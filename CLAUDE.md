# MG (Management Game) シミュレーションシステム

## 概要
6社で競争するビジネスシミュレーションゲーム。2期～5期を通して自己資本¥450以上を目指す。

---

## !! 最重要原則 !!

### 1. ルール定義は1箇所のみ（Single Source of Truth）
```
唯一のルール定義: js/simulation-engine.js

・全てのゲームルール（73項目）はこのファイルのみに定義
・他のファイルはこのファイルを参照して使用する
・ルール変更は必ずこのファイルを変更する
・二重定義は絶対禁止（整合性が取れなくなる）
```

### 2. チェックリストは毎回強制実行
```
検証ファイル: rules/rules-checklist.json
テストファイル: tests/rule-tests.js

・シミュレーション実行前に必ず全73項目をチェック
・1項目でも未実装・不整合があれば実行拒否
・スキップは可能だが強く非推奨
・これによりルール違反を100%防止
```

### 3. 1年後でも確実にルールが守られる仕組み
```
・チェックリストは機械可読なJSON形式
・テストは自動実行される
・人間が忘れても機械が確認する
・ルール追加時はチェックリスト・テストも必ず更新
```

### 4. どの経路からでも検証される
```
検証レイヤー:

1. mg-simulation.js 経由:
   → RuleEnforcer による外部検証（テスト84件 + チェックリスト82件）

2. js/simulation-engine.js を直接使用:
   → RuleValidator による内部自己検証（ルール定義の存在確認）

3. ブラウザでゲームプレイ:
   → RuleValidator が runSimulation() 時に自動検証

※検証をスキップするには明示的に {skipValidation: true} が必要
※スキップした場合でもルール定義は存在確認される
```

---

## 実行方法

### シミュレーション実行（検証込み）
```bash
node mg-simulation.js        # 1回実行（検証→実行）
node mg-simulation.js 100    # 100回実行（検証→実行）
```

### テスト単体実行
```bash
node tests/rule-tests.js     # ルールテスト
node rules/verify-rules.js   # チェックリスト検証
```

---

## ファイル構成

```
Management Game/
├── mg-simulation.js              # 統一エントリポイント（検証+実行）
├── CLAUDE.md                     # このファイル（原則記録）
├── js/
│   └── simulation-engine.js      # ★唯一のルール定義+シミュレーションエンジン
├── rules/
│   ├── rules-checklist.json      # 全73ルールのチェックリスト
│   ├── game-rules.js             # ★削除予定（simulation-engine.jsに統一）
│   └── verify-rules.js           # チェックリスト検証スクリプト
└── tests/
    └── rule-tests.js             # ルール単体テスト（73項目）
```

**重要**:
- シミュレーションは `mg-simulation.js` から実行
- ルール定義は `js/simulation-engine.js` のみ
- `rules/game-rules.js` は削除予定（重複定義）

---

## 主要ルール

### 親の定義（最重要）
```
親 = 入札を仕掛けた会社

例: A社が名古屋市場で販売を希望
    → A社が入札を仕掛ける
    → A社が親となり、親ボーナス+2を得る
    → 他社(B,C,D...)がこの入札に参加可能
```

### 入札システム
- **入札市場**: 仙台・札幌・福岡・名古屋
- **非入札市場**: 大阪（サイコロ価格21-26）、東京（固定20）、海外（固定16）
- **コール価格**: 希望価格 - (研究チップ×2 + 親ボーナス2)
- **勝敗判定**: コール価格低い順 → 研究チップ多い順 → 親優先

### 市場ボリューム
各市場には最大販売数がある。満杯になると販売不可。
```
仙台: 3個, 札幌: 4個, 福岡: 6個, 名古屋: 9個
大阪: 13個, 東京: 20個, 海外: 100個
```

### 期別行数
```
2期: 20行, 3期: 30行, 4期: 34行, 5期: 35行
```

### 研究チップ別販売価格（親の場合）
```
2期: 0枚→24, 1枚→26, 2枚→28, 3枚→30, 4枚→32
3期: 0枚→24, 1枚→26, 2枚→28, 3枚→30, 4枚→32, 5枚→34
4期: 0枚→22, 1枚→24, 2枚→26, 3枚→28, 4枚→30, 5枚→32
5期: 0枚→21, 1枚→23, 2枚→25, 3枚→27, 4枚→29, 5枚→31
```

### 能力計算
```
製造能力 = min(機械能力, ワーカー能力)
機械能力 = 小型1 + アタッチ+1 + 大型4 + PCチップ×機械数 + 教育+1
ワーカー能力 = ワーカー数 + 教育効果(+1)

販売能力 = セールス×2 + 有効広告×2 + 教育効果(+1)
有効広告 = min(広告チップ, セールス×2)
```

### チップ繰越
```
2期末: PC・保険は返却、研究・教育・広告は-1して最大3枚繰越
3期以降末: 全チップ没収
```

### 勝利条件
```
・自己資本¥450以上
・在庫10個以上
・次期繰越チップ3枚以上
・6社中1位
```

---

## ルール変更時の手順

1. `js/simulation-engine.js` のRULES定数を変更
2. `rules/rules-checklist.json` を更新（implementedをfalseにして変更内容追記）
3. `tests/rule-tests.js` にテストを追加/修正
4. テスト実行: `node tests/rule-tests.js`
5. 全テスト成功を確認
6. チェックリストのimplementedをtrueに戻す
7. `node mg-simulation.js` でシミュレーション実行

---

## トラブルシューティング

### テストが失敗する場合
```bash
node tests/rule-tests.js
```
失敗したテストを確認し、`js/simulation-engine.js` を修正

### 検証がスキップされた場合
```
!! 警告: --skip-verify は緊急時のみ使用 !!
ルール違反の結果が出る可能性があります
```

### 古いファイルを使ってしまった場合
- `mg-simulation.js` 以外のシミュレーションファイルは使用禁止
- `rules/game-rules.js` は参照しない（削除予定）

---

## 更新履歴
- 2026-01-04: 100%完成 - 84項目全て実装・検証済み
  - チェックリスト84項目 = テスト84項目（完全一致）
  - 全経路で検証強制（mg-simulation.js + simulation-engine.js内部）
  - 行動明細表示機能追加
  - ワーカールール修正（機械1台にワーカー1人必要）
- 2026-01-04: ルール唯一定義の原則を確立、チェックリスト強制実行の仕組み構築
- 2026-01-04: 統一エンジン作成、親の定義を正しく実装
