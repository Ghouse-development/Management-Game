# MG (Management Game) シミュレーションシステム

## 概要
6社で競争するビジネスシミュレーションゲーム。2期～5期を通して自己資本¥450以上を目指す。

---

## 絶対厳守の設計原則（ユーザー命令）

### 1. 成功パターン学習方式
- シミュレーション結果から成功した行動パターンを自動抽出
- 成功パターンは `data/learned-patterns.json` に保存
- 次回シミュレーションで成功パターンを優先使用

### 2. ルールを絶対に忘れない・守る
- 全てのルールは `js/rule-enforcer.js` に定義
- ルール違反は自動検出・修正
- ルールはコードで強制（人間の判断不要）

### 3. 全てをシステム化・フラグ化
- 全パラメータは定数として定義
- 判断ロジックはフラグで管理
- 曖昧な処理は禁止

### 4. 頭脳を使わずに計算
- 全ての計算はコードで自動化
- 人間の推測・判断に依存しない
- 結果は再現可能

### 関連ファイル
- `js/pattern-learner.js` - 成功パターン学習システム
- `js/rule-enforcer.js` - ルール強制システム
- `data/learned-patterns.json` - 学習済みパターン

---

## システム構成

```
Management Game/
├── mg-simulation.js              # エントリポイント（検証+実行）
├── CLAUDE.md                     # このファイル
├── js/
│   ├── simulation-engine.js      # ルール定義+シミュレーションエンジン
│   └── intelligent-learning.js   # Q学習システム v2.0
├── data/
│   ├── q-learning-data.json      # Q学習データ（状態-行動価値）
│   └── learned-strategies.json   # 戦略統計データ
├── rules/
│   ├── rules-checklist.json      # 全84ルールのチェックリスト
│   └── verify-rules.js           # チェックリスト検証
└── tests/
    ├── rule-tests.js             # ルール単体テスト（84項目）
    └── behavior-tests.js         # 動作確認テスト
```

---

## 実行方法

```bash
# シミュレーション実行（検証込み）
node mg-simulation.js        # 1回実行
node mg-simulation.js 1000   # 1000回実行

# テスト実行
node tests/rule-tests.js     # 84項目ルールテスト
node rules/verify-rules.js   # チェックリスト検証
```

---

## Q学習システム v2.0

### 概要
- **状態空間**: 約260状態（期×進捗×現金×製品×生産可能×研究チップ）
- **行動タイプ**: SELL, BUY_MATERIALS, PRODUCE, BUY_CHIP, HIRE_*, DO_NOTHING等
- **学習率**: 0.15、割引率: 0.95、探索率: 25%→5%（自動調整）

### 状態エンコード形式
```
例: "5M_H_YN_L"
     │ │  ││  └─ 研究チップ: L=0-2枚, H=3-5枚
     │ │  │└──── 生産可能: Y/N
     │ │  └───── 製品あり: Y/N
     │ └──────── 現金: L=低, M=中, H=高
     └────────── 期+進捗: 5M=5期中盤
```

### 会社別トラッカー
各会社の行動履歴を分離管理（v1.0のバグ修正済み）

---

## ルール強制システム

### 1. RuntimeRuleEnforcer
全ての状態変更後に自動検証。違反があれば即エラー。

### 2. ActionValidator
アクション実行前に事前検証。無効な行動は実行されない。

### 3. RuleValidator
シミュレーション開始時にルール定義の存在を確認。

---

## 主要ルール（84項目）

### ゲーム構造
- 6社競争（プレイヤー1社 + AI5社）
- 期別行数: 2期=20行, 3期=30行, 4期=34行, 5期=35行
- 親ボーナス+2

### 入札システム
- 入札市場: 仙台・札幌・福岡・名古屋
- 非入札市場: 大阪（サイコロ21-26）、東京（固定20）、海外（固定16）
- コール価格 = 希望価格 - 研究チップ×2 - 親ボーナス2

### 勝利条件
- 自己資本¥450以上
- 在庫10個以上
- 次期繰越チップ3枚以上
- 6社中1位

---

## ユーザー指定の行動パターン（PLAYER戦略）

### 初期状態（2期開始時）
- 現金: ¥137
- 材料: 1個、仕掛品: 2個、製品: 1個
- 機械: 小型1台（能力1）
- ワーカー: 1人、セールスマン: 1人
- 製造能力: 2（小型1+PC1）→教育で+1=3
- 販売能力: 2（セールス1×2）→教育で+1=3

### 2期の行動（20行）
```
行1:  期首（PC¥20+保険¥5=¥25）→ 残り¥112
行2:  教育チップ購入
行3:  材料5個購入（12円希望、13円まで許容）
行4:  完成投入3+3
行5:  [リスクカード]
行6:  研究開発チップ購入（1枚目）
行7:  販売29円×3以上
行8:  完成投入3+3
行9:  研究開発チップ購入（2枚目）
行10: [リスクカード]
行11: 研究開発チップ購入（3枚目）
行12: 研究開発チップ購入（4枚目）
行13: 販売32円×3以上
行14: 材料6個購入（12円希望、14円まで許容）
行15: [リスクカード]
行16: 完成投入3+3
行17: 販売32円×3以上
行18: 教育チップ購入（2枚目）
行19: 完成投入3+3
行20: [リスクカード]→期末
```
目標売上: 29×3 + 32×3 + 32×3 = 279円

### 3期のF目標: 356円
| 項目 | 金額 |
|------|------|
| ワーカー1人 | 29円 |
| 機械1台 | 29円 |
| セールスマン3人 | 87円 |
| 期中最大人員4人 | 56円 |
| 大型機械減価償却費 | 40円 |
| 研究開発チップ3枚 | 60円 |
| 教育チップ1枚 | 20円 |
| 長期借入金利145円 | 15円 |
| 予備日 | 20円 |
| **合計** | **356円** |

### 4期のF目標: 399円
| 項目 | 金額 |
|------|------|
| ワーカー1人 | 31円 |
| 機械1台 | 31円 |
| セールスマン3人 | 93円 |
| 期中最大人員4人 | 64円 |
| 大型機械減価償却費 | 40円 |
| 研究開発チップ4枚 | 80円 |
| 教育チップ1枚 | 0円（没収済み） |
| 長期借入金利300円 | 30円 |
| 予備日 | 30円 |
| **合計** | **399円** |

### 重要なルール
- **非入札市場（大阪・東京・海外）**: 固定価格、研究チップ・親ボーナスの効果なし
  - 大阪: 2期=24円、3期以降=サイコロ21-26円
  - 東京: 20円固定
  - 海外: 16円固定
- **2期1周目材料購入**: 全社共通で3個まで（PLAYERも例外なし）
- **期の終了**: 1社でも既定行数に達すると全社の期が終了

---

## ★★★ 絶対変更禁止ルール（ユーザー指定 2026-01-06）★★★

### 1. 記帳価格テーブル（親の時）

**変更する前にユーザーに確認すること！**

| 期 | 0枚 | 1枚 | 2枚 | 3枚 | 4枚 | 5枚 |
|----|-----|-----|-----|-----|-----|-----|
| 2期| ¥24 | ¥26 | ¥28 | ¥30 | ¥32 |  -  |
| 3期| ¥24 | ¥26 | ¥28 | ¥30 | ¥32 | ¥34 |
| 4期| ¥22 | ¥24 | ¥26 | ¥28 | ¥30 | ¥32 |
| 5期| ¥21 | ¥23 | ¥25 | ¥27 | ¥29 | ¥31 |

**関連ファイル:**
- `js/simulation-engine.js` の `TARGET_PRICES`
- `rules/price-rules.json`

### 2. 5期終了条件（絶対厳守）

**これは絶対条件。例外なし。**

- ✓ 在庫10個以上（材料+仕掛品+製品）
- ✓ 次期繰り越しチップ3枚以上
- ✓ 自己資本¥450以上

**関連ファイル:**
- `js/simulation-engine.js` の `RULES.VICTORY`
- `rules/victory-rules.json`

### 3. 再発防止策

1. **ルール定義の一元化**: `rules/` ディレクトリにJSONで定義
2. **起動時検証**: シミュレーション開始時にJSONファイルとコード内定数を比較
3. **CLAUDE.md更新**: 重要なルール変更時は必ずこのファイルを更新

---

## 更新履歴

- 2026-01-06: ルール再発防止策実装
  - `rules/price-rules.json` - 価格テーブル定義ファイル作成
  - `rules/victory-rules.json` - 勝利条件定義ファイル作成
  - TARGET_PRICESを正しい値に修正
  - 5期終了条件の厳格チェック実装
  - 期末現金表示機能追加
  - `visualize-actions.js` - 行動見える化ツール作成
- 2026-01-04: Q学習v2.0
  - 会社別トラッカーで行動履歴分離（混入バグ修正）
  - 状態空間を8036→260に削減（学習効率向上）
  - 期首処理・リスクカードの学習追加
  - 不要ファイル・古い学習システム削除
- 2026-01-04: 84項目全て実装・検証済み
- 2026-01-04: 統一エンジン作成、親の定義を正しく実装
