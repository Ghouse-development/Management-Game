# 開発記録 2025-12-29

## 修正内容

### 1. 入札システム改善
- 他社の入札時に希望価格を非表示（「入札価格は非公開」と表示）
- 他社同士も積極的に入札するよう改善（製品2個以上あれば参加）
- AIの性格に応じた入札価格設定（aggressive: 0.7倍, price_focused: 0.75倍, conservative: 0.85倍）

### 2. 各社共通リスクカード実装
- 全社が12円で3個まで材料購入可能
- 市場から優先購入、不足分は海外から補完
- 行を消費しない

### 3. 市場盤の並び順変更
- 販売上限価格の高い順に変更
- 順序: 仙台 → 札幌 → 福岡 → 名古屋 → 大阪 → 東京 → 海外

### 4. 材料総数を100個に設定
- 海外市場の初期在庫を45個に変更（合計: 3+4+6+9+13+20+45=100）

### 5. AI行動最適化
- 2個未満の売買は行わない（行の無駄遣い防止）
- 代わりに生産を試みる
- DO NOTHINGを基本的にしない

### 6. 持ち金表示追加
- 生産モーダル、チップ購入モーダル、材料購入モーダルに持ち金を表示

### 7. 「全体を見る」機能強化
- 全会社盤（自社・他社）を一覧表示
- 市場盤（在庫・価格・閉鎖状況）を表示
- スクロール可能なモーダルで実装

### 8. 規定行数達成時の処理確認
- 誰か1人が規定行数に達した時点で全員の期が終了（既存実装を確認）

### 9. AIの性格実装確認
- 6種類の性格が実装済み
  - aggressive（積極的）
  - conservative（保守的）
  - price_focused（価格競争）
  - tech_focused（技術重視）
  - balanced（バランス）
  - unpredictable（予測不能）

### 10. F（固定費）計算方法修正
- **金利を追加**: 長期借入10%、短期借入20%
- **チップ費用の正確な計算**:
  - 2期: 全チップ20円/枚
  - 3期以降: 繰り越しチップ20円/枚、特急（今期購入）40円/枚
- **carriedOverChips**フィールドを追加して繰り越しチップを追跡
- 期中最大人員 × 半額単価 を含む（確認済み）

### 11. 倉庫処理
- 期末で倉庫をリセット（消滅）
- 倉庫費用20円はextraLaborCostとしてFに計上済み

### 12. 配置転換処理
- 配置転換費用（5円/人）をFに計上
- 1行使用してターン終了

### 13. AI販売・購入最適化
- **販売**: 販売能力の7割以上の製品がある時のみ販売（例：能力10なら7個以上）
- **購入（3期以降）**: 製造能力の7割以上を購入できる時のみ購入
- 7割に満たない場合は生産に回すか見送り

### 14. 市場在庫引き継ぎ確認
- 3期以降、市場在庫は前期を引き継ぐ（カードデッキのみリセット）

## 技術的変更

### 新規フィールド追加
- `company.carriedOverChips`: 前期から繰り越したチップ数を追跡

### 関数修正
- `calculateFixedCost()`: 金利・チップ費用の計算を修正
- `executeDefaultSale()`: 7割以上ルール適用
- `executeDefaultMaterialPurchase()`: 7割以上ルール適用
- `viewGameState()`: 全会社盤・市場盤表示
- `reassign()`: F計上・1行使用
- `endPeriod()`: 倉庫リセット・carriedOverChips設定
