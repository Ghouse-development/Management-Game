# 開発記録 2025-12-29

## 修正内容

### 1. 入札システム改善
- 他社の入札時に希望価格を非表示（「入札価格は非公開」と表示）
- 他社同士も積極的に入札するよう改善（製品2個以上あれば参加）
- AIの性格に応じた入札価格設定（aggressive: 0.7倍, price_focused: 0.75倍, conservative: 0.85倍）

### 2. 各社共通リスクカード実装
- 全社が12円で3個まで材料購入可能
- 市場から優先購入、不足分は海外から補完
- 行を消費しない

### 3. 市場盤の並び順変更
- 販売上限価格の高い順に変更
- 順序: 仙台 → 札幌 → 福岡 → 名古屋 → 大阪 → 東京 → 海外

### 4. 材料総数を100個に設定
- 海外市場の初期在庫を45個に変更（合計: 3+4+6+9+13+20+45=100）

### 5. AI行動最適化
- 2個未満の売買は行わない（行の無駄遣い防止）
- 代わりに生産を試みる
- DO NOTHINGを基本的にしない

### 6. 持ち金表示追加
- 生産モーダル、チップ購入モーダル、材料購入モーダルに持ち金を表示

### 7. 「全体を見る」機能強化
- 全会社盤（自社・他社）を一覧表示
- 市場盤（在庫・価格・閉鎖状況）を表示
- スクロール可能なモーダルで実装

### 8. 規定行数達成時の処理確認
- 誰か1人が規定行数に達した時点で全員の期が終了（既存実装を確認）

### 9. AIの性格実装確認
- 6種類の性格が実装済み
  - aggressive（積極的）
  - conservative（保守的）
  - price_focused（価格競争）
  - tech_focused（技術重視）
  - balanced（バランス）
  - unpredictable（予測不能）

### 10. F（固定費）計算方法修正
- **金利を追加**: 長期借入10%、短期借入20%
- **チップ費用の正確な計算**:
  - 2期: 全チップ20円/枚
  - 3期以降: 繰り越しチップ20円/枚、特急（今期購入）40円/枚
- **carriedOverChips**フィールドを追加して繰り越しチップを追跡
- 期中最大人員 × 半額単価 を含む（確認済み）

### 11. 倉庫処理
- 期末で倉庫をリセット（消滅）
- 倉庫費用20円はextraLaborCostとしてFに計上済み

### 12. 配置転換処理
- 配置転換費用（5円/人）をFに計上
- 1行使用してターン終了

### 13. AI販売・購入最適化
- **販売**: 販売能力の7割以上の製品がある時のみ販売（例：能力10なら7個以上）
- **購入（3期以降）**: 製造能力の7割以上を購入できる時のみ購入
- 7割に満たない場合は生産に回すか見送り

### 14. 市場在庫引き継ぎ確認
- 3期以降、市場在庫は前期を引き継ぐ（カードデッキのみリセット）

### 15. 行使用ルール修正（お金の流れがあるかどうか）
- **各社共通カード**: 購入した場合のみ1行使用（購入しなければ0行）
- **入札キャンセル時**: 行を使わない（nextTurnに変更）
- **入札失敗時**: 行を使わない（playerSoldInBidフラグで追跡）

### 16. 入札結果表示の改善
- **コール価格**: 勝敗判定に使用する価格（表示価格 - 価格競争力）
- **記帳価格**: 売上に計上される価格（表示価格）
- 両方の価格を入札結果画面で明確に表示

### 17. 行動ログ機能の追加
- 期末に「行動ログを見る」ボタンを追加
- 各会社の行動と金銭の流れを一覧表示
- 対象アクション:
  - 商品販売（収入）
  - 材料購入（支出）
  - 完成・投入（支出）
  - 採用（支出）
  - 戦略チップ購入（支出）
  - 各社共通カード購入（支出）

## 技術的変更

### 新規フィールド追加
- `gameState.actionLog`: 行動ログ配列（companyIndex, action, details, cashChange, rowUsed等）
- `gameState.playerSoldInBid`: 入札で販売成功したかのフラグ
- `company.carriedOverChips`: 前期から繰り越したチップ数を追跡

### 新規関数追加
- `logAction()`: 行動ログを記録
- `resetActionLog()`: 行動ログをリセット
- `showActionLogModal()`: 行動ログ表示モーダル

### 関数修正
- `calculateFixedCost()`: 金利・チップ費用の計算を修正
- `executeDefaultSale()`: 7割以上ルール適用
- `executeDefaultMaterialPurchase()`: 7割以上ルール適用
- `viewGameState()`: 全会社盤・市場盤表示
- `reassign()`: F計上・1行使用
- `endPeriod()`: 倉庫リセット・carriedOverChips設定
- `cancelPlayerBid()`: endTurn→nextTurnに変更
- `cancelPlayerBidTwoMarket()`: endTurn→nextTurnに変更
- `completeSale()`: playerSoldInBidフラグで行使用を判定
- `completeSaleTwoMarket()`: playerSoldInBidフラグで行使用を判定
- `processCommonPurchase()`: プレイヤー購入時のみ行使用
- `processAICommonPurchase()`: プレイヤー購入時のみ行使用
- `processBidsWithAllCompanies()`: コール価格/記帳価格表示、ログ記録
- `processBidsWithAllCompaniesTwoMarket()`: コール価格/記帳価格表示、ログ記録
- `showFinancialSummary()`: 行動ログボタン追加

### 18. UI改善（カード選択形式）
- **縁故採用モーダル**: セールスマン/ワーカーをカードタップで選択
  - カラフルなカードUI（セールスマン：赤、ワーカー：茶）
  - ホバー効果付き
- **意思決定カードモーダル**: 7つのアクションをカード形式で表示
  - 各アクションに固有の色とアイコン
  - 会社情報（持ち金、能力、在庫）を同時表示
  - 4列グリッドレイアウト

### 19. AI強化（G最大化・自己資本最大化）
- **投資判断の戦略化**:
  - 期末支払いを考慮した安全マージン確保
  - ボトルネック解消投資のみ実行（無駄な採用・機械購入を排除）
  - 研究チップ優先（価格競争力向上→MQ増加に直結）

- **各戦略の最適化**:
  - **A社（積極的）**: 低価格入札で量を確保、研究チップ投資優先
  - **B社（バランス）**: 7割ルール徹底、バランスのよい投資
  - **C社（保守的）**: 安全マージン大きめ、保険チップ優先
  - **D社（価格競争）**: 薄利多売、ボトルネック解消のみ投資
  - **E社（技術重視）**: 研究・教育・コンピュータチップ優先
  - **F社（予測不能）**: ランダムだが合理的な範囲内で行動

- **無駄な投資の排除**:
  - 期末近く（残り5行以下）は投資しない
  - 製造能力がボトルネックでない場合はワーカー採用しない
  - 販売能力がボトルネックでない場合はセールスマン採用しない
  - ワーカー能力に余裕がなければ機械購入しない

### 関数修正（追加）
- `executeDefaultInvestment()`: G最大化・自己資本最大化志向に全面改修
- `executeAggressiveStrategy()`: 無駄な投資を排除、7割ルール徹底
- `executeConservativeStrategy()`: 保険チップ優先、安全マージン拡大
- `executePriceFocusedStrategy()`: ボトルネック解消投資のみ
- `executeTechFocusedStrategy()`: 教育チップ上限確認、戦略的投資
- `executeBalancedStrategy()`: 7割ルール徹底、バランス投資
- `executeUnpredictableStrategy()`: 合理的な範囲内でランダム行動

### 20. 労災発生時の処理改善
- 労災発生時にアクション選択モーダルを表示
- 許可されるアクション: 材料購入、商品販売、DO NOTHING
- 禁止されるアクション: 完成・投入（生産）
- ターン終了時に労災フラグをリセット
- `showLaborAccidentActionModal()`: 労災時のアクション選択モーダル

### 21. 不良在庫発生の保険対応
- 保険加入時: 1個10円の保険金を受け取れる
- 特別損失 = 失われた価値 - 保険金
- 保険使用後は再加入選択モーダルを表示
- 計算例: 製品5個消失(75円) - 保険金(50円) = 特別損失25円

### 22. 戦略チップのF計算修正（2期）
- 修正前: 持っている全チップ × 20円
- 修正後: 各種1枚分（最大20円）のみ計上
- ルール: 2期は各種チップ1枚だけ返却するため

### 23. 市場タイル位置調整
- 六角形のクリップパス内に収まるよう位置を調整
- 各市場タイルの `top`, `left`, `right`, `bottom` を微調整

### 24. Optional Chaining追加
- `nextPeriodChips` への安全なアクセス
- チップ表示UIでのnull安全性向上

### 25. アラートメッセージ修正
- 期開始時: 「3行目から」→「2行目から」に修正

### 26. VQ表示のラベル順序修正
- **修正前**: ③期末在庫評価額、④期首在庫評価額（順序が逆）
- **修正後**: ③期首在庫評価額、④期末在庫評価額（正しい順序）
- VQ計算式: 材料購入費 + 完成投入費 + 期首在庫 - 期末在庫

### 27. リスクカード費用のF計上修正
- 以下のリスクカードがFに正しく計上されるよう修正:
  - **クレーム発生** (case 1, 2): 5円
  - **コンピュータートラブル** (case 24, 25): 10円
  - **設計トラブル発生** (case 49, 50): 10円
- プレイヤー用（processRiskCard）とAI用（applyRiskCardToAI）の両方を修正
- `additionalFixedCost` フィールドに費用を加算

### 28. プレイヤーターンバグの安全ガード追加
- `executeAITurn()` 関数にプレイヤーターン時の実行防止ガードを追加
- `gameState.currentPlayerIndex === 0` の場合は即座にreturn

### 29. F計算詳細表示の改善
- F内訳表示に **リスクカード費用** を追加
- F内訳表示に **その他人件費**（配置転換費用等）を追加
- 条件付き表示で0円の場合は非表示

### 30. 重複CSSの整理
- **`.ai-action-header`の競合解消**:
  - `.ai-action-display .ai-action-header` （シンプルなテキストヘッダー用）
  - `.ai-action-modal .ai-action-header` （Flexレイアウト+アバター用）
- **`.personnel-dots`の競合解消**:
  - メインボード用（line 481）はそのまま維持
  - `.company-card .personnel-dots` にスコープ変更（全体表示モーダル用）
- **`.chip-dots`の競合解消**:
  - メインボード用（line 517）はそのまま維持
  - `.chips-section .chip-dots` にスコープ変更（全体表示モーダル用）
- **`.chip-dot.filled.*`** も `.chips-section` にスコープ変更

### 31. コードリファクタリング（ファイル分割）
- **フォルダ構造作成**:
  - `css/` ディレクトリ新規作成
  - `js/` ディレクトリ新規作成

- **CSS外部化**:
  - `css/styles.css` に全CSS抽出（約1360行）
  - `index.html` からインラインCSS削除
  - ファイルサイズ: 10939行 → 9579行（1360行削減）

- **定数ファイル作成** (`js/constants.js`):
  - `MAX_ROWS_BY_PERIOD`: 各期の行数上限
  - `BASE_SALARY_BY_PERIOD`: 各期の基本人件費単価
  - `DEPRECIATION`: 機械の減価償却費
  - `CHIP_COSTS`: チップコスト（通常/特急/コンピュータ/保険）
  - `INVENTORY_VALUES`: 在庫評価単価
  - `PRODUCTION_COST`: 完成・投入コスト
  - `MARKETS`: 市場データ（7市場分）
  - `RISK_CARDS`: リスクカード（64枚分）
  - `DECISION_CARDS`: 意思決定カード（7種類）
  - `AI_STRATEGY_DESCRIPTIONS`: AI戦略説明

## 追加修正（セッション2）

### 1. UI改善：プルダウン→カード/ステッパー形式
- **材料購入モーダル**: 0〜5個のカード選択
- **広告チップ購入モーダル**: 0〜2枚のカード選択
- **製造モーダル**: +/- ステッパーボタン
- **販売モーダル**: +/- ステッパーボタン（数量・価格）
- **材料仕入モーダル**: +/- ステッパーボタン + コスト表示
- **雇用モーダル**: +/- ステッパーボタン（ワーカー・セールス）
- **チップ購入モーダル**: 1/2/3個のカード選択
- **各社共通カード**: 0〜3個のカード選択

### 2. 販売制限の修正
- **海外市場**: 販売上限なし（無制限）
- **東京・他市場**: 市場容量による制限あり
- バグ修正: `market.maxStock - market.currentStock` が0になって販売不可だった問題

### 3. AI分散購入機能
- **行数が最多でないAI**: 複数市場から分散購入可能
  - 例: 仙台3個 + 札幌2個 + 福岡2個 = 7個
- **行数が最多のAI**: 単一市場からのみ購入
- **7割ルール維持**: 製造能力の7割以上買えない場合は購入しない
- シミュレーション方式で実装（購入前に計算してから実行）

### 4. ステッパー/カードUIのCSS追加
- `.stepper-btn`: ホバー時scale(1.1)、クリック時scale(0.95)
- `.qty-card`: ホバー時scale(1.05)、影効果

### 5. 新規関数追加
- `adjustProduction()`: 製造ステッパー調整
- `adjustStepper()`: 汎用ステッパー調整
- `adjustBuyStepper()`: 購入ステッパー調整（コスト表示付き）
- `adjustHire()`: 雇用ステッパー調整（合計3名制限）
- `selectChipQty()`: チップ数量選択
- `selectCommonPurchase()`: 各社共通購入選択

## 追加修正（セッション3）

### 1. 順番飛ばし完全排除
- **長期労務紛争のみ**順番飛ばし許可（2回休み）
- ストライキ発生、社長病気で倒れるから`skipTurns`を削除
- これらは行を消費しないが、次のターンは通常通り回る

### 2. 各社共通カードUI統一
- プレイヤー版・AI版ともにカード選択UIに統一
- 現金チェック追加（買えない選択肢は無効化）
- `selectAICommonPurchase()` 関数追加

### 3. AIバッジレイアウト改善
- **在庫ブロック**: 5列グリッドに変更（10個=2行で収まる）
- **ブロックサイズ**: 12px → 9pxに縮小
- **色の区別**: 材料=紫、仕掛品=オレンジ、製品=緑
- **チップ表示**: 数字カウント追加、ラベル短縮（PC/保険/研究/教育/広告）

### 4. AI行動積極化・DO NOTHING禁止
- **材料購入**: 2期は倉庫容量まで、3期以降は製造能力まで購入可能
- **販売**: 1個以上あれば販売実行（7割制限撤廃）
- **DO NOTHING削除**: 全戦略からDO NOTHINGを削除
- フォールバック: 材料購入 → 生産 → チップ購入 → nextTurn()

### 5. AI会社名変更（性格反映）
- 青山商事 → **攻め商事**（aggressive）
- 鈴木産業 → **堅実産業**（conservative）
- 田中製作所 → **安値製作所**（price_focused）
- 山本工業 → **技術工業**（tech_focused）
- 佐藤物産 → **変幻物産**（unpredictable）

### 6. 期首処理カード形式化
- **長期借入**: ¥0/¥50/¥100/¥150のカード選択
- **無災害倉庫**: 0/1/2個のカード選択
- **コンピュータ**: 0/1個のカード選択（デフォルト1）
- **保険**: 0/1個のカード選択（デフォルト1）
- `selectPeriodStart()` 関数追加

### 7. 期首/期末処理の明確化
- **期首**: 金利支払い + 納税 + 配当 + 長期借入判断 + 倉庫購入判断
- **期末**: 給料支払い + 借入返済（元本）

## 今後の改善点

### 優先度：高
1. **JavaScript定数統合**: constants.jsの定数をgameStateで使用
2. **JavaScript関数外部化**: 機能別にファイル分割
   - `js/state.js`: ゲーム状態管理
   - `js/game.js`: ゲームロジック
   - `js/ai.js`: AI関連
   - `js/ui.js`: UI更新・モーダル
   - `js/main.js`: 初期化・イベント

### 優先度：中
3. **マジックナンバー排除**: ハードコードされた数値を定数化
4. **重複コード削除**: 類似処理の共通関数化
5. **エラーハンドリング強化**: try-catch追加

### 優先度：低
6. **TypeScript移行**: 型安全性向上
7. **ユニットテスト追加**: Jest等でテスト実装
8. **JSDoc追加**: 関数ドキュメント整備

---

## 追加修正（セッション3）- 最強AI実装

### 1. AIBrain - 最強AI戦略エンジン実装
`index.html` 内に `AIBrain` オブジェクトを実装（約400行）

#### 主要機能
- `calculatePathToVictory()`: 勝利への道筋を計算（必要なG、達成可能MQ）
- `calculateInvestmentROI()`: 各投資のROI（投資収益率）を計算
- `forecastCashFlow()`: キャッシュフロー予測（期末必要資金、投資可能額）
- `analyzeCompetitors()`: 競合分析（脅威レベル、順位、研究チップ平均）
- `calculateThreatLevel()`: 各ライバルの脅威度をスコア化
- `decideOptimalAction()`: 最適行動を決定
- `findBestInvestment()`: ROIベースで最良の投資を特定
- `calculateStrategicBidPrice()`: 戦略的入札価格（生存/ブロッキング/プレミアム/通常モード）

### 2. リスクカード認識システム
AIが全64枚のリスクカードを認識し、予防策を取る

#### RISK_KNOWLEDGE オブジェクト
```javascript
AIBrain.RISK_KNOWLEDGE = {
    // 損失系（予防可能）
    materialLoss: { cards: ['倉庫火災'], count: 2, prevention: 'warehouse_materials' },
    productLoss: { cards: ['盗難発見'], count: 2, prevention: 'warehouse_products' },
    excessInventory: { cards: ['不良在庫発生'], count: 2, threshold: 20 },

    // チップ返却系
    chipLoss: { research: 3枚, advertising: 2枚, education: 2枚 },

    // 現金損失系（最大30円）
    cashLoss: { maxLoss: 30, avgLoss: 8 },

    // チャンスカード（18枚 = 28%）
    opportunities: {
        researchSuccess: 6枚,  // ★最多！
        advertisingSuccess: 3枚,
        exclusiveSale: 3枚,
        educationSuccess: 2枚,
        specialService: 2枚,
        commonPurchase: 2枚
    }
};
```

#### analyzeRiskProtection()
- 保険チェック（火災・盗難対策）
- 倉庫チェック（材料/製品保護）
- 在庫過多チェック（20個以下か）
- 現金バッファチェック（30円以上か）
- チップ複数持ちチェック（返却対策）
- チャンス活用準備チェック（製品+チップ）

### 3. 生存モード
給料が払えない危機時の特別行動
- 20円まで価格を下げて販売
- 緊急短期借入の実行

### 4. 設備・採用戦略
- **小型→大型機械アップグレード**: aggressive限定、2期-3期
- **戦略的ワーカー採用**: 機械があるのに活用できてない場合
- **戦略的セールスマン採用**: 販売能力 < 製造能力の場合
- **倉庫購入**: 在庫容量拡大・リスク保護

### 5. 勝ちパターン認識
- **リードしている場合**: 高値販売、現金キープ、守りの姿勢
- **ビハインドの場合**: 特急チップ、積極販売、攻めの姿勢

### 6. 戦略的入札価格
| モード | 条件 | 価格範囲 |
|--------|------|----------|
| 生存 | 給料払えない | 20円〜 |
| ブロッキング | ライバル妨害 | 24円〜 |
| プレミアム | 余裕がある時 | 92%程度 |
| 通常 | 性格別 | 78〜96% |

### 7. コンソールログで思考を可視化
```
[AIBrain] 攻め商事: SELL - 製品があるので販売
[AIRisk] 堅実産業: BUY_INSURANCE - 火災・盗難対策
[AI戦略] 技研工業: ビハインドのため攻めモード発動
```

### 8. リスクカード確率計算
- リスク発生確率: 20%（15/75枚）
- チャンスカード: 28%（18/64枚）
- 期待リスク枚数: 約3枚/期

## 技術的変更

### 新規追加コード（index.html）
- `AIBrain` オブジェクト: 約400行
- `executeAIStrategyByType()` 大幅拡張: リスク認識・勝ちパターン対応
- `startAIBidding()`: AIBrain.calculateStrategicBidPrice()使用
- `processAIOnlyBidding()`: AIBrain使用に変更

### AI行動フロー
1. `AIBrain.decideOptimalAction()` で最適行動を判断
2. `AIBrain.getRecommendedAction()` でリスク対策を確認
3. 生存モード・機械アップグレード・採用戦略を実行
4. 勝ちパターン認識（リード vs ビハインド）
5. 性格別戦略を実行

---

## 追加修正（セッション4）

### 1. AI入札への1円刻み参加UI
- **ステッパーUI実装**: -10/-1/+1/+10ボタンで価格調整
- **プリセットボタン**: 攻め(80%)/普通(85%)/安全(90%)/高め(95%)
- **価格範囲表示**: 最低¥26〜上限価格
- 新規関数: `adjustAIBidPrice()`, `setAIBidPrice()`, `updateAIBidPriceDisplay()`

### 2. 入札価格の浮動小数点問題修正
- `calculateStrategicBidPrice()`内の3箇所で`Math.round()`追加
  - 生存モード: `basePrice * 0.6`
  - ブロッキングモード: `basePrice * 0.75`
  - プレミアムモード: `basePrice * 0.92`
- 親AI・他AIの入札処理でも`Math.round()`追加

### 3. 安い材料の貪欲な仕入れ（Vを下げる）
- **12円以下**の材料があれば優先的に仕入れる
- 仙台(¥10)、札幌(¥11)、福岡(¥12)の材料が残っていれば積極的に購入
- 倉庫容量・製造能力・現金の範囲内で最大限購入
- `executeAIStrategyByType()`の冒頭に安価材料チェック追加

### 4. 倉庫購入タイミング制限
- **残り20行**（期の最初）の時のみ購入
- 期末に没収されるため、後半に買っても効果が薄い問題を解決

### 5. 特急チップROI計算機能
`AIBrain.shouldUseExpressChip(company, chipType, companyIndex)`

#### 判断ロジック
| チップ種類 | 効果 | 損益分岐点 |
|-----------|------|-----------|
| 研究 | 価格競争力+2円 | 20個以上売らないと回収不可 |
| 教育 | 能力+1 | MQ15円×追加生産数 > 40円 |
| 広告 | 販売能力+2 | MQ12円×追加販売数 > 40円 |

#### 判断基準
- 残り行数から販売可能数を推定
- 期待利益が**40円の1.2倍以上**なければ「安く売った方が確実」と判断
- ROIが+の時のみ特急を実行

#### コンソールログ出力
```
[AI特急] 攻め商事: 期待利益80円 > 投資40円
[AI特急見送り] 堅実産業: 残り10個しか売れない → 40円安く売った方が効果的
```

### 6. 販売条件の統一
- 全戦略で「製品が販売能力の7割以上」で販売する条件を維持
- aggressive/conservative/price_focused/tech_focused/balanced 全て統一

## 技術的変更

### 新規関数追加
- `adjustAIBidPrice(delta)`: AI入札価格をステッパーで調整
- `setAIBidPrice(price)`: AI入札価格を直接設定（プリセット用）
- `updateAIBidPriceDisplay()`: AI入札価格の表示を更新
- `AIBrain.shouldUseExpressChip()`: 特急チップROI計算

### 修正箇所
- `showPlayerBidInAIAuction()`: priceCardsをpriceStepperに変更
- `calculateStrategicBidPrice()`: Math.round()追加（3箇所）
- `startAIBidding()`: Math.round()追加
- `processAIOnlyBidding()`: Math.round()追加
- `executeAIStrategyByType()`: 安価材料購入・特急ROI判断追加
- 倉庫購入条件: `rowsRemaining >= 10` → `rowsRemaining >= 20`
