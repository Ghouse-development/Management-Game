# 開発記録 2025-12-29

## 修正内容

### 1. 入札システム改善
- 他社の入札時に希望価格を非表示（「入札価格は非公開」と表示）
- 他社同士も積極的に入札するよう改善（製品2個以上あれば参加）
- AIの性格に応じた入札価格設定（aggressive: 0.7倍, price_focused: 0.75倍, conservative: 0.85倍）

### 2. 各社共通リスクカード実装
- 全社が12円で3個まで材料購入可能
- 市場から優先購入、不足分は海外から補完
- 行を消費しない

### 3. 市場盤の並び順変更
- 販売上限価格の高い順に変更
- 順序: 仙台 → 札幌 → 福岡 → 名古屋 → 大阪 → 東京 → 海外

### 4. 材料総数を100個に設定
- 海外市場の初期在庫を45個に変更（合計: 3+4+6+9+13+20+45=100）

### 5. AI行動最適化
- 2個未満の売買は行わない（行の無駄遣い防止）
- 代わりに生産を試みる
- DO NOTHINGを基本的にしない

### 6. 持ち金表示追加
- 生産モーダル、チップ購入モーダル、材料購入モーダルに持ち金を表示

### 7. 「全体を見る」機能強化
- 全会社盤（自社・他社）を一覧表示
- 市場盤（在庫・価格・閉鎖状況）を表示
- スクロール可能なモーダルで実装

### 8. 規定行数達成時の処理確認
- 誰か1人が規定行数に達した時点で全員の期が終了（既存実装を確認）

### 9. AIの性格実装確認
- 6種類の性格が実装済み
  - aggressive（積極的）
  - conservative（保守的）
  - price_focused（価格競争）
  - tech_focused（技術重視）
  - balanced（バランス）
  - unpredictable（予測不能）

### 10. F（固定費）計算方法修正
- **金利を追加**: 長期借入10%、短期借入20%
- **チップ費用の正確な計算**:
  - 2期: 全チップ20円/枚
  - 3期以降: 繰り越しチップ20円/枚、特急（今期購入）40円/枚
- **carriedOverChips**フィールドを追加して繰り越しチップを追跡
- 期中最大人員 × 半額単価 を含む（確認済み）

### 11. 倉庫処理
- 期末で倉庫をリセット（消滅）
- 倉庫費用20円はextraLaborCostとしてFに計上済み

### 12. 配置転換処理
- 配置転換費用（5円/人）をFに計上
- 1行使用してターン終了

### 13. AI販売・購入最適化
- **販売**: 販売能力の7割以上の製品がある時のみ販売（例：能力10なら7個以上）
- **購入（3期以降）**: 製造能力の7割以上を購入できる時のみ購入
- 7割に満たない場合は生産に回すか見送り

### 14. 市場在庫引き継ぎ確認
- 3期以降、市場在庫は前期を引き継ぐ（カードデッキのみリセット）

### 15. 行使用ルール修正（お金の流れがあるかどうか）
- **各社共通カード**: 購入した場合のみ1行使用（購入しなければ0行）
- **入札キャンセル時**: 行を使わない（nextTurnに変更）
- **入札失敗時**: 行を使わない（playerSoldInBidフラグで追跡）

### 16. 入札結果表示の改善
- **コール価格**: 勝敗判定に使用する価格（表示価格 - 価格競争力）
- **記帳価格**: 売上に計上される価格（表示価格）
- 両方の価格を入札結果画面で明確に表示

### 17. 行動ログ機能の追加
- 期末に「行動ログを見る」ボタンを追加
- 各会社の行動と金銭の流れを一覧表示
- 対象アクション:
  - 商品販売（収入）
  - 材料購入（支出）
  - 完成・投入（支出）
  - 採用（支出）
  - 戦略チップ購入（支出）
  - 各社共通カード購入（支出）

## 技術的変更

### 新規フィールド追加
- `gameState.actionLog`: 行動ログ配列（companyIndex, action, details, cashChange, rowUsed等）
- `gameState.playerSoldInBid`: 入札で販売成功したかのフラグ
- `company.carriedOverChips`: 前期から繰り越したチップ数を追跡

### 新規関数追加
- `logAction()`: 行動ログを記録
- `resetActionLog()`: 行動ログをリセット
- `showActionLogModal()`: 行動ログ表示モーダル

### 関数修正
- `calculateFixedCost()`: 金利・チップ費用の計算を修正
- `executeDefaultSale()`: 7割以上ルール適用
- `executeDefaultMaterialPurchase()`: 7割以上ルール適用
- `viewGameState()`: 全会社盤・市場盤表示
- `reassign()`: F計上・1行使用
- `endPeriod()`: 倉庫リセット・carriedOverChips設定
- `cancelPlayerBid()`: endTurn→nextTurnに変更
- `cancelPlayerBidTwoMarket()`: endTurn→nextTurnに変更
- `completeSale()`: playerSoldInBidフラグで行使用を判定
- `completeSaleTwoMarket()`: playerSoldInBidフラグで行使用を判定
- `processCommonPurchase()`: プレイヤー購入時のみ行使用
- `processAICommonPurchase()`: プレイヤー購入時のみ行使用
- `processBidsWithAllCompanies()`: コール価格/記帳価格表示、ログ記録
- `processBidsWithAllCompaniesTwoMarket()`: コール価格/記帳価格表示、ログ記録
- `showFinancialSummary()`: 行動ログボタン追加

### 18. UI改善（カード選択形式）
- **縁故採用モーダル**: セールスマン/ワーカーをカードタップで選択
  - カラフルなカードUI（セールスマン：赤、ワーカー：茶）
  - ホバー効果付き
- **意思決定カードモーダル**: 7つのアクションをカード形式で表示
  - 各アクションに固有の色とアイコン
  - 会社情報（持ち金、能力、在庫）を同時表示
  - 4列グリッドレイアウト

### 19. AI強化（G最大化・自己資本最大化）
- **投資判断の戦略化**:
  - 期末支払いを考慮した安全マージン確保
  - ボトルネック解消投資のみ実行（無駄な採用・機械購入を排除）
  - 研究チップ優先（価格競争力向上→MQ増加に直結）

- **各戦略の最適化**:
  - **A社（積極的）**: 低価格入札で量を確保、研究チップ投資優先
  - **B社（バランス）**: 7割ルール徹底、バランスのよい投資
  - **C社（保守的）**: 安全マージン大きめ、保険チップ優先
  - **D社（価格競争）**: 薄利多売、ボトルネック解消のみ投資
  - **E社（技術重視）**: 研究・教育・コンピュータチップ優先
  - **F社（予測不能）**: ランダムだが合理的な範囲内で行動

- **無駄な投資の排除**:
  - 期末近く（残り5行以下）は投資しない
  - 製造能力がボトルネックでない場合はワーカー採用しない
  - 販売能力がボトルネックでない場合はセールスマン採用しない
  - ワーカー能力に余裕がなければ機械購入しない

### 関数修正（追加）
- `executeDefaultInvestment()`: G最大化・自己資本最大化志向に全面改修
- `executeAggressiveStrategy()`: 無駄な投資を排除、7割ルール徹底
- `executeConservativeStrategy()`: 保険チップ優先、安全マージン拡大
- `executePriceFocusedStrategy()`: ボトルネック解消投資のみ
- `executeTechFocusedStrategy()`: 教育チップ上限確認、戦略的投資
- `executeBalancedStrategy()`: 7割ルール徹底、バランス投資
- `executeUnpredictableStrategy()`: 合理的な範囲内でランダム行動

### 20. 労災発生時の処理改善
- 労災発生時にアクション選択モーダルを表示
- 許可されるアクション: 材料購入、商品販売、DO NOTHING
- 禁止されるアクション: 完成・投入（生産）
- ターン終了時に労災フラグをリセット
- `showLaborAccidentActionModal()`: 労災時のアクション選択モーダル

### 21. 不良在庫発生の保険対応
- 保険加入時: 1個10円の保険金を受け取れる
- 特別損失 = 失われた価値 - 保険金
- 保険使用後は再加入選択モーダルを表示
- 計算例: 製品5個消失(75円) - 保険金(50円) = 特別損失25円

### 22. 戦略チップのF計算修正（2期）
- 修正前: 持っている全チップ × 20円
- 修正後: 各種1枚分（最大20円）のみ計上
- ルール: 2期は各種チップ1枚だけ返却するため

### 23. 市場タイル位置調整
- 六角形のクリップパス内に収まるよう位置を調整
- 各市場タイルの `top`, `left`, `right`, `bottom` を微調整

### 24. Optional Chaining追加
- `nextPeriodChips` への安全なアクセス
- チップ表示UIでのnull安全性向上

### 25. アラートメッセージ修正
- 期開始時: 「3行目から」→「2行目から」に修正
