<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MG (Management Game) - Ultimate Edition</title>
    <!-- å¤–éƒ¨CSSãƒ•ã‚¡ã‚¤ãƒ« -->
    <link rel="stylesheet" href="css/styles.css">
    <!-- å¤–éƒ¨JSãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆå®šæ•°ï¼‰ -->
    <script src="js/constants.js"></script>
</head>
<body>
    <!-- ãƒˆãƒ¼ã‚¹ãƒˆé€šçŸ¥ã‚³ãƒ³ãƒ†ãƒŠ -->
    <div id="toastContainer" class="toast-container"></div>

    <div class="container">
        <!-- ã‚²ãƒ¼ãƒ ã‚¨ãƒªã‚¢ï¼šå¸‚å ´ç›¤ä¸­å¤®ã€ä»–ç¤¾å‘¨å›² -->
        <div class="game-area">
            <!-- ä¸Šéƒ¨ï¼šä»–ç¤¾ï¼ˆ1-3ï¼‰ -->
            <div class="other-companies-top" id="otherCompaniesTop"></div>

            <!-- ä¸­å¤®ã‚¨ãƒªã‚¢ï¼šå·¦ã®ä»–ç¤¾ | å¸‚å ´ç›¤+ã‚«ãƒ¼ãƒ‰ãƒ‡ãƒƒã‚­ | å³ã®ä»–ç¤¾ -->
            <div class="center-area">
                <!-- å·¦ã®ä»–ç¤¾ -->
                <div class="other-companies-left" id="otherCompaniesLeft"></div>

                <!-- å¸‚å ´ç›¤ï¼ˆä¸­å¤®ï¼‰ã¨ã‚«ãƒ¼ãƒ‰ãƒ‡ãƒƒã‚­ -->
                <div class="market-center">
                    <div class="card-draw-section" id="cardDrawSection">
                        <button class="draw-card-btn" onclick="drawCard()">ã‚«ãƒ¼ãƒ‰ã‚’å¼•ã</button>
                        <div class="turn-info" id="turnInfo">ã‚ãªãŸã®ã‚¿ãƒ¼ãƒ³ã§ã™</div>
                    </div>
                    <div class="markets-board">
                        <div class="markets-inner">
                            <div class="card-deck-area">
                                <div class="deck-cards">DECISION</div>
                            </div>
                            <div class="markets-ring" id="marketsDisplay"></div>
                        </div>
                    </div>
                </div>

                <!-- å³ã®ä»–ç¤¾ -->
                <div class="other-companies-right" id="otherCompaniesRight"></div>
            </div>
        </div>

        <!-- æ‰‹å…ƒã‚¨ãƒªã‚¢ï¼šãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ä¼šç¤¾ç›¤ + å›ºå®šè²» + æ¬¡ç¹°ç›¤ -->
        <div class="player-area-wrapper">
        <div class="player-area">
            <!-- ä¼šç¤¾ç›¤ï¼ˆå¤§ããè¡¨ç¤ºï¼‰ -->
            <div class="company-board" id="companyBoard">
                <!-- æƒ…å ±ãƒãƒ¼ -->
                <div class="board-info-bar">
                    <div class="info-badge period">
                        <span class="info-badge-label">æœŸ</span>
                        <span class="info-badge-value" id="currentPeriod">2</span>
                    </div>
                    <div class="info-badge row">
                        <span class="info-badge-label">è¡Œ</span>
                        <span class="info-badge-value" id="currentRow">2/20</span>
                    </div>
                    <div class="info-badge cash">
                        <span class="info-badge-label">ç¾é‡‘</span>
                        <span class="info-badge-value" id="playerCash">Â¥112</span>
                    </div>
                    <div class="info-badge fixed-cost" onclick="showFixedCostModal()">
                        <span class="info-badge-label">F</span>
                        <span class="info-badge-value" id="fixedCostDisplay">Â¥0</span>
                    </div>
                    <div class="info-badge equity">
                        <span class="info-badge-label">è‡ªå·±è³‡æœ¬</span>
                        <span class="info-badge-value" id="equity">Â¥283</span>
                    </div>
                </div>

                <!-- èƒ½åŠ›ã‚µãƒãƒªãƒ¼ -->
                <div class="capacity-summary" id="capacitySummary">
                    <div class="capacity-item mfg">
                        <span class="capacity-label">è£½é€ </span>
                        <span class="capacity-value" id="mfgCapacityDisplay">1</span>
                    </div>
                    <div class="capacity-item sales">
                        <span class="capacity-label">è²©å£²</span>
                        <span class="capacity-value" id="salesCapacityDisplay">2</span>
                    </div>
                    <div class="capacity-item price">
                        <span class="capacity-label">ä¾¡æ ¼</span>
                        <span class="capacity-value" id="priceCompDisplay">+0</span>
                    </div>
                </div>

                <!-- ç”Ÿç”£ãƒ•ãƒ­ãƒ¼ -->
                <div class="production-flow">
                    <div class="flow-box">
                        <div class="flow-box-title">ææ–™å€‰åº«</div>
                        <div class="flow-box-content" id="materialsDisplay"></div>
                    </div>
                    <div class="flow-arrow">
                        <span class="flow-arrow-icon">â†’</span>
                        <span class="flow-arrow-label">æŠ•å…¥</span>
                    </div>
                    <div class="flow-box factory">
                        <div class="flow-box-title">å·¥å ´ï¼ˆä»•æ›å“ï¼‰</div>
                        <div class="flow-box-content" id="wipDisplay"></div>
                    </div>
                    <div class="flow-arrow">
                        <span class="flow-arrow-icon">â†’</span>
                        <span class="flow-arrow-label">å®Œæˆ</span>
                    </div>
                    <div class="flow-box">
                        <div class="flow-box-title">å–¶æ¥­æ‰€ï¼ˆè£½å“ï¼‰</div>
                        <div class="flow-box-content" id="productsDisplay"></div>
                    </div>
                </div>

                <!-- äººå“¡ãƒ»æ©Ÿæ¢° -->
                <div class="personnel-row">
                    <div class="personnel-box">
                        <div class="personnel-box-title">ãƒ¯ãƒ¼ã‚«ãƒ¼</div>
                        <div class="personnel-dots" id="workersDisplay"></div>
                    </div>
                    <div class="personnel-box">
                        <div class="personnel-box-title">æ©Ÿæ¢°</div>
                        <div class="personnel-dots" id="machinesDisplay"></div>
                    </div>
                    <div class="personnel-box">
                        <div class="personnel-box-title">ã‚»ãƒ¼ãƒ«ã‚¹ãƒãƒ³</div>
                        <div class="personnel-dots" id="salesmenDisplay"></div>
                    </div>
                </div>

                <!-- ãƒãƒƒãƒ— -->
                <div class="chips-row">
                    <div class="chip-box">
                        <div class="chip-box-title">ç ”ç©¶</div>
                        <div class="chip-dots" id="researchChipsDisplay"></div>
                    </div>
                    <div class="chip-box">
                        <div class="chip-box-title">æ•™è‚²</div>
                        <div class="chip-dots" id="educationChipsDisplay"></div>
                    </div>
                    <div class="chip-box">
                        <div class="chip-box-title">åºƒå‘Š</div>
                        <div class="chip-dots" id="advertisingChipsDisplay"></div>
                    </div>
                    <div class="chip-box">
                        <div class="chip-box-title">PC</div>
                        <div class="chip-dots" id="computerChipsDisplay"></div>
                    </div>
                    <div class="chip-box">
                        <div class="chip-box-title">ä¿é™º</div>
                        <div class="chip-dots" id="insuranceChipsDisplay"></div>
                    </div>
                </div>
            </div>

            <!-- Få†…è¨³ãƒ‘ãƒãƒ« -->
            <div class="fixed-cost-panel">
                <div class="panel-title">Få†…è¨³</div>
                <div class="cost-breakdown" id="fixedCostBreakdown"></div>
            </div>

            <!-- æ¬¡ç¹°ç›¤ï¼ˆ3æœŸä»¥é™ã®ã¿è¡¨ç¤ºï¼‰ -->
            <div class="next-period-board" id="nextPeriodBoard" style="display: none;">
                <div class="board-title" style="background: #6b21a8;">æ¬¡ç¹°ç›¤</div>
                <div class="next-period-content">
                    <div class="next-chips">
                        <span class="next-chip-item">ç ”ç©¶: <span id="nextResearch">0</span></span>
                        <span class="next-chip-item">æ•™è‚²: <span id="nextEducation">0</span></span>
                        <span class="next-chip-item">åºƒå‘Š: <span id="nextAdvertising">0</span></span>
                    </div>
                </div>
            </div>
        </div>
        </div> <!-- player-area-wrapper -->
    </div>

    <div id="modalContainer"></div>
    
    <script>
// MG Game Ultimate Edition - Complete Implementation
const gameState = {
    currentPeriod: 2,
    currentRow: 2,  // 2æœŸã¯æœŸé¦–å‡¦ç†å¾Œ2è¡Œç›®ã‹ã‚‰é–‹å§‹ï¼ˆå»ƒæ­¢äºˆå®šï¼‰
    maxRows: MAX_ROWS_BY_PERIOD[2],  // ç¾åœ¨ã®æœŸã®è¡Œæ•°ä¸Šé™ï¼ˆå®šæ•°ã‹ã‚‰å–å¾—ï¼‰
    maxRowsByPeriod: MAX_ROWS_BY_PERIOD,  // å„æœŸã®è¡Œæ•°ä¸Šé™ï¼ˆå®šæ•°ã‹ã‚‰å‚ç…§ï¼‰
    currentPlayerIndex: 0,
    turnOrder: [],
    skipTurns: {},
    doNothingCount: {},
    usedRiskCards: [],
    usedDecisionCards: [],
    reverseOrder: false,
    turnReversed: false,  // æ™¯æ°—å¤‰å‹•ã«ã‚ˆã‚‹é€†å›ã‚Š
    periodStarted: false,
    waitingForBids: false,
    currentBids: [],
    bidMarkets: [],

    // è¡Œå‹•ãƒ­ã‚°ï¼ˆæœŸæœ«ã«è¡¨ç¤ºï¼‰
    actionLog: [],  // {companyIndex, companyName, action, details, cashBefore, cashAfter, rowUsed}
    playerSoldInBid: null,  // å…¥æœ­ã§ã®è²©å£²æˆåŠŸãƒ•ãƒ©ã‚°

    // å¸‚å ´é¸æŠãƒ¢ãƒ¼ãƒ‰
    salesMode: false,  // è²©å£²ãƒ¢ãƒ¼ãƒ‰ï¼ˆå¸‚å ´ã‚¿ãƒƒãƒ—ã§è²©å£²ï¼‰
    buyMode: false,    // è³¼å…¥ãƒ¢ãƒ¼ãƒ‰ï¼ˆå¸‚å ´ã‚¿ãƒƒãƒ—ã§ææ–™è³¼å…¥ï¼‰
    twoMarketMode: false,  // 2å¸‚å ´è²©å£²ãƒ¢ãƒ¼ãƒ‰ ('simultaneous' or 'separate' or false)
    selectedMarkets: [],   // 2å¸‚å ´è²©å£²ã§é¸æŠã•ã‚ŒãŸå¸‚å ´ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
    pendingSeparateBids: null, // åˆ¥ã€…è²©å£²ã®å…¥æœ­ã‚­ãƒ¥ãƒ¼

    // 3æœŸä»¥é™ã®ã‚µã‚¤ã‚³ãƒ­çµæœ
    diceRoll: null,  // 1-6ã®å€¤
    wageMultiplier: 1.0,  // äººä»¶è²»å€ç‡ï¼ˆ1.1ã¾ãŸã¯1.2ï¼‰
    osakaMaxPrice: 24,  // å¤§é˜ªä¸Šé™ä¾¡æ ¼ï¼ˆ21-26ï¼‰

    // ã‚«ãƒ¼ãƒ‰ãƒ‡ãƒƒã‚­ï¼ˆ75æšï¼š60æšæ„æ€æ±ºå®š + 15æšãƒªã‚¹ã‚¯ï¼‰
    cardDeck: [],
    deckInitialized: false,
    
    // å¸‚å ´ãƒ‡ãƒ¼ã‚¿ï¼ˆMARKETSå®šæ•°ã‹ã‚‰åˆæœŸåŒ–ã€currentStockã‚’è¿½åŠ ï¼‰
    markets: MARKETS.map(m => ({
        ...m,
        currentStock: m.initialStock
    })),
    
    // æ„æ€æ±ºå®šã‚«ãƒ¼ãƒ‰ï¼ˆå®šæ•°ã‹ã‚‰å‚ç…§ï¼‰
    decisionCards: DECISION_CARDS,
    
    // ãƒªã‚¹ã‚¯ã‚«ãƒ¼ãƒ‰ï¼ˆå®šæ•°ã‹ã‚‰å‚ç…§ - 64æšï¼‰
    riskCards: RISK_CARDS,
    
    companies: []
};

// Handle cash shortage - first sell materials, then short-term loan
// Returns object with details of actions taken
function handleCashShortage(company, neededAmount) {
    let shortage = neededAmount - company.cash;
    if (shortage <= 0) return { materialsSold: 0, loanAmount: 0 };

    let materialsSold = 0;
    let materialRevenue = 0;

    // First, sell materials at Â¥10 each to overseas market
    if (company.materials > 0 && shortage > 0) {
        const materialsToSell = Math.min(company.materials, Math.ceil(shortage / 10));
        materialsSold = materialsToSell;
        materialRevenue = materialsToSell * 10;
        company.materials -= materialsToSell;
        company.cash += materialRevenue;

        // Add to overseas market stock
        const overseasMarket = gameState.markets.find(m => m.name === 'æµ·å¤–');
        if (overseasMarket) {
            overseasMarket.currentStock += materialsToSell;
        }

        shortage = neededAmount - company.cash;
    }

    let loanAmount = 0;

    // If still not enough, take short-term loan
    if (shortage > 0) {
        // Short-term loan: receive 80% of loan amount
        loanAmount = Math.ceil(shortage / 0.8 / 50) * 50;
        company.shortLoans += loanAmount;
        company.cash += loanAmount * 0.8;
    }

    return { materialsSold, materialRevenue, loanAmount };
}

// Initialize companies (6äºº: ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼1äºº + AI 5äººã€ãƒ©ãƒ³ãƒ€ãƒ æˆ¦ç•¥)
function initializeCompanies() {
    // AIæˆ¦ç•¥ã‚’ãƒ©ãƒ³ãƒ€ãƒ ã«é¸æŠ
    const strategies = ['aggressive', 'balanced', 'conservative', 'price_focused', 'tech_focused', 'unpredictable'];
    const shuffledStrategies = strategies.sort(() => Math.random() - 0.5);

    const companyNames = ['é’å±±å•†äº‹', 'éˆ´æœ¨ç”£æ¥­', 'ç”°ä¸­è£½ä½œæ‰€', 'å±±æœ¬å·¥æ¥­', 'ä½è—¤ç‰©ç”£'];

    const companyTypes = [
        {name: 'ã‚ãªãŸ', type: 'player', strategy: 'player'},
        ...companyNames.map((name, i) => ({
            name: name,
            type: 'ai',
            strategy: shuffledStrategies[i % shuffledStrategies.length]
        }))
    ];
    
    // 2æœŸé–‹å§‹: 137å†† â†’ æœŸé¦–å‡¦ç†ï¼ˆã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿20å††+ä¿é™º5å††=25å††ï¼‰â†’ 112å††ã§2è¡Œç›®ã‚¹ã‚¿ãƒ¼ãƒˆ
    gameState.companies = companyTypes.map(ct => ({
        name: ct.name,
        type: ct.type,
        strategy: ct.strategy || ct.type,  // strategyã¾ãŸã¯typeã‚’ä½¿ç”¨
        cash: 112,  // 2æœŸé–‹å§‹æ™‚ã®ç¾é‡‘ï¼ˆæœŸé¦–å‡¦ç†å¾Œ: 137-25=112ï¼‰
        equity: 283,
        loans: 0,
        shortLoans: 0,
        currentRow: 2,  // æœŸé¦–å‡¦ç†ã§1è¡Œä½¿ç”¨æ¸ˆã¿ã€2è¡Œç›®ã‹ã‚‰ã‚¹ã‚¿ãƒ¼ãƒˆ
        materials: 1,  // 2æœŸé–‹å§‹æ™‚ã®åˆæœŸåœ¨åº«
        wip: 2,         // 2æœŸé–‹å§‹æ™‚ã®åˆæœŸåœ¨åº«
        products: 1,    // 2æœŸé–‹å§‹æ™‚ã®åˆæœŸåœ¨åº«
        workers: 1,
        salesmen: 1,
        machines: [{type: 'small', attachments: 0}],
        warehouses: 0,  // ç„¡ç½å®³å€‰åº«ã®æ•°ï¼ˆ0, 1, or 2ï¼‰
        warehouseLocation: 'materials',  // 1å€‹ã®å ´åˆã®è¨­ç½®å ´æ‰€ ('materials' or 'products')
        chips: {
            computer: 1,  // æœŸé¦–å‡¦ç†ã§è³¼å…¥æ¸ˆã¿
            insurance: 1, // æœŸé¦–å‡¦ç†ã§è³¼å…¥æ¸ˆã¿
            research: 0,
            education: 0,
            advertising: 0
        },
        nextPeriodChips: {
            research: 0,
            education: 0,
            advertising: 0
        },
        carriedOverChips: {  // å‰æœŸã‹ã‚‰ç¹°ã‚Šè¶Šã—ãŸãƒãƒƒãƒ—ï¼ˆFè¨ˆç®—ã§20å††/æšï¼‰
            research: 0,
            education: 0,
            advertising: 0
        },
        periodStartInventory: {
            materials: 1,
            wip: 2,
            products: 1
        },
        skipTurns: 0,
        rowsUsed: 0,
        decisionCard: null,
        totalSales: 0,  // PQè¨ˆç®—ç”¨
        totalMaterialCost: 0,  // VQè¨ˆç®—ç”¨
        totalProductionCost: 0,  // VQè¨ˆç®—ç”¨
        extraLaborCost: 0,  // è¿½åŠ äººä»¶è²»ï¼ˆé€€è·ã€ç¸æ•…æ¡ç”¨ã€å€‰åº«ç­‰ï¼‰
        retiredWorkers: 0,  // æœŸä¸­ã«é€€è·ã—ãŸãƒ¯ãƒ¼ã‚«ãƒ¼æ•°ï¼ˆ0.5åã¨ã—ã¦çµ¦æ–™è¨ˆç®—ï¼‰
        retiredSalesmen: 0,  // æœŸä¸­ã«é€€è·ã—ãŸã‚»ãƒ¼ãƒ«ã‚¹ãƒãƒ³æ•°ï¼ˆ0.5åã¨ã—ã¦çµ¦æ–™è¨ˆç®—ï¼‰
        maxPersonnel: 2,  // æœŸä¸­æœ€å¤§äººå“¡ï¼ˆæœŸé¦–=ãƒ¯ãƒ¼ã‚«ãƒ¼1+ã‚»ãƒ¼ãƒ«ã‚¹ãƒãƒ³1ï¼‰
        hasExceeded300: false,  // è‡ªå·±è³‡æœ¬ãŒÂ¥300ã‚’è¶…ãˆãŸã“ã¨ãŒã‚ã‚‹ã‹
        pendingTax: 0,  // æ¬¡æœŸæœŸé¦–ã«æ”¯æ‰•ã†ç¨é‡‘
        pendingDividend: 0,  // æ¬¡æœŸæœŸé¦–ã«æ”¯æ‰•ã†é…å½“
        aiStrategy: ct.type
    }));
}

// Calculate manufacturing capacity
function getManufacturingCapacity(company) {
    let baseMachineCapacity = 0;
    company.machines.forEach(machine => {
        if (machine.type === 'small') {
            baseMachineCapacity += machine.attachments > 0 ? 2 : 1;
        } else if (machine.type === 'large') {
            baseMachineCapacity += 4;
        }
    });
    
    // ãƒ¯ãƒ¼ã‚«ãƒ¼ãŒ0äººãªã‚‰è£½é€ èƒ½åŠ›0
    if (company.workers === 0) {
        return 0;
    }
    
    // æ©Ÿæ¢°å°æ•°ã¨ãƒ¯ãƒ¼ã‚«ãƒ¼äººæ•°ã‚’ãƒã‚§ãƒƒã‚¯
    const machineCount = company.machines.length;
    if (company.workers < machineCount) {
        // ãƒ¯ãƒ¼ã‚«ãƒ¼ãŒæ©Ÿæ¢°å°æ•°ã‚ˆã‚Šå°‘ãªã„å ´åˆã€ãƒ¯ãƒ¼ã‚«ãƒ¼äººæ•°ãŒä¸Šé™
        return company.workers;
    }
    
    // æ©Ÿæ¢°èƒ½åŠ›ã®è¨ˆç®—
    // åŸºæœ¬æ©Ÿæ¢°èƒ½åŠ› + ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ãƒãƒƒãƒ—(+1) + æ•™è‚²ãƒãƒƒãƒ—(+1)
    let manufacturingCapacity = baseMachineCapacity + (company.chips.computer || 0);
    
    // æ•™è‚²ãƒãƒƒãƒ—ã§è£½é€ èƒ½åŠ›+1ï¼ˆåŠ¹æœã¯å¸¸ã«1æšåˆ†ãŒä¸Šé™ï¼‰
    const educationBonus = Math.min(company.chips.education || 0, 1);
    manufacturingCapacity += educationBonus;
    
    return manufacturingCapacity;
}

// Calculate sales capacity
function getSalesCapacity(company) {
    // ã‚»ãƒ¼ãƒ«ã‚¹ãƒãƒ³0äººãªã‚‰è²©å£²èƒ½åŠ›0ï¼ˆæ•™è‚²ãƒãƒƒãƒ—ãŒã‚ã£ã¦ã‚‚ç„¡åŠ¹ï¼‰
    if (company.salesmen === 0) {
        return 0;
    }

    // ã‚»ãƒ¼ãƒ«ã‚¹ãƒãƒ³Ã—2
    const baseCapacity = company.salesmen * 2;

    // åºƒå‘Šãƒãƒƒãƒ—åŠ¹æœï¼ˆ1æšã«ã¤ã+2ã€ã‚»ãƒ¼ãƒ«ã‚¹ãƒãƒ³1äººã«ã¤ã2æšã¾ã§æœ‰åŠ¹ï¼‰
    const effectiveAdChips = Math.min(company.chips.advertising || 0, company.salesmen * 2);
    const adBonus = effectiveAdChips * 2;

    // åŸºæœ¬è²©å£²èƒ½åŠ›
    let salesCapacity = baseCapacity + adBonus;

    // æ•™è‚²ãƒãƒƒãƒ—ã§è²©å£²èƒ½åŠ›+1ï¼ˆåŠ¹æœã¯å¸¸ã«1æšåˆ†ãŒä¸Šé™ï¼‰
    const educationBonus = Math.min(company.chips.education || 0, 1);
    salesCapacity += educationBonus;

    return salesCapacity;
}

// ææ–™ç½®å ´ã®å®¹é‡ã‚’å–å¾—ï¼ˆå€‰åº«ä½ç½®ã«åŸºã¥ãï¼‰
function getMaterialCapacity(company) {
    const baseCapacity = 10;
    const warehouseBonus = 12;

    if (company.warehouses === 0) {
        return baseCapacity;
    } else if (company.warehouses === 1) {
        // 1å€‹ã®å ´åˆã€warehouseLocationã«åŸºã¥ã
        return company.warehouseLocation === 'materials' ? baseCapacity + warehouseBonus : baseCapacity;
    } else {
        // 2å€‹ã®å ´åˆã€ä¸¡æ–¹ã«è¨­ç½®
        return baseCapacity + warehouseBonus;
    }
}

// è£½å“ç½®å ´ã®å®¹é‡ã‚’å–å¾—ï¼ˆå€‰åº«ä½ç½®ã«åŸºã¥ãï¼‰
function getProductCapacity(company) {
    const baseCapacity = 10;
    const warehouseBonus = 12;

    if (company.warehouses === 0) {
        return baseCapacity;
    } else if (company.warehouses === 1) {
        // 1å€‹ã®å ´åˆã€warehouseLocationã«åŸºã¥ã
        return company.warehouseLocation === 'products' ? baseCapacity + warehouseBonus : baseCapacity;
    } else {
        // 2å€‹ã®å ´åˆã€ä¸¡æ–¹ã«è¨­ç½®
        return baseCapacity + warehouseBonus;
    }
}

// ææ–™ãŒç«ç½ã‹ã‚‰ä¿è­·ã•ã‚Œã¦ã„ã‚‹ã‹ï¼ˆç„¡ç½å®³å€‰åº«ãŒææ–™ç½®å ´ã«ã‚ã‚‹ï¼‰
function isMaterialProtectedFromFire(company) {
    if (company.warehouses === 0) return false;
    if (company.warehouses === 1) {
        return company.warehouseLocation === 'materials';
    }
    return true;  // 2å€‹ã®å ´åˆã¯ä¸¡æ–¹ã«è¨­ç½®
}

// è£½å“ãŒç›—é›£ã‹ã‚‰ä¿è­·ã•ã‚Œã¦ã„ã‚‹ã‹ï¼ˆç„¡ç½å®³å€‰åº«ãŒè£½å“ç½®å ´ã«ã‚ã‚‹ï¼‰
function isProductProtectedFromTheft(company) {
    if (company.warehouses === 0) return false;
    if (company.warehouses === 1) {
        return company.warehouseLocation === 'products';
    }
    return true;  // 2å€‹ã®å ´åˆã¯ä¸¡æ–¹ã«è¨­ç½®
}

// è¡Œå‹•ãƒ­ã‚°ã‚’è¨˜éŒ²ã™ã‚‹é–¢æ•°
function logAction(companyIndex, action, details, cashChange = 0, rowUsed = false) {
    const company = gameState.companies[companyIndex];
    gameState.actionLog.push({
        companyIndex: companyIndex,
        companyName: company.name,
        action: action,
        details: details,
        cashChange: cashChange,  // æ­£=åå…¥ã€è² =æ”¯å‡º
        rowUsed: rowUsed,
        row: company.currentRow,
        timestamp: Date.now()
    });
}

// è¡Œå‹•ãƒ­ã‚°ã‚’ãƒªã‚»ãƒƒãƒˆï¼ˆæœŸã®é–‹å§‹æ™‚ï¼‰
function resetActionLog() {
    gameState.actionLog = [];
}

// è¡Œå‹•ãƒ­ã‚°ã‚’è¡¨ç¤ºã™ã‚‹ãƒ¢ãƒ¼ãƒ€ãƒ«
function showActionLogModal() {
    const companies = gameState.companies;

    let content = `
        <div style="max-height: 70vh; overflow-y: auto; padding: 10px;">
            <div style="text-align: center; margin-bottom: 15px;">
                <div style="font-size: 20px; font-weight: bold;">ç¬¬${gameState.currentPeriod}æœŸ è¡Œå‹•ãƒ­ã‚°</div>
            </div>
    `;

    // å„ä¼šç¤¾ã”ã¨ã«ãƒ­ã‚°ã‚’ã¾ã¨ã‚ã‚‹
    for (let i = 0; i < companies.length; i++) {
        const company = companies[i];
        const companyLogs = gameState.actionLog.filter(log => log.companyIndex === i);
        const emoji = i === 0 ? 'ğŸ‘¤' : ['ğŸ…°ï¸', 'ğŸ…±ï¸', 'Â©ï¸', 'ğŸ‡©', 'ğŸ‡ª'][i - 1] || 'ğŸ¢';
        const bgColor = i === 0 ? '#eff6ff' : '#f9fafb';

        content += `
            <div style="background: ${bgColor}; border-radius: 10px; padding: 12px; margin-bottom: 12px; border: 1px solid #e5e7eb;">
                <div style="display: flex; align-items: center; margin-bottom: 10px; border-bottom: 1px solid #e5e7eb; padding-bottom: 8px;">
                    <span style="font-size: 24px; margin-right: 10px;">${emoji}</span>
                    <span style="font-weight: bold; font-size: 16px; color: ${i === 0 ? '#2563eb' : '#374151'};">${company.name}</span>
                    <span style="margin-left: auto; font-size: 12px; color: #666;">ä½¿ç”¨è¡Œæ•°: ${company.currentRow - 1}</span>
                </div>
        `;

        if (companyLogs.length === 0) {
            content += `<div style="color: #999; font-size: 12px; padding: 5px;">è¡Œå‹•è¨˜éŒ²ãªã—</div>`;
        } else {
            content += '<div style="font-size: 12px;">';
            companyLogs.forEach((log, idx) => {
                const cashStr = log.cashChange !== 0
                    ? `<span style="color: ${log.cashChange > 0 ? '#16a34a' : '#dc2626'}; font-weight: bold;">${log.cashChange > 0 ? '+' : ''}Â¥${log.cashChange}</span>`
                    : '';
                const rowStr = log.rowUsed ? `<span style="color: #9333ea; margin-left: 5px;">ã€1è¡Œã€‘</span>` : '';

                content += `
                    <div style="display: flex; align-items: flex-start; padding: 4px 0; ${idx < companyLogs.length - 1 ? 'border-bottom: 1px dashed #e5e7eb;' : ''}">
                        <span style="color: #9ca3af; width: 25px; flex-shrink: 0;">${log.row}è¡Œ</span>
                        <span style="color: #374151; flex: 1;">${log.action}: ${log.details}</span>
                        <span style="min-width: 70px; text-align: right;">${cashStr}${rowStr}</span>
                    </div>
                `;
            });
            content += '</div>';
        }

        // ç·è¨ˆ
        const totalIncome = companyLogs.filter(l => l.cashChange > 0).reduce((sum, l) => sum + l.cashChange, 0);
        const totalExpense = companyLogs.filter(l => l.cashChange < 0).reduce((sum, l) => sum + l.cashChange, 0);
        content += `
            <div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid #d1d5db; display: flex; justify-content: space-between; font-size: 11px;">
                <span style="color: #16a34a;">åå…¥è¨ˆ: +Â¥${totalIncome}</span>
                <span style="color: #dc2626;">æ”¯å‡ºè¨ˆ: Â¥${totalExpense}</span>
                <span style="font-weight: bold;">å·®å¼•: Â¥${totalIncome + totalExpense}</span>
            </div>
        `;

        content += '</div>';
    }

    content += `
        </div>
        <button class="submit-btn" onclick="closeModal()">é–‰ã˜ã‚‹</button>
    `;

    showModal('è¡Œå‹•ãƒ­ã‚°', content);
}

// Get price competitiveness
function getPriceCompetitiveness(company, companyIndex = null) {
    // companyIndexãŒæ¸¡ã•ã‚Œãªã„å ´åˆã¯ã€companiesã‹ã‚‰æ¤œç´¢
    if (companyIndex === null) {
        companyIndex = gameState.companies.indexOf(company);
    }
    
    // è¦ªï¼ˆç¾åœ¨ã®ã‚¿ãƒ¼ãƒ³ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ï¼‰ã¯è¿½åŠ ã§2å††ã®ä¾¡æ ¼ç«¶äº‰åŠ›
    const isParent = (companyIndex === gameState.currentPlayerIndex);
    const parentBonus = isParent ? 2 : 0;
    return (company.chips.research * 2) + parentBonus;  // ç ”ç©¶ãƒãƒƒãƒ—1æšã«ã¤ã2å†† + è¦ªãƒœãƒ¼ãƒŠã‚¹
}

// Calculate salary costs (çµ¦æ–™)
function calculateSalaryCost(company, period) {
    let cost = 0;

    // åŸºæœ¬å˜ä¾¡ï¼ˆå®šæ•°ã‹ã‚‰å–å¾—ã€ã‚µã‚¤ã‚³ãƒ­ã«ã‚ˆã‚‹å¤‰å‹•ã¯3æœŸä»¥é™ï¼‰
    let unitCost = BASE_SALARY_BY_PERIOD[period];
    let halfCost = Math.round(unitCost / 2);

    // 3æœŸä»¥é™ã¯ã‚µã‚¤ã‚³ãƒ­ã§å˜ä¾¡å¤‰å‹•
    if (period >= 3 && gameState.wageMultiplier > 1) {
        unitCost = Math.round(BASE_SALARY_BY_PERIOD[period] * gameState.wageMultiplier);
        halfCost = Math.round(unitCost / 2);
    }

    // æ©Ÿæ¢°å°æ•° Ã— å˜ä¾¡
    const machineCount = company.machines.length;
    cost += machineCount * unitCost;

    // ãƒ¯ãƒ¼ã‚«ãƒ¼ï¼ˆç¾åœ¨ + é€€è·è€…0.5ï¼‰Ã— å˜ä¾¡
    const effectiveWorkers = company.workers + (company.retiredWorkers || 0) * 0.5;
    cost += effectiveWorkers * unitCost;

    // ã‚»ãƒ¼ãƒ«ã‚¹ãƒãƒ³ï¼ˆç¾åœ¨ + é€€è·è€…0.5ï¼‰Ã— å˜ä¾¡
    const effectiveSalesmen = company.salesmen + (company.retiredSalesmen || 0) * 0.5;
    cost += effectiveSalesmen * unitCost;

    // æœŸä¸­æœ€å¤§äººå“¡ Ã— åŠé¡å˜ä¾¡
    const maxPersonnel = company.maxPersonnel || (company.workers + company.salesmen);
    cost += maxPersonnel * halfCost;

    return Math.round(cost);
}

// Calculate depreciationï¼ˆå®šæ•°ã‚’ä½¿ç”¨ï¼‰
function calculateDepreciation(company, period) {
    let cost = 0;
    const isPeriod2 = period === 2;

    company.machines.forEach(machine => {
        if (machine.type === 'small') {
            if (machine.attachments > 0) {
                // å°å‹+ã‚¢ã‚¿ãƒƒãƒãƒ¡ãƒ³ãƒˆ
                cost += isPeriod2 ? DEPRECIATION.smallWithAttachment.period2 : DEPRECIATION.smallWithAttachment.period3plus;
            } else {
                // å°å‹ã®ã¿
                cost += isPeriod2 ? DEPRECIATION.small.period2 : DEPRECIATION.small.period3plus;
            }
        } else if (machine.type === 'large') {
            // å¤§å‹
            cost += isPeriod2 ? DEPRECIATION.large.period2 : DEPRECIATION.large.period3plus;
        }
    });

    return cost;
}

// Calculate period end payment (æœŸæœ«æ”¯æ‰•)ï¼ˆå®šæ•°ã‚’ä½¿ç”¨ï¼‰
function calculatePeriodPayment(company, useEndOfPeriod = false) {
    const period = gameState.currentPeriod;
    let payment = 0;

    // çµ¦æ–™ï¼ˆæœŸæœ«è¨ˆç®—æ™‚ã¯æœŸæœ«æ™‚ç‚¹ã®äººæ•°ã‚’ä½¿ç”¨ï¼‰
    if (useEndOfPeriod && company.endOfPeriodStats) {
        // æœŸæœ«æ™‚ç‚¹ã®äººæ•°ãƒ»æ©Ÿæ¢°å°æ•°ã§è¨ˆç®—
        let unitCost = BASE_SALARY_BY_PERIOD[period] || BASE_SALARY_BY_PERIOD[2];
        if (period >= 3 && gameState.wageMultiplier > 1) {
            unitCost = Math.round(BASE_SALARY_BY_PERIOD[period] * gameState.wageMultiplier);
        }
        const halfCost = Math.round(unitCost / 2);

        payment += company.endOfPeriodStats.machines * unitCost;
        payment += company.endOfPeriodStats.workers * unitCost;
        payment += company.endOfPeriodStats.salesmen * unitCost;
        payment += (company.endOfPeriodStats.workers + company.endOfPeriodStats.salesmen) * halfCost;
    } else {
        payment += calculateSalaryCost(company, period);
    }

    // é•·æœŸå€Ÿå…¥è¿”æ¸ˆï¼ˆå…ƒæœ¬ã®10%ä»¥ä¸Šï¼‰
    if (company.loans > 0) {
        payment += Math.floor(company.loans * INTEREST_RATES.longTerm);
    }

    // çŸ­æœŸå€Ÿå…¥è¿”æ¸ˆï¼ˆå…ƒæœ¬ã®20%ä»¥ä¸Šï¼‰
    if (company.shortLoans > 0) {
        payment += Math.floor(company.shortLoans * INTEREST_RATES.shortTerm);
    }

    return payment;
}

// Calculate chip costsï¼ˆå®šæ•°ã‚’ä½¿ç”¨ï¼‰
function calculateChipCost(company, period) {
    let cost = 0;

    // ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ãƒ»ä¿é™º
    cost += (company.chips.computer || 0) * CHIP_COSTS.computer;
    cost += (company.chips.insurance || 0) * CHIP_COSTS.insurance;

    // æˆ¦ç•¥ãƒãƒƒãƒ—
    if (period === 2) {
        // 2æœŸã¯å„1æšåˆ†ã®ã¿å›ºå®šè²»
        if (company.chips.research > 0) cost += CHIP_COSTS.normal;
        if (company.chips.education > 0) cost += CHIP_COSTS.normal;
        if (company.chips.advertising > 0) cost += CHIP_COSTS.normal;
    } else {
        // 3æœŸä»¥é™
        cost += (company.chips.research || 0) * CHIP_COSTS.express;  // ç‰¹æ€¥
        cost += (company.chips.education || 0) * CHIP_COSTS.express; // ç‰¹æ€¥
        cost += (company.chips.advertising || 0) * CHIP_COSTS.express; // ç‰¹æ€¥
        cost += (company.nextPeriodChips?.research || 0) * CHIP_COSTS.normal; // ç¹°è¶Š
        cost += (company.nextPeriodChips?.education || 0) * CHIP_COSTS.normal; // ç¹°è¶Š
        cost += (company.nextPeriodChips?.advertising || 0) * CHIP_COSTS.normal; // ç¹°è¶Š
    }

    return cost;
}

// Calculate fixed costs total (å›ºå®šè²»åˆè¨ˆ - ç°¡æ˜“è¡¨ç¤ºç”¨)
function calculateFixedCostTotal(company, period) {
    return calculateFixedCost(company);
}

// Calculate fixed costs (å›ºå®šè²») - ç¨é‡‘é™¤å¤–ï¼ˆå®šæ•°ã‚’ä½¿ç”¨ï¼‰
function calculateFixedCost(company) {
    const period = gameState.currentPeriod;
    let cost = 0;

    // çµ¦æ–™ï¼ˆäººä»¶è²»ï¼‰
    cost += calculateSalaryCost(company, period);

    // å€Ÿå…¥é‡‘åˆ©ï¼ˆFã«å«ã‚ã‚‹ï¼‰
    cost += Math.round((company.loans || 0) * INTEREST_RATES.longTerm);
    cost += Math.round((company.shortLoans || 0) * INTEREST_RATES.shortTerm);

    // ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ãƒ»ä¿é™ºè²»ç”¨
    cost += (company.chips.computer || 0) * CHIP_COSTS.computer;
    cost += (company.chips.insurance || 0) * CHIP_COSTS.insurance;

    // æˆ¦ç•¥ãƒãƒƒãƒ—è²»ç”¨
    const carriedOver = company.carriedOverChips || {research: 0, education: 0, advertising: 0};

    if (period === 2) {
        // 2æœŸï¼šå„ç¨®1æšã ã‘è¿”å´ â†’ å„ç¨®æœ€å¤§20å††ã®ã¿
        if (company.chips.research > 0) cost += CHIP_COSTS.normal;
        if (company.chips.education > 0) cost += CHIP_COSTS.normal;
        if (company.chips.advertising > 0) cost += CHIP_COSTS.normal;
    } else {
        // 3-5æœŸï¼šç¹°ã‚Šè¶Šã—åˆ†ã¯é€šå¸¸ä¾¡æ ¼ã€ä»ŠæœŸè³¼å…¥ï¼ˆç‰¹æ€¥ï¼‰ã¯ç‰¹æ€¥ä¾¡æ ¼
        // ç¹°ã‚Šè¶Šã—ãƒãƒƒãƒ—ï¼ˆå‰æœŸã‹ã‚‰æŒã¡è¶Šã—ï¼‰
        cost += (carriedOver.research || 0) * CHIP_COSTS.normal;
        cost += (carriedOver.education || 0) * CHIP_COSTS.normal;
        cost += (carriedOver.advertising || 0) * CHIP_COSTS.normal;

        // ä»ŠæœŸç‰¹æ€¥è³¼å…¥åˆ†ï¼ˆchips - carriedOverï¼‰
        const urgentResearch = Math.max(0, (company.chips.research || 0) - (carriedOver.research || 0));
        const urgentEducation = Math.max(0, (company.chips.education || 0) - (carriedOver.education || 0));
        const urgentAdvertising = Math.max(0, (company.chips.advertising || 0) - (carriedOver.advertising || 0));
        cost += urgentResearch * CHIP_COSTS.express;
        cost += urgentEducation * CHIP_COSTS.express;
        cost += urgentAdvertising * CHIP_COSTS.express;

        // æ¬¡æœŸç¹°ã‚Šè¶Šã—åˆ†ï¼ˆæ¥æœŸç”¨ã«è³¼å…¥ï¼‰
        cost += (company.nextPeriodChips?.research || 0) * CHIP_COSTS.normal;
        cost += (company.nextPeriodChips?.education || 0) * CHIP_COSTS.normal;
        cost += (company.nextPeriodChips?.advertising || 0) * CHIP_COSTS.normal;
    }

    // æ¸›ä¾¡å„Ÿå´è²»
    cost += calculateDepreciation(company, period);

    // æ©Ÿæ¢°æ•…éšœã«ã‚ˆã‚‹è¿½åŠ å›ºå®šè²»
    if (company.additionalFixedCost) {
        cost += company.additionalFixedCost;
    }

    // ãƒªã‚¹ã‚¯ã‚«ãƒ¼ãƒ‰è²»ç”¨ï¼ˆè¿½åŠ å›ºå®šè²»ã¨ã—ã¦è¨ˆä¸Šæ¸ˆã¿ï¼‰

    // å€‰åº«è²»ç”¨ï¼ˆç„¡ç½å®³å€‰åº«ã¯è³¼å…¥æ™‚ã®ã¿20å††ã€æœŸæœ«è²»ç”¨ãªã—ï¼‰

    // è¿½åŠ äººä»¶è²»ï¼ˆæ¡ç”¨è²»ã€é€€è·ã€ç¸æ•…æ¡ç”¨ã€å€‰åº«è³¼å…¥ãªã©ï¼‰
    cost += company.extraLaborCost || 0;

    return cost;
}

// Calculate VQ (å¤‰å‹•è²»ç·é¡)ï¼ˆå®šæ•°ã‚’ä½¿ç”¨ï¼‰
function calculateVQ(company) {
    // VQ = ææ–™è³¼å…¥é‡‘é¡ + å®ŒæˆæŠ•å…¥è²»ç”¨ + (æœŸé¦–åœ¨åº«è©•ä¾¡é¡ - æœŸæœ«åœ¨åº«è©•ä¾¡é¡)
    // â€» åœ¨åº«ãŒå¢—ãˆãŸåˆ†ã¯ã‚³ã‚¹ãƒˆã§ã¯ãªã„ã€åœ¨åº«ãŒæ¸›ã£ãŸåˆ†ãŒã‚³ã‚¹ãƒˆã«ãªã‚‹

    // â‘ ææ–™è³¼å…¥è²»ï¼ˆæœŸä¸­ã®åˆè¨ˆï¼‰
    const materialCost = company.totalMaterialCost || 0;

    // â‘¡å®Œæˆãƒ»æŠ•å…¥è²»ï¼ˆæœŸä¸­ã®åˆè¨ˆï¼‰
    const productionCost = company.totalProductionCost || 0;

    // â‘¢æœŸé¦–åœ¨åº«è©•ä¾¡é¡ï¼ˆå…ƒã®ææ–™ä¾¡å€¤ï¼‰
    const startInventoryValue = (company.periodStartInventory.materials * INVENTORY_VALUES.material) +
                               (company.periodStartInventory.wip * INVENTORY_VALUES.wip) +
                               (company.periodStartInventory.products * INVENTORY_VALUES.product);

    // â‘£æœŸæœ«åœ¨åº«è©•ä¾¡é¡ï¼ˆä»Šã®ææ–™ä¾¡å€¤ï¼‰
    const endInventoryValue = (company.materials * INVENTORY_VALUES.material) +
                             (company.wip * INVENTORY_VALUES.wip) +
                             (company.products * INVENTORY_VALUES.product);

    // VQ = â‘ +â‘¡+(â‘¢-â‘£)
    return materialCost + productionCost + startInventoryValue - endInventoryValue;
}

// Show period payment breakdown
function showPeriodPaymentBreakdown() {
    const company = gameState.companies[0];
    const period = gameState.currentPeriod;
    
    let html = '<div class="breakdown-list">';
    
    // çµ¦æ–™ã®è©³ç´°å†…è¨³
    if (company.endOfPeriodStats) {
        // æœŸæœ«æ™‚ç‚¹ã®äººæ•°ãƒ»æ©Ÿæ¢°å°æ•°ã‚’ä½¿ç”¨
        const stats = company.endOfPeriodStats;

        // åŸºæœ¬å˜ä¾¡ï¼ˆã‚µã‚¤ã‚³ãƒ­ã«ã‚ˆã‚‹å¤‰å‹•ã¯3æœŸä»¥é™ï¼‰
        const baseCost = {2: 22, 3: 24, 4: 26, 5: 28};
        let unitCost = baseCost[period] || 22;
        if (period >= 3 && gameState.wageMultiplier > 1) {
            unitCost = Math.round(baseCost[period] * gameState.wageMultiplier);
        }
        const halfCost = Math.round(unitCost / 2);

        const machineCost = stats.machines * unitCost;
        const workerCost = stats.workers * unitCost;
        const salesmanCost = stats.salesmen * unitCost;
        const personnelCost = (stats.workers + stats.salesmen) * halfCost;

        html += `<div class="breakdown-item"><span>ã€çµ¦æ–™å†…è¨³ã€‘</span><span></span></div>`;
        html += `<div class="breakdown-item"><span>ã€€æ©Ÿæ¢°è²» (${stats.machines}å°Ã—Â¥${unitCost})</span><span>Â¥${machineCost}</span></div>`;
        html += `<div class="breakdown-item"><span>ã€€ãƒ¯ãƒ¼ã‚«ãƒ¼çµ¦æ–™ (${stats.workers}äººÃ—Â¥${unitCost})</span><span>Â¥${workerCost}</span></div>`;
        html += `<div class="breakdown-item"><span>ã€€ã‚»ãƒ¼ãƒ«ã‚¹ãƒãƒ³çµ¦æ–™ (${stats.salesmen}äººÃ—Â¥${unitCost})</span><span>Â¥${salesmanCost}</span></div>`;
        html += `<div class="breakdown-item"><span>ã€€äººå“¡åˆè¨ˆè²» (${stats.workers + stats.salesmen}äººÃ—Â¥${halfCost})</span><span>Â¥${personnelCost}</span></div>`;
        html += `<div class="breakdown-item"><span>çµ¦æ–™åˆè¨ˆ</span><span>Â¥${machineCost + workerCost + salesmanCost + personnelCost}</span></div>`;
    } else {
        // é€šå¸¸ã®çµ¦æ–™è¨ˆç®—
        const salaryCost = calculateSalaryCost(company, period);
        html += `<div class="breakdown-item"><span>çµ¦æ–™</span><span>Â¥${salaryCost}</span></div>`;
    }
    
    // é•·æœŸå€Ÿå…¥è¿”æ¸ˆ
    if (company.loans > 0) {
        const loanPayment = Math.floor(company.loans * 0.1);
        html += `<div class="breakdown-item"><span>é•·æœŸå€Ÿå…¥è¿”æ¸ˆ (Â¥${company.loans}Ã—10%)</span><span>Â¥${loanPayment}</span></div>`;
    }
    
    // çŸ­æœŸå€Ÿå…¥è¿”æ¸ˆ
    if (company.shortLoans > 0) {
        const shortLoanPayment = Math.floor(company.shortLoans * 0.2);
        html += `<div class="breakdown-item"><span>çŸ­æœŸå€Ÿå…¥è¿”æ¸ˆ (Â¥${company.shortLoans}Ã—20%)</span><span>Â¥${shortLoanPayment}</span></div>`;
    }
    
    const total = calculatePeriodPayment(company, company.endOfPeriodStats ? true : false);
    html += `<div class="breakdown-item breakdown-total"><span>åˆè¨ˆ</span><span>Â¥${total}</span></div>`;
    html += '</div>';
    
    showModal('æœŸæœ«æ”¯æ‰•å†…è¨³', html);
}

// Show fixed cost breakdown
function showFixedCostBreakdown() {
    const company = gameState.companies[0];
    const period = gameState.currentPeriod;
    
    let html = '<div class="breakdown-list">';
    
    // çµ¦æ–™
    const salaryCost = calculateSalaryCost(company, period);
    html += `<div class="breakdown-item"><span>çµ¦æ–™</span><span>Â¥${salaryCost}</span></div>`;
    
    // ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ãƒ»ä¿é™º
    if (company.chips.computer > 0) {
        html += `<div class="breakdown-item"><span>ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿(${company.chips.computer}æš)</span><span>Â¥${company.chips.computer * 20}</span></div>`;
    }
    
    if (company.chips.insurance > 0) {
        html += `<div class="breakdown-item"><span>ä¿é™º(${company.chips.insurance}æš)</span><span>Â¥${company.chips.insurance * 5}</span></div>`;
    }
    
    // æˆ¦ç•¥ãƒãƒƒãƒ—
    if (period === 2) {
        if (company.chips.research > 0) html += `<div class="breakdown-item"><span>ç ”ç©¶(1æšåˆ†)</span><span>Â¥20</span></div>`;
        if (company.chips.education > 0) html += `<div class="breakdown-item"><span>æ•™è‚²(1æšåˆ†)</span><span>Â¥20</span></div>`;
        if (company.chips.advertising > 0) html += `<div class="breakdown-item"><span>åºƒå‘Š(1æšåˆ†)</span><span>Â¥20</span></div>`;
    } else {
        if (company.chips.research > 0) html += `<div class="breakdown-item"><span>ç ”ç©¶ãƒ»ç‰¹æ€¥(${company.chips.research}æš)</span><span>Â¥${company.chips.research * 40}</span></div>`;
        if (company.chips.education > 0) html += `<div class="breakdown-item"><span>æ•™è‚²ãƒ»ç‰¹æ€¥(${company.chips.education}æš)</span><span>Â¥${company.chips.education * 40}</span></div>`;
        if (company.chips.advertising > 0) html += `<div class="breakdown-item"><span>åºƒå‘Šãƒ»ç‰¹æ€¥(${company.chips.advertising}æš)</span><span>Â¥${company.chips.advertising * 40}</span></div>`;
        if (company.nextPeriodChips?.research > 0) html += `<div class="breakdown-item"><span>ç ”ç©¶ãƒ»ç¹°è¶Š(${company.nextPeriodChips.research}æš)</span><span>Â¥${company.nextPeriodChips.research * 20}</span></div>`;
        if (company.nextPeriodChips?.education > 0) html += `<div class="breakdown-item"><span>æ•™è‚²ãƒ»ç¹°è¶Š(${company.nextPeriodChips.education}æš)</span><span>Â¥${company.nextPeriodChips.education * 20}</span></div>`;
        if (company.nextPeriodChips?.advertising > 0) html += `<div class="breakdown-item"><span>åºƒå‘Šãƒ»ç¹°è¶Š(${company.nextPeriodChips.advertising}æš)</span><span>Â¥${company.nextPeriodChips.advertising * 20}</span></div>`;
    }
    
    // æ¸›ä¾¡å„Ÿå´è²»
    const depreciationCost = calculateDepreciation(company, period);
    if (depreciationCost > 0) {
        html += `<div class="breakdown-item"><span>æ¸›ä¾¡å„Ÿå´è²»</span><span>Â¥${depreciationCost}</span></div>`;
    }
    
    const total = calculateFixedCost(company);
    html += `<div class="breakdown-item breakdown-total"><span>åˆè¨ˆ</span><span>Â¥${total}</span></div>`;
    html += '</div>';
    
    showModal('å›ºå®šè²»å†…è¨³', html);
}

// Start period
function startPeriod() {
    if (gameState.periodStarted) return;
    
    let content = `
        <div class="decision-card">
            <h3>ç¬¬${gameState.currentPeriod}æœŸé–‹å§‹</h3>
            <p>æœŸé¦–å‡¦ç†ã‚’è¡Œã„ã¾ã™</p>
        </div>
    `;
    
    // 3æœŸä»¥é™ã¯å€Ÿå…¥ã¨ç„¡ç½å®³å€‰åº«ã®é¸æŠ
    if (gameState.currentPeriod >= 3) {
        const company = gameState.companies[0];
        // å€Ÿå…¥ä¸Šé™ï¼š3æœŸã¯0.5å€ã€4æœŸä»¥é™ã§è‡ªå·±è³‡æœ¬300è¶…ãªã‚‰1å€
        const loanMultiplier = (gameState.currentPeriod >= 4 && company.equity > 300) ? 1.0 : 0.5;
        const maxLoanTotal = Math.round(company.equity * loanMultiplier);
        const availableLoan = Math.max(0, maxLoanTotal - company.loans);
        const loanRuleText = (gameState.currentPeriod >= 4 && company.equity > 300)
            ? `è‡ªå·±è³‡æœ¬ã®1å€ã¾ã§ï¼ˆ300è¶…ã®ãŸã‚ï¼‰`
            : `è‡ªå·±è³‡æœ¬ã®0.5å€ã¾ã§`;

        content += `
            <div class="form-group">
                <label class="form-label">é•·æœŸå€Ÿå…¥ï¼ˆ${loanRuleText}ï¼‰</label>
                <div style="font-size: 11px; color: #666; margin-bottom: 5px;">
                    ä¸Šé™: Â¥${maxLoanTotal} - æ—¢å­˜å€Ÿå…¥Â¥${company.loans} = è¿½åŠ å¯èƒ½Â¥${availableLoan}
                </div>
                <select id="loanAmount" class="form-control">
                    <option value="0">å€Ÿã‚Šãªã„</option>
                    ${availableLoan >= 50 ? '<option value="50">Â¥50</option>' : ''}
                    ${availableLoan >= 100 ? '<option value="100">Â¥100</option>' : ''}
                    ${availableLoan >= 150 ? '<option value="150">Â¥150</option>' : ''}
                    ${availableLoan >= 200 ? '<option value="200">Â¥200</option>' : ''}
                    ${availableLoan >= 250 ? '<option value="250">Â¥250</option>' : ''}
                    ${availableLoan >= 300 ? '<option value="300">Â¥300</option>' : ''}
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">ç„¡ç½å®³å€‰åº«ï¼ˆÂ¥20/å€‹ã€å®¹é‡12ï¼‰</label>
                <select id="warehouseCount" class="form-control">
                    <option value="0">è²·ã‚ãªã„</option>
                    <option value="1">1å€‹è²·ã†</option>
                    <option value="2">2å€‹è²·ã†</option>
                </select>
            </div>
        `;
    }
    
    content += `
        <div class="form-group">
            <label class="form-label">ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ãƒãƒƒãƒ—ï¼ˆç”Ÿç”£+1ï¼‰</label>
            <div>ä¾¡æ ¼: Â¥20/å€‹ï¼ˆæœŸé¦–ã¯1å€‹é™å®šï¼‰</div>
            <select id="computerChips" class="form-control">
                <option value="0">0å€‹</option>
                <option value="1" selected>1å€‹</option>
            </select>
        </div>
        <div class="form-group">
            <label class="form-label">ä¿é™ºãƒãƒƒãƒ—ï¼ˆç½å®³å¯¾ç­–ï¼‰</label>
            <div>ä¾¡æ ¼: Â¥5/å€‹ï¼ˆæœŸé¦–ã¯1å€‹é™å®šï¼‰</div>
            <select id="insuranceChips" class="form-control">
                <option value="0">0å€‹</option>
                <option value="1" selected>1å€‹</option>
            </select>
        </div>
        <button class="submit-btn" onclick="processPeriodStart()">æœŸé¦–å‡¦ç†ã‚’å®Œäº†</button>
    `;
    
    showModal('æœŸé¦–å‡¦ç†', content);
}

// Process period start
function processPeriodStart() {
    const company = gameState.companies[0];
    let totalCost = 0;

    // ç´ç¨ãƒ»é…å½“ã®æ”¯æ‰•ã„ï¼ˆå‰æœŸæ±ºç®—åˆ†ï¼‰
    const playerTax = company.pendingTax || 0;
    const playerDividend = company.pendingDividend || 0;
    const taxDividendTotal = playerTax + playerDividend;

    if (taxDividendTotal > 0) {
        // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã«é€šçŸ¥
        alert(`ã€ç´ç¨ãƒ»é…å½“ã®æ”¯æ‰•ã„ã€‘\nç¨é‡‘: Â¥${playerTax}\né…å½“: Â¥${playerDividend}\nåˆè¨ˆ: Â¥${taxDividendTotal}`);
    }

    // å…¨ç¤¾ã®ç´ç¨ãƒ»é…å½“ã‚’å‡¦ç†
    gameState.companies.forEach(c => {
        const payment = (c.pendingTax || 0) + (c.pendingDividend || 0);
        if (payment > 0) {
            c.cash -= payment;
            console.log(`${c.name}: ç´ç¨Â¥${c.pendingTax || 0} + é…å½“Â¥${c.pendingDividend || 0} = Â¥${payment}`);

            // ç¾é‡‘ä¸è¶³ã®å ´åˆã¯çŸ­æœŸå€Ÿå…¥
            if (c.cash < 0) {
                const needed = Math.ceil(Math.abs(c.cash) / 0.8 / 50) * 50;
                c.shortLoans += needed;
                c.cash += needed * 0.8;
            }

            c.pendingTax = 0;
            c.pendingDividend = 0;
        }
    });

    // å€Ÿå…¥å‡¦ç†ï¼ˆ3æœŸä»¥é™ï¼‰
    if (gameState.currentPeriod >= 3) {
        const loanAmount = parseInt(document.getElementById('loanAmount')?.value || 0);
        if (loanAmount > 0) {
            const interest = Math.floor(loanAmount * 0.1);
            company.cash += loanAmount - interest;  // åˆ©æ¯ã‚’å¼•ã„ãŸé¡ãŒå…¥é‡‘
            company.loans += loanAmount;
            console.log(`é•·æœŸå€Ÿå…¥: Â¥${loanAmount} (åˆ©æ¯Â¥${interest}æ”¯æ‰•ã„æ¸ˆã¿)`);
        }
        
        // ç„¡ç½å®³å€‰åº«è³¼å…¥
        const warehouseCount = parseInt(document.getElementById('warehouseCount')?.value || 0);
        if (warehouseCount > 0) {
            totalCost += warehouseCount * 20;
            company.warehouses += warehouseCount;
            company.extraLaborCost = (company.extraLaborCost || 0) + (warehouseCount * 20);  // äººä»¶è²»ï¼ˆæ©Ÿæ¢°çµŒè²»ï¼‰
        }
    }
    
    // ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ãƒ»ä¿é™ºè³¼å…¥
    const computerQty = parseInt(document.getElementById('computerChips').value || 0);
    const insuranceQty = parseInt(document.getElementById('insuranceChips').value || 0);
    
    totalCost += (computerQty * 20) + (insuranceQty * 5);

    // æœŸé¦–ã§ç¾é‡‘ä¸è¶³ã®å ´åˆã€Â¥100ã®é•·æœŸå€Ÿå…¥ãŒå¯èƒ½
    if (company.cash < totalCost) {
        const shortage = totalCost - company.cash;
        const loansNeeded = Math.ceil(shortage / 100) * 100;

        if (confirm(`ç¾é‡‘ãŒÂ¥${shortage}ä¸è¶³ã—ã¦ã„ã¾ã™ã€‚\né•·æœŸå€Ÿå…¥Â¥${loansNeeded}ã‚’è¡Œã„ã¾ã™ã‹ï¼Ÿ\nï¼ˆåˆ©æ¯10%ã‚’å·®ã—å¼•ã„ãŸÂ¥${loansNeeded * 0.9}ãŒå…¥é‡‘ã•ã‚Œã¾ã™ï¼‰`)) {
            const netAmount = loansNeeded * 0.9;
            company.loans += loansNeeded;
            company.cash += netAmount;
        } else {
            alert('æœŸé¦–å‡¦ç†ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸ');
            return;
        }
    }

    company.cash -= totalCost;
    company.chips.computer = Math.min(3, company.chips.computer + computerQty);
    company.chips.insurance = Math.min(3, company.chips.insurance + insuranceQty);
    
    // AI companies also process period start
    for (let i = 1; i < gameState.companies.length; i++) {
        const aiCompany = gameState.companies[i];
        // Simple AI logic
        if (aiCompany.cash >= 25) {
            aiCompany.cash -= 25;
            aiCompany.chips.computer = 1;
            aiCompany.chips.insurance = 1;
        }
    }
    
    gameState.periodStarted = true;
    closeModal();
    updateDisplay();
    
    // Show turn start options
    showTurnStartOptions();
}

// Show turn start options
function showTurnStartOptions() {
    if (gameState.currentPlayerIndex !== 0) return;

    const company = gameState.companies[0];
    const content = `
        <div class="card-choice-container">
            <h2>ã‚ãªãŸã®ã‚¿ãƒ¼ãƒ³</h2>
            <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                <button class="action-btn main card-choice-btn" onclick="drawCard()" style="flex: 2;">ã‚«ãƒ¼ãƒ‰ã‚’å¼•ã</button>
                <button class="action-btn secondary" onclick="viewGameState()" style="flex: 1; font-size: 12px;">å…¨ä½“ã‚’è¦‹ã‚‹</button>
            </div>
            <div style="margin-top: 20px;">
                <p>ãã®ä»–ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆBãƒ«ãƒ¼ãƒ«ï¼‰</p>
                <button class="action-btn secondary" onclick="showInsurancePurchaseModal()">ä¿é™ºãƒãƒƒãƒ—è³¼å…¥</button>
                <button class="action-btn secondary" onclick="showWarehouseModal()">ç„¡ç½å®³å€‰åº«ã‚’è³¼å…¥</button>
                ${company.warehouses === 1 ? '<button class="action-btn secondary" onclick="showWarehouseMoveModal()">å€‰åº«ã®ç§»å‹•</button>' : ''}
                <button class="action-btn secondary" onclick="showReassignModal()">é…ç½®è»¢æ›</button>
                <button class="action-btn secondary" onclick="showSellMachineModal()">æ©Ÿæ¢°å£²å´</button>
            </div>
        </div>
    `;
    
    showModal('è¡Œå‹•é¸æŠ', content);
}

// View game state - å…¨ä½“ã‚’è¦‹ã‚‹æ©Ÿèƒ½
function viewGameState() {
    closeModal();

    // è¡¨ç¤ºé †ï¼ˆè²©å£²ä¸Šé™ä¾¡æ ¼ã®é«˜ã„é †ï¼‰
    const displayOrder = ['ä»™å°', 'æœ­å¹Œ', 'ç¦å²¡', 'åå¤å±‹', 'å¤§é˜ª', 'æ±äº¬', 'æµ·å¤–'];

    // å¸‚å ´æƒ…å ±ã‚’ç”Ÿæˆ
    let marketsHtml = '<div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-bottom: 15px;">';
    displayOrder.forEach(marketName => {
        const market = gameState.markets.find(m => m.name === marketName);
        if (!market) return;
        const closedStyle = market.closed ? 'opacity: 0.5; text-decoration: line-through;' : '';
        const volumeText = market.name === 'æµ·å¤–' ? 'âˆ' : market.maxStock;
        marketsHtml += `
            <div style="background: linear-gradient(135deg, #1e3a5f 0%, #0f172a 100%); padding: 8px; border-radius: 8px; text-align: center; ${closedStyle}">
                <div style="font-weight: bold; color: #fbbf24; font-size: 12px;">${market.name}</div>
                <div style="color: #93c5fd; font-size: 10px;">å£²Â¥${market.sellPrice} / è²·Â¥${market.buyPrice}</div>
                <div style="color: #4ade80; font-size: 11px; margin-top: 3px;">åœ¨åº«: ${market.currentStock}/${volumeText}</div>
                ${market.closed ? '<div style="color: #ef4444; font-size: 10px;">é–‰é–ä¸­</div>' : ''}
            </div>
        `;
    });
    marketsHtml += '</div>';

    // å…¨ä¼šç¤¾ã®æƒ…å ±ã‚’ç”Ÿæˆ
    let companiesHtml = '';
    gameState.companies.forEach((company, idx) => {
        const isPlayer = idx === 0;
        const periodPayment = calculatePeriodPayment(company);
        const fixedCost = calculateFixedCost(company);
        const mfgCapacity = getManufacturingCapacity(company);
        const salesCapacity = getSalesCapacity(company);
        const priceComp = getPriceCompetitiveness(company, idx);

        // ãƒãƒƒãƒ—æƒ…å ±
        const chips = company.chips || {};
        const chipInfo = [];
        if (chips.research) chipInfo.push(`ç ”${chips.research}`);
        if (chips.education) chipInfo.push(`æ•™${chips.education}`);
        if (chips.advertising) chipInfo.push(`åºƒ${chips.advertising}`);
        if (chips.computer) chipInfo.push(`PC${chips.computer}`);
        if (chips.insurance) chipInfo.push(`ä¿${chips.insurance}`);

        // æ©Ÿæ¢°æƒ…å ±
        const smallMachines = company.machines.filter(m => m.type === 'small').length;
        const largeMachines = company.machines.filter(m => m.type === 'large').length;

        const bgColor = isPlayer ? 'linear-gradient(135deg, #166534 0%, #14532d 100%)' : 'linear-gradient(135deg, #1e40af 0%, #1e3a8a 100%)';
        const borderColor = isPlayer ? '#22c55e' : '#3b82f6';

        companiesHtml += `
            <div style="background: ${bgColor}; border: 2px solid ${borderColor}; border-radius: 12px; padding: 12px; margin-bottom: 10px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                    <div style="font-weight: bold; color: #fbbf24; font-size: 14px;">${isPlayer ? 'â˜… ' : ''}${company.name}</div>
                    <div style="display: flex; gap: 8px;">
                        <span style="color: #4ade80; font-weight: bold;">Â¥${company.cash}</span>
                        <span style="background: ${(company.currentRow || 1) >= gameState.maxRows - 5 ? '#ef4444' : '#3b82f6'}; color: white; padding: 2px 6px; border-radius: 4px; font-size: 11px;">
                            ${company.currentRow || 1}/${gameState.maxRows}è¡Œ
                        </span>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px; margin-bottom: 8px;">
                    <div style="background: rgba(139, 92, 246, 0.3); padding: 6px; border-radius: 6px; text-align: center;">
                        <div style="color: #c4b5fd; font-size: 10px;">ææ–™</div>
                        <div style="color: white; font-weight: bold;">${company.materials}å€‹</div>
                    </div>
                    <div style="background: rgba(168, 85, 247, 0.3); padding: 6px; border-radius: 6px; text-align: center;">
                        <div style="color: #d8b4fe; font-size: 10px;">ä»•æ›å“</div>
                        <div style="color: white; font-weight: bold;">${company.wip}å€‹</div>
                    </div>
                    <div style="background: rgba(99, 102, 241, 0.3); padding: 6px; border-radius: 6px; text-align: center;">
                        <div style="color: #a5b4fc; font-size: 10px;">è£½å“</div>
                        <div style="color: white; font-weight: bold;">${company.products}å€‹</div>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px; margin-bottom: 8px;">
                    <div style="background: rgba(251, 191, 36, 0.2); padding: 4px; border-radius: 4px; text-align: center;">
                        <span style="color: #fbbf24; font-size: 10px;">W:${company.workers}</span>
                    </div>
                    <div style="background: rgba(148, 163, 184, 0.2); padding: 4px; border-radius: 4px; text-align: center;">
                        <span style="color: #94a3b8; font-size: 10px;">æ©Ÿ:${smallMachines}å°${largeMachines}å¤§</span>
                    </div>
                    <div style="background: rgba(59, 130, 246, 0.2); padding: 4px; border-radius: 4px; text-align: center;">
                        <span style="color: #60a5fa; font-size: 10px;">S:${company.salesmen}</span>
                    </div>
                </div>

                <div style="display: flex; justify-content: space-between; font-size: 10px; color: #93c5fd;">
                    <span>è£½é€ :${mfgCapacity} è²©å£²:${salesCapacity} ä¾¡æ ¼:+${priceComp}</span>
                    <span>F:Â¥${fixedCost}</span>
                </div>

                ${chipInfo.length > 0 ? `<div style="font-size: 10px; color: #a78bfa; margin-top: 4px;">ãƒãƒƒãƒ—: ${chipInfo.join(' ')}</div>` : ''}
            </div>
        `;
    });

    const content = `
        <div style="max-height: 70vh; overflow-y: auto; padding: 10px;">
            <div style="background: #1e293b; padding: 10px; border-radius: 8px; margin-bottom: 15px;">
                <div style="text-align: center; color: #fbbf24; font-weight: bold; margin-bottom: 10px;">
                    ğŸ“Š ${gameState.currentPeriod}æœŸ ${gameState.currentRow}/${gameState.maxRows}è¡Œç›®
                </div>
                <h4 style="color: #60a5fa; margin-bottom: 8px; font-size: 13px;">ğŸª å¸‚å ´ç›¤</h4>
                ${marketsHtml}
            </div>

            <h4 style="color: #60a5fa; margin-bottom: 10px; font-size: 13px;">ğŸ¢ å…¨ä¼šç¤¾ç›¤</h4>
            ${companiesHtml}
        </div>

        <button onclick="closeModal(); showTurnStartOptions();"
                style="width: 100%; padding: 12px; background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
                       color: white; border: none; border-radius: 8px; font-weight: bold; font-size: 14px; cursor: pointer;">
            è¡Œå‹•é¸æŠã«æˆ»ã‚‹
        </button>
    `;

    showModal('å…¨ä½“ã‚’è¦‹ã‚‹', content);
}

// Draw card (80% decision, 20% risk)
// ã‚«ãƒ¼ãƒ‰ãƒ‡ãƒƒã‚­ã‚’åˆæœŸåŒ–ï¼ˆ75æšï¼š60æšæ„æ€æ±ºå®š + 15æšãƒªã‚¹ã‚¯ï¼‰
function initializeCardDeck() {
    gameState.cardDeck = [];

    // 60æšã®æ„æ€æ±ºå®šã‚«ãƒ¼ãƒ‰ï¼ˆ'decision'ï¼‰
    for (let i = 0; i < 60; i++) {
        gameState.cardDeck.push('decision');
    }

    // 15æšã®ãƒªã‚¹ã‚¯ã‚«ãƒ¼ãƒ‰ï¼ˆ'risk'ï¼‰
    for (let i = 0; i < 15; i++) {
        gameState.cardDeck.push('risk');
    }

    // ã‚·ãƒ£ãƒƒãƒ•ãƒ«ï¼ˆFisher-Yatesï¼‰
    for (let i = gameState.cardDeck.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [gameState.cardDeck[i], gameState.cardDeck[j]] = [gameState.cardDeck[j], gameState.cardDeck[i]];
    }

    gameState.deckInitialized = true;
    console.log('ã‚«ãƒ¼ãƒ‰ãƒ‡ãƒƒã‚­ã‚’åˆæœŸåŒ–ã—ã¾ã—ãŸï¼ˆ75æšï¼‰');
}

// Draw card from deck
function drawCard() {
    closeModal();

    // ãƒ‡ãƒƒã‚­ãŒãªã„ã€ã¾ãŸã¯ç©ºã®å ´åˆã¯åˆæœŸåŒ–
    if (!gameState.deckInitialized || gameState.cardDeck.length === 0) {
        initializeCardDeck();
    }

    // ãƒ‡ãƒƒã‚­ã‹ã‚‰ã‚«ãƒ¼ãƒ‰ã‚’å¼•ã
    const cardType = gameState.cardDeck.pop();
    console.log(`ã‚«ãƒ¼ãƒ‰ã‚’å¼•ãã¾ã—ãŸ: ${cardType}ï¼ˆæ®‹ã‚Š${gameState.cardDeck.length}æšï¼‰`);

    if (cardType === 'decision') {
        showDecisionCard();
    } else {
        drawRiskCard();
    }
}

// Show decision card (ä¼šç¤¾ç›¤ãŒè¦‹ãˆã‚‹çŠ¶æ…‹ã§è¡¨ç¤º)
function showDecisionCard() {
    const company = gameState.companies[0];
    const mfgCapacity = getManufacturingCapacity(company);
    const salesCapacity = getSalesCapacity(company);
    const priceComp = getPriceCompetitiveness(company, 0);

    // å„ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã®è¨­å®š
    const actionConfig = {
        1: { icon: 'ğŸ’°', label: 'å•†å“è²©å£²', color: '#22c55e', border: '#16a34a', desc: 'è£½å“ã‚’è²©å£²' },
        2: { icon: 'ğŸ“¦', label: 'ææ–™ä»•å…¥', color: '#8b5cf6', border: '#7c3aed', desc: 'ææ–™ã‚’è³¼å…¥' },
        3: { icon: 'ğŸ­', label: 'å®Œæˆãƒ»æŠ•å…¥', color: '#3b82f6', border: '#2563eb', desc: 'è£½é€ ã‚’å®Ÿè¡Œ' },
        4: { icon: 'ğŸ‘¥', label: 'æ¡ç”¨', color: '#f59e0b', border: '#d97706', desc: 'äººå“¡ã‚’æ¡ç”¨' },
        5: { icon: 'âš™ï¸', label: 'è¨­å‚™æŠ•è³‡', color: '#6366f1', border: '#4f46e5', desc: 'æ©Ÿæ¢°ã‚’è³¼å…¥' },
        6: { icon: 'ğŸ¯', label: 'æˆ¦ç•¥ãƒãƒƒãƒ—', color: '#ef4444', border: '#dc2626', desc: 'ãƒãƒƒãƒ—è³¼å…¥' },
        7: { icon: 'â­ï¸', label: 'DO NOTHING', color: '#64748b', border: '#475569', desc: 'ãƒ‘ã‚¹' }
    };

    const cardHtml = gameState.decisionCards.map(card => {
        const cfg = actionConfig[card.id];
        return `
            <div onclick="selectDecisionCard(${card.id})" style="
                background: linear-gradient(135deg, ${cfg.color} 0%, ${cfg.border} 100%);
                border: 3px solid ${cfg.border};
                border-radius: 10px;
                padding: 12px 8px;
                text-align: center;
                cursor: pointer;
                color: white;
                transition: transform 0.2s, box-shadow 0.2s;
                box-shadow: 0 3px 10px rgba(0,0,0,0.2);
            " onmouseover="this.style.transform='scale(1.05)'"
               onmouseout="this.style.transform='scale(1)'">
                <div style="font-size: 24px; margin-bottom: 4px;">${cfg.icon}</div>
                <div style="font-weight: bold; font-size: 12px;">${cfg.label}</div>
                <div style="font-size: 9px; opacity: 0.9;">${cfg.desc}</div>
            </div>
        `;
    }).join('');

    const content = `
        <div style="background: #fef3c7; border-radius: 8px; padding: 8px; margin-bottom: 12px; text-align: center;">
            <div style="font-weight: bold; color: #92400e; font-size: 14px;">ğŸ’° æŒã¡é‡‘: Â¥${company.cash}</div>
        </div>
        <div style="display: flex; justify-content: space-around; margin-bottom: 12px; padding: 8px; background: #f1f5f9; border-radius: 8px;">
            <div style="text-align: center;">
                <div style="font-size: 10px; color: #64748b;">è£½é€ </div>
                <div style="font-size: 16px; font-weight: bold; color: #0284c7;">${mfgCapacity}</div>
            </div>
            <div style="text-align: center;">
                <div style="font-size: 10px; color: #64748b;">è²©å£²</div>
                <div style="font-size: 16px; font-weight: bold; color: #dc2626;">${salesCapacity}</div>
            </div>
            <div style="text-align: center;">
                <div style="font-size: 10px; color: #64748b;">ä¾¡æ ¼ç«¶äº‰åŠ›</div>
                <div style="font-size: 16px; font-weight: bold; color: #16a34a;">+${priceComp}</div>
            </div>
        </div>
        <div style="display: flex; justify-content: center; gap: 6px; margin-bottom: 12px; font-size: 11px;">
            <div style="background: #e0e7ff; padding: 4px 10px; border-radius: 6px;">
                <span style="color: #4338ca;">ææ–™</span> <b>${company.materials}</b>
            </div>
            <div style="background: #fae8ff; padding: 4px 10px; border-radius: 6px;">
                <span style="color: #a21caf;">ä»•æ›å“</span> <b>${company.wip}</b>
            </div>
            <div style="background: #dbeafe; padding: 4px 10px; border-radius: 6px;">
                <span style="color: #1d4ed8;">è£½å“</span> <b>${company.products}</b>
            </div>
        </div>
        <p style="text-align: center; font-size: 12px; color: #666; margin-bottom: 10px;">ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’é¸æŠã—ã¦ãã ã•ã„</p>
        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px;">
            ${cardHtml}
        </div>
    `;

    showModal('æ„æ€æ±ºå®šã‚«ãƒ¼ãƒ‰', content);
}

// Select decision card
function selectDecisionCard(cardId) {
    const card = gameState.decisionCards.find(c => c.id === cardId);
    gameState.companies[0].decisionCard = card;
    
    closeModal();
    
    // Execute decision card action
    switch(cardId) {
        case 1: showSalesModal(); break;
        case 2: showBuyMaterialsModal(); break;
        case 3: showProductionModal(); break;
        case 4: showHireModal(); break;
        case 5: showMachineModal(); break;
        case 6: showChipPurchaseModal(); break;  // ãƒãƒƒãƒ—è³¼å…¥
        case 7: doNothing(); break;
    }
}

// Draw risk card
function drawRiskCard() {
    const availableCards = gameState.riskCards.filter(card => {
        if (gameState.currentPeriod === 2 && card.period2Exempt) return false;
        return !gameState.usedRiskCards.includes(card.id);
    });
    
    if (availableCards.length === 0) {
        showDecisionCard();
        return;
    }
    
    const card = availableCards[Math.floor(Math.random() * availableCards.length)];
    gameState.usedRiskCards.push(card.id);

    // ã‚«ãƒ¼ãƒ‰ã‚¿ã‚¤ãƒ—ã«å¿œã˜ãŸè‰²ã¨ã‚¢ã‚¤ã‚³ãƒ³
    const isPositive = card.type === 'benefit';
    const cardIcon = isPositive ? 'ğŸ‰' : 'âš ï¸';

    const content = `
        <div class="risk-display" style="${isPositive ? 'background: linear-gradient(135deg, #059669 0%, #047857 100%); border-color: #34d399;' : ''}">
            <div class="risk-badge">${cardIcon} ãƒªã‚¹ã‚¯ã‚«ãƒ¼ãƒ‰</div>
            <div class="risk-title">${card.name}</div>
            <div class="risk-description">${card.description}</div>
        </div>
        <button class="submit-btn" onclick="applyRiskCard(${card.id})" style="margin-top: 15px;">
            ${isPositive ? 'âœ“ åŠ¹æœã‚’é©ç”¨' : 'âš¡ é©ç”¨ã™ã‚‹'}
        </button>
    `;

    showModal('ãƒªã‚¹ã‚¯ã‚«ãƒ¼ãƒ‰', content);
}

// Apply risk card
function applyRiskCard(cardId) {
    const company = gameState.companies[0];
    const card = gameState.riskCards.find(c => c.id === cardId);
    let rowUsed = true;

    switch(cardId) {
        case 1: // ã‚¯ãƒ¬ãƒ¼ãƒ ç™ºç”Ÿ
        case 2:
            company.cash = Math.max(0, company.cash - 5);
            if (!company.additionalFixedCost) company.additionalFixedCost = 0;
            company.additionalFixedCost += 5;  // Fã«è¨ˆä¸Š
            showToast('ã‚¯ãƒ¬ãƒ¼ãƒ ç™ºç”Ÿï¼\næœ¬ç¤¾çµŒè²»â–²5ï¼ˆFè¨ˆä¸Šï¼‰', 'warning', 4000);
            break;
        case 3: // æ•™è‚²æˆåŠŸï¼ˆä»•å…¥ã‚Œå¯ï¼‰
        case 4:
            if (company.chips.education > 0) {
                // è²©å£²èƒ½åŠ›ã®ç¯„å›²å†…ã€æœ€é«˜5å€‹ã¾ã§ã€ä»•å…¥ã‚Œå¯
                const result = executeSpecialSaleWithPurchase('education', 'education', 2, true);
                if (result.async) {
                    return; // éåŒæœŸå‡¦ç†ä¸­
                }
                if (!result.success) {
                    alert(`æ•™è‚²æˆåŠŸï¼\nï¼ˆ${result.reason}ã®ãŸã‚åŠ¹æœãªã—ï¼‰`);
                    rowUsed = false;
                }
            } else {
                alert('æ•™è‚²ãƒãƒƒãƒ—ã‚’æŒã£ã¦ã„ãªã„ãŸã‚åŠ¹æœãªã—');
                rowUsed = false;
            }
            break;
        case 5: // æ¶ˆè²»è€…é‹å‹•ç™ºç”Ÿ
        case 6:
            company.cannotSell = true;
            showToast('æ¶ˆè²»è€…é‹å‹•ç™ºç”Ÿï¼\nå•†å“ã®è²©å£²ã¯ã§ãã¾ã›ã‚“\nï¼ˆææ–™è³¼å…¥ã€å®Œæˆãƒ»æŠ•å…¥ã€DO NOTHINGã¯å¯èƒ½ï¼‰', 'danger', 5000);
            showForcedActionModal();  // ã‚¢ã‚¯ã‚·ãƒ§ãƒ³é¸æŠãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
            return;  // ã“ã“ã§ãƒªã‚¿ãƒ¼ãƒ³ï¼ˆãƒ¢ãƒ¼ãƒ€ãƒ«ã§è¡Œå‹•ã‚’é¸æŠå¾Œã«ã‚¿ãƒ¼ãƒ³çµ‚äº†ï¼‰
        case 7: // å¾—æ„å…ˆå€’ç”£
        case 8:
            if (gameState.currentPeriod !== 2) {
                company.cash = Math.max(0, company.cash - 30);
                company.specialLoss = (company.specialLoss || 0) + 30;
                alert('å¾—æ„å…ˆå€’ç”£ï¼\nç¾é‡‘â–²30ï¼ˆç‰¹åˆ¥æå¤±ï¼‰');
            } else {
                alert('å¾—æ„å…ˆå€’ç”£ï¼\n2æœŸç›®ã¯å…é™¤');
                rowUsed = false;
            }
            break;
        case 9: // ç ”ç©¶é–‹ç™ºå¤±æ•—
        case 10:
        case 11:
            if (company.chips.research > 0) {
                company.chips.research--;
                alert('ç ”ç©¶é–‹ç™ºå¤±æ•—ï¼\né’ãƒãƒƒãƒ—1æšè¿”å´');
            } else if (company.nextPeriodChips.research > 0) {
                company.nextPeriodChips.research--;
                alert('ç ”ç©¶é–‹ç™ºå¤±æ•—ï¼\næ¬¡ç¹°ç›¤ã®é’ãƒãƒƒãƒ—1æšè¿”å´');
            } else {
                alert('ç ”ç©¶é–‹ç™ºå¤±æ•—ï¼\nï¼ˆé’ãƒãƒƒãƒ—ãŒãªã„ãŸã‚åŠ¹æœãªã—ï¼‰');
                rowUsed = false;
            }
            break;
        case 12: // åºƒå‘ŠæˆåŠŸï¼ˆä»•å…¥ã‚Œå¯ï¼‰
        case 13:
        case 14:
            if (company.chips.advertising > 0) {
                // èµ¤ãƒãƒƒãƒ—1æšã«ã¤ã2å€‹ã¾ã§ã€æœ€é«˜5å€‹ã¾ã§ã€ä»•å…¥ã‚Œå¯
                const result = executeSpecialSaleWithPurchase('advertising', 'advertising', 2, false);
                if (result.async) {
                    return; // éåŒæœŸå‡¦ç†ä¸­
                }
                if (!result.success) {
                    alert(`åºƒå‘ŠæˆåŠŸï¼\nï¼ˆ${result.reason}ã®ãŸã‚åŠ¹æœãªã—ï¼‰`);
                    rowUsed = false;
                }
            } else {
                alert('åºƒå‘ŠæˆåŠŸï¼\nï¼ˆèµ¤ãƒãƒƒãƒ—ãŒãªã„ãŸã‚åŠ¹æœãªã—ï¼‰');
                rowUsed = false;
            }
            break;
        case 15: // åŠ´ç½ç™ºç”Ÿ
        case 16:
            company.cannotProduce = true;
            showToast('åŠ´ç½ç™ºç”Ÿï¼\nç”Ÿç”£æ´»å‹•ã¯ã§ãã¾ã›ã‚“\nï¼ˆææ–™è³¼å…¥ã€å•†å“è²©å£²ãƒ»å…¥æœ­ã€DO NOTHINGã¯å¯èƒ½ï¼‰', 'danger', 5000);
            showLaborAccidentActionModal();  // è¡Œå‹•é¸æŠãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
            return;  // ã“ã“ã§ãƒªã‚¿ãƒ¼ãƒ³ï¼ˆãƒ¢ãƒ¼ãƒ€ãƒ«ã§è¡Œå‹•ã‚’é¸æŠå¾Œã«ã‚¿ãƒ¼ãƒ³çµ‚äº†ï¼‰
        case 17: // åºƒå‘Šæ”¿ç­–å¤±æ•—
        case 18:
            if (company.chips.advertising > 0) {
                company.chips.advertising--;
                alert('åºƒå‘Šæ”¿ç­–å¤±æ•—ï¼\nèµ¤ãƒãƒƒãƒ—1æšè¿”å´');
            } else if (company.nextPeriodChips.advertising > 0) {
                company.nextPeriodChips.advertising--;
                alert('åºƒå‘Šæ”¿ç­–å¤±æ•—ï¼\næ¬¡ç¹°ç›¤ã®èµ¤ãƒãƒƒãƒ—1æšè¿”å´');
            } else {
                alert('åºƒå‘Šæ”¿ç­–å¤±æ•—ï¼\nï¼ˆèµ¤ãƒãƒƒãƒ—ãŒãªã„ãŸã‚åŠ¹æœãªã—ï¼‰');
                rowUsed = false;
            }
            break;
        case 19: // ç‰¹åˆ¥ã‚µãƒ¼ãƒ“ã‚¹
        case 20:
            showSpecialServiceModal();  // é¸æŠãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
            return;  // ã“ã“ã§ãƒªã‚¿ãƒ¼ãƒ³ï¼ˆãƒ¢ãƒ¼ãƒ€ãƒ«ã§é¸æŠå¾Œã«ã‚¿ãƒ¼ãƒ³çµ‚äº†ï¼‰
        case 21: // è¿”å“ç™ºç”Ÿ
        case 22:
        case 23:
            if (gameState.currentPeriod !== 2) {
                company.products = Math.min(company.products + 1, 999);
                company.totalSales -= 20;
                alert('è¿”å“ç™ºç”Ÿï¼\nå•†å“1å€‹ãŒæˆ»ã‚Šã€å£²ä¸Šâ–²20å††');
            } else {
                alert('è¿”å“ç™ºç”Ÿï¼\n2æœŸç›®ã¯å…é™¤');
                rowUsed = false;
            }
            break;
        case 24: // ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ãƒ¼ãƒˆãƒ©ãƒ–ãƒ«
        case 25:
            company.cash = Math.max(0, company.cash - 10);
            if (!company.additionalFixedCost) company.additionalFixedCost = 0;
            company.additionalFixedCost += 10;  // Fã«è¨ˆä¸Š
            showToast('ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ãƒ¼ãƒˆãƒ©ãƒ–ãƒ«ï¼\nè£½é€ çµŒè²»â–²10ï¼ˆFè¨ˆä¸Šï¼‰', 'warning', 4000);
            break;
        case 26: // å•†å“ã®ç‹¬å è²©å£²ï¼ˆä»•å…¥ã‚Œå¯ï¼‰
        case 27:
        case 28:
            if (company.salesmen > 0) {
                // ã‚»ãƒ¼ãƒ«ã‚¹ãƒãƒ³1äººã«ã¤ã2å€‹ã¾ã§ã€æœ€é«˜5å€‹ã¾ã§ã€ä»•å…¥ã‚Œå¯
                const result = executeSpecialSaleWithPurchase('exclusive', 'salesmen', 2, false);
                if (result.async) {
                    return; // éåŒæœŸå‡¦ç†ä¸­
                }
                if (!result.success) {
                    alert(`å•†å“ã®ç‹¬å è²©å£²ï¼\nï¼ˆ${result.reason}ã®ãŸã‚åŠ¹æœãªã—ï¼‰`);
                    rowUsed = false;
                }
            } else {
                alert('å•†å“ã®ç‹¬å è²©å£²ï¼\nï¼ˆã‚»ãƒ¼ãƒ«ã‚¹ãƒãƒ³ãŒã„ãªã„ãŸã‚åŠ¹æœãªã—ï¼‰');
                rowUsed = false;
            }
            break;
        case 29: // è£½é€ ãƒŸã‚¹ç™ºç”Ÿ
        case 30:
            if (company.wip > 0) {
                company.wip--;
                company.specialLoss = (company.specialLoss || 0) + 14;  // ä»•æ›å“1å€‹=14å††
                alert('è£½é€ ãƒŸã‚¹ç™ºç”Ÿï¼\nä»•æ›å“1å€‹ã‚’ã‚¹ãƒˆãƒƒã‚«ãƒ¼ã¸ï¼ˆç‰¹åˆ¥æå¤±Â¥14ï¼‰');
            } else {
                alert('è£½é€ ãƒŸã‚¹ç™ºç”Ÿï¼\nï¼ˆä»•æ›å“ãŒãªã„ãŸã‚åŠ¹æœãªã—ï¼‰');
                rowUsed = false;
            }
            break;
        case 31: // å€‰åº«ç«ç½
        case 32:
            if (isMaterialProtectedFromFire(company)) {
                alert('å€‰åº«ç«ç½ï¼\nç„¡ç½å®³å€‰åº«ã«ã‚ˆã‚Šå›é¿ã—ã¾ã—ãŸ');
            } else if (company.chips.insurance > 0) {
                const lostMaterials = company.materials;
                const materialValue = lostMaterials * 13;  // ææ–™1å€‹=13å††
                const compensation = lostMaterials * 8;
                const netLoss = materialValue - compensation;
                company.cash += compensation;
                company.materials = 0;
                company.chips.insurance = 0;  // ä¿é™ºä½¿ç”¨å¾Œæ¶ˆå¤±
                company.specialLoss = (company.specialLoss || 0) + netLoss;
                if (company.type === 'player') {
                    showInsuranceRepurchaseModal('å€‰åº«ç«ç½', lostMaterials, compensation, netLoss);
                } else {
                    // AIä¼šç¤¾ã¯è‡ªå‹•ã§å†åŠ å…¥
                    if (company.cash >= 5) {
                        company.cash -= 5;
                        company.chips.insurance = 1;
                    }
                }
            } else {
                const lostMaterials = company.materials;
                const materialValue = lostMaterials * 13;
                company.materials = 0;
                company.specialLoss = (company.specialLoss || 0) + materialValue;
                alert(`å€‰åº«ç«ç½ï¼\nææ–™${lostMaterials}å€‹ã‚’ã‚¹ãƒˆãƒƒã‚«ãƒ¼ã¸ï¼ˆç‰¹åˆ¥æå¤±Â¥${materialValue}ï¼‰`);
            }
            break;
        case 33: // ç¸æ•…æ¡ç”¨
        case 34:
            company.cash = Math.max(0, company.cash - 5);
            company.extraLaborCost = (company.extraLaborCost || 0) + 5;  // äººä»¶è²»
            showHiringChoiceModal();
            rowUsed = false;
            break;
        case 35: // ç ”ç©¶é–‹ç™ºæˆåŠŸ
        case 36:
        case 37:
        case 38:
        case 39:
        case 40:
            if (company.chips.research > 0 && company.products > 0) {
                const salesCapacity = getSalesCapacity(company);
                const sellQty = Math.min(company.chips.research * 2, company.products, salesCapacity, 5);
                const revenue = sellQty * 32;
                company.cash += revenue;
                company.products -= sellQty;
                company.totalSales += revenue;
                alert(`ç ”ç©¶é–‹ç™ºæˆåŠŸï¼\né’ãƒãƒƒãƒ—${company.chips.research}æšã§${sellQty}å€‹ã‚’Â¥32ã§è²©å£²\nå…¥é‡‘é¡: Â¥${revenue}ï¼ˆä»•å…¥ã‚Œä¸å¯ï¼‰`);
            } else {
                alert('ç ”ç©¶é–‹ç™ºæˆåŠŸï¼\nï¼ˆé’ãƒãƒƒãƒ—ã¾ãŸã¯è£½å“ãŒãªã„ãŸã‚åŠ¹æœãªã—ï¼‰');
                rowUsed = false;
            }
            break;
        case 41: // å„ç¤¾å…±é€š
        case 42:
            executeAllCompaniesCommonPurchase();
            rowUsed = false;
            break;
        case 43: // ã‚¹ãƒˆãƒ©ã‚¤ã‚­ç™ºç”Ÿ
        case 44:
            company.skipTurns = 1;
            showToast('ã‚¹ãƒˆãƒ©ã‚¤ã‚­ç™ºç”Ÿï¼\n1å›ä¼‘ã¿', 'danger', 4000);
            rowUsed = false;
            break;
        case 45: // ç›—é›£ç™ºè¦‹
        case 46:
            if (isProductProtectedFromTheft(company)) {
                alert('ç›—é›£ç™ºè¦‹ï¼\nç„¡ç½å®³å€‰åº«ã«ã‚ˆã‚Šå›é¿ã—ã¾ã—ãŸ');
            } else if (company.chips.insurance > 0) {
                const stolen = Math.min(2, company.products);
                const productValue = stolen * 15;  // è£½å“1å€‹=15å††
                const compensation = stolen * 10;
                const netLoss = productValue - compensation;
                company.cash += compensation;
                company.products -= stolen;
                company.chips.insurance = 0;  // ä¿é™ºä½¿ç”¨å¾Œæ¶ˆå¤±
                const overseasMarket = gameState.markets.find(m => m.name === 'æµ·å¤–');
                if (overseasMarket) overseasMarket.currentStock += stolen;
                company.specialLoss = (company.specialLoss || 0) + netLoss;
                if (company.type === 'player') {
                    showInsuranceRepurchaseModal('ç›—é›£ç™ºè¦‹', stolen, compensation, netLoss);
                } else {
                    // AIä¼šç¤¾ã¯è‡ªå‹•ã§å†åŠ å…¥
                    if (company.cash >= 5) {
                        company.cash -= 5;
                        company.chips.insurance = 1;
                    }
                }
            } else {
                const stolen = Math.min(2, company.products);
                const productValue = stolen * 15;
                company.products -= stolen;
                const overseasMarket = gameState.markets.find(m => m.name === 'æµ·å¤–');
                if (overseasMarket) overseasMarket.currentStock += stolen;
                company.specialLoss = (company.specialLoss || 0) + productValue;
                alert(`ç›—é›£ç™ºè¦‹ï¼\nå•†å“${stolen}å€‹ã‚’ã‚¹ãƒˆãƒƒã‚«ãƒ¼ã¸ï¼ˆä¿é™ºæœªåŠ å…¥ï¼‰`);
            }
            break;
        case 47: // é•·æœŸåŠ´å‹™ç´›äº‰
        case 48:
            company.skipTurns = 2;
            showToast('é•·æœŸåŠ´å‹™ç´›äº‰ï¼\n2å›ä¼‘ã¿', 'danger', 4000);
            rowUsed = false;
            break;
        case 49: // è¨­è¨ˆãƒˆãƒ©ãƒ–ãƒ«ç™ºç”Ÿ
        case 50:
            company.cash = Math.max(0, company.cash - 10);
            if (!company.additionalFixedCost) company.additionalFixedCost = 0;
            company.additionalFixedCost += 10;  // Fã«è¨ˆä¸Š
            showToast('è¨­è¨ˆãƒˆãƒ©ãƒ–ãƒ«ç™ºç”Ÿï¼\nè£½é€ çµŒè²»â–²10ï¼ˆFè¨ˆä¸Šï¼‰', 'warning', 4000);
            break;
        case 51: // ãƒ¯ãƒ¼ã‚«ãƒ¼é€€è·
        case 52:
            company.cash = Math.max(0, company.cash - 5);
            company.extraLaborCost = (company.extraLaborCost || 0) + 5;  // äººä»¶è²»
            if (company.workers > 0) {
                company.workers--;
                company.retiredWorkers = (company.retiredWorkers || 0) + 1;  // é€€è·è€…è¿½è·¡ï¼ˆ0.5ååˆ†çµ¦æ–™ï¼‰
                alert('ãƒ¯ãƒ¼ã‚«ãƒ¼é€€è·ï¼\näººä»¶è²»â–²5\nãƒ¯ãƒ¼ã‚«ãƒ¼1äººé€€è·ï¼ˆçµ¦æ–™ã¯0.5ååˆ†ï¼‰');
            } else {
                alert('ãƒ¯ãƒ¼ã‚«ãƒ¼é€€è·ï¼\näººä»¶è²»â–²5');
            }
            break;
        case 53: // æ™¯æ°—å¤‰å‹•
        case 54:
            gameState.turnReversed = !gameState.turnReversed;
            alert(`æ™¯æ°—å¤‰å‹•ï¼\nã‚¿ãƒ¼ãƒ³é †ãŒ${gameState.turnReversed ? 'é€†å›ã‚Š' : 'æ­£é †'}ã«ãªã‚Šã¾ã—ãŸ`);
            break;
        case 55: // æ•™è‚²å¤±æ•—
        case 56:
            if (company.chips.education > 0) {
                company.chips.education--;
                alert('æ•™è‚²å¤±æ•—ï¼\né»„ãƒãƒƒãƒ—1æšè¿”å´');
            } else if (company.nextPeriodChips.education > 0) {
                company.nextPeriodChips.education--;
                alert('æ•™è‚²å¤±æ•—ï¼\næ¬¡ç¹°ç›¤ã®é»„ãƒãƒƒãƒ—1æšè¿”å´');
            } else {
                alert('æ•™è‚²å¤±æ•—ï¼\nï¼ˆé»„ãƒãƒƒãƒ—ãŒãªã„ãŸã‚åŠ¹æœãªã—ï¼‰');
                rowUsed = false;
            }
            break;
        case 57: // ã‚»ãƒ¼ãƒ«ã‚¹ãƒãƒ³é€€è·
        case 58:
            company.cash = Math.max(0, company.cash - 5);
            company.extraLaborCost = (company.extraLaborCost || 0) + 5;  // äººä»¶è²»
            if (company.salesmen > 0) {
                company.salesmen--;
                company.retiredSalesmen = (company.retiredSalesmen || 0) + 1;  // é€€è·è€…è¿½è·¡ï¼ˆ0.5ååˆ†çµ¦æ–™ï¼‰
                alert('ã‚»ãƒ¼ãƒ«ã‚¹ãƒãƒ³é€€è·ï¼\näººä»¶è²»â–²5\nã‚»ãƒ¼ãƒ«ã‚¹ãƒãƒ³1äººé€€è·ï¼ˆçµ¦æ–™ã¯0.5ååˆ†ï¼‰');
            } else {
                alert('ã‚»ãƒ¼ãƒ«ã‚¹ãƒãƒ³é€€è·ï¼\näººä»¶è²»â–²5');
            }
            break;
        case 59: // ç¤¾é•·ã€ç—…æ°—ã§å€’ã‚Œã‚‹
        case 60:
            company.skipTurns = 1;
            showToast('ç¤¾é•·ã€ç—…æ°—ã§å€’ã‚Œã‚‹ï¼\n1å›ä¼‘ã¿', 'danger', 4000);
            rowUsed = false;
            break;
        case 61: // ä¸è‰¯åœ¨åº«ç™ºç”Ÿ
        case 62:
            let totalInventory = company.materials + company.wip + company.products;
            if (totalInventory > 20) {
                let excess = totalInventory - 20;
                let lostItems = 0;
                let lostValue = 0;
                // è£½å“ã‹ã‚‰é †ã«å‡¦ç†
                if (company.products > 0 && excess > 0) {
                    const remove = Math.min(company.products, excess);
                    company.products -= remove;
                    lostValue += remove * 15;  // è£½å“1å€‹=15å††
                    lostItems += remove;
                    excess -= remove;
                }
                if (company.wip > 0 && excess > 0) {
                    const remove = Math.min(company.wip, excess);
                    company.wip -= remove;
                    lostValue += remove * 14;  // ä»•æ›å“1å€‹=14å††
                    lostItems += remove;
                    excess -= remove;
                }
                if (company.materials > 0 && excess > 0) {
                    const remove = Math.min(company.materials, excess);
                    company.materials -= remove;
                    lostValue += remove * 13;  // ææ–™1å€‹=13å††
                    lostItems += remove;
                }

                // ä¿é™ºåŠ å…¥ãƒã‚§ãƒƒã‚¯
                if (company.chips.insurance > 0) {
                    const compensation = lostItems * 10;  // 1å€‹10å††ã®ä¿é™ºé‡‘
                    const netLoss = lostValue - compensation;
                    company.cash += compensation;
                    company.chips.insurance = 0;  // ä¿é™ºä½¿ç”¨å¾Œæ¶ˆå¤±
                    company.specialLoss = (company.specialLoss || 0) + netLoss;
                    if (company.type === 'player') {
                        showInsuranceRepurchaseModal('ä¸è‰¯åœ¨åº«ç™ºç”Ÿ', lostItems, compensation, netLoss);
                        return;  // ãƒ¢ãƒ¼ãƒ€ãƒ«ã§å†åŠ å…¥é¸æŠå¾Œã«å‡¦ç†
                    } else {
                        // AIä¼šç¤¾ã¯è‡ªå‹•ã§å†åŠ å…¥
                        if (company.cash >= 5) {
                            company.cash -= 5;
                            company.chips.insurance = 1;
                        }
                        alert(`ä¸è‰¯åœ¨åº«ç™ºç”Ÿï¼\n${lostItems}å€‹ã‚’ã‚¹ãƒˆãƒƒã‚«ãƒ¼ã¸\nä¿é™ºé‡‘: Â¥${compensation}\nç‰¹åˆ¥æå¤±: Â¥${netLoss}`);
                    }
                } else {
                    // ä¿é™ºæœªåŠ å…¥
                    company.specialLoss = (company.specialLoss || 0) + lostValue;
                    alert(`ä¸è‰¯åœ¨åº«ç™ºç”Ÿï¼\n${lostItems}å€‹ã‚’ã‚¹ãƒˆãƒƒã‚«ãƒ¼ã¸\nç‰¹åˆ¥æå¤±: Â¥${lostValue}ï¼ˆä¿é™ºæœªåŠ å…¥ï¼‰`);
                }
            } else {
                alert('ä¸è‰¯åœ¨åº«ç™ºç”Ÿï¼\nï¼ˆç·åœ¨åº«ãŒ20å€‹ä»¥ä¸‹ã®ãŸã‚åŠ¹æœãªã—ï¼‰');
                rowUsed = false;
            }
            break;
        case 63: // æ©Ÿæ¢°æ•…éšœ
        case 64:
            company.cash = Math.max(0, company.cash - 5);
            if (!company.additionalFixedCost) company.additionalFixedCost = 0;
            company.additionalFixedCost += 5;
            alert('æ©Ÿæ¢°æ•…éšœï¼\nè£½é€ çµŒè²»â–²5');
            break;
    }

    closeModal();

    if (rowUsed) {
        endTurn();
    } else {
        // è¡Œã‚’æ¶ˆè²»ã—ãªã„ãƒªã‚¹ã‚¯ã‚«ãƒ¼ãƒ‰ã®å ´åˆã€æ„æ€æ±ºå®šã‚«ãƒ¼ãƒ‰ã‚’è¡¨ç¤º
        showDecisionCard();
    }
}

// Special service modal
function showSpecialServiceModal() {
    const content = `
        <div class="form-group">
            <label class="form-label">ç‰¹åˆ¥ã‚µãƒ¼ãƒ“ã‚¹ã‚’é¸æŠã—ã¦ãã ã•ã„:</label>
            <div style="margin: 10px 0;">
                <button class="action-btn primary" onclick="executeMaterialPurchase()" style="width: 100%; margin: 5px 0;">
                    ææ–™è³¼å…¥ï¼ˆ1å€‹Â¥10ã§5å€‹ã¾ã§ï¼‰
                </button>
                <button class="action-btn secondary" onclick="executeAdPurchase()" style="width: 100%; margin: 5px 0;">
                    åºƒå‘Šãƒãƒƒãƒ—è³¼å…¥ï¼ˆ1æšÂ¥20ã§2æšã¾ã§ï¼‰
                </button>
            </div>
        </div>
    `;
    
    showModal('ç‰¹åˆ¥ã‚µãƒ¼ãƒ“ã‚¹', content);
}

// Execute material purchase from special service
function executeMaterialPurchase() {
    const company = gameState.companies[0];
    
    // è³¼å…¥æ•°é‡ã‚’é¸æŠã•ã›ã‚‹
    const content = `
        <div class="form-group">
            <label class="form-label">ææ–™è³¼å…¥ï¼šæ•°é‡ã‚’é¸æŠã—ã¦ãã ã•ã„</label>
            <p style="font-size: 12px; color: #666;">ç‰¹åˆ¥ä¾¡æ ¼ï¼š1å€‹10å††ï¼ˆæœ€å¤§5å€‹ã¾ã§ï¼‰</p>
            <p style="font-size: 12px; color: #666;">ç¾åœ¨ã®ç¾é‡‘: Â¥${company.cash}</p>
            <p style="font-size: 12px; color: #666;">ç¾åœ¨ã®ææ–™: ${company.materials}å€‹</p>
            <select id="materialQty" class="form-control">
                <option value="0">è³¼å…¥ã—ãªã„</option>
                ${company.cash >= 10 ? '<option value="1">1å€‹ï¼ˆÂ¥10ï¼‰</option>' : ''}
                ${company.cash >= 20 ? '<option value="2">2å€‹ï¼ˆÂ¥20ï¼‰</option>' : ''}
                ${company.cash >= 30 ? '<option value="3">3å€‹ï¼ˆÂ¥30ï¼‰</option>' : ''}
                ${company.cash >= 40 ? '<option value="4">4å€‹ï¼ˆÂ¥40ï¼‰</option>' : ''}
                ${company.cash >= 50 ? '<option value="5">5å€‹ï¼ˆÂ¥50ï¼‰</option>' : ''}
            </select>
            <button class="submit-btn" onclick="confirmMaterialPurchase()" style="margin-top: 10px;">è³¼å…¥</button>
        </div>
    `;
    
    showModal('ç‰¹åˆ¥ã‚µãƒ¼ãƒ“ã‚¹ - ææ–™è³¼å…¥', content);
}

// Confirm material purchase from special service
function confirmMaterialPurchase() {
    const company = gameState.companies[0];
    const buyQty = parseInt(document.getElementById('materialQty').value || 0);

    if (buyQty > 0) {
        const cost = buyQty * 10;
        company.cash -= cost;
        company.materials += buyQty;
        company.totalMaterialCost += cost;
        incrementRow(gameState.companies.indexOf(company));
        closeModal();
        alert(`ç‰¹åˆ¥ã‚µãƒ¼ãƒ“ã‚¹ï¼šææ–™${buyQty}å€‹ã‚’Â¥${cost}ã§è³¼å…¥ã—ã¾ã—ãŸ`);
        updateDisplay();
        nextTurn();
    } else {
        // è³¼å…¥ã—ãªã„å ´åˆã¯æ„æ€æ±ºå®šã‚«ãƒ¼ãƒ‰ã‚’è¡¨ç¤ºï¼ˆè¡Œã‚’æ¶ˆè²»ã—ãªã„ï¼‰
        closeModal();
        showDecisionCard();
    }
}

// Execute ad chip purchase from special service
function executeAdPurchase() {
    const company = gameState.companies[0];
    
    // è³¼å…¥æ•°é‡ã‚’é¸æŠã•ã›ã‚‹
    const content = `
        <div class="form-group">
            <label class="form-label">åºƒå‘Šãƒãƒƒãƒ—è³¼å…¥ï¼šæ•°é‡ã‚’é¸æŠã—ã¦ãã ã•ã„</label>
            <p style="font-size: 12px; color: #666;">ç‰¹åˆ¥ä¾¡æ ¼ï¼š1æš20å††ï¼ˆæœ€å¤§2æšã¾ã§ï¼‰</p>
            <p style="font-size: 12px; color: #666;">ç¾åœ¨ã®ç¾é‡‘: Â¥${company.cash}</p>
            <p style="font-size: 12px; color: #666;">ç¾åœ¨ã®åºƒå‘Šãƒãƒƒãƒ—: ${company.chips.advertising || 0}æš</p>
            <select id="adChipQty" class="form-control">
                <option value="0">è³¼å…¥ã—ãªã„</option>
                ${company.cash >= 20 ? '<option value="1">1æšï¼ˆÂ¥20ï¼‰</option>' : ''}
                ${company.cash >= 40 ? '<option value="2">2æšï¼ˆÂ¥40ï¼‰</option>' : ''}
            </select>
            <button class="submit-btn" onclick="confirmAdPurchase()" style="margin-top: 10px;">è³¼å…¥</button>
        </div>
    `;
    
    showModal('ç‰¹åˆ¥ã‚µãƒ¼ãƒ“ã‚¹ - åºƒå‘Šãƒãƒƒãƒ—è³¼å…¥', content);
}

// Confirm ad chip purchase from special service
function confirmAdPurchase() {
    const company = gameState.companies[0];
    const buyQty = parseInt(document.getElementById('adChipQty').value || 0);

    if (buyQty > 0) {
        const cost = buyQty * 20;
        company.cash -= cost;
        company.chips.advertising = (company.chips.advertising || 0) + buyQty;
        incrementRow(gameState.companies.indexOf(company));
        closeModal();
        alert(`ç‰¹åˆ¥ã‚µãƒ¼ãƒ“ã‚¹ï¼šåºƒå‘Šãƒãƒƒãƒ—${buyQty}æšã‚’Â¥${cost}ã§è³¼å…¥ã—ã¾ã—ãŸ`);
        updateDisplay();
        nextTurn();
    } else {
        // è³¼å…¥ã—ãªã„å ´åˆã¯æ„æ€æ±ºå®šã‚«ãƒ¼ãƒ‰ã‚’è¡¨ç¤ºï¼ˆè¡Œã‚’æ¶ˆè²»ã—ãªã„ï¼‰
        closeModal();
        showDecisionCard();
    }
}

// ============================================
// ä»•å…¥ã‚Œäº¤æ¸‰ã‚·ã‚¹ãƒ†ãƒ ï¼ˆä»–ä¼æ¥­ã‹ã‚‰è£½å“ã‚’è³¼å…¥ï¼‰
// ============================================

// ä»•å…¥ã‚Œäº¤æ¸‰ã®çŠ¶æ…‹ã‚’ä¿æŒ
let purchaseNegotiationState = {
    cardType: null,        // 'education', 'advertising', 'exclusive'
    maxSellQty: 0,         // æœ€å¤§è²©å£²å¯èƒ½æ•°
    ownProducts: 0,        // è‡ªç¤¾è£½å“æ•°
    needToBuy: 0,          // ä»•å…¥ã‚Œå¿…è¦æ•°
    purchases: [],         // [{companyIndex, qty, price}]
    onComplete: null       // å®Œäº†æ™‚ã®ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯
};

// AIä¼æ¥­ã®ä»•å…¥ã‚Œäº¤æ¸‰å¿œç­”ãƒ­ã‚¸ãƒƒã‚¯
function getAINegotiationResponse(aiCompany, requestedQty, offeredPrice) {
    // AIä¼æ¥­ã®æˆ¦ç•¥ã«åŸºã¥ã„ã¦äº¤æ¸‰å¿œç­”ã‚’æ±ºå®š
    const strategy = aiCompany.strategy;
    const hasProducts = aiCompany.products >= requestedQty;

    if (!hasProducts) {
        return { accept: false, counter: null, reason: 'åœ¨åº«ä¸è¶³' };
    }

    // å„æˆ¦ç•¥ã®æœ€ä½å¸Œæœ›ä¾¡æ ¼
    let minPrice;
    switch (strategy) {
        case 'aggressive':
            minPrice = 26;  // ç©æ¥µçš„ï¼šåˆ©ç›Šé‡è¦–ã§é«˜ã‚
            break;
        case 'balanced':
            minPrice = 24;  // ãƒãƒ©ãƒ³ã‚¹å‹ï¼šä¸­é–“
            break;
        case 'conservative':
            minPrice = 28;  // ä¿å®ˆçš„ï¼šãƒªã‚¹ã‚¯å›é¿ã§é«˜ã‚
            break;
        case 'price_focused':
            minPrice = 22;  // ä¾¡æ ¼ç ´å£Šï¼šå®‰ãã¦ã‚‚å£²ã‚‹
            break;
        case 'tech_focused':
            minPrice = 25;  // æŠ€è¡“é‡è¦–ï¼šæ™®é€š
            break;
        case 'unpredictable':
            minPrice = 18 + Math.floor(Math.random() * 14);  // 18-31ã®ãƒ©ãƒ³ãƒ€ãƒ 
            break;
        default:
            minPrice = 25;
    }

    if (offeredPrice >= minPrice) {
        return { accept: true, counter: null, reason: null };
    } else {
        // ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ã‚ªãƒ•ã‚¡ãƒ¼
        const counterPrice = Math.min(31, minPrice + Math.floor(Math.random() * 3));
        return { accept: false, counter: counterPrice, reason: `Â¥${counterPrice}ãªã‚‰å£²ã‚Šã¾ã™` };
    }
}

// ä»•å…¥ã‚Œäº¤æ¸‰ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
function showPurchaseNegotiationModal(cardType, maxSellQty, ownProducts, onComplete) {
    const company = gameState.companies[0];
    const needToBuy = maxSellQty - ownProducts;

    if (needToBuy <= 0) {
        // ä»•å…¥ã‚Œä¸è¦ï¼šè‡ªç¤¾è£½å“ã ã‘ã§è¶³ã‚Šã‚‹
        onComplete(0, 0, []);
        return;
    }

    // ä»–ä¼æ¥­ã®åœ¨åº«ã‚’ç¢ºèª
    const otherCompanies = gameState.companies.slice(1).filter(c => c.products > 0);

    if (otherCompanies.length === 0) {
        alert('ä»–ä¼æ¥­ã«åœ¨åº«ãŒãªã„ãŸã‚ä»•å…¥ã‚Œã§ãã¾ã›ã‚“');
        onComplete(0, 0, []);
        return;
    }

    purchaseNegotiationState = {
        cardType,
        maxSellQty,
        ownProducts,
        needToBuy,
        purchases: [],
        onComplete
    };

    let content = `
        <div class="form-group">
            <p><strong>è²©å£²å¯èƒ½æ•°:</strong> ${maxSellQty}å€‹ï¼ˆè‡ªç¤¾${ownProducts}å€‹ + ä»•å…¥ã‚Œ${needToBuy}å€‹ã¾ã§ï¼‰</p>
            <p><strong>ä»•å…¥ã‚Œå¯èƒ½æ•°:</strong> æœ€å¤§${needToBuy}å€‹</p>
            <hr style="margin: 10px 0;">
            <p><strong>ä»–ä¼æ¥­ã‹ã‚‰ä»•å…¥ã‚Œäº¤æ¸‰:</strong></p>
            <div id="negotiationList">
    `;

    otherCompanies.forEach((c, idx) => {
        const actualIdx = gameState.companies.indexOf(c);
        content += `
            <div style="border: 1px solid #ddd; padding: 10px; margin: 5px 0; border-radius: 5px;">
                <strong>${c.name}</strong>ï¼ˆåœ¨åº«: ${c.products}å€‹ï¼‰
                <div style="display: flex; gap: 10px; margin-top: 5px; align-items: center;">
                    <label>æ•°é‡: <input type="number" id="negQty_${actualIdx}" min="0" max="${Math.min(c.products, needToBuy)}" value="0" style="width: 60px;"></label>
                    <label>å¸Œæœ›ä¾¡æ ¼: Â¥<input type="number" id="negPrice_${actualIdx}" min="15" max="31" value="25" style="width: 60px;"></label>
                    <button class="action-btn secondary" onclick="negotiateWithCompany(${actualIdx})" style="padding: 5px 10px;">äº¤æ¸‰</button>
                    <span id="negResult_${actualIdx}" style="font-size: 12px;"></span>
                </div>
            </div>
        `;
    });

    content += `
            </div>
            <div id="purchaseSummary" style="margin-top: 15px; padding: 10px; background: #f5f5f5; border-radius: 5px;">
                <p>ä»•å…¥ã‚Œåˆè¨ˆ: <span id="totalPurchased">0</span>å€‹ / è²»ç”¨: Â¥<span id="totalCost">0</span></p>
            </div>
            <div style="margin-top: 15px; display: flex; gap: 10px;">
                <button class="action-btn primary" onclick="completePurchaseNegotiation()">ä»•å…¥ã‚Œå®Œäº†</button>
                <button class="action-btn secondary" onclick="skipPurchaseNegotiation()">ä»•å…¥ã‚Œã—ãªã„</button>
            </div>
        </div>
    `;

    showModal('ä»•å…¥ã‚Œäº¤æ¸‰', content);
}

// å€‹åˆ¥ä¼æ¥­ã¨ã®äº¤æ¸‰
function negotiateWithCompany(companyIndex) {
    const aiCompany = gameState.companies[companyIndex];
    const qtyInput = document.getElementById(`negQty_${companyIndex}`);
    const priceInput = document.getElementById(`negPrice_${companyIndex}`);
    const resultSpan = document.getElementById(`negResult_${companyIndex}`);

    const requestedQty = parseInt(qtyInput.value) || 0;
    const offeredPrice = parseInt(priceInput.value) || 25;

    if (requestedQty <= 0) {
        resultSpan.textContent = 'æ•°é‡ã‚’æŒ‡å®šã—ã¦ãã ã•ã„';
        resultSpan.style.color = 'orange';
        return;
    }

    if (requestedQty > aiCompany.products) {
        resultSpan.textContent = 'åœ¨åº«ä¸è¶³';
        resultSpan.style.color = 'red';
        return;
    }

    // æ—¢å­˜ã®äº¤æ¸‰çµæœã‚’å‰Šé™¤
    purchaseNegotiationState.purchases = purchaseNegotiationState.purchases.filter(
        p => p.companyIndex !== companyIndex
    );

    // ç¾åœ¨ã®ä»•å…¥ã‚Œåˆè¨ˆã‚’ç¢ºèª
    const currentTotal = purchaseNegotiationState.purchases.reduce((sum, p) => sum + p.qty, 0);
    const remainingNeed = purchaseNegotiationState.needToBuy - currentTotal;

    if (requestedQty > remainingNeed) {
        resultSpan.textContent = `ã‚ã¨${remainingNeed}å€‹ã¾ã§`;
        resultSpan.style.color = 'orange';
        return;
    }

    const response = getAINegotiationResponse(aiCompany, requestedQty, offeredPrice);

    if (response.accept) {
        purchaseNegotiationState.purchases.push({
            companyIndex,
            qty: requestedQty,
            price: offeredPrice
        });
        resultSpan.textContent = `âœ“ ${requestedQty}å€‹Ã—Â¥${offeredPrice}ã§åˆæ„`;
        resultSpan.style.color = 'green';
    } else if (response.counter) {
        resultSpan.textContent = response.reason;
        resultSpan.style.color = 'blue';
        priceInput.value = response.counter;
    } else {
        resultSpan.textContent = response.reason;
        resultSpan.style.color = 'red';
    }

    updatePurchaseSummary();
}

// ä»•å…¥ã‚Œã‚µãƒãƒªãƒ¼ã‚’æ›´æ–°
function updatePurchaseSummary() {
    const totalPurchased = purchaseNegotiationState.purchases.reduce((sum, p) => sum + p.qty, 0);
    const totalCost = purchaseNegotiationState.purchases.reduce((sum, p) => sum + (p.qty * p.price), 0);

    const purchasedSpan = document.getElementById('totalPurchased');
    const costSpan = document.getElementById('totalCost');

    if (purchasedSpan) purchasedSpan.textContent = totalPurchased;
    if (costSpan) costSpan.textContent = totalCost;
}

// ä»•å…¥ã‚Œäº¤æ¸‰å®Œäº†
function completePurchaseNegotiation() {
    const company = gameState.companies[0];
    const state = purchaseNegotiationState;

    const totalPurchased = state.purchases.reduce((sum, p) => sum + p.qty, 0);
    const totalCost = state.purchases.reduce((sum, p) => sum + (p.qty * p.price), 0);

    // è³‡é‡‘ãƒã‚§ãƒƒã‚¯
    if (totalCost > company.cash) {
        alert(`è³‡é‡‘ä¸è¶³ã§ã™ï¼ˆå¿…è¦: Â¥${totalCost}ã€ç¾é‡‘: Â¥${company.cash}ï¼‰`);
        return;
    }

    // ä»•å…¥ã‚Œå®Ÿè¡Œ
    company.cash -= totalCost;
    state.purchases.forEach(p => {
        gameState.companies[p.companyIndex].products -= p.qty;
        gameState.companies[p.companyIndex].cash += p.qty * p.price;
    });

    closeModal();

    if (state.onComplete) {
        state.onComplete(totalPurchased, totalCost, state.purchases);
    }
}

// ä»•å…¥ã‚Œã‚¹ã‚­ãƒƒãƒ—
function skipPurchaseNegotiation() {
    closeModal();
    if (purchaseNegotiationState.onComplete) {
        purchaseNegotiationState.onComplete(0, 0, []);
    }
}

// ä»•å…¥ã‚Œå¯èƒ½ã‚«ãƒ¼ãƒ‰ç”¨ã®è²©å£²å‡¦ç†
function executeSpecialSaleWithPurchase(cardType, chipType, maxPerChip, salesCapacityRequired) {
    const company = gameState.companies[0];

    // ãƒãƒƒãƒ—ç¢ºèª
    let chipCount = 0;
    if (chipType === 'education') chipCount = company.chips.education || 0;
    else if (chipType === 'advertising') chipCount = company.chips.advertising || 0;
    else if (chipType === 'research') chipCount = company.chips.research || 0;
    else if (chipType === 'salesmen') chipCount = company.salesmen || 0;

    if (chipCount <= 0 && chipType !== 'salesmen') {
        return { success: false, reason: 'ãƒãƒƒãƒ—ãªã—' };
    }
    if (chipType === 'salesmen' && chipCount <= 0) {
        return { success: false, reason: 'ã‚»ãƒ¼ãƒ«ã‚¹ãƒãƒ³ãªã—' };
    }

    // æœ€å¤§è²©å£²æ•°ã‚’è¨ˆç®—
    let maxSell = chipCount * maxPerChip;
    maxSell = Math.min(maxSell, 5);  // æœ€é«˜5å€‹ã¾ã§

    if (salesCapacityRequired) {
        const salesCapacity = getSalesCapacity(company);
        maxSell = Math.min(maxSell, salesCapacity);
    }

    const ownProducts = company.products;

    // è‡ªç¤¾è£½å“ãŒãªã„å ´åˆã§ã‚‚ä»•å…¥ã‚Œå¯èƒ½ãªã‚‰ç¶šè¡Œ
    if (ownProducts <= 0 && cardType !== 'research') {
        // ä»•å…¥ã‚Œäº¤æ¸‰ã‚’é–‹å§‹
        showPurchaseNegotiationModal(cardType, maxSell, ownProducts, (purchasedQty, purchaseCost, purchases) => {
            const totalSell = purchasedQty;
            if (totalSell > 0) {
                const revenue = totalSell * 32;
                company.cash += revenue;
                company.totalSales += revenue;
                alert(`${cardType === 'education' ? 'æ•™è‚²æˆåŠŸ' : cardType === 'advertising' ? 'åºƒå‘ŠæˆåŠŸ' : 'å•†å“ã®ç‹¬å è²©å£²'}ï¼\nä»•å…¥ã‚Œ${purchasedQty}å€‹ï¼ˆÂ¥${purchaseCost}ï¼‰â†’ ${totalSell}å€‹ã‚’Â¥${revenue}ã§è²©å£²\nç´”åˆ©ç›Š: Â¥${revenue - purchaseCost}`);
                endTurn();
            } else {
                alert('ä»•å…¥ã‚Œãªã—ï¼šåŠ¹æœãªã—');
                nextTurn();
            }
        });
        return { success: true, async: true };
    }

    // ä»•å…¥ã‚Œäº¤æ¸‰ã‚’é–‹å§‹
    showPurchaseNegotiationModal(cardType, maxSell, ownProducts, (purchasedQty, purchaseCost, purchases) => {
        const totalSell = ownProducts + purchasedQty;
        const sellFromOwn = Math.min(ownProducts, totalSell);

        if (totalSell > 0) {
            company.products -= sellFromOwn;
            const revenue = totalSell * 32;
            company.cash += revenue;
            company.totalSales += revenue;

            let message = `${cardType === 'education' ? 'æ•™è‚²æˆåŠŸ' : cardType === 'advertising' ? 'åºƒå‘ŠæˆåŠŸ' : 'å•†å“ã®ç‹¬å è²©å£²'}ï¼\n`;
            message += `è‡ªç¤¾${sellFromOwn}å€‹`;
            if (purchasedQty > 0) {
                message += ` + ä»•å…¥ã‚Œ${purchasedQty}å€‹ï¼ˆÂ¥${purchaseCost}ï¼‰`;
            }
            message += `\nåˆè¨ˆ${totalSell}å€‹ã‚’Â¥${revenue}ã§è²©å£²`;
            if (purchasedQty > 0) {
                message += `\nç´”åˆ©ç›Š: Â¥${revenue - purchaseCost}`;
            }
            alert(message);
            endTurn();
        } else {
            alert('è²©å£²ãªã—ï¼šåŠ¹æœãªã—');
            nextTurn();
        }
    });

    return { success: true, async: true };
}

// Show forced action modal for æ¶ˆè²»è€…é‹å‹•ç™ºç”Ÿ
function showForcedActionModal() {
    const content = `
        <div class="form-group">
            <label class="form-label">æ¶ˆè²»è€…é‹å‹•ç™ºç”Ÿï¼šè²©å£²ç¦æ­¢ã®ãŸã‚ã€ä»¥ä¸‹ã‹ã‚‰é¸æŠã—ã¦ãã ã•ã„</label>
            <div style="margin: 10px 0;">
                <button class="action-btn primary" onclick="closeModal(); showMaterialPurchaseModal();" style="width: 100%; margin: 5px 0;">
                    ææ–™è³¼å…¥
                </button>
                <button class="action-btn primary" onclick="closeModal(); showProductionModal();" style="width: 100%; margin: 5px 0;">
                    å®Œæˆãƒ»æŠ•å…¥
                </button>
                <button class="action-btn secondary" onclick="closeModal(); doNothing();" style="width: 100%; margin: 5px 0;">
                    Do Nothingï¼ˆ1è¡Œæ¶ˆè²»ï¼‰
                </button>
            </div>
        </div>
    `;

    showModal('æ¶ˆè²»è€…é‹å‹•ç™ºç”Ÿ - è¡Œå‹•é¸æŠ', content);
}

// Show forced action modal for åŠ´ç½ç™ºç”Ÿ
function showLaborAccidentActionModal() {
    const content = `
        <div class="form-group">
            <div style="background: #fee2e2; border: 2px solid #dc2626; border-radius: 8px; padding: 12px; margin-bottom: 15px; text-align: center;">
                <div style="font-weight: bold; color: #b91c1c;">âš ï¸ åŠ´ç½ç™ºç”Ÿä¸­</div>
                <div style="font-size: 12px; color: #7f1d1d; margin-top: 5px;">ç”Ÿç”£æ´»å‹•ã¯ã§ãã¾ã›ã‚“</div>
            </div>
            <label class="form-label">ä»¥ä¸‹ã‹ã‚‰è¡Œå‹•ã‚’é¸æŠã—ã¦ãã ã•ã„ï¼š</label>
            <div style="margin: 10px 0;">
                <button class="action-btn success" onclick="closeModal(); showSaleModal();" style="width: 100%; margin: 5px 0;">
                    ğŸ’° å•†å“è²©å£²
                </button>
                <button class="action-btn primary" onclick="closeModal(); showMaterialPurchaseModal();" style="width: 100%; margin: 5px 0;">
                    ğŸ“¦ ææ–™è³¼å…¥
                </button>
                <button class="action-btn secondary" onclick="closeModal(); doNothing();" style="width: 100%; margin: 5px 0;">
                    â¸ï¸ Do Nothingï¼ˆ1è¡Œæ¶ˆè²»ï¼‰
                </button>
            </div>
        </div>
    `;

    showModal('åŠ´ç½ç™ºç”Ÿ - è¡Œå‹•é¸æŠ', content);
}

// Show hiring choice modal for ç¸æ•…æ¡ç”¨
function showHiringChoiceModal() {
    const company = gameState.companies[0];
    const content = `
        <div style="background: #fef3c7; border-radius: 8px; padding: 10px; margin-bottom: 15px; text-align: center;">
            <div style="font-weight: bold; color: #92400e;">ğŸ’° æŒã¡é‡‘: Â¥${company.cash}</div>
        </div>
        <p style="text-align: center; margin-bottom: 15px; color: #666; font-size: 14px;">ç¸æ•…æ¡ç”¨ï¼šè¿½åŠ ã™ã‚‹äººå“¡ã‚’é¸æŠï¼ˆæœ¬ç¤¾çµŒè²»Â¥5ï¼‰</p>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
            <!-- ã‚»ãƒ¼ãƒ«ã‚¹ãƒãƒ³ -->
            <div onclick="executeHiring('salesman')" style="
                background: linear-gradient(135deg, #ff6b6b 0%, #ee5a5a 100%);
                border: 3px solid #c44;
                border-radius: 12px;
                padding: 20px 15px;
                text-align: center;
                cursor: pointer;
                color: white;
                transition: transform 0.2s, box-shadow 0.2s;
                box-shadow: 0 4px 12px rgba(238, 90, 90, 0.4);
            " onmouseover="this.style.transform='scale(1.05)'; this.style.boxShadow='0 6px 20px rgba(238, 90, 90, 0.6)'"
               onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='0 4px 12px rgba(238, 90, 90, 0.4)'">
                <div style="font-size: 36px; margin-bottom: 8px;">ğŸ’¼</div>
                <div style="font-weight: bold; font-size: 16px;">ã‚»ãƒ¼ãƒ«ã‚¹ãƒãƒ³</div>
                <div style="font-size: 12px; margin-top: 5px;">+1å</div>
            </div>

            <!-- ãƒ¯ãƒ¼ã‚«ãƒ¼ -->
            <div onclick="executeHiring('worker')" style="
                background: linear-gradient(135deg, #f5deb3 0%, #deb887 100%);
                border: 3px solid #a08060;
                border-radius: 12px;
                padding: 20px 15px;
                text-align: center;
                cursor: pointer;
                color: #5d4037;
                transition: transform 0.2s, box-shadow 0.2s;
                box-shadow: 0 4px 12px rgba(160, 128, 96, 0.4);
            " onmouseover="this.style.transform='scale(1.05)'; this.style.boxShadow='0 6px 20px rgba(160, 128, 96, 0.6)'"
               onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='0 4px 12px rgba(160, 128, 96, 0.4)'">
                <div style="font-size: 36px; margin-bottom: 8px;">ğŸ‘·</div>
                <div style="font-weight: bold; font-size: 16px;">ãƒ¯ãƒ¼ã‚«ãƒ¼</div>
                <div style="font-size: 12px; margin-top: 5px;">+1å</div>
            </div>
        </div>
        <div style="text-align: center; margin-top: 15px;">
            <button class="cancel-btn" onclick="closeModal(true)" style="padding: 10px 30px;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        </div>
    `;

    showModal('ç¸æ•…æ¡ç”¨', content);
}

// Execute hiring from ç¸æ•…æ¡ç”¨
function executeHiring(type) {
    const company = gameState.companies[0];
    const cost = 5;  // ç¸æ•…æ¡ç”¨è²»ç”¨

    // ç¾é‡‘ä¸è¶³æ™‚ã¯çŸ­æœŸå€Ÿå…¥
    if (company.cash < cost) {
        const needed = Math.ceil((cost - company.cash) / 0.8 / 50) * 50;
        company.shortLoans += needed;
        company.cash += needed * 0.8;
        showToast(`ç¾é‡‘ä¸è¶³ã®ãŸã‚çŸ­æœŸå€Ÿå…¥Â¥${needed}ã‚’å®Ÿè¡Œã—ã¾ã—ãŸ`, 'warning', 4000);
    }

    // 5å††æ”¯æ‰•ã„
    company.cash -= cost;
    company.extraLaborCost = (company.extraLaborCost || 0) + cost;  // Fã«è¨ˆä¸Š

    if (type === 'worker') {
        company.workers++;
        // è¡Œå‹•ãƒ­ã‚°è¨˜éŒ²
        logAction(0, 'ç¸æ•…æ¡ç”¨', 'ãƒ¯ãƒ¼ã‚«ãƒ¼+1', -cost, true);
        closeModal();
        alert('ç¸æ•…æ¡ç”¨ï¼šãƒ¯ãƒ¼ã‚«ãƒ¼ã‚’1åè¿½åŠ ã—ã¾ã—ãŸï¼ˆÂ¥5ï¼‰');
    } else if (type === 'salesman') {
        company.salesmen++;
        // è¡Œå‹•ãƒ­ã‚°è¨˜éŒ²
        logAction(0, 'ç¸æ•…æ¡ç”¨', 'ã‚»ãƒ¼ãƒ«ã‚¹+1', -cost, true);
        closeModal();
        alert('ç¸æ•…æ¡ç”¨ï¼šã‚»ãƒ¼ãƒ«ã‚¹ãƒãƒ³ã‚’1åè¿½åŠ ã—ã¾ã—ãŸï¼ˆÂ¥5ï¼‰');
    }

    updateDisplay();
    endTurn();  // 5å††æ”¯æ‰•ã„ãŒã‚ã‚‹ã®ã§1è¡Œä½¿ç”¨
}

// Execute common purchase for all companies (å„ç¤¾å…±é€š)
function executeAllCompaniesCommonPurchase() {
    const triggerCompany = gameState.companies[gameState.currentPlayerIndex];
    const content = `
        <div class="risk-display">
            <div class="risk-title">${triggerCompany.name}ãŒã€Œå„ç¤¾å…±é€šã€ã‚’å¼•ãã¾ã—ãŸ</div>
            <div class="risk-description">å…¨ç¤¾ãŒ12å††ã§3å€‹ã¾ã§ææ–™ã‚’è³¼å…¥ã§ãã¾ã™<br>ï¼ˆã¾ãšå¸‚å ´ã‹ã‚‰ã€ä¸è¶³åˆ†ã¯æµ·å¤–ã‹ã‚‰ï¼‰</div>
        </div>
        <div class="form-group" style="margin-top: 20px;">
            <label class="form-label">ã‚ãªãŸã®è³¼å…¥æ•°é‡:</label>
            <p>ç¾åœ¨ã®ç¾é‡‘: Â¥${gameState.companies[0].cash}</p>
            <select id="playerQuantity" class="form-control">
                <option value="0">è³¼å…¥ã—ãªã„</option>
                <option value="1">1å€‹ï¼ˆÂ¥12ï¼‰</option>
                <option value="2">2å€‹ï¼ˆÂ¥24ï¼‰</option>
                <option value="3">3å€‹ï¼ˆÂ¥36ï¼‰</option>
            </select>
        </div>
        <button class="submit-btn" onclick="processCommonPurchase()">æ±ºå®š</button>
    `;
    
    showModal('å„ç¤¾å…±é€šè³¼å…¥', content);
}

// Process common purchase
function processCommonPurchase() {
    const playerQty = parseInt(document.getElementById('playerQuantity').value || 0);
    let purchaseLog = [];
    let playerPurchased = false;  // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒè³¼å…¥ã—ãŸã‹è¿½è·¡

    // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®è³¼å…¥å‡¦ç†
    if (playerQty > 0) {
        const playerCompany = gameState.companies[0];
        const cost = playerQty * 12;

        if (playerCompany.cash >= cost) {
            let purchased = 0;

            // ã¾ãšå¸‚å ´ã‹ã‚‰è³¼å…¥
            for (const market of gameState.markets) {
                if (purchased >= playerQty) break;
                if (market.currentStock > 0) {
                    const qty = Math.min(playerQty - purchased, market.currentStock);
                    market.currentStock -= qty;
                    purchased += qty;
                }
            }

            // ä¸è¶³åˆ†ã¯æµ·å¤–å¸‚å ´ï¼ˆã‚¹ãƒˆãƒƒã‚«ãƒ¼ï¼‰ã‹ã‚‰
            const overseasMarket = gameState.markets.find(m => m.name === 'æµ·å¤–');
            if (purchased < playerQty && overseasMarket) {
                const qty = playerQty - purchased;
                overseasMarket.currentStock = Math.max(0, overseasMarket.currentStock - qty);
                purchased += qty;
            }

            playerCompany.cash -= cost;
            playerCompany.materials += playerQty;
            playerCompany.totalMaterialCost += cost;
            playerPurchased = true;  // è³¼å…¥ã—ãŸ

            // è¡Œå‹•ãƒ­ã‚°è¨˜éŒ²
            logAction(0, 'å„ç¤¾å…±é€š', `Â¥12Ã—${playerQty}å€‹è³¼å…¥`, -cost, true);

            purchaseLog.push(`ã‚ãªãŸ: ${playerQty}å€‹è³¼å…¥ï¼ˆÂ¥${cost}ï¼‰`);
        } else {
            purchaseLog.push('ã‚ãªãŸ: ç¾é‡‘ä¸è¶³ã§è³¼å…¥ã§ããš');
        }
    } else {
        purchaseLog.push('ã‚ãªãŸ: è³¼å…¥ã—ãªã„');
    }

    // AIä¼šç¤¾ã®è³¼å…¥å‡¦ç†ï¼ˆãƒ—ãƒ­ã¯12å††ã§3å€‹å¿…ãšè²·ã†ï¼‰
    for (let i = 1; i < gameState.companies.length; i++) {
        const company = gameState.companies[i];
        const maxAffordable = Math.min(3, Math.floor(company.cash / 12));

        if (maxAffordable >= 2) {  // 2å€‹ä»¥ä¸Šè²·ãˆã‚‹ãªã‚‰è²·ã†
            const aiQty = maxAffordable;  // å¯èƒ½ãªé™ã‚Šæœ€å¤§é‡è³¼å…¥
            let purchased = 0;

            // ã¾ãšå¸‚å ´ã‹ã‚‰è³¼å…¥
            for (const market of gameState.markets) {
                if (purchased >= aiQty) break;
                if (market.currentStock > 0) {
                    const qty = Math.min(aiQty - purchased, market.currentStock);
                    market.currentStock -= qty;
                    purchased += qty;
                }
            }

            // ä¸è¶³åˆ†ã¯æµ·å¤–ã‹ã‚‰
            const overseasMarket = gameState.markets.find(m => m.name === 'æµ·å¤–');
            if (purchased < aiQty && overseasMarket) {
                const qty = aiQty - purchased;
                overseasMarket.currentStock = Math.max(0, overseasMarket.currentStock - qty);
                purchased += qty;
            }

            if (purchased > 0) {
                const aiCost = purchased * 12;
                company.cash -= aiCost;
                company.materials += purchased;
                company.totalMaterialCost += aiCost;

                // è¡Œå‹•ãƒ­ã‚°è¨˜éŒ²ï¼ˆAIï¼‰
                logAction(i, 'å„ç¤¾å…±é€š', `Â¥12Ã—${purchased}å€‹è³¼å…¥`, -aiCost, false);

                purchaseLog.push(`${company.name}: ${purchased}å€‹è³¼å…¥ï¼ˆÂ¥${aiCost}ï¼‰`);
            }
        }
    }

    closeModal();
    updateDisplay();

    // è³¼å…¥çµæœã‚’è¡¨ç¤º
    if (purchaseLog.length > 0) {
        alert('ã€å„ç¤¾å…±é€šè³¼å…¥çµæœã€‘\n' + purchaseLog.join('\n'));
    } else {
        alert('ã©ã®ä¼šç¤¾ã‚‚è³¼å…¥ã—ã¾ã›ã‚“ã§ã—ãŸ');
    }

    // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒè³¼å…¥ã—ãŸå ´åˆã®ã¿1è¡Œä½¿ç”¨
    if (playerPurchased) {
        endTurn();
    } else {
        nextTurn();
    }
}

// Render markets
function renderMarkets() {
    const container = document.getElementById('marketsContainer');
    let html = '';
    
    gameState.markets.forEach(market => {
        html += `
            <div class="market-card">
                <div class="market-header">
                    <span class="market-name">${market.name}</span>
                    <div class="market-prices">
                        <span class="price-tag buy">è²·Â¥${market.buyPrice}</span>
                        <span class="price-tag sell">å£²Â¥${market.sellPrice}</span>
                    </div>
                </div>
                <div class="market-stock-info">
                    <div class="market-stock">
                        ${Array(Math.min(market.currentStock, 20)).fill('<div class="stock-block"></div>').join('')}
                        ${market.currentStock > 20 ? '...' : ''}
                    </div>
                    <span class="stock-count">${market.currentStock}/${market.maxStock}</span>
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

// Render companies
function renderCompanies() {
    const container = document.getElementById('companiesContainer');
    let html = '';
    
    gameState.companies.forEach((company, index) => {
        const isCurrentTurn = index === gameState.currentPlayerIndex;
        const isPlayer = company.type === 'player';
        const mfgCapacity = getManufacturingCapacity(company);
        const salesCapacity = getSalesCapacity(company);
        
        // Machine display
        let machineDisplay = '';
        company.machines.forEach((machine) => {
            const machineName = machine.type === 'small' ? 
                (machine.attachments > 0 ? 'å°å‹+A' : 'å°å‹') : 'å¤§å‹';
            machineDisplay += `<span class="machine-item">${machineName}</span>`;
        });
        
        // Warehouse display
        let warehouseDisplay = '';
        if (company.warehouses > 0) {
            let locationText = '';
            if (company.warehouses === 2 || company.warehouseLocation === 'both') {
                locationText = 'æ+è£½';
            } else if (company.warehouseLocation === 'materials') {
                locationText = 'æ';
            } else {
                locationText = 'è£½';
            }
            warehouseDisplay = `<span class="warehouse-item">å€‰åº«(${locationText})</span>`;
        }
        
        html += `
            <div class="company-card ${isPlayer ? 'player' : ''} ${isCurrentTurn ? 'current-turn' : ''}">
                <div class="company-header">
                    <span class="company-name">${company.name}</span>
                    <span class="company-cash">Â¥${company.cash}</span>
                    <span style="font-size: 12px; background: ${(company.currentRow || 1) >= gameState.maxRows - 5 ? '#ef4444' : '#3b82f6'}; color: white; padding: 2px 6px; border-radius: 4px; font-weight: bold;">
                        è¡Œ:${company.currentRow || 1}/${gameState.maxRows}
                    </span>
                </div>
                <div class="company-stats">
                    <div class="stat-item">è‡ªå·±è³‡æœ¬: Â¥${company.equity}</div>
                    <div class="stat-item">å€Ÿå…¥: Â¥${company.loans + company.shortLoans}</div>
                    <div class="stat-item capacity" onclick="showManufacturingCapacityDetail(${index})" style="cursor: pointer;">è£½é€ èƒ½åŠ›: ${mfgCapacity}</div>
                    <div class="stat-item capacity" onclick="showSalesCapacityDetail(${index})" style="cursor: pointer;">è²©å£²èƒ½åŠ›: ${salesCapacity}</div>
                </div>
                <div class="machine-section">
                    ${machineDisplay || '<span class="machine-item">æ©Ÿæ¢°ãªã—</span>'}
                </div>
                ${warehouseDisplay ? `<div class="warehouse-section">${warehouseDisplay}</div>` : ''}
                <div class="personnel-section">
                    <div class="personnel-group">
                        <span class="personnel-label">ãƒ¯ãƒ¼ã‚«ãƒ¼:</span>
                        <div class="personnel-dots">
                            ${Array(company.workers).fill('<div class="personnel-dot"></div>').join('')}
                        </div>
                        <span>(${company.workers})</span>
                    </div>
                    <div class="personnel-group">
                        <span class="personnel-label">ã‚»ãƒ¼ãƒ«ã‚¹:</span>
                        <div class="personnel-dots">
                            ${Array(company.salesmen).fill('<div class="personnel-dot"></div>').join('')}
                        </div>
                        <span>(${company.salesmen})</span>
                    </div>
                </div>
                <div class="inventory-section">
                    <div class="inventory-box">
                        <div class="inventory-label">ææ–™</div>
                        <div class="inventory-blocks">
                            ${Array(Math.min(company.materials, 10)).fill('<div class="inventory-block material"></div>').join('')}
                            ${company.materials > 10 ? `<small>+${company.materials - 10}</small>` : ''}
                        </div>
                    </div>
                    <div class="inventory-box">
                        <div class="inventory-label">ä»•æ›å“</div>
                        <div class="inventory-blocks">
                            ${Array(Math.min(company.wip, 10)).fill('<div class="inventory-block wip"></div>').join('')}
                            ${company.wip > 10 ? `<small>+${company.wip - 10}</small>` : ''}
                        </div>
                    </div>
                    <div class="inventory-box">
                        <div class="inventory-label">è£½å“</div>
                        <div class="inventory-blocks">
                            ${Array(Math.min(company.products, 10)).fill('<div class="inventory-block product"></div>').join('')}
                            ${company.products > 10 ? `<small>+${company.products - 10}</small>` : ''}
                        </div>
                    </div>
                </div>
                <div class="chips-section">
                    <div class="chip-row">
                        <span class="chip-label">ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿:</span>
                        <div class="chip-dots">
                            ${Array(3).fill(0).map((_, i) => 
                                `<div class="chip-dot ${i < company.chips.computer ? 'filled computer' : ''}"></div>`
                            ).join('')}
                        </div>
                    </div>
                    <div class="chip-row">
                        <span class="chip-label">ä¿é™º:</span>
                        <div class="chip-dots">
                            ${Array(3).fill(0).map((_, i) => 
                                `<div class="chip-dot ${i < company.chips.insurance ? 'filled insurance' : ''}"></div>`
                            ).join('')}
                        </div>
                    </div>
                    <div class="chip-row">
                        <span class="chip-label">ç ”ç©¶:</span>
                        <div class="chip-dots">
                            ${Array(5).fill(0).map((_, i) =>
                                `<div class="chip-dot ${i < (company.chips.research + (company.nextPeriodChips?.research || 0)) ? 'filled research' : ''}"></div>`
                            ).join('')}
                        </div>
                    </div>
                    <div class="chip-row">
                        <span class="chip-label">æ•™è‚²:</span>
                        <div class="chip-dots">
                            ${Array(gameState.currentPeriod === 2 ? 2 : 1).fill(0).map((_, i) =>
                                `<div class="chip-dot ${i < (company.chips.education + (company.nextPeriodChips?.education || 0)) ? 'filled education' : ''}"></div>`
                            ).join('')}
                        </div>
                    </div>
                    <div class="chip-row">
                        <span class="chip-label">åºƒå‘Š:</span>
                        <div class="chip-dots">
                            ${Array(5).fill(0).map((_, i) =>
                                `<div class="chip-dot ${i < (company.chips.advertising + (company.nextPeriodChips?.advertising || 0)) ? 'filled advertising' : ''}"></div>`
                            ).join('')}
                        </div>
                    </div>
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

// Render action buttons
function renderActionButtons() {
    const container = document.getElementById('actionButtons');
    const isPlayerTurn = gameState.currentPlayerIndex === 0;
    
    let html = '';
    
    if (!gameState.periodStarted) {
        html = `<button class="action-btn warning" onclick="startPeriod()">ç¬¬${gameState.currentPeriod}æœŸã‚’é–‹å§‹</button>`;
    } else if (isPlayerTurn) {
        html = `
            <button class="action-btn main mobile-card-btn" onclick="showTurnStartOptions()">ã‚«ãƒ¼ãƒ‰ã‚’å¼•ã</button>
        `;
    } else {
        html = `
            <button class="action-btn secondary" disabled>AIã®ã‚¿ãƒ¼ãƒ³ä¸­...</button>
        `;
    }
    
    container.innerHTML = html;
}

// Update display
function updateDisplay() {
    const player = gameState.companies[0];
    const currentCompany = gameState.companies[gameState.currentPlayerIndex];

    // ãƒ˜ãƒƒãƒ€ãƒ¼æƒ…å ±
    document.getElementById('currentPeriod').textContent = gameState.currentPeriod;
    document.getElementById('currentRow').textContent = `${player.currentRow || 1}/${gameState.maxRows}`;
    document.getElementById('playerCash').textContent = `Â¥${player.cash}`;
    document.getElementById('equity').textContent = `Â¥${player.equity}`;

    // ã‚«ãƒ¼ãƒ‰ã‚’å¼•ãã‚»ã‚¯ã‚·ãƒ§ãƒ³
    const cardSection = document.getElementById('cardDrawSection');
    const turnInfo = document.getElementById('turnInfo');
    if (gameState.currentPlayerIndex === 0) {
        cardSection.style.display = 'block';
        turnInfo.textContent = 'ã‚ãªãŸã®ã‚¿ãƒ¼ãƒ³ã§ã™';
    } else {
        cardSection.style.display = 'none';
    }

    // ä¼šç¤¾ç›¤ã‚’æ›´æ–°
    renderCompanyBoard(player);

    // å¸‚å ´ç›¤ã‚’æ›´æ–°
    renderMarketsBoard();

    // å›ºå®šè²»å†…è¨³ã‚’æ›´æ–°
    renderFixedCostBreakdown(player);

    // ä»–ç¤¾ä¸€è¦§ã‚’æ›´æ–°
    renderOtherCompanies();

    // æ¬¡ç¹°ç›¤ã®è¡¨ç¤ºï¼ˆ3æœŸä»¥é™ã®ã¿ï¼‰
    const nextPeriodBoard = document.getElementById('nextPeriodBoard');
    if (gameState.currentPeriod >= 3) {
        nextPeriodBoard.style.display = 'block';
        document.getElementById('nextResearch').textContent = player.nextPeriodChips?.research || 0;
        document.getElementById('nextEducation').textContent = player.nextPeriodChips?.education || 0;
        document.getElementById('nextAdvertising').textContent = player.nextPeriodChips?.advertising || 0;
    } else {
        nextPeriodBoard.style.display = 'none';
    }
}

// ä¼šç¤¾ç›¤ã‚’æç”»
function renderCompanyBoard(company) {
    // æƒ…å ±ãƒãƒ¼ã‚’æ›´æ–°
    document.getElementById('currentPeriod').textContent = gameState.currentPeriod;
    document.getElementById('currentRow').textContent = `${company.currentRow}/${gameState.maxRows}`;
    document.getElementById('playerCash').textContent = `Â¥${company.cash}`;
    document.getElementById('equity').textContent = `Â¥${company.equity}`;

    // å›ºå®šè²»ã‚’è¨ˆç®—ã—ã¦è¡¨ç¤º
    const fixedCost = calculateFixedCostTotal(company, gameState.currentPeriod);
    document.getElementById('fixedCostDisplay').textContent = `Â¥${fixedCost}`;

    // èƒ½åŠ›ã‚µãƒãƒªãƒ¼ã‚’æ›´æ–°
    const mfgCapacity = getManufacturingCapacity(company);
    const salesCapacity = getSalesCapacity(company);
    const priceComp = getPriceCompetitiveness(company, 0);
    document.getElementById('mfgCapacityDisplay').textContent = mfgCapacity;
    document.getElementById('salesCapacityDisplay').textContent = salesCapacity;
    document.getElementById('priceCompDisplay').textContent = '+' + priceComp;

    // ææ–™
    const materialsHtml = Array(company.materials).fill('<div class="inv-block material"></div>').join('');
    document.getElementById('materialsDisplay').innerHTML = materialsHtml || '<span style="color:#999;font-size:10px;">0</span>';

    // ä»•æ›å“
    const wipHtml = Array(company.wip).fill('<div class="inv-block wip"></div>').join('');
    document.getElementById('wipDisplay').innerHTML = wipHtml || '<span style="color:#999;font-size:10px;">0</span>';

    // è£½å“
    const productsHtml = Array(company.products).fill('<div class="inv-block product"></div>').join('');
    document.getElementById('productsDisplay').innerHTML = productsHtml || '<span style="color:#999;font-size:10px;">0</span>';

    // ãƒ¯ãƒ¼ã‚«ãƒ¼
    const workersHtml = Array(company.workers).fill('<div class="person-dot worker">W</div>').join('');
    document.getElementById('workersDisplay').innerHTML = workersHtml || '<span style="color:#999;font-size:10px;">0</span>';

    // æ©Ÿæ¢°
    let machinesHtml = '';
    company.machines.forEach(m => {
        if (m.type === 'large') {
            machinesHtml += '<div class="machine-dot large">å¤§</div>';
        } else {
            machinesHtml += `<div class="machine-dot">å°${m.attachments > 0 ? '+' : ''}</div>`;
        }
    });
    document.getElementById('machinesDisplay').innerHTML = machinesHtml || '<span style="color:#999;font-size:10px;">0</span>';

    // ã‚»ãƒ¼ãƒ«ã‚¹ãƒãƒ³
    const salesmenHtml = Array(company.salesmen).fill('<div class="person-dot salesman">S</div>').join('');
    document.getElementById('salesmenDisplay').innerHTML = salesmenHtml || '<span style="color:#999;font-size:10px;">0</span>';

    // ãƒãƒƒãƒ—
    document.getElementById('researchChipsDisplay').innerHTML =
        Array(company.chips.research || 0).fill('<div class="chip research"></div>').join('') || '-';
    document.getElementById('educationChipsDisplay').innerHTML =
        Array(company.chips.education || 0).fill('<div class="chip education"></div>').join('') || '-';
    document.getElementById('advertisingChipsDisplay').innerHTML =
        Array(company.chips.advertising || 0).fill('<div class="chip advertising"></div>').join('') || '-';
    document.getElementById('computerChipsDisplay').innerHTML =
        Array(company.chips.computer || 0).fill('<div class="chip computer"></div>').join('') || '-';
    document.getElementById('insuranceChipsDisplay').innerHTML =
        Array(company.chips.insurance || 0).fill('<div class="chip insurance"></div>').join('') || '-';
}

// å¸‚å ´ç›¤ã‚’æç”»
function renderMarketsBoard() {
    // å¸‚å ´åâ†’CSSã‚¯ãƒ©ã‚¹åã®ãƒãƒƒãƒ”ãƒ³ã‚°
    const marketClasses = {
        'æ±äº¬': 'tokyo',
        'åå¤å±‹': 'nagoya',
        'å¤§é˜ª': 'osaka',
        'ç¦å²¡': 'fukuoka',
        'æµ·å¤–': 'overseas',
        'ä»™å°': 'sendai',
        'æœ­å¹Œ': 'sapporo'
    };

    // è¡¨ç¤ºé †ï¼ˆè²©å£²ä¸Šé™ä¾¡æ ¼ã®é«˜ã„é †ï¼‰
    const displayOrder = ['ä»™å°', 'æœ­å¹Œ', 'ç¦å²¡', 'åå¤å±‹', 'å¤§é˜ª', 'æ±äº¬', 'æµ·å¤–'];

    const company = gameState.companies[0];
    const period = gameState.currentPeriod;

    let html = '';
    displayOrder.forEach(marketName => {
        const market = gameState.markets.find(m => m.name === marketName);
        if (!market) return;
        const marketIndex = gameState.markets.indexOf(market);

        const marketClass = marketClasses[market.name] || '';
        const stockHtml = Array(Math.min(market.currentStock, 12)).fill('<div class="stock-cube"></div>').join('');
        const stockExtra = market.currentStock > 12 ? `+${market.currentStock - 12}` : '';

        // é–‰é–ä¸­ã‹ã©ã†ã‹
        const closedClass = market.closed ? 'closed' : '';

        // ãƒ¢ãƒ¼ãƒ‰åˆ¥ã®åˆ©ç”¨å¯èƒ½ãƒã‚§ãƒƒã‚¯
        let unavailableClass = '';
        let onClickHandler = '';

        // 2å¸‚å ´ãƒ¢ãƒ¼ãƒ‰ã§é¸æŠæ¸ˆã¿ã‹ãƒã‚§ãƒƒã‚¯ï¼ˆåŒæ™‚ãƒ»åˆ¥ã€…ä¸¡æ–¹ï¼‰
        const isSelected = (gameState.twoMarketMode === 'simultaneous' || gameState.twoMarketMode === 'separate') &&
            gameState.selectedMarkets && gameState.selectedMarkets.includes(marketIndex);

        if (gameState.salesMode) {
            // è²©å£²ãƒ¢ãƒ¼ãƒ‰: 2æœŸã¯æµ·å¤–ç¦æ­¢ã€é–‰é–å¸‚å ´ç¦æ­¢ã€åœ¨åº«æº€æ¯ç¦æ­¢
            const isFull = market.currentStock >= market.maxStock;
            const isOverseasIn2nd = period === 2 && market.name === 'æµ·å¤–';
            // 2å¸‚å ´åŒæ™‚ãƒ¢ãƒ¼ãƒ‰ã§ã¯å…¥æœ­å¸‚å ´ã®ã¿
            const needsBidOnly = gameState.twoMarketMode === 'simultaneous' && !market.needsBid;
            if (market.closed || isFull || isOverseasIn2nd || needsBidOnly) {
                unavailableClass = 'unavailable';
            } else {
                onClickHandler = `onclick="onMarketTileClick(${marketIndex}, 'sell')"`;
            }
        } else if (gameState.buyMode) {
            // è³¼å…¥ãƒ¢ãƒ¼ãƒ‰: é–‰é–å¸‚å ´ç¦æ­¢ã€åœ¨åº«ãŒãªã„å¸‚å ´ç¦æ­¢
            const isEmpty = market.currentStock <= 0;
            if (market.closed || isEmpty) {
                unavailableClass = 'unavailable';
            } else {
                onClickHandler = `onclick="onMarketTileClick(${marketIndex}, 'buy')"`;
            }
        }

        // ãƒãƒ¼ã‚±ãƒƒãƒˆãƒœãƒªãƒ¥ãƒ¼ãƒ ï¼ˆæµ·å¤–ã¯ç„¡åˆ¶é™ï¼‰
        const volumeText = market.name === 'æµ·å¤–' ? 'âˆ' : market.maxStock;

        const selectedClass = isSelected ? 'selected' : '';
        const selectedBadge = isSelected ? '<div style="position:absolute;top:2px;right:2px;background:#8b5cf6;color:white;border-radius:50%;width:20px;height:20px;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:bold;z-index:5;">âœ“</div>' : '';

        // ç‰©ç†ç›¤é¢¨ãƒã‚±ãƒƒãƒˆæ§‹é€ 
        html += `
            <div class="market-tile ${marketClass} ${closedClass} ${unavailableClass} ${selectedClass}" ${onClickHandler} style="position:relative;">
                ${selectedBadge}
                <!-- è‰²å¸¯ï¼ˆä¾¡æ ¼è¡¨ç¤ºã‚¨ãƒªã‚¢ï¼‰ -->
                <div class="market-color-band">
                    <span class="price-badge buy">${market.buyPrice}</span>
                    <span class="price-badge sell">${market.sellPrice}</span>
                </div>
                <!-- ãƒã‚±ãƒƒãƒˆå†…éƒ¨ï¼ˆé»’ã„å‡¹ã¿ã‚¨ãƒªã‚¢ï¼‰ -->
                <div class="market-pocket">
                    <div class="market-name">${market.name}</div>
                    <div class="market-volume">MV:${volumeText}</div>
                    <div class="market-stock">${stockHtml}${stockExtra ? `<span style="color:#fff;font-size:10px;margin-left:2px;">${stockExtra}</span>` : ''}</div>
                </div>
            </div>
        `;
    });
    document.getElementById('marketsDisplay').innerHTML = html;

    // ãƒ¢ãƒ¼ãƒ‰ã«å¿œã˜ã¦å¸‚å ´ç›¤ã«ã‚¯ãƒ©ã‚¹ã‚’è¿½åŠ 
    const marketsBoard = document.querySelector('.markets-board');
    if (marketsBoard) {
        marketsBoard.classList.toggle('sales-mode', gameState.salesMode);
        marketsBoard.classList.toggle('buy-mode', gameState.buyMode);
    }
}

// å›ºå®šè²»å†…è¨³ã‚’æç”»
function renderFixedCostBreakdown(company) {
    const period = gameState.currentPeriod;
    const baseCost = {2: 22, 3: 24, 4: 26, 5: 28};
    let unitCost = baseCost[period] || 22;

    if (period >= 3 && gameState.wageMultiplier > 1) {
        unitCost = Math.round(baseCost[period] * gameState.wageMultiplier);
    }

    const halfCost = Math.round(unitCost / 2);
    const machineCount = company.machines.length;
    const effectiveWorkers = company.workers + (company.retiredWorkers || 0) * 0.5;
    const effectiveSalesmen = company.salesmen + (company.retiredSalesmen || 0) * 0.5;
    const maxPersonnel = company.maxPersonnel || (company.workers + company.salesmen);

    const machineCost = machineCount * unitCost;
    const workerCost = Math.round(effectiveWorkers * unitCost);
    const salesmenCost = Math.round(effectiveSalesmen * unitCost);
    const maxPersonnelCost = maxPersonnel * halfCost;
    const salaryCost = machineCost + workerCost + salesmenCost + maxPersonnelCost;

    // æ¸›ä¾¡å„Ÿå´
    let depreciationCost = 0;
    company.machines.forEach(m => {
        if (period === 2) {
            depreciationCost += m.type === 'large' ? 20 : 10;
        } else {
            if (m.type === 'large') depreciationCost += 40;
            else depreciationCost += m.attachments > 0 ? 26 : 20;
        }
    });

    const extraLabor = company.extraLaborCost || 0;
    const totalFixed = salaryCost + depreciationCost + extraLabor;

    const html = `
        <div class="cost-item"><span>çµ¦æ–™(æ©Ÿæ¢°Ã—${unitCost})</span><span>Â¥${machineCost}</span></div>
        <div class="cost-item"><span>çµ¦æ–™(W${effectiveWorkers}Ã—${unitCost})</span><span>Â¥${workerCost}</span></div>
        <div class="cost-item"><span>çµ¦æ–™(S${effectiveSalesmen}Ã—${unitCost})</span><span>Â¥${salesmenCost}</span></div>
        <div class="cost-item"><span>æœŸä¸­æœ€å¤§(${maxPersonnel}Ã—${halfCost})</span><span>Â¥${maxPersonnelCost}</span></div>
        <div class="cost-item"><span>æ¸›ä¾¡å„Ÿå´</span><span>Â¥${depreciationCost}</span></div>
        ${extraLabor > 0 ? `<div class="cost-item"><span>ãã®ä»–äººä»¶è²»</span><span>Â¥${extraLabor}</span></div>` : ''}
        <div class="cost-item cost-total"><span>Fåˆè¨ˆ</span><span>Â¥${totalFixed}</span></div>
    `;
    document.getElementById('fixedCostBreakdown').innerHTML = html;
}

// ä»–ç¤¾ä¸€è¦§ã‚’æç”»ï¼ˆå¸‚å ´ç›¤ã®å‘¨å›²ã«é…ç½®ï¼‰- ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¨åŒã˜ãƒ•ãƒ«ä¼šç¤¾ç›¤è¡¨ç¤º
function renderOtherCompanies() {
    const others = gameState.companies.slice(1);

    // ä»–ç¤¾ä¼šç¤¾ç›¤ã®HTMLç”Ÿæˆé–¢æ•°ï¼ˆãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¨åŒã˜å½¢å¼ï¼‰
    function createCompanyBoard(company, idx) {
        const isCurrent = gameState.currentPlayerIndex === idx + 1;

        // ææ–™ãƒ–ãƒ­ãƒƒã‚¯
        const materialsHtml = Array(company.materials).fill('<div class="inv-block material"></div>').join('');
        // ä»•æ›å“ãƒ–ãƒ­ãƒƒã‚¯
        const wipHtml = Array(company.wip).fill('<div class="inv-block wip"></div>').join('');
        // è£½å“ãƒ–ãƒ­ãƒƒã‚¯
        const productsHtml = Array(company.products).fill('<div class="inv-block product"></div>').join('');

        // ãƒ¯ãƒ¼ã‚«ãƒ¼
        const workersHtml = Array(company.workers).fill('<div class="person-dot worker">W</div>').join('');
        // æ©Ÿæ¢°
        const machinesHtml = company.machines.map(m =>
            `<div class="machine-dot ${m.type === 'large' ? 'large' : ''}">${m.type === 'large' ? 'å¤§' : 'å°'}${m.attachments > 0 ? '+' : ''}</div>`
        ).join('');
        // ã‚»ãƒ¼ãƒ«ã‚¹ãƒãƒ³
        const salesmenHtml = Array(company.salesmen).fill('<div class="person-dot salesman">S</div>').join('');

        // ãƒãƒƒãƒ—
        const researchHtml = Array(company.chips.research || 0).fill('<div class="chip research"></div>').join('');
        const educationHtml = Array(company.chips.education || 0).fill('<div class="chip education"></div>').join('');
        const advertisingHtml = Array(company.chips.advertising || 0).fill('<div class="chip advertising"></div>').join('');
        const computerHtml = Array(company.chips.computer || 0).fill('<div class="chip computer"></div>').join('');
        const insuranceHtml = Array(company.chips.insurance || 0).fill('<div class="chip insurance"></div>').join('');

        return `
            <div class="other-company-board ${isCurrent ? 'current-turn' : ''}">
                <div class="board-title-mini">
                    ${company.name}
                    <span style="color: #4ade80;">Â¥${company.cash}</span>
                    <span style="background: ${(company.currentRow || 1) >= gameState.maxRows - 5 ? '#ef4444' : '#3b82f6'}; color: white; padding: 1px 4px; border-radius: 3px; font-size: 9px; margin-left: 4px;">
                        ${company.currentRow || 1}/${gameState.maxRows}
                    </span>
                </div>

                <!-- ç”Ÿç”£ãƒ•ãƒ­ãƒ¼ -->
                <div class="production-flow-mini">
                    <div class="flow-box-mini">
                        <div class="flow-box-title-mini">ææ–™</div>
                        <div class="flow-box-content-mini">${materialsHtml || '-'}</div>
                    </div>
                    <div class="flow-box-mini factory">
                        <div class="flow-box-title-mini">ä»•æ›</div>
                        <div class="flow-box-content-mini">${wipHtml || '-'}</div>
                    </div>
                    <div class="flow-box-mini">
                        <div class="flow-box-title-mini">è£½å“</div>
                        <div class="flow-box-content-mini">${productsHtml || '-'}</div>
                    </div>
                </div>

                <!-- äººå“¡ãƒ»æ©Ÿæ¢° -->
                <div class="personnel-row-mini">
                    <div class="personnel-box-mini">
                        <div class="personnel-box-title-mini">W</div>
                        <div class="personnel-dots-mini">${workersHtml || '-'}</div>
                    </div>
                    <div class="personnel-box-mini">
                        <div class="personnel-box-title-mini">æ©Ÿ</div>
                        <div class="personnel-dots-mini">${machinesHtml || '-'}</div>
                    </div>
                    <div class="personnel-box-mini">
                        <div class="personnel-box-title-mini">S</div>
                        <div class="personnel-dots-mini">${salesmenHtml || '-'}</div>
                    </div>
                </div>

                <!-- ãƒãƒƒãƒ— -->
                <div class="chips-row-mini">
                    <div class="chip-box-mini" title="ç ”ç©¶">${researchHtml || '-'}</div>
                    <div class="chip-box-mini" title="æ•™è‚²">${educationHtml || '-'}</div>
                    <div class="chip-box-mini" title="åºƒå‘Š">${advertisingHtml || '-'}</div>
                    <div class="chip-box-mini" title="PC">${computerHtml || '-'}</div>
                    <div class="chip-box-mini" title="ä¿é™º">${insuranceHtml || '-'}</div>
                </div>
            </div>
        `;
    }

    // 5ç¤¾ã‚’ä¸Š2ãƒ»å·¦1ãƒ»å³2ã«é…ç½®
    let topHtml = '';
    let leftHtml = '';
    let rightHtml = '';

    others.forEach((company, idx) => {
        const board = createCompanyBoard(company, idx);
        if (idx < 2) {
            topHtml += board;  // Aç¤¾ã€Bç¤¾
        } else if (idx === 2) {
            leftHtml += board;  // Cç¤¾
        } else {
            rightHtml += board;  // Dç¤¾ã€Eç¤¾
        }
    });

    document.getElementById('otherCompaniesTop').innerHTML = topHtml;
    document.getElementById('otherCompaniesLeft').innerHTML = leftHtml;
    document.getElementById('otherCompaniesRight').innerHTML = rightHtml;
}

// ============================================
// ãƒˆãƒ¼ã‚¹ãƒˆé€šçŸ¥ã‚·ã‚¹ãƒ†ãƒ 
// ============================================
function showToast(message, type = 'info', duration = 3000) {
    const container = document.getElementById('toastContainer');
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;

    const icons = {
        info: 'â„¹ï¸',
        success: 'âœ…',
        warning: 'âš ï¸',
        danger: 'âŒ'
    };

    const titles = {
        info: 'ãŠçŸ¥ã‚‰ã›',
        success: 'æˆåŠŸ',
        warning: 'æ³¨æ„',
        danger: 'è­¦å‘Š'
    };

    toast.innerHTML = `
        <button class="toast-close" onclick="this.parentElement.remove()">Ã—</button>
        <div class="toast-header">
            <span class="toast-icon">${icons[type] || icons.info}</span>
            <span class="toast-title">${titles[type] || titles.info}</span>
        </div>
        <div class="toast-body">${message}</div>
    `;

    container.appendChild(toast);

    // è‡ªå‹•å‰Šé™¤
    setTimeout(() => {
        toast.classList.add('hiding');
        setTimeout(() => toast.remove(), 300);
    }, duration);

    return toast;
}

// Modal functions
function showModal(title, content) {
    const modalHtml = `
        <div class="modal active">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title">${title}</h3>
                    <button class="close-btn" onclick="closeModal(true)">âœ• é–‰ã˜ã‚‹</button>
                </div>
                <div class="modal-body">
                    ${content}
                </div>
            </div>
        </div>
    `;
    document.getElementById('modalContainer').innerHTML = modalHtml;
}

// ä¿é™ºå†åŠ å…¥ãƒ¢ãƒ¼ãƒ€ãƒ«
function showInsuranceRepurchaseModal(disasterType, lostItems, compensation, netLoss) {
    const company = gameState.companies[0];
    const canAfford = company.cash >= 5;

    const itemLabel = disasterType === 'å€‰åº«ç«ç½' ? 'ææ–™' : 'å•†å“';
    const content = `
        <div style="padding: 15px; text-align: center;">
            <div style="background: linear-gradient(135deg, #dc2626 0%, #ef4444 100%); border-radius: 12px; padding: 20px; margin-bottom: 15px; color: white;">
                <div style="font-size: 24px; margin-bottom: 10px;">âš ï¸ ${disasterType}ç™ºç”Ÿï¼</div>
                <div style="font-size: 14px;">
                    <div>${itemLabel} ${lostItems}å€‹ã‚’ã‚¹ãƒˆãƒƒã‚«ãƒ¼ã¸</div>
                    <div>ä¿é™ºé‡‘ Â¥${compensation} ã‚’å—ã‘å–ã‚Šã¾ã—ãŸ</div>
                    <div>ç‰¹åˆ¥æå¤± Â¥${netLoss}</div>
                </div>
            </div>

            <div style="background: #fef3c7; border-radius: 8px; padding: 15px; margin-bottom: 15px;">
                <div style="font-weight: bold; color: #92400e; margin-bottom: 10px;">
                    ä¿é™ºãƒãƒƒãƒ—ã‚’æ¶ˆè²»ã—ã¾ã—ãŸ
                </div>
                <div style="font-size: 14px; color: #78350f;">
                    å†åŠ å…¥: Â¥5ï¼ˆç¾åœ¨ã®ç¾é‡‘: Â¥${company.cash}ï¼‰
                </div>
            </div>

            <div style="display: flex; gap: 10px; justify-content: center;">
                ${canAfford ? `
                    <button class="action-btn primary" onclick="repurchaseInsurance()" style="flex: 1;">
                        å†åŠ å…¥ã™ã‚‹ï¼ˆÂ¥5ï¼‰
                    </button>
                ` : ''}
                <button class="action-btn secondary" onclick="closeModal(); updateDisplay();" style="flex: 1;">
                    ${canAfford ? 'å†åŠ å…¥ã—ãªã„' : 'é–‰ã˜ã‚‹'}
                </button>
            </div>
        </div>
    `;

    showModal('ä¿é™ºä½¿ç”¨', content);
}

// ä¿é™ºå†åŠ å…¥å‡¦ç†
function repurchaseInsurance() {
    const company = gameState.companies[0];
    if (company.cash >= 5) {
        company.cash -= 5;
        company.chips.insurance = 1;
        alert('ä¿é™ºã«å†åŠ å…¥ã—ã¾ã—ãŸï¼ˆÂ¥5ï¼‰');
    } else {
        alert('è³‡é‡‘ãŒä¸è¶³ã—ã¦ã„ã¾ã™');
    }
    closeModal();
    updateDisplay();
}

// å›ºå®šè²»å†…è¨³ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
function showFixedCostModal() {
    const company = gameState.companies[0];
    const period = gameState.currentPeriod;
    const baseCost = {2: 22, 3: 24, 4: 26, 5: 28};
    let unitCost = baseCost[period] || 22;

    if (period >= 3 && gameState.wageMultiplier > 1) {
        unitCost = Math.round(baseCost[period] * gameState.wageMultiplier);
    }

    const halfCost = Math.round(unitCost / 2);
    const machineCount = company.machines.length;
    const effectiveWorkers = company.workers + (company.retiredWorkers || 0) * 0.5;
    const effectiveSalesmen = company.salesmen + (company.retiredSalesmen || 0) * 0.5;
    const maxPersonnel = company.maxPersonnel || (company.workers + company.salesmen);

    const machineCost = machineCount * unitCost;
    const workerCost = Math.round(effectiveWorkers * unitCost);
    const salesmenCost = Math.round(effectiveSalesmen * unitCost);
    const maxPersonnelCost = maxPersonnel * halfCost;
    const salaryCost = machineCost + workerCost + salesmenCost + maxPersonnelCost;

    // æ¸›ä¾¡å„Ÿå´
    let depreciationCost = 0;
    company.machines.forEach(m => {
        if (period === 2) {
            depreciationCost += m.type === 'large' ? 20 : 10;
        } else {
            if (m.type === 'large') depreciationCost += 40;
            else depreciationCost += m.attachments > 0 ? 26 : 20;
        }
    });

    // æˆ¦ç•¥ãƒãƒƒãƒ—è²»ç”¨
    const carriedOver = company.carriedOverChips || {research: 0, education: 0, advertising: 0};
    let chipCost = 0;
    let chipDetails = [];

    if (period === 2) {
        const researchCost = (company.chips.research || 0) * 20;
        const educationCost = (company.chips.education || 0) * 20;
        const advertisingCost = (company.chips.advertising || 0) * 20;
        chipCost = researchCost + educationCost + advertisingCost;
        if (researchCost > 0) chipDetails.push(`ç ”ç©¶ ${company.chips.research}æšÃ—Â¥20 = Â¥${researchCost}`);
        if (educationCost > 0) chipDetails.push(`æ•™è‚² ${company.chips.education}æšÃ—Â¥20 = Â¥${educationCost}`);
        if (advertisingCost > 0) chipDetails.push(`åºƒå‘Š ${company.chips.advertising}æšÃ—Â¥20 = Â¥${advertisingCost}`);
    } else {
        // ç¹°ã‚Šè¶Šã—åˆ†ï¼ˆ20å††ï¼‰
        const carryResearch = (carriedOver.research || 0) * 20;
        const carryEducation = (carriedOver.education || 0) * 20;
        const carryAdvertising = (carriedOver.advertising || 0) * 20;
        // ç‰¹æ€¥åˆ†ï¼ˆ40å††ï¼‰
        const urgentResearch = Math.max(0, (company.chips.research || 0) - (carriedOver.research || 0)) * 40;
        const urgentEducation = Math.max(0, (company.chips.education || 0) - (carriedOver.education || 0)) * 40;
        const urgentAdvertising = Math.max(0, (company.chips.advertising || 0) - (carriedOver.advertising || 0)) * 40;
        // æ¬¡æœŸç¹°ã‚Šè¶Šã—åˆ†ï¼ˆ20å††ï¼‰
        const nextResearch = (company.nextPeriodChips?.research || 0) * 20;
        const nextEducation = (company.nextPeriodChips?.education || 0) * 20;
        const nextAdvertising = (company.nextPeriodChips?.advertising || 0) * 20;

        chipCost = carryResearch + carryEducation + carryAdvertising +
                   urgentResearch + urgentEducation + urgentAdvertising +
                   nextResearch + nextEducation + nextAdvertising;

        if (carriedOver.research > 0) chipDetails.push(`ç ”ç©¶(ç¹°è¶Š) ${carriedOver.research}æšÃ—Â¥20 = Â¥${carryResearch}`);
        if (urgentResearch > 0) chipDetails.push(`ç ”ç©¶(ç‰¹æ€¥) ${(company.chips.research - carriedOver.research)}æšÃ—Â¥40 = Â¥${urgentResearch}`);
        if (carriedOver.education > 0) chipDetails.push(`æ•™è‚²(ç¹°è¶Š) ${carriedOver.education}æšÃ—Â¥20 = Â¥${carryEducation}`);
        if (urgentEducation > 0) chipDetails.push(`æ•™è‚²(ç‰¹æ€¥) ${(company.chips.education - carriedOver.education)}æšÃ—Â¥40 = Â¥${urgentEducation}`);
        if (carriedOver.advertising > 0) chipDetails.push(`åºƒå‘Š(ç¹°è¶Š) ${carriedOver.advertising}æšÃ—Â¥20 = Â¥${carryAdvertising}`);
        if (urgentAdvertising > 0) chipDetails.push(`åºƒå‘Š(ç‰¹æ€¥) ${(company.chips.advertising - carriedOver.advertising)}æšÃ—Â¥40 = Â¥${urgentAdvertising}`);
        if (nextResearch > 0) chipDetails.push(`ç ”ç©¶(æ¬¡æœŸ) ${company.nextPeriodChips.research}æšÃ—Â¥20 = Â¥${nextResearch}`);
        if (nextEducation > 0) chipDetails.push(`æ•™è‚²(æ¬¡æœŸ) ${company.nextPeriodChips.education}æšÃ—Â¥20 = Â¥${nextEducation}`);
        if (nextAdvertising > 0) chipDetails.push(`åºƒå‘Š(æ¬¡æœŸ) ${company.nextPeriodChips.advertising}æšÃ—Â¥20 = Â¥${nextAdvertising}`);
    }

    // ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ãƒ»ä¿é™º
    const computerCost = (company.chips.computer || 0) * 20;
    const insuranceCost = (company.chips.insurance || 0) * 5;

    // é‡‘åˆ©
    const longInterest = Math.round((company.loans || 0) * 0.10);
    const shortInterest = Math.round((company.shortLoans || 0) * 0.20);

    // ãã®ä»–äººä»¶è²»ï¼ˆæ¡ç”¨è²»ã€é€€è·è²»ã€ãƒªã‚¹ã‚¯ã‚«ãƒ¼ãƒ‰ãªã©ï¼‰
    const extraLabor = company.extraLaborCost || 0;

    // åˆè¨ˆ
    const totalFixed = salaryCost + depreciationCost + chipCost + computerCost + insuranceCost +
                       longInterest + shortInterest + extraLabor;

    const content = `
        <div class="breakdown-list" style="max-height: 400px; overflow-y: auto;">
            <div style="font-weight: bold; color: #1e40af; margin-bottom: 12px; font-size: 14px;">çµ¦æ–™ï¼ˆå˜ä¾¡: Â¥${unitCost}ï¼‰</div>
            <div class="breakdown-item">
                <span class="breakdown-item-label">æ©Ÿæ¢° ${machineCount}å° Ã— Â¥${unitCost}</span>
                <span class="breakdown-item-value">Â¥${machineCost}</span>
            </div>
            <div class="breakdown-item">
                <span class="breakdown-item-label">ãƒ¯ãƒ¼ã‚«ãƒ¼ ${effectiveWorkers}äºº Ã— Â¥${unitCost}</span>
                <span class="breakdown-item-value">Â¥${workerCost}</span>
            </div>
            <div class="breakdown-item">
                <span class="breakdown-item-label">ã‚»ãƒ¼ãƒ«ã‚¹ ${effectiveSalesmen}äºº Ã— Â¥${unitCost}</span>
                <span class="breakdown-item-value">Â¥${salesmenCost}</span>
            </div>
            <div class="breakdown-item">
                <span class="breakdown-item-label">æœŸä¸­æœ€å¤§ ${maxPersonnel}äºº Ã— Â¥${halfCost}</span>
                <span class="breakdown-item-value">Â¥${maxPersonnelCost}</span>
            </div>
            <div style="font-weight: bold; color: #1e40af; margin: 12px 0; font-size: 14px;">æ¸›ä¾¡å„Ÿå´ãƒ»ãã®ä»–</div>
            <div class="breakdown-item">
                <span class="breakdown-item-label">æ¸›ä¾¡å„Ÿå´</span>
                <span class="breakdown-item-value">Â¥${depreciationCost}</span>
            </div>
            ${chipCost > 0 ? `
            <div style="font-weight: bold; color: #059669; margin: 12px 0; font-size: 12px;">æˆ¦ç•¥ãƒãƒƒãƒ—</div>
            ${chipDetails.map(d => `<div class="breakdown-item" style="font-size: 11px;"><span>${d}</span></div>`).join('')}
            <div class="breakdown-item">
                <span class="breakdown-item-label">ãƒãƒƒãƒ—åˆè¨ˆ</span>
                <span class="breakdown-item-value">Â¥${chipCost}</span>
            </div>
            ` : ''}
            ${computerCost > 0 ? `
            <div class="breakdown-item">
                <span class="breakdown-item-label">ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ ${company.chips.computer}æšÃ—Â¥20</span>
                <span class="breakdown-item-value">Â¥${computerCost}</span>
            </div>
            ` : ''}
            ${insuranceCost > 0 ? `
            <div class="breakdown-item">
                <span class="breakdown-item-label">ä¿é™º ${company.chips.insurance}æšÃ—Â¥5</span>
                <span class="breakdown-item-value">Â¥${insuranceCost}</span>
            </div>
            ` : ''}
            ${longInterest > 0 ? `
            <div class="breakdown-item">
                <span class="breakdown-item-label">é•·æœŸå€Ÿå…¥é‡‘åˆ© Â¥${company.loans}Ã—10%</span>
                <span class="breakdown-item-value">Â¥${longInterest}</span>
            </div>
            ` : ''}
            ${shortInterest > 0 ? `
            <div class="breakdown-item">
                <span class="breakdown-item-label">çŸ­æœŸå€Ÿå…¥é‡‘åˆ© Â¥${company.shortLoans}Ã—20%</span>
                <span class="breakdown-item-value">Â¥${shortInterest}</span>
            </div>
            ` : ''}
            ${extraLabor > 0 ? `
            <div class="breakdown-item">
                <span class="breakdown-item-label">ãã®ä»–ï¼ˆæ¡ç”¨è²»ãƒ»ãƒªã‚¹ã‚¯ç­‰ï¼‰</span>
                <span class="breakdown-item-value">Â¥${extraLabor}</span>
            </div>
            ` : ''}
            <div class="breakdown-total">
                <span>Fåˆè¨ˆ</span>
                <span>Â¥${totalFixed}</span>
            </div>
        </div>
    `;

    showModal('Fï¼ˆå›ºå®šè²»ï¼‰å†…è¨³', content);
}

function closeModal(returnToDecision = false) {
    document.getElementById('modalContainer').innerHTML = '';
    // æ„æ€æ±ºå®šã‚«ãƒ¼ãƒ‰ã‹ã‚‰æ¥ãŸå ´åˆã¯æ„æ€æ±ºå®šã‚«ãƒ¼ãƒ‰ã«æˆ»ã‚‹
    if (returnToDecision && gameState.currentPlayerIndex === 0) {
        showDecisionCard();
    }
}

// Buy materials modal - è³¼å…¥ãƒ¢ãƒ¼ãƒ‰ã«å…¥ã‚‹
function showBuyMaterialsModal() {
    enterBuyMode();
}

// Update material purchase cost (for multiple markets - not used now)
function updateMaterialCost() {
    let totalCost = 0;
    let rowsUsed = 0;
    
    gameState.markets.forEach((market, i) => {
        const qty = parseInt(document.getElementById(`market_${i}`).value || 0);
        if (qty > 0) {
            totalCost += market.buyPrice * qty;
            rowsUsed++;
        }
    });
    
    document.getElementById('totalCost').textContent = `Â¥${totalCost}`;
    document.getElementById('rowsUsed').textContent = rowsUsed;
}

// Buy materials from multiple markets
function buyMaterialsFromMultiple() {
    const company = gameState.companies[0];
    let totalCost = 0;
    let totalQty = 0;
    let rowsUsed = 0;
    let purchases = [];
    
    // å„å¸‚å ´ã‹ã‚‰ã®è³¼å…¥ã‚’åé›†
    gameState.markets.forEach((market, i) => {
        const qty = parseInt(document.getElementById(`market_${i}`).value || 0);
        if (qty > 0) {
            totalCost += market.buyPrice * qty;
            totalQty += qty;
            rowsUsed++;
            purchases.push({market: market, qty: qty, cost: market.buyPrice * qty});
        }
    });
    
    if (rowsUsed === 0) {
        showToast('è³¼å…¥ã™ã‚‹å¸‚å ´ã‚’é¸æŠã—ã¦ãã ã•ã„', 'warning', 3000);
        return;
    }
    
    // å€‰åº«å®¹é‡ãƒã‚§ãƒƒã‚¯
    const newMaterialCount = company.materials + totalQty;
    const maxMaterialCapacity = getMaterialCapacity(company);
    if (newMaterialCount > maxMaterialCapacity) {
        if (company.warehouses === 0) {
            alert(`ææ–™ç½®å ´ã«10å€‹ä»¥ä¸Šç½®ãã«ã¯ç„¡ç½å®³å€‰åº«ãŒå¿…è¦ã§ã™ã€‚\nç¾åœ¨: ${company.materials}å€‹ã€è³¼å…¥å¾Œ: ${newMaterialCount}å€‹`);
        } else {
            alert(`ææ–™ç½®å ´ã®å®¹é‡ï¼ˆ${maxMaterialCapacity}å€‹ï¼‰ã‚’è¶…ãˆã¾ã™ã€‚\nç¾åœ¨: ${company.materials}å€‹ã€è³¼å…¥å¾Œ: ${newMaterialCount}å€‹`);
        }
        return;
    }
    
    // è¡Œæ•°ãƒã‚§ãƒƒã‚¯
    if (gameState.currentRow + rowsUsed - 1 > gameState.maxRows) {
        alert(`è¡Œæ•°ãŒä¸è¶³ã—ã¦ã„ã¾ã™ï¼ˆå¿…è¦: ${rowsUsed}è¡Œã€æ®‹ã‚Š: ${gameState.maxRows - gameState.currentRow + 1}è¡Œï¼‰`);
        return;
    }
    
    // ç¾é‡‘ãƒã‚§ãƒƒã‚¯ã¨çŸ­æœŸå€Ÿå…¥
    if (company.cash < totalCost) {
        const needed = Math.ceil((totalCost - company.cash) / 0.8 / 50) * 50;
        company.shortLoans += needed;
        company.cash += needed * 0.8;  // çŸ­æœŸå€Ÿå…¥: å€Ÿå…¥æ™‚20%é‡‘åˆ©æ§é™¤
        showToast(`ç¾é‡‘ä¸è¶³ã®ãŸã‚çŸ­æœŸå€Ÿå…¥Â¥${needed}ã‚’å®Ÿè¡Œã—ã¾ã—ãŸ`, 'warning', 4000);
    }
    
    // è³¼å…¥å®Ÿè¡Œ
    company.cash -= totalCost;
    company.materials += totalQty;
    company.totalMaterialCost += totalCost;

    // å„å¸‚å ´ã®åœ¨åº«ã‚’æ¸›ã‚‰ã™
    purchases.forEach(p => {
        const marketIndex = gameState.markets.indexOf(p.market);
        gameState.markets[marketIndex].currentStock -= p.qty;
    });

    // è¡Œå‹•ãƒ­ã‚°è¨˜éŒ²ï¼ˆè¤‡æ•°å¸‚å ´ã‹ã‚‰ã®è³¼å…¥ï¼‰
    const purchaseDetails = purchases.map(p => `${p.market.name}Â¥${p.market.buyPrice}Ã—${p.qty}`).join(', ');
    logAction(0, 'ææ–™è³¼å…¥', purchaseDetails, -totalCost, true);

    // ä½¿ç”¨è¡Œæ•°åˆ†é€²ã‚ã‚‹
    gameState.currentRow += rowsUsed - 1; // -1ã¯é€šå¸¸ã®endTurnã§1è¡Œé€²ã‚€ãŸã‚

    closeModal();
    updateDisplay();

    // è³¼å…¥çµæœã‚’è¡¨ç¤º
    let message = `ææ–™${totalQty}å€‹ã‚’Â¥${totalCost}ã§è³¼å…¥ã—ã¾ã—ãŸ\n`;
    purchases.forEach(p => {
        message += `${p.market.name}: ${p.qty}å€‹ (Â¥${p.cost})\n`;
    });
    message += `${rowsUsed}è¡Œä½¿ç”¨ã—ã¾ã—ãŸ`;
    alert(message);

    endTurn();
}

// Buy materials (single market - legacy support)
function buyMaterials() {
    const company = gameState.companies[0];
    const marketIndex = parseInt(document.getElementById('marketSelect').value);
    const quantity = parseInt(document.getElementById('quantity').value);
    const market = gameState.markets[marketIndex];
    
    // Check warehouse capacity
    const newMaterialCount = company.materials + quantity;
    const maxMaterialCapacity = getMaterialCapacity(company);
    if (newMaterialCount > maxMaterialCapacity) {
        if (company.warehouses === 0) {
            alert(`ææ–™ç½®å ´ã«10å€‹ä»¥ä¸Šç½®ãã«ã¯ç„¡ç½å®³å€‰åº«ãŒå¿…è¦ã§ã™ã€‚\nç¾åœ¨: ${company.materials}å€‹ã€è³¼å…¥å¾Œ: ${newMaterialCount}å€‹`);
        } else {
            alert(`ææ–™ç½®å ´ã®å®¹é‡ï¼ˆ${maxMaterialCapacity}å€‹ï¼‰ã‚’è¶…ãˆã¾ã™ã€‚\nç¾åœ¨: ${company.materials}å€‹ã€è³¼å…¥å¾Œ: ${newMaterialCount}å€‹`);
        }
        return;
    }
    
    const cost = market.buyPrice * quantity;
    
    if (company.cash < cost) {
        // çŸ­æœŸå€Ÿå…¥
        const needed = Math.ceil((cost - company.cash) / 0.8 / 50) * 50;
        company.shortLoans += needed;
        company.cash += needed * 0.8;  // çŸ­æœŸå€Ÿå…¥: å€Ÿå…¥æ™‚20%é‡‘åˆ©æ§é™¤
        showToast(`ç¾é‡‘ä¸è¶³ã®ãŸã‚çŸ­æœŸå€Ÿå…¥Â¥${needed}ã‚’å®Ÿè¡Œã—ã¾ã—ãŸ`, 'warning', 4000);
    }
    
    if (quantity > market.currentStock) {
        showToast('åœ¨åº«ãŒä¸è¶³ã—ã¦ã„ã¾ã™ï¼', 'danger', 3000);
        return;
    }
    
    company.cash -= cost;
    company.materials += quantity;
    company.totalMaterialCost += cost;
    market.currentStock -= quantity;

    // è¡Œå‹•ãƒ­ã‚°è¨˜éŒ²
    logAction(0, 'ææ–™è³¼å…¥', `${market.name}ã‹ã‚‰Â¥${market.buyPrice}Ã—${quantity}å€‹`, -cost, true);

    closeModal();
    updateDisplay();
    showToast(`${market.name}ã‹ã‚‰ææ–™${quantity}å€‹ã‚’Â¥${cost}ã§è³¼å…¥ã—ã¾ã—ãŸ`, 'success', 3000);
    endTurn();
}

// Production modal
function showProductionModal() {
    const company = gameState.companies[0];

    // åŠ´ç½ç™ºç”Ÿãƒã‚§ãƒƒã‚¯ï¼ˆãƒ•ãƒ©ã‚°ã¯ã‚¿ãƒ¼ãƒ³çµ‚äº†æ™‚ã«ãƒªã‚»ãƒƒãƒˆï¼‰
    if (company.cannotProduce) {
        showToast('åŠ´ç½ç™ºç”Ÿä¸­ã®ãŸã‚ç”Ÿç”£ã§ãã¾ã›ã‚“ï¼\nï¼ˆææ–™è³¼å…¥ã€å•†å“è²©å£²ãƒ»å…¥æœ­ã€DO NOTHINGã¯å¯èƒ½ï¼‰', 'danger', 4000);
        showDecisionCard();
        return;
    }

    const mfgCapacity = getManufacturingCapacity(company);

    const content = `
        <div style="background: #fef3c7; border-radius: 8px; padding: 10px; margin-bottom: 15px; text-align: center;">
            <div style="font-weight: bold; color: #92400e;">ğŸ’° æŒã¡é‡‘: Â¥${company.cash}</div>
        </div>
        <div style="background: linear-gradient(180deg, #e0f2fe 0%, #bae6fd 100%); border-radius: 12px; padding: 15px; margin-bottom: 15px; border: 2px solid #0284c7;">
            <div style="text-align: center; margin-bottom: 10px;">
                <span style="font-size: 12px; color: #0369a1;">è£½é€ èƒ½åŠ›</span>
                <span style="font-size: 28px; font-weight: bold; color: #0c4a6e; display: block;">${mfgCapacity}å€‹</span>
            </div>
            <div style="display: flex; justify-content: space-around; text-align: center;">
                <div style="background: #fff; border-radius: 8px; padding: 8px 15px; border: 2px solid #9b59b6;">
                    <div style="font-size: 10px; color: #7c3aed;">ææ–™</div>
                    <div style="font-size: 20px; font-weight: bold; color: #6d28d9;">${company.materials}</div>
                </div>
                <div style="font-size: 24px; color: #0284c7; display: flex; align-items: center;">â†’</div>
                <div style="background: #fff; border-radius: 8px; padding: 8px 15px; border: 2px dashed #a855f7;">
                    <div style="font-size: 10px; color: #a855f7;">ä»•æ›å“</div>
                    <div style="font-size: 20px; font-weight: bold; color: #9333ea;">${company.wip}</div>
                </div>
                <div style="font-size: 24px; color: #0284c7; display: flex; align-items: center;">â†’</div>
                <div style="background: #fff; border-radius: 8px; padding: 8px 15px; border: 2px solid #6366f1;">
                    <div style="font-size: 10px; color: #4f46e5;">è£½å“</div>
                    <div style="font-size: 20px; font-weight: bold; color: #4338ca;">${company.products}</div>
                </div>
            </div>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 15px;">
            <div style="background: linear-gradient(180deg, #faf5ff 0%, #f3e8ff 100%); border-radius: 10px; padding: 12px; border: 2px solid #9b59b6;">
                <div style="font-size: 12px; font-weight: bold; color: #7c3aed; margin-bottom: 8px; text-align: center;">ğŸ”§ ææ–™â†’ä»•æ›å“</div>
                <div style="font-size: 10px; color: #6b7280; text-align: center; margin-bottom: 5px;">ï¼ˆÂ¥1/å€‹ï¼‰</div>
                <select id="matToWip" class="form-control" style="font-size: 18px; text-align: center; font-weight: bold;">
                    ${Array(Math.min(mfgCapacity, company.materials) + 1).fill(0).map((_, i) =>
                        `<option value="${i}" ${i === Math.min(mfgCapacity, company.materials) ? 'selected' : ''}>${i}å€‹</option>`
                    ).join('')}
                </select>
            </div>
            <div style="background: linear-gradient(180deg, #eef2ff 0%, #e0e7ff 100%); border-radius: 10px; padding: 12px; border: 2px solid #6366f1;">
                <div style="font-size: 12px; font-weight: bold; color: #4f46e5; margin-bottom: 8px; text-align: center;">ğŸ“¦ ä»•æ›å“â†’è£½å“</div>
                <div style="font-size: 10px; color: #6b7280; text-align: center; margin-bottom: 5px;">ï¼ˆÂ¥1/å€‹ï¼‰</div>
                <select id="wipToProd" class="form-control" style="font-size: 18px; text-align: center; font-weight: bold;">
                    ${Array(Math.min(mfgCapacity, company.wip) + 1).fill(0).map((_, i) =>
                        `<option value="${i}" ${i === Math.min(mfgCapacity, company.wip) ? 'selected' : ''}>${i}å€‹</option>`
                    ).join('')}
                </select>
            </div>
        </div>

        <div style="background: #f1f5f9; border-radius: 10px; padding: 12px; text-align: center; margin-bottom: 15px;">
            <span style="font-size: 14px; color: #475569;">ç”Ÿç”£ã‚³ã‚¹ãƒˆ: </span>
            <span id="totalCost" style="font-size: 24px; font-weight: bold; color: #dc2626;">Â¥0</span>
        </div>

        <button class="submit-btn" onclick="produce()" style="width: 100%;">
            ğŸ­ ç”Ÿç”£å®Ÿè¡Œ
        </button>
    `;

    showModal('ğŸ­ å®Œæˆãƒ»æŠ•å…¥', content);

    // Update cost display
    const updateCost = () => {
        const matToWip = parseInt(document.getElementById('matToWip').value) || 0;
        const wipToProd = parseInt(document.getElementById('wipToProd').value) || 0;
        const cost = matToWip + wipToProd;
        document.getElementById('totalCost').textContent = `Â¥${cost}`;
    };

    // Set initial cost display
    updateCost();

    document.getElementById('matToWip').addEventListener('change', updateCost);
    document.getElementById('wipToProd').addEventListener('change', updateCost);
    updateCost();
}

// Production
function produce() {
    const company = gameState.companies[0];
    const matToWip = parseInt(document.getElementById('matToWip').value);
    const wipToProd = parseInt(document.getElementById('wipToProd').value);
    
    // Check capacity limits
    const newWip = company.wip + matToWip - wipToProd;
    const newProducts = company.products + wipToProd;
    
    if (newWip > 10) {
        alert('ä»•æ›å“ç½®å ´ã®å®¹é‡ä¸è¶³ã§ã™ã€‚ä»•æ›å“ã¯10å€‹ã¾ã§ã§ã™ã€‚');
        return;
    }
    
    const maxProductCapacity = getProductCapacity(company);
    if (newProducts > maxProductCapacity) {
        if (company.warehouses === 0 || company.warehouseLocation === 'materials') {
            alert(`è£½å“ç½®å ´ã«10å€‹ä»¥ä¸Šç½®ãã«ã¯ç„¡ç½å®³å€‰åº«ãŒå¿…è¦ã§ã™ã€‚\nç¾åœ¨: ${company.products}å€‹ã€ç”Ÿç”£å¾Œ: ${newProducts}å€‹`);
        } else {
            alert(`è£½å“ç½®å ´ã®å®¹é‡ï¼ˆ${maxProductCapacity}å€‹ï¼‰ã‚’è¶…ãˆã¾ã™ã€‚`);
        }
        return;
    }
    
    const cost = matToWip + wipToProd;
    
    if (company.cash < cost) {
        // çŸ­æœŸå€Ÿå…¥
        const needed = Math.ceil((cost - company.cash) / 0.8 / 50) * 50;
        company.shortLoans += needed;
        company.cash += needed * 0.8;  // çŸ­æœŸå€Ÿå…¥: å€Ÿå…¥æ™‚20%é‡‘åˆ©æ§é™¤
        showToast(`ç¾é‡‘ä¸è¶³ã®ãŸã‚çŸ­æœŸå€Ÿå…¥Â¥${needed}ã‚’å®Ÿè¡Œã—ã¾ã—ãŸ`, 'warning', 4000);
    }
    
    company.cash -= cost;
    company.materials -= matToWip;
    company.wip = newWip;
    company.products = newProducts;
    company.totalProductionCost += cost;

    // è¡Œå‹•ãƒ­ã‚°è¨˜éŒ²
    const productionDetails = `æ${matToWip}â†’ä»•æ›, ä»•æ›${wipToProd}â†’è£½å“`;
    logAction(0, 'å®Œæˆãƒ»æŠ•å…¥', productionDetails, -cost, true);

    closeModal();
    updateDisplay();
    showToast(`ææ–™${matToWip}å€‹â†’ä»•æ›å“ã€ä»•æ›å“${wipToProd}å€‹â†’è£½å“ã‚’ç”Ÿç”£ã—ã¾ã—ãŸï¼ˆÂ¥${cost}ï¼‰`, 'success', 3500);
    endTurn();
}

// è²©å£²ãƒ¢ãƒ¼ãƒ‰ã‚’é–‹å§‹
function enterSalesMode() {
    const company = gameState.companies[0];

    if (company.products <= 0) {
        showToast('è£½å“åœ¨åº«ãŒã‚ã‚Šã¾ã›ã‚“', 'danger', 3000);
        return;
    }

    // è²©å£²æ–¹å¼é¸æŠãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
    showSalesTypeModal();
}

// è²©å£²æ–¹å¼é¸æŠãƒ¢ãƒ¼ãƒ€ãƒ«
function showSalesTypeModal() {
    const company = gameState.companies[0];
    const salesCapacity = getSalesCapacity(company);
    const availableMarkets = gameState.markets.filter(m => !m.closed && m.needsBid);
    const canTwoMarkets = availableMarkets.length >= 2 && company.products >= 2;

    const content = `
        <div style="padding: 10px;">
            <div style="background: #fef3c7; border-radius: 8px; padding: 12px; margin-bottom: 15px;">
                <div style="font-weight: bold; color: #92400e;">è£½å“åœ¨åº«: ${company.products}å€‹ / è²©å£²èƒ½åŠ›: ${salesCapacity}</div>
            </div>

            <div style="display: grid; gap: 12px;">
                <button onclick="startSingleMarketSale()" class="submit-btn" style="padding: 15px; font-size: 16px;">
                    <div style="font-weight: bold;">ğŸ“ 1å¸‚å ´ã§è²©å£²</div>
                    <div style="font-size: 12px; opacity: 0.8;">1è¡Œä½¿ç”¨</div>
                </button>

                ${canTwoMarkets ? `
                <button onclick="startTwoMarketSale()" class="submit-btn" style="padding: 15px; font-size: 16px; background: linear-gradient(180deg, #8b5cf6 0%, #7c3aed 100%);">
                    <div style="font-weight: bold;">ğŸ“ğŸ“ 2å¸‚å ´åŒæ™‚è²©å£²</div>
                    <div style="font-size: 12px; opacity: 0.8;">åŒä¾¡æ ¼ãƒ»1è¡Œä½¿ç”¨ï¼ˆä½ã„ä¸Šé™ä¾¡æ ¼é©ç”¨ï¼‰</div>
                </button>

                <button onclick="startSeparateTwoMarketSale()" class="submit-btn" style="padding: 15px; font-size: 16px; background: linear-gradient(180deg, #f59e0b 0%, #d97706 100%);">
                    <div style="font-weight: bold;">ğŸ“+ğŸ“ 2å¸‚å ´åˆ¥ã€…è²©å£²</div>
                    <div style="font-size: 12px; opacity: 0.8;">åˆ¥ä¾¡æ ¼ãƒ»2è¡Œä½¿ç”¨</div>
                </button>
                ` : `
                <div style="background: #f3f4f6; border-radius: 8px; padding: 12px; text-align: center; color: #6b7280;">
                    2å¸‚å ´è²©å£²ã«ã¯å…¥æœ­å¸‚å ´ãŒ2ã¤ä»¥ä¸Šå¿…è¦ã§ã™
                </div>
                `}
            </div>

            <button onclick="closeModal(); showTurnStartOptions();" class="submit-btn" style="margin-top: 15px; background: linear-gradient(180deg, #6b7280 0%, #4b5563 100%);">
                â† æˆ»ã‚‹
            </button>
        </div>
    `;

    showModal('ğŸ’° è²©å£²æ–¹å¼ã‚’é¸æŠ', content);
}

// 1å¸‚å ´è²©å£²ãƒ¢ãƒ¼ãƒ‰é–‹å§‹
function startSingleMarketSale() {
    const company = gameState.companies[0];
    gameState.salesMode = true;
    gameState.buyMode = false;
    gameState.twoMarketMode = false;
    closeModal();
    renderMarketsBoard();

    const instruction = document.createElement('div');
    instruction.className = 'market-instruction';
    instruction.id = 'marketInstruction';
    instruction.innerHTML = `
        <span>ğŸ’° è²©å£²ã—ãŸã„å¸‚å ´ã‚’ã‚¿ãƒƒãƒ—ã—ã¦ãã ã•ã„ï¼ˆåœ¨åº«: ${company.products}å€‹ï¼‰</span>
        <button class="cancel-mode-btn" onclick="cancelMarketMode()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
    `;
    document.body.appendChild(instruction);
}

// 2å¸‚å ´åŒæ™‚è²©å£²ãƒ¢ãƒ¼ãƒ‰é–‹å§‹
function startTwoMarketSale() {
    const company = gameState.companies[0];
    gameState.salesMode = true;
    gameState.buyMode = false;
    gameState.twoMarketMode = 'simultaneous';
    gameState.selectedMarkets = [];
    closeModal();
    renderMarketsBoard();

    const instruction = document.createElement('div');
    instruction.className = 'market-instruction';
    instruction.id = 'marketInstruction';
    instruction.style.background = 'linear-gradient(180deg, #8b5cf6 0%, #7c3aed 100%)';
    instruction.innerHTML = `
        <span>ğŸ“ğŸ“ 2ã¤ã®å¸‚å ´ã‚’é¸æŠã—ã¦ãã ã•ã„ï¼ˆåŒä¾¡æ ¼ãƒ»1è¡Œï¼‰</span>
        <button class="cancel-mode-btn" onclick="cancelMarketMode()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
    `;
    document.body.appendChild(instruction);
}

// 2å¸‚å ´åˆ¥ã€…è²©å£²ãƒ¢ãƒ¼ãƒ‰é–‹å§‹
function startSeparateTwoMarketSale() {
    const company = gameState.companies[0];
    gameState.salesMode = true;
    gameState.buyMode = false;
    gameState.twoMarketMode = 'separate';
    gameState.selectedMarkets = [];
    closeModal();
    renderMarketsBoard();

    const instruction = document.createElement('div');
    instruction.className = 'market-instruction';
    instruction.id = 'marketInstruction';
    instruction.style.background = 'linear-gradient(180deg, #f59e0b 0%, #d97706 100%)';
    instruction.innerHTML = `
        <span>ğŸ“+ğŸ“ 2ã¤ã®å¸‚å ´ã‚’é¸æŠã—ã¦ãã ã•ã„ï¼ˆåˆ¥ä¾¡æ ¼ãƒ»2è¡Œï¼‰</span>
        <button class="cancel-mode-btn" onclick="cancelMarketMode()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
    `;
    document.body.appendChild(instruction);
}

// ææ–™è³¼å…¥ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆè¤‡æ•°å¸‚å ´å¯¾å¿œï¼‰
function showMaterialPurchaseModal() {
    const company = gameState.companies[0];
    const remainingRows = gameState.maxRows - company.currentRow + 1;

    // æœ€ã‚‚è¡Œæ•°ã‚’ä½¿ã£ã¦ã„ã‚‹ä¼šç¤¾ã‚’å–å¾—
    const maxRowCompany = gameState.companies.reduce((max, c) =>
        (c.currentRow || 1) > (max.currentRow || 1) ? c : max
    );
    const isHighestRow = company === maxRowCompany;

    // è³¼å…¥å¯èƒ½ãªå¸‚å ´ã‚’å–å¾—ï¼ˆé–‰é–ã•ã‚Œã¦ã„ãªã„å¸‚å ´ã®ã¿ï¼‰
    const availableMarkets = gameState.markets.filter(m => !m.closed && m.currentStock > 0);

    // 3æœŸä»¥é™ã¯1å¸‚å ´ã‹ã‚‰ã®è³¼å…¥ä¸Šé™ = è£½é€ èƒ½åŠ›
    const mfgCapacity = getManufacturingCapacity(company);
    const isPeriod2 = gameState.currentPeriod === 2;

    let marketOptions = '';
    availableMarkets.forEach((market, i) => {
        const marketIndex = gameState.markets.indexOf(market);
        // 2æœŸ: åˆ¶é™ãªã—ã€3æœŸä»¥é™: è£½é€ èƒ½åŠ›ãŒä¸Šé™
        const maxPerMarket = isPeriod2 ? 99 : mfgCapacity;
        const maxBuy = Math.min(market.currentStock, 10 - company.materials, maxPerMarket);
        marketOptions += `
            <div style="background: #f3f4f6; border-radius: 8px; padding: 10px; margin-bottom: 10px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                    <span style="font-weight: bold;">${market.name}</span>
                    <span style="color: #059669; font-weight: bold;">Â¥${market.buyPrice}/å€‹</span>
                </div>
                <div style="display: flex; align-items: center; gap: 10px;">
                    <span style="font-size: 12px; color: #6b7280;">åœ¨åº«: ${market.currentStock}å€‹</span>
                    <select id="market_${marketIndex}" class="form-control" style="flex: 1;">
                        <option value="0">è³¼å…¥ã—ãªã„</option>
                        ${Array.from({length: maxBuy}, (_, j) => `<option value="${j + 1}">${j + 1}å€‹ (Â¥${market.buyPrice * (j + 1)})</option>`).join('')}
                    </select>
                </div>
            </div>
        `;
    });

    const content = `
        <div style="padding: 10px;">
            <div style="background: #fef3c7; border-radius: 8px; padding: 10px; margin-bottom: 15px;">
                <div style="font-weight: bold; color: #92400e;">ç¾é‡‘: Â¥${company.cash} / ææ–™: ${company.materials}å€‹</div>
                <div style="font-size: 12px; color: #78350f;">æ®‹ã‚Šè¡Œæ•°: ${remainingRows}è¡Œ</div>
                ${!isPeriod2 ? `<div style="font-size: 12px; color: #0369a1;">è£½é€ èƒ½åŠ›: ${mfgCapacity} (1å¸‚å ´ã‚ãŸã‚Š${mfgCapacity}å€‹ã¾ã§)</div>` : ''}
                ${isHighestRow ? `<div style="font-size: 12px; color: #dc2626; margin-top: 5px;">âš ï¸ ã‚ãªãŸã¯è¡Œæ•°ãƒˆãƒƒãƒ—ã§ã™ã€‚2å¸‚å ´è³¼å…¥ã¯æ…é‡ã«ã€‚</div>` : ''}
            </div>
            <div style="font-size: 13px; color: #6b7280; margin-bottom: 10px;">
                è¤‡æ•°å¸‚å ´ã‹ã‚‰è³¼å…¥å¯èƒ½ã§ã™ï¼ˆå¸‚å ´æ•°Ã—1è¡Œä½¿ç”¨ï¼‰
            </div>
            ${marketOptions}
            <button class="submit-btn" onclick="buyMaterialsFromMultiple()">è³¼å…¥å®Ÿè¡Œ</button>
        </div>
    `;

    showModal('ğŸ“¦ ææ–™è³¼å…¥', content);
}

// è³¼å…¥ãƒ¢ãƒ¼ãƒ‰ã‚’é–‹å§‹
function enterBuyMode() {
    gameState.buyMode = true;
    gameState.salesMode = false;
    closeModal();
    renderMarketsBoard();

    const company = gameState.companies[0];

    // ã‚¤ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¡¨ç¤º
    const instruction = document.createElement('div');
    instruction.className = 'market-instruction buy-mode';
    instruction.id = 'marketInstruction';
    instruction.innerHTML = `
        <span>ğŸ“¦ ææ–™ã‚’è³¼å…¥ã™ã‚‹å¸‚å ´ã‚’ã‚¿ãƒƒãƒ—ã—ã¦ãã ã•ã„ï¼ˆç¾é‡‘: Â¥${company.cash}ï¼‰</span>
        <button class="cancel-mode-btn" onclick="cancelMarketMode()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
    `;
    document.body.appendChild(instruction);
}

// å¸‚å ´é¸æŠãƒ¢ãƒ¼ãƒ‰ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«
function cancelMarketMode() {
    gameState.salesMode = false;
    gameState.buyMode = false;
    gameState.twoMarketMode = false;
    gameState.selectedMarkets = [];
    gameState.pendingSeparateBids = null;
    const instruction = document.getElementById('marketInstruction');
    if (instruction) instruction.remove();
    renderMarketsBoard();
    showTurnStartOptions();
}

// å¸‚å ´ã‚¿ã‚¤ãƒ«ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸæ™‚
function onMarketTileClick(marketIndex, action) {
    const market = gameState.markets[marketIndex];
    const company = gameState.companies[0];

    if (action === 'sell') {
        // 2å¸‚å ´åŒæ™‚è²©å£²ãƒ¢ãƒ¼ãƒ‰ã®å ´åˆ
        if (gameState.twoMarketMode === 'simultaneous') {
            if (!gameState.selectedMarkets) gameState.selectedMarkets = [];

            // æ—¢ã«é¸æŠæ¸ˆã¿ãªã‚‰é™¤å¤–
            const existingIndex = gameState.selectedMarkets.indexOf(marketIndex);
            if (existingIndex >= 0) {
                gameState.selectedMarkets.splice(existingIndex, 1);
                updateMarketSelectionInstruction();
                renderMarketsBoard();
                return;
            }

            // é¸æŠè¿½åŠ 
            gameState.selectedMarkets.push(marketIndex);

            if (gameState.selectedMarkets.length === 2) {
                // 2å¸‚å ´é¸æŠå®Œäº†
                const instruction = document.getElementById('marketInstruction');
                if (instruction) instruction.remove();
                gameState.salesMode = false;
                renderMarketsBoard();
                showTwoMarketSaleModal();
            } else {
                updateMarketSelectionInstruction();
                renderMarketsBoard();
            }
            return;
        }

        // 2å¸‚å ´åˆ¥ã€…è²©å£²ãƒ¢ãƒ¼ãƒ‰ã®å ´åˆ
        if (gameState.twoMarketMode === 'separate') {
            if (!gameState.selectedMarkets) gameState.selectedMarkets = [];

            // æ—¢ã«é¸æŠæ¸ˆã¿ãªã‚‰é™¤å¤–
            const existingIndex = gameState.selectedMarkets.indexOf(marketIndex);
            if (existingIndex >= 0) {
                gameState.selectedMarkets.splice(existingIndex, 1);
                updateSeparateMarketSelectionInstruction();
                renderMarketsBoard();
                return;
            }

            // é¸æŠè¿½åŠ 
            gameState.selectedMarkets.push(marketIndex);

            if (gameState.selectedMarkets.length === 2) {
                // 2å¸‚å ´é¸æŠå®Œäº†
                const instruction = document.getElementById('marketInstruction');
                if (instruction) instruction.remove();
                gameState.salesMode = false;
                renderMarketsBoard();
                showSeparateTwoMarketSaleModal();
            } else {
                updateSeparateMarketSelectionInstruction();
                renderMarketsBoard();
            }
            return;
        }

        // é€šå¸¸ã®1å¸‚å ´è²©å£²
        const instruction = document.getElementById('marketInstruction');
        if (instruction) instruction.remove();
        gameState.salesMode = false;
        renderMarketsBoard();
        showSaleConfirmModal(marketIndex);
    } else if (action === 'buy') {
        const instruction = document.getElementById('marketInstruction');
        if (instruction) instruction.remove();
        gameState.buyMode = false;
        renderMarketsBoard();
        showBuyConfirmModal(marketIndex);
    }
}

// 2å¸‚å ´é¸æŠæ™‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚·ãƒ§ãƒ³æ›´æ–°ï¼ˆåŒæ™‚è²©å£²ï¼‰
function updateMarketSelectionInstruction() {
    const instruction = document.getElementById('marketInstruction');
    if (instruction) {
        const selected = gameState.selectedMarkets || [];
        const marketNames = selected.map(i => gameState.markets[i].name).join('ã€');
        instruction.innerHTML = `
            <span>ğŸ“ğŸ“ 2ã¤ã®å¸‚å ´ã‚’é¸æŠ (${selected.length}/2) ${marketNames ? '- ' + marketNames : ''}</span>
            <button class="cancel-mode-btn" onclick="cancelMarketMode()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        `;
    }
}

// 2å¸‚å ´é¸æŠæ™‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚·ãƒ§ãƒ³æ›´æ–°ï¼ˆåˆ¥ã€…è²©å£²ï¼‰
function updateSeparateMarketSelectionInstruction() {
    const instruction = document.getElementById('marketInstruction');
    if (instruction) {
        const selected = gameState.selectedMarkets || [];
        const marketNames = selected.map(i => gameState.markets[i].name).join('ã€');
        instruction.innerHTML = `
            <span>ğŸ“+ğŸ“ 2ã¤ã®å¸‚å ´ã‚’é¸æŠ (${selected.length}/2) ${marketNames ? '- ' + marketNames : ''}</span>
            <button class="cancel-mode-btn" onclick="cancelMarketMode()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        `;
    }
}

// 2å¸‚å ´åˆ¥ã€…è²©å£²ãƒ¢ãƒ¼ãƒ€ãƒ«
function showSeparateTwoMarketSaleModal() {
    const company = gameState.companies[0];
    const salesCapacity = getSalesCapacity(company);
    const market1 = gameState.markets[gameState.selectedMarkets[0]];
    const market2 = gameState.markets[gameState.selectedMarkets[1]];

    // å„å¸‚å ´ã®ãƒãƒ¼ã‚±ãƒƒãƒˆãƒœãƒªãƒ¥ãƒ¼ãƒ ï¼ˆç©ºãå®¹é‡ï¼‰
    const volume1 = market1.maxStock - market1.currentStock;
    const volume2 = market2.maxStock - market2.currentStock;

    // å„å¸‚å ´ã¸ã®æœ€å¤§è²©å£²æ•°
    const maxQty1 = Math.min(salesCapacity, volume1, company.products);
    const maxQty2 = Math.min(salesCapacity, volume2, company.products);

    const defaultPrice1 = market1.sellPrice - 4;
    const defaultPrice2 = market2.sellPrice - 4;

    const content = `
        <div style="padding: 10px;">
            <div style="background: linear-gradient(180deg, #f59e0b 0%, #d97706 100%); border-radius: 12px; padding: 15px; margin-bottom: 15px; color: white;">
                <div style="font-weight: bold; font-size: 16px; margin-bottom: 5px;">2å¸‚å ´åˆ¥ã€…è²©å£²</div>
                <div style="font-size: 12px;">å„å¸‚å ´ã«ç•°ãªã‚‹ä¾¡æ ¼ã§å…¥æœ­ï¼ˆ2è¡Œä½¿ç”¨ï¼‰</div>
            </div>

            <div style="background: #f1f5f9; border-radius: 8px; padding: 10px; margin-bottom: 10px;">
                <div style="font-weight: bold; color: #1e293b;">è£½å“åœ¨åº«: ${company.products}å€‹ / è²©å£²èƒ½åŠ›: ${salesCapacity}</div>
            </div>

            <!-- 1ã¤ç›®ã®å¸‚å ´ -->
            <div style="background: #fef3c7; border-radius: 8px; padding: 12px; margin-bottom: 10px; border-left: 4px solid #f59e0b;">
                <div style="font-weight: bold; margin-bottom: 8px;">${market1.name}ï¼ˆä¸Šé™Â¥${market1.sellPrice}ã€ç©ºã${volume1}å€‹ï¼‰</div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <div>
                        <label style="font-size: 12px; color: #666;">æ•°é‡</label>
                        <select id="separateQty1" class="form-control" style="font-size: 14px;" onchange="updateSeparateTotal()">
                            <option value="0">è²©å£²ã—ãªã„</option>
                            ${Array(maxQty1).fill(0).map((_, i) => `<option value="${i+1}">${i+1}å€‹</option>`).join('')}
                        </select>
                    </div>
                    <div>
                        <label style="font-size: 12px; color: #666;">å…¥æœ­ä¾¡æ ¼</label>
                        <input type="number" id="separatePrice1" class="form-control" min="1" max="${market1.sellPrice}" value="${defaultPrice1}" style="font-size: 14px;">
                    </div>
                </div>
            </div>

            <!-- 2ã¤ç›®ã®å¸‚å ´ -->
            <div style="background: #dbeafe; border-radius: 8px; padding: 12px; margin-bottom: 15px; border-left: 4px solid #3b82f6;">
                <div style="font-weight: bold; margin-bottom: 8px;">${market2.name}ï¼ˆä¸Šé™Â¥${market2.sellPrice}ã€ç©ºã${volume2}å€‹ï¼‰</div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <div>
                        <label style="font-size: 12px; color: #666;">æ•°é‡</label>
                        <select id="separateQty2" class="form-control" style="font-size: 14px;" onchange="updateSeparateTotal()">
                            <option value="0">è²©å£²ã—ãªã„</option>
                            ${Array(maxQty2).fill(0).map((_, i) => `<option value="${i+1}">${i+1}å€‹</option>`).join('')}
                        </select>
                    </div>
                    <div>
                        <label style="font-size: 12px; color: #666;">å…¥æœ­ä¾¡æ ¼</label>
                        <input type="number" id="separatePrice2" class="form-control" min="1" max="${market2.sellPrice}" value="${defaultPrice2}" style="font-size: 14px;">
                    </div>
                </div>
            </div>

            <div id="separateTotalInfo" style="background: #f3f4f6; border-radius: 8px; padding: 10px; margin-bottom: 15px; text-align: center;">
                <span style="color: #6b7280;">åˆè¨ˆè²©å£²æ•°é‡: <strong id="separateTotalQty">0</strong>å€‹ï¼ˆè²©å£²èƒ½åŠ›: ${salesCapacity}ï¼‰</span>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <button onclick="cancelSeparateTwoMarketSale()" class="submit-btn" style="background: linear-gradient(180deg, #6b7280 0%, #4b5563 100%);">
                    â† æˆ»ã‚‹
                </button>
                <button onclick="processSeparateTwoMarketSale()" class="submit-btn" style="background: linear-gradient(180deg, #f59e0b 0%, #d97706 100%);">
                    ğŸ’° å…¥æœ­å®Ÿè¡Œï¼ˆ2è¡Œï¼‰
                </button>
            </div>
        </div>
    `;

    showModal('ğŸ“+ğŸ“ 2å¸‚å ´åˆ¥ã€…è²©å£²', content);
}

// åˆ¥ã€…è²©å£²ã®åˆè¨ˆæ•°é‡ã‚’æ›´æ–°
function updateSeparateTotal() {
    const qty1 = parseInt(document.getElementById('separateQty1').value) || 0;
    const qty2 = parseInt(document.getElementById('separateQty2').value) || 0;
    document.getElementById('separateTotalQty').textContent = qty1 + qty2;
}

// 2å¸‚å ´åˆ¥ã€…è²©å£²ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«
function cancelSeparateTwoMarketSale() {
    gameState.selectedMarkets = [];
    gameState.twoMarketMode = false;
    closeModal();
    showSalesTypeModal();
}

// 2å¸‚å ´åˆ¥ã€…è²©å£²ã‚’å®Ÿè¡Œ
function processSeparateTwoMarketSale() {
    const company = gameState.companies[0];
    const salesCapacity = getSalesCapacity(company);

    const qty1 = parseInt(document.getElementById('separateQty1').value) || 0;
    const qty2 = parseInt(document.getElementById('separateQty2').value) || 0;
    const price1 = parseInt(document.getElementById('separatePrice1').value);
    const price2 = parseInt(document.getElementById('separatePrice2').value);

    const totalQty = qty1 + qty2;

    if (totalQty === 0) {
        showToast('å°‘ãªãã¨ã‚‚1ã¤ã®å¸‚å ´ã«è²©å£²æ•°é‡ã‚’è¨­å®šã—ã¦ãã ã•ã„', 'warning', 3000);
        return;
    }

    if (totalQty > salesCapacity) {
        alert(`åˆè¨ˆè²©å£²æ•°é‡ï¼ˆ${totalQty}å€‹ï¼‰ãŒè²©å£²èƒ½åŠ›ï¼ˆ${salesCapacity}å€‹ï¼‰ã‚’è¶…ãˆã¦ã„ã¾ã™`);
        return;
    }

    if (totalQty > company.products) {
        alert(`åˆè¨ˆè²©å£²æ•°é‡ï¼ˆ${totalQty}å€‹ï¼‰ãŒè£½å“åœ¨åº«ï¼ˆ${company.products}å€‹ï¼‰ã‚’è¶…ãˆã¦ã„ã¾ã™`);
        return;
    }

    const market1 = gameState.markets[gameState.selectedMarkets[0]];
    const market2 = gameState.markets[gameState.selectedMarkets[1]];

    if (qty1 > 0 && price1 > market1.sellPrice) {
        alert(`${market1.name}ã®å…¥æœ­ä¾¡æ ¼ã¯ä¸Šé™Â¥${market1.sellPrice}ä»¥ä¸‹ã«ã—ã¦ãã ã•ã„`);
        return;
    }

    if (qty2 > 0 && price2 > market2.sellPrice) {
        alert(`${market2.name}ã®å…¥æœ­ä¾¡æ ¼ã¯ä¸Šé™Â¥${market2.sellPrice}ä»¥ä¸‹ã«ã—ã¦ãã ã•ã„`);
        return;
    }

    // ä¾¡æ ¼ç«¶äº‰åŠ›ã‚’è¨ˆç®—
    const competitiveness = getPriceCompetitiveness(company, 0);

    // 2å¸‚å ´åˆ¥ã€…å…¥æœ­ã¨ã—ã¦ä¿å­˜
    gameState.pendingSeparateBids = {
        bids: [],
        currentIndex: 0
    };

    if (qty1 > 0) {
        gameState.pendingSeparateBids.bids.push({
            marketIndex: gameState.selectedMarkets[0],
            quantity: qty1,
            price: price1 - competitiveness,
            displayPrice: price1,
            company: 0
        });
    }

    if (qty2 > 0) {
        gameState.pendingSeparateBids.bids.push({
            marketIndex: gameState.selectedMarkets[1],
            quantity: qty2,
            price: price2 - competitiveness,
            displayPrice: price2,
            company: 0
        });
    }

    closeModal();
    gameState.twoMarketMode = false;
    gameState.selectedMarkets = [];

    // æœ€åˆã®å¸‚å ´ã®å…¥æœ­ã‚’å‡¦ç†
    processSeparateBidNext();
}

// åˆ¥ã€…è²©å£²ã®æ¬¡ã®å…¥æœ­ã‚’å‡¦ç†
function processSeparateBidNext() {
    const pending = gameState.pendingSeparateBids;

    if (pending.currentIndex >= pending.bids.length) {
        // å…¨ã¦ã®å…¥æœ­å®Œäº†
        gameState.pendingSeparateBids = null;
        updateDisplay();
        return;
    }

    const bid = pending.bids[pending.currentIndex];
    const market = gameState.markets[bid.marketIndex];

    // ã“ã®å…¥æœ­ã‚’pendingBidã«è¨­å®šã—ã¦é€šå¸¸ã®å…¥æœ­å‡¦ç†ã‚’å®Ÿè¡Œ
    gameState.pendingBid = bid;
    gameState.pendingSeparateBids.currentIndex++;

    // ä»–ç¤¾ã®å…¥æœ­ã‚’å‡¦ç†
    showOtherPlayersBidModal(market, bid.marketIndex);
}

// 2å¸‚å ´åŒæ™‚è²©å£²ãƒ¢ãƒ¼ãƒ€ãƒ«
function showTwoMarketSaleModal() {
    const company = gameState.companies[0];
    const salesCapacity = getSalesCapacity(company);
    const market1 = gameState.markets[gameState.selectedMarkets[0]];
    const market2 = gameState.markets[gameState.selectedMarkets[1]];

    // ä½ã„æ–¹ã®ä¸Šé™ä¾¡æ ¼ã‚’é©ç”¨
    const maxPrice = Math.min(market1.sellPrice, market2.sellPrice);
    const defaultPrice = maxPrice - 4;

    // å„å¸‚å ´ã®ãƒãƒ¼ã‚±ãƒƒãƒˆãƒœãƒªãƒ¥ãƒ¼ãƒ ï¼ˆç©ºãå®¹é‡ï¼‰
    const volume1 = market1.maxStock - market1.currentStock;
    const volume2 = market2.maxStock - market2.currentStock;
    const totalVolume = volume1 + volume2;

    // è²©å£²ä¸Šé™ = MIN(è²©å£²èƒ½åŠ›, åˆè¨ˆãƒãƒ¼ã‚±ãƒƒãƒˆãƒœãƒªãƒ¥ãƒ¼ãƒ , è£½å“åœ¨åº«)
    const maxQuantity = Math.min(salesCapacity, totalVolume, company.products);

    const content = `
        <div style="padding: 10px;">
            <div style="background: linear-gradient(180deg, #8b5cf6 0%, #7c3aed 100%); border-radius: 12px; padding: 15px; margin-bottom: 15px; color: white;">
                <div style="font-weight: bold; font-size: 16px; margin-bottom: 10px;">2å¸‚å ´åŒæ™‚è²©å£²</div>
                <div style="display: flex; justify-content: space-around;">
                    <div style="text-align: center;">
                        <div style="font-size: 12px; opacity: 0.8;">${market1.name}</div>
                        <div style="font-size: 14px;">ä¸Šé™Â¥${market1.sellPrice}</div>
                        <div style="font-size: 11px;">ç©ºã${volume1}å€‹</div>
                    </div>
                    <div style="font-size: 24px;">+</div>
                    <div style="text-align: center;">
                        <div style="font-size: 12px; opacity: 0.8;">${market2.name}</div>
                        <div style="font-size: 14px;">ä¸Šé™Â¥${market2.sellPrice}</div>
                        <div style="font-size: 11px;">ç©ºã${volume2}å€‹</div>
                    </div>
                </div>
                <div style="text-align: center; margin-top: 10px; padding-top: 10px; border-top: 1px solid rgba(255,255,255,0.3);">
                    <div style="font-size: 12px;">é©ç”¨ä¸Šé™ä¾¡æ ¼</div>
                    <div style="font-size: 24px; font-weight: bold;">Â¥${maxPrice}</div>
                </div>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                <div style="background: #f1f5f9; border-radius: 8px; padding: 10px; text-align: center;">
                    <div style="font-size: 11px; color: #64748b;">è²©å£²èƒ½åŠ›</div>
                    <div style="font-size: 20px; font-weight: bold;">${salesCapacity}</div>
                </div>
                <div style="background: #f1f5f9; border-radius: 8px; padding: 10px; text-align: center;">
                    <div style="font-size: 11px; color: #64748b;">è£½å“åœ¨åº«</div>
                    <div style="font-size: 20px; font-weight: bold;">${company.products}</div>
                </div>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                <div class="form-group" style="margin-bottom: 0;">
                    <label class="form-label">ğŸ“¦ è²©å£²æ•°é‡</label>
                    <select id="twoMarketQuantity" class="form-control" style="font-size: 16px; text-align: center;">
                        ${Array(maxQuantity).fill(0).map((_, i) =>
                            `<option value="${i+1}" ${i+1 === maxQuantity ? 'selected' : ''}>${i+1}å€‹</option>`
                        ).join('')}
                    </select>
                </div>
                <div class="form-group" style="margin-bottom: 0;">
                    <label class="form-label">ğŸ’µ å…¥æœ­ä¾¡æ ¼</label>
                    <input type="number" id="twoMarketPrice" class="form-control" min="1" max="${maxPrice}" value="${defaultPrice}" style="font-size: 16px; text-align: center;">
                </div>
            </div>

            <div style="font-size: 12px; color: #6b7280; margin-bottom: 15px; text-align: center;">
                â€» ä¸¡å¸‚å ´ã«åŒä¾¡æ ¼ã§å…¥æœ­ï¼ˆ1è¡Œä½¿ç”¨ï¼‰
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <button onclick="cancelTwoMarketSale()" class="submit-btn" style="background: linear-gradient(180deg, #6b7280 0%, #4b5563 100%);">
                    â† æˆ»ã‚‹
                </button>
                <button onclick="processTwoMarketSale()" class="submit-btn">
                    ğŸ’° å…¥æœ­å®Ÿè¡Œ
                </button>
            </div>
        </div>
    `;

    showModal('ğŸ“ğŸ“ 2å¸‚å ´åŒæ™‚è²©å£²', content);
}

// 2å¸‚å ´åŒæ™‚è²©å£²ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«
function cancelTwoMarketSale() {
    gameState.selectedMarkets = [];
    gameState.twoMarketMode = false;
    closeModal();
    showSalesTypeModal();
}

// 2å¸‚å ´åŒæ™‚è²©å£²ã‚’å®Ÿè¡Œ
function processTwoMarketSale() {
    const company = gameState.companies[0];
    const quantity = parseInt(document.getElementById('twoMarketQuantity').value);
    const bidPrice = parseInt(document.getElementById('twoMarketPrice').value);
    const salesCapacity = getSalesCapacity(company);

    if (quantity > salesCapacity) {
        alert(`è²©å£²èƒ½åŠ›ï¼ˆ${salesCapacity}å€‹ï¼‰ã‚’è¶…ãˆã¦å…¥æœ­ã§ãã¾ã›ã‚“`);
        return;
    }

    const market1 = gameState.markets[gameState.selectedMarkets[0]];
    const market2 = gameState.markets[gameState.selectedMarkets[1]];
    const maxPrice = Math.min(market1.sellPrice, market2.sellPrice);

    if (bidPrice > maxPrice) {
        alert(`å…¥æœ­ä¾¡æ ¼ã¯ä¸Šé™ä¾¡æ ¼Â¥${maxPrice}ä»¥ä¸‹ã«ã—ã¦ãã ã•ã„`);
        return;
    }

    // ä¾¡æ ¼ç«¶äº‰åŠ›ã‚’è¨ˆç®—
    const competitiveness = getPriceCompetitiveness(company, 0);
    const effectiveBidPrice = bidPrice - competitiveness;

    // 2å¸‚å ´åŒæ™‚å…¥æœ­ã¨ã—ã¦ä¿å­˜
    gameState.pendingBid = {
        markets: gameState.selectedMarkets,
        quantity: quantity,
        price: effectiveBidPrice,
        displayPrice: bidPrice,
        company: 0,
        isTwoMarket: true
    };

    closeModal();

    // ä»–ç¤¾ã®å…¥æœ­ã‚’å‡¦ç†
    showOtherPlayersBidModalTwoMarket();
}

// è²©å£²ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ«
function showSaleConfirmModal(marketIndex) {
    const market = gameState.markets[marketIndex];
    const company = gameState.companies[0];
    const salesCapacity = getSalesCapacity(company);
    const maxQuantity = Math.min(salesCapacity, company.products, market.maxStock - market.currentStock);
    const defaultPrice = market.sellPrice - 4;

    const content = `
        <div style="background: linear-gradient(180deg, #fef3c7 0%, #fde68a 100%); border-radius: 12px; padding: 15px; margin-bottom: 15px; border: 2px solid #f59e0b;">
            <div style="display: flex; justify-content: space-around; text-align: center;">
                <div>
                    <div style="font-size: 12px; color: #92400e;">é¸æŠå¸‚å ´</div>
                    <div style="font-size: 20px; font-weight: bold; color: #78350f;">${market.name}</div>
                </div>
                <div>
                    <div style="font-size: 12px; color: #92400e;">ä¸Šé™ä¾¡æ ¼</div>
                    <div style="font-size: 20px; font-weight: bold; color: #059669;">Â¥${market.sellPrice}</div>
                </div>
                <div>
                    <div style="font-size: 12px; color: #92400e;">${market.needsBid ? 'å…¥æœ­' : 'å³å£²'}</div>
                    <div style="font-size: 20px; font-weight: bold; color: ${market.needsBid ? '#dc2626' : '#2563eb'};">${market.needsBid ? 'âš”ï¸' : 'âœ“'}</div>
                </div>
            </div>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 15px;">
            <div style="background: #f1f5f9; border-radius: 8px; padding: 10px; text-align: center;">
                <div style="font-size: 11px; color: #64748b;">è²©å£²èƒ½åŠ›</div>
                <div style="font-size: 22px; font-weight: bold; color: #1e293b;">${salesCapacity}</div>
            </div>
            <div style="background: #f1f5f9; border-radius: 8px; padding: 10px; text-align: center;">
                <div style="font-size: 11px; color: #64748b;">è£½å“åœ¨åº«</div>
                <div style="font-size: 22px; font-weight: bold; color: #1e293b;">${company.products}</div>
            </div>
        </div>

        <div style="display: grid; grid-template-columns: 1fr ${market.needsBid ? '1fr' : ''}; gap: 12px;">
            <div class="form-group" style="margin-bottom: 0;">
                <label class="form-label">ğŸ“¦ è²©å£²æ•°é‡</label>
                <select id="quantity" class="form-control" style="font-size: 18px; text-align: center; font-weight: bold;">
                    ${maxQuantity > 0 ? Array(maxQuantity).fill(0).map((_, i) =>
                        `<option value="${i+1}" ${i+1 === maxQuantity ? 'selected' : ''}>${i+1}å€‹</option>`
                    ).join('') : '<option value="0">è²©å£²ä¸å¯</option>'}
                </select>
            </div>
            ${market.needsBid ? `
            <div class="form-group" style="margin-bottom: 0;" id="bidPriceGroup">
                <label class="form-label">ğŸ’µ å…¥æœ­ä¾¡æ ¼</label>
                <input type="number" id="bidPrice" class="form-control" min="1" max="${market.sellPrice}" value="${defaultPrice}" style="font-size: 18px; text-align: center; font-weight: bold;">
            </div>
            ` : ''}
        </div>

        <input type="hidden" id="marketSelect" value="${marketIndex}">

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px;">
            <button class="submit-btn" onclick="enterSalesMode()" style="background: linear-gradient(180deg, #6b7280 0%, #4b5563 100%);">
                â† å¸‚å ´ã‚’å¤‰æ›´
            </button>
            <button class="submit-btn" onclick="processSale()" ${maxQuantity <= 0 ? 'disabled' : ''}>
                ğŸ’° è²©å£²å®Ÿè¡Œ
            </button>
        </div>
    `;

    showModal(`ğŸ’° ${market.name}ã«è²©å£²`, content);
}

// è³¼å…¥ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ«
function showBuyConfirmModal(marketIndex) {
    const market = gameState.markets[marketIndex];
    const company = gameState.companies[0];
    const maxQuantity = Math.min(market.currentStock, Math.floor(company.cash / market.buyPrice));

    // ææ–™å€‰åº«ã®ç©ºãå®¹é‡ã‚’ãƒã‚§ãƒƒã‚¯
    const maxMaterialCapacity = getMaterialCapacity(company);
    const spaceAvailable = maxMaterialCapacity - company.materials;
    const actualMax = Math.min(maxQuantity, spaceAvailable);

    const content = `
        <div style="background: linear-gradient(180deg, #dcfce7 0%, #bbf7d0 100%); border-radius: 12px; padding: 15px; margin-bottom: 15px; border: 2px solid #22c55e;">
            <div style="display: flex; justify-content: space-around; text-align: center;">
                <div>
                    <div style="font-size: 12px; color: #166534;">é¸æŠå¸‚å ´</div>
                    <div style="font-size: 20px; font-weight: bold; color: #14532d;">${market.name}</div>
                </div>
                <div>
                    <div style="font-size: 12px; color: #166534;">ä»•å…¥ä¾¡æ ¼</div>
                    <div style="font-size: 20px; font-weight: bold; color: #059669;">Â¥${market.buyPrice}</div>
                </div>
                <div>
                    <div style="font-size: 12px; color: #166534;">å¸‚å ´åœ¨åº«</div>
                    <div style="font-size: 20px; font-weight: bold; color: #14532d;">${market.currentStock}å€‹</div>
                </div>
            </div>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 15px;">
            <div style="background: #f1f5f9; border-radius: 8px; padding: 10px; text-align: center;">
                <div style="font-size: 11px; color: #64748b;">ç¾é‡‘</div>
                <div style="font-size: 22px; font-weight: bold; color: #1e293b;">Â¥${company.cash}</div>
            </div>
            <div style="background: #f1f5f9; border-radius: 8px; padding: 10px; text-align: center;">
                <div style="font-size: 11px; color: #64748b;">ææ–™åœ¨åº«</div>
                <div style="font-size: 22px; font-weight: bold; color: #1e293b;">${company.materials}å€‹</div>
            </div>
        </div>

        <div class="form-group">
            <label class="form-label">ğŸ“¦ è³¼å…¥æ•°é‡</label>
            <select id="buyQuantity" class="form-control" style="font-size: 18px; text-align: center; font-weight: bold;">
                ${actualMax > 0 ? Array(actualMax).fill(0).map((_, i) =>
                    `<option value="${i+1}" ${i+1 === Math.min(actualMax, 3) ? 'selected' : ''}>${i+1}å€‹ï¼ˆÂ¥${(i+1) * market.buyPrice}ï¼‰</option>`
                ).join('') : '<option value="0">è³¼å…¥ä¸å¯</option>'}
            </select>
        </div>

        <input type="hidden" id="buyMarketSelect" value="${marketIndex}">

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px;">
            <button class="submit-btn" onclick="enterBuyMode()" style="background: linear-gradient(180deg, #6b7280 0%, #4b5563 100%);">
                â† å¸‚å ´ã‚’å¤‰æ›´
            </button>
            <button class="submit-btn" onclick="processBuyFromModal()" ${actualMax <= 0 ? 'disabled' : ''} style="background: linear-gradient(180deg, #22c55e 0%, #16a34a 100%);">
                ğŸ“¦ è³¼å…¥å®Ÿè¡Œ
            </button>
        </div>
    `;

    showModal(`ğŸ“¦ ${market.name}ã‹ã‚‰ææ–™è³¼å…¥`, content);
}

// ãƒ¢ãƒ¼ãƒ€ãƒ«ã‹ã‚‰è³¼å…¥å‡¦ç†
function processBuyFromModal() {
    const marketIndex = parseInt(document.getElementById('buyMarketSelect').value);
    const quantity = parseInt(document.getElementById('buyQuantity').value);
    const market = gameState.markets[marketIndex];
    const company = gameState.companies[0];

    const cost = market.buyPrice * quantity;

    if (company.cash < cost) {
        showToast('ç¾é‡‘ãŒä¸è¶³ã—ã¦ã„ã¾ã™', 'danger', 3000);
        return;
    }

    if (market.currentStock < quantity) {
        showToast('å¸‚å ´åœ¨åº«ãŒä¸è¶³ã—ã¦ã„ã¾ã™', 'danger', 3000);
        return;
    }

    company.cash -= cost;
    company.materials += quantity;
    market.currentStock -= quantity;
    company.totalPurchaseCost += cost;

    closeModal();
    updateDisplay();
    showToast(`${market.name}ã‹ã‚‰ææ–™${quantity}å€‹ã‚’Â¥${cost}ã§è³¼å…¥ã—ã¾ã—ãŸ`, 'success', 3000);
    endTurn();
}

// è²©å£²ãƒ¢ãƒ¼ãƒ‰ã«å…¥ã‚‹ã‚ˆã†ã«å¤‰æ›´
function showSalesModal() {
    enterSalesMode();
}

// Process sale
function processSale() {
    const company = gameState.companies[0];
    const marketIndex = parseInt(document.getElementById('marketSelect').value);
    const quantity = parseInt(document.getElementById('quantity').value);
    const market = gameState.markets[marketIndex];
    
    if (company.products < quantity) {
        showToast('è£½å“ãŒä¸è¶³ã—ã¦ã„ã¾ã™ï¼', 'danger', 3000);
        return;
    }
    
    if (market.needsBid) {
        // å…¥æœ­å‡¦ç†
        const bidPrice = parseInt(document.getElementById('bidPrice').value);
        
        // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®å…¥æœ­ï¼ˆè²©å£²èƒ½åŠ›ã‚’è¶…ãˆã¦å…¥æœ­ã§ããªã„ï¼‰
        const salesCapacity = getSalesCapacity(company);
        if (quantity > salesCapacity) {
            alert(`è²©å£²èƒ½åŠ›ï¼ˆ${salesCapacity}å€‹ï¼‰ã‚’è¶…ãˆã¦å…¥æœ­ã§ãã¾ã›ã‚“`);
            return;
        }
        
        // Store bid for later processing
        // ä¾¡æ ¼ç«¶äº‰åŠ›ã‚’è¨ˆç®—ï¼ˆè¦ªãƒœãƒ¼ãƒŠã‚¹+ç ”ç©¶ãƒãƒƒãƒ—ï¼‰
        const competitiveness = getPriceCompetitiveness(company, 0);  // 0ã¯ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®index
        const effectiveBidPrice = bidPrice - competitiveness;
        
        // ãƒ‡ãƒãƒƒã‚°æƒ…å ±
        console.log(`ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼å…¥æœ­: è¡¨ç¤ºä¾¡æ ¼=${bidPrice}, ç«¶äº‰åŠ›=${competitiveness}, æœ‰åŠ¹ä¾¡æ ¼=${effectiveBidPrice}`);
        
        gameState.pendingBid = {
            market: marketIndex,
            company: 0,
            price: effectiveBidPrice,  // æœ‰åŠ¹å…¥æœ­ä¾¡æ ¼
            quantity: quantity,
            displayPrice: bidPrice  // è¡¨ç¤ºç”¨ä¾¡æ ¼
        };
        
        // Show modal for other players to bid
        showOtherPlayersBidModal(market, marketIndex);
        return;  // Exit here, will continue after all bids collected
    } else {
        // å…¥æœ­ä¸è¦ï¼ˆæ±äº¬ãƒ»æµ·å¤–ï¼‰
        const actualQty = Math.min(quantity, market.maxStock - market.currentStock);
        if (actualQty > 0) {
            company.cash += market.sellPrice * actualQty;
            company.products -= actualQty;
            company.totalSales += market.sellPrice * actualQty;
            company.totalSoldQuantity = (company.totalSoldQuantity || 0) + actualQty;
            market.currentStock += actualQty;
            
            closeModal();
            updateDisplay();
            alert(`${market.name}ã«è£½å“${actualQty}å€‹ã‚’Â¥${market.sellPrice * actualQty}ã§è²©å£²ã—ã¾ã—ãŸ`);
            endTurn();
        }
    }
}

// Complete sale
function completeSale() {
    closeModal();
    updateDisplay();
    if (gameState.lastSaleInfo) {
        alert(gameState.lastSaleInfo);
        gameState.lastSaleInfo = null;
    }

    // åˆ¥ã€…è²©å£²ã®æ¬¡ã®å…¥æœ­ãŒã‚ã‚Œã°å‡¦ç†
    if (gameState.pendingSeparateBids && gameState.pendingSeparateBids.currentIndex < gameState.pendingSeparateBids.bids.length) {
        processSeparateBidNext();
        return;
    }

    // åˆ¥ã€…è²©å£²å®Œäº†
    if (gameState.pendingSeparateBids) {
        gameState.pendingSeparateBids = null;
    }

    // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒå®Ÿéš›ã«è²©å£²ã—ãŸå ´åˆã®ã¿1è¡Œä½¿ç”¨ï¼ˆãŠé‡‘ã®æµã‚ŒãŒã‚ã£ãŸå ´åˆï¼‰
    const playerSold = gameState.playerSoldInBid;
    gameState.playerSoldInBid = null;  // ãƒ•ãƒ©ã‚°ã‚’ãƒªã‚»ãƒƒãƒˆ

    if (playerSold) {
        endTurn();
    } else {
        nextTurn();
    }
}

// Hire modal
function showHireModal() {
    const company = gameState.companies[0];

    const content = `
        <div style="background: linear-gradient(180deg, #fef3c7 0%, #fde68a 100%); border-radius: 12px; padding: 15px; margin-bottom: 15px; border: 2px solid #f59e0b;">
            <div style="text-align: center; margin-bottom: 10px;">
                <span style="font-size: 12px; color: #92400e;">æ¡ç”¨ä¸Šé™ï¼ˆ1ã‚¿ãƒ¼ãƒ³ï¼‰</span>
                <span style="font-size: 24px; font-weight: bold; color: #78350f; display: block;">3åã¾ã§</span>
                <span style="font-size: 11px; color: #a16207;">æ¡ç”¨è²»: Â¥5/äºº</span>
            </div>
            <div style="display: flex; justify-content: space-around; text-align: center; margin-top: 10px;">
                <div style="background: #fff; border-radius: 8px; padding: 8px 15px; border: 2px solid #a08060;">
                    <div style="font-size: 10px; color: #5d4037;">ç¾ãƒ¯ãƒ¼ã‚«ãƒ¼</div>
                    <div style="font-size: 20px; font-weight: bold; color: #5d4037;">${company.workers}äºº</div>
                </div>
                <div style="background: #fff; border-radius: 8px; padding: 8px 15px; border: 2px solid #c44;">
                    <div style="font-size: 10px; color: #c44;">ç¾ã‚»ãƒ¼ãƒ«ã‚¹</div>
                    <div style="font-size: 20px; font-weight: bold; color: #c44;">${company.salesmen}äºº</div>
                </div>
            </div>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 15px;">
            <div style="background: linear-gradient(180deg, #f5deb3 0%, #deb887 100%); border-radius: 10px; padding: 15px; border: 2px solid #a08060; text-align: center;">
                <div style="font-size: 28px; margin-bottom: 5px;">ğŸ‘·</div>
                <div style="font-size: 14px; font-weight: bold; color: #5d4037; margin-bottom: 8px;">ãƒ¯ãƒ¼ã‚«ãƒ¼</div>
                <select id="workerCount" class="form-control" style="font-size: 18px; text-align: center; font-weight: bold;">
                    <option value="0">0äºº</option>
                    <option value="1">1äºº</option>
                    <option value="2">2äºº</option>
                    <option value="3">3äºº</option>
                </select>
            </div>
            <div style="background: linear-gradient(180deg, #ff6b6b 0%, #ee5a5a 100%); border-radius: 10px; padding: 15px; border: 2px solid #c44; text-align: center;">
                <div style="font-size: 28px; margin-bottom: 5px;">ğŸ’¼</div>
                <div style="font-size: 14px; font-weight: bold; color: #fff; margin-bottom: 8px;">ã‚»ãƒ¼ãƒ«ã‚¹ãƒãƒ³</div>
                <select id="salesmanCount" class="form-control" style="font-size: 18px; text-align: center; font-weight: bold;">
                    <option value="0">0äºº</option>
                    <option value="1">1äºº</option>
                    <option value="2">2äºº</option>
                    <option value="3">3äºº</option>
                </select>
            </div>
        </div>

        <div style="background: #f1f5f9; border-radius: 10px; padding: 12px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <div>
                <span style="font-size: 12px; color: #64748b;">æ¡ç”¨äººæ•°: </span>
                <span id="totalHires" style="font-size: 18px; font-weight: bold; color: #1e293b;">0äºº</span>
            </div>
            <div>
                <span style="font-size: 12px; color: #64748b;">æ¡ç”¨è²»: </span>
                <span id="totalCost" style="font-size: 22px; font-weight: bold; color: #dc2626;">Â¥0</span>
            </div>
        </div>

        <button class="submit-btn" onclick="hire()" style="width: 100%;">
            ğŸ‘¥ æ¡ç”¨å®Ÿè¡Œ
        </button>
    `;

    showModal('ğŸ‘¥ æ¡ç”¨', content);

    // Update cost display
    const updateCost = () => {
        const workers = parseInt(document.getElementById('workerCount').value) || 0;
        const salesmen = parseInt(document.getElementById('salesmanCount').value) || 0;
        const total = workers + salesmen;

        if (total > 3) {
            alert('åˆè¨ˆ3åã¾ã§ã§ã™');
            document.getElementById('workerCount').value = 0;
            document.getElementById('salesmanCount').value = 0;
            return;
        }

        const cost = total * 5;
        document.getElementById('totalHires').textContent = `${total}äºº`;
        document.getElementById('totalCost').textContent = `Â¥${cost}`;
    };

    document.getElementById('workerCount').addEventListener('change', updateCost);
    document.getElementById('salesmanCount').addEventListener('change', updateCost);
    updateCost();
}

// Hire
function hire() {
    const company = gameState.companies[0];
    const workers = parseInt(document.getElementById('workerCount').value) || 0;
    const salesmen = parseInt(document.getElementById('salesmanCount').value) || 0;
    const total = workers + salesmen;
    
    if (total > 3) {
        alert('åˆè¨ˆ3åã¾ã§ã§ã™ï¼');
        return;
    }
    
    const cost = total * 5;
    
    if (company.cash < cost) {
        // çŸ­æœŸå€Ÿå…¥
        const needed = Math.ceil((cost - company.cash) / 0.8 / 50) * 50;
        company.shortLoans += needed;
        company.cash += needed * 0.8;  // çŸ­æœŸå€Ÿå…¥: å€Ÿå…¥æ™‚20%é‡‘åˆ©æ§é™¤
        showToast(`ç¾é‡‘ä¸è¶³ã®ãŸã‚çŸ­æœŸå€Ÿå…¥Â¥${needed}ã‚’å®Ÿè¡Œã—ã¾ã—ãŸ`, 'warning', 4000);
    }
    
    company.cash -= cost;
    company.extraLaborCost = (company.extraLaborCost || 0) + cost;  // æ¡ç”¨è²»ã¯äººä»¶è²»
    company.workers += workers;
    company.salesmen += salesmen;

    // é€€è·è€…ã®è£œå……ï¼ˆå†é›‡ç”¨ã§é€€è·è€…ã‚«ã‚¦ãƒ³ãƒˆã‚’æ¸›ã‚‰ã™ï¼‰
    if (workers > 0 && company.retiredWorkers > 0) {
        const filled = Math.min(workers, company.retiredWorkers);
        company.retiredWorkers -= filled;
    }
    if (salesmen > 0 && company.retiredSalesmen > 0) {
        const filled = Math.min(salesmen, company.retiredSalesmen);
        company.retiredSalesmen -= filled;
    }

    // æœŸä¸­æœ€å¤§äººå“¡ã®æ›´æ–°
    const currentTotal = company.workers + company.salesmen;
    if (currentTotal > (company.maxPersonnel || 0)) {
        company.maxPersonnel = currentTotal;
    }

    // æ•™è‚²ãƒãƒƒãƒ—ã®åŠ¹æœ
    if (company.chips.education > 0) {
        company.workers++;
        company.salesmen++;
        alert('æ•™è‚²ãƒãƒƒãƒ—ã®åŠ¹æœã§ãƒ¯ãƒ¼ã‚«ãƒ¼+1ã€ã‚»ãƒ¼ãƒ«ã‚¹+1ï¼');
    }

    // è¡Œå‹•ãƒ­ã‚°è¨˜éŒ²
    logAction(0, 'æ¡ç”¨', `ãƒ¯ãƒ¼ã‚«ãƒ¼${workers}äºº, ã‚»ãƒ¼ãƒ«ã‚¹${salesmen}äºº`, -cost, true);

    closeModal();
    updateDisplay();
    alert(`ãƒ¯ãƒ¼ã‚«ãƒ¼${workers}äººã€ã‚»ãƒ¼ãƒ«ã‚¹ãƒãƒ³${salesmen}äººã‚’æ¡ç”¨ã—ã¾ã—ãŸï¼ˆäººä»¶è²»Â¥${cost}ï¼‰`);
    endTurn();
}

// Machine modal
function showMachineModal() {
    const company = gameState.companies[0];
    const smallMachines = company.machines.filter(m => m.type === 'small');
    const largeMachines = company.machines.filter(m => m.type === 'large');
    const attachableMachines = smallMachines.filter(m => m.attachments === 0);

    const content = `
        <div style="background: linear-gradient(180deg, #e5e7eb 0%, #d1d5db 100%); border-radius: 12px; padding: 15px; margin-bottom: 15px; border: 2px solid #6b7280;">
            <div style="text-align: center; margin-bottom: 10px;">
                <span style="font-size: 12px; color: #4b5563;">ç¾åœ¨ã®è¨­å‚™</span>
            </div>
            <div style="display: flex; justify-content: space-around; text-align: center;">
                <div style="background: #fff; border-radius: 8px; padding: 8px 15px; border: 2px solid #888;">
                    <div style="font-size: 10px; color: #666;">å°å‹æ©Ÿæ¢°</div>
                    <div style="font-size: 20px; font-weight: bold; color: #444;">${smallMachines.length}å°</div>
                </div>
                <div style="background: #fff; border-radius: 8px; padding: 8px 15px; border: 2px solid #444;">
                    <div style="font-size: 10px; color: #444;">å¤§å‹æ©Ÿæ¢°</div>
                    <div style="font-size: 20px; font-weight: bold; color: #222;">${largeMachines.length}å°</div>
                </div>
                <div style="background: #fff; border-radius: 8px; padding: 8px 15px; border: 2px solid #f97316;">
                    <div style="font-size: 10px; color: #ea580c;">è£½é€ èƒ½åŠ›</div>
                    <div style="font-size: 20px; font-weight: bold; color: #c2410c;">${getManufacturingCapacity(company)}</div>
                </div>
            </div>
        </div>

        <div style="display: grid; grid-template-columns: 1fr; gap: 10px; margin-bottom: 15px;">
            <div onclick="selectMachineType('small')" id="machine-small" style="background: linear-gradient(180deg, #888 0%, #666 100%); border-radius: 10px; padding: 15px; border: 3px solid #444; cursor: pointer; display: flex; align-items: center; gap: 15px; transition: all 0.2s;">
                <div style="font-size: 32px;">âš™ï¸</div>
                <div style="flex: 1;">
                    <div style="font-size: 14px; font-weight: bold; color: #fff;">å°å‹æ©Ÿæ¢°</div>
                    <div style="font-size: 11px; color: #ddd;">è£½é€ èƒ½åŠ› +1</div>
                </div>
                <div style="text-align: right;">
                    <div style="font-size: 18px; font-weight: bold; color: #fef08a;">Â¥100</div>
                </div>
            </div>
            <div onclick="selectMachineType('attachment')" id="machine-attachment" style="background: linear-gradient(180deg, #f97316 0%, #ea580c 100%); border-radius: 10px; padding: 15px; border: 3px solid #c2410c; cursor: ${attachableMachines.length > 0 ? 'pointer' : 'not-allowed'}; display: flex; align-items: center; gap: 15px; transition: all 0.2s; opacity: ${attachableMachines.length > 0 ? '1' : '0.5'};">
                <div style="font-size: 32px;">ğŸ”§</div>
                <div style="flex: 1;">
                    <div style="font-size: 14px; font-weight: bold; color: #fff;">ã‚¢ã‚¿ãƒƒãƒãƒ¡ãƒ³ãƒˆ</div>
                    <div style="font-size: 11px; color: #fed7aa;">å°å‹æ©Ÿæ¢°ã‚’èƒ½åŠ›2ã« ${attachableMachines.length === 0 ? 'ï¼ˆå¯¾è±¡ãªã—ï¼‰' : `ï¼ˆå¯¾è±¡: ${attachableMachines.length}å°ï¼‰`}</div>
                </div>
                <div style="text-align: right;">
                    <div style="font-size: 18px; font-weight: bold; color: #fff;">Â¥30</div>
                </div>
            </div>
            <div onclick="selectMachineType('large')" id="machine-large" style="background: linear-gradient(180deg, #555 0%, #333 100%); border-radius: 10px; padding: 15px; border: 3px solid #111; cursor: pointer; display: flex; align-items: center; gap: 15px; transition: all 0.2s;">
                <div style="font-size: 32px;">ğŸ­</div>
                <div style="flex: 1;">
                    <div style="font-size: 14px; font-weight: bold; color: #fff;">å¤§å‹æ©Ÿæ¢°</div>
                    <div style="font-size: 11px; color: #ddd;">è£½é€ èƒ½åŠ› +4</div>
                </div>
                <div style="text-align: right;">
                    <div style="font-size: 18px; font-weight: bold; color: #fef08a;">Â¥200</div>
                </div>
            </div>
        </div>

        <input type="hidden" id="machineType" value="small">

        <button class="submit-btn" onclick="buyMachine()" style="width: 100%;">
            âš™ï¸ è³¼å…¥å®Ÿè¡Œ
        </button>
    `;

    showModal('âš™ï¸ è¨­å‚™æŠ•è³‡', content);

    // åˆæœŸé¸æŠã‚’è¦–è¦šçš„ã«åæ˜ 
    setTimeout(() => selectMachineType('small'), 0);
}

// æ©Ÿæ¢°ã‚¿ã‚¤ãƒ—ã‚’é¸æŠ
function selectMachineType(type) {
    const company = gameState.companies[0];
    const attachableMachines = company.machines.filter(m => m.type === 'small' && m.attachments === 0);

    if (type === 'attachment' && attachableMachines.length === 0) {
        return; // ã‚¢ã‚¿ãƒƒãƒãƒ¡ãƒ³ãƒˆå¯¾è±¡ãŒãªã„å ´åˆã¯é¸æŠä¸å¯
    }

    document.getElementById('machineType').value = type;

    // è¦–è¦šçš„ãªé¸æŠçŠ¶æ…‹ã‚’æ›´æ–°
    ['small', 'attachment', 'large'].forEach(t => {
        const el = document.getElementById(`machine-${t}`);
        if (el) {
            el.style.transform = t === type ? 'scale(1.02)' : 'scale(1)';
            el.style.boxShadow = t === type ? '0 0 20px rgba(251,191,36,0.5)' : 'none';
        }
    });
}

// Buy machine
function buyMachine() {
    const company = gameState.companies[0];
    const type = document.getElementById('machineType').value;
    
    let cost = 0;
    if (type === 'small') cost = 100;
    else if (type === 'large') cost = 200;
    else if (type === 'attachment') cost = 30;
    
    if (company.cash < cost) {
        // çŸ­æœŸå€Ÿå…¥
        const needed = Math.ceil((cost - company.cash) / 0.8 / 50) * 50;
        company.shortLoans += needed;
        company.cash += needed * 0.8;  // çŸ­æœŸå€Ÿå…¥: å€Ÿå…¥æ™‚20%é‡‘åˆ©æ§é™¤
        showToast(`ç¾é‡‘ä¸è¶³ã®ãŸã‚çŸ­æœŸå€Ÿå…¥Â¥${needed}ã‚’å®Ÿè¡Œã—ã¾ã—ãŸ`, 'warning', 4000);
    }
    
    if (type === 'attachment') {
        // Find small machine without attachment
        const smallMachine = company.machines.find(m => m.type === 'small' && m.attachments === 0);
        if (!smallMachine) {
            alert('ã‚¢ã‚¿ãƒƒãƒãƒ¡ãƒ³ãƒˆã‚’ä»˜ã‘ã‚‰ã‚Œã‚‹å°å‹æ©Ÿæ¢°ãŒã‚ã‚Šã¾ã›ã‚“ï¼');
            return;
        }
        smallMachine.attachments = 1;
        company.cash -= cost;
        alert('å°å‹æ©Ÿæ¢°ã«ã‚¢ã‚¿ãƒƒãƒãƒ¡ãƒ³ãƒˆã‚’è¿½åŠ ã—ã¾ã—ãŸ');
    } else {
        company.cash -= cost;
        company.machines.push({type: type, attachments: 0});
        showToast(`${type === 'small' ? 'å°å‹' : 'å¤§å‹'}æ©Ÿæ¢°ã‚’è³¼å…¥ã—ã¾ã—ãŸï¼ˆÂ¥${cost}ï¼‰`, 'success', 3000);
    }
    
    closeModal();
    updateDisplay();
    endTurn();
}

// Warehouse modal (ç„¡ç½å®³å€‰åº«)
function showWarehouseModal() {
    const company = gameState.companies[0];
    const currentWarehouses = company.warehouses || 0;

    if (currentWarehouses >= 2) {
        alert('å€‰åº«ã¯æœ€å¤§2å€‹ã¾ã§ã§ã™ã€‚æ—¢ã«2å€‹æ‰€æœ‰ã—ã¦ã„ã¾ã™ã€‚');
        return;
    }

    // è³¼å…¥å¯èƒ½ãªã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ç”Ÿæˆ
    let locationOptions = '';
    let purchaseOptions = '';

    if (currentWarehouses === 0) {
        // 0å€‹â†’1å€‹: ææ–™ã‹è£½å“ã‚’é¸æŠ
        locationOptions = `
            <option value="materials">ææ–™ç½®å ´ã«è¨­ç½®ï¼ˆ+12å€‹ï¼‰</option>
            <option value="products">è£½å“ç½®å ´ã«è¨­ç½®ï¼ˆ+12å€‹ï¼‰</option>
        `;
        purchaseOptions = `
            <option value="1">1å€‹è³¼å…¥ï¼ˆÂ¥20ï¼‰</option>
            <option value="2">2å€‹è³¼å…¥ï¼ˆÂ¥40ï¼‰- ææ–™+è£½å“ä¸¡æ–¹</option>
        `;
    } else {
        // 1å€‹â†’2å€‹: åå¯¾å´ã«è¿½åŠ 
        const otherLocation = company.warehouseLocation === 'materials' ? 'products' : 'materials';
        const otherName = otherLocation === 'materials' ? 'ææ–™ç½®å ´' : 'è£½å“ç½®å ´';
        locationOptions = `<option value="${otherLocation}">${otherName}ã«è¨­ç½®ï¼ˆ+12å€‹ï¼‰</option>`;
        purchaseOptions = `<option value="1">1å€‹è³¼å…¥ï¼ˆÂ¥20ï¼‰</option>`;
    }

    const content = `
        <div style="padding: 10px;">
            <div style="background: #fef3c7; border-radius: 8px; padding: 10px; margin-bottom: 15px;">
                <div style="font-weight: bold; color: #92400e;">ç¾é‡‘: Â¥${company.cash}</div>
                <div style="font-size: 12px; color: #78350f;">
                    ç¾åœ¨ã®å€‰åº«: ${currentWarehouses}å€‹
                    ${currentWarehouses === 1 ? `ï¼ˆ${company.warehouseLocation === 'materials' ? 'ææ–™ç½®å ´' : 'è£½å“ç½®å ´'}ï¼‰` : ''}
                </div>
            </div>
            <div class="form-group">
                <label class="form-label">ç„¡ç½å®³å€‰åº«ï¼ˆÂ¥20/å€‹ã€å®¹é‡+12å€‹ï¼‰</label>
                <p style="font-size: 12px; color: #666;">åŠ¹æœï¼šç«ç½ãƒ»ç›—é›£å®Œå…¨å›é¿</p>
                <p style="font-size: 12px; color: #0369a1;">â€» 1å€‹ã®å ´åˆã¯å¾Œã‹ã‚‰ç§»å‹•å¯èƒ½</p>
            </div>
            <div class="form-group">
                <label class="form-label">è³¼å…¥æ•°:</label>
                <select id="warehouseCount" class="form-control" onchange="updateWarehouseLocationOptions()">
                    ${purchaseOptions}
                </select>
            </div>
            <div class="form-group" id="warehouseLocationGroup">
                <label class="form-label">è¨­ç½®å ´æ‰€:</label>
                <select id="warehouseLocation" class="form-control">
                    ${locationOptions}
                </select>
            </div>
            <button class="submit-btn" onclick="buyWarehouse()">è³¼å…¥ï¼ˆ1è¡Œä½¿ç”¨ï¼‰</button>
        </div>
    `;

    showModal('ç„¡ç½å®³å€‰åº«è³¼å…¥', content);
}

// å€‰åº«è³¼å…¥æ•°ã«å¿œã˜ã¦è¨­ç½®å ´æ‰€ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’æ›´æ–°
function updateWarehouseLocationOptions() {
    const count = document.getElementById('warehouseCount').value;
    const locationGroup = document.getElementById('warehouseLocationGroup');

    if (count === '2') {
        locationGroup.style.display = 'none';  // 2å€‹ã®å ´åˆã¯ä¸¡æ–¹ã«è¨­ç½®ãªã®ã§é¸æŠä¸è¦
    } else {
        locationGroup.style.display = 'block';
    }
}

// Buy warehouse
function buyWarehouse() {
    const company = gameState.companies[0];
    const count = parseInt(document.getElementById('warehouseCount')?.value || '1');
    const location = document.getElementById('warehouseLocation')?.value || 'materials';

    const cost = count * 20;

    if (company.warehouses + count > 2) {
        alert('å€‰åº«ã¯æœ€å¤§2å€‹ã¾ã§ã§ã™ï¼');
        return;
    }

    if (company.cash < cost) {
        showToast('ç¾é‡‘ãŒä¸è¶³ã—ã¦ã„ã¾ã™ï¼', 'danger', 3000);
        return;
    }

    company.cash -= cost;

    if (count === 2) {
        // 2å€‹è³¼å…¥: ä¸¡æ–¹ã«è¨­ç½®
        company.warehouses = 2;
        company.warehouseLocation = 'both';  // ä¸¡æ–¹ã«è¨­ç½®ã‚’ç¤ºã™
    } else {
        // 1å€‹è³¼å…¥
        company.warehouses += 1;
        if (company.warehouses === 1) {
            company.warehouseLocation = location;
        } else {
            // 2å€‹ç›®ã¯åå¯¾å´ã«è¨­ç½®ï¼ˆè‡ªå‹•ï¼‰
            company.warehouseLocation = 'both';
        }
    }

    company.extraLaborCost = (company.extraLaborCost || 0) + cost;

    closeModal();
    let locationText;
    if (count === 2 || company.warehouses === 2) {
        locationText = 'ææ–™ç½®å ´ã¨è£½å“ç½®å ´';
    } else {
        locationText = location === 'materials' ? 'ææ–™ç½®å ´' : 'è£½å“ç½®å ´';
    }
    alert(`ç„¡ç½å®³å€‰åº«ã‚’${locationText}ã«è¨­ç½®ã—ã¾ã—ãŸï¼ˆÂ¥${cost}ï¼‰`);

    // ã‚«ãƒ¼ãƒ‰ã‚’å¼•ã
    drawCard();
}

// å€‰åº«ç§»å‹•ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆ1å€‹ã®ã¿ä¿æœ‰æ™‚ã«ä½¿ç”¨å¯èƒ½ï¼‰
function showWarehouseMoveModal() {
    const company = gameState.companies[0];

    if (company.warehouses !== 1) {
        alert('å€‰åº«ã®ç§»å‹•ã¯1å€‹ä¿æœ‰æ™‚ã®ã¿å¯èƒ½ã§ã™ã€‚');
        return;
    }

    const currentLocation = company.warehouseLocation === 'materials' ? 'ææ–™ç½®å ´' : 'è£½å“ç½®å ´';
    const newLocation = company.warehouseLocation === 'materials' ? 'products' : 'materials';
    const newLocationName = newLocation === 'materials' ? 'ææ–™ç½®å ´' : 'è£½å“ç½®å ´';

    // ç§»å‹•å…ˆã®å®¹é‡ãƒã‚§ãƒƒã‚¯
    let canMove = true;
    let warningMessage = '';

    if (newLocation === 'materials') {
        // è£½å“ç½®å ´â†’ææ–™ç½®å ´ã«ç§»å‹•ã™ã‚‹å ´åˆã€è£½å“ãŒ10å€‹ã‚’è¶…ãˆã¦ã„ã‚‹ã‹ç¢ºèª
        if (company.products > 10) {
            canMove = false;
            warningMessage = `è£½å“ãŒ${company.products}å€‹ã‚ã‚Šã¾ã™ã€‚\nå€‰åº«ã‚’ç§»å‹•ã™ã‚‹ã¨è£½å“ç½®å ´ã®å®¹é‡ï¼ˆ10å€‹ï¼‰ã‚’è¶…ãˆã¦ã—ã¾ã„ã¾ã™ã€‚`;
        }
    } else {
        // ææ–™ç½®å ´â†’è£½å“ç½®å ´ã«ç§»å‹•ã™ã‚‹å ´åˆã€ææ–™ãŒ10å€‹ã‚’è¶…ãˆã¦ã„ã‚‹ã‹ç¢ºèª
        if (company.materials > 10) {
            canMove = false;
            warningMessage = `ææ–™ãŒ${company.materials}å€‹ã‚ã‚Šã¾ã™ã€‚\nå€‰åº«ã‚’ç§»å‹•ã™ã‚‹ã¨ææ–™ç½®å ´ã®å®¹é‡ï¼ˆ10å€‹ï¼‰ã‚’è¶…ãˆã¦ã—ã¾ã„ã¾ã™ã€‚`;
        }
    }

    const content = `
        <div style="padding: 10px;">
            <div style="background: #fef3c7; border-radius: 8px; padding: 10px; margin-bottom: 15px;">
                <div style="font-weight: bold; color: #92400e;">ç¾åœ¨ã®å€‰åº«ä½ç½®</div>
                <div style="font-size: 18px; color: #78350f; margin-top: 5px;">${currentLocation}</div>
            </div>
            <div style="margin-bottom: 15px;">
                <p style="font-size: 14px; color: #444;">å€‰åº«ã‚’${newLocationName}ã«ç§»å‹•ã—ã¾ã™ã‹ï¼Ÿ</p>
                <p style="font-size: 12px; color: #0369a1;">â€» ç§»å‹•ã¯ä½•å›ã§ã‚‚å¯èƒ½ã§ã€è¡Œã‚’æ¶ˆè²»ã—ã¾ã›ã‚“</p>
                ${!canMove ? `<p style="font-size: 12px; color: #dc2626; margin-top: 10px;">${warningMessage}</p>` : ''}
            </div>
            ${canMove ? `
                <button class="submit-btn" onclick="moveWarehouse('${newLocation}')" style="width: 100%;">
                    ${newLocationName}ã«ç§»å‹•
                </button>
            ` : `
                <button class="submit-btn" disabled style="width: 100%; background: #ccc; cursor: not-allowed;">
                    ç§»å‹•ä¸å¯
                </button>
            `}
            <button class="action-btn secondary" onclick="closeModal()" style="width: 100%; margin-top: 10px;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        </div>
    `;

    showModal('å€‰åº«ã®ç§»å‹•', content);
}

// å€‰åº«ã‚’ç§»å‹•ã™ã‚‹
function moveWarehouse(newLocation) {
    const company = gameState.companies[0];

    if (company.warehouses !== 1) {
        alert('å€‰åº«ã®ç§»å‹•ã¯1å€‹ä¿æœ‰æ™‚ã®ã¿å¯èƒ½ã§ã™ã€‚');
        return;
    }

    const newLocationName = newLocation === 'materials' ? 'ææ–™ç½®å ´' : 'è£½å“ç½®å ´';
    company.warehouseLocation = newLocation;

    closeModal();
    alert(`å€‰åº«ã‚’${newLocationName}ã«ç§»å‹•ã—ã¾ã—ãŸã€‚`);
    updateDisplay();
    // è¡Œã‚’æ¶ˆè²»ã—ãªã„ã®ã§ã€ã‚¿ãƒ¼ãƒ³é¸æŠã«æˆ»ã‚‹
    showTurnStartOptions();
}

// Reassign modal (é…ç½®è»¢æ›)
function showReassignModal() {
    const content = `
        <div class="form-group">
            <label class="form-label">é…ç½®è»¢æ›ï¼ˆÂ¥5/äººï¼‰:</label>
            <select id="reassignType" class="form-control">
                <option value="workerToSales">ãƒ¯ãƒ¼ã‚«ãƒ¼â†’ã‚»ãƒ¼ãƒ«ã‚¹ãƒãƒ³</option>
                <option value="salesToWorker">ã‚»ãƒ¼ãƒ«ã‚¹ãƒãƒ³â†’ãƒ¯ãƒ¼ã‚«ãƒ¼</option>
            </select>
        </div>
        <div class="form-group">
            <label class="form-label">äººæ•°:</label>
            <select id="reassignCount" class="form-control">
                <option value="1">1äºº</option>
                <option value="2">2äºº</option>
                <option value="3">3äºº</option>
            </select>
        </div>
        <button class="submit-btn" onclick="reassign()">é…ç½®è»¢æ›</button>
    `;
    
    showModal('é…ç½®è»¢æ›', content);
}

// Reassign
function reassign() {
    const company = gameState.companies[0];
    const type = document.getElementById('reassignType').value;
    const count = parseInt(document.getElementById('reassignCount').value);
    const cost = count * 5;

    if (company.cash < cost) {
        showToast('ç¾é‡‘ãŒä¸è¶³ã—ã¦ã„ã¾ã™ï¼', 'danger', 3000);
        return;
    }

    if (type === 'workerToSales') {
        if (company.workers < count) {
            alert('ãƒ¯ãƒ¼ã‚«ãƒ¼ãŒä¸è¶³ã—ã¦ã„ã¾ã™ï¼');
            return;
        }
        company.workers -= count;
        company.salesmen += count;
    } else {
        if (company.salesmen < count) {
            alert('ã‚»ãƒ¼ãƒ«ã‚¹ãƒãƒ³ãŒä¸è¶³ã—ã¦ã„ã¾ã™ï¼');
            return;
        }
        company.salesmen -= count;
        company.workers += count;
    }

    company.cash -= cost;

    // é…ç½®è»¢æ›è²»ç”¨ã‚’Fã«è¨ˆä¸Š
    company.extraLaborCost = (company.extraLaborCost || 0) + cost;

    closeModal();

    // 1è¡Œä½¿ç”¨ã—ã¦ã‚¿ãƒ¼ãƒ³çµ‚äº†
    endTurn();
}

// Sell machine modal
function showSellMachineModal() {
    const company = gameState.companies[0];
    
    if (company.machines.length === 0) {
        alert('å£²å´ã™ã‚‹æ©Ÿæ¢°ãŒã‚ã‚Šã¾ã›ã‚“ï¼');
        return;
    }
    
    const content = `
        <div class="form-group">
            <label class="form-label">å£²å´ã™ã‚‹æ©Ÿæ¢°ï¼ˆç°¿ä¾¡ã®70%ï¼‰:</label>
            <select id="machineIndex" class="form-control">
                ${company.machines.map((m, i) => {
                    const name = m.type === 'small' ? 
                        (m.attachments > 0 ? 'å°å‹+ã‚¢ã‚¿ãƒƒãƒãƒ¡ãƒ³ãƒˆ' : 'å°å‹æ©Ÿæ¢°') : 'å¤§å‹æ©Ÿæ¢°';
                    const bookValue = m.type === 'small' ? 
                        (m.attachments > 0 ? 130 : 100) : 200;
                    const salePrice = Math.floor(bookValue * 0.7);
                    return `<option value="${i}">${name} (å£²å´é¡: Â¥${salePrice})</option>`;
                }).join('')}
            </select>
        </div>
        <button class="submit-btn" onclick="sellMachine()">å£²å´</button>
    `;
    
    showModal('æ©Ÿæ¢°å£²å´', content);
}

// Sell machine
function sellMachine() {
    const company = gameState.companies[0];
    const machineIndex = parseInt(document.getElementById('machineIndex').value);
    const machine = company.machines[machineIndex];
    
    const bookValue = machine.type === 'small' ? 
        (machine.attachments > 0 ? 130 : 100) : 200;
    const salePrice = Math.floor(bookValue * 0.7);
    const loss = bookValue - salePrice;
    
    company.cash += salePrice;
    company.machines.splice(machineIndex, 1);
    
    // ç‰¹åˆ¥æå¤±ã¨ã—ã¦æœŸæœ«ã«åæ˜ 
    company.specialLoss = (company.specialLoss || 0) + loss;
    
    closeModal();
    alert(`æ©Ÿæ¢°ã‚’Â¥${salePrice}ã§å£²å´ã—ã¾ã—ãŸï¼ˆç‰¹åˆ¥æå¤±Â¥${loss}ï¼‰`);
    
    // ã‚«ãƒ¼ãƒ‰ã‚’å¼•ã
    drawCard();
}

// Chip purchase modal for decision cards (ã‚«ãƒ¼ãƒ‰ã‚¿ãƒƒãƒ—å½¢å¼)
function showChipPurchaseModal() {
    const company = gameState.companies[0];
    const maxEducation = gameState.currentPeriod === 2 ? 2 : 1;

    const content = `
        <div style="background: #fef3c7; border-radius: 8px; padding: 10px; margin-bottom: 15px; text-align: center;">
            <div style="font-weight: bold; color: #92400e;">ğŸ’° æŒã¡é‡‘: Â¥${company.cash}</div>
        </div>
        <p style="text-align: center; margin-bottom: 15px; color: #666;">è³¼å…¥ã™ã‚‹ãƒãƒƒãƒ—ã‚’ã‚¿ãƒƒãƒ—ã—ã¦ãã ã•ã„ï¼ˆ1æšÂ¥20ï¼‰</p>
        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px;">
            <!-- ç ”ç©¶ãƒãƒƒãƒ—ï¼ˆé’ï¼‰ -->
            <div onclick="buyChipDirect('research')" style="
                background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
                border: 3px solid #1e40af;
                border-radius: 12px;
                padding: 15px 10px;
                text-align: center;
                cursor: pointer;
                color: white;
                transition: transform 0.2s, box-shadow 0.2s;
                box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
            " onmouseover="this.style.transform='scale(1.05)'; this.style.boxShadow='0 6px 20px rgba(59, 130, 246, 0.6)'"
               onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='0 4px 12px rgba(59, 130, 246, 0.4)'">
                <div style="font-size: 28px; margin-bottom: 8px;">ğŸ”¬</div>
                <div style="font-weight: bold; font-size: 14px;">ç ”ç©¶é–‹ç™º</div>
                <div style="font-size: 11px; margin-top: 5px;">ä¾¡æ ¼ç«¶äº‰åŠ›+2</div>
                <div style="font-size: 10px; margin-top: 3px; opacity: 0.8;">æ‰€æŒ: ${company.chips.research || 0}æš</div>
            </div>

            <!-- æ•™è‚²ãƒãƒƒãƒ—ï¼ˆé»„ï¼‰ -->
            <div onclick="buyChipDirect('education')" style="
                background: linear-gradient(135deg, #eab308 0%, #ca8a04 100%);
                border: 3px solid #a16207;
                border-radius: 12px;
                padding: 15px 10px;
                text-align: center;
                cursor: pointer;
                color: #1e293b;
                transition: transform 0.2s, box-shadow 0.2s;
                box-shadow: 0 4px 12px rgba(234, 179, 8, 0.4);
            " onmouseover="this.style.transform='scale(1.05)'; this.style.boxShadow='0 6px 20px rgba(234, 179, 8, 0.6)'"
               onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='0 4px 12px rgba(234, 179, 8, 0.4)'">
                <div style="font-size: 28px; margin-bottom: 8px;">ğŸ“š</div>
                <div style="font-weight: bold; font-size: 14px;">æ•™è‚²</div>
                <div style="font-size: 11px; margin-top: 5px;">è£½é€ ãƒ»è²©å£²+1</div>
                <div style="font-size: 10px; margin-top: 3px; opacity: 0.8;">æ‰€æŒ: ${company.chips.education || 0}/${maxEducation}æš</div>
            </div>

            <!-- åºƒå‘Šãƒãƒƒãƒ—ï¼ˆèµ¤ï¼‰ -->
            <div onclick="buyChipDirect('advertising')" style="
                background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
                border: 3px solid #b91c1c;
                border-radius: 12px;
                padding: 15px 10px;
                text-align: center;
                cursor: pointer;
                color: white;
                transition: transform 0.2s, box-shadow 0.2s;
                box-shadow: 0 4px 12px rgba(239, 68, 68, 0.4);
            " onmouseover="this.style.transform='scale(1.05)'; this.style.boxShadow='0 6px 20px rgba(239, 68, 68, 0.6)'"
               onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='0 4px 12px rgba(239, 68, 68, 0.4)'">
                <div style="font-size: 28px; margin-bottom: 8px;">ğŸ“¢</div>
                <div style="font-weight: bold; font-size: 14px;">åºƒå‘Š</div>
                <div style="font-size: 11px; margin-top: 5px;">è²©å£²èƒ½åŠ›å‘ä¸Š</div>
                <div style="font-size: 10px; margin-top: 3px; opacity: 0.8;">æ‰€æŒ: ${company.chips.advertising || 0}æš</div>
            </div>
        </div>
        <div style="text-align: center; margin-top: 15px;">
            <button class="action-btn secondary" onclick="closeModal(true)" style="padding: 10px 30px;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        </div>
    `;

    showModal('æˆ¦ç•¥ãƒãƒƒãƒ—è³¼å…¥', content);
}

// ç›´æ¥ãƒãƒƒãƒ—è³¼å…¥ï¼ˆã‚«ãƒ¼ãƒ‰ã‚¿ãƒƒãƒ—ç”¨ï¼‰
function buyChipDirect(chipType) {
    const company = gameState.companies[0];
    const cost = 20;

    if (company.cash < cost) {
        alert('ç¾é‡‘ãŒä¸è¶³ã—ã¦ã„ã¾ã™ï¼ˆå¿…è¦: Â¥20ï¼‰');
        return;
    }

    // ä¸Šé™ãƒã‚§ãƒƒã‚¯
    const maxLimits = {
        research: 5,
        education: gameState.currentPeriod === 2 ? 2 : 1,
        advertising: 5
    };
    const currentCount = company.chips[chipType] || 0;

    if (currentCount >= maxLimits[chipType]) {
        const names = { research: 'ç ”ç©¶é–‹ç™º', education: 'æ•™è‚²', advertising: 'åºƒå‘Š' };
        alert(`${names[chipType]}ãƒãƒƒãƒ—ã¯æœ€å¤§${maxLimits[chipType]}æšã¾ã§ã§ã™`);
        return;
    }

    company.cash -= cost;
    company.chips[chipType] = currentCount + 1;

    const names = { research: 'ç ”ç©¶é–‹ç™º', education: 'æ•™è‚²', advertising: 'åºƒå‘Š' };
    closeModal();
    showToast(`${names[chipType]}ãƒãƒƒãƒ—ã‚’è³¼å…¥ã—ã¾ã—ãŸï¼ˆÂ¥20ï¼‰`, 'success', 3000);

    endTurn();
}

// Buy chips from decision card
function buyChipsFromDecision() {
    const company = gameState.companies[0];
    const chipType = document.getElementById('chipType').value;
    const quantity = parseInt(document.getElementById('quantity').value);
    
    const cost = quantity * 20;
    
    if (company.cash < cost) {
        showToast('ç¾é‡‘ãŒä¸è¶³ã—ã¦ã„ã¾ã™', 'danger', 3000);
        return;
    }
    
    // Check limits (2æœŸã¯æ•™è‚²ãƒãƒƒãƒ—2æšã¾ã§)
    const maxLimits = {
        research: 5, 
        education: gameState.currentPeriod === 2 ? 2 : 1,  // 2æœŸã¯2æšã¾ã§
        advertising: 5
    };
    const currentCount = company.chips[chipType] || 0;
    const newTotal = currentCount + quantity;
    
    if (newTotal > maxLimits[chipType]) {
        alert(`${chipType}ãƒãƒƒãƒ—ã¯æœ€å¤§${maxLimits[chipType]}æšã¾ã§ã§ã™`);
        return;
    }
    
    company.cash -= cost;
    company.chips[chipType] = newTotal;
    
    closeModal();
    showToast(`${chipType}ãƒãƒƒãƒ—ã‚’${quantity}å€‹è³¼å…¥ã—ã¾ã—ãŸï¼ˆÂ¥${cost}ï¼‰`, 'success', 3000);
    
    endTurn();
}

// Show manufacturing capacity detail
function showManufacturingCapacityDetail(companyIndex) {
    const company = gameState.companies[companyIndex];
    let baseMachineCapacity = 0;
    let machineDetail = [];
    
    company.machines.forEach(machine => {
        if (machine.type === 'small') {
            const capacity = machine.attachments > 0 ? 2 : 1;
            baseMachineCapacity += capacity;
            machineDetail.push(`å°å‹æ©Ÿæ¢°${machine.attachments > 0 ? '+ã‚¢ã‚¿ãƒƒãƒãƒ¡ãƒ³ãƒˆ' : ''}: ${capacity}`);
        } else if (machine.type === 'large') {
            baseMachineCapacity += 4;
            machineDetail.push(`å¤§å‹æ©Ÿæ¢°: 4`);
        }
    });
    
    const computerBonus = company.chips.computer || 0;
    const machineCapacity = baseMachineCapacity + computerBonus;
    const workerCapacity = company.workers + (company.chips.education || 0);
    const finalCapacity = Math.min(machineCapacity, workerCapacity);
    
    const content = `
        <div class="breakdown-list">
            <h3>è£½é€ èƒ½åŠ›ã®è©³ç´°</h3>
            ${machineDetail.map(d => `<div class="breakdown-item"><span>${d}</span></div>`).join('')}
            ${computerBonus > 0 ? `<div class="breakdown-item"><span>ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ãƒãƒƒãƒ—: +${computerBonus}</span></div>` : ''}
            <div class="breakdown-item"><span>æ©Ÿæ¢°èƒ½åŠ›è¨ˆ: ${machineCapacity}</span></div>
            <hr>
            <div class="breakdown-item"><span>ãƒ¯ãƒ¼ã‚«ãƒ¼: ${company.workers}</span></div>
            ${company.chips.education > 0 ? `<div class="breakdown-item"><span>æ•™è‚²ãƒãƒƒãƒ—: +${company.chips.education}</span></div>` : ''}
            <div class="breakdown-item"><span>ãƒ¯ãƒ¼ã‚«ãƒ¼èƒ½åŠ›è¨ˆ: ${workerCapacity}</span></div>
            <hr>
            <div class="breakdown-item breakdown-total"><span>è£½é€ èƒ½åŠ›</span><span>MIN(${machineCapacity}, ${workerCapacity}) = ${finalCapacity}</span></div>
        </div>
    `;
    
    showModal(`${company.name}ã®è£½é€ èƒ½åŠ›`, content);
}

// Show other players bid modal
function showOtherPlayersBidModal(market, marketIndex) {
    const content = `
        <div class="bid-display">
            <div class="bid-title">ä»–ç¤¾ã®å…¥æœ­å‚åŠ </div>
            <p>å¸‚å ´: ${market.name} (æœ€å¤§ä¾¡æ ¼: Â¥${market.sellPrice})</p>
            <p>ã‚ãªãŸã®å…¥æœ­: Â¥${gameState.pendingBid.displayPrice || gameState.pendingBid.price} Ã— ${gameState.pendingBid.quantity}å€‹</p>
            <p style="color: #666; font-size: 12px;">ä»–ç¤¾ã‚‚å…¥æœ­ã«å‚åŠ ã—ã¾ã™ï¼ˆé‡‘é¡ã¯éå…¬é–‹ï¼‰</p>
            <button class="submit-btn" onclick="processBidsWithAllCompanies(${marketIndex})">å…¥æœ­çµæœã‚’ç¢ºèª</button>
            <button class="cancel-btn" onclick="cancelPlayerBid()" style="margin-top: 10px;">å…¥æœ­ã«å‚åŠ ã—ãªã„</button>
        </div>
    `;
    
    showModal('å…¥æœ­å‚åŠ ç¢ºèª', content);
}

// Cancel player bid
function cancelPlayerBid() {
    // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®å…¥æœ­ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ï¼ˆãŠé‡‘ã®æµã‚ŒãŒãªã„ã®ã§è¡Œã‚’æ¶ˆè²»ã—ãªã„ï¼‰
    gameState.pendingBid = null;
    closeModal();
    showToast('å…¥æœ­ã¸ã®å‚åŠ ã‚’å–ã‚Šã‚„ã‚ã¾ã—ãŸ', 'info', 3000);
    nextTurn();
}

// Process bids with all companies
function processBidsWithAllCompanies(marketIndex) {
    const market = gameState.markets[marketIndex];
    const allBids = [gameState.pendingBid];
    
    // AI companies also bid
    for (let i = 1; i < gameState.companies.length; i++) {
        const aiCompany = gameState.companies[i];
        if (aiCompany.products > 0) {
            const aiSalesCapacity = getSalesCapacity(aiCompany);
            const aiQuantity = Math.min(aiSalesCapacity, aiCompany.products);
            if (aiQuantity > 0) {
                // AIãŒè¦ªã®å ´åˆã€2å††ã®ä¾¡æ ¼ç«¶äº‰åŠ›ã‚’è¿½åŠ 
                const isAIParent = (gameState.currentPlayerIndex === i);
                const aiDisplayPrice = Math.floor(market.sellPrice * (0.7 + Math.random() * 0.25));
                const aiPrice = aiDisplayPrice - getPriceCompetitiveness(aiCompany, isAIParent);
                allBids.push({
                    company: i, 
                    price: aiPrice, 
                    quantity: aiQuantity,
                    displayPrice: aiDisplayPrice
                });
            }
        }
    }
    
    // Sort by: 1) price (lowest), 2) research chips (most), 3) parent (priority)
    allBids.sort((a, b) => {
        // First compare actual bid price
        if (a.price !== b.price) return a.price - b.price;
        
        // Same price: compare research chips (more chips wins)
        const aResearch = gameState.companies[a.company].chips.research || 0;
        const bResearch = gameState.companies[b.company].chips.research || 0;
        if (aResearch !== bResearch) return bResearch - aResearch;
        
        // Same research chips: parent wins
        const aIsParent = (gameState.currentPlayerIndex === a.company);
        const bIsParent = (gameState.currentPlayerIndex === b.company);
        if (aIsParent && !bIsParent) return -1;
        if (!aIsParent && bIsParent) return 1;
        
        return 0;
    });
    
    // å…¥æœ­çµæœã‚’å‡¦ç†ï¼ˆè²©å£²ä¸Šé™ã¯è¦ªã®å‡ºã—ãŸå€‹æ•°ï¼‰
    // è¦ªã®å…¥æœ­æ•°é‡ã‚’è²©å£²ä¸Šé™ã¨ã™ã‚‹ï¼ˆå¸‚å ´æ ã¨ã‚‚æ¯”è¼ƒï¼‰
    const parentBid = allBids.find(b => b.company === gameState.currentPlayerIndex);
    const parentQuantity = parentBid ? parentBid.quantity : (gameState.pendingBid ? gameState.pendingBid.quantity : 3);
    let remainingCapacity = Math.min(parentQuantity, market.maxStock - market.currentStock);
    let salesResults = [];

    // å…¥æœ­é †ï¼ˆä¾¡æ ¼ãŒä½ã„é †ï¼‰ã«å¸‚å ´æ ã‚’å‰²ã‚Šå½“ã¦
    for (const bid of allBids) {
        if (remainingCapacity <= 0) break;

        const bidCompany = gameState.companies[bid.company];
        const actualQty = Math.min(bid.quantity, remainingCapacity, bidCompany.products);

        if (actualQty > 0) {
            const salePrice = bid.displayPrice || bid.price;
            const revenue = salePrice * actualQty;
            bidCompany.cash += revenue;
            bidCompany.products -= actualQty;
            bidCompany.totalSales += revenue;
            bidCompany.totalSoldQuantity = (bidCompany.totalSoldQuantity || 0) + actualQty;
            market.currentStock += actualQty;
            remainingCapacity -= actualQty;

            // è¡Œå‹•ãƒ­ã‚°è¨˜éŒ²
            logAction(bid.company, 'å•†å“è²©å£²', `${market.name}ã«Â¥${salePrice}Ã—${actualQty}å€‹`, revenue, true);

            salesResults.push({
                company: bidCompany,
                quantity: actualQty,
                price: salePrice,
                bid: bid
            });
        }
    }

    // å…¥æœ­çµæœã®è¡¨ç¤º
    let bidResultHtml = '<div class="bid-display">';
    bidResultHtml += '<div class="bid-title">å…¥æœ­çµæœ</div>';

    // è²©å£²æˆåŠŸè€…ã‚’è¡¨ç¤º
    salesResults.forEach((result, index) => {
        const researchChips = result.company.chips.research || 0;
        const isParent = (gameState.currentPlayerIndex === result.bid.company);
        const bgColor = index === 0 ? '#d4edda' : '#fef3c7';
        const callPrice = result.bid.price;  // ã‚³ãƒ¼ãƒ«ä¾¡æ ¼ï¼ˆå‹æ•—åˆ¤å®šç”¨ï¼‰
        const recordPrice = result.bid.displayPrice || result.bid.price;  // è¨˜å¸³ä¾¡æ ¼ï¼ˆå£²ä¸Šè¨ˆä¸Šç”¨ï¼‰

        bidResultHtml += `<div style="background: ${bgColor}; padding: 10px; margin: 10px 0; border-radius: 5px;">`;
        bidResultHtml += `<strong>${index === 0 ? 'ğŸ† 1ä½è½æœ­' : 'âœ“ æ®‹æ è²©å£²'}: ${result.company.name}</strong><br>`;
        bidResultHtml += `<div style="display: flex; gap: 15px; margin: 5px 0;">`;
        bidResultHtml += `<span style="font-size: 12px; color: #666;">ã‚³ãƒ¼ãƒ«ä¾¡æ ¼: Â¥${callPrice}</span>`;
        bidResultHtml += `<span style="font-size: 12px; color: #2563eb;">è¨˜å¸³ä¾¡æ ¼: Â¥${recordPrice}</span>`;
        bidResultHtml += `</div>`;
        bidResultHtml += `æ•°é‡: ${result.quantity}å€‹<br>`;
        if (researchChips > 0 || isParent) {
            bidResultHtml += '<div style="font-size: 12px; margin-top: 5px; color: #666;">ã€ä¾¡æ ¼ç«¶äº‰åŠ›ã€‘';
            if (researchChips > 0) {
                bidResultHtml += ` ç ”ç©¶${researchChips}æš(-${researchChips * 2}å††)`;
            }
            if (isParent) {
                bidResultHtml += ` è¦ª(-2å††)`;
            }
            bidResultHtml += '</div>';
        }
        bidResultHtml += `<strong>å£²ä¸Šé‡‘é¡: Â¥${recordPrice * result.quantity}</strong>`;
        bidResultHtml += '</div>';
    });

    // å…¥æœ­ã—ãŸãŒå£²ã‚Œãªã‹ã£ãŸè€…
    const unsoldBids = allBids.filter(bid =>
        !salesResults.some(result => result.bid === bid)
    );

    if (unsoldBids.length > 0) {
        bidResultHtml += '<div class="bid-entries">';
        bidResultHtml += '<div style="font-size: 12px; color: #666; margin-bottom: 5px;">å…¥æœ­ã—ãŸãŒå£²ã‚Œãªã‹ã£ãŸ:</div>';
        unsoldBids.forEach((bid) => {
            const bidCompany = gameState.companies[bid.company];
            const callPrice = bid.price;  // ã‚³ãƒ¼ãƒ«ä¾¡æ ¼
            const recordPrice = bid.displayPrice || bid.price;  // è¨˜å¸³ä¾¡æ ¼

            bidResultHtml += `
                <div class="bid-entry" style="color: #9ca3af; padding: 5px;">
                    <span>${bidCompany.name}</span>
                    <span style="font-size: 11px;">ã‚³ãƒ¼ãƒ«Â¥${callPrice} / è¨˜å¸³Â¥${recordPrice} Ã— ${bid.quantity}å€‹ï¼ˆå¸‚å ´æ ãªã—ï¼‰</span>
                </div>
            `;
        });
        bidResultHtml += '</div>';
    }

    bidResultHtml += '</div>';

    closeModal();
    showModal('å…¥æœ­çµæœ', bidResultHtml + '<button class="submit-btn" onclick="completeSale()">OK</button>');

    // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¸ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¨ãƒ•ãƒ©ã‚°è¨­å®š
    const playerResult = salesResults.find(r => r.bid.company === 0);
    if (playerResult) {
        gameState.lastSaleInfo = `ã€å…¥æœ­çµæœã€‘\nã‚ãªãŸã¯${market.name}ã«${playerResult.quantity}å€‹ã‚’Â¥${playerResult.price * playerResult.quantity}ã§è²©å£²ã—ã¾ã—ãŸ`;
        gameState.playerSoldInBid = true;  // ãŠé‡‘ã®æµã‚ŒãŒã‚ã£ãŸ
    } else {
        gameState.lastSaleInfo = `ã€å…¥æœ­çµæœã€‘\n${market.name}ã¸ã®å…¥æœ­ã¯ä»–ç¤¾ã«è² ã‘ã¾ã—ãŸ`;
        gameState.playerSoldInBid = false;  // ãŠé‡‘ã®æµã‚ŒãŒãªã‹ã£ãŸ
    }

    // Clear pending bid
    gameState.pendingBid = null;
}

// 2å¸‚å ´åŒæ™‚è²©å£²ã®ä»–ç¤¾å…¥æœ­ãƒ¢ãƒ¼ãƒ€ãƒ«
function showOtherPlayersBidModalTwoMarket() {
    const market1 = gameState.markets[gameState.selectedMarkets[0]];
    const market2 = gameState.markets[gameState.selectedMarkets[1]];
    const maxPrice = Math.min(market1.sellPrice, market2.sellPrice);

    const content = `
        <div class="bid-display">
            <div class="bid-title">2å¸‚å ´åŒæ™‚å…¥æœ­ - ä»–ç¤¾å‚åŠ </div>
            <p>å¸‚å ´: ${market1.name} + ${market2.name}</p>
            <p>é©ç”¨ä¸Šé™ä¾¡æ ¼: Â¥${maxPrice}</p>
            <p>ã‚ãªãŸã®å…¥æœ­: Â¥${gameState.pendingBid.displayPrice} Ã— ${gameState.pendingBid.quantity}å€‹</p>
            <p style="color: #666; font-size: 12px;">ä»–ç¤¾ã‚‚å…¥æœ­ã«å‚åŠ ã—ã¾ã™ï¼ˆé‡‘é¡ã¯éå…¬é–‹ï¼‰</p>
            <button class="submit-btn" onclick="processBidsWithAllCompaniesTwoMarket()">å…¥æœ­çµæœã‚’ç¢ºèª</button>
            <button class="cancel-btn" onclick="cancelPlayerBidTwoMarket()" style="margin-top: 10px;">å…¥æœ­ã«å‚åŠ ã—ãªã„</button>
        </div>
    `;

    showModal('2å¸‚å ´åŒæ™‚å…¥æœ­', content);
}

// 2å¸‚å ´åŒæ™‚å…¥æœ­ã®ã‚­ãƒ£ãƒ³ã‚»ãƒ«
function cancelPlayerBidTwoMarket() {
    // ãŠé‡‘ã®æµã‚ŒãŒãªã„ã®ã§è¡Œã‚’æ¶ˆè²»ã—ãªã„
    gameState.pendingBid = null;
    gameState.selectedMarkets = [];
    gameState.twoMarketMode = false;
    closeModal();
    showToast('å…¥æœ­ã¸ã®å‚åŠ ã‚’å–ã‚Šã‚„ã‚ã¾ã—ãŸ', 'info', 3000);
    nextTurn();
}

// 2å¸‚å ´åŒæ™‚å…¥æœ­ã®å‡¦ç†
function processBidsWithAllCompaniesTwoMarket() {
    const market1 = gameState.markets[gameState.selectedMarkets[0]];
    const market2 = gameState.markets[gameState.selectedMarkets[1]];
    const maxPrice = Math.min(market1.sellPrice, market2.sellPrice);

    const allBids = [gameState.pendingBid];

    // AI companies also bid (2å¸‚å ´åŒæ™‚)
    for (let i = 1; i < gameState.companies.length; i++) {
        const aiCompany = gameState.companies[i];
        if (aiCompany.products >= 2) {  // 2å¸‚å ´åŒæ™‚ã¯2å€‹ä»¥ä¸Šå¿…è¦
            const aiSalesCapacity = getSalesCapacity(aiCompany);
            const aiQuantity = Math.min(aiSalesCapacity, aiCompany.products);
            if (aiQuantity >= 2) {
                const isAIParent = (gameState.currentPlayerIndex === i);
                const aiDisplayPrice = Math.floor(maxPrice * (0.7 + Math.random() * 0.25));
                const aiPrice = aiDisplayPrice - getPriceCompetitiveness(aiCompany, isAIParent);
                allBids.push({
                    company: i,
                    price: aiPrice,
                    quantity: aiQuantity,
                    displayPrice: aiDisplayPrice,
                    isTwoMarket: true
                });
            }
        }
    }

    // Sort by: 1) price (lowest), 2) research chips (most), 3) parent (priority)
    allBids.sort((a, b) => {
        if (a.price !== b.price) return a.price - b.price;
        const aResearch = gameState.companies[a.company].chips.research || 0;
        const bResearch = gameState.companies[b.company].chips.research || 0;
        if (aResearch !== bResearch) return bResearch - aResearch;
        const aIsParent = (gameState.currentPlayerIndex === a.company);
        const bIsParent = (gameState.currentPlayerIndex === b.company);
        if (aIsParent && !bIsParent) return -1;
        if (!aIsParent && bIsParent) return 1;
        return 0;
    });

    // 2å¸‚å ´ã®åˆè¨ˆå®¹é‡
    const volume1 = market1.maxStock - market1.currentStock;
    const volume2 = market2.maxStock - market2.currentStock;
    const parentBid = allBids.find(b => b.company === gameState.currentPlayerIndex);
    const parentQuantity = parentBid ? parentBid.quantity : gameState.pendingBid.quantity;
    let remainingCapacity = Math.min(parentQuantity, volume1 + volume2);
    let salesResults = [];

    // å…¥æœ­é †ã«å‰²ã‚Šå½“ã¦
    for (const bid of allBids) {
        if (remainingCapacity <= 0) break;

        const bidCompany = gameState.companies[bid.company];
        const actualQty = Math.min(bid.quantity, remainingCapacity, bidCompany.products);

        if (actualQty > 0) {
            const salePrice = bid.displayPrice || bid.price;
            const revenue = salePrice * actualQty;
            bidCompany.cash += revenue;
            bidCompany.products -= actualQty;
            bidCompany.totalSales += revenue;
            bidCompany.totalSoldQuantity = (bidCompany.totalSoldQuantity || 0) + actualQty;

            // 2å¸‚å ´ã«åˆ†é…
            let remainingQty = actualQty;
            if (market1.currentStock < market1.maxStock && remainingQty > 0) {
                const toMarket1 = Math.min(remainingQty, market1.maxStock - market1.currentStock);
                market1.currentStock += toMarket1;
                remainingQty -= toMarket1;
            }
            if (market2.currentStock < market2.maxStock && remainingQty > 0) {
                const toMarket2 = Math.min(remainingQty, market2.maxStock - market2.currentStock);
                market2.currentStock += toMarket2;
            }

            remainingCapacity -= actualQty;

            // è¡Œå‹•ãƒ­ã‚°è¨˜éŒ²
            logAction(bid.company, 'å•†å“è²©å£²', `${market1.name}+${market2.name}ã«Â¥${salePrice}Ã—${actualQty}å€‹`, revenue, true);

            salesResults.push({
                company: bidCompany,
                quantity: actualQty,
                price: salePrice,
                bid: bid
            });
        }
    }

    // å…¥æœ­çµæœã®è¡¨ç¤º
    let bidResultHtml = '<div class="bid-display">';
    bidResultHtml += '<div class="bid-title">2å¸‚å ´åŒæ™‚å…¥æœ­ çµæœ</div>';
    bidResultHtml += `<p style="margin-bottom: 10px;">${market1.name} + ${market2.name}</p>`;

    salesResults.forEach((result, index) => {
        const researchChips = result.company.chips.research || 0;
        const isParent = (gameState.currentPlayerIndex === result.bid.company);
        const bgColor = index === 0 ? '#d4edda' : '#fef3c7';
        const callPrice = result.bid.price;  // ã‚³ãƒ¼ãƒ«ä¾¡æ ¼ï¼ˆå‹æ•—åˆ¤å®šç”¨ï¼‰
        const recordPrice = result.bid.displayPrice || result.bid.price;  // è¨˜å¸³ä¾¡æ ¼ï¼ˆå£²ä¸Šè¨ˆä¸Šç”¨ï¼‰

        bidResultHtml += `<div style="background: ${bgColor}; padding: 10px; margin: 10px 0; border-radius: 5px;">`;
        bidResultHtml += `<strong>${index === 0 ? 'ğŸ† 1ä½è½æœ­' : 'âœ“ æ®‹æ è²©å£²'}: ${result.company.name}</strong><br>`;
        bidResultHtml += `<div style="display: flex; gap: 15px; margin: 5px 0;">`;
        bidResultHtml += `<span style="font-size: 12px; color: #666;">ã‚³ãƒ¼ãƒ«ä¾¡æ ¼: Â¥${callPrice}</span>`;
        bidResultHtml += `<span style="font-size: 12px; color: #2563eb;">è¨˜å¸³ä¾¡æ ¼: Â¥${recordPrice}</span>`;
        bidResultHtml += `</div>`;
        bidResultHtml += `æ•°é‡: ${result.quantity}å€‹<br>`;
        if (researchChips > 0 || isParent) {
            bidResultHtml += '<div style="font-size: 12px; margin-top: 5px; color: #666;">ã€ä¾¡æ ¼ç«¶äº‰åŠ›ã€‘';
            if (researchChips > 0) {
                bidResultHtml += ` ç ”ç©¶${researchChips}æš(-${researchChips * 2}å††)`;
            }
            if (isParent) {
                bidResultHtml += ` è¦ª(-2å††)`;
            }
            bidResultHtml += '</div>';
        }
        bidResultHtml += `<strong>å£²ä¸Šé‡‘é¡: Â¥${recordPrice * result.quantity}</strong>`;
        bidResultHtml += '</div>';
    });

    const unsoldBids = allBids.filter(bid =>
        !salesResults.some(result => result.bid === bid)
    );

    if (unsoldBids.length > 0) {
        bidResultHtml += '<div class="bid-entries">';
        bidResultHtml += '<div style="font-size: 12px; color: #666; margin-bottom: 5px;">å…¥æœ­ã—ãŸãŒå£²ã‚Œãªã‹ã£ãŸ:</div>';
        unsoldBids.forEach((bid) => {
            const bidCompany = gameState.companies[bid.company];
            const callPrice = bid.price;  // ã‚³ãƒ¼ãƒ«ä¾¡æ ¼
            const recordPrice = bid.displayPrice || bid.price;  // è¨˜å¸³ä¾¡æ ¼
            bidResultHtml += `
                <div class="bid-entry" style="color: #9ca3af; padding: 5px;">
                    <span>${bidCompany.name}</span>
                    <span style="font-size: 11px;">ã‚³ãƒ¼ãƒ«Â¥${callPrice} / è¨˜å¸³Â¥${recordPrice} Ã— ${bid.quantity}å€‹ï¼ˆå¸‚å ´æ ãªã—ï¼‰</span>
                </div>
            `;
        });
        bidResultHtml += '</div>';
    }

    bidResultHtml += '</div>';

    closeModal();
    showModal('2å¸‚å ´åŒæ™‚å…¥æœ­ çµæœ', bidResultHtml + '<button class="submit-btn" onclick="completeSaleTwoMarket()">OK</button>');

    // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¸ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¨ãƒ•ãƒ©ã‚°è¨­å®š
    const playerResult = salesResults.find(r => r.bid.company === 0);
    if (playerResult) {
        gameState.lastSaleInfo = `ã€2å¸‚å ´åŒæ™‚å…¥æœ­çµæœã€‘\n${market1.name}+${market2.name}ã«${playerResult.quantity}å€‹ã‚’Â¥${playerResult.price * playerResult.quantity}ã§è²©å£²ã—ã¾ã—ãŸ`;
        gameState.playerSoldInBid = true;  // ãŠé‡‘ã®æµã‚ŒãŒã‚ã£ãŸ
    } else {
        gameState.lastSaleInfo = `ã€2å¸‚å ´åŒæ™‚å…¥æœ­çµæœã€‘\nå…¥æœ­ã¯ä»–ç¤¾ã«è² ã‘ã¾ã—ãŸ`;
        gameState.playerSoldInBid = false;  // ãŠé‡‘ã®æµã‚ŒãŒãªã‹ã£ãŸ
    }

    gameState.pendingBid = null;
    gameState.selectedMarkets = [];
    gameState.twoMarketMode = false;
}

// 2å¸‚å ´åŒæ™‚è²©å£²å®Œäº†
function completeSaleTwoMarket() {
    closeModal();
    updateDisplay();

    // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒå®Ÿéš›ã«è²©å£²ã—ãŸå ´åˆã®ã¿1è¡Œä½¿ç”¨ï¼ˆãŠé‡‘ã®æµã‚ŒãŒã‚ã£ãŸå ´åˆï¼‰
    const playerSold = gameState.playerSoldInBid;
    gameState.playerSoldInBid = null;  // ãƒ•ãƒ©ã‚°ã‚’ãƒªã‚»ãƒƒãƒˆ

    if (playerSold) {
        endTurn();
    } else {
        nextTurn();
    }
}

// å„ç¤¾ã®æ±ºç®—ã‚’å€‹åˆ¥ã«è¡¨ç¤º
function showCompanySettlement(index, financialData) {
    if (index >= financialData.length) {
        // å…¨ç¤¾è¡¨ç¤ºå®Œäº†ã€ã‚µãƒãƒªãƒ¼ã‚’è¡¨ç¤º
        showFinancialSummary(financialData);
        return;
    }

    const data = financialData[index];
    const company = gameState.companies[index];
    const isPlayer = index === 0;

    // PQ/VQ/MQ/Gè¨ˆç®—
    const pq = data.pq;
    const vq = data.vq;
    const mq = data.mq;
    const f = data.f;
    const g = data.g;
    const q = data.q;

    const companyEmojis = { 'ã‚ãªãŸ': 'ğŸ‘¤', 'Aç¤¾': 'ğŸ…°ï¸', 'Bç¤¾': 'ğŸ…±ï¸', 'Cç¤¾': 'Â©ï¸', 'Dç¤¾': 'ğŸ‡©', 'Eç¤¾': 'ğŸ‡ª' };
    const emoji = companyEmojis[company.name] || 'ğŸ¢';

    const content = `
        <div style="padding: 20px;">
            <div style="text-align: center; margin-bottom: 20px;">
                <div style="font-size: 48px; margin-bottom: 10px;">${emoji}</div>
                <div style="font-size: 24px; font-weight: bold; color: ${isPlayer ? '#2563eb' : '#374151'};">${company.name}</div>
                <div style="font-size: 14px; color: #666;">ç¬¬${gameState.currentPeriod}æœŸ æ±ºç®—</div>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                <div style="background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%); color: white; padding: 15px; border-radius: 12px; text-align: center;">
                    <div style="font-size: 12px; opacity: 0.8;">å£²ä¸Šé«˜ (PQ)</div>
                    <div style="font-size: 24px; font-weight: bold;">Â¥${pq}</div>
                </div>
                <div style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; padding: 15px; border-radius: 12px; text-align: center;">
                    <div style="font-size: 12px; opacity: 0.8;">å¤‰å‹•è²» (VQ)</div>
                    <div style="font-size: 24px; font-weight: bold;">Â¥${vq}</div>
                </div>
                <div style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; padding: 15px; border-radius: 12px; text-align: center;">
                    <div style="font-size: 12px; opacity: 0.8;">ä»˜åŠ ä¾¡å€¤ (MQ)</div>
                    <div style="font-size: 24px; font-weight: bold;">Â¥${mq}</div>
                </div>
                <div style="background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%); color: white; padding: 15px; border-radius: 12px; text-align: center;">
                    <div style="font-size: 12px; opacity: 0.8;">å›ºå®šè²» (F)</div>
                    <div style="font-size: 24px; font-weight: bold;">Â¥${f}</div>
                </div>
            </div>

            <div style="background: ${g >= 0 ? 'linear-gradient(135deg, #22c55e 0%, #16a34a 100%)' : 'linear-gradient(135deg, #ef4444 0%, #dc2626 100%)'}; color: white; padding: 20px; border-radius: 12px; text-align: center; margin-bottom: 20px;">
                <div style="font-size: 14px; opacity: 0.9;">åˆ©ç›Š (G = MQ - F)</div>
                <div style="font-size: 36px; font-weight: bold;">${g >= 0 ? '+' : ''}Â¥${g}</div>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 20px;">
                <div style="background: #f1f5f9; padding: 10px; border-radius: 8px; text-align: center;">
                    <div style="font-size: 10px; color: #64748b;">è²©å£²å€‹æ•° (Q)</div>
                    <div style="font-size: 18px; font-weight: bold;">${q}å€‹</div>
                </div>
                <div style="background: #f1f5f9; padding: 10px; border-radius: 8px; text-align: center;">
                    <div style="font-size: 10px; color: #64748b;">å¹³å‡P</div>
                    <div style="font-size: 18px; font-weight: bold;">${data.p.toFixed(1)}</div>
                </div>
                <div style="background: #f1f5f9; padding: 10px; border-radius: 8px; text-align: center;">
                    <div style="font-size: 10px; color: #64748b;">å¹³å‡M</div>
                    <div style="font-size: 18px; font-weight: bold;">${data.m.toFixed(1)}</div>
                </div>
            </div>

            <div style="background: #e0f2fe; padding: 15px; border-radius: 12px; margin-bottom: 20px;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span style="font-size: 14px; color: #0369a1;">è‡ªå·±è³‡æœ¬</span>
                    <span style="font-size: 24px; font-weight: bold; color: #0369a1;">Â¥${company.equity}</span>
                </div>
            </div>

            <div style="text-align: center;">
                <button class="action-btn primary" onclick="showNextCompanySettlement()" style="padding: 15px 40px; font-size: 16px;">
                    ${index < financialData.length - 1 ? `æ¬¡ã¸ï¼ˆ${financialData[index + 1].name}ï¼‰` : 'å…¨ç¤¾ã‚µãƒãƒªãƒ¼ã‚’è¡¨ç¤º'}
                </button>
            </div>
        </div>
    `;

    showModal(`${company.name} æ±ºç®—çµæœ`, content);
}

// æ¬¡ã®ä¼šç¤¾ã®æ±ºç®—ã‚’è¡¨ç¤º
function showNextCompanySettlement() {
    closeModal();
    window.currentSettlementIndex++;
    showCompanySettlement(window.currentSettlementIndex, window.lastFinancialData);
}

// Show financial summary with detailed calculations
// æ¨ªè»¸ï¼šãƒ¡ãƒ³ãƒãƒ¼ã€ç¸¦è»¸ï¼šé …ç›®ã®è¡¨å½¢å¼
function showFinancialSummary(financialData) {
    // å„ç¤¾ã®è‡ªå·±è³‡æœ¬ã‚’å–å¾—
    const equities = gameState.companies.map(c => c.equity);

    // é …ç›®å®šç¾©ï¼ˆç¸¦è»¸ï¼‰
    const items = [
        { key: 'equity', label: 'è‡ªå·±è³‡æœ¬', format: v => `Â¥${v}` },
        { key: 'p', label: 'å¹³å‡P', format: v => v.toFixed(1) },
        { key: 'v', label: 'å¹³å‡V', format: v => v.toFixed(1) },
        { key: 'm', label: 'å¹³å‡M', format: v => v.toFixed(1) },
        { key: 'q', label: 'Q', format: v => v },
        { key: 'pq', label: 'PQ', format: v => `Â¥${v}` },
        { key: 'vq', label: 'VQ', format: v => `Â¥${v}` },
        { key: 'mq', label: 'MQ', format: v => `Â¥${v}` },
        { key: 'f', label: 'F', format: v => `Â¥${v}` },
        { key: 'g', label: 'G', format: v => `Â¥${v}`, highlight: true }
    ];

    // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œï¼ˆä¼šç¤¾åï¼‰
    let html = `
        <div style="overflow-x: auto;">
            <table style="width: 100%; border-collapse: collapse; font-size: 11px;">
                <thead>
                    <tr style="background: #1e40af; color: white;">
                        <th style="border: 1px solid #3b82f6; padding: 6px; text-align: left;">é …ç›®</th>
    `;

    financialData.forEach((data, index) => {
        const isPlayer = index === 0;
        html += `<th style="border: 1px solid #3b82f6; padding: 6px; text-align: center; background: ${isPlayer ? '#2563eb' : '#1e40af'}; min-width: 60px;">${data.name.replace('ç¤¾', '')}</th>`;
    });
    html += '</tr></thead><tbody>';

    // å„é …ç›®ã®è¡Œã‚’ç”Ÿæˆ
    items.forEach(item => {
        html += `<tr>
            <td style="border: 1px solid #dee2e6; padding: 6px; background: #f1f5f9; font-weight: bold;">${item.label}</td>`;

        financialData.forEach((data, index) => {
            const isPlayer = index === 0;
            let value;
            if (item.key === 'equity') {
                value = equities[index];
            } else {
                value = data[item.key];
            }

            const formatted = item.format(value);
            let style = `border: 1px solid #dee2e6; padding: 6px; text-align: right;`;
            if (isPlayer) style += ' background: #e0f2fe;';
            if (item.highlight) {
                style += value >= 0 ? ' color: #16a34a; font-weight: bold;' : ' color: #dc2626; font-weight: bold;';
            }

            html += `<td style="${style}">${formatted}</td>`;
        });
        html += '</tr>';
    });

    html += `
                </tbody>
            </table>
        </div>
        <div style="margin-top: 10px; font-size: 10px; color: #666;">
            <p>å¹³å‡P = PQÃ·Qã€å¹³å‡V = VQÃ·Qã€å¹³å‡M = MQÃ·Q</p>
            <p>MQ = PQ - VQã€G = MQ - F</p>
        </div>
        <div style="display: flex; gap: 10px; margin-top: 15px;">
            <button class="cancel-btn" onclick="showActionLogModal()" style="flex: 1;">è¡Œå‹•ãƒ­ã‚°ã‚’è¦‹ã‚‹</button>
            <button class="submit-btn" onclick="closeModal(); proceedToNextPeriod();" style="flex: 1;">æ¬¡æœŸã¸é€²ã‚€</button>
        </div>
    `;

    showModal(`ç¬¬${gameState.currentPeriod}æœŸ æ±ºç®—çµæœ`, html);
}

// Show detailed financial calculations for a company
function showFinancialDetails(companyIndex) {
    const company = gameState.companies[companyIndex];
    const pq = company.totalSales;
    const vq = calculateVQ(company);
    const mq = pq - vq;
    const fixedCosts = calculateFixedCost(company);
    const g = mq - fixedCosts - (company.specialLoss || 0);
    
    // Q = è²©å£²å€‹æ•°
    const q = company.totalSoldQuantity || 0;
    
    // åœ¨åº«æ•°é‡
    const inventoryP = company.products || 0;
    const inventoryV = company.wip || 0;
    const inventoryM = company.materials || 0;
    
    // VQã®è©³ç´°è¨ˆç®—
    const materialCost = company.totalMaterialCost || 0;
    const productionCost = company.totalProductionCost || 0;
    const endInventoryValue = (inventoryM * 13) + (inventoryV * 14) + (inventoryP * 15);
    const startInventoryValue = (company.periodStartInventory.materials * 13) + 
                               (company.periodStartInventory.wip * 14) + 
                               (company.periodStartInventory.products * 15);
    
    let html = `
        <div class="breakdown-list" style="max-height: 500px; overflow-y: auto;">
            <h3>${company.name}ã®è²¡å‹™è©³ç´°</h3>
            
            <div class="breakdown-item breakdown-total"><span>ã€PQï¼šå£²ä¸Šé«˜ã€‘</span><span>Â¥${pq}</span></div>
            <div class="breakdown-item" style="font-size: 11px;"><span>ã€€æœŸä¸­å£²ä¸Šç´¯è¨ˆ</span><span>Â¥${pq}</span></div>
            
            <div class="breakdown-item breakdown-total"><span>ã€VQï¼šå¤‰å‹•è²»ç·é¡ã€‘</span><span>Â¥${vq}</span></div>
            <div class="breakdown-item" style="font-size: 11px;"><span>ã€€â‘ ææ–™è³¼å…¥è²»</span><span>Â¥${materialCost}</span></div>
            <div class="breakdown-item" style="font-size: 11px;"><span>ã€€â‘¡å®ŒæˆæŠ•å…¥è²»</span><span>Â¥${productionCost}</span></div>
            <div class="breakdown-item" style="font-size: 11px;"><span>ã€€â‘¢æœŸé¦–åœ¨åº«è©•ä¾¡é¡</span><span>Â¥${startInventoryValue}</span></div>
            <div class="breakdown-item" style="font-size: 11px; color: #666;"><span>ã€€ã€€(æ${company.periodStartInventory.materials}Ã—13 + ä»•${company.periodStartInventory.wip}Ã—14 + è£½${company.periodStartInventory.products}Ã—15)</span><span></span></div>
            <div class="breakdown-item" style="font-size: 11px;"><span>ã€€â‘£æœŸæœ«åœ¨åº«è©•ä¾¡é¡</span><span>-Â¥${endInventoryValue}</span></div>
            <div class="breakdown-item" style="font-size: 11px; color: #666;"><span>ã€€ã€€(æ${inventoryM}Ã—13 + ä»•${inventoryV}Ã—14 + è£½${inventoryP}Ã—15)</span><span></span></div>
            <div class="breakdown-item" style="font-size: 11px; color: #28a745;"><span>ã€€VQ = â‘ +â‘¡+â‘¢-â‘£</span><span>Â¥${vq}</span></div>
            
            <div class="breakdown-item breakdown-total"><span>ã€MQï¼šä»˜åŠ ä¾¡å€¤ç·é¡ã€‘</span><span>Â¥${mq}</span></div>
            <div class="breakdown-item" style="font-size: 11px; color: #28a745;"><span>ã€€MQ = PQ - VQ</span><span>Â¥${pq} - Â¥${vq}</span></div>
            
            <div class="breakdown-item breakdown-total"><span>ã€Fã€‘</span><span>Â¥${fixedCosts}</span></div>
            <div class="breakdown-item" style="font-size: 11px;"><span>ã€€çµ¦æ–™</span><span>Â¥${calculateSalaryCost(company, gameState.currentPeriod)}</span></div>
            <div class="breakdown-item" style="font-size: 11px;"><span>ã€€ãƒãƒƒãƒ—è²»ç”¨</span><span>Â¥${calculateChipCost(company, gameState.currentPeriod)}</span></div>
            <div class="breakdown-item" style="font-size: 11px;"><span>ã€€æ¸›ä¾¡å„Ÿå´è²»</span><span>Â¥${calculateDepreciation(company, gameState.currentPeriod)}</span></div>
            ${company.additionalFixedCost ? `<div class="breakdown-item" style="font-size: 11px;"><span>ã€€ãƒªã‚¹ã‚¯ã‚«ãƒ¼ãƒ‰è²»ç”¨</span><span>Â¥${company.additionalFixedCost}</span></div>` : ''}
            ${company.extraLaborCost ? `<div class="breakdown-item" style="font-size: 11px;"><span>ã€€ãã®ä»–äººä»¶è²»</span><span>Â¥${company.extraLaborCost}</span></div>` : ''}
            ${company.specialLoss ? `<div class="breakdown-item" style="font-size: 11px;"><span>ã€€ç‰¹åˆ¥æå¤±</span><span>Â¥${company.specialLoss}</span></div>` : ''}
            
            <div class="breakdown-item breakdown-total"><span>ã€Gï¼šåˆ©ç›Šã€‘</span><span style="color: ${g >= 0 ? '#28a745' : '#dc3545'}">Â¥${g}</span></div>
            <div class="breakdown-item" style="font-size: 11px; color: #28a745;"><span>ã€€G = MQ - F</span><span>Â¥${mq} - Â¥${fixedCosts}</span></div>
            
            <div class="breakdown-item breakdown-total"><span>ã€Qï¼šè²©å£²å€‹æ•°ã€‘</span><span>${company.totalSoldQuantity || 0}å€‹</span></div>
            
            <div class="breakdown-item breakdown-total"><span>ã€æœŸæœ«åœ¨åº«ã€‘</span><span></span></div>
            <div class="breakdown-item" style="font-size: 11px;"><span>ã€€ææ–™</span><span>${inventoryM}å€‹</span></div>
            <div class="breakdown-item" style="font-size: 11px;"><span>ã€€ä»•æ›å“</span><span>${inventoryV}å€‹</span></div>
            <div class="breakdown-item" style="font-size: 11px;"><span>ã€€è£½å“</span><span>${inventoryP}å€‹</span></div>
            
            <div class="breakdown-item breakdown-total"><span>ã€å˜ä¾¡è¨ˆç®—ã€‘</span><span></span></div>
            <div class="breakdown-item" style="font-size: 11px;"><span>ã€€P = PQÃ·Q</span><span>Â¥${pq}Ã·${q} = ${q > 0 ? (pq/q).toFixed(1) : 'â€•'}</span></div>
            <div class="breakdown-item" style="font-size: 11px;"><span>ã€€V = VQÃ·Q</span><span>Â¥${vq}Ã·${q} = ${q > 0 ? (vq/q).toFixed(1) : 'â€•'}</span></div>
            <div class="breakdown-item" style="font-size: 11px;"><span>ã€€M = MQÃ·Q</span><span>Â¥${mq}Ã·${q} = ${q > 0 ? (mq/q).toFixed(1) : 'â€•'}</span></div>
        </div>
        <button class="submit-btn" onclick="closeModal();" style="margin-top: 10px;">é–‰ã˜ã‚‹</button>
    `;
    
    showModal(`${company.name}ã®è²¡å‹™è©³ç´°`, html);
}

// Store financial data for reference
window.lastFinancialData = [];

// Proceed to next period
function proceedToNextPeriod() {
    // Move to next period
    gameState.currentPeriod++;
    gameState.currentPlayerIndex = 0;
    // 2æœŸã¯æœŸé¦–å‡¦ç†ã§1è¡Œç›®ã‚’ä½¿ã†ã®ã§ã€1ã‹ã‚‰ã‚¹ã‚¿ãƒ¼ãƒˆ
    // 3-5æœŸã‚‚æœŸé¦–å‡¦ç†ãŒã‚ã‚‹ã®ã§1ã‹ã‚‰ã‚¹ã‚¿ãƒ¼ãƒˆ
    gameState.currentRow = 1;
    gameState.periodStarted = false;
    gameState.doNothingCount = {};

    // å„ç¤¾ã®ãƒ©ã‚¹ãƒˆ5è¡Œè­¦å‘Šãƒ•ãƒ©ã‚°ã‚’ãƒªã‚»ãƒƒãƒˆ
    gameState.companies.forEach(company => {
        company.last5RowWarningShown = false;
    });

    // ã‚«ãƒ¼ãƒ‰ãƒ‡ãƒƒã‚­ã‚’ãƒªã‚»ãƒƒãƒˆï¼ˆæ¯æœŸã‚·ãƒ£ãƒƒãƒ•ãƒ«ï¼‰
    initializeCardDeck();
    console.log(`ç¬¬${gameState.currentPeriod}æœŸé–‹å§‹ï¼šã‚«ãƒ¼ãƒ‰ãƒ‡ãƒƒã‚­ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ`);

    // ä½¿ç”¨æ¸ˆã¿ãƒªã‚¹ã‚¯ã‚«ãƒ¼ãƒ‰ã‚‚ãƒªã‚»ãƒƒãƒˆ
    gameState.usedRiskCards = [];
    
    // Set max rows based on period
    if (gameState.currentPeriod === 3) {
        gameState.maxRows = 30;
    } else if (gameState.currentPeriod === 4) {
        gameState.maxRows = 34;
    } else if (gameState.currentPeriod === 5) {
        gameState.maxRows = 35;
    }
    
    if (gameState.currentPeriod > 5) {
        endGame();
    } else {
        // Period 2: Auto-purchase chips and start from row 2
        if (gameState.currentPeriod === 2) {
            // æœŸé¦–å‡¦ç†ã¨ã—ã¦1è¡Œç›®ã‚’æ¶ˆè²»ã—ã€2è¡Œç›®ã‹ã‚‰é–‹å§‹
            gameState.maxRows = gameState.maxRowsByPeriod[2];  // 2æœŸã¯20è¡Œ
            gameState.currentRow = 2;  // æœŸé¦–å‡¦ç†æ¸ˆã¿ãªã®ã§2è¡Œç›®ã‹ã‚‰é–‹å§‹ï¼ˆå»ƒæ­¢äºˆå®šï¼‰
            
            // æœŸé¦–ã«è‡ªå‹•ã§ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ã¨ä¿é™ºã‚’è³¼å…¥
            gameState.companies.forEach(company => {
                const computerCost = 20;
                const insuranceCost = 5;
                const totalCost = computerCost + insuranceCost;
                
                // å„ç¤¾ã®è¡Œæ•°ã‚’2ã«è¨­å®šï¼ˆæœŸé¦–å‡¦ç†ã§1è¡Œä½¿ç”¨ï¼‰
                company.currentRow = 2;
                
                if (company.cash >= totalCost) {
                    company.cash -= totalCost;
                    company.chips.computer = 1;  // æ¯æœŸ1æšè³¼å…¥
                    company.chips.insurance = 1;
                } else {
                    // Apply short loan if needed
                    const needed = Math.ceil((totalCost - company.cash) / 0.8 / 50) * 50;
                    company.shortLoans += needed;
                    company.cash += needed * 0.8;  // çŸ­æœŸå€Ÿå…¥: å€Ÿå…¥æ™‚20%é‡‘åˆ©æ§é™¤
                    company.cash -= totalCost;
                    company.chips.computer = 1;
                    company.chips.insurance = 1;
                }
            });
            
            gameState.periodStarted = true;
            updateDisplay();
            showToast(`ç¬¬${gameState.currentPeriod}æœŸã‚’é–‹å§‹ã—ã¾ã™\nå…¨ç¤¾ï¼šã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ãƒãƒƒãƒ—(Â¥20)ã¨ä¿é™ºãƒãƒƒãƒ—(Â¥5)ã‚’è‡ªå‹•è³¼å…¥ã—ã¾ã—ãŸã€‚\næœŸé¦–å‡¦ç†ã«ã‚ˆã‚Š2è¡Œç›®ã‹ã‚‰ã‚²ãƒ¼ãƒ é–‹å§‹ã§ã™ã€‚`, 'success', 5000);

            // å¼·åˆ¶çš„ã«ã‚‚ã†ä¸€åº¦updateDisplay()ã‚’å‘¼ã‚“ã§ç¢ºå®Ÿã«2è¡Œç›®è¡¨ç¤º
            setTimeout(() => {
                updateDisplay();
                saveGame();  // æœŸé¦–ã‚’è‡ªå‹•ã‚»ãƒ¼ãƒ–
                showTurnStartOptions();
            }, 100);
        } else {
            // Periods 3-5: Ask about borrowing
            showBorrowingChoice();
        }
    }
}

// æœŸé¦–é‡‘åˆ©æ”¯æ‰•ã„å‡¦ç†ï¼ˆ3æœŸä»¥é™ï¼‰
function processInterestPayments() {
    const interestDetails = [];

    gameState.companies.forEach(company => {
        let totalInterest = 0;
        let shortInterest = 0;
        let longInterest = 0;

        // çŸ­æœŸå€Ÿå…¥é‡‘åˆ©ï¼ˆ20%ï¼‰
        if (company.shortLoans > 0) {
            shortInterest = Math.floor(company.shortLoans * 0.2);
            totalInterest += shortInterest;
        }

        // é•·æœŸå€Ÿå…¥é‡‘åˆ©ï¼ˆ10%ï¼‰
        if (company.loans > 0) {
            longInterest = Math.floor(company.loans * 0.1);
            totalInterest += longInterest;
        }

        if (totalInterest > 0) {
            // è³‡é‡‘ãŒè¶³ã‚Šãªã„å ´åˆã¯çŸ­æœŸå€Ÿå…¥
            if (company.cash < totalInterest) {
                const needed = Math.ceil((totalInterest - company.cash) / 0.8 / 50) * 50;
                company.shortLoans += needed;
                company.cash += needed * 0.8;  // çŸ­æœŸå€Ÿå…¥: å€Ÿå…¥æ™‚20%é‡‘åˆ©æ§é™¤
            }

            company.cash -= totalInterest;

            interestDetails.push({
                name: company.name,
                shortLoans: company.shortLoans,
                longLoans: company.loans,
                shortInterest: shortInterest,
                longInterest: longInterest,
                total: totalInterest
            });
        }
    });

    return interestDetails;
}

// Show borrowing choice for periods 3-5
function showBorrowingChoice() {
    // æœŸé¦–é‡‘åˆ©æ”¯æ‰•ã„å‡¦ç†
    const interestDetails = processInterestPayments();

    // ã‚µã‚¤ã‚³ãƒ­ã‚’æŒ¯ã‚‹ï¼ˆå‰æœŸã®PQãƒˆãƒƒãƒ—ãŒæŒ¯ã‚‹è¨­å®šã ãŒã€ç°¡ç•¥åŒ–ã—ã¦è‡ªå‹•ã§æŒ¯ã‚‹ï¼‰
    gameState.diceRoll = Math.floor(Math.random() * 6) + 1;

    // ã‚µã‚¤ã‚³ãƒ­çµæœã«åŸºã¥ãè¨­å®š
    if (gameState.diceRoll <= 3) {
        gameState.wageMultiplier = 1.1;
        // ä»™å°ã®ã¿é–‰é–
        gameState.markets[0].closed = true;  // ä»™å°
        gameState.markets[1].closed = false; // æœ­å¹Œ
    } else {
        gameState.wageMultiplier = 1.2;
        // ä»™å°ãƒ»æœ­å¹Œé–‰é–
        gameState.markets[0].closed = true;  // ä»™å°
        gameState.markets[1].closed = true;  // æœ­å¹Œ
    }

    // å¤§é˜ªä¸Šé™ä¾¡æ ¼ï¼ˆã‚µã‚¤ã‚³ãƒ­ã®ç›®+20ï¼‰
    gameState.osakaMaxPrice = 20 + gameState.diceRoll;
    gameState.markets[4].sellPrice = gameState.osakaMaxPrice;

    const closedMarkets = gameState.diceRoll <= 3 ? 'ä»™å°' : 'ä»™å°ãƒ»æœ­å¹Œ';

    // é‡‘åˆ©æ”¯æ‰•ã„æƒ…å ±ã®HTMLç”Ÿæˆ
    let interestHtml = '';
    if (interestDetails.length > 0) {
        interestHtml = `
            <div style="background: linear-gradient(135deg, #dc2626 0%, #ef4444 100%); border-radius: 12px; padding: 15px; margin-bottom: 15px; color: white; text-align: left;">
                <div style="font-size: 14px; font-weight: bold; margin-bottom: 10px; text-align: center;">ğŸ’° æœŸé¦–é‡‘åˆ©æ”¯æ‰•ã„</div>
                ${interestDetails.map(d => `
                    <div style="background: rgba(255,255,255,0.15); border-radius: 8px; padding: 10px; margin-bottom: 8px;">
                        <div style="font-weight: bold; margin-bottom: 5px;">${d.name}</div>
                        <div style="font-size: 12px; display: grid; grid-template-columns: 1fr 1fr; gap: 5px;">
                            ${d.shortInterest > 0 ? `<div>çŸ­æœŸé‡‘åˆ©(20%): Â¥${d.shortInterest}</div>` : ''}
                            ${d.longInterest > 0 ? `<div>é•·æœŸé‡‘åˆ©(10%): Â¥${d.longInterest}</div>` : ''}
                        </div>
                        <div style="font-size: 13px; font-weight: bold; margin-top: 5px; text-align: right;">æ”¯æ‰•åˆè¨ˆ: Â¥${d.total}</div>
                    </div>
                `).join('')}
            </div>
        `;
    }

    const content = `
        <div style="text-align: center; padding: 20px;">
            <h3 style="margin-bottom: 15px;">ç¬¬${gameState.currentPeriod}æœŸé–‹å§‹</h3>

            ${interestHtml}

            <div style="background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%); border-radius: 16px; padding: 20px; margin-bottom: 20px; color: white;">
                <div style="font-size: 14px; margin-bottom: 10px;">ğŸ² ã‚µã‚¤ã‚³ãƒ­çµæœ</div>
                <div style="font-size: 48px; font-weight: bold; margin-bottom: 10px;">${gameState.diceRoll}</div>
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; font-size: 12px;">
                    <div style="background: rgba(255,255,255,0.2); padding: 8px; border-radius: 8px;">
                        <div style="opacity: 0.8;">å¸‚å ´é–‰é–</div>
                        <div style="font-weight: bold;">${closedMarkets}</div>
                    </div>
                    <div style="background: rgba(255,255,255,0.2); padding: 8px; border-radius: 8px;">
                        <div style="opacity: 0.8;">äººä»¶è²»å€ç‡</div>
                        <div style="font-weight: bold;">Ã—${gameState.wageMultiplier}</div>
                    </div>
                    <div style="background: rgba(255,255,255,0.2); padding: 8px; border-radius: 8px;">
                        <div style="opacity: 0.8;">å¤§é˜ªä¸Šé™</div>
                        <div style="font-weight: bold;">Â¥${gameState.osakaMaxPrice}</div>
                    </div>
                </div>
            </div>

            <p style="margin-bottom: 15px;">å€Ÿå…¥ã‚’è¡Œã„ã¾ã™ã‹ï¼Ÿ</p>
            <button class="action-btn primary" onclick="startPeriodWithBorrowing()" style="margin: 10px;">å€Ÿå…¥ã‚’è¡Œã†ï¼ˆ3è¡Œç›®ã‹ã‚‰ã‚¹ã‚¿ãƒ¼ãƒˆï¼‰</button>
            <button class="action-btn secondary" onclick="startPeriodWithoutBorrowing()" style="margin: 10px;">å€Ÿå…¥ã‚’è¡Œã‚ãªã„ï¼ˆ2è¡Œç›®ã‹ã‚‰ã‚¹ã‚¿ãƒ¼ãƒˆï¼‰</button>
        </div>
    `;

    showModal('æœŸé¦–å‡¦ç† - ã‚µã‚¤ã‚³ãƒ­çµæœ', content);
}

// Start period with borrowing (periods 3-5)
function startPeriodWithBorrowing() {
    // è¡Œå‹•ãƒ­ã‚°ã‚’ãƒªã‚»ãƒƒãƒˆ
    resetActionLog();

    // Auto-purchase chips for all companies first
    gameState.companies.forEach(company => {
        const computerCost = 20;
        const insuranceCost = 5;
        const totalCost = computerCost + insuranceCost;
        
        // æœŸé¦–å‡¦ç†ã§2è¡Œä½¿ç”¨ï¼ˆå€Ÿå…¥ã‚ã‚Šï¼‰â†’3è¡Œç›®ã‹ã‚‰é–‹å§‹
        company.currentRow = 3;
        
        if (company.cash >= totalCost) {
            company.cash -= totalCost;
            company.chips.computer = 1;
            company.chips.insurance = 1;
        } else {
            // Apply short loan if needed
            const needed = Math.ceil((totalCost - company.cash) / 0.8 / 50) * 50;
            company.shortLoans += needed;
            company.cash += needed * 0.8;  // çŸ­æœŸå€Ÿå…¥: å€Ÿå…¥æ™‚20%é‡‘åˆ©æ§é™¤
            company.cash -= totalCost;
            company.chips.computer = 1;
            company.chips.insurance = 1;
        }
    });
    
    gameState.currentRow = 3;  // Start from row 3 when borrowing
    // Set maxRows based on period
    if (gameState.currentPeriod === 3) {
        gameState.maxRows = gameState.maxRowsByPeriod[3];
    } else if (gameState.currentPeriod === 4) {
        gameState.maxRows = gameState.maxRowsByPeriod[4];
    } else if (gameState.currentPeriod === 5) {
        gameState.maxRows = gameState.maxRowsByPeriod[5];
    }
    gameState.periodStarted = true;
    // AIä¼šç¤¾ã®é•·æœŸå€Ÿå…¥å‡¦ç†ï¼ˆãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®å€Ÿå…¥ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤ºå‰ã«å‡¦ç†ï¼‰
    processAILongTermBorrowing();

    closeModal();
    updateDisplay();
    showToast(`ç¬¬${gameState.currentPeriod}æœŸã‚’é–‹å§‹ã—ã¾ã™\nå…¨ç¤¾ï¼šã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ãƒãƒƒãƒ—(Â¥20)ã¨ä¿é™ºãƒãƒƒãƒ—(Â¥5)ã‚’è‡ªå‹•è³¼å…¥ã—ã¾ã—ãŸã€‚\nå€Ÿå…¥ã‚’å®Ÿæ–½ã™ã‚‹ãŸã‚ã€3è¡Œç›®ã‹ã‚‰ã‚²ãƒ¼ãƒ ã‚¹ã‚¿ãƒ¼ãƒˆã§ã™ã€‚`, 'success', 5000);
    showBorrowModal();
}

// Start period without borrowing (periods 3-5)
function startPeriodWithoutBorrowing() {
    // è¡Œå‹•ãƒ­ã‚°ã‚’ãƒªã‚»ãƒƒãƒˆ
    resetActionLog();

    // Auto-purchase chips for all companies first
    gameState.companies.forEach(company => {
        const computerCost = 20;
        const insuranceCost = 5;
        const totalCost = computerCost + insuranceCost;
        
        // æœŸé¦–å‡¦ç†ã§1è¡Œä½¿ç”¨ï¼ˆå€Ÿå…¥ãªã—ï¼‰â†’2è¡Œç›®ã‹ã‚‰é–‹å§‹
        company.currentRow = 2;
        
        if (company.cash >= totalCost) {
            company.cash -= totalCost;
            company.chips.computer = 1;
            company.chips.insurance = 1;
        } else {
            // Apply short loan if needed
            const needed = Math.ceil((totalCost - company.cash) / 0.8 / 50) * 50;
            company.shortLoans += needed;
            company.cash += needed * 0.8;  // çŸ­æœŸå€Ÿå…¥: å€Ÿå…¥æ™‚20%é‡‘åˆ©æ§é™¤
            company.cash -= totalCost;
            company.chips.computer = 1;
            company.chips.insurance = 1;
        }
    });
    
    // Period 3-5: å€Ÿå…¥ãªã—ã®å ´åˆã¯2è¡Œç›®ã‹ã‚‰é–‹å§‹
    gameState.currentRow = 2;  // Start from row 2 (period start processing uses 1 row)
    // Set maxRows based on period
    if (gameState.currentPeriod === 3) {
        gameState.maxRows = gameState.maxRowsByPeriod[3];
    } else if (gameState.currentPeriod === 4) {
        gameState.maxRows = gameState.maxRowsByPeriod[4];
    } else if (gameState.currentPeriod === 5) {
        gameState.maxRows = gameState.maxRowsByPeriod[5];
    }
    gameState.periodStarted = true;

    // AIä¼šç¤¾ã®é•·æœŸå€Ÿå…¥å‡¦ç†
    processAILongTermBorrowing();

    closeModal();
    updateDisplay();
    saveGame();  // æœŸé¦–ã‚’è‡ªå‹•ã‚»ãƒ¼ãƒ–
    showToast(`ç¬¬${gameState.currentPeriod}æœŸã‚’é–‹å§‹ã—ã¾ã™\nå…¨ç¤¾ï¼šã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ãƒãƒƒãƒ—(Â¥20)ã¨ä¿é™ºãƒãƒƒãƒ—(Â¥5)ã‚’è‡ªå‹•è³¼å…¥ã—ã¾ã—ãŸã€‚\næœŸé¦–å‡¦ç†å®Œäº†ã§2è¡Œç›®ã‹ã‚‰ã‚²ãƒ¼ãƒ ã‚¹ã‚¿ãƒ¼ãƒˆã§ã™ã€‚`, 'success', 5000);
    showTurnStartOptions();
}

// Show borrowing modal
function showBorrowModal() {
    const company = gameState.companies[0];
    // å€Ÿå…¥ä¸Šé™ï¼š3æœŸã¯0.5å€ã€4æœŸä»¥é™ã§è‡ªå·±è³‡æœ¬300è¶…ãªã‚‰1å€
    const loanMultiplier = (gameState.currentPeriod >= 4 && company.equity > 300) ? 1.0 : 0.5;
    const maxLoanTotal = Math.round(company.equity * loanMultiplier);
    const availableLoan = Math.max(0, maxLoanTotal - company.loans);
    const loanRuleText = (gameState.currentPeriod >= 4 && company.equity > 300)
        ? `è‡ªå·±è³‡æœ¬ã®1å€ã¾ã§ï¼ˆ300è¶…ã®ãŸã‚ï¼‰`
        : `è‡ªå·±è³‡æœ¬ã®0.5å€ã¾ã§`;

    const content = `
        <div class="form-group">
            <label class="form-label">é•·æœŸå€Ÿå…¥ï¼ˆ${loanRuleText}ï¼‰</label>
            <div style="font-size: 11px; color: #666; margin-bottom: 5px;">
                ä¸Šé™: Â¥${maxLoanTotal} - æ—¢å­˜å€Ÿå…¥Â¥${company.loans} = è¿½åŠ å¯èƒ½Â¥${availableLoan}
            </div>
            <select id="loanAmount" class="form-control">
                <option value="0">å€Ÿã‚Šãªã„</option>
                ${availableLoan >= 50 ? '<option value="50">Â¥50</option>' : ''}
                ${availableLoan >= 100 ? '<option value="100">Â¥100</option>' : ''}
                ${availableLoan >= 150 ? '<option value="150">Â¥150</option>' : ''}
                ${availableLoan >= 200 ? '<option value="200">Â¥200</option>' : ''}
                ${availableLoan >= 250 ? '<option value="250">Â¥250</option>' : ''}
                ${availableLoan >= 300 ? '<option value="300">Â¥300</option>' : ''}
            </select>
        </div>
        <button class="submit-btn" onclick="processBorrowing()">å€Ÿå…¥ã‚’å®Ÿæ–½</button>
    `;

    showModal('å€Ÿå…¥å‡¦ç†', content);
}

// Process borrowing
function processBorrowing() {
    const company = gameState.companies[0];
    const loanAmount = parseInt(document.getElementById('loanAmount').value || 0);

    if (loanAmount > 0) {
        company.loans += loanAmount;
        const netAmount = Math.floor(loanAmount * 0.9);  // é•·æœŸå€Ÿå…¥: å€Ÿå…¥æ™‚10%é‡‘åˆ©æ§é™¤
        company.cash += netAmount;
        alert(`é•·æœŸå€Ÿå…¥Â¥${loanAmount}ï¼ˆåˆ©æ¯æ§é™¤å¾ŒÂ¥${netAmount}å…¥é‡‘ï¼‰`);
    }

    closeModal();
    updateDisplay();
    saveGame();  // å€Ÿå…¥å¾Œã‚’è‡ªå‹•ã‚»ãƒ¼ãƒ–
    showTurnStartOptions();
}

// AIä¼šç¤¾ã®é•·æœŸå€Ÿå…¥å‡¦ç†ï¼ˆ3æœŸä»¥é™ã®æœŸé¦–ã§å®Ÿè¡Œï¼‰
function processAILongTermBorrowing() {
    if (gameState.currentPeriod < 3) return;

    gameState.companies.forEach((company, index) => {
        if (company.type !== 'ai') return;

        // å€Ÿå…¥ä¸Šé™è¨ˆç®—ï¼ˆ4æœŸä»¥é™ã€è‡ªå·±è³‡æœ¬300è¶…ãªã‚‰1å€ï¼‰
        const loanMultiplier = (gameState.currentPeriod >= 4 && company.equity > 300) ? 1.0 : 0.5;
        const maxLoanTotal = Math.round(company.equity * loanMultiplier);
        const availableLoan = Math.max(0, maxLoanTotal - company.loans);

        if (availableLoan <= 0) return;

        // æˆ¦ç•¥åˆ¥ã®å€Ÿå…¥åˆ¤æ–­
        let borrowRatio = 0;  // å€Ÿå…¥å¯èƒ½é¡ã«å¯¾ã™ã‚‹å€Ÿå…¥å‰²åˆ
        const mfgCapacity = getManufacturingCapacity(company);
        const salesCapacity = getSalesCapacity(company);
        const periodsRemaining = 5 - gameState.currentPeriod;
        const needsInvestment = company.chips.research < 3 || mfgCapacity < 6 || salesCapacity < 6;

        switch (company.strategy) {
            case 'aggressive':
                // ç©æ¥µçš„ï¼šæŠ•è³‡ä½™åŠ›ãŒå¿…è¦ãªã‚‰ç©æ¥µçš„ã«å€Ÿå…¥
                if (needsInvestment && company.cash < 150) {
                    borrowRatio = 0.8;  // 80%ã¾ã§å€Ÿå…¥
                } else if (company.cash < 100) {
                    borrowRatio = 0.5;
                }
                break;

            case 'conservative':
                // ä¿å®ˆçš„ï¼šæœ€ä½é™ã®å€Ÿå…¥ã®ã¿
                if (company.cash < 50 && needsInvestment) {
                    borrowRatio = 0.3;  // 30%ã¾ã§
                }
                break;

            case 'price_focused':
                // ä¾¡æ ¼ç«¶äº‰ï¼šç ”ç©¶ãƒãƒƒãƒ—æŠ•è³‡ã®ãŸã‚å€Ÿå…¥
                if (company.chips.research < 4 && company.cash < 120) {
                    borrowRatio = 0.6;
                }
                break;

            case 'tech_focused':
                // æŠ€è¡“é‡è¦–ï¼šãƒãƒƒãƒ—æŠ•è³‡ã®ãŸã‚ç©æ¥µå€Ÿå…¥
                if ((company.chips.research < 4 || company.chips.education < 2) && company.cash < 150) {
                    borrowRatio = 0.7;
                }
                break;

            case 'balanced':
                // ãƒãƒ©ãƒ³ã‚¹ï¼šä¸­ç¨‹åº¦ã®å€Ÿå…¥
                if (needsInvestment && company.cash < 120) {
                    borrowRatio = 0.5;
                }
                break;

            case 'unpredictable':
                // äºˆæ¸¬ä¸èƒ½ï¼šãƒ©ãƒ³ãƒ€ãƒ 
                if (Math.random() > 0.5 && company.cash < 150) {
                    borrowRatio = Math.random() * 0.7;
                }
                break;
        }

        // æ®‹ã‚ŠæœŸæ•°ãŒå°‘ãªã„å ´åˆã¯å€Ÿå…¥ã‚’æ§ãˆã‚‹ï¼ˆè¿”æ¸ˆãƒªã‚¹ã‚¯ï¼‰
        if (periodsRemaining <= 1) {
            borrowRatio *= 0.3;
        }

        // å€Ÿå…¥å®Ÿè¡Œ
        if (borrowRatio > 0) {
            const loanAmount = Math.floor(availableLoan * borrowRatio / 50) * 50;  // 50å††å˜ä½
            if (loanAmount >= 50) {
                company.loans += loanAmount;
                const netAmount = Math.floor(loanAmount * 0.9);  // 10%é‡‘åˆ©æ§é™¤
                company.cash += netAmount;
                console.log(`${company.name}ãŒé•·æœŸå€Ÿå…¥Â¥${loanAmount}ï¼ˆå…¥é‡‘Â¥${netAmount}ï¼‰ã‚’å®Ÿè¡Œ`);
            }
        }
    });
}

// Show sales capacity detail
function showSalesCapacityDetail(companyIndex) {
    const company = gameState.companies[companyIndex];
    const baseCapacity = company.salesmen * 2;
    const maxAdChips = company.salesmen * 2;  // ã‚»ãƒ¼ãƒ«ã‚¹ãƒãƒ³1äººã«ã¤ã2æšã¾ã§
    const effectiveAdChips = Math.min(company.chips.advertising || 0, maxAdChips);
    const adBonus = effectiveAdChips * 2;
    const educationBonus = Math.min(company.chips.education || 0, 1);  // åŠ¹æœã¯1æšåˆ†ãŒä¸Šé™
    const totalCapacity = getSalesCapacity(company);

    const adInfo = company.chips.advertising > 0
        ? `åºƒå‘Šãƒãƒƒãƒ—: ${effectiveAdChips}æš Ã— 2 = +${adBonus}${company.chips.advertising > maxAdChips ? ` (${company.chips.advertising}æšä¸­${effectiveAdChips}æšæœ‰åŠ¹)` : ''}`
        : '';

    const content = `
        <div class="breakdown-list">
            <h3>è²©å£²èƒ½åŠ›ã®è©³ç´°</h3>
            <div class="breakdown-item"><span>ã‚»ãƒ¼ãƒ«ã‚¹ãƒãƒ³: ${company.salesmen}äºº Ã— 2 = ${baseCapacity}</span></div>
            ${adInfo ? `<div class="breakdown-item"><span>${adInfo}</span></div>` : ''}
            ${educationBonus > 0 ? `<div class="breakdown-item"><span>æ•™è‚²ãƒãƒƒãƒ—: +${educationBonus}${company.chips.education > 1 ? ' (ä¸Šé™1)' : ''}</span></div>` : ''}
            <hr>
            <div class="breakdown-item breakdown-total"><span>è²©å£²èƒ½åŠ›</span><span>${totalCapacity}</span></div>
        </div>
    `;

    showModal(`${company.name}ã®è²©å£²èƒ½åŠ›`, content);
}

// Show AI bid notification
function showAIBidNotification() {
    const bid = gameState.aiPendingBid;
    const playerCompany = gameState.companies[0];
    const playerSalesCapacity = getSalesCapacity(playerCompany);
    const playerMaxQty = Math.min(playerSalesCapacity, playerCompany.products);
    
    const content = `
        <div class="bid-display">
            <div class="bid-title">${gameState.companies[bid.company].name}ãŒå…¥æœ­ã‚’é–‹å§‹</div>
            <p>å¸‚å ´: ${bid.market.name} (æœ€å¤§ä¾¡æ ¼: Â¥${bid.market.sellPrice})</p>
            <p>${gameState.companies[bid.company].name}ã®å…¥æœ­: éå…¬é–‹ Ã— ${bid.quantity}å€‹</p>
            <hr>
            <p>ã‚ãªãŸã‚‚å…¥æœ­ã«å‚åŠ ã—ã¾ã™ã‹ï¼Ÿ</p>
            <p>ç¾åœ¨ã®åœ¨åº«: ${playerCompany.products}å€‹ (è²©å£²èƒ½åŠ›: ${playerSalesCapacity})</p>
            <div class="form-group">
                <label class="form-label">å…¥æœ­ä¾¡æ ¼ï¼ˆÂ¥ï¼‰:</label>
                <input type="number" id="playerBidPrice" class="form-control" value="${Math.floor(bid.market.sellPrice * 0.9)}" min="1" max="${bid.market.sellPrice}">
            </div>
            <div class="form-group">
                <label class="form-label">å…¥æœ­æ•°é‡:</label>
                <select id="playerBidQty" class="form-control">
                    ${Array(playerMaxQty + 1).fill(0).map((_, i) => 
                        `<option value="${i}" ${i === playerMaxQty ? 'selected' : ''}>${i}å€‹</option>`
                    ).join('')}
                </select>
            </div>
            <button class="submit-btn" onclick="processAIBidWithPlayer()">å…¥æœ­ã«å‚åŠ </button>
            <button class="cancel-btn" onclick="skipPlayerBid()">å‚åŠ ã—ãªã„</button>
        </div>
    `;
    
    showModal('ä»–ç¤¾å…¥æœ­ã¸ã®å‚åŠ ', content);
}

// Process AI bid with player participation
function processAIBidWithPlayer() {
    const bid = gameState.aiPendingBid;
    const playerPrice = parseInt(document.getElementById('playerBidPrice').value);
    const playerQty = parseInt(document.getElementById('playerBidQty').value);
    
    const allBids = [];
    
    // AI company's bid
    const aiCompany = gameState.companies[bid.company];
    const aiCompetitiveness = getPriceCompetitiveness(aiCompany);
    allBids.push({
        company: bid.company,
        price: bid.price,  // æœ‰åŠ¹å…¥æœ­é¡ï¼ˆæ—¢ã«ç«¶äº‰åŠ›ã‚’å¼•ã„ãŸå€¤ï¼‰
        displayPrice: bid.price + aiCompetitiveness,  // å®Ÿéš›ã®å…¥é‡‘é¡
        quantity: bid.quantity,
        competitiveness: aiCompetitiveness
    });
    
    // Player's bid
    if (playerQty > 0) {
        const playerCompetitiveness = getPriceCompetitiveness(gameState.companies[0]);
        allBids.push({
            company: 0,
            price: playerPrice - playerCompetitiveness,  // æœ‰åŠ¹å…¥æœ­é¡
            displayPrice: playerPrice,  // å®Ÿéš›ã®å…¥é‡‘é¡
            quantity: playerQty,
            competitiveness: playerCompetitiveness
        });
    }
    
    // Other AI companies' bids
    for (let i = 1; i < gameState.companies.length; i++) {
        if (i !== bid.company) {
            const otherCompany = gameState.companies[i];
            if (otherCompany.products > 0) {
                const otherCapacity = getSalesCapacity(otherCompany);
                const otherQty = Math.min(otherCapacity, otherCompany.products);
                if (otherQty > 0) {
                    const otherDisplayPrice = Math.floor(bid.market.sellPrice * (0.7 + Math.random() * 0.25));
                    const otherPrice = otherDisplayPrice - getPriceCompetitiveness(otherCompany);
                    allBids.push({company: i, price: otherPrice, quantity: otherQty, displayPrice: otherDisplayPrice});
                }
            }
        }
    }
    
    // Sort by: 1) price (lowest), 2) research chips (most), 3) parent (priority)
    allBids.sort((a, b) => {
        // First compare actual bid price
        if (a.price !== b.price) return a.price - b.price;
        
        // Same price: compare research chips (more chips wins)
        const aResearch = gameState.companies[a.company].chips.research || 0;
        const bResearch = gameState.companies[b.company].chips.research || 0;
        if (aResearch !== bResearch) return bResearch - aResearch;
        
        // Same research chips: parent wins
        const aIsParent = (gameState.currentPlayerIndex === a.company);
        const bIsParent = (gameState.currentPlayerIndex === b.company);
        if (aIsParent && !bIsParent) return -1;
        if (!aIsParent && bIsParent) return 1;
        
        return 0;
    });
    
    // Process winner
    const winner = allBids[0];
    const winCompany = gameState.companies[winner.company];
    const actualQty = Math.min(winner.quantity, bid.market.maxStock - bid.market.currentStock);
    
    if (actualQty > 0) {
        const salePrice = winner.displayPrice || winner.price;
        winCompany.cash += salePrice * actualQty;
        winCompany.products -= actualQty;
        winCompany.totalSales += salePrice * actualQty;
        winCompany.totalSoldQuantity = (winCompany.totalSoldQuantity || 0) + actualQty;
        bid.market.currentStock += actualQty;
    }
    
    // Show results
    let resultHtml = '<div class="bid-display"><div class="bid-title">å…¥æœ­çµæœ</div><div class="bid-entries">';
    allBids.forEach((b, index) => {
        const isWinner = index === 0;
        const company = gameState.companies[b.company];
        const isParent = (gameState.currentPlayerIndex === b.company);
        const researchChips = company.chips.research || 0;
        
        // ç«¶äº‰åŠ›ã®å†…è¨³ã‚’è¡¨ç¤º
        let competitiveBonus = '';
        if (isParent) competitiveBonus += 'è¦ª+2 ';
        if (researchChips > 0) competitiveBonus += `ç ”ç©¶+${researchChips * 2} `;
        
        // æœ‰åŠ¹å…¥æœ­é¡ã¨å®Ÿéš›ã®å…¥é‡‘é¡ã‚’è¡¨ç¤º
        const effectivePrice = b.price;
        const actualPrice = b.displayPrice || (b.price + getPriceCompetitiveness(company));
        
        resultHtml += `
            <div class="bid-entry ${isWinner ? 'bid-winner' : ''}">
                <span>${company.name}</span>
                <span>Â¥${effectivePrice}ï¼ˆÂ¥${actualPrice}ï¼‰Ã— ${b.quantity}å€‹ ${competitiveBonus}</span>
            </div>
        `;
    });
    resultHtml += '</div><p style="font-size: 12px; margin-top: 10px;">â€»æœ‰åŠ¹å…¥æœ­é¡ï¼ˆå®Ÿéš›ã®å…¥é‡‘é¡ï¼‰</p></div><button class="submit-btn" onclick="continueAITurn()">OK</button>';
    
    closeModal();
    showModal('å…¥æœ­çµæœ', resultHtml);
}

// Skip player bid
function skipPlayerBid() {
    // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®å…¥æœ­ã‚’ã‚¹ã‚­ãƒƒãƒ—ï¼ˆæ•°é‡0ã§å‡¦ç†ï¼‰
    document.getElementById('playerBidQty').value = '0';
    processAIBidWithPlayer(); // Process without player bid
}

// Continue AI turn after bid
function continueAITurn() {
    closeModal();
    const company = gameState.companies[gameState.aiPendingBid.company];
    incrementRow(gameState.companies.indexOf(company));
    gameState.aiPendingBid = null;
    nextTurn();
}

// Insurance purchase modal (B-rule)
function showInsurancePurchaseModal() {
    const company = gameState.companies[0];
    
    if (company.chips.insurance > 0) {
        showToast('ã™ã§ã«ä¿é™ºã«åŠ å…¥ã—ã¦ã„ã¾ã™', 'warning', 3000);
        return;
    }
    
    const content = `
        <div class="form-group">
            <label class="form-label">ä¿é™ºãƒãƒƒãƒ—è³¼å…¥</label>
            <p style="font-size: 12px; color: #666;">ä¾¡æ ¼ï¼šÂ¥5<br>åŠ¹æœï¼šç«ç½ãƒ»ç›—é›£æ™‚ã«ä¿é™ºé‡‘å—å–ï¼ˆä½¿ç”¨å¾Œæ¶ˆè²»ï¼‰</p>
        </div>
        <button class="submit-btn" onclick="buyInsurance()">è³¼å…¥(Â¥5)</button>
    `;
    
    showModal('ä¿é™ºãƒãƒƒãƒ—è³¼å…¥', content);
}

// Buy insurance
function buyInsurance() {
    const company = gameState.companies[0];
    
    if (company.cash < 5) {
        showToast('ç¾é‡‘ãŒä¸è¶³ã—ã¦ã„ã¾ã™', 'danger', 3000);
        return;
    }
    
    company.cash -= 5;
    company.chips.insurance = 1;
    
    closeModal();
    showToast('ä¿é™ºãƒãƒƒãƒ—ã‚’è³¼å…¥ã—ã¾ã—ãŸï¼ˆÂ¥5ï¼‰', 'success', 3000);
    
    // ã‚«ãƒ¼ãƒ‰ã‚’å¼•ã
    drawCard();
}

// Chip modal (for period-specific purchases)
function showChipModal(specificType = null) {
    const period = gameState.currentPeriod;
    const company = gameState.companies[0];

    const chipInfo = {
        research: { name: 'ç ”ç©¶', icon: 'ğŸ”¬', color: '#4a90d9', border: '#1e4a7a', desc: 'ä¾¡æ ¼ç«¶äº‰åŠ›+2å††' },
        education: { name: 'æ•™è‚²', icon: 'ğŸ“š', color: '#fbbf24', border: '#9a7000', desc: 'è£½é€ èƒ½åŠ›+1' },
        advertising: { name: 'åºƒå‘Š', icon: 'ğŸ“£', color: '#ef4444', border: '#8b1c1c', desc: 'è²©å£²èƒ½åŠ›+2' }
    };

    let content = `
        <div style="background: linear-gradient(180deg, #f0f9ff 0%, #e0f2fe 100%); border-radius: 12px; padding: 15px; margin-bottom: 15px; border: 2px solid #0284c7;">
            <div style="text-align: center; margin-bottom: 10px;">
                <span style="font-size: 12px; color: #0369a1;">ç¾åœ¨ã®ãƒãƒƒãƒ—</span>
            </div>
            <div style="display: flex; justify-content: space-around; text-align: center;">
                <div style="background: #fff; border-radius: 8px; padding: 6px 12px; border: 2px solid ${chipInfo.research.border};">
                    <div style="font-size: 18px;">${chipInfo.research.icon}</div>
                    <div style="font-size: 14px; font-weight: bold; color: ${chipInfo.research.color};">${company.chips.research || 0}</div>
                </div>
                <div style="background: #fff; border-radius: 8px; padding: 6px 12px; border: 2px solid ${chipInfo.education.border};">
                    <div style="font-size: 18px;">${chipInfo.education.icon}</div>
                    <div style="font-size: 14px; font-weight: bold; color: ${chipInfo.education.color};">${company.chips.education || 0}</div>
                </div>
                <div style="background: #fff; border-radius: 8px; padding: 6px 12px; border: 2px solid ${chipInfo.advertising.border};">
                    <div style="font-size: 18px;">${chipInfo.advertising.icon}</div>
                    <div style="font-size: 14px; font-weight: bold; color: ${chipInfo.advertising.color};">${company.chips.advertising || 0}</div>
                </div>
            </div>
        </div>

        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 15px;">
            <div onclick="selectChipType('research')" id="chip-research" style="background: linear-gradient(180deg, ${chipInfo.research.color} 0%, #2e6db4 100%); border-radius: 10px; padding: 12px 8px; border: 3px solid ${chipInfo.research.border}; cursor: pointer; text-align: center; transition: all 0.2s;">
                <div style="font-size: 28px; margin-bottom: 5px;">${chipInfo.research.icon}</div>
                <div style="font-size: 12px; font-weight: bold; color: #fff;">ç ”ç©¶</div>
                <div style="font-size: 9px; color: #bfdbfe;">${chipInfo.research.desc}</div>
            </div>
            <div onclick="selectChipType('education')" id="chip-education" style="background: linear-gradient(180deg, ${chipInfo.education.color} 0%, #d69e00 100%); border-radius: 10px; padding: 12px 8px; border: 3px solid ${chipInfo.education.border}; cursor: pointer; text-align: center; transition: all 0.2s;">
                <div style="font-size: 28px; margin-bottom: 5px;">${chipInfo.education.icon}</div>
                <div style="font-size: 12px; font-weight: bold; color: #78350f;">æ•™è‚²</div>
                <div style="font-size: 9px; color: #92400e;">${chipInfo.education.desc}</div>
            </div>
            <div onclick="selectChipType('advertising')" id="chip-advertising" style="background: linear-gradient(180deg, ${chipInfo.advertising.color} 0%, #c42b2b 100%); border-radius: 10px; padding: 12px 8px; border: 3px solid ${chipInfo.advertising.border}; cursor: pointer; text-align: center; transition: all 0.2s;">
                <div style="font-size: 28px; margin-bottom: 5px;">${chipInfo.advertising.icon}</div>
                <div style="font-size: 12px; font-weight: bold; color: #fff;">åºƒå‘Š</div>
                <div style="font-size: 9px; color: #fecaca;">${chipInfo.advertising.desc}</div>
            </div>
        </div>

        <input type="hidden" id="chipType" value="${specificType || 'research'}">
    `;

    if (period >= 3) {
        // 3-5æœŸï¼šç‰¹æ€¥ã¾ãŸã¯ç¹°ã‚Šè¶Šã—
        content += `
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
            <div onclick="selectPurchaseType('express')" id="purchase-express" style="background: linear-gradient(180deg, #dc2626 0%, #b91c1c 100%); border-radius: 10px; padding: 12px; border: 3px solid #991b1b; cursor: pointer; text-align: center; transition: all 0.2s;">
                <div style="font-size: 20px; margin-bottom: 3px;">âš¡</div>
                <div style="font-size: 13px; font-weight: bold; color: #fff;">ç‰¹æ€¥</div>
                <div style="font-size: 11px; color: #fecaca;">Â¥40 / å³æ™‚ä½¿ç”¨</div>
            </div>
            <div onclick="selectPurchaseType('carryover')" id="purchase-carryover" style="background: linear-gradient(180deg, #9333ea 0%, #7c3aed 100%); border-radius: 10px; padding: 12px; border: 3px solid #6b21a8; cursor: pointer; text-align: center; transition: all 0.2s;">
                <div style="font-size: 20px; margin-bottom: 3px;">ğŸ“…</div>
                <div style="font-size: 13px; font-weight: bold; color: #fff;">æ¬¡æœŸç¹°ã‚Šè¶Šã—</div>
                <div style="font-size: 11px; color: #e9d5ff;">Â¥20 / æ¬¡æœŸã‹ã‚‰</div>
            </div>
        </div>
        <input type="hidden" id="purchaseType" value="express">
        `;
    }

    content += `
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 15px;">
            <div style="background: #f1f5f9; border-radius: 10px; padding: 12px;">
                <div style="font-size: 12px; color: #64748b; margin-bottom: 5px;">è³¼å…¥æ•°</div>
                <select id="quantity" class="form-control" style="font-size: 18px; text-align: center; font-weight: bold;" onchange="updateChipCost()">
                    <option value="1">1å€‹</option>
                    <option value="2">2å€‹</option>
                    <option value="3">3å€‹</option>
                </select>
            </div>
            <div style="background: #f1f5f9; border-radius: 10px; padding: 12px; text-align: center;">
                <div style="font-size: 12px; color: #64748b;">åˆè¨ˆé‡‘é¡</div>
                <div id="chipTotalCost" style="font-size: 24px; font-weight: bold; color: #dc2626;">Â¥${period === 2 ? 20 : 40}</div>
            </div>
        </div>

        <button class="submit-btn" onclick="buyChips()" style="width: 100%;">
            ğŸ¯ è³¼å…¥å®Ÿè¡Œ
        </button>
    `;

    showModal('ğŸ¯ æˆ¦ç•¥ãƒãƒƒãƒ—è³¼å…¥', content);

    // åˆæœŸé¸æŠã‚’è¦–è¦šçš„ã«åæ˜ 
    setTimeout(() => {
        selectChipType(specificType || 'research');
        if (period >= 3) selectPurchaseType('express');
    }, 0);
}

// ãƒãƒƒãƒ—ã‚¿ã‚¤ãƒ—ã‚’é¸æŠ
function selectChipType(type) {
    document.getElementById('chipType').value = type;

    ['research', 'education', 'advertising'].forEach(t => {
        const el = document.getElementById(`chip-${t}`);
        if (el) {
            el.style.transform = t === type ? 'scale(1.05)' : 'scale(1)';
            el.style.boxShadow = t === type ? '0 0 20px rgba(251,191,36,0.6)' : 'none';
        }
    });
    updateChipCost();
}

// è³¼å…¥ã‚¿ã‚¤ãƒ—ã‚’é¸æŠï¼ˆ3æœŸä»¥é™ï¼‰
function selectPurchaseType(type) {
    document.getElementById('purchaseType').value = type;

    ['express', 'carryover'].forEach(t => {
        const el = document.getElementById(`purchase-${t}`);
        if (el) {
            el.style.transform = t === type ? 'scale(1.03)' : 'scale(1)';
            el.style.boxShadow = t === type ? '0 0 15px rgba(251,191,36,0.5)' : 'none';
        }
    });
    updateChipCost();
}

// ãƒãƒƒãƒ—è³¼å…¥é‡‘é¡ã‚’æ›´æ–°
function updateChipCost() {
    const period = gameState.currentPeriod;
    const quantity = parseInt(document.getElementById('quantity').value) || 1;
    let unitCost = 20;

    if (period >= 3) {
        const purchaseType = document.getElementById('purchaseType');
        if (purchaseType && purchaseType.value === 'express') {
            unitCost = 40;
        }
    }

    const total = quantity * unitCost;
    document.getElementById('chipTotalCost').textContent = `Â¥${total}`;
}

// Buy chips
function buyChips() {
    const company = gameState.companies[0];
    const chipType = document.getElementById('chipType').value;
    const quantity = parseInt(document.getElementById('quantity').value);
    const period = gameState.currentPeriod;
    
    let cost = 0;
    let isExpress = false;
    
    if (period === 2) {
        // 2æœŸï¼šãã®æœŸã«ä½¿ç”¨ï¼ˆ20å††ï¼‰
        cost = quantity * 20;
        isExpress = true;
    } else {
        // 3-5æœŸï¼šç‰¹æ€¥ã¾ãŸã¯ç¹°ã‚Šè¶Šã—
        const purchaseType = document.getElementById('purchaseType').value;
        isExpress = purchaseType === 'express';
        cost = quantity * (isExpress ? 40 : 20);
    }
    
    if (company.cash < cost) {
        // çŸ­æœŸå€Ÿå…¥
        const needed = Math.ceil((cost - company.cash) / 0.8 / 50) * 50;
        company.shortLoans += needed;
        company.cash += needed * 0.8;  // çŸ­æœŸå€Ÿå…¥: å€Ÿå…¥æ™‚20%é‡‘åˆ©æ§é™¤
        showToast(`ç¾é‡‘ä¸è¶³ã®ãŸã‚çŸ­æœŸå€Ÿå…¥Â¥${needed}ã‚’å®Ÿè¡Œã—ã¾ã—ãŸ`, 'warning', 4000);
    }
    
    // Check max limits
    const maxLimits = {research: 5, education: 1, advertising: 5};
    const nextPeriodCount = company.nextPeriodChips?.[chipType] || 0;
    const currentTotal = company.chips[chipType] + nextPeriodCount + quantity;
    if (currentTotal > maxLimits[chipType]) {
        alert(`${chipType}ãƒãƒƒãƒ—ã¯æœ€å¤§${maxLimits[chipType]}å€‹ã¾ã§ã§ã™ï¼`);
        return;
    }
    
    company.cash -= cost;

    if (isExpress) {
        // å³æ™‚ä½¿ç”¨
        company.chips[chipType] += quantity;
    } else {
        // æ¬¡æœŸç¹°ã‚Šè¶Šã—
        company.nextPeriodChips[chipType] += quantity;
    }

    // è¡Œå‹•ãƒ­ã‚°è¨˜éŒ²
    const chipNames = {research: 'ç ”ç©¶', education: 'æ•™è‚²', advertising: 'åºƒå‘Š'};
    const typeStr = isExpress ? 'ç‰¹æ€¥' : 'ç¹°è¶Š';
    logAction(0, 'ãƒãƒƒãƒ—è³¼å…¥', `${chipNames[chipType]}${quantity}æš(${typeStr})`, -cost, true);

    closeModal();
    updateDisplay();
    showToast(`${chipType}ãƒãƒƒãƒ—ã‚’${quantity}å€‹è³¼å…¥ã—ã¾ã—ãŸï¼ˆÂ¥${cost}ï¼‰`, 'success', 3000);
    endTurn();
}

// Do nothing
function doNothing() {
    const company = gameState.companies[0];
    
    if (!gameState.doNothingCount[0]) {
        gameState.doNothingCount[0] = 0;
    }
    
    if (gameState.doNothingCount[0] >= 3) {
        showToast('DO NOTHINGã¯é€£ç¶š3å›ã¾ã§ã§ã™ï¼', 'danger', 3000);
        return;
    }
    
    gameState.doNothingCount[0]++;
    showToast(`DO NOTHINGã‚’é¸æŠã—ã¾ã—ãŸï¼ˆ${gameState.doNothingCount[0]}/3å›ï¼‰\nè¡Œã¯æ¶ˆè²»ã•ã‚Œã¾ã›ã‚“ã€‚`, 'info', 3000);
    
    // DO NOTHING doesn't use a row
    nextTurn();
}

// ãƒ©ã‚¹ãƒˆ5è¡Œè­¦å‘Šãƒ¢ãƒ¼ãƒ€ãƒ«
function showLast5RowWarning(company) {
    const remaining = gameState.maxRows - company.currentRow + 1;
    const content = `
        <div style="padding: 20px; text-align: center;">
            <div style="font-size: 48px; margin-bottom: 15px;">âš ï¸</div>
            <div style="font-size: 18px; font-weight: bold; color: #dc2626; margin-bottom: 10px;">
                ${company.name}ãŒãƒ©ã‚¹ãƒˆ5è¡Œã«åˆ°é”ï¼
            </div>
            <div style="font-size: 14px; color: #6b7280; margin-bottom: 15px;">
                æ®‹ã‚Š${remaining}è¡Œã§æœŸæœ«å‡¦ç†ãŒå§‹ã¾ã‚Šã¾ã™ã€‚<br>
                çµ¦æ–™æ”¯æ‰•ã„ã«å‚™ãˆã¦è³‡é‡‘ã‚’ç¢ºä¿ã—ã¦ãã ã•ã„ã€‚
            </div>
            <div style="background: #fef2f2; border-radius: 8px; padding: 15px; margin-bottom: 15px;">
                <div style="font-size: 12px; color: #991b1b;">
                    ç¾åœ¨è¡Œ: ${company.currentRow} / ä¸Šé™: ${gameState.maxRows}è¡Œ
                </div>
            </div>
            <button class="submit-btn" onclick="closeModal()">OK</button>
        </div>
    `;
    showModal('ãƒ©ã‚¹ãƒˆ5è¡Œè­¦å‘Š', content);
}

// è¡Œæ•°ã‚’å¢—ã‚„ã™é–¢æ•°ï¼ˆè³‡æºå¤‰æ›´æ™‚ã«å‘¼ã¶ï¼‰
function incrementRow(companyIndex) {
    const company = gameState.companies[companyIndex];
    company.currentRow = (company.currentRow || 1) + 1;

    // ãƒ©ã‚¹ãƒˆ5è¡Œã®è­¦å‘Šï¼ˆå„ç¤¾ãŒå€‹åˆ¥ã«æ®‹ã‚Š5è¡Œã«åˆ°é”ã™ã‚‹ãŸã³ã«è­¦å‘Šï¼‰
    if (!company.last5RowWarningShown && company.currentRow === gameState.maxRows - 4) {
        company.last5RowWarningShown = true;
        showLast5RowWarning(company);
    }
    
    // èª°ã‹ãŒä¸Šé™ã«é”ã—ãŸã‚‰æœŸæœ«å‡¦ç†
    if (company.currentRow >= gameState.maxRows) {
        console.log(`${company.name}ãŒè¡Œæ•°ä¸Šé™ï¼ˆ${gameState.maxRows}è¡Œï¼‰ã«é”ã—ã¾ã—ãŸï¼æœŸæœ«å‡¦ç†ã‚’é–‹å§‹ã—ã¾ã™ã€‚`);
        endPeriod();
        return true;  // æœŸæœ«å‡¦ç†ã‚’é–‹å§‹ã—ãŸ
    }
    return false;  // ã¾ã ç¶šè¡Œ
}

// End turn
function endTurn() {
    const company = gameState.companies[gameState.currentPlayerIndex];

    // åŠ´ç½ãƒ•ãƒ©ã‚°ã‚’ãƒªã‚»ãƒƒãƒˆï¼ˆã‚¿ãƒ¼ãƒ³çµ‚äº†æ™‚ï¼‰
    company.cannotProduce = false;

    // è¡Œæ•°ã‚’å¢—ã‚„ã™ï¼ˆè³‡æºå¤‰æ›´ãŒã‚ã£ãŸãŸã‚ï¼‰
    if (incrementRow(gameState.currentPlayerIndex)) {
        return;  // æœŸæœ«å‡¦ç†ãŒå§‹ã¾ã£ãŸã®ã§çµ‚äº†
    }

    gameState.doNothingCount[gameState.currentPlayerIndex] = 0;

    // è‡ªå‹•ã‚»ãƒ¼ãƒ–
    saveGame();

    nextTurn();
}

// Next turn
function nextTurn() {
    // Check skip turns
    const currentCompany = gameState.companies[gameState.currentPlayerIndex];
    if (currentCompany.skipTurns > 0) {
        currentCompany.skipTurns--;
        console.log(`${currentCompany.name}ã¯ä¼‘ã¿ï¼ˆæ®‹ã‚Š${currentCompany.skipTurns}å›ï¼‰`);
    }
    
    // ã‚¿ãƒ¼ãƒ³é †ã®å‡¦ç†ï¼ˆé€†å›ã‚Šã®å ´åˆï¼‰
    if (gameState.turnReversed) {
        gameState.currentPlayerIndex--;
        if (gameState.currentPlayerIndex < 0) {
            gameState.currentPlayerIndex = gameState.companies.length - 1;
            gameState.currentRow++;
            
            if (gameState.currentRow > gameState.maxRows) {
                endPeriod();
                return;
            }
        }
    } else {
        gameState.currentPlayerIndex++;
        if (gameState.currentPlayerIndex >= gameState.companies.length) {
            gameState.currentPlayerIndex = 0;
            gameState.currentRow++;
            
            if (gameState.currentRow > gameState.maxRows) {
                endPeriod();
                return;
            }
        }
    }
    
    updateDisplay();
    
    // Auto-execute AI turn
    if (gameState.currentPlayerIndex !== 0) {
        setTimeout(executeAITurn, 1000);
    } else {
        // Player's turn
        if (gameState.companies[0].skipTurns > 0) {
            gameState.companies[0].skipTurns--;
            alert(`ä¼‘ã¿ä¸­ï¼ˆæ®‹ã‚Š${gameState.companies[0].skipTurns}å›ï¼‰`);
            nextTurn();
        } else {
            showTurnStartOptions();
        }
    }
}

// Apply risk card to AI company
function applyRiskCardToAI(company, card) {
    let rowUsed = true;

    switch(card.id) {
        case 1: // ã‚¯ãƒ¬ãƒ¼ãƒ ç™ºç”Ÿ
        case 2:
            company.cash = Math.max(0, company.cash - 5);
            if (!company.additionalFixedCost) company.additionalFixedCost = 0;
            company.additionalFixedCost += 5;  // Fã«è¨ˆä¸Š
            break;
        case 3: // æ•™è‚²æˆåŠŸ
        case 4:
            if (company.chips.education > 0 && company.products > 0) {
                const sellQty = Math.min(getSalesCapacity(company), company.products, 5);
                company.cash += sellQty * 32;
                company.products -= sellQty;
                company.totalSales += sellQty * 32;
                company.totalSoldQuantity = (company.totalSoldQuantity || 0) + sellQty;
            }
            break;
        case 5: // æ¶ˆè²»è€…é‹å‹•ç™ºç”Ÿ
        case 6:
            company.cannotSell = true;
            break;
        case 7: // å¾—æ„å…ˆå€’ç”£
        case 8:
            if (gameState.currentPeriod !== 2) {
                company.cash = Math.max(0, company.cash - 30);
                company.specialLoss = (company.specialLoss || 0) + 30;
            }
            break;
        case 9: // ç ”ç©¶é–‹ç™ºå¤±æ•—
        case 10:
        case 11:
            if (company.chips.research > 0) {
                company.chips.research--;
            } else if (company.nextPeriodChips.research > 0) {
                company.nextPeriodChips.research--;
            }
            break;
        case 12: // åºƒå‘ŠæˆåŠŸ
        case 13:
        case 14:
            if (company.chips.advertising > 0 && company.products > 0) {
                const maxSell = Math.min(company.chips.advertising * 2, 5);
                const sellQty = Math.min(maxSell, company.products);
                company.cash += sellQty * 32;
                company.products -= sellQty;
                company.totalSales += sellQty * 32;
                company.totalSoldQuantity = (company.totalSoldQuantity || 0) + sellQty;
            }
            break;
        case 15: // åŠ´ç½ç™ºç”Ÿ
        case 16:
            company.cannotProduce = true;
            break;
        case 17: // åºƒå‘Šæ”¿ç­–å¤±æ•—
        case 18:
            if (company.chips.advertising > 0) {
                company.chips.advertising--;
            } else if (company.nextPeriodChips.advertising > 0) {
                company.nextPeriodChips.advertising--;
            }
            break;
        case 19: // ç‰¹åˆ¥ã‚µãƒ¼ãƒ“ã‚¹
        case 20:
            // AIã¯ææ–™è³¼å…¥ã‚’é¸æŠï¼ˆ5å€‹ã¾ã§1å€‹10å††ï¼‰
            const buyQty = Math.min(5, Math.floor(company.cash / 10));
            if (buyQty > 0) {
                company.cash -= buyQty * 10;
                company.materials += buyQty;
            }
            break;
        case 21: // è¿”å“ç™ºç”Ÿ
        case 22:
        case 23:
            if (gameState.currentPeriod !== 2) {
                company.totalSales -= 20;
                company.products++;
            }
            break;
        case 24: // ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ãƒ¼ãƒˆãƒ©ãƒ–ãƒ«
        case 25:
            company.cash = Math.max(0, company.cash - 10);
            if (!company.additionalFixedCost) company.additionalFixedCost = 0;
            company.additionalFixedCost += 10;  // Fã«è¨ˆä¸Š
            break;
        case 26: // å•†å“ã®ç‹¬å è²©å£²
        case 27:
        case 28:
            const sellQtyMonopoly = Math.min(company.salesmen * 2, company.products, 5);
            if (sellQtyMonopoly > 0) {
                company.cash += sellQtyMonopoly * 32;
                company.products -= sellQtyMonopoly;
                company.totalSales += sellQtyMonopoly * 32;
                company.totalSoldQuantity = (company.totalSoldQuantity || 0) + sellQtyMonopoly;
            }
            break;
        case 29: // è£½é€ ãƒŸã‚¹ç™ºç”Ÿ
        case 30:
            if (company.wip > 0) {
                company.wip--;
                company.specialLoss = (company.specialLoss || 0) + 14;
            }
            break;
        case 31: // å€‰åº«ç«ç½
        case 32:
            {
                const lostMaterials = company.materials;
                const materialValue = lostMaterials * 13;
                if (company.chips.insurance > 0) {
                    const compensation = lostMaterials * 8;
                    company.cash += compensation;
                    company.chips.insurance = 0;
                    company.specialLoss = (company.specialLoss || 0) + (materialValue - compensation);
                } else {
                    company.specialLoss = (company.specialLoss || 0) + materialValue;
                }
                company.materials = 0;
            }
            break;
        case 33: // ç¸æ•…æ¡ç”¨
        case 34:
            company.cash = Math.max(0, company.cash - 5);
            company.extraLaborCost = (company.extraLaborCost || 0) + 5;  // äººä»¶è²»
            // AIã¯ãƒ©ãƒ³ãƒ€ãƒ ã§ãƒ¯ãƒ¼ã‚«ãƒ¼ã‹ã‚»ãƒ¼ãƒ«ã‚¹ãƒãƒ³ã‚’è¿½åŠ 
            if (Math.random() > 0.5) {
                company.workers++;
            } else {
                company.salesmen++;
            }
            break;
        case 35: // ç ”ç©¶é–‹ç™ºæˆåŠŸ
        case 36:
        case 37:
        case 38:
        case 39:
        case 40:
            if (company.chips.research > 0 && company.products > 0) {
                const salesCapacity = getSalesCapacity(company);
                const sellQty = Math.min(company.chips.research * 2, company.products, salesCapacity, 5);
                company.cash += sellQty * 32;
                company.products -= sellQty;
                company.totalSales += sellQty * 32;
                company.totalSoldQuantity = (company.totalSoldQuantity || 0) + sellQty;
            }
            break;
        case 41: // å„ç¤¾å…±é€š
        case 42:
            executeAllCompaniesCommonPurchaseFromAI(company);
            return;
        case 43: // ã‚¹ãƒˆãƒ©ã‚¤ã‚­ç™ºç”Ÿ
        case 44:
            company.skipTurns = 1;
            rowUsed = false;
            break;
        case 45: // ç›—é›£ç™ºè¦‹
        case 46:
            {
                const stolen = Math.min(2, company.products);
                const productValue = stolen * 15;
                if (company.chips.insurance > 0) {
                    const compensation = stolen * 10;
                    company.cash += compensation;
                    company.chips.insurance = 0;
                    company.specialLoss = (company.specialLoss || 0) + (productValue - compensation);
                } else {
                    company.specialLoss = (company.specialLoss || 0) + productValue;
                }
                company.products -= stolen;
                const overseasMarket = gameState.markets.find(m => m.name === 'æµ·å¤–');
                if (overseasMarket) overseasMarket.currentStock += stolen;
            }
            break;
        case 47: // é•·æœŸåŠ´å‹™ç´›äº‰
        case 48:
            company.skipTurns = 2;
            rowUsed = false;
            break;
        case 49: // è¨­è¨ˆãƒˆãƒ©ãƒ–ãƒ«ç™ºç”Ÿ
        case 50:
            company.cash = Math.max(0, company.cash - 10);
            if (!company.additionalFixedCost) company.additionalFixedCost = 0;
            company.additionalFixedCost += 10;  // Fã«è¨ˆä¸Š
            break;
        case 51: // ãƒ¯ãƒ¼ã‚«ãƒ¼é€€è·
        case 52:
            company.cash = Math.max(0, company.cash - 5);
            company.extraLaborCost = (company.extraLaborCost || 0) + 5;  // äººä»¶è²»
            if (company.workers > 0) {
                company.workers--;
                company.retiredWorkers = (company.retiredWorkers || 0) + 1;  // é€€è·è€…è¿½è·¡
            }
            break;
        case 53: // æ™¯æ°—å¤‰å‹•
        case 54:
            gameState.turnReversed = !gameState.turnReversed;
            break;
        case 55: // æ•™è‚²å¤±æ•—
        case 56:
            if (company.chips.education > 0) {
                company.chips.education--;
            } else if (company.nextPeriodChips.education > 0) {
                company.nextPeriodChips.education--;
            }
            break;
        case 57: // ã‚»ãƒ¼ãƒ«ã‚¹ãƒãƒ³é€€è·
        case 58:
            company.cash = Math.max(0, company.cash - 5);
            company.extraLaborCost = (company.extraLaborCost || 0) + 5;  // äººä»¶è²»
            if (company.salesmen > 0) {
                company.salesmen--;
                company.retiredSalesmen = (company.retiredSalesmen || 0) + 1;  // é€€è·è€…è¿½è·¡
            }
            break;
        case 59: // ç¤¾é•·ã€ç—…æ°—ã§å€’ã‚Œã‚‹
        case 60:
            company.skipTurns = 1;
            rowUsed = false;
            break;
        case 61: // ä¸è‰¯åœ¨åº«ç™ºç”Ÿï¼ˆä¿é™ºå¯¾è±¡å¤–ï¼‰
        case 62:
            let totalInv = company.materials + company.wip + company.products;
            if (totalInv > 20) {
                let excess = totalInv - 20;
                let lostVal = 0;
                if (company.products > 0 && excess > 0) {
                    const remove = Math.min(company.products, excess);
                    company.products -= remove;
                    lostVal += remove * 15;
                    excess -= remove;
                }
                if (company.wip > 0 && excess > 0) {
                    const remove = Math.min(company.wip, excess);
                    company.wip -= remove;
                    lostVal += remove * 14;
                    excess -= remove;
                }
                if (company.materials > 0 && excess > 0) {
                    const remove = Math.min(company.materials, excess);
                    company.materials -= remove;
                    lostVal += remove * 13;
                }
                company.specialLoss = (company.specialLoss || 0) + lostVal;
            }
            break;
        case 63: // æ©Ÿæ¢°æ•…éšœ
        case 64:
            company.cash = Math.max(0, company.cash - 5);
            if (!company.additionalFixedCost) company.additionalFixedCost = 0;
            company.additionalFixedCost += 5;
            break;
        default:
            break;
    }

    if (rowUsed) {
        endTurn();
    } else {
        nextTurn();
    }
}

// Execute common purchase when AI draws the card
function executeAllCompaniesCommonPurchaseFromAI(aiCompany) {
    const playerCompany = gameState.companies[0];
    const content = `
        <div class="risk-display">
            <div class="risk-title">${aiCompany.name}ãŒã€Œå„ç¤¾å…±é€šã€ã‚’å¼•ãã¾ã—ãŸ</div>
            <div class="risk-description">å…¨ç¤¾ãŒ12å††ã§3å€‹ã¾ã§ææ–™ã‚’è³¼å…¥ã§ãã¾ã™<br>ï¼ˆã¾ãšå¸‚å ´ã‹ã‚‰ã€ä¸è¶³åˆ†ã¯æµ·å¤–ã‹ã‚‰ï¼‰</div>
        </div>
        <div style="margin-top: 20px;">
            <p>ç¾åœ¨ã®ç¾é‡‘: Â¥${playerCompany.cash}</p>
            <div class="form-group">
                <label class="form-label">ã‚ãªãŸã®è³¼å…¥æ•°é‡:</label>
                <select id="playerQuantity" class="form-control">
                    <option value="0">è³¼å…¥ã—ãªã„</option>
                    <option value="1">1å€‹è³¼å…¥ï¼ˆÂ¥12ï¼‰</option>
                    <option value="2">2å€‹è³¼å…¥ï¼ˆÂ¥24ï¼‰</option>
                    <option value="3">3å€‹è³¼å…¥ï¼ˆÂ¥36ï¼‰</option>
                </select>
            </div>
            <button class="submit-btn" onclick="processAICommonPurchase()">æ±ºå®š</button>
        </div>
    `;
    
    showModal('å„ç¤¾å…±é€šè³¼å…¥', content);
    
    // AIä¼šç¤¾ã‚’ä¸€æ™‚ä¿å­˜
    gameState.aiCommonPurchase = aiCompany;
}

// Process AI common purchase
function processAICommonPurchase() {
    const playerQty = parseInt(document.getElementById('playerQuantity').value || 0);
    const playerCompany = gameState.companies[0];
    const aiCompany = gameState.aiCommonPurchase;

    let purchaseLog = [];
    let playerPurchased = false;  // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒå®Ÿéš›ã«è³¼å…¥ã—ãŸã‹ã©ã†ã‹

    // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®è³¼å…¥å‡¦ç†
    if (playerQty > 0) {
        const cost = playerQty * 12;
        if (playerCompany.cash >= cost) {
            let purchased = 0;

            // ã¾ãšå¸‚å ´ã‹ã‚‰è³¼å…¥
            for (const market of gameState.markets) {
                if (purchased >= playerQty) break;
                if (market.currentStock > 0) {
                    const qty = Math.min(playerQty - purchased, market.currentStock);
                    market.currentStock -= qty;
                    purchased += qty;
                }
            }

            // ä¸è¶³åˆ†ã¯æµ·å¤–å¸‚å ´ï¼ˆã‚¹ãƒˆãƒƒã‚«ãƒ¼ï¼‰ã‹ã‚‰
            const overseasMarket = gameState.markets.find(m => m.name === 'æµ·å¤–');
            if (purchased < playerQty && overseasMarket) {
                const qty = playerQty - purchased;
                overseasMarket.currentStock = Math.max(0, overseasMarket.currentStock - qty);
                purchased += qty;
            }

            playerCompany.cash -= cost;
            playerCompany.materials += playerQty;
            playerCompany.totalMaterialCost += cost;
            playerPurchased = true;  // ãŠé‡‘ã®æµã‚ŒãŒã‚ã£ãŸ

            // è¡Œå‹•ãƒ­ã‚°è¨˜éŒ²
            logAction(0, 'å„ç¤¾å…±é€š', `Â¥12Ã—${playerQty}å€‹è³¼å…¥`, -cost, true);

            purchaseLog.push(`ã‚ãªãŸ: ${playerQty}å€‹è³¼å…¥ï¼ˆÂ¥${cost}ï¼‰`);
        } else {
            purchaseLog.push('ã‚ãªãŸ: ç¾é‡‘ä¸è¶³ã§è³¼å…¥ã§ããš');
        }
    } else {
        purchaseLog.push('ã‚ãªãŸ: è³¼å…¥ã—ãªã„');
    }

    // å…¨AIä¼šç¤¾ã®è³¼å…¥å‡¦ç†ï¼ˆãƒ—ãƒ­ã¯12å††ã§3å€‹å¿…ãšè²·ã†ï¼‰
    for (let i = 1; i < gameState.companies.length; i++) {
        const company = gameState.companies[i];
        const maxAffordable = Math.min(3, Math.floor(company.cash / 12));

        if (maxAffordable >= 2) {  // 2å€‹ä»¥ä¸Šè²·ãˆã‚‹ãªã‚‰è²·ã†
            const aiQty = maxAffordable;
            let purchased = 0;

            // ã¾ãšå¸‚å ´ã‹ã‚‰è³¼å…¥
            for (const market of gameState.markets) {
                if (purchased >= aiQty) break;
                if (market.currentStock > 0) {
                    const buyQty = Math.min(aiQty - purchased, market.currentStock);
                    market.currentStock -= buyQty;
                    purchased += buyQty;
                }
            }

            // ä¸è¶³åˆ†ã¯æµ·å¤–å¸‚å ´ã‹ã‚‰
            const overseasMarket = gameState.markets.find(m => m.name === 'æµ·å¤–');
            if (purchased < aiQty && overseasMarket) {
                const buyQty = aiQty - purchased;
                overseasMarket.currentStock = Math.max(0, overseasMarket.currentStock - buyQty);
                purchased += buyQty;
            }

            if (purchased > 0) {
                const aiCost = purchased * 12;
                company.cash -= aiCost;
                company.materials += purchased;
                company.totalMaterialCost += aiCost;

                // è¡Œå‹•ãƒ­ã‚°è¨˜éŒ²ï¼ˆAIï¼‰
                logAction(i, 'å„ç¤¾å…±é€š', `Â¥12Ã—${purchased}å€‹è³¼å…¥`, -aiCost, false);

                purchaseLog.push(`${company.name}: ${purchased}å€‹è³¼å…¥ï¼ˆÂ¥${aiCost}ï¼‰`);
            }
        }
    }

    closeModal();
    updateDisplay();

    // è³¼å…¥çµæœã‚’è¡¨ç¤º
    alert('ã€å„ç¤¾å…±é€šè³¼å…¥çµæœã€‘\n' + purchaseLog.join('\n'));

    // AIã®ã‚¿ãƒ¼ãƒ³ã‚’çµ‚äº†
    gameState.aiCommonPurchase = null;

    // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒè³¼å…¥ã—ãŸå ´åˆã®ã¿1è¡Œä½¿ç”¨ï¼ˆãŠé‡‘ã®æµã‚ŒãŒã‚ã£ãŸå ´åˆï¼‰
    if (playerPurchased) {
        endTurn();
    } else {
        nextTurn();
    }
}

// AIè¡Œå‹•è¡¨ç¤ºãƒ¢ãƒ¼ãƒ€ãƒ«
function showAIActionModal(company, actionType, actionIcon, actionDetail, resultData = null) {
    const companyEmojis = {
        'Aç¤¾': 'ğŸ…°ï¸', 'Bç¤¾': 'ğŸ…±ï¸', 'Cç¤¾': 'Â©ï¸', 'Dç¤¾': 'ğŸ‡©', 'Eç¤¾': 'ğŸ‡ª'
    };

    let resultHtml = '';
    if (resultData) {
        resultHtml = '<div class="ai-action-result">';
        resultData.forEach(row => {
            resultHtml += `<div class="ai-action-result-row ${row.highlight ? 'highlight' : ''}">
                <span>${row.label}</span>
                <span>${row.value}</span>
            </div>`;
        });
        resultHtml += '</div>';
    }

    const modalHtml = `
        <div class="ai-action-modal" id="aiActionModal">
            <div class="ai-action-header">
                <div class="ai-action-avatar">${companyEmojis[company.name] || 'ğŸ¢'}</div>
                <div class="ai-action-company-info">
                    <div class="ai-action-company-name">${company.name}</div>
                    <div class="ai-action-company-cash">ç¾é‡‘: Â¥${company.cash}</div>
                </div>
            </div>
            <div class="ai-action-body">
                <div class="ai-action-icon">${actionIcon}</div>
                <div class="ai-action-type">${actionType}</div>
                <div class="ai-action-detail">${actionDetail}</div>
                ${resultHtml}
            </div>
            <button class="ai-action-continue-btn" onclick="closeAIActionModal()">OK</button>
        </div>
    `;

    document.getElementById('modalContainer').innerHTML = modalHtml;
}

// AIè¡Œå‹•ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã¦æ¬¡ã®ã‚¿ãƒ¼ãƒ³ã¸
function closeAIActionModal() {
    document.getElementById('modalContainer').innerHTML = '';
    nextTurn();
}

// Execute AI turn
function executeAITurn() {
    // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚¿ãƒ¼ãƒ³ã®å ´åˆã¯å®Ÿè¡Œã—ãªã„ï¼ˆå®‰å…¨ã‚¬ãƒ¼ãƒ‰ï¼‰
    if (gameState.currentPlayerIndex === 0) {
        console.warn('executeAITurn called during player turn - aborting');
        return;
    }
    const company = gameState.companies[gameState.currentPlayerIndex];

    if (company.skipTurns > 0) {
        company.skipTurns--;
        nextTurn();
        return;
    }

    // ã‚«ãƒ¼ãƒ‰ãƒ‡ãƒƒã‚­ã‹ã‚‰å¼•ãï¼ˆãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¨åŒæ§˜ï¼‰
    if (!gameState.deckInitialized || gameState.cardDeck.length === 0) {
        initializeCardDeck();
    }

    const cardType = gameState.cardDeck.pop();
    console.log(`${company.name}ãŒã‚«ãƒ¼ãƒ‰ã‚’å¼•ãã¾ã—ãŸ: ${cardType}ï¼ˆæ®‹ã‚Š${gameState.cardDeck.length}æšï¼‰`);

    if (cardType === 'risk') {
        const availableCards = gameState.riskCards.filter(card => {
            if (gameState.currentPeriod === 2 && card.period2Exempt) return false;
            return !gameState.usedRiskCards.includes(card.id);
        });

        if (availableCards.length > 0) {
            const card = availableCards[Math.floor(Math.random() * availableCards.length)];
            gameState.usedRiskCards.push(card.id);
            console.log(`${company.name}ãŒãƒªã‚¹ã‚¯ã‚«ãƒ¼ãƒ‰ã€Œ${card.name}ã€ã‚’å¼•ãã¾ã—ãŸ`);

            // Apply risk card effect to AI
            applyRiskCardToAI(company, card);

            // ãƒªã‚¹ã‚¯ã‚«ãƒ¼ãƒ‰ã‚’å¼•ã„ãŸã“ã¨ã‚’é€šçŸ¥
            showAIActionModal(company, `ãƒªã‚¹ã‚¯ã‚«ãƒ¼ãƒ‰: ${card.name}`, 'âš ï¸', card.description);
            return; // ãƒªã‚¹ã‚¯ã‚«ãƒ¼ãƒ‰ã‚’å¼•ã„ãŸã‚‰ã‚¿ãƒ¼ãƒ³çµ‚äº†
        }
        // åˆ©ç”¨å¯èƒ½ãªãƒªã‚¹ã‚¯ã‚«ãƒ¼ãƒ‰ãŒãªã„å ´åˆã¯æ„æ€æ±ºå®šã¸
    }
    
    // ç·Šæ€¥æ¡ç”¨ãƒã‚§ãƒƒã‚¯ï¼ˆãƒ¯ãƒ¼ã‚«ãƒ¼ã¾ãŸã¯ã‚»ãƒ¼ãƒ«ã‚¹ãƒãƒ³ãŒ0äººï¼‰
    if (company.workers === 0 || company.salesmen === 0) {
        // ç·Šæ€¥æ¡ç”¨ã‚’å®Ÿè¡Œ
        let hireWorkers = 0;
        let hireSalesmen = 0;
        
        if (company.workers === 0) {
            hireWorkers = 1; // æœ€ä½1äººæ¡ç”¨
        }
        if (company.salesmen === 0) {
            hireSalesmen = 1; // æœ€ä½1äººæ¡ç”¨
        }
        
        const cost = (hireWorkers + hireSalesmen) * 5;
        if (company.cash >= cost) {
            company.cash -= cost;
            company.workers += hireWorkers;
            company.salesmen += hireSalesmen;
            incrementRow(gameState.companies.indexOf(company));
            
            let detail = '';
            if (hireWorkers > 0) detail += `ãƒ¯ãƒ¼ã‚«ãƒ¼ ${hireWorkers}äºº`;
            if (hireSalesmen > 0) detail += `${hireWorkers > 0 ? 'ã€' : ''}ã‚»ãƒ¼ãƒ«ã‚¹ãƒãƒ³ ${hireSalesmen}äºº`;

            showAIActionModal(company, 'ç·Šæ€¥æ¡ç”¨', 'ğŸ‘¥', detail, [
                { label: 'æ¡ç”¨è²»', value: `Â¥${cost}` }
            ]);
            return;
        } else {
            // ç¾é‡‘ä¸è¶³ã®å ´åˆã¯çŸ­æœŸå€Ÿå…¥
            const needed = Math.ceil((cost - company.cash) / 0.8 / 50) * 50;
            company.shortLoans += needed;
            company.cash += needed * 0.8;  // çŸ­æœŸå€Ÿå…¥: å€Ÿå…¥æ™‚20%é‡‘åˆ©æ§é™¤
            company.cash -= cost;
            company.workers += hireWorkers;
            company.salesmen += hireSalesmen;
            incrementRow(gameState.companies.indexOf(company));

            let detail = '';
            if (hireWorkers > 0) detail += `ãƒ¯ãƒ¼ã‚«ãƒ¼ ${hireWorkers}äºº`;
            if (hireSalesmen > 0) detail += `${hireWorkers > 0 ? 'ã€' : ''}ã‚»ãƒ¼ãƒ«ã‚¹ãƒãƒ³ ${hireSalesmen}äºº`;

            showAIActionModal(company, 'ç·Šæ€¥æ¡ç”¨', 'ğŸ‘¥', detail, [
                { label: 'çŸ­æœŸå€Ÿå…¥', value: `Â¥${needed}` },
                { label: 'æ¡ç”¨è²»', value: `Â¥${cost}` }
            ]);
            return;
        }
    }
    
    // AIæ€§æ ¼åˆ¥æˆ¦ç•¥å®Ÿè¡Œ
    const mfgCapacity = getManufacturingCapacity(company);
    const salesCapacity = getSalesCapacity(company);
    
    // AIåˆ†æãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
    const analysis = getAIFinancialAnalysis(company);
    executeAIStrategyByType(company, mfgCapacity, salesCapacity, analysis);
}

// AIè²¡å‹™åˆ†æï¼ˆè³¢ã„åˆ¤æ–­ã®ãŸã‚ã®ãƒ‡ãƒ¼ã‚¿åé›† - 5æœŸçµ‚äº†æ™‚è‡ªå·±è³‡æœ¬æœ€å¤§åŒ–å¿—å‘ï¼‰
function getAIFinancialAnalysis(company) {
    const period = gameState.currentPeriod;
    const rowsRemaining = gameState.maxRows - (company.currentRow || 1);
    const periodsRemaining = 5 - period;  // æ®‹ã‚ŠæœŸæ•°

    // æœŸæœ«å¿…è¦è³‡é‡‘ï¼ˆçµ¦æ–™ + å€Ÿå…¥è¿”æ¸ˆï¼‰
    const periodEndCost = calculatePeriodPayment(company);
    const fixedCost = calculateFixedCost(company);

    // ä»–ç¤¾ã¨ã®æ¯”è¼ƒ
    const rivals = gameState.companies.filter(c => c !== company);
    const avgRivalEquity = rivals.reduce((sum, c) => sum + c.equity, 0) / rivals.length;
    const maxRivalEquity = Math.max(...rivals.map(c => c.equity));
    const equityRank = gameState.companies.filter(c => c.equity > company.equity).length + 1;

    // MQæ¨å®šï¼ˆç¾åœ¨ã®è²©å£²èƒ½åŠ›ã¨è£½å“ã‹ã‚‰ï¼‰
    const salesCapacity = getSalesCapacity(company);
    const potentialSales = Math.min(company.products, salesCapacity);
    const estimatedPQ = potentialSales * 28; // å¹³å‡è²©å£²ä¾¡æ ¼æ¨å®š
    const estimatedMQ = estimatedPQ - (potentialSales * 15); // ææ–™è²»å·®ã—å¼•ã

    // åœ¨åº«çŠ¶æ³
    const totalInventory = company.materials + company.wip + company.products;
    const needsMaterials = company.materials < 3;
    const needsProduction = company.wip > 0 || company.materials > company.wip;
    const canSell = company.products > 0 && salesCapacity > 0;

    // è³‡é‡‘ä½™è£•åº¦
    const cashSafety = company.cash - periodEndCost;
    const isCashTight = cashSafety < 50;

    // é•·æœŸå€Ÿå…¥å¯èƒ½é¡ï¼ˆ3æœŸã¯0.5å€ã€4æœŸä»¥é™ã§300è¶…ãªã‚‰1å€ï¼‰
    const loanMultiplier = (period >= 4 && company.equity > 300) ? 1.0 : 0.5;
    const maxLongLoan = Math.round(company.equity * loanMultiplier);
    const availableLoan = Math.max(0, maxLongLoan - company.loans);
    const canBorrow = period >= 3 && availableLoan > 0;

    // === é•·æœŸæˆ¦ç•¥åˆ†æï¼ˆ5æœŸçµ‚äº†æ™‚è‡ªå·±è³‡æœ¬æœ€å¤§åŒ–ï¼‰ ===
    const mfgCapacity = getManufacturingCapacity(company);

    // æ¬¡æœŸã¸ã®æŠ•è³‡ä¾¡å€¤ï¼ˆç ”ç©¶ãƒãƒƒãƒ—ã¯ä¾¡æ ¼ç«¶äº‰åŠ›+2 â†’ å…¥æœ­å‹ç‡å‘ä¸Š â†’ MQå¢—åŠ ï¼‰
    const researchChipValue = periodsRemaining * 2 * 5;  // æ®‹ã‚ŠæœŸæ•° Ã— ä¾¡æ ¼ç«¶äº‰åŠ› Ã— æ¨å®šè²©å£²å›æ•°
    const shouldInvestForFuture = periodsRemaining >= 2 && !isCashTight && company.chips.research < 4;

    // èƒ½åŠ›ãƒãƒ©ãƒ³ã‚¹ï¼ˆé•·æœŸçš„ã«è£½é€ =è²©å£²ãŒç†æƒ³ï¼‰
    const capacityBalance = mfgCapacity - salesCapacity;
    const needsCapacityBalance = Math.abs(capacityBalance) >= 2;

    // 5æœŸã¯æŠ•è³‡ã›ãšå£²ã‚Šåˆ‡ã‚Šå„ªå…ˆï¼ˆå›åæœŸï¼‰
    const isFinalPeriod = period === 5;
    const isRecoveryPhase = period >= 4 && rowsRemaining < 10;

    return {
        period,
        periodsRemaining,
        rowsRemaining,
        periodEndCost,
        fixedCost,
        avgRivalEquity,
        maxRivalEquity,
        equityRank,
        estimatedMQ,
        totalInventory,
        needsMaterials,
        needsProduction,
        canSell,
        cashSafety,
        isCashTight,
        maxLongLoan,
        canBorrow,
        // é•·æœŸæˆ¦ç•¥
        shouldInvestForFuture,
        researchChipValue,
        capacityBalance,
        needsCapacityBalance,
        isFinalPeriod,
        isRecoveryPhase,
        // æ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³å„ªå…ˆåº¦
        shouldSellFirst: canSell && (isCashTight || rowsRemaining < 5 || isFinalPeriod),
        shouldInvest: !isCashTight && rowsRemaining > 10 && !isRecoveryPhase,
        shouldBeAggressive: equityRank > 3 && rowsRemaining > 5 && !isFinalPeriod
    };
}

// AIæ€§æ ¼åˆ¥ã®æˆ¦ç•¥å®Ÿè¡Œ
function executeAIStrategyByType(company, mfgCapacity, salesCapacity, analysis) {
    // çµ¦æ–™æ”¯æ‰•ã„ã‚’è€ƒæ…®ï¼šæ®‹ã‚Š5è¡Œä»¥ä¸‹ã‹ã¤è³‡é‡‘ä¸è¶³ãªã‚‰è²©å£²å„ªå…ˆ
    if (analysis.rowsRemaining <= 5 && analysis.isCashTight && company.products > 0 && salesCapacity > 0) {
        executeDefaultSale(company, salesCapacity, 0.85);
        return;
    }

    // æ¬¡æœŸãƒãƒƒãƒ—æŠ•è³‡ï¼ˆ3æœŸä»¥é™ã€ä½™è£•ãŒã‚ã‚Œã°ï¼‰
    if (gameState.currentPeriod >= 3 && !analysis.isCashTight && analysis.rowsRemaining > 3) {
        const chipCost = 40;
        if (company.cash > analysis.periodEndCost + chipCost + 50) {
            // ç ”ç©¶ãƒãƒƒãƒ—å„ªå…ˆï¼ˆæ¬¡æœŸã«æŒã¡è¶Šã—ï¼‰
            if (company.nextPeriodChips.research < 3 && Math.random() > 0.5) {
                company.cash -= chipCost;
                company.nextPeriodChips.research++;
                incrementRow(gameState.companies.indexOf(company));
                showAIActionModal(company, 'ãƒãƒƒãƒ—è³¼å…¥(æ¬¡æœŸ)', 'ğŸ”¬', 'ç ”ç©¶é–‹ç™ºãƒãƒƒãƒ—ã‚’æ¬¡æœŸç”¨ã«è³¼å…¥');
                return;
            }
        }
    }

    switch(company.strategy) {
        case 'aggressive':    // Aç¤¾ï¼šç©æ¥µçš„
            executeAggressiveStrategy(company, mfgCapacity, salesCapacity, analysis);
            break;
        case 'conservative':  // Cç¤¾ï¼šä¿å®ˆçš„
            executeConservativeStrategy(company, mfgCapacity, salesCapacity, analysis);
            break;
        case 'price_focused': // Dç¤¾ï¼šä¾¡æ ¼ç«¶äº‰
            executePriceFocusedStrategy(company, mfgCapacity, salesCapacity, analysis);
            break;
        case 'tech_focused':  // Eç¤¾ï¼šæŠ€è¡“é‡è¦–
            executeTechFocusedStrategy(company, mfgCapacity, salesCapacity, analysis);
            break;
        case 'unpredictable': // Fç¤¾ï¼šäºˆæ¸¬ä¸èƒ½
            executeUnpredictableStrategy(company, mfgCapacity, salesCapacity, analysis);
            break;
        default:             // Bç¤¾ï¼šãƒãƒ©ãƒ³ã‚¹
            executeBalancedStrategy(company, mfgCapacity, salesCapacity, analysis);
    }
}

// Aç¤¾ï¼šç©æ¥µçš„æˆ¦ç•¥ï¼ˆMQæœ€å¤§åŒ–é‡è¦–ãƒ»é•·æœŸå¿—å‘ï¼‰
function executeAggressiveStrategy(company, mfgCapacity, salesCapacity, analysis) {
    // MQã‚’æœ€å¤§åŒ–ã™ã‚‹ãŸã‚ã®æˆ¦ç•¥çš„åˆ¤æ–­ï¼ˆ5æœŸçµ‚äº†æ™‚è‡ªå·±è³‡æœ¬æœ€å¤§åŒ–ï¼‰
    const periodEndCost = calculatePeriodPayment(company);
    const safetyMargin = periodEndCost + 30;
    const chipCost = gameState.currentPeriod === 2 ? 20 : 40;

    // === 5æœŸï¼ˆæœ€çµ‚æœŸï¼‰ã¯å£²ã‚Šåˆ‡ã‚Šå„ªå…ˆ ===
    if (analysis.isFinalPeriod) {
        if (company.products > 0 && salesCapacity > 0) {
            executeDefaultSale(company, salesCapacity, 0.70);
            return;
        }
        if ((company.materials > 0 || company.wip > 0) && mfgCapacity > 0) {
            executeDefaultProduction(company, mfgCapacity);
            return;
        }
        nextTurn();
        return;
    }

    // === 4æœŸå¾ŒåŠã¯å›åãƒ•ã‚§ãƒ¼ã‚º ===
    if (analysis.isRecoveryPhase && company.products > 0 && salesCapacity > 0) {
        executeDefaultSale(company, salesCapacity, 0.72);
        return;
    }

    // 1. è²©å£²å„ªå…ˆï¼ˆPQã‚’å¢—ã‚„ã™ - 7å‰²ä»¥ä¸Šã§ï¼‰
    if (company.products > 0 && salesCapacity > 0) {
        const minSellQty = Math.ceil(salesCapacity * 0.7);
        if (company.products >= minSellQty) {
            executeDefaultSale(company, salesCapacity, 0.70);  // Aç¤¾ã¯ç©æ¥µçš„ãªä½ä¾¡æ ¼
            return;
        }
    }

    // 2. ç”Ÿç”£æœ€å¤§åŒ–ï¼ˆåœ¨åº«ã‚’è£½å“ã«å¤‰æ›ï¼‰
    if ((company.materials > 0 || company.wip > 0) && mfgCapacity > 0) {
        executeDefaultProduction(company, mfgCapacity);
        return;
    }

    // 3. ææ–™è³¼å…¥ï¼ˆ7å‰²ä»¥ä¸Šã®è£½é€ èƒ½åŠ›ã§ï¼‰
    if (company.cash > safetyMargin + 40 && company.materials < mfgCapacity) {
        executeDefaultMaterialPurchase(company, mfgCapacity);
        return;
    }

    // 4. é•·æœŸæŠ•è³‡ï¼ˆæ®‹ã‚ŠæœŸæ•°ã‚’è€ƒæ…®ï¼‰
    if (company.cash > safetyMargin + chipCost && analysis.rowsRemaining > 5 && !analysis.isRecoveryPhase) {
        // ç ”ç©¶ãƒãƒƒãƒ—å„ªå…ˆï¼ˆé•·æœŸçš„ã«MQå¢—åŠ ã«ç›´çµï¼‰
        if (analysis.shouldInvestForFuture && company.chips.research < 5 && company.cash >= chipCost + safetyMargin) {
            company.cash -= chipCost;
            company.chips.research++;
            incrementRow(gameState.companies.indexOf(company));
            showAIActionModal(company, 'ãƒãƒƒãƒ—è³¼å…¥', 'ğŸ”¬', 'ç ”ç©¶é–‹ç™ºãƒãƒƒãƒ—è³¼å…¥ï¼ˆé•·æœŸæŠ•è³‡ï¼‰');
            return;
        }

        // æ¬¡æœŸç”¨ãƒãƒƒãƒ—è³¼å…¥ï¼ˆç©æ¥µçš„ã«ï¼‰
        if (gameState.currentPeriod >= 3 && analysis.periodsRemaining >= 2) {
            if (company.nextPeriodChips.research < 3 && company.cash >= chipCost + safetyMargin + 30) {
                company.cash -= chipCost;
                company.nextPeriodChips.research++;
                incrementRow(gameState.companies.indexOf(company));
                showAIActionModal(company, 'ãƒãƒƒãƒ—è³¼å…¥(æ¬¡æœŸ)', 'ğŸ”¬', 'æ¬¡æœŸç”¨ç ”ç©¶ãƒãƒƒãƒ—è³¼å…¥');
                return;
            }
        }

        // ãƒœãƒˆãƒ«ãƒãƒƒã‚¯è§£æ¶ˆæŠ•è³‡
        if (analysis.needsCapacityBalance && analysis.capacityBalance > 0) {
            if (company.chips.advertising < 3 && company.cash >= chipCost + safetyMargin) {
                company.cash -= chipCost;
                company.chips.advertising++;
                incrementRow(gameState.companies.indexOf(company));
                showAIActionModal(company, 'ãƒãƒƒãƒ—è³¼å…¥', 'ğŸ“¢', 'åºƒå‘Šãƒãƒƒãƒ—è³¼å…¥');
                return;
            }
        }
    }
    
    // è²©å£²æœ€å„ªå…ˆ
    if (company.products >= salesCapacity && salesCapacity > 0) {
        // Find best market (high price, has space)
        const availableMarkets = gameState.markets.filter(m => 
            m.currentStock < m.maxStock && 
            (gameState.currentPeriod > 2 || m.name !== 'æµ·å¤–')
        ).sort((a, b) => b.sellPrice - a.sellPrice);
        
        if (availableMarkets.length > 0) {
            const market = availableMarkets[0];
            const sellQty = Math.min(salesCapacity, company.products, market.maxStock - market.currentStock);
            
            if (market.needsBid) {
                // Check if player wants to participate
                const playerCompany = gameState.companies[0];
                
                if (playerCompany.products > 0) {
                    // Store AI company's bid info and ask player
                    gameState.aiPendingBid = {
                        company: gameState.currentPlayerIndex,
                        market: market,
                        marketIndex: gameState.markets.indexOf(market),
                        price: Math.floor(market.sellPrice * (0.7 + Math.random() * 0.25)) - getPriceCompetitiveness(company),
                        quantity: sellQty
                    };
                    
                    // Show modal to ask player if they want to bid
                    showAIBidNotification();
                    return; // Exit here, will continue after player decides
                }
                
                // Process bidding with all companies (player has no products)
                const allBids = [];
                
                // ä¾¡æ ¼è¨­å®šï¼ˆæ€§æ ¼ã«ã‚ˆã‚Šå¤‰å‹•ï¼‰
                let priceMultiplier = 0.7 + Math.random() * 0.25;
                if (company.strategy === 'price_focused') {
                    priceMultiplier = 0.6 + Math.random() * 0.2;  // Dç¤¾ï¼šã‚ˆã‚Šä½ä¾¡æ ¼
                } else if (company.strategy === 'conservative') {
                    priceMultiplier = 0.75 + Math.random() * 0.2; // Cç¤¾ï¼šå®‰å®šä¾¡æ ¼
                } else if (company.strategy === 'aggressive') {
                    priceMultiplier = 0.65 + Math.random() * 0.25; // Aç¤¾ï¼šç©æ¥µçš„ä¾¡æ ¼
                }
                
                // Current AI company's bid
                const bidPrice = Math.floor(market.sellPrice * priceMultiplier) - getPriceCompetitiveness(company);
                const displayPrice = Math.floor(market.sellPrice * priceMultiplier);
                allBids.push({company: gameState.currentPlayerIndex, price: bidPrice, quantity: sellQty, displayPrice: displayPrice});
                
                // All other companies (including player) also bid if they have products
                for (let i = 0; i < gameState.companies.length; i++) {
                    if (i !== gameState.currentPlayerIndex) {
                        const otherCompany = gameState.companies[i];
                        if (otherCompany.products > 0) {
                            const otherCapacity = getSalesCapacity(otherCompany);
                            const otherQty = Math.min(otherCapacity, otherCompany.products, market.maxStock - market.currentStock);
                            if (otherQty > 0) {
                                let otherPrice;
                                if (i === 0) {
                                    // Player company - use strategic pricing
                                    otherPrice = Math.floor(market.sellPrice * 0.85) - getPriceCompetitiveness(otherCompany);
                                } else {
                                    // AI company
                                    otherPrice = Math.floor(market.sellPrice * (0.7 + Math.random() * 0.25)) - getPriceCompetitiveness(otherCompany);
                                }
                                const otherDisplayPrice = i === 0 ? Math.floor(market.sellPrice * 0.85) : Math.floor(market.sellPrice * (0.7 + Math.random() * 0.25));
                                allBids.push({company: i, price: otherPrice, quantity: otherQty, displayPrice: otherDisplayPrice});
                            }
                        }
                    }
                }
                
                // Sort by price (lowest wins)
                allBids.sort((a, b) => a.price - b.price);
                
                // Process winner's sale
                const winner = allBids[0];
                const winCompany = gameState.companies[winner.company];
                const actualQty = Math.min(winner.quantity, market.maxStock - market.currentStock);
                
                if (actualQty > 0) {
                    const salePrice = winner.displayPrice || winner.price;
                    winCompany.cash += salePrice * actualQty;
                    winCompany.products -= actualQty;
                    winCompany.totalSales += salePrice * actualQty;
                    winCompany.totalSoldQuantity = (winCompany.totalSoldQuantity || 0) + actualQty;
                    market.currentStock += actualQty;
                    
                    // Notify player if they participated
                    if (winner.company === 0) {
                        console.log(`ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒ${market.name}ã«Â¥${winner.price}Ã—${actualQty}å€‹ã§è½æœ­ã—ã¾ã—ãŸï¼`);
                    } else if (gameState.companies[0].products > 0) {
                        console.log(`${winCompany.name}ãŒ${market.name}ã«Â¥${winner.price}Ã—${actualQty}å€‹ã§è½æœ­ï¼ˆãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚‚å‚åŠ ï¼‰`);
                    } else {
                        console.log(`å…¥æœ­çµæœ: ${winCompany.name}ãŒ${market.name}ã«Â¥${winner.price}Ã—${actualQty}å€‹ã§è½æœ­`);
                    }
                }
            } else {
                // Direct sale (no bidding)
                company.cash += market.sellPrice * sellQty;
                company.products -= sellQty;
                company.totalSales += market.sellPrice * sellQty;
                company.totalSoldQuantity = (company.totalSoldQuantity || 0) + sellQty;
                market.currentStock += sellQty;
            }
            
            incrementRow(gameState.companies.indexOf(company));
            nextTurn();
            return;
        }
    }
    
    // Buy materials if low
    if (company.materials < 3 && company.cash > 50) {
        // Find cheapest market with stock
        const availableMarkets = gameState.markets.filter(m => m.currentStock > 0)
            .sort((a, b) => a.buyPrice - b.buyPrice);
        
        if (availableMarkets.length > 0) {
            const market = availableMarkets[0];
            const buyQty = Math.min(3, market.currentStock, Math.floor(company.cash / market.buyPrice));
            
            if (buyQty > 0) {
                company.cash -= market.buyPrice * buyQty;
                company.materials += buyQty;
                company.totalMaterialCost += market.buyPrice * buyQty;
                market.currentStock -= buyQty;
                
                incrementRow(gameState.companies.indexOf(company));
                nextTurn();
                return;
            }
        }
    }
    
    // Produce if has materials
    if (company.materials > 0 && company.cash > mfgCapacity) {
        const produceQty = Math.min(mfgCapacity, company.materials);
        const wipToProduct = Math.min(mfgCapacity, company.wip);
        const cost = produceQty + wipToProduct;
        
        if (company.cash >= cost) {
            company.cash -= cost;
            company.materials -= produceQty;
            company.wip += produceQty - wipToProduct;
            company.products += wipToProduct;
            company.totalProductionCost += cost;
            
            incrementRow(gameState.companies.indexOf(company));
            nextTurn();
            return;
        }
    }
    
    // æŠ•è³‡æˆ¦ç•¥ï¼ˆæ€§æ ¼ã«ã‚ˆã‚Šç•°ãªã‚‹ï¼‰
    executeDefaultInvestment(company);
}

// Cç¤¾ï¼šä¿å®ˆçš„æˆ¦ç•¥ï¼ˆå®‰å®šçš„MQç¢ºä¿ãƒ»é•·æœŸå¿—å‘ï¼‰
function executeConservativeStrategy(company, mfgCapacity, salesCapacity, analysis) {
    // å®‰å®šçš„ã«MQã‚’ç¢ºä¿ã™ã‚‹æˆ¦ç•¥ï¼ˆ5æœŸçµ‚äº†æ™‚è‡ªå·±è³‡æœ¬æœ€å¤§åŒ–ï¼‰
    const periodEndCost = calculatePeriodPayment(company);
    const safetyMargin = periodEndCost + 50;  // ä¿å®ˆçš„ãªã®ã§ä½™è£•ã‚’æŒã¤
    const chipCost = gameState.currentPeriod === 2 ? 20 : 40;

    // === 5æœŸï¼ˆæœ€çµ‚æœŸï¼‰ã¯å£²ã‚Šåˆ‡ã‚Šå„ªå…ˆ ===
    if (analysis.isFinalPeriod) {
        if (company.products > 0 && salesCapacity > 0) {
            executeDefaultSale(company, salesCapacity, 0.85);
            return;
        }
        if ((company.materials > 0 || company.wip > 0) && mfgCapacity > 0) {
            executeDefaultProduction(company, mfgCapacity);
            return;
        }
        nextTurn();
        return;
    }

    // === 4æœŸå¾ŒåŠã¯å›åãƒ•ã‚§ãƒ¼ã‚º ===
    if (analysis.isRecoveryPhase && company.products > 0 && salesCapacity > 0) {
        executeDefaultSale(company, salesCapacity, 0.83);
        return;
    }

    // 1. ç¢ºå®Ÿãªè²©å£²ï¼ˆåœ¨åº«ãƒªã‚¹ã‚¯å›é¿ã€7å‰²ä»¥ä¸Šã§ï¼‰
    const minSellQty = Math.ceil(salesCapacity * 0.7);
    if (company.products >= minSellQty && salesCapacity > 0) {
        executeDefaultSale(company, salesCapacity, 0.85);  // å®‰å…¨ãªä¾¡æ ¼
        return;
    }

    // 2. å®‰å®šç”Ÿç”£
    if ((company.materials > 0 || company.wip > 0) && mfgCapacity > 0 && company.products < 4) {
        executeDefaultProduction(company, mfgCapacity);
        return;
    }

    // 3. è¨ˆç”»çš„ææ–™è³¼å…¥ï¼ˆ7å‰²ä»¥ä¸Šã§ï¼‰
    if (company.cash > safetyMargin + 40 && company.materials < mfgCapacity) {
        executeDefaultMaterialPurchase(company, mfgCapacity);
        return;
    }

    // 4. é•·æœŸçš„æŠ•è³‡ï¼ˆä¿å®ˆçš„ã ãŒç€å®Ÿã«ï¼‰
    if (company.cash > safetyMargin + chipCost && analysis.rowsRemaining > 8 && !analysis.isRecoveryPhase) {
        // ä¿é™ºãƒãƒƒãƒ—ï¼ˆãƒªã‚¹ã‚¯è»½æ¸›ï¼‰
        if (!company.chips.insurance && company.cash >= chipCost + safetyMargin) {
            company.cash -= chipCost;
            company.chips.insurance = 1;
            incrementRow(gameState.companies.indexOf(company));
            showAIActionModal(company, 'ãƒãƒƒãƒ—è³¼å…¥', 'ğŸ›¡ï¸', 'ä¿é™ºãƒãƒƒãƒ—è³¼å…¥ï¼ˆãƒªã‚¹ã‚¯è»½æ¸›ï¼‰');
            return;
        }
        // ç ”ç©¶ãƒãƒƒãƒ—ï¼ˆé•·æœŸçš„ã«ä¾¡æ ¼ç«¶äº‰åŠ›å‘ä¸Šï¼‰
        if (analysis.shouldInvestForFuture && company.chips.research < 3 && company.cash >= chipCost + safetyMargin) {
            company.cash -= chipCost;
            company.chips.research++;
            incrementRow(gameState.companies.indexOf(company));
            showAIActionModal(company, 'ãƒãƒƒãƒ—è³¼å…¥', 'ğŸ”¬', 'ç ”ç©¶é–‹ç™ºãƒãƒƒãƒ—è³¼å…¥ï¼ˆé•·æœŸæŠ•è³‡ï¼‰');
            return;
        }
        // æ¬¡æœŸç”¨ãƒãƒƒãƒ—è³¼å…¥ï¼ˆä¿å®ˆçš„ã«1æšã¾ã§ï¼‰
        if (gameState.currentPeriod >= 3 && analysis.periodsRemaining >= 2) {
            if (company.nextPeriodChips.research < 1 && company.cash >= chipCost + safetyMargin + 80) {
                company.cash -= chipCost;
                company.nextPeriodChips.research++;
                incrementRow(gameState.companies.indexOf(company));
                showAIActionModal(company, 'ãƒãƒƒãƒ—è³¼å…¥(æ¬¡æœŸ)', 'ğŸ”¬', 'æ¬¡æœŸç”¨ç ”ç©¶ãƒãƒƒãƒ—è³¼å…¥');
                return;
            }
        }
    }

    // Do Nothingï¼ˆè¡Œæ•°ã‚’å¢—ã‚„ã•ãªã„ - ä¿å®ˆçš„åˆ¤æ–­ï¼‰
    nextTurn();
}

// Dç¤¾ï¼šä¾¡æ ¼ç«¶äº‰æˆ¦ç•¥ï¼ˆé‡ã§MQç¢ºä¿ãƒ»é•·æœŸå¿—å‘ï¼‰
function executePriceFocusedStrategy(company, mfgCapacity, salesCapacity, analysis) {
    // å¤§é‡ç”Ÿç”£ãƒ»å¤§é‡è²©å£²ã§MQã‚’ç¢ºä¿ï¼ˆ5æœŸçµ‚äº†æ™‚è‡ªå·±è³‡æœ¬æœ€å¤§åŒ–ï¼‰
    const periodEndCost = calculatePeriodPayment(company);
    const safetyMargin = periodEndCost + 30;
    const chipCost = gameState.currentPeriod === 2 ? 20 : 40;

    // === 5æœŸï¼ˆæœ€çµ‚æœŸï¼‰ã¯å£²ã‚Šåˆ‡ã‚Šå„ªå…ˆ ===
    if (analysis.isFinalPeriod) {
        if (company.products > 0 && salesCapacity > 0) {
            executeDefaultSale(company, salesCapacity, 0.65);
            return;
        }
        if ((company.materials > 0 || company.wip > 0) && mfgCapacity > 0) {
            executeDefaultProduction(company, mfgCapacity);
            return;
        }
        nextTurn();
        return;
    }

    // === 4æœŸå¾ŒåŠã¯å›åãƒ•ã‚§ãƒ¼ã‚º ===
    if (analysis.isRecoveryPhase && company.products > 0 && salesCapacity > 0) {
        executeDefaultSale(company, salesCapacity, 0.67);
        return;
    }

    // 1. å¤§é‡è²©å£²ï¼ˆä½ä¾¡æ ¼ã§ã‚‚é‡ã§å‹è² ã€7å‰²ä»¥ä¸Šï¼‰
    const minSellQty = Math.ceil(salesCapacity * 0.7);
    if (company.products >= minSellQty && salesCapacity > 0) {
        executeDefaultSale(company, salesCapacity, 0.65);  // ç©æ¥µçš„ãªä½ä¾¡æ ¼
        return;
    }

    // 2. å¤§é‡ç”Ÿç”£
    if ((company.materials > 0 || company.wip > 0) && mfgCapacity > 0) {
        executeDefaultProduction(company, mfgCapacity);
        return;
    }

    // 3. å¤§é‡ææ–™è³¼å…¥ï¼ˆ7å‰²ä»¥ä¸Šã§ï¼‰
    if (company.cash > safetyMargin + 40 && company.materials < mfgCapacity) {
        executeDefaultMaterialPurchase(company, mfgCapacity);
        return;
    }

    // 4. é•·æœŸæŠ•è³‡ï¼ˆé‡ã‚’å¢—ã‚„ã™ãŸã‚ã®æŠ•è³‡ï¼‰
    if (company.cash > safetyMargin + 50 && analysis.rowsRemaining > 5 && !analysis.isRecoveryPhase) {
        // ç ”ç©¶ãƒãƒƒãƒ—ï¼ˆä¾¡æ ¼ç«¶äº‰åŠ›ã§é‡ã‚’ç¢ºä¿ï¼‰
        if (analysis.shouldInvestForFuture && company.chips.research < 3 && company.cash >= chipCost + safetyMargin) {
            company.cash -= chipCost;
            company.chips.research++;
            incrementRow(gameState.companies.indexOf(company));
            showAIActionModal(company, 'ãƒãƒƒãƒ—è³¼å…¥', 'ğŸ”¬', 'ç ”ç©¶é–‹ç™ºãƒãƒƒãƒ—è³¼å…¥ï¼ˆé•·æœŸæŠ•è³‡ï¼‰');
            return;
        }

        // èƒ½åŠ›ãƒãƒ©ãƒ³ã‚¹èª¿æ•´
        if (analysis.needsCapacityBalance && analysis.capacityBalance > 0) {
            if (company.chips.advertising < 3 && company.cash >= chipCost + safetyMargin) {
                company.cash -= chipCost;
                company.chips.advertising++;
                incrementRow(gameState.companies.indexOf(company));
                showAIActionModal(company, 'ãƒãƒƒãƒ—è³¼å…¥', 'ğŸ“¢', 'åºƒå‘Šãƒãƒƒãƒ—è³¼å…¥');
                return;
            }
        }

        // æ¬¡æœŸç”¨ãƒãƒƒãƒ—è³¼å…¥
        if (gameState.currentPeriod >= 3 && analysis.periodsRemaining >= 2) {
            if (company.nextPeriodChips.research < 2 && company.cash >= chipCost + safetyMargin + 40) {
                company.cash -= chipCost;
                company.nextPeriodChips.research++;
                incrementRow(gameState.companies.indexOf(company));
                showAIActionModal(company, 'ãƒãƒƒãƒ—è³¼å…¥(æ¬¡æœŸ)', 'ğŸ”¬', 'æ¬¡æœŸç”¨ç ”ç©¶ãƒãƒƒãƒ—è³¼å…¥');
                return;
            }
        }
    }

    // ä½•ã‚‚ã—ãªã‹ã£ãŸå ´åˆã¯Do Nothing
    nextTurn();
}

// Eç¤¾ï¼šæŠ€è¡“é‡è¦–æˆ¦ç•¥ï¼ˆèƒ½åŠ›å‘ä¸Šã§MQæœ€å¤§åŒ–ãƒ»é•·æœŸå¿—å‘ï¼‰
function executeTechFocusedStrategy(company, mfgCapacity, salesCapacity, analysis) {
    // æŠ€è¡“æŠ•è³‡ã§åŠ¹ç‡ã‚’ä¸Šã’ã¦MQã‚’æœ€å¤§åŒ–ï¼ˆ5æœŸçµ‚äº†æ™‚è‡ªå·±è³‡æœ¬æœ€å¤§åŒ–ï¼‰
    const periodEndCost = calculatePeriodPayment(company);
    const safetyMargin = periodEndCost + 40;
    const chipCost = gameState.currentPeriod === 2 ? 20 : 40;

    // === 5æœŸï¼ˆæœ€çµ‚æœŸï¼‰ã¯å£²ã‚Šåˆ‡ã‚Šå„ªå…ˆ ===
    if (analysis.isFinalPeriod) {
        if (company.products > 0 && salesCapacity > 0) {
            executeDefaultSale(company, salesCapacity, 0.80);
            return;
        }
        if ((company.materials > 0 || company.wip > 0) && mfgCapacity > 0) {
            executeDefaultProduction(company, mfgCapacity);
            return;
        }
        nextTurn();
        return;
    }

    // === 4æœŸå¾ŒåŠã¯å›åãƒ•ã‚§ãƒ¼ã‚º ===
    if (analysis.isRecoveryPhase && company.products > 0 && salesCapacity > 0) {
        executeDefaultSale(company, salesCapacity, 0.78);
        return;
    }

    // 1. é«˜åŠ¹ç‡è²©å£²ï¼ˆ7å‰²ä»¥ä¸Šã§ï¼‰
    const minSellQty = Math.ceil(salesCapacity * 0.7);
    if (company.products >= minSellQty && salesCapacity > 0) {
        executeDefaultSale(company, salesCapacity, 0.80);  // ç ”ç©¶ãƒãƒƒãƒ—ã§å‹è² 
        return;
    }

    // 2. åŠ¹ç‡çš„ç”Ÿç”£
    if ((company.materials > 0 || company.wip > 0) && mfgCapacity > 0) {
        executeDefaultProduction(company, mfgCapacity);
        return;
    }

    // 3. é•·æœŸæŠ€è¡“æŠ•è³‡ï¼ˆæ®‹ã‚ŠæœŸæ•°ã‚’è€ƒæ…®ï¼‰
    if (company.cash > safetyMargin + chipCost && analysis.rowsRemaining > 5 && !analysis.isRecoveryPhase) {
        // ç ”ç©¶ãƒãƒƒãƒ—å„ªå…ˆï¼ˆé•·æœŸçš„ã«ä¾¡æ ¼ç«¶äº‰åŠ›å‘ä¸Šï¼‰
        if (analysis.shouldInvestForFuture && company.chips.research < 5 && company.cash >= chipCost + safetyMargin) {
            company.cash -= chipCost;
            company.chips.research++;
            incrementRow(gameState.companies.indexOf(company));
            showAIActionModal(company, 'ãƒãƒƒãƒ—è³¼å…¥', 'ğŸ”¬', 'ç ”ç©¶é–‹ç™ºãƒãƒƒãƒ—è³¼å…¥ï¼ˆé•·æœŸæŠ•è³‡ï¼‰');
            return;
        }

        // æ•™è‚²ãƒãƒƒãƒ—ï¼ˆè£½é€ ãƒ»è²©å£²èƒ½åŠ›+1ã€ä¸Šé™ç¢ºèªï¼‰
        const maxEducation = gameState.currentPeriod === 2 ? 2 : 1;
        if (company.chips.education < maxEducation && company.cash >= chipCost + safetyMargin) {
            company.cash -= chipCost;
            company.chips.education++;
            incrementRow(gameState.companies.indexOf(company));
            showAIActionModal(company, 'ãƒãƒƒãƒ—è³¼å…¥', 'ğŸ“š', 'æ•™è‚²ãƒãƒƒãƒ—è³¼å…¥ï¼ˆèƒ½åŠ›+1ï¼‰');
            return;
        }

        // ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ãƒãƒƒãƒ—ï¼ˆè£½é€ èƒ½åŠ›+1ï¼‰
        if (!company.chips.computer && company.cash >= chipCost + safetyMargin) {
            company.cash -= chipCost;
            company.chips.computer = 1;
            incrementRow(gameState.companies.indexOf(company));
            showAIActionModal(company, 'ãƒãƒƒãƒ—è³¼å…¥', 'ğŸ’»', 'ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ãƒãƒƒãƒ—è³¼å…¥ï¼ˆè£½é€ èƒ½åŠ›+1ï¼‰');
            return;
        }

        // æ¬¡æœŸç”¨ãƒãƒƒãƒ—è³¼å…¥ï¼ˆç©æ¥µçš„ã«ï¼‰
        if (gameState.currentPeriod >= 3 && analysis.periodsRemaining >= 2) {
            if (company.nextPeriodChips.research < 3 && company.cash >= chipCost + safetyMargin + 30) {
                company.cash -= chipCost;
                company.nextPeriodChips.research++;
                incrementRow(gameState.companies.indexOf(company));
                showAIActionModal(company, 'ãƒãƒƒãƒ—è³¼å…¥(æ¬¡æœŸ)', 'ğŸ”¬', 'æ¬¡æœŸç”¨ç ”ç©¶ãƒãƒƒãƒ—è³¼å…¥');
                return;
            }
        }
    }

    // 4. ææ–™è³¼å…¥ï¼ˆ7å‰²ä»¥ä¸Šã§ï¼‰
    if (company.cash > safetyMargin + 40 && company.materials < mfgCapacity) {
        executeDefaultMaterialPurchase(company, mfgCapacity);
        return;
    }

    // é€šå¸¸ã®æŠ•è³‡æˆ¦ç•¥ã¸
    executeDefaultInvestment(company);
}

// Bç¤¾ãƒ»ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼šãƒãƒ©ãƒ³ã‚¹æˆ¦ç•¥ï¼ˆé•·æœŸçš„è‡ªå·±è³‡æœ¬æœ€å¤§åŒ–å¿—å‘ï¼‰
function executeBalancedStrategy(company, mfgCapacity, salesCapacity, analysis) {
    // ãƒãƒ©ãƒ³ã‚¹è‰¯ãMQã‚’å¢—ã‚„ã—ã¤ã¤ã€5æœŸçµ‚äº†æ™‚ã®è‡ªå·±è³‡æœ¬æœ€å¤§åŒ–ã‚’ç›®æŒ‡ã™
    const periodEndCost = calculatePeriodPayment(company);
    const safetyMargin = periodEndCost + 35;
    const chipCost = gameState.currentPeriod === 2 ? 20 : 40;

    // === 5æœŸï¼ˆæœ€çµ‚æœŸï¼‰ã¯å£²ã‚Šåˆ‡ã‚Šå„ªå…ˆ ===
    if (analysis.isFinalPeriod) {
        if (company.products > 0 && salesCapacity > 0) {
            executeDefaultSale(company, salesCapacity, 0.80);
            return;
        }
        if ((company.materials > 0 || company.wip > 0) && mfgCapacity > 0) {
            executeDefaultProduction(company, mfgCapacity);
            return;
        }
        nextTurn();
        return;
    }

    // === 4æœŸå¾ŒåŠã¯å›åãƒ•ã‚§ãƒ¼ã‚º ===
    if (analysis.isRecoveryPhase) {
        if (company.products > 0 && salesCapacity > 0) {
            executeDefaultSale(company, salesCapacity, 0.78);
            return;
        }
    }

    // 1. è²©å£²æ©Ÿä¼šã‚’é€ƒã•ãªã„ï¼ˆ7å‰²ä»¥ä¸Šã§ï¼‰
    const minSellQty = Math.ceil(salesCapacity * 0.7);
    if (company.products >= minSellQty && salesCapacity > 0) {
        executeDefaultSale(company, salesCapacity, 0.75);
        return;
    }

    // 2. åŠ¹ç‡çš„ç”Ÿç”£
    if ((company.materials > 0 || company.wip > 0) && mfgCapacity > 0) {
        executeDefaultProduction(company, mfgCapacity);
        return;
    }

    // 3. ææ–™ç¢ºä¿ï¼ˆ7å‰²ä»¥ä¸Šã§ï¼‰
    if (company.cash > safetyMargin + 40 && company.materials < mfgCapacity) {
        executeDefaultMaterialPurchase(company, mfgCapacity);
        return;
    }

    // 4. é•·æœŸæˆ¦ç•¥çš„æŠ•è³‡ï¼ˆæ®‹ã‚ŠæœŸæ•°ã‚’è€ƒæ…®ï¼‰
    if (company.cash > safetyMargin + chipCost && analysis.rowsRemaining > 6 && !analysis.isRecoveryPhase) {
        // ç ”ç©¶ãƒãƒƒãƒ—å„ªå…ˆï¼ˆä¾¡æ ¼ç«¶äº‰åŠ›ã¯é•·æœŸçš„ã«MQå¢—åŠ ã«ç›´çµï¼‰
        if (analysis.shouldInvestForFuture && company.chips.research < 4 && company.cash >= chipCost + safetyMargin) {
            company.cash -= chipCost;
            company.chips.research++;
            incrementRow(gameState.companies.indexOf(company));
            showAIActionModal(company, 'ãƒãƒƒãƒ—è³¼å…¥', 'ğŸ”¬', 'ç ”ç©¶é–‹ç™ºãƒãƒƒãƒ—è³¼å…¥ï¼ˆé•·æœŸæŠ•è³‡ï¼‰');
            return;
        }

        // èƒ½åŠ›ãƒãƒ©ãƒ³ã‚¹èª¿æ•´ï¼ˆè£½é€ =è²©å£²ãŒç†æƒ³ï¼‰
        if (analysis.needsCapacityBalance) {
            if (analysis.capacityBalance > 0 && company.chips.advertising < 2 && company.cash >= chipCost + safetyMargin) {
                // è£½é€  > è²©å£² â†’ åºƒå‘Šãƒãƒƒãƒ—ã§è²©å£²åŠ›å¼·åŒ–
                company.cash -= chipCost;
                company.chips.advertising++;
                incrementRow(gameState.companies.indexOf(company));
                showAIActionModal(company, 'ãƒãƒƒãƒ—è³¼å…¥', 'ğŸ“¢', 'åºƒå‘Šãƒãƒƒãƒ—è³¼å…¥ï¼ˆèƒ½åŠ›ãƒãƒ©ãƒ³ã‚¹ï¼‰');
                return;
            }
        }

        // æ¬¡æœŸç”¨ãƒãƒƒãƒ—è³¼å…¥ï¼ˆ3æœŸä»¥é™ã€ä½™è£•ãŒã‚ã‚Œã°ï¼‰
        if (gameState.currentPeriod >= 3 && analysis.periodsRemaining >= 2) {
            if (company.nextPeriodChips.research < 2 && company.cash >= chipCost + safetyMargin + 50) {
                company.cash -= chipCost;
                company.nextPeriodChips.research++;
                incrementRow(gameState.companies.indexOf(company));
                showAIActionModal(company, 'ãƒãƒƒãƒ—è³¼å…¥(æ¬¡æœŸ)', 'ğŸ”¬', 'æ¬¡æœŸç”¨ç ”ç©¶ãƒãƒƒãƒ—è³¼å…¥');
                return;
            }
        }
    }

    // ä½•ã‚‚ã—ãªã‹ã£ãŸå ´åˆã¯Do Nothing
    nextTurn();
}

// Fç¤¾ï¼šäºˆæ¸¬ä¸èƒ½æˆ¦ç•¥ï¼ˆãƒ©ãƒ³ãƒ€ãƒ ã ãŒé•·æœŸå¿—å‘ï¼‰
function executeUnpredictableStrategy(company, mfgCapacity, salesCapacity, analysis) {
    // ãƒ©ãƒ³ãƒ€ãƒ ã ãŒ5æœŸçµ‚äº†æ™‚ã®è‡ªå·±è³‡æœ¬æœ€å¤§åŒ–ã‚’æ„è­˜
    const periodEndCost = calculatePeriodPayment(company);
    const safetyMargin = periodEndCost + 20;
    const chipCost = gameState.currentPeriod === 2 ? 20 : 40;

    // === 5æœŸï¼ˆæœ€çµ‚æœŸï¼‰ã¯å£²ã‚Šåˆ‡ã‚Šå„ªå…ˆ ===
    if (analysis.isFinalPeriod) {
        if (company.products > 0 && salesCapacity > 0) {
            const priceBase = 0.70 + Math.random() * 0.15;
            executeDefaultSale(company, salesCapacity, priceBase);
            return;
        }
        if ((company.materials > 0 || company.wip > 0) && mfgCapacity > 0) {
            executeDefaultProduction(company, mfgCapacity);
            return;
        }
        nextTurn();
        return;
    }

    // === 4æœŸå¾ŒåŠã¯å›åãƒ•ã‚§ãƒ¼ã‚º ===
    if (analysis.isRecoveryPhase && company.products > 0 && salesCapacity > 0) {
        const priceBase = 0.68 + Math.random() * 0.12;
        executeDefaultSale(company, salesCapacity, priceBase);
        return;
    }

    const actions = [];

    // å¯èƒ½ãªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’ãƒªã‚¹ãƒˆã‚¢ãƒƒãƒ—ï¼ˆåˆç†çš„ãªæ¡ä»¶ã§ï¼‰
    const minSellQty = Math.ceil(salesCapacity * 0.7);
    if (company.products >= minSellQty && salesCapacity > 0) {
        actions.push('sell');  // è²©å£²
    }
    if ((company.materials > 0 || company.wip > 0) && mfgCapacity > 0) {
        actions.push('produce');  // ç”Ÿç”£
    }
    if (company.cash > safetyMargin + 40 && company.materials < mfgCapacity) {
        actions.push('buy_materials');  // ææ–™è³¼å…¥
    }
    if (company.cash > safetyMargin + chipCost && analysis.rowsRemaining > 5 && !analysis.isRecoveryPhase) {
        actions.push('buy_chip');  // ãƒãƒƒãƒ—è³¼å…¥ï¼ˆé•·æœŸæŠ•è³‡ï¼‰
    }
    // å¸¸ã«Do Nothingã¯é¸æŠå¯èƒ½
    actions.push('do_nothing');

    // ãƒ©ãƒ³ãƒ€ãƒ ã«è¡Œå‹•ã‚’é¸æŠ
    const action = actions[Math.floor(Math.random() * actions.length)];

    switch(action) {
        case 'sell':
            // ãƒ©ãƒ³ãƒ€ãƒ ãªä¾¡æ ¼ã§è²©å£²ï¼ˆ0.65ã€œ0.85ã®ç¯„å›²ï¼‰
            const priceBase = 0.65 + Math.random() * 0.2;
            executeDefaultSale(company, salesCapacity, priceBase);
            return;

        case 'produce':
            // ç”Ÿç”£å®Ÿè¡Œ
            executeDefaultProduction(company, mfgCapacity);
            return;

        case 'buy_materials':
            // ææ–™è³¼å…¥
            executeDefaultMaterialPurchase(company, mfgCapacity);
            return;

        case 'buy_chip':
            // ãƒ©ãƒ³ãƒ€ãƒ ãªãƒãƒƒãƒ—ã‚’è³¼å…¥ï¼ˆç ”ç©¶ãƒãƒƒãƒ—å„ªå…ˆï¼‰
            const chipTypes = ['research', 'research', 'advertising'];  // ç ”ç©¶ãƒãƒƒãƒ—ç¢ºç‡é«˜ã‚
            const chipType = chipTypes[Math.floor(Math.random() * chipTypes.length)];
            if (chipType === 'research' && company.chips.research < 4) {
                company.cash -= chipCost;
                company.chips.research++;
                incrementRow(gameState.companies.indexOf(company));
                showAIActionModal(company, 'ãƒãƒƒãƒ—è³¼å…¥', 'ğŸ”¬', 'ç ”ç©¶é–‹ç™ºãƒãƒƒãƒ—è³¼å…¥');
            } else if (company.chips.advertising < 3) {
                company.cash -= chipCost;
                company.chips.advertising++;
                incrementRow(gameState.companies.indexOf(company));
                showAIActionModal(company, 'ãƒãƒƒãƒ—è³¼å…¥', 'ğŸ“¢', 'åºƒå‘Šãƒãƒƒãƒ—è³¼å…¥');
            } else {
                nextTurn();
            }
            return;

        case 'do_nothing':
        default:
            // æ„å›³çš„ã«ä½•ã‚‚ã—ãªã„
            incrementRow(gameState.companies.indexOf(company));
            showAIActionModal(company, 'DO NOTHING', 'â­ï¸', 'æ§˜å­è¦‹');
            return;
    }
}

// å…±é€šé–¢æ•°ï¼šè²©å£²å®Ÿè¡Œ
function executeDefaultSale(company, salesCapacity, priceBase) {
    // è²©å£²èƒ½åŠ›ã®7å‰²ä»¥ä¸Šã‚’å£²ã‚‹ï¼ˆä¾‹ï¼šèƒ½åŠ›10ãªã‚‰7ã€œ10å€‹ï¼‰
    const minSellQty = Math.ceil(salesCapacity * 0.7);  // æœ€ä½7å‰²
    const targetSellQty = salesCapacity;  // ãªã‚‹ã¹ãé™ç•Œã¾ã§
    const sellQty = Math.min(targetSellQty, company.products);

    // 7å‰²ã«æº€ãŸãªã„å ´åˆã¯è²©å£²ã—ãªã„ï¼ˆè¡Œã®ç„¡é§„é£ã„é˜²æ­¢ï¼‰
    if (sellQty < minSellQty || sellQty < 2) {
        if (company.materials > 0 || company.wip > 0) {
            // ä»£ã‚ã‚Šã«ç”Ÿç”£ã‚’è©¦ã¿ã‚‹
            const mfgCapacity = getManufacturingCapacity(company);
            executeDefaultProduction(company, mfgCapacity);
            return;
        }
        incrementRow(gameState.companies.indexOf(company));
        showAIActionModal(company, 'DO NOTHING', 'â­ï¸', 'è²©å£²èƒ½åŠ›ã®7å‰²ã«æº€ãŸãªã„ãŸã‚è¦‹é€ã‚Š');
        return;
    }

    // é«˜ä¾¡æ ¼å¸‚å ´ã‚’å„ªå…ˆï¼ˆå…¥æœ­å¸‚å ´ã‚‚å«ã‚€ï¼‰
    const availableMarkets = gameState.markets
        .filter(m => m.currentStock < m.maxStock && !m.closed && (gameState.currentPeriod > 2 || m.name !== 'æµ·å¤–'))
        .sort((a, b) => b.sellPrice - a.sellPrice);

    if (availableMarkets.length > 0) {
        const market = availableMarkets[0];
        const actualQty = Math.min(sellQty, market.maxStock - market.currentStock);

        if (actualQty > 0) {
            if (!market.needsBid) {
                // å³å£²å¸‚å ´
                const revenue = market.sellPrice * actualQty;
                company.cash += revenue;
                company.products -= actualQty;
                company.totalSales += revenue;
                company.totalSoldQuantity = (company.totalSoldQuantity || 0) + actualQty;
                market.currentStock += actualQty;

                incrementRow(gameState.companies.indexOf(company));
                showAIActionModal(company, 'å•†å“è²©å£²', 'ğŸ’°', `${market.name}ã«${actualQty}å€‹è²©å£²`, [
                    { label: 'è²©å£²ä¾¡æ ¼', value: `Â¥${market.sellPrice}/å€‹` },
                    { label: 'å£²ä¸Š', value: `Â¥${revenue}`, highlight: true }
                ]);
                return;
            } else {
                // å…¥æœ­å¸‚å ´ï¼šAIãŒè¦ªã¨ã—ã¦å…¥æœ­ã‚’é–‹å§‹ã€ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¨ä»–AIã‚‚å‚åŠ 
                startAIBidding(company, market, actualQty, priceBase);
                return;
            }
        }
    }

    incrementRow(gameState.companies.indexOf(company));
    showAIActionModal(company, 'DO NOTHING', 'â­ï¸', 'è²©å£²ã§ãã‚‹å¸‚å ´ãŒã‚ã‚Šã¾ã›ã‚“');
}

// AIãŒè¦ªã¨ã—ã¦å…¥æœ­ã‚’é–‹å§‹
function startAIBidding(parentCompany, market, parentQty, priceBase) {
    const marketIndex = gameState.markets.indexOf(market);
    const parentIndex = gameState.companies.indexOf(parentCompany);

    // è¦ªAIã®å…¥æœ­ä¾¡æ ¼ã‚’æ±ºå®š
    const parentPrice = Math.floor(market.sellPrice * priceBase);
    const parentCompetitiveness = getPriceCompetitiveness(parentCompany, true);
    const parentEffectivePrice = parentPrice - parentCompetitiveness;

    // è¦ªã®å…¥æœ­æƒ…å ±ã‚’ä¿å­˜
    gameState.aiBidding = {
        market: market,
        marketIndex: marketIndex,
        parentCompany: parentIndex,
        parentQty: parentQty,
        parentPrice: parentPrice,
        parentEffectivePrice: parentEffectivePrice
    };

    // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã«å…¥æœ­å‚åŠ ã‚’ç¢ºèª
    const player = gameState.companies[0];
    const playerSalesCapacity = getSalesCapacity(player);
    const playerMaxQty = Math.min(playerSalesCapacity, player.products);

    if (playerMaxQty > 0) {
        // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚‚å…¥æœ­å¯èƒ½
        showPlayerBidInAIAuction(parentCompany, market, parentQty, parentPrice, playerMaxQty);
    } else {
        // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¯å‚åŠ ä¸å¯ã€AIåŒå£«ã§å…¥æœ­
        processAIOnlyBidding();
    }
}

// ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã«AIé–‹å§‹ã®å…¥æœ­ã¸ã®å‚åŠ ã‚’ç¢ºèª
function showPlayerBidInAIAuction(parentCompany, market, parentQty, parentPrice, playerMaxQty) {
    const player = gameState.companies[0];
    const competitiveness = getPriceCompetitiveness(player, false);

    const defaultBidPrice = Math.floor(market.sellPrice * 0.85);  // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå…¥æœ­ä¾¡æ ¼

    const content = `
        <div style="text-align: center; padding: 15px;">
            <div style="background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%); color: white; padding: 15px; border-radius: 12px; margin-bottom: 15px;">
                <div style="font-size: 16px; font-weight: bold;">âš”ï¸ ${parentCompany.name}ãŒå…¥æœ­ã‚’é–‹å§‹ï¼</div>
                <div style="font-size: 14px; margin-top: 8px;">å¸‚å ´: ${market.name}ï¼ˆä¸Šé™ä¾¡æ ¼: Â¥${market.sellPrice}ï¼‰</div>
                <div style="font-size: 14px;">è²©å£²å¸Œæœ›: ${parentQty}å€‹ï¼ˆå…¥æœ­ä¾¡æ ¼ã¯éå…¬é–‹ï¼‰</div>
            </div>

            <div style="background: #fef3c7; border-radius: 8px; padding: 10px; margin-bottom: 15px;">
                <div style="font-weight: bold; color: #92400e;">ğŸ’° ã‚ãªãŸã®ç¾é‡‘: Â¥${player.cash} / è£½å“: ${player.products}å€‹</div>
            </div>

            <p style="margin-bottom: 15px;">å…¥æœ­ã«å‚åŠ ã—ã¾ã™ã‹ï¼Ÿ</p>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 15px;">
                <div>
                    <label style="font-size: 12px;">ğŸ“¦ è²©å£²æ•°é‡</label>
                    <select id="playerBidQty" class="form-control" style="font-size: 16px; text-align: center;">
                        ${Array(playerMaxQty).fill(0).map((_, i) =>
                            `<option value="${i+1}">${i+1}å€‹</option>`
                        ).join('')}
                    </select>
                </div>
                <div>
                    <label style="font-size: 12px;">ğŸ’µ å…¥æœ­ä¾¡æ ¼ (ç«¶äº‰åŠ›: -Â¥${competitiveness})</label>
                    <input type="number" id="playerBidPrice" class="form-control" min="1" max="${market.sellPrice}" value="${defaultBidPrice}" style="font-size: 16px; text-align: center;">
                </div>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <button class="action-btn primary" onclick="submitPlayerBidInAIAuction()">å…¥æœ­ã«å‚åŠ </button>
                <button class="action-btn secondary" onclick="skipPlayerBidInAIAuction()">å‚åŠ ã—ãªã„</button>
            </div>
        </div>
    `;

    showModal('å…¥æœ­å‚åŠ ç¢ºèª', content);
}

// ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒAIå…¥æœ­ã«å‚åŠ 
function submitPlayerBidInAIAuction() {
    const player = gameState.companies[0];
    const bidQty = parseInt(document.getElementById('playerBidQty').value);
    const bidPrice = parseInt(document.getElementById('playerBidPrice').value);
    const competitiveness = getPriceCompetitiveness(player, false);

    gameState.aiBidding.playerBid = {
        company: 0,
        quantity: bidQty,
        price: bidPrice - competitiveness,
        displayPrice: bidPrice
    };

    closeModal();
    processAIBiddingWithPlayer();
}

// ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒAIå…¥æœ­ã‚’ã‚¹ã‚­ãƒƒãƒ—
function skipPlayerBidInAIAuction() {
    gameState.aiBidding.playerBid = null;
    closeModal();
    processAIBiddingWithPlayer();
}

// AIå…¥æœ­ã‚’å‡¦ç†ï¼ˆãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼å‚åŠ /ä¸å‚åŠ ã©ã¡ã‚‰ã‚‚ï¼‰
function processAIBiddingWithPlayer() {
    const bidInfo = gameState.aiBidding;
    const market = bidInfo.market;
    const allBids = [];

    // è¦ªAIã®å…¥æœ­
    allBids.push({
        company: bidInfo.parentCompany,
        quantity: bidInfo.parentQty,
        price: bidInfo.parentEffectivePrice,
        displayPrice: bidInfo.parentPrice
    });

    // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®å…¥æœ­ï¼ˆå‚åŠ ã—ãŸå ´åˆï¼‰
    if (bidInfo.playerBid) {
        allBids.push(bidInfo.playerBid);
    }

    // ä»–ã®AIã‚‚ç©æ¥µçš„ã«å…¥æœ­ï¼ˆè£½å“ãŒã‚ã‚Œã°å¿…ãšå‚åŠ ï¼‰
    for (let i = 1; i < gameState.companies.length; i++) {
        if (i === bidInfo.parentCompany) continue; // è¦ªAIã¯ã‚¹ã‚­ãƒƒãƒ—

        const aiCompany = gameState.companies[i];
        if (aiCompany.products >= 2) {  // 2å€‹ä»¥ä¸Šã‚ã‚Œã°å…¥æœ­
            const aiSalesCapacity = getSalesCapacity(aiCompany);
            const aiQuantity = Math.min(aiSalesCapacity, aiCompany.products);
            if (aiQuantity >= 2) {
                // AIã®æ€§æ ¼ã«å¿œã˜ã¦å…¥æœ­ä¾¡æ ¼ã‚’æ±ºå®š
                let priceMultiplier = 0.8;  // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ80%
                if (aiCompany.strategy === 'aggressive') priceMultiplier = 0.7;
                else if (aiCompany.strategy === 'price_focused') priceMultiplier = 0.75;
                else if (aiCompany.strategy === 'conservative') priceMultiplier = 0.85;

                const aiDisplayPrice = Math.floor(market.sellPrice * (priceMultiplier + Math.random() * 0.1));
                const aiCompetitiveness = getPriceCompetitiveness(aiCompany, false);
                const aiPrice = aiDisplayPrice - aiCompetitiveness;
                allBids.push({
                    company: i,
                    quantity: aiQuantity,
                    price: aiPrice,
                    displayPrice: aiDisplayPrice
                });
            }
        }
    }

    // å…¥æœ­çµæœã‚’å‡¦ç†ï¼ˆè²©å£²ä¸Šé™ã¯è¦ªã®æ•°é‡ï¼‰
    processAIBidsResult(bidInfo.parentQty, market, allBids);
}

// AIå…¥æœ­ã®ã¿ï¼ˆãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼å‚åŠ ä¸å¯ã®å ´åˆï¼‰
function processAIOnlyBidding() {
    const bidInfo = gameState.aiBidding;
    const market = bidInfo.market;
    const allBids = [];

    // è¦ªAIã®å…¥æœ­
    allBids.push({
        company: bidInfo.parentCompany,
        quantity: bidInfo.parentQty,
        price: bidInfo.parentEffectivePrice,
        displayPrice: bidInfo.parentPrice
    });

    // ä»–ã®AIã‚‚ç©æ¥µçš„ã«å…¥æœ­ï¼ˆè£½å“ãŒã‚ã‚Œã°å¿…ãšå‚åŠ ï¼‰
    for (let i = 1; i < gameState.companies.length; i++) {
        if (i === bidInfo.parentCompany) continue;

        const aiCompany = gameState.companies[i];
        if (aiCompany.products >= 2) {
            const aiSalesCapacity = getSalesCapacity(aiCompany);
            const aiQuantity = Math.min(aiSalesCapacity, aiCompany.products);
            if (aiQuantity >= 2) {
                // AIã®æ€§æ ¼ã«å¿œã˜ã¦å…¥æœ­ä¾¡æ ¼ã‚’æ±ºå®š
                let priceMultiplier = 0.8;
                if (aiCompany.strategy === 'aggressive') priceMultiplier = 0.7;
                else if (aiCompany.strategy === 'price_focused') priceMultiplier = 0.75;
                else if (aiCompany.strategy === 'conservative') priceMultiplier = 0.85;

                const aiDisplayPrice = Math.floor(market.sellPrice * (priceMultiplier + Math.random() * 0.1));
                const aiCompetitiveness = getPriceCompetitiveness(aiCompany, false);
                const aiPrice = aiDisplayPrice - aiCompetitiveness;
                allBids.push({
                    company: i,
                    quantity: aiQuantity,
                    price: aiPrice,
                    displayPrice: aiDisplayPrice
                });
            }
        }
    }

    processAIBidsResult(bidInfo.parentQty, market, allBids);
}

// AIå…¥æœ­çµæœã‚’å‡¦ç†
function processAIBidsResult(maxSales, market, allBids) {
    // ä¾¡æ ¼ã§ã‚½ãƒ¼ãƒˆï¼ˆä½ã„é †=æœ‰åˆ©ï¼‰
    allBids.sort((a, b) => {
        if (a.price !== b.price) return a.price - b.price;
        const aResearch = gameState.companies[a.company].chips.research || 0;
        const bResearch = gameState.companies[b.company].chips.research || 0;
        if (aResearch !== bResearch) return bResearch - aResearch;
        const aIsParent = (a.company === gameState.aiBidding.parentCompany);
        const bIsParent = (b.company === gameState.aiBidding.parentCompany);
        if (aIsParent && !bIsParent) return -1;
        if (!aIsParent && bIsParent) return 1;
        return 0;
    });

    // è²©å£²ä¸Šé™ã¯è¦ªã®æ•°é‡
    let remainingCapacity = maxSales;
    let salesResults = [];

    for (const bid of allBids) {
        if (remainingCapacity <= 0) break;

        const bidCompany = gameState.companies[bid.company];
        const actualQty = Math.min(bid.quantity, remainingCapacity, bidCompany.products);

        if (actualQty > 0) {
            const salePrice = bid.displayPrice || bid.price;
            bidCompany.cash += salePrice * actualQty;
            bidCompany.products -= actualQty;
            bidCompany.totalSales += salePrice * actualQty;
            bidCompany.totalSoldQuantity = (bidCompany.totalSoldQuantity || 0) + actualQty;
            market.currentStock += actualQty;
            remainingCapacity -= actualQty;

            salesResults.push({
                company: bidCompany,
                companyIndex: bid.company,
                quantity: actualQty,
                price: salePrice
            });
        }
    }

    // è¦ªAIã®è¡Œæ•°ã‚’æ¶ˆè²»
    incrementRow(gameState.aiBidding.parentCompany);

    // çµæœè¡¨ç¤º
    showAIBiddingResultModal(market, salesResults);
}

// AIå…¥æœ­çµæœãƒ¢ãƒ¼ãƒ€ãƒ«
function showAIBiddingResultModal(market, salesResults) {
    let resultHtml = salesResults.map(r => `
        <div style="display: flex; justify-content: space-between; padding: 8px; background: ${r.companyIndex === 0 ? '#dcfce7' : '#f1f5f9'}; border-radius: 6px; margin-bottom: 5px;">
            <span style="font-weight: bold;">${r.company.name}</span>
            <span>${r.quantity}å€‹ Ã— Â¥${r.price} = Â¥${r.quantity * r.price}</span>
        </div>
    `).join('');

    if (salesResults.length === 0) {
        resultHtml = '<p style="text-align: center; color: #666;">å£²ã‚ŒãŸä¼šç¤¾ã¯ã‚ã‚Šã¾ã›ã‚“</p>';
    }

    const content = `
        <div style="padding: 15px;">
            <div style="background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%); color: white; padding: 15px; border-radius: 12px; margin-bottom: 15px; text-align: center;">
                <div style="font-size: 16px; font-weight: bold;">âš”ï¸ å…¥æœ­çµæœ</div>
                <div style="font-size: 14px; margin-top: 5px;">å¸‚å ´: ${market.name}</div>
            </div>

            <div style="margin-bottom: 15px;">
                ${resultHtml}
            </div>

            <button class="action-btn primary" onclick="closeAIBiddingResult()" style="width: 100%;">ç¢ºèª</button>
        </div>
    `;

    showModal('å…¥æœ­çµæœ', content);
}

// AIå…¥æœ­çµæœã‚’é–‰ã˜ã‚‹
function closeAIBiddingResult() {
    gameState.aiBidding = null;
    closeModal();
    nextTurn();
}

// å…±é€šé–¢æ•°ï¼šææ–™è³¼å…¥
function executeDefaultMaterialPurchase(company, targetQty) {
    // 3æœŸä»¥é™ã¯è£½é€ èƒ½åŠ›ã®7å‰²ä»¥ä¸Šã‚’è³¼å…¥ï¼ˆä¾‹ï¼šèƒ½åŠ›10ãªã‚‰7ã€œ10å€‹ï¼‰
    const mfgCapacity = getManufacturingCapacity(company);
    const minBuyQty = gameState.currentPeriod >= 3 ? Math.ceil(mfgCapacity * 0.7) : 2;
    const actualTargetQty = gameState.currentPeriod >= 3 ? mfgCapacity : targetQty;

    const availableMarkets = gameState.markets.filter(m => m.currentStock > 0 && !m.closed)
        .sort((a, b) => a.buyPrice - b.buyPrice);

    if (availableMarkets.length > 0) {
        const market = availableMarkets[0];
        const buyQty = Math.min(actualTargetQty, market.currentStock, Math.floor(company.cash / market.buyPrice));

        // 7å‰²ã«æº€ãŸãªã„å ´åˆã¯è³¼å…¥ã—ãªã„ï¼ˆè¡Œã®ç„¡é§„é£ã„é˜²æ­¢ï¼‰
        if (buyQty >= minBuyQty && buyQty >= 2) {
            const cost = market.buyPrice * buyQty;
            company.cash -= cost;
            company.materials += buyQty;
            company.totalMaterialCost += cost;
            market.currentStock -= buyQty;

            incrementRow(gameState.companies.indexOf(company));
            showAIActionModal(company, 'ææ–™ä»•å…¥', 'ğŸ“¦', `${market.name}ã‹ã‚‰${buyQty}å€‹è³¼å…¥`, [
                { label: 'ä»•å…¥ä¾¡æ ¼', value: `Â¥${market.buyPrice}/å€‹` },
                { label: 'æ”¯æ‰•', value: `Â¥${cost}` }
            ]);
            return;
        }
    }

    // 7å‰²ä»¥ä¸Šè²·ãˆãªã„å ´åˆã¯ç”Ÿç”£ã‚’è©¦ã¿ã‚‹
    if (company.materials > 0 || company.wip > 0) {
        executeDefaultProduction(company, mfgCapacity);
        return;
    }

    incrementRow(gameState.companies.indexOf(company));
    showAIActionModal(company, 'DO NOTHING', 'â­ï¸', 'è£½é€ èƒ½åŠ›ã®7å‰²ã«æº€ãŸãªã„ãŸã‚è¦‹é€ã‚Š');
}

// å…±é€šé–¢æ•°ï¼šç”Ÿç”£å®Ÿè¡Œ
function executeDefaultProduction(company, maxQty) {
    const produceQty = Math.min(maxQty, company.materials);
    const wipToProduct = Math.min(maxQty, company.wip);
    const cost = produceQty + wipToProduct;

    if (company.cash >= cost && (produceQty > 0 || wipToProduct > 0)) {
        company.cash -= cost;
        company.materials -= produceQty;
        company.wip += produceQty - wipToProduct;
        company.products += wipToProduct;
        company.totalProductionCost += cost;

        let detail = '';
        if (produceQty > 0) detail += `ææ–™â†’ä»•æ›å“: ${produceQty}å€‹`;
        if (wipToProduct > 0) detail += `${produceQty > 0 ? 'ã€' : ''}ä»•æ›å“â†’è£½å“: ${wipToProduct}å€‹`;

        incrementRow(gameState.companies.indexOf(company));
        showAIActionModal(company, 'å®Œæˆãƒ»æŠ•å…¥', 'ğŸ­', detail, [
            { label: 'åŠ å·¥è²»', value: `Â¥${cost}` }
        ]);
        return;
    }

    incrementRow(gameState.companies.indexOf(company));
    showAIActionModal(company, 'DO NOTHING', 'â­ï¸', 'ç”Ÿç”£ã§ãã¾ã›ã‚“');
}

// å…±é€šé–¢æ•°ï¼šæŠ•è³‡å®Ÿè¡Œï¼ˆGæœ€å¤§åŒ–ãƒ»è‡ªå·±è³‡æœ¬æœ€å¤§åŒ–å¿—å‘ï¼‰
function executeDefaultInvestment(company) {
    const companyIndex = gameState.companies.indexOf(company);
    const mfgCapacity = getManufacturingCapacity(company);
    const salesCapacity = getSalesCapacity(company);
    const chipCost = gameState.currentPeriod === 2 ? 20 : 40;
    const rowsRemaining = gameState.maxRows - (company.currentRow || 1);
    const periodsRemaining = 5 - gameState.currentPeriod;

    // æœŸæœ«è¿‘ãã¯æŠ•è³‡ã—ãªã„ï¼ˆè³‡é‡‘ã‚’ç¢ºä¿ï¼‰
    if (rowsRemaining < 5) {
        nextTurn();
        return;
    }

    // å¿…è¦ãªä½™è£•è³‡é‡‘ï¼ˆæœŸæœ«æ”¯æ‰•ã„+Î±ã‚’ç¢ºä¿ï¼‰
    const periodEndCost = calculatePeriodPayment(company);
    let safetyMargin = periodEndCost + 30;

    // === æˆ¦ç•¥åˆ¥ã®æŠ•è³‡æ„æ¬² ===
    // aggressive/tech_focused ã¯å®‰å…¨ãƒãƒ¼ã‚¸ãƒ³ã‚’å°ã•ãï¼ˆç©æ¥µæŠ•è³‡ï¼‰
    if (company.strategy === 'aggressive') safetyMargin = periodEndCost + 15;
    if (company.strategy === 'tech_focused') safetyMargin = periodEndCost + 20;
    if (company.strategy === 'conservative') safetyMargin = periodEndCost + 50;

    if (company.cash <= safetyMargin) {
        nextTurn();
        return;
    }

    // === æˆ¦ç•¥çš„æŠ•è³‡åˆ¤æ–­ï¼ˆFã‚’ã‹ã‘ã¦æˆé•·ã‚’ç›®æŒ‡ã™ï¼‰ ===

    // === 1. æˆ¦ç•¥åˆ¥ã®ç©æ¥µæŠ•è³‡ãƒ•ã‚§ãƒ¼ã‚ºï¼ˆ2-3æœŸã«é›†ä¸­æŠ•è³‡ï¼‰ ===
    if (gameState.currentPeriod <= 3 && rowsRemaining > 10) {

        // AGGRESSIVEæˆ¦ç•¥ï¼šå¤§èƒ†ãªè¨­å‚™æŠ•è³‡ãƒ»äººå“¡æ‹¡å¤§
        if (company.strategy === 'aggressive') {
            // å¤§å‹æ©Ÿæ¢°æŠ•è³‡ï¼ˆä¸€æ°—ã«è£½é€ èƒ½åŠ›+4ï¼‰
            if (company.machines.length < 2 && company.workers >= 2 && company.cash >= 100 + safetyMargin) {
                company.cash -= 100;
                company.machines.push({type: 'large', attachments: 0});
                incrementRow(companyIndex);
                showAIActionModal(company, 'è¨­å‚™æŠ•è³‡', 'ğŸ­', 'å¤§å‹æ©Ÿæ¢°è³¼å…¥ï¼ˆè£½é€ èƒ½åŠ›+4ã€ç©æ¥µæŠ•è³‡ï¼‰');
                return;
            }
            // ãƒ¯ãƒ¼ã‚«ãƒ¼ãƒ»ã‚»ãƒ¼ãƒ«ã‚¹ãƒãƒ³åŒæ™‚æ‹¡å¤§å¿—å‘
            if (company.workers < 3 && company.cash >= 5 + safetyMargin) {
                company.cash -= 5;
                company.workers++;
                company.extraLaborCost = (company.extraLaborCost || 0) + 5;
                incrementRow(companyIndex);
                showAIActionModal(company, 'æ¡ç”¨', 'ğŸ‘·', 'ãƒ¯ãƒ¼ã‚«ãƒ¼æ¡ç”¨ï¼ˆæ‹¡å¤§æˆ¦ç•¥ï¼‰');
                return;
            }
            if (company.salesmen < 4 && company.cash >= 5 + safetyMargin) {
                company.cash -= 5;
                company.salesmen++;
                company.extraLaborCost = (company.extraLaborCost || 0) + 5;
                incrementRow(companyIndex);
                showAIActionModal(company, 'æ¡ç”¨', 'ğŸ’¼', 'ã‚»ãƒ¼ãƒ«ã‚¹ãƒãƒ³æ¡ç”¨ï¼ˆæ‹¡å¤§æˆ¦ç•¥ï¼‰');
                return;
            }
        }

        // TECH_FOCUSEDæˆ¦ç•¥ï¼šãƒãƒƒãƒ—ãƒ»æ•™è‚²ã¸ã®é›†ä¸­æŠ•è³‡
        if (company.strategy === 'tech_focused') {
            // ç ”ç©¶ãƒãƒƒãƒ—å„ªå…ˆï¼ˆ5æšã¾ã§ï¼‰
            if (company.chips.research < 5 && company.cash >= chipCost + safetyMargin) {
                company.cash -= chipCost;
                company.chips.research++;
                incrementRow(companyIndex);
                showAIActionModal(company, 'ãƒãƒƒãƒ—è³¼å…¥', 'ğŸ”¬', 'ç ”ç©¶é–‹ç™ºãƒãƒƒãƒ—è³¼å…¥ï¼ˆæŠ€è¡“æŠ•è³‡ï¼‰');
                return;
            }
            // æ•™è‚²ãƒãƒƒãƒ—ï¼ˆåŠ¹ç‡å‘ä¸Šï¼‰
            if (company.chips.education < 2 && company.cash >= chipCost + safetyMargin) {
                company.cash -= chipCost;
                company.chips.education++;
                incrementRow(companyIndex);
                showAIActionModal(company, 'ãƒãƒƒãƒ—è³¼å…¥', 'ğŸ“š', 'æ•™è‚²ãƒãƒƒãƒ—è³¼å…¥ï¼ˆåŠ¹ç‡å‘ä¸Šï¼‰');
                return;
            }
            // å°å‹æ©Ÿæ¢°ï¼ˆåŠ¹ç‡çš„ãªæŠ•è³‡ï¼‰
            if (company.machines.length < 2 && company.cash >= 50 + safetyMargin) {
                company.cash -= 50;
                company.machines.push({type: 'small', attachments: 0});
                incrementRow(companyIndex);
                showAIActionModal(company, 'è¨­å‚™æŠ•è³‡', 'âš™ï¸', 'å°å‹æ©Ÿæ¢°è³¼å…¥ï¼ˆæŠ€è¡“æŠ•è³‡ï¼‰');
                return;
            }
        }

        // BALANCEDæˆ¦ç•¥ï¼šãƒãƒ©ãƒ³ã‚¹ã‚ˆãæŠ•è³‡
        if (company.strategy === 'balanced') {
            // ã¾ãšç ”ç©¶ãƒãƒƒãƒ—3æšç¢ºä¿
            if (company.chips.research < 3 && company.cash >= chipCost + safetyMargin) {
                company.cash -= chipCost;
                company.chips.research++;
                incrementRow(companyIndex);
                showAIActionModal(company, 'ãƒãƒƒãƒ—è³¼å…¥', 'ğŸ”¬', 'ç ”ç©¶é–‹ç™ºãƒãƒƒãƒ—è³¼å…¥ï¼ˆãƒãƒ©ãƒ³ã‚¹æŠ•è³‡ï¼‰');
                return;
            }
            // äººå“¡ãƒãƒ©ãƒ³ã‚¹
            if (company.workers < 2 && company.cash >= 5 + safetyMargin) {
                company.cash -= 5;
                company.workers++;
                company.extraLaborCost = (company.extraLaborCost || 0) + 5;
                incrementRow(companyIndex);
                showAIActionModal(company, 'æ¡ç”¨', 'ğŸ‘·', 'ãƒ¯ãƒ¼ã‚«ãƒ¼æ¡ç”¨ï¼ˆãƒãƒ©ãƒ³ã‚¹æŠ•è³‡ï¼‰');
                return;
            }
            if (company.salesmen < 3 && company.cash >= 5 + safetyMargin) {
                company.cash -= 5;
                company.salesmen++;
                company.extraLaborCost = (company.extraLaborCost || 0) + 5;
                incrementRow(companyIndex);
                showAIActionModal(company, 'æ¡ç”¨', 'ğŸ’¼', 'ã‚»ãƒ¼ãƒ«ã‚¹ãƒãƒ³æ¡ç”¨ï¼ˆãƒãƒ©ãƒ³ã‚¹æŠ•è³‡ï¼‰');
                return;
            }
        }

        // PRICE_FOCUSEDæˆ¦ç•¥ï¼šç ”ç©¶ãƒãƒƒãƒ—ç‰¹åŒ–
        if (company.strategy === 'price_focused') {
            if (company.chips.research < 6 && company.cash >= chipCost + safetyMargin) {
                company.cash -= chipCost;
                company.chips.research++;
                incrementRow(companyIndex);
                showAIActionModal(company, 'ãƒãƒƒãƒ—è³¼å…¥', 'ğŸ”¬', 'ç ”ç©¶ãƒãƒƒãƒ—è³¼å…¥ï¼ˆä¾¡æ ¼ç«¶äº‰åŠ›å¼·åŒ–ï¼‰');
                return;
            }
        }

        // UNPREDICTABLEæˆ¦ç•¥ï¼šãƒ©ãƒ³ãƒ€ãƒ ãªå¤§å‹æŠ•è³‡
        if (company.strategy === 'unpredictable' && Math.random() > 0.4) {
            const investmentChoice = Math.floor(Math.random() * 5);
            if (investmentChoice === 0 && company.machines.length < 2 && company.cash >= 100 + safetyMargin) {
                company.cash -= 100;
                company.machines.push({type: 'large', attachments: 0});
                incrementRow(companyIndex);
                showAIActionModal(company, 'è¨­å‚™æŠ•è³‡', 'ğŸ­', 'å¤§å‹æ©Ÿæ¢°è³¼å…¥ï¼ˆäºˆæ¸¬ä¸èƒ½ãªæŠ•è³‡ï¼‰');
                return;
            } else if (investmentChoice === 1 && company.chips.research < 5 && company.cash >= chipCost + safetyMargin) {
                company.cash -= chipCost;
                company.chips.research++;
                incrementRow(companyIndex);
                showAIActionModal(company, 'ãƒãƒƒãƒ—è³¼å…¥', 'ğŸ”¬', 'ç ”ç©¶ãƒãƒƒãƒ—è³¼å…¥ï¼ˆäºˆæ¸¬ä¸èƒ½ãªæŠ•è³‡ï¼‰');
                return;
            } else if (investmentChoice === 2 && company.workers < 4 && company.cash >= 5 + safetyMargin) {
                company.cash -= 5;
                company.workers++;
                company.extraLaborCost = (company.extraLaborCost || 0) + 5;
                incrementRow(companyIndex);
                showAIActionModal(company, 'æ¡ç”¨', 'ğŸ‘·', 'ãƒ¯ãƒ¼ã‚«ãƒ¼å¤§é‡æ¡ç”¨');
                return;
            } else if (investmentChoice === 3 && company.salesmen < 5 && company.cash >= 5 + safetyMargin) {
                company.cash -= 5;
                company.salesmen++;
                company.extraLaborCost = (company.extraLaborCost || 0) + 5;
                incrementRow(companyIndex);
                showAIActionModal(company, 'æ¡ç”¨', 'ğŸ’¼', 'ã‚»ãƒ¼ãƒ«ã‚¹ãƒãƒ³å¤§é‡æ¡ç”¨');
                return;
            }
        }
    }

    // === 2. åŸºæœ¬æŠ•è³‡ï¼ˆãƒœãƒˆãƒ«ãƒãƒƒã‚¯è§£æ¶ˆï¼‰ ===

    // ç ”ç©¶ãƒãƒƒãƒ—ï¼ˆä¾¡æ ¼ç«¶äº‰åŠ›å‘ä¸Šâ†’MQå¢—åŠ ã«ç›´çµï¼‰
    if (company.chips.research < 4 && company.cash >= chipCost + safetyMargin) {
        company.cash -= chipCost;
        company.chips.research++;
        incrementRow(companyIndex);
        showAIActionModal(company, 'ãƒãƒƒãƒ—è³¼å…¥', 'ğŸ”¬', 'ç ”ç©¶é–‹ç™ºãƒãƒƒãƒ—è³¼å…¥ï¼ˆä¾¡æ ¼ç«¶äº‰åŠ›+2ï¼‰');
        return;
    }

    // èƒ½åŠ›ãƒãƒ©ãƒ³ã‚¹èª¿æ•´
    const needMoreMfg = mfgCapacity < salesCapacity && mfgCapacity < 6;
    const needMoreSales = salesCapacity < mfgCapacity && salesCapacity < 6;

    // ãƒ¯ãƒ¼ã‚«ãƒ¼æ¡ç”¨
    if (needMoreMfg && company.workers < 3 && company.cash >= 5 + safetyMargin) {
        const machineCapacity = company.machines.reduce((sum, m) => {
            if (m.type === 'small') return sum + (m.attachments > 0 ? 2 : 1);
            return sum + 4;
        }, 0) + (company.chips.computer || 0);

        if (company.workers < machineCapacity) {
            company.cash -= 5;
            company.workers++;
            company.extraLaborCost = (company.extraLaborCost || 0) + 5;
            incrementRow(companyIndex);
            showAIActionModal(company, 'æ¡ç”¨', 'ğŸ‘·', 'ãƒ¯ãƒ¼ã‚«ãƒ¼æ¡ç”¨ï¼ˆè£½é€ èƒ½åŠ›å‘ä¸Šï¼‰');
            return;
        }
    }

    // ã‚»ãƒ¼ãƒ«ã‚¹ãƒãƒ³æ¡ç”¨
    if (needMoreSales && company.salesmen < 3 && company.cash >= 5 + safetyMargin) {
        company.cash -= 5;
        company.salesmen++;
        company.extraLaborCost = (company.extraLaborCost || 0) + 5;
        incrementRow(companyIndex);
        showAIActionModal(company, 'æ¡ç”¨', 'ğŸ’¼', 'ã‚»ãƒ¼ãƒ«ã‚¹ãƒãƒ³æ¡ç”¨ï¼ˆè²©å£²èƒ½åŠ›å‘ä¸Šï¼‰');
        return;
    }

    // åºƒå‘Šãƒãƒƒãƒ—
    if (needMoreSales && company.chips.advertising < 3 && company.cash >= chipCost + safetyMargin) {
        company.cash -= chipCost;
        company.chips.advertising++;
        incrementRow(companyIndex);
        showAIActionModal(company, 'ãƒãƒƒãƒ—è³¼å…¥', 'ğŸ“¢', 'åºƒå‘Šãƒãƒƒãƒ—è³¼å…¥ï¼ˆè²©å£²èƒ½åŠ›å‘ä¸Šï¼‰');
        return;
    }

    // æ©Ÿæ¢°æŠ•è³‡
    const workerCapacity = company.workers + (company.chips.education || 0);
    if (needMoreMfg && company.machines.length < 2 && workerCapacity > mfgCapacity && company.cash >= 50 + safetyMargin) {
        company.cash -= 50;
        company.machines.push({type: 'small', attachments: 0});
        incrementRow(companyIndex);
        showAIActionModal(company, 'è¨­å‚™æŠ•è³‡', 'âš™ï¸', 'å°å‹æ©Ÿæ¢°è³¼å…¥ï¼ˆè£½é€ èƒ½åŠ›å‘ä¸Šï¼‰');
        return;
    }

    // ä½•ã‚‚ã—ãªã‹ã£ãŸå ´åˆã¯Do Nothing
    nextTurn();
}

// End period
function endPeriod() {
    showToast('æœŸæœ«æ±ºç®—ã‚’é–‹å§‹ã—ã¾ã™', 'info', 3000);
    
    // æœŸæœ«æ™‚ç‚¹ã®äººæ•°ãƒ»æ©Ÿæ¢°å°æ•°ã‚’è¨˜éŒ²
    gameState.companies.forEach(company => {
        company.endOfPeriodStats = {
            workers: company.workers,
            salesmen: company.salesmen,
            machines: company.machines.length
        };
    });
    
    // Calculate financial metrics for all companies
    const financialData = [];
    
    gameState.companies.forEach(company => {
        // Calculate PQ, VQ, MQ, G
        const pq = company.totalSales;
        const vq = calculateVQ(company);
        const mq = pq - vq;
        const fixedCosts = calculateFixedCost(company);
        const g = mq - fixedCosts - (company.specialLoss || 0);
        
        // Q = è²©å£²å€‹æ•°ï¼ˆæœŸä¸­ã®ç·è²©å£²æ•°é‡ï¼‰
        const q = company.totalSoldQuantity || 0;
        
        // Calculate unit prices (P=PQ/Q, V=VQ/Q, M=MQ/Q) with rounding to 1 decimal place
        // ã™ã¹ã¦Qã§å‰²ã‚‹ï¼ˆè²©å£²æ•°é‡ãƒ™ãƒ¼ã‚¹ã®å˜ä¾¡ï¼‰
        const unitP = q > 0 ? Math.round(pq / q * 10) / 10 : 0;  // P = PQ Ã· Q
        const unitV = q > 0 ? Math.round(vq / q * 10) / 10 : 0;  // V = VQ Ã· Q
        const unitM = q > 0 ? Math.round(mq / q * 10) / 10 : 0;  // M = MQ Ã· Q
        
        financialData.push({
            name: company.name,
            p: unitP,  // P=PQ/Q (å˜ä¾¡)
            v: unitV,  // V=VQ/Q (å˜ä¾¡)
            m: unitM,  // M=MQ/Q (å˜ä¾¡)
            q: q,
            pq: pq,
            vq: vq,
            mq: mq,
            f: fixedCosts,
            g: g
        });
        
        // Calculate tax and dividend if equity exceeds Â¥300
        let tax = 0;
        let dividend = 0;
        const previousEquity = company.equity;
        const newEquity = previousEquity + g;

        if (newEquity > 300) {
            if (!company.hasExceeded300) {
                // åˆã‚ã¦Â¥300ã‚’è¶…ãˆãŸå ´åˆ
                const excess = newEquity - 300;
                tax = Math.round(excess * 0.5);  // è¶…éåˆ†ã®50%
                dividend = Math.round(excess * 0.2);  // è¶…éåˆ†ã®20%
                company.hasExceeded300 = true;
            } else {
                // æ—¢ã«Â¥300ã‚’è¶…ãˆã¦ã„ãŸå ´åˆï¼ˆåˆ©ç›ŠãŒã‚ã‚‹å ´åˆã®ã¿ï¼‰
                if (g > 0) {
                    tax = Math.round(g * 0.5);  // åˆ©ç›Šã®50%
                    dividend = Math.round(g * 0.1);  // åˆ©ç›Šã®10%
                }
            }
        }

        company.pendingTax = tax;
        company.pendingDividend = dividend;

        // Update equity (ç¨é‡‘ã¯è‡ªå·±è³‡æœ¬ã‹ã‚‰å¼•ã)
        company.equity = newEquity - tax;
        
        // Pay period-end costs (using end-of-period stats)
        const periodPayment = calculatePeriodPayment(company, true);
        company.cash -= periodPayment;
        
        // Apply short-term loan if cash is negative
        if (company.cash < 0) {
            const needed = Math.ceil(Math.abs(company.cash) / 0.8 / 50) * 50;
            company.shortLoans += needed;
            company.cash += needed * 0.8;  // çŸ­æœŸå€Ÿå…¥: å€Ÿå…¥æ™‚20%é‡‘åˆ©æ§é™¤
        }
        
        // Handle chip returns
        if (gameState.currentPeriod === 2) {
            // 2æœŸæœ«ï¼šã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ãƒ»ä¿é™ºã¯è¿”å´ã€ç ”ç©¶ãƒ»åºƒå‘Šã¯æœ€å¤§3æšã¾ã§æŒã¡è¶Šã—
            const maxCarryOver = 3;
            const totalResearch = company.chips.research + company.nextPeriodChips.research;
            const totalAdvertising = company.chips.advertising + company.nextPeriodChips.advertising;
            const totalEducation = company.chips.education + company.nextPeriodChips.education;

            // 3æšã‚’è¶…ãˆã‚‹å ´åˆã¯è­¦å‘Š
            if (totalResearch > maxCarryOver && company.type === 'player') {
                alert(`ç ”ç©¶ãƒãƒƒãƒ—ãŒ${totalResearch}æšã‚ã‚Šã¾ã™ãŒã€3æšã¾ã§ã—ã‹æŒã¡è¶Šã›ã¾ã›ã‚“ã€‚`);
            }
            if (totalAdvertising > maxCarryOver && company.type === 'player') {
                alert(`åºƒå‘Šãƒãƒƒãƒ—ãŒ${totalAdvertising}æšã‚ã‚Šã¾ã™ãŒã€3æšã¾ã§ã—ã‹æŒã¡è¶Šã›ã¾ã›ã‚“ã€‚`);
            }

            // æ¬¡æœŸãƒãƒƒãƒ—è¨­å®šï¼ˆ2æœŸâ†’3æœŸã¯å…¨ãƒãƒƒãƒ—1æšæ¸›ã£ã¦ç¹°ã‚Šè¶Šã—ã€æœ€å¤§3æšã¾ã§ï¼‰
            const newResearch = Math.max(0, Math.min(totalResearch, maxCarryOver) - 1);
            const newEducation = Math.max(0, Math.min(totalEducation, maxCarryOver) - 1);
            const newAdvertising = Math.max(0, Math.min(totalAdvertising, maxCarryOver) - 1);

            company.chips.computer = 0;  // è¿”å´
            company.chips.insurance = 0; // è¿”å´
            company.chips.research = newResearch;
            company.chips.education = newEducation;
            company.chips.advertising = newAdvertising;
            company.nextPeriodChips = {research: 0, education: 0, advertising: 0};

            // ç¹°ã‚Šè¶Šã—ãƒãƒƒãƒ—ã‚’è¨˜éŒ²ï¼ˆ3æœŸã®Fè¨ˆç®—ã§20å††/æšã¨ã—ã¦ä½¿ç”¨ï¼‰
            company.carriedOverChips = {
                research: newResearch,
                education: newEducation,
                advertising: newAdvertising
            };
        } else {
            // 3-5æœŸæœ«ï¼šå…¨ãƒãƒƒãƒ—æ²¡åï¼ˆç¹°è¶Šåˆ†ã¯æ®‹ã‚‹ï¼‰
            const carryResearch = company.nextPeriodChips.research || 0;
            const carryEducation = company.nextPeriodChips.education || 0;
            const carryAdvertising = company.nextPeriodChips.advertising || 0;

            company.chips = {
                computer: 0,
                insurance: 0,
                research: carryResearch,
                education: carryEducation,
                advertising: carryAdvertising
            };
            company.nextPeriodChips = {research: 0, education: 0, advertising: 0};

            // ç¹°ã‚Šè¶Šã—ãƒãƒƒãƒ—ã‚’è¨˜éŒ²ï¼ˆæ¬¡æœŸã®Fè¨ˆç®—ã§20å††/æšã¨ã—ã¦ä½¿ç”¨ï¼‰
            company.carriedOverChips = {
                research: carryResearch,
                education: carryEducation,
                advertising: carryAdvertising
            };
        }
        
        // Update period start inventory
        company.periodStartInventory = {
            materials: company.materials,
            wip: company.wip,
            products: company.products
        };
        
        // Reset period tracking
        company.rowsUsed = 0;
        company.totalSales = 0;
        company.totalSoldQuantity = 0;
        company.totalMaterialCost = 0;
        company.totalProductionCost = 0;
        company.specialLoss = 0;
        company.extraLaborCost = 0;

        // å€‰åº«ãƒªã‚»ãƒƒãƒˆï¼ˆæœŸæœ«ã§æ¶ˆæ»…ï¼‰
        company.warehouses = 0;
        company.warehouseLocation = 'materials';

        // Reset retirement and max personnel tracking for next period
        company.retiredWorkers = 0;
        company.retiredSalesmen = 0;
        company.maxPersonnel = company.workers + company.salesmen;  // æ¬¡æœŸã®åˆæœŸå€¤
    });
    
    // Store and show financial summary
    window.lastFinancialData = financialData;

    // æœŸæœ«è¿”æ¸ˆå‡¦ç†ï¼ˆAIä¼šç¤¾ã¯è‡ªå‹•è¿”æ¸ˆã€ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¯é¸æŠï¼‰
    processEndPeriodLoanRepayments(financialData);
}

// æœŸæœ«è¿”æ¸ˆå‡¦ç†
function processEndPeriodLoanRepayments(financialData) {
    // AIä¼šç¤¾ã®è‡ªå‹•è¿”æ¸ˆå‡¦ç†
    gameState.companies.forEach(company => {
        if (company.type === 'ai') {
            processAutoLoanRepayment(company);
        }
    });

    // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ä¼šç¤¾ã®è¿”æ¸ˆUIè¡¨ç¤º
    const player = gameState.companies[0];
    if (player.shortLoans > 0 || player.loans > 0) {
        showLoanRepaymentModal(financialData);
    } else {
        // å€Ÿå…¥ãŒãªã„å ´åˆã¯ç›´æ¥æ±ºç®—è¡¨ç¤ºã¸
        window.currentSettlementIndex = 0;
        showCompanySettlement(0, financialData);
    }
}

// AIä¼šç¤¾ã®è‡ªå‹•è¿”æ¸ˆå‡¦ç†
function processAutoLoanRepayment(company) {
    // çŸ­æœŸå€Ÿå…¥: æœ€ä½20%è¿”æ¸ˆ
    if (company.shortLoans > 0) {
        const minShortPayment = Math.ceil(company.shortLoans * 0.2);
        const actualPayment = Math.min(minShortPayment, company.cash);

        if (actualPayment > 0) {
            company.cash -= actualPayment;
            company.shortLoans -= actualPayment;
        }

        // è³‡é‡‘ä¸è¶³ã§æœ€ä½è¿”æ¸ˆã§ããªã„å ´åˆã¯çŸ­æœŸå€Ÿå…¥ã§è£œå¡«
        if (actualPayment < minShortPayment) {
            const shortfall = minShortPayment - actualPayment;
            const needed = Math.ceil(shortfall / 0.8 / 50) * 50;
            company.shortLoans += needed;
            company.cash += needed * 0.8;
            company.cash -= (minShortPayment - actualPayment);
            company.shortLoans -= (minShortPayment - actualPayment);
        }
    }

    // é•·æœŸå€Ÿå…¥: æœ€ä½10%è¿”æ¸ˆ
    if (company.loans > 0) {
        const minLongPayment = Math.ceil(company.loans * 0.1);
        const actualPayment = Math.min(minLongPayment, company.cash);

        if (actualPayment > 0) {
            company.cash -= actualPayment;
            company.loans -= actualPayment;
        }

        // è³‡é‡‘ä¸è¶³ã§æœ€ä½è¿”æ¸ˆã§ããªã„å ´åˆã¯çŸ­æœŸå€Ÿå…¥ã§è£œå¡«
        if (actualPayment < minLongPayment) {
            const shortfall = minLongPayment - actualPayment;
            const needed = Math.ceil(shortfall / 0.8 / 50) * 50;
            company.shortLoans += needed;
            company.cash += needed * 0.8;
            company.cash -= (minLongPayment - actualPayment);
            company.loans -= (minLongPayment - actualPayment);
        }
    }
}

// ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼è¿”æ¸ˆUIãƒ¢ãƒ¼ãƒ€ãƒ«
function showLoanRepaymentModal(financialData) {
    const player = gameState.companies[0];
    const minShortPayment = player.shortLoans > 0 ? Math.ceil(player.shortLoans * 0.2) : 0;
    const minLongPayment = player.loans > 0 ? Math.ceil(player.loans * 0.1) : 0;

    let shortOptions = '';
    if (player.shortLoans > 0) {
        shortOptions = `
            <div class="form-group">
                <label class="form-label">çŸ­æœŸå€Ÿå…¥è¿”æ¸ˆï¼ˆæ®‹é«˜: Â¥${player.shortLoans}ã€æœ€ä½20%: Â¥${minShortPayment}ï¼‰</label>
                <select id="shortRepayment" class="form-control">
                    <option value="${minShortPayment}">æœ€ä½è¿”æ¸ˆ: Â¥${minShortPayment}</option>
                    ${player.shortLoans <= player.cash ? `<option value="${player.shortLoans}">å…¨é¡è¿”æ¸ˆ: Â¥${player.shortLoans}</option>` : ''}
                </select>
            </div>
        `;
    }

    let longOptions = '';
    if (player.loans > 0) {
        longOptions = `
            <div class="form-group">
                <label class="form-label">é•·æœŸå€Ÿå…¥è¿”æ¸ˆï¼ˆæ®‹é«˜: Â¥${player.loans}ã€æœ€ä½10%: Â¥${minLongPayment}ï¼‰</label>
                <select id="longRepayment" class="form-control">
                    <option value="${minLongPayment}">æœ€ä½è¿”æ¸ˆ: Â¥${minLongPayment}</option>
                    ${player.loans <= player.cash ? `<option value="${player.loans}">å…¨é¡è¿”æ¸ˆ: Â¥${player.loans}</option>` : ''}
                </select>
            </div>
        `;
    }

    const content = `
        <div style="padding: 15px;">
            <div style="background: #fef3c7; border-radius: 8px; padding: 10px; margin-bottom: 15px;">
                <div style="font-weight: bold; color: #92400e;">ğŸ’° ç¾åœ¨ã®ç¾é‡‘: Â¥${player.cash}</div>
            </div>
            ${shortOptions}
            ${longOptions}
            <button class="submit-btn" onclick="processPlayerLoanRepayment()">è¿”æ¸ˆå®Ÿè¡Œ</button>
        </div>
    `;

    showModal('æœŸæœ«è¿”æ¸ˆå‡¦ç†', content);
}

// ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼è¿”æ¸ˆå‡¦ç†
function processPlayerLoanRepayment() {
    const player = gameState.companies[0];

    const shortRepaymentEl = document.getElementById('shortRepayment');
    const longRepaymentEl = document.getElementById('longRepayment');

    const shortRepayment = shortRepaymentEl ? parseInt(shortRepaymentEl.value) : 0;
    const longRepayment = longRepaymentEl ? parseInt(longRepaymentEl.value) : 0;
    const totalRepayment = shortRepayment + longRepayment;

    // è³‡é‡‘ä¸è¶³ã®å ´åˆã¯çŸ­æœŸå€Ÿå…¥
    if (player.cash < totalRepayment) {
        const needed = Math.ceil((totalRepayment - player.cash) / 0.8 / 50) * 50;
        player.shortLoans += needed;
        player.cash += needed * 0.8;
        alert(`è³‡é‡‘ä¸è¶³ã®ãŸã‚Â¥${needed}ã‚’çŸ­æœŸå€Ÿå…¥ã—ã¾ã—ãŸ`);
    }

    // è¿”æ¸ˆå‡¦ç†
    player.cash -= totalRepayment;
    player.shortLoans -= shortRepayment;
    player.loans -= longRepayment;

    closeModal();

    // æ±ºç®—è¡¨ç¤ºã¸
    window.currentSettlementIndex = 0;
    showCompanySettlement(0, window.lastFinancialData);
}

// End game
function endGame() {
    // å‹åˆ©æ¡ä»¶ãƒã‚§ãƒƒã‚¯: æ¬¡æœŸç¹°ã‚Šè¶Šã—ãƒãƒƒãƒ—3æšä»¥ä¸Š ã‹ã¤ åœ¨åº«åˆè¨ˆ10å€‹ä»¥ä¸Š
    const companiesWithConditions = gameState.companies.map(company => {
        const nextChips = (company.nextPeriodChips?.research || 0) +
                         (company.nextPeriodChips?.education || 0) +
                         (company.nextPeriodChips?.advertising || 0);
        const inventory = company.materials + company.wip + company.products;
        const meetsCondition = nextChips >= 3 && inventory >= 10;

        return {
            ...company,
            nextChips,
            inventory,
            meetsCondition
        };
    });

    // æ¡ä»¶ã‚’æº€ãŸã™ä¼šç¤¾ã®ã¿ã§ãƒ©ãƒ³ã‚­ãƒ³ã‚°
    const qualifiedCompanies = companiesWithConditions.filter(c => c.meetsCondition);
    const disqualifiedCompanies = companiesWithConditions.filter(c => !c.meetsCondition);

    let resultHtml = '<div style="max-height: 500px; overflow-y: auto;">';

    // å‹åˆ©æ¡ä»¶ã®èª¬æ˜
    resultHtml += `
        <div style="background: #fef3c7; border-radius: 8px; padding: 12px; margin-bottom: 15px; font-size: 12px;">
            <div style="font-weight: bold; color: #92400e; margin-bottom: 5px;">å‹åˆ©æ¡ä»¶</div>
            <div style="color: #78350f;">æ¬¡æœŸç¹°ã‚Šè¶Šã—ãƒãƒƒãƒ—3æšä»¥ä¸Š ã‹ã¤ åœ¨åº«åˆè¨ˆ10å€‹ä»¥ä¸Š</div>
        </div>
    `;

    if (qualifiedCompanies.length > 0) {
        const rankings = qualifiedCompanies.sort((a, b) => b.equity - a.equity);
        const winner = rankings[0];

        resultHtml += `
            <div style="background: linear-gradient(180deg, #fbbf24 0%, #f59e0b 100%); border-radius: 12px; padding: 20px; margin-bottom: 15px; text-align: center; border: 3px solid #d97706;">
                <div style="font-size: 32px; margin-bottom: 5px;">ğŸ†</div>
                <div style="font-size: 20px; font-weight: bold; color: #78350f;">${winner.name}</div>
                <div style="font-size: 24px; font-weight: bold; color: #1e40af; margin-top: 5px;">è‡ªå·±è³‡æœ¬ Â¥${winner.equity}</div>
                <div style="font-size: 11px; color: #78350f; margin-top: 8px;">
                    ç¹°è¶Šãƒãƒƒãƒ—: ${winner.nextChips}æš / åœ¨åº«: ${winner.inventory}å€‹
                </div>
            </div>
        `;

        resultHtml += '<div class="breakdown-list">';
        rankings.forEach((company, index) => {
            const medal = index === 0 ? 'ğŸ¥‡' : index === 1 ? 'ğŸ¥ˆ' : index === 2 ? 'ğŸ¥‰' : '';
            resultHtml += `
                <div class="breakdown-item" style="padding: 10px; ${index === 0 ? 'background: #fef9c3;' : ''}">
                    <div>
                        <span style="font-weight: bold;">${medal} ${index + 1}ä½: ${company.name}</span>
                        <div style="font-size: 11px; color: #666;">ãƒãƒƒãƒ—: ${company.nextChips}æš / åœ¨åº«: ${company.inventory}å€‹</div>
                    </div>
                    <span style="font-weight: bold; color: #1e40af;">Â¥${company.equity}</span>
                </div>
            `;
        });
        resultHtml += '</div>';
    } else {
        resultHtml += `
            <div style="background: #fee2e2; border-radius: 12px; padding: 20px; margin-bottom: 15px; text-align: center;">
                <div style="font-size: 24px; margin-bottom: 5px;">ğŸ˜¢</div>
                <div style="font-size: 16px; font-weight: bold; color: #991b1b;">å‹åˆ©æ¡ä»¶ã‚’æº€ãŸã™ä¼šç¤¾ãŒã‚ã‚Šã¾ã›ã‚“</div>
            </div>
        `;
    }

    // å¤±æ ¼ä¼šç¤¾ï¼ˆæ¡ä»¶æœªé”æˆï¼‰
    if (disqualifiedCompanies.length > 0) {
        resultHtml += `
            <div style="margin-top: 15px; padding-top: 15px; border-top: 2px dashed #e5e7eb;">
                <div style="font-weight: bold; color: #6b7280; margin-bottom: 10px;">æ¡ä»¶æœªé”æˆ</div>
        `;
        disqualifiedCompanies.forEach(company => {
            const chipStatus = company.nextChips >= 3 ? 'âœ“' : 'âœ—';
            const invStatus = company.inventory >= 10 ? 'âœ“' : 'âœ—';
            resultHtml += `
                <div class="breakdown-item" style="padding: 8px; opacity: 0.7;">
                    <div>
                        <span>${company.name}</span>
                        <div style="font-size: 10px; color: #ef4444;">
                            ãƒãƒƒãƒ—${chipStatus}${company.nextChips}æš / åœ¨åº«${invStatus}${company.inventory}å€‹
                        </div>
                    </div>
                    <span style="color: #6b7280;">Â¥${company.equity}</span>
                </div>
            `;
        });
        resultHtml += '</div>';
    }

    resultHtml += '</div>';

    showModal('ã‚²ãƒ¼ãƒ çµ‚äº† - æœ€çµ‚çµæœ', resultHtml);
}

// ============================================
// ã‚»ãƒ¼ãƒ–ãƒ»ãƒ­ãƒ¼ãƒ‰æ©Ÿèƒ½
// ============================================
const SAVE_KEY = 'mg_game_save';

function saveGame() {
    const saveData = {
        version: 1,
        timestamp: Date.now(),
        currentPeriod: gameState.currentPeriod,
        currentRow: gameState.currentRow,
        maxRows: gameState.maxRows,
        currentPlayerIndex: gameState.currentPlayerIndex,
        turnOrder: gameState.turnOrder,
        skipTurns: gameState.skipTurns,
        doNothingCount: gameState.doNothingCount,
        usedRiskCards: gameState.usedRiskCards,
        usedDecisionCards: gameState.usedDecisionCards,
        reverseOrder: gameState.reverseOrder,
        turnReversed: gameState.turnReversed,
        periodStarted: gameState.periodStarted,
        cardDeck: gameState.cardDeck,
        deckInitialized: gameState.deckInitialized,
        markets: gameState.markets,
        companies: gameState.companies
    };
    localStorage.setItem(SAVE_KEY, JSON.stringify(saveData));
    console.log('ã‚²ãƒ¼ãƒ ã‚’è‡ªå‹•ä¿å­˜ã—ã¾ã—ãŸï¼ˆæœŸ' + gameState.currentPeriod + 'ï¼‰');
}

function loadGame() {
    const savedData = localStorage.getItem(SAVE_KEY);
    if (!savedData) return null;
    try {
        return JSON.parse(savedData);
    } catch (e) {
        console.error('ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—:', e);
        return null;
    }
}

function hasSavedGame() {
    return localStorage.getItem(SAVE_KEY) !== null;
}

function deleteSavedGame() {
    localStorage.removeItem(SAVE_KEY);
}

function restoreGame(saveData) {
    gameState.currentPeriod = saveData.currentPeriod;
    gameState.currentRow = saveData.currentRow;
    gameState.maxRows = saveData.maxRows;
    gameState.currentPlayerIndex = saveData.currentPlayerIndex;
    gameState.turnOrder = saveData.turnOrder;
    gameState.skipTurns = saveData.skipTurns;
    gameState.doNothingCount = saveData.doNothingCount;
    gameState.usedRiskCards = saveData.usedRiskCards;
    gameState.usedDecisionCards = saveData.usedDecisionCards;
    gameState.reverseOrder = saveData.reverseOrder;
    gameState.turnReversed = saveData.turnReversed;
    gameState.periodStarted = saveData.periodStarted;
    gameState.cardDeck = saveData.cardDeck;
    gameState.deckInitialized = saveData.deckInitialized;
    gameState.markets = saveData.markets;
    gameState.companies = saveData.companies;
}

function showStartMenu() {
    const hasSave = hasSavedGame();
    const saveData = hasSave ? loadGame() : null;
    const saveInfo = saveData ? `ï¼ˆ${saveData.currentPeriod}æœŸã€${new Date(saveData.timestamp).toLocaleString('ja-JP')}ï¼‰` : '';

    const menuHtml = `
        <div class="modal active" style="z-index: 2000;">
            <div class="modal-content" style="max-width: 400px; text-align: center;">
                <h2 style="margin-bottom: 20px; color: #1e40af;">ğŸ® MGï¼ˆãƒãƒã‚¸ãƒ¡ãƒ³ãƒˆã‚²ãƒ¼ãƒ ï¼‰</h2>
                <p style="margin-bottom: 20px; color: #666;">è‡ªä¸»ç·´ãƒ¢ãƒ¼ãƒ‰ - 6äººå¯¾æˆ¦</p>

                <div style="display: flex; flex-direction: column; gap: 12px;">
                    ${hasSave ? `
                        <button onclick="resumeGame()" class="action-btn primary" style="padding: 15px; font-size: 16px;">
                            â–¶ ç¶šãã‹ã‚‰å§‹ã‚ã‚‹${saveInfo}
                        </button>
                    ` : ''}
                    <button onclick="startNewGame()" class="action-btn success" style="padding: 15px; font-size: 16px;">
                        ğŸ†• 2æœŸã‹ã‚‰æ–°ã—ãå§‹ã‚ã‚‹
                    </button>
                    ${hasSave ? `
                        <button onclick="confirmDeleteSave()" class="action-btn secondary" style="padding: 10px; font-size: 14px;">
                            ğŸ—‘ ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤
                        </button>
                    ` : ''}
                </div>
            </div>
        </div>
    `;
    document.getElementById('modalContainer').innerHTML = menuHtml;
}

function resumeGame() {
    const saveData = loadGame();
    if (saveData) {
        restoreGame(saveData);
        document.getElementById('modalContainer').innerHTML = '';
        updateDisplay();
        showToast('ã‚²ãƒ¼ãƒ ã‚’å†é–‹ã—ã¾ã—ãŸï¼ˆ' + gameState.currentPeriod + 'æœŸï¼‰', 'success', 3000);
    }
}

function startNewGame() {
    deleteSavedGame();
    initializeCompanies();
    initializeCardDeck();
    document.getElementById('modalContainer').innerHTML = '';
    updateDisplay();
    saveGame(); // åˆæœŸçŠ¶æ…‹ã‚’ä¿å­˜
}

function confirmDeleteSave() {
    if (confirm('ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚')) {
        deleteSavedGame();
        showStartMenu();
    }
}

// Initialize game
function initGame() {
    console.log("initGame started");
    try {
        // ã¾ãšä¼šç¤¾ã¨ãƒ‡ãƒƒã‚­ã‚’åˆæœŸåŒ–ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆçŠ¶æ…‹ï¼‰
        initializeCompanies();
        console.log("Companies initialized");
        initializeCardDeck();
        console.log("Card deck initialized (75 cards)");

        // ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Œã°ã‚¹ã‚¿ãƒ¼ãƒˆãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’è¡¨ç¤º
        if (hasSavedGame()) {
            showStartMenu();
        } else {
            updateDisplay();
            saveGame(); // åˆæœŸçŠ¶æ…‹ã‚’ä¿å­˜
        }
        console.log("Display updated");
    } catch(e) {
        console.error("Error in initGame:", e);
        alert("ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: " + e.message);
    }
}

// Start the game
console.log("Starting game...");
initGame();
    </script>
</body>
</html>