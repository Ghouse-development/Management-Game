<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MG (Management Game) - Ultimate Edition</title>
    <!-- å¤–éƒ¨CSSãƒ•ã‚¡ã‚¤ãƒ« -->
    <link rel="stylesheet" href="css/styles.css">
    <!-- å¤–éƒ¨JSãƒ•ã‚¡ã‚¤ãƒ« -->
    <script src="js/constants.js"></script>
    <script src="js/state.js"></script>
    <script src="js/game.js"></script>
    <script src="js/ui.js"></script>
    <script src="js/bidding.js"></script>
    <script src="js/accounting.js"></script>
    <script src="js/settlement.js"></script>
    <script src="js/loans.js"></script>
    <script src="js/chips.js"></script>
    <script src="js/save.js"></script>
    <script src="js/sales.js"></script>
    <script src="js/production.js"></script>
    <script src="js/assets.js"></script>
    <script src="js/ai-actions.js"></script>
    <script src="js/risk-effects.js"></script>
    <script src="js/cards.js"></script>
    <script src="js/ai-brain.js"></script>
    <script src="js/ai-strategies.js"></script>
</head>
<body>
    <!-- ãƒˆãƒ¼ã‚¹ãƒˆé€šçŸ¥ã‚³ãƒ³ãƒ†ãƒŠ -->
    <div id="toastContainer" class="toast-container"></div>

    <div class="container no-scroll">
        <!-- æ–°ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆï¼šã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãªã—ã§å…¨æƒ…å ±è¡¨ç¤º -->

        <!-- 1. AIä¼šç¤¾ãƒãƒƒã‚¸ï¼ˆã‚¿ãƒƒãƒ—ã§è©³ç´°è¡¨ç¤ºï¼‰ -->
        <div class="ai-companies-bar" id="aiCompaniesBar"></div>
        <!-- å…¨ç¤¾ä¸€è¦§ãƒœã‚¿ãƒ³ -->
        <button class="all-companies-btn" onclick="showAllCompaniesModal()" title="å…¨ç¤¾çŠ¶æ³ã‚’è¡¨ç¤º">ğŸ“Š å…¨ç¤¾</button>

        <!-- 2. ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ï¼ˆPC:æ¨ªä¸¦ã³ / ã‚¹ãƒãƒ›:ç¸¦ä¸¦ã³ï¼‰ -->
        <div class="main-content-wrapper">
            <!-- å·¦: ã‚«ãƒ¼ãƒ‰æ“ä½œ + å¸‚å ´ç›¤ -->
            <div class="main-game-area">
                <div class="card-draw-section" id="cardDrawSection">
                    <button class="draw-card-btn" onclick="drawCard()">ã‚«ãƒ¼ãƒ‰ã‚’å¼•ã</button>
                    <div class="turn-info" id="turnInfo">ã‚ãªãŸã®ã‚¿ãƒ¼ãƒ³ã§ã™</div>
                </div>
                <div class="markets-board compact">
                    <div class="markets-grid-compact" id="marketsDisplay"></div>
                </div>
            </div>

            <!-- å³: ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ä¼šç¤¾ç›¤ -->
            <div class="player-area-wrapper">
        <div class="player-area">
            <!-- ä¼šç¤¾ç›¤ï¼ˆå¤§ããè¡¨ç¤ºï¼‰ -->
            <div class="company-board" id="companyBoard">
                <!-- æƒ…å ±ãƒãƒ¼ -->
                <div class="board-info-bar">
                    <div class="info-badge period">
                        <span class="info-badge-label">æœŸ</span>
                        <span class="info-badge-value" id="currentPeriod">2</span>
                    </div>
                    <div class="info-badge row">
                        <span class="info-badge-label">è¡Œ</span>
                        <span class="info-badge-value" id="currentRow">2/20</span>
                    </div>
                    <div class="info-badge cash">
                        <span class="info-badge-label">ç¾é‡‘</span>
                        <span class="info-badge-value" id="playerCash">Â¥112</span>
                    </div>
                    <div class="info-badge fixed-cost" onclick="showFixedCostModal()">
                        <span class="info-badge-label">F</span>
                        <span class="info-badge-value" id="fixedCostDisplay">Â¥0</span>
                    </div>
                    <div class="info-badge equity">
                        <span class="info-badge-label">è‡ªå·±è³‡æœ¬</span>
                        <span class="info-badge-value" id="equity">Â¥283</span>
                    </div>
                    <div class="info-badge loan-long" id="loanLongBadge" style="display: none;">
                        <span class="info-badge-label">é•·æœŸå€Ÿå…¥</span>
                        <span class="info-badge-value" id="loanLong">Â¥0</span>
                    </div>
                    <div class="info-badge loan-short" id="loanShortBadge" style="display: none;">
                        <span class="info-badge-label">çŸ­æœŸå€Ÿå…¥</span>
                        <span class="info-badge-value" id="loanShort">Â¥0</span>
                    </div>
                </div>

                <!-- èƒ½åŠ›ã‚µãƒãƒªãƒ¼ -->
                <div class="capacity-summary" id="capacitySummary">
                    <div class="capacity-item mfg">
                        <span class="capacity-label">è£½é€ </span>
                        <span class="capacity-value" id="mfgCapacityDisplay">1</span>
                    </div>
                    <div class="capacity-item sales">
                        <span class="capacity-label">è²©å£²</span>
                        <span class="capacity-value" id="salesCapacityDisplay">2</span>
                    </div>
                    <div class="capacity-item price">
                        <span class="capacity-label">ä¾¡æ ¼</span>
                        <span class="capacity-value" id="priceCompDisplay">+0</span>
                    </div>
                </div>

                <!-- ç”Ÿç”£ãƒ•ãƒ­ãƒ¼ -->
                <div class="production-flow">
                    <div class="flow-box">
                        <div class="flow-box-title">ææ–™å€‰åº«</div>
                        <div class="flow-box-content" id="materialsDisplay"></div>
                    </div>
                    <div class="flow-arrow">
                        <span class="flow-arrow-icon">â†’</span>
                        <span class="flow-arrow-label">æŠ•å…¥</span>
                    </div>
                    <div class="flow-box factory">
                        <div class="flow-box-title">å·¥å ´ï¼ˆä»•æ›å“ï¼‰</div>
                        <div class="flow-box-content" id="wipDisplay"></div>
                    </div>
                    <div class="flow-arrow">
                        <span class="flow-arrow-icon">â†’</span>
                        <span class="flow-arrow-label">å®Œæˆ</span>
                    </div>
                    <div class="flow-box">
                        <div class="flow-box-title">å–¶æ¥­æ‰€ï¼ˆè£½å“ï¼‰</div>
                        <div class="flow-box-content" id="productsDisplay"></div>
                    </div>
                </div>

                <!-- äººå“¡ãƒ»æ©Ÿæ¢° -->
                <div class="personnel-row">
                    <div class="personnel-box">
                        <div class="personnel-box-title">ãƒ¯ãƒ¼ã‚«ãƒ¼</div>
                        <div class="personnel-dots" id="workersDisplay"></div>
                    </div>
                    <div class="personnel-box">
                        <div class="personnel-box-title">æ©Ÿæ¢°</div>
                        <div class="personnel-dots" id="machinesDisplay"></div>
                    </div>
                    <div class="personnel-box">
                        <div class="personnel-box-title">ã‚»ãƒ¼ãƒ«ã‚¹ãƒãƒ³</div>
                        <div class="personnel-dots" id="salesmenDisplay"></div>
                    </div>
                </div>

                <!-- ãƒãƒƒãƒ— -->
                <div class="chips-row">
                    <div class="chip-box">
                        <div class="chip-box-title">ç ”ç©¶</div>
                        <div class="chip-dots" id="researchChipsDisplay"></div>
                    </div>
                    <div class="chip-box">
                        <div class="chip-box-title">æ•™è‚²</div>
                        <div class="chip-dots" id="educationChipsDisplay"></div>
                    </div>
                    <div class="chip-box">
                        <div class="chip-box-title">åºƒå‘Š</div>
                        <div class="chip-dots" id="advertisingChipsDisplay"></div>
                    </div>
                    <div class="chip-box">
                        <div class="chip-box-title">PC</div>
                        <div class="chip-dots" id="computerChipsDisplay"></div>
                    </div>
                    <div class="chip-box">
                        <div class="chip-box-title">ä¿é™º</div>
                        <div class="chip-dots" id="insuranceChipsDisplay"></div>
                    </div>
                </div>
            </div>

            <!-- Få†…è¨³ãƒ‘ãƒãƒ« -->
            <div class="fixed-cost-panel">
                <div class="panel-title">Få†…è¨³</div>
                <div class="cost-breakdown" id="fixedCostBreakdown"></div>
            </div>

            <!-- æ¬¡ç¹°ç›¤ï¼ˆ3æœŸä»¥é™ã®ã¿è¡¨ç¤ºï¼‰ -->
            <div class="next-period-board" id="nextPeriodBoard" style="display: none;">
                <div class="board-title" style="background: #ca8a04; color: #fff;">æ¬¡ç¹°ç›¤</div>
                <div class="next-period-content">
                    <div class="next-chips">
                        <span class="next-chip-item">ç ”ç©¶: <span id="nextResearch">0</span></span>
                        <span class="next-chip-item">æ•™è‚²: <span id="nextEducation">0</span></span>
                        <span class="next-chip-item">åºƒå‘Š: <span id="nextAdvertising">0</span></span>
                    </div>
                </div>
            </div>
        </div>
        </div> <!-- player-area-wrapper -->
        </div> <!-- main-content-wrapper -->
    </div>

    <div id="modalContainer"></div>
    
    <script>
// MG Game Ultimate Edition
// ã‚³ã‚¢ãƒ­ã‚¸ãƒƒã‚¯ã¯ js/game.js, js/ui.js ã«ç§»å‹•æ¸ˆã¿

// è¡Œå‹•ãƒ­ã‚°ã‚’è¡¨ç¤ºã™ã‚‹ãƒ¢ãƒ¼ãƒ€ãƒ«
function showActionLogModal() {
    const companies = gameState.companies;

    let content = `
        <div style="max-height: 70vh; overflow-y: auto; padding: 10px;">
            <div style="text-align: center; margin-bottom: 15px;">
                <div style="font-size: 20px; font-weight: bold;">ç¬¬${gameState.currentPeriod}æœŸ è¡Œå‹•ãƒ­ã‚°</div>
            </div>
    `;

    // å„ä¼šç¤¾ã”ã¨ã«ãƒ­ã‚°ã‚’ã¾ã¨ã‚ã‚‹
    for (let i = 0; i < companies.length; i++) {
        const company = companies[i];
        const companyLogs = gameState.actionLog.filter(log => log.companyIndex === i);
        const emoji = i === 0 ? 'ğŸ‘¤' : ['ğŸ…°ï¸', 'ğŸ…±ï¸', 'Â©ï¸', 'ğŸ‡©', 'ğŸ‡ª'][i - 1] || 'ğŸ¢';
        const bgColor = i === 0 ? '#eff6ff' : '#f9fafb';

        content += `
            <div style="background: ${bgColor}; border-radius: 10px; padding: 12px; margin-bottom: 12px; border: 1px solid #e5e7eb;">
                <div style="display: flex; align-items: center; margin-bottom: 10px; border-bottom: 1px solid #e5e7eb; padding-bottom: 8px;">
                    <span style="font-size: 24px; margin-right: 10px;">${emoji}</span>
                    <span style="font-weight: bold; font-size: 16px; color: ${i === 0 ? '#2563eb' : '#374151'};">${company.name}</span>
                    <span style="margin-left: auto; font-size: 12px; color: #666;">ä½¿ç”¨è¡Œæ•°: ${company.currentRow - 1}</span>
                </div>
        `;

        if (companyLogs.length === 0) {
            content += `<div style="color: #999; font-size: 12px; padding: 5px;">è¡Œå‹•è¨˜éŒ²ãªã—</div>`;
        } else {
            content += '<div style="font-size: 12px;">';
            companyLogs.forEach((log, idx) => {
                const cashStr = log.cashChange !== 0
                    ? `<span style="color: ${log.cashChange > 0 ? '#16a34a' : '#dc2626'}; font-weight: bold;">${log.cashChange > 0 ? '+' : ''}Â¥${log.cashChange}</span>`
                    : '';
                const rowStr = log.rowUsed ? `<span style="color: #9333ea; margin-left: 5px;">ã€1è¡Œã€‘</span>` : '';

                content += `
                    <div style="display: flex; align-items: flex-start; padding: 4px 0; ${idx < companyLogs.length - 1 ? 'border-bottom: 1px dashed #e5e7eb;' : ''}">
                        <span style="color: #9ca3af; width: 25px; flex-shrink: 0;">${log.row}è¡Œ</span>
                        <span style="color: #374151; flex: 1;">${log.action}: ${log.details}</span>
                        <span style="min-width: 70px; text-align: right;">${cashStr}${rowStr}</span>
                    </div>
                `;
            });
            content += '</div>';
        }

        // ç·è¨ˆ
        const totalIncome = companyLogs.filter(l => l.cashChange > 0).reduce((sum, l) => sum + l.cashChange, 0);
        const totalExpense = companyLogs.filter(l => l.cashChange < 0).reduce((sum, l) => sum + l.cashChange, 0);
        content += `
            <div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid #d1d5db; display: flex; justify-content: space-between; font-size: 11px;">
                <span style="color: #16a34a;">åå…¥è¨ˆ: +Â¥${totalIncome}</span>
                <span style="color: #dc2626;">æ”¯å‡ºè¨ˆ: Â¥${totalExpense}</span>
                <span style="font-weight: bold;">å·®å¼•: Â¥${totalIncome + totalExpense}</span>
            </div>
        `;

        content += '</div>';
    }

    content += `
        </div>
        <button class="submit-btn" onclick="closeModal()">é–‰ã˜ã‚‹</button>
    `;

    showModal('è¡Œå‹•ãƒ­ã‚°', content);
}

// ã‚³ã‚¹ãƒˆè¨ˆç®—é–¢æ•°ã¯ js/game.js ã«ç§»å‹•æ¸ˆã¿

// Show period payment breakdown
function showPeriodPaymentBreakdown() {
    const company = gameState.companies[0];
    const period = gameState.currentPeriod;
    
    let html = '<div class="breakdown-list">';
    
    // çµ¦æ–™ã®è©³ç´°å†…è¨³
    if (company.endOfPeriodStats) {
        // æœŸæœ«æ™‚ç‚¹ã®äººæ•°ãƒ»æ©Ÿæ¢°å°æ•°ã‚’ä½¿ç”¨
        const stats = company.endOfPeriodStats;

        // åŸºæœ¬å˜ä¾¡ï¼ˆã‚µã‚¤ã‚³ãƒ­ã«ã‚ˆã‚‹å¤‰å‹•ã¯3æœŸä»¥é™ï¼‰
        const baseCost = {2: 22, 3: 24, 4: 26, 5: 28};
        let unitCost = baseCost[period] || 22;
        if (period >= 3 && gameState.wageMultiplier > 1) {
            unitCost = Math.round(baseCost[period] * gameState.wageMultiplier);
        }
        const halfCost = Math.round(unitCost / 2);

        const machineCost = stats.machines * unitCost;
        const workerCost = stats.workers * unitCost;
        const salesmanCost = stats.salesmen * unitCost;
        const personnelCost = (stats.workers + stats.salesmen) * halfCost;

        html += `<div class="breakdown-item"><span>ã€çµ¦æ–™å†…è¨³ã€‘</span><span></span></div>`;
        html += `<div class="breakdown-item"><span>ã€€æ©Ÿæ¢°è²» (${stats.machines}å°Ã—Â¥${unitCost})</span><span>Â¥${machineCost}</span></div>`;
        html += `<div class="breakdown-item"><span>ã€€ãƒ¯ãƒ¼ã‚«ãƒ¼çµ¦æ–™ (${stats.workers}äººÃ—Â¥${unitCost})</span><span>Â¥${workerCost}</span></div>`;
        html += `<div class="breakdown-item"><span>ã€€ã‚»ãƒ¼ãƒ«ã‚¹ãƒãƒ³çµ¦æ–™ (${stats.salesmen}äººÃ—Â¥${unitCost})</span><span>Â¥${salesmanCost}</span></div>`;
        html += `<div class="breakdown-item"><span>ã€€äººå“¡åˆè¨ˆè²» (${stats.workers + stats.salesmen}äººÃ—Â¥${halfCost})</span><span>Â¥${personnelCost}</span></div>`;
        html += `<div class="breakdown-item"><span>çµ¦æ–™åˆè¨ˆ</span><span>Â¥${machineCost + workerCost + salesmanCost + personnelCost}</span></div>`;
    } else {
        // é€šå¸¸ã®çµ¦æ–™è¨ˆç®—
        const salaryCost = calculateSalaryCost(company, period);
        html += `<div class="breakdown-item"><span>çµ¦æ–™</span><span>Â¥${salaryCost}</span></div>`;
    }
    
    // é•·æœŸå€Ÿå…¥è¿”æ¸ˆ
    if (company.loans > 0) {
        const loanPayment = Math.floor(company.loans * 0.1);
        html += `<div class="breakdown-item"><span>é•·æœŸå€Ÿå…¥è¿”æ¸ˆ (Â¥${company.loans}Ã—10%)</span><span>Â¥${loanPayment}</span></div>`;
    }
    
    // çŸ­æœŸå€Ÿå…¥è¿”æ¸ˆ
    if (company.shortLoans > 0) {
        const shortLoanPayment = Math.floor(company.shortLoans * 0.2);
        html += `<div class="breakdown-item"><span>çŸ­æœŸå€Ÿå…¥è¿”æ¸ˆ (Â¥${company.shortLoans}Ã—20%)</span><span>Â¥${shortLoanPayment}</span></div>`;
    }
    
    const total = calculatePeriodPayment(company, company.endOfPeriodStats ? true : false);
    html += `<div class="breakdown-item breakdown-total"><span>åˆè¨ˆ</span><span>Â¥${total}</span></div>`;
    html += '</div>';
    
    showModal('æœŸæœ«æ”¯æ‰•å†…è¨³', html);
}

// Show fixed cost breakdown
function showFixedCostBreakdown() {
    const company = gameState.companies[0];
    const period = gameState.currentPeriod;
    
    let html = '<div class="breakdown-list">';
    
    // çµ¦æ–™
    const salaryCost = calculateSalaryCost(company, period);
    html += `<div class="breakdown-item"><span>çµ¦æ–™</span><span>Â¥${salaryCost}</span></div>`;
    
    // ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ãƒ»ä¿é™º
    if (company.chips.computer > 0) {
        html += `<div class="breakdown-item"><span>ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿(${company.chips.computer}æš)</span><span>Â¥${company.chips.computer * 20}</span></div>`;
    }
    
    if (company.chips.insurance > 0) {
        html += `<div class="breakdown-item"><span>ä¿é™º(${company.chips.insurance}æš)</span><span>Â¥${company.chips.insurance * 5}</span></div>`;
    }
    
    // æˆ¦ç•¥ãƒãƒƒãƒ—
    if (period === 2) {
        if (company.chips.research > 0) html += `<div class="breakdown-item"><span>ç ”ç©¶(1æšåˆ†)</span><span>Â¥20</span></div>`;
        if (company.chips.education > 0) html += `<div class="breakdown-item"><span>æ•™è‚²(1æšåˆ†)</span><span>Â¥20</span></div>`;
        if (company.chips.advertising > 0) html += `<div class="breakdown-item"><span>åºƒå‘Š(1æšåˆ†)</span><span>Â¥20</span></div>`;
    } else {
        if (company.chips.research > 0) html += `<div class="breakdown-item"><span>ç ”ç©¶ãƒ»ç‰¹æ€¥(${company.chips.research}æš)</span><span>Â¥${company.chips.research * 40}</span></div>`;
        if (company.chips.education > 0) html += `<div class="breakdown-item"><span>æ•™è‚²ãƒ»ç‰¹æ€¥(${company.chips.education}æš)</span><span>Â¥${company.chips.education * 40}</span></div>`;
        if (company.chips.advertising > 0) html += `<div class="breakdown-item"><span>åºƒå‘Šãƒ»ç‰¹æ€¥(${company.chips.advertising}æš)</span><span>Â¥${company.chips.advertising * 40}</span></div>`;
        if (company.nextPeriodChips?.research > 0) html += `<div class="breakdown-item"><span>ç ”ç©¶ãƒ»ç¹°è¶Š(${company.nextPeriodChips.research}æš)</span><span>Â¥${company.nextPeriodChips.research * 20}</span></div>`;
        if (company.nextPeriodChips?.education > 0) html += `<div class="breakdown-item"><span>æ•™è‚²ãƒ»ç¹°è¶Š(${company.nextPeriodChips.education}æš)</span><span>Â¥${company.nextPeriodChips.education * 20}</span></div>`;
        if (company.nextPeriodChips?.advertising > 0) html += `<div class="breakdown-item"><span>åºƒå‘Šãƒ»ç¹°è¶Š(${company.nextPeriodChips.advertising}æš)</span><span>Â¥${company.nextPeriodChips.advertising * 20}</span></div>`;
    }
    
    // æ¸›ä¾¡å„Ÿå´è²»
    const depreciationCost = calculateDepreciation(company, period);
    if (depreciationCost > 0) {
        html += `<div class="breakdown-item"><span>æ¸›ä¾¡å„Ÿå´è²»</span><span>Â¥${depreciationCost}</span></div>`;
    }
    
    const total = calculateFixedCost(company);
    html += `<div class="breakdown-item breakdown-total"><span>åˆè¨ˆ</span><span>Â¥${total}</span></div>`;
    html += '</div>';
    
    showModal('å›ºå®šè²»å†…è¨³', html);
}

// Start period
function startPeriod() {
    if (gameState.periodStarted) return;

    const company = gameState.companies[0];

    // é¸æŠçŠ¶æ…‹ã‚’åˆæœŸåŒ–
    window.periodStartSelections = {
        loan: 0,
        warehouse: 0,
        computer: 1,  // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ1å€‹
        insurance: 1  // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ1å€‹
    };

    // æœ€åˆã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’å–å¾—
    const startPlayer = gameState.companies[gameState.periodStartPlayerIndex || 0];
    const isPlayerFirst = (gameState.periodStartPlayerIndex || 0) === 0;

    let content = `
        <div style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white; padding: 15px; border-radius: 12px; margin-bottom: 15px; text-align: center;">
            <div style="font-size: 20px; font-weight: bold;">ğŸ“… ç¬¬${gameState.currentPeriod}æœŸé–‹å§‹</div>
            <div style="font-size: 14px; margin-top: 5px;">ğŸ’° ç¾é‡‘: Â¥${company.cash}</div>
            <div style="font-size: 12px; margin-top: 8px; padding: 6px; background: rgba(255,255,255,0.2); border-radius: 6px;">
                ğŸ² ä»ŠæœŸã®æœ€åˆ: <strong>${startPlayer.name}</strong>${isPlayerFirst ? 'ï¼ˆã‚ãªãŸã‹ã‚‰ï¼ï¼‰' : ''}
            </div>
        </div>
    `;

    // 3æœŸä»¥é™ã¯å€Ÿå…¥ã¨ç„¡ç½å®³å€‰åº«ã®é¸æŠ
    if (gameState.currentPeriod >= 3) {
        // å€Ÿå…¥ä¸Šé™ï¼š3æœŸã¯0.5å€ã€4æœŸä»¥é™ã§è‡ªå·±è³‡æœ¬300è¶…ãªã‚‰1å€
        const loanMultiplier = (gameState.currentPeriod >= 4 && company.equity > 300) ? 1.0 : 0.5;
        const maxLoanTotal = Math.round(company.equity * loanMultiplier);
        const availableLoan = Math.max(0, maxLoanTotal - company.loans);
        const loanRuleText = (gameState.currentPeriod >= 4 && company.equity > 300)
            ? `è‡ªå·±è³‡æœ¬ã®1å€ã¾ã§`
            : `è‡ªå·±è³‡æœ¬ã®0.5å€ã¾ã§`;

        content += `
            <div style="margin-bottom: 15px;">
                <div style="font-weight: bold; margin-bottom: 8px;">ğŸ¦ é•·æœŸå€Ÿå…¥ï¼ˆ${loanRuleText}ï¼‰</div>
                <div style="font-size: 11px; color: #666; margin-bottom: 8px;">
                    ä¸Šé™Â¥${maxLoanTotal} - æ—¢å­˜Â¥${company.loans} = è¿½åŠ å¯èƒ½Â¥${availableLoan}
                </div>
                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 6px;">
                    <div onclick="selectPeriodStart('loan', 0)" class="period-card" id="loan-0" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); border: 2px solid #34d399; border-radius: 8px; padding: 10px; text-align: center; cursor: pointer; color: white;">
                        <div style="font-size: 14px; font-weight: bold;">ãªã—</div>
                        <div style="font-size: 11px;">Â¥0</div>
                    </div>
                    ${availableLoan >= 50 ? `<div onclick="selectPeriodStart('loan', 50)" class="period-card" id="loan-50" style="background: #374151; border: 2px solid #6b7280; border-radius: 8px; padding: 10px; text-align: center; cursor: pointer; color: white;">
                        <div style="font-size: 14px; font-weight: bold;">Â¥50</div>
                        <div style="font-size: 11px;">é‡‘åˆ©Â¥5</div>
                    </div>` : ''}
                    ${availableLoan >= 100 ? `<div onclick="selectPeriodStart('loan', 100)" class="period-card" id="loan-100" style="background: #374151; border: 2px solid #6b7280; border-radius: 8px; padding: 10px; text-align: center; cursor: pointer; color: white;">
                        <div style="font-size: 14px; font-weight: bold;">Â¥100</div>
                        <div style="font-size: 11px;">é‡‘åˆ©Â¥10</div>
                    </div>` : ''}
                    ${availableLoan >= 150 ? `<div onclick="selectPeriodStart('loan', 150)" class="period-card" id="loan-150" style="background: #374151; border: 2px solid #6b7280; border-radius: 8px; padding: 10px; text-align: center; cursor: pointer; color: white;">
                        <div style="font-size: 14px; font-weight: bold;">Â¥150</div>
                        <div style="font-size: 11px;">é‡‘åˆ©Â¥15</div>
                    </div>` : ''}
                </div>
            </div>
            <div style="margin-bottom: 15px;">
                <div style="font-weight: bold; margin-bottom: 8px;">ğŸ­ ç„¡ç½å®³å€‰åº«ï¼ˆÂ¥20/å€‹ã€å®¹é‡+12ï¼‰</div>
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px;">
                    <div onclick="selectPeriodStart('warehouse', 0)" class="period-card" id="warehouse-0" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); border: 2px solid #34d399; border-radius: 8px; padding: 12px; text-align: center; cursor: pointer; color: white;">
                        <div style="font-size: 18px;">ğŸš«</div>
                        <div style="font-size: 14px; font-weight: bold;">è²·ã‚ãªã„</div>
                    </div>
                    <div onclick="selectPeriodStart('warehouse', 1)" class="period-card" id="warehouse-1" style="background: #374151; border: 2px solid #6b7280; border-radius: 8px; padding: 12px; text-align: center; cursor: pointer; color: white;">
                        <div style="font-size: 18px;">ğŸ­</div>
                        <div style="font-size: 14px; font-weight: bold;">1å€‹</div>
                        <div style="font-size: 11px;">Â¥20</div>
                    </div>
                    <div onclick="selectPeriodStart('warehouse', 2)" class="period-card" id="warehouse-2" style="background: #374151; border: 2px solid #6b7280; border-radius: 8px; padding: 12px; text-align: center; cursor: pointer; color: white;">
                        <div style="font-size: 18px;">ğŸ­ğŸ­</div>
                        <div style="font-size: 14px; font-weight: bold;">2å€‹</div>
                        <div style="font-size: 11px;">Â¥40</div>
                    </div>
                </div>
            </div>
        `;
    }

    content += `
        <div style="margin-bottom: 15px;">
            <div style="font-weight: bold; margin-bottom: 8px;">ğŸ’» ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ãƒãƒƒãƒ—ï¼ˆè£½é€ +1ï¼‰Â¥20</div>
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px;">
                <div onclick="selectPeriodStart('computer', 0)" class="period-card" id="computer-0" style="background: #374151; border: 2px solid #6b7280; border-radius: 8px; padding: 12px; text-align: center; cursor: pointer; color: white;">
                    <div style="font-size: 18px;">ğŸš«</div>
                    <div style="font-size: 14px; font-weight: bold;">è²·ã‚ãªã„</div>
                </div>
                <div onclick="selectPeriodStart('computer', 1)" class="period-card" id="computer-1" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); border: 2px solid #34d399; border-radius: 8px; padding: 12px; text-align: center; cursor: pointer; color: white;">
                    <div style="font-size: 18px;">ğŸ’»</div>
                    <div style="font-size: 14px; font-weight: bold;">1å€‹è³¼å…¥</div>
                    <div style="font-size: 11px;">Â¥20</div>
                </div>
            </div>
        </div>
        <div style="margin-bottom: 15px;">
            <div style="font-weight: bold; margin-bottom: 8px;">ğŸ›¡ï¸ ä¿é™ºãƒãƒƒãƒ—ï¼ˆç½å®³å¯¾ç­–ï¼‰Â¥5</div>
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px;">
                <div onclick="selectPeriodStart('insurance', 0)" class="period-card" id="insurance-0" style="background: #374151; border: 2px solid #6b7280; border-radius: 8px; padding: 12px; text-align: center; cursor: pointer; color: white;">
                    <div style="font-size: 18px;">ğŸš«</div>
                    <div style="font-size: 14px; font-weight: bold;">è²·ã‚ãªã„</div>
                </div>
                <div onclick="selectPeriodStart('insurance', 1)" class="period-card" id="insurance-1" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); border: 2px solid #34d399; border-radius: 8px; padding: 12px; text-align: center; cursor: pointer; color: white;">
                    <div style="font-size: 18px;">ğŸ›¡ï¸</div>
                    <div style="font-size: 14px; font-weight: bold;">1å€‹è³¼å…¥</div>
                    <div style="font-size: 11px;">Â¥5</div>
                </div>
            </div>
        </div>
        <button class="submit-btn" onclick="processPeriodStart()" style="width: 100%; padding: 15px; font-size: 16px;">æœŸé¦–å‡¦ç†ã‚’å®Œäº†</button>
    `;

    showModal('æœŸé¦–å‡¦ç†', content);
}

// æœŸé¦–å‡¦ç†ã®ã‚«ãƒ¼ãƒ‰é¸æŠ
function selectPeriodStart(type, value) {
    window.periodStartSelections[type] = value;

    // å…¨ã‚«ãƒ¼ãƒ‰ã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚’ãƒªã‚»ãƒƒãƒˆ
    document.querySelectorAll(`[id^="${type}-"]`).forEach(card => {
        card.style.background = '#374151';
        card.style.borderColor = '#6b7280';
    });

    // é¸æŠã•ã‚ŒãŸã‚«ãƒ¼ãƒ‰ã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆ
    const selected = document.getElementById(`${type}-${value}`);
    if (selected) {
        selected.style.background = 'linear-gradient(135deg, #10b981 0%, #059669 100%)';
        selected.style.borderColor = '#34d399';
    }
}

// Process period start
function processPeriodStart() {
    const company = gameState.companies[0];
    const selections = window.periodStartSelections || { loan: 0, warehouse: 0, computer: 1, insurance: 1 };
    let totalCost = 0;

    // ç´ç¨ãƒ»é…å½“ã®æ”¯æ‰•ã„ï¼ˆå‰æœŸæ±ºç®—åˆ†ï¼‰
    const playerTax = company.pendingTax || 0;
    const playerDividend = company.pendingDividend || 0;
    const taxDividendTotal = playerTax + playerDividend;

    if (taxDividendTotal > 0) {
        // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã«é€šçŸ¥
        alert(`ã€ç´ç¨ãƒ»é…å½“ã®æ”¯æ‰•ã„ã€‘\nç¨é‡‘: Â¥${playerTax}\né…å½“: Â¥${playerDividend}\nåˆè¨ˆ: Â¥${taxDividendTotal}`);
    }

    // å…¨ç¤¾ã®ç´ç¨ãƒ»é…å½“ã‚’å‡¦ç†
    gameState.companies.forEach(c => {
        const payment = (c.pendingTax || 0) + (c.pendingDividend || 0);
        if (payment > 0) {
            c.cash -= payment;
            console.log(`${c.name}: ç´ç¨Â¥${c.pendingTax || 0} + é…å½“Â¥${c.pendingDividend || 0} = Â¥${payment}`);

            // ç¾é‡‘ä¸è¶³ã®å ´åˆã¯çŸ­æœŸå€Ÿå…¥
            if (c.cash < 0) {
                const needed = Math.ceil(Math.abs(c.cash) / 0.8 / 50) * 50;
                c.shortLoans += needed;
                c.cash += needed * 0.8;
            }

            c.pendingTax = 0;
            c.pendingDividend = 0;
        }
    });

    // å€Ÿå…¥å‡¦ç†ï¼ˆ3æœŸä»¥é™ã€ã‚«ãƒ¼ãƒ‰é¸æŠã‹ã‚‰å–å¾—ï¼‰
    if (gameState.currentPeriod >= 3) {
        const loanAmount = selections.loan || 0;
        if (loanAmount > 0) {
            const interest = Math.floor(loanAmount * 0.1);
            company.cash += loanAmount - interest;  // åˆ©æ¯ã‚’å¼•ã„ãŸé¡ãŒå…¥é‡‘
            company.loans += loanAmount;
            console.log(`é•·æœŸå€Ÿå…¥: Â¥${loanAmount} (åˆ©æ¯Â¥${interest}æ”¯æ‰•ã„æ¸ˆã¿)`);
        }

        // ç„¡ç½å®³å€‰åº«è³¼å…¥
        const warehouseCount = selections.warehouse || 0;
        if (warehouseCount > 0) {
            totalCost += warehouseCount * WAREHOUSE_COST;
            company.warehouses += warehouseCount;
            company.extraLaborCost = (company.extraLaborCost || 0) + (warehouseCount * WAREHOUSE_COST);
        }
    }

    // ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ãƒ»ä¿é™ºè³¼å…¥ï¼ˆã‚«ãƒ¼ãƒ‰é¸æŠã‹ã‚‰å–å¾—ï¼‰
    const computerQty = selections.computer || 0;
    const insuranceQty = selections.insurance || 0;

    totalCost += (computerQty * CHIP_COSTS.computer) + (insuranceQty * CHIP_COSTS.insurance);

    // æœŸé¦–ã§ç¾é‡‘ä¸è¶³ã®å ´åˆã€é•·æœŸå€Ÿå…¥ãŒå¯èƒ½
    if (company.cash < totalCost) {
        const shortage = totalCost - company.cash;
        const loansNeeded = Math.ceil(shortage / 100) * 100;

        if (confirm(`ç¾é‡‘ãŒÂ¥${shortage}ä¸è¶³ã—ã¦ã„ã¾ã™ã€‚\né•·æœŸå€Ÿå…¥Â¥${loansNeeded}ã‚’è¡Œã„ã¾ã™ã‹ï¼Ÿ\nï¼ˆåˆ©æ¯10%ã‚’å·®ã—å¼•ã„ãŸÂ¥${loansNeeded * 0.9}ãŒå…¥é‡‘ã•ã‚Œã¾ã™ï¼‰`)) {
            const netAmount = loansNeeded * 0.9;
            company.loans += loansNeeded;
            company.cash += netAmount;
        } else {
            alert('æœŸé¦–å‡¦ç†ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸ');
            return;
        }
    }

    company.cash -= totalCost;
    company.chips.computer = Math.min(3, company.chips.computer + computerQty);
    company.chips.insurance = Math.min(3, company.chips.insurance + insuranceQty);

    // AI companies also process period start with strategic planning
    for (let i = 1; i < gameState.companies.length; i++) {
        const aiCompany = gameState.companies[i];
        planAIPeriodStrategy(aiCompany, i);
    }

    gameState.periodStarted = true;
    closeModal();
    updateDisplay();

    // Show turn start options
    showTurnStartOptions();
}

// Show turn start options
function showTurnStartOptions() {
    if (gameState.currentPlayerIndex !== 0) return;

    const company = gameState.companies[0];
    const content = `
        <div class="card-choice-container">
            <h2>ã‚ãªãŸã®ã‚¿ãƒ¼ãƒ³</h2>
            <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                <button class="action-btn main card-choice-btn" onclick="drawCard()" style="flex: 2;">ã‚«ãƒ¼ãƒ‰ã‚’å¼•ã</button>
                <button class="action-btn secondary" onclick="viewGameState()" style="flex: 1; font-size: 12px;">å…¨ä½“ã‚’è¦‹ã‚‹</button>
            </div>
            <div style="margin-top: 20px;">
                <p>ãã®ä»–ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆBãƒ«ãƒ¼ãƒ«ï¼‰</p>
                <button class="action-btn secondary" onclick="showInsurancePurchaseModal()">ä¿é™ºãƒãƒƒãƒ—è³¼å…¥</button>
                <button class="action-btn secondary" onclick="showWarehouseModal()">ç„¡ç½å®³å€‰åº«ã‚’è³¼å…¥</button>
                ${company.warehouses === 1 ? '<button class="action-btn secondary" onclick="showWarehouseMoveModal()">å€‰åº«ã®ç§»å‹•</button>' : ''}
                <button class="action-btn secondary" onclick="showReassignModal()">é…ç½®è»¢æ›</button>
                <button class="action-btn secondary" onclick="showSellMachineModal()">æ©Ÿæ¢°å£²å´</button>
            </div>
        </div>
    `;
    
    showModal('è¡Œå‹•é¸æŠ', content);
}

// View game state - å…¨ä½“ã‚’è¦‹ã‚‹æ©Ÿèƒ½
function viewGameState() {
    closeModal();

    // è¡¨ç¤ºé †ï¼ˆè²©å£²ä¸Šé™ä¾¡æ ¼ã®é«˜ã„é †ï¼‰
    const displayOrder = ['ä»™å°', 'æœ­å¹Œ', 'ç¦å²¡', 'åå¤å±‹', 'å¤§é˜ª', 'æ±äº¬', 'æµ·å¤–'];

    // å¸‚å ´æƒ…å ±ã‚’ç”Ÿæˆ
    let marketsHtml = '<div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-bottom: 15px;">';
    displayOrder.forEach(marketName => {
        const market = gameState.markets.find(m => m.name === marketName);
        if (!market) return;
        const closedStyle = market.closed ? 'opacity: 0.5; text-decoration: line-through;' : '';
        const volumeText = market.name === 'æµ·å¤–' ? 'âˆ' : market.maxStock;
        marketsHtml += `
            <div style="background: linear-gradient(135deg, #1e3a5f 0%, #0f172a 100%); padding: 8px; border-radius: 8px; text-align: center; ${closedStyle}">
                <div style="font-weight: bold; color: #fbbf24; font-size: 12px;">${market.name}</div>
                <div style="color: #93c5fd; font-size: 10px;">å£²Â¥${market.sellPrice} / è²·Â¥${market.buyPrice}</div>
                <div style="color: #4ade80; font-size: 11px; margin-top: 3px;">åœ¨åº«: ${market.currentStock}/${volumeText}</div>
                ${market.closed ? '<div style="color: #ef4444; font-size: 10px;">é–‰é–ä¸­</div>' : ''}
            </div>
        `;
    });
    marketsHtml += '</div>';

    // å…¨ä¼šç¤¾ã®æƒ…å ±ã‚’ç”Ÿæˆ
    let companiesHtml = '';
    gameState.companies.forEach((company, idx) => {
        const isPlayer = idx === 0;
        const periodPayment = calculatePeriodPayment(company);
        const fixedCost = calculateFixedCost(company);
        const mfgCapacity = getManufacturingCapacity(company);
        const salesCapacity = getSalesCapacity(company);
        const priceComp = getPriceCompetitiveness(company, idx);

        // ãƒãƒƒãƒ—æƒ…å ±
        const chips = company.chips || {};
        const chipInfo = [];
        if (chips.research) chipInfo.push(`ç ”${chips.research}`);
        if (chips.education) chipInfo.push(`æ•™${chips.education}`);
        if (chips.advertising) chipInfo.push(`åºƒ${chips.advertising}`);
        if (chips.computer) chipInfo.push(`PC${chips.computer}`);
        if (chips.insurance) chipInfo.push(`ä¿${chips.insurance}`);

        // æ©Ÿæ¢°æƒ…å ±
        const smallMachines = company.machines.filter(m => m.type === 'small').length;
        const largeMachines = company.machines.filter(m => m.type === 'large').length;

        const bgColor = isPlayer ? 'linear-gradient(135deg, #166534 0%, #14532d 100%)' : 'linear-gradient(135deg, #1e40af 0%, #1e3a8a 100%)';
        const borderColor = isPlayer ? '#22c55e' : '#3b82f6';

        companiesHtml += `
            <div style="background: ${bgColor}; border: 2px solid ${borderColor}; border-radius: 12px; padding: 12px; margin-bottom: 10px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                    <div style="font-weight: bold; color: #fbbf24; font-size: 14px;">${isPlayer ? 'â˜… ' : ''}${company.name}</div>
                    <div style="display: flex; gap: 8px;">
                        <span style="color: #4ade80; font-weight: bold;">Â¥${company.cash}</span>
                        <span style="background: ${(company.currentRow || 1) >= gameState.maxRows - 5 ? '#ef4444' : '#3b82f6'}; color: white; padding: 2px 6px; border-radius: 4px; font-size: 11px;">
                            ${company.currentRow || 1}/${gameState.maxRows}è¡Œ
                        </span>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px; margin-bottom: 8px;">
                    <div style="background: rgba(139, 92, 246, 0.3); padding: 6px; border-radius: 6px; text-align: center;">
                        <div style="color: #c4b5fd; font-size: 10px;">ææ–™</div>
                        <div style="color: white; font-weight: bold;">${company.materials}å€‹</div>
                    </div>
                    <div style="background: rgba(168, 85, 247, 0.3); padding: 6px; border-radius: 6px; text-align: center;">
                        <div style="color: #d8b4fe; font-size: 10px;">ä»•æ›å“</div>
                        <div style="color: white; font-weight: bold;">${company.wip}å€‹</div>
                    </div>
                    <div style="background: rgba(99, 102, 241, 0.3); padding: 6px; border-radius: 6px; text-align: center;">
                        <div style="color: #a5b4fc; font-size: 10px;">è£½å“</div>
                        <div style="color: white; font-weight: bold;">${company.products}å€‹</div>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px; margin-bottom: 8px;">
                    <div style="background: rgba(251, 191, 36, 0.2); padding: 4px; border-radius: 4px; text-align: center;">
                        <span style="color: #fbbf24; font-size: 10px;">W:${company.workers}</span>
                    </div>
                    <div style="background: rgba(148, 163, 184, 0.2); padding: 4px; border-radius: 4px; text-align: center;">
                        <span style="color: #94a3b8; font-size: 10px;">æ©Ÿ:${smallMachines}å°${largeMachines}å¤§</span>
                    </div>
                    <div style="background: rgba(59, 130, 246, 0.2); padding: 4px; border-radius: 4px; text-align: center;">
                        <span style="color: #60a5fa; font-size: 10px;">S:${company.salesmen}</span>
                    </div>
                </div>

                <div style="display: flex; justify-content: space-between; font-size: 10px; color: #93c5fd;">
                    <span>è£½é€ :${mfgCapacity} è²©å£²:${salesCapacity} ä¾¡æ ¼:+${priceComp}</span>
                    <span>F:Â¥${fixedCost}</span>
                </div>

                ${chipInfo.length > 0 ? `<div style="font-size: 10px; color: #a78bfa; margin-top: 4px;">ãƒãƒƒãƒ—: ${chipInfo.join(' ')}</div>` : ''}
            </div>
        `;
    });

    const content = `
        <div style="max-height: 70vh; overflow-y: auto; padding: 10px;">
            <div style="background: #1e293b; padding: 10px; border-radius: 8px; margin-bottom: 15px;">
                <div style="text-align: center; color: #fbbf24; font-weight: bold; margin-bottom: 10px;">
                    ğŸ“Š ${gameState.currentPeriod}æœŸ ${gameState.currentRow}/${gameState.maxRows}è¡Œç›®
                </div>
                <h4 style="color: #60a5fa; margin-bottom: 8px; font-size: 13px;">ğŸª å¸‚å ´ç›¤</h4>
                ${marketsHtml}
            </div>

            <h4 style="color: #60a5fa; margin-bottom: 10px; font-size: 13px;">ğŸ¢ å…¨ä¼šç¤¾ç›¤</h4>
            ${companiesHtml}
        </div>

        <button onclick="closeModal(); showTurnStartOptions();"
                style="width: 100%; padding: 12px; background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
                       color: white; border: none; border-radius: 8px; font-weight: bold; font-size: 14px; cursor: pointer;">
            è¡Œå‹•é¸æŠã«æˆ»ã‚‹
        </button>
    `;

    showModal('å…¨ä½“ã‚’è¦‹ã‚‹', content);
}

// initializeCardDeck ã¯ js/game.js ã«ç§»å‹•æ¸ˆã¿

// Draw card from deck
function drawCard() {
    closeModal();

    // ãƒ‡ãƒƒã‚­ãŒãªã„ã€ã¾ãŸã¯ç©ºã®å ´åˆã¯åˆæœŸåŒ–
    if (!gameState.deckInitialized || gameState.cardDeck.length === 0) {
        initializeCardDeck();
    }

    // ãƒ‡ãƒƒã‚­ã‹ã‚‰ã‚«ãƒ¼ãƒ‰ã‚’å¼•ã
    const cardType = gameState.cardDeck.pop();
    console.log(`ã‚«ãƒ¼ãƒ‰ã‚’å¼•ãã¾ã—ãŸ: ${cardType}ï¼ˆæ®‹ã‚Š${gameState.cardDeck.length}æšï¼‰`);

    // è‡¨å ´æ„Ÿã®ã‚ã‚‹ã‚«ãƒ¼ãƒ‰ã‚ãã‚Šæ¼”å‡º
    showCardDrawAnimation(cardType);
}

// ã‚«ãƒ¼ãƒ‰ã‚ãã‚Šã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
function showCardDrawAnimation(cardType) {
    const isRisk = cardType === 'risk';
    const cardColor = isRisk ? '#dc2626' : '#3b82f6';
    const cardLabel = isRisk ? 'ãƒªã‚¹ã‚¯ã‚«ãƒ¼ãƒ‰' : 'æ„æ€æ±ºå®šã‚«ãƒ¼ãƒ‰';
    const cardIcon = isRisk ? 'âš ï¸' : 'ğŸ¯';

    const animationHtml = `
        <div class="card-draw-overlay" id="cardDrawOverlay">
            <div class="draw-deck">
                <div class="deck-stack">
                    <div class="deck-card"></div>
                    <div class="deck-card"></div>
                    <div class="deck-card"></div>
                </div>
                <div class="deck-count">æ®‹ã‚Š ${gameState.cardDeck.length}æš</div>
            </div>
            <div class="drawn-card-container">
                <div class="drawn-card" id="drawnCard">
                    <div class="card-face card-back">
                        <div class="card-pattern">MG</div>
                    </div>
                    <div class="card-face card-front" style="background: linear-gradient(135deg, ${cardColor} 0%, ${cardColor}dd 100%);">
                        <div class="card-icon">${cardIcon}</div>
                        <div class="card-type">${cardLabel}</div>
                    </div>
                </div>
            </div>
        </div>
    `;

    document.getElementById('modalContainer').innerHTML = animationHtml;

    // 0.5ç§’å¾Œã«ã‚«ãƒ¼ãƒ‰ã‚’ã‚ãã‚‹
    setTimeout(() => {
        document.getElementById('drawnCard').classList.add('flipped');
    }, 500);

    // 1.5ç§’å¾Œã«çµæœç”»é¢ã¸
    setTimeout(() => {
        document.getElementById('modalContainer').innerHTML = '';
        if (cardType === 'decision') {
            showDecisionCard();
        } else {
            drawRiskCard();
        }
    }, 1500);
}

// Show decision card (ä¼šç¤¾ç›¤ãŒè¦‹ãˆã‚‹çŠ¶æ…‹ã§è¡¨ç¤º)
function showDecisionCard() {
    const company = gameState.companies[0];
    const mfgCapacity = getManufacturingCapacity(company);
    const salesCapacity = getSalesCapacity(company);
    const priceComp = getPriceCompetitiveness(company, 0);

    // å„ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã®è¨­å®š
    const actionConfig = {
        1: { icon: 'ğŸ’°', label: 'å•†å“è²©å£²', color: '#22c55e', border: '#16a34a', desc: 'è£½å“ã‚’è²©å£²' },
        2: { icon: 'ğŸ“¦', label: 'ææ–™ä»•å…¥', color: '#8b5cf6', border: '#7c3aed', desc: 'ææ–™ã‚’è³¼å…¥' },
        3: { icon: 'ğŸ­', label: 'å®Œæˆãƒ»æŠ•å…¥', color: '#3b82f6', border: '#2563eb', desc: 'è£½é€ ã‚’å®Ÿè¡Œ' },
        4: { icon: 'ğŸ‘¥', label: 'æ¡ç”¨', color: '#f59e0b', border: '#d97706', desc: 'äººå“¡ã‚’æ¡ç”¨' },
        5: { icon: 'âš™ï¸', label: 'è¨­å‚™æŠ•è³‡', color: '#6366f1', border: '#4f46e5', desc: 'æ©Ÿæ¢°ã‚’è³¼å…¥' },
        6: { icon: 'ğŸ¯', label: 'æˆ¦ç•¥ãƒãƒƒãƒ—', color: '#ef4444', border: '#dc2626', desc: 'ãƒãƒƒãƒ—è³¼å…¥' },
        7: { icon: 'â­ï¸', label: 'DO NOTHING', color: '#64748b', border: '#475569', desc: 'ãƒ‘ã‚¹' }
    };

    const cardHtml = gameState.decisionCards.map(card => {
        const cfg = actionConfig[card.id];
        return `
            <div onclick="selectDecisionCard(${card.id})" style="
                background: linear-gradient(135deg, ${cfg.color} 0%, ${cfg.border} 100%);
                border: 3px solid ${cfg.border};
                border-radius: 10px;
                padding: 12px 8px;
                text-align: center;
                cursor: pointer;
                color: white;
                transition: transform 0.2s, box-shadow 0.2s;
                box-shadow: 0 3px 10px rgba(0,0,0,0.2);
            " onmouseover="this.style.transform='scale(1.05)'"
               onmouseout="this.style.transform='scale(1)'">
                <div style="font-size: 24px; margin-bottom: 4px;">${cfg.icon}</div>
                <div style="font-weight: bold; font-size: 12px;">${cfg.label}</div>
                <div style="font-size: 9px; opacity: 0.9;">${cfg.desc}</div>
            </div>
        `;
    }).join('');

    const content = `
        <div style="background: #fef3c7; border-radius: 8px; padding: 8px; margin-bottom: 12px; text-align: center;">
            <div style="font-weight: bold; color: #92400e; font-size: 14px;">ğŸ’° æŒã¡é‡‘: Â¥${company.cash}</div>
        </div>
        <div style="display: flex; justify-content: space-around; margin-bottom: 12px; padding: 8px; background: #f1f5f9; border-radius: 8px;">
            <div style="text-align: center;">
                <div style="font-size: 10px; color: #64748b;">è£½é€ </div>
                <div style="font-size: 16px; font-weight: bold; color: #0284c7;">${mfgCapacity}</div>
            </div>
            <div style="text-align: center;">
                <div style="font-size: 10px; color: #64748b;">è²©å£²</div>
                <div style="font-size: 16px; font-weight: bold; color: #dc2626;">${salesCapacity}</div>
            </div>
            <div style="text-align: center;">
                <div style="font-size: 10px; color: #64748b;">ä¾¡æ ¼ç«¶äº‰åŠ›</div>
                <div style="font-size: 16px; font-weight: bold; color: #16a34a;">+${priceComp}</div>
            </div>
        </div>
        <div style="display: flex; justify-content: center; gap: 6px; margin-bottom: 12px; font-size: 11px;">
            <div style="background: #e0e7ff; padding: 4px 10px; border-radius: 6px;">
                <span style="color: #4338ca;">ææ–™</span> <b>${company.materials}</b>
            </div>
            <div style="background: #fae8ff; padding: 4px 10px; border-radius: 6px;">
                <span style="color: #a21caf;">ä»•æ›å“</span> <b>${company.wip}</b>
            </div>
            <div style="background: #dbeafe; padding: 4px 10px; border-radius: 6px;">
                <span style="color: #1d4ed8;">è£½å“</span> <b>${company.products}</b>
            </div>
        </div>
        <p style="text-align: center; font-size: 12px; color: #666; margin-bottom: 10px;">ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’é¸æŠã—ã¦ãã ã•ã„</p>
        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px;">
            ${cardHtml}
        </div>
    `;

    showModal('æ„æ€æ±ºå®šã‚«ãƒ¼ãƒ‰', content);
}

// Select decision card
function selectDecisionCard(cardId) {
    const card = gameState.decisionCards.find(c => c.id === cardId);
    gameState.companies[0].decisionCard = card;
    
    closeModal();
    
    // Execute decision card action
    switch(cardId) {
        case 1: showSalesModal(); break;
        case 2: showBuyMaterialsModal(); break;
        case 3: showProductionModal(); break;
        case 4: showHireModal(); break;
        case 5: showMachineModal(); break;
        case 6: showChipPurchaseModal(); break;  // ãƒãƒƒãƒ—è³¼å…¥
        case 7: doNothing(); break;
    }
}

// Draw risk card
function drawRiskCard() {
    const availableCards = gameState.riskCards.filter(card => {
        if (gameState.currentPeriod === 2 && card.period2Exempt) return false;
        return !gameState.usedRiskCards.includes(card.id);
    });
    
    if (availableCards.length === 0) {
        showDecisionCard();
        return;
    }
    
    const card = availableCards[Math.floor(Math.random() * availableCards.length)];
    gameState.usedRiskCards.push(card.id);

    // ã‚«ãƒ¼ãƒ‰ã‚¿ã‚¤ãƒ—ã«å¿œã˜ãŸè‰²ã¨ã‚¢ã‚¤ã‚³ãƒ³
    const isPositive = card.type === 'benefit';
    const cardIcon = isPositive ? 'ğŸ‰' : 'âš ï¸';

    const content = `
        <div class="risk-display" style="${isPositive ? 'background: linear-gradient(135deg, #059669 0%, #047857 100%); border-color: #34d399;' : ''}">
            <div class="risk-badge">${cardIcon} ãƒªã‚¹ã‚¯ã‚«ãƒ¼ãƒ‰</div>
            <div class="risk-title">${card.name}</div>
            <div class="risk-description">${card.description}</div>
        </div>
        <button class="submit-btn" onclick="applyRiskCard(${card.id})" style="margin-top: 15px;">
            ${isPositive ? 'âœ“ åŠ¹æœã‚’é©ç”¨' : 'âš¡ é©ç”¨ã™ã‚‹'}
        </button>
    `;

    showModal('ãƒªã‚¹ã‚¯ã‚«ãƒ¼ãƒ‰', content);
}

// Apply risk card
function applyRiskCard(cardId) {
    const company = gameState.companies[0];
    const card = gameState.riskCards.find(c => c.id === cardId);
    let rowUsed = true;

    switch(cardId) {
        case 1: // ã‚¯ãƒ¬ãƒ¼ãƒ ç™ºç”Ÿ
        case 2:
            company.cash = Math.max(0, company.cash - 5);
            if (!company.additionalFixedCost) company.additionalFixedCost = 0;
            company.additionalFixedCost += 5;  // Fã«è¨ˆä¸Š
            showToast('ã‚¯ãƒ¬ãƒ¼ãƒ ç™ºç”Ÿï¼\næœ¬ç¤¾çµŒè²»â–²5ï¼ˆFè¨ˆä¸Šï¼‰', 'warning', 4000);
            break;
        case 3: // æ•™è‚²æˆåŠŸï¼ˆä»•å…¥ã‚Œå¯ï¼‰
        case 4:
            if (company.chips.education > 0) {
                // è²©å£²èƒ½åŠ›ã®ç¯„å›²å†…ã€æœ€é«˜5å€‹ã¾ã§ã€ä»•å…¥ã‚Œå¯
                const result = executeSpecialSaleWithPurchase('education', 'education', 2, true);
                if (result.async) {
                    return; // éåŒæœŸå‡¦ç†ä¸­
                }
                if (!result.success) {
                    alert(`æ•™è‚²æˆåŠŸï¼\nï¼ˆ${result.reason}ã®ãŸã‚åŠ¹æœãªã—ï¼‰`);
                    rowUsed = false;
                }
            } else {
                alert('æ•™è‚²ãƒãƒƒãƒ—ã‚’æŒã£ã¦ã„ãªã„ãŸã‚åŠ¹æœãªã—');
                rowUsed = false;
            }
            break;
        case 5: // æ¶ˆè²»è€…é‹å‹•ç™ºç”Ÿ
        case 6:
            company.cannotSell = true;
            showToast('æ¶ˆè²»è€…é‹å‹•ç™ºç”Ÿï¼\nå•†å“ã®è²©å£²ã¯ã§ãã¾ã›ã‚“\nï¼ˆææ–™è³¼å…¥ã€å®Œæˆãƒ»æŠ•å…¥ã€DO NOTHINGã¯å¯èƒ½ï¼‰', 'danger', 5000);
            showForcedActionModal();  // ã‚¢ã‚¯ã‚·ãƒ§ãƒ³é¸æŠãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
            return;  // ã“ã“ã§ãƒªã‚¿ãƒ¼ãƒ³ï¼ˆãƒ¢ãƒ¼ãƒ€ãƒ«ã§è¡Œå‹•ã‚’é¸æŠå¾Œã«ã‚¿ãƒ¼ãƒ³çµ‚äº†ï¼‰
        case 7: // å¾—æ„å…ˆå€’ç”£
        case 8:
            if (gameState.currentPeriod !== 2) {
                company.cash = Math.max(0, company.cash - 30);
                company.specialLoss = (company.specialLoss || 0) + 30;
                alert('å¾—æ„å…ˆå€’ç”£ï¼\nç¾é‡‘â–²30ï¼ˆç‰¹åˆ¥æå¤±ï¼‰');
            } else {
                alert('å¾—æ„å…ˆå€’ç”£ï¼\n2æœŸç›®ã¯å…é™¤');
                rowUsed = false;
            }
            break;
        case 9: // ç ”ç©¶é–‹ç™ºå¤±æ•—
        case 10:
        case 11:
            if (company.chips.research > 0) {
                company.chips.research--;
                alert('ç ”ç©¶é–‹ç™ºå¤±æ•—ï¼\né’ãƒãƒƒãƒ—1æšè¿”å´');
            } else if (company.nextPeriodChips.research > 0) {
                company.nextPeriodChips.research--;
                alert('ç ”ç©¶é–‹ç™ºå¤±æ•—ï¼\næ¬¡ç¹°ç›¤ã®é’ãƒãƒƒãƒ—1æšè¿”å´');
            } else {
                alert('ç ”ç©¶é–‹ç™ºå¤±æ•—ï¼\nï¼ˆé’ãƒãƒƒãƒ—ãŒãªã„ãŸã‚åŠ¹æœãªã—ï¼‰');
                rowUsed = false;
            }
            break;
        case 12: // åºƒå‘ŠæˆåŠŸï¼ˆä»•å…¥ã‚Œå¯ï¼‰
        case 13:
        case 14:
            if (company.chips.advertising > 0) {
                // èµ¤ãƒãƒƒãƒ—1æšã«ã¤ã2å€‹ã¾ã§ã€æœ€é«˜5å€‹ã¾ã§ã€ä»•å…¥ã‚Œå¯
                const result = executeSpecialSaleWithPurchase('advertising', 'advertising', 2, false);
                if (result.async) {
                    return; // éåŒæœŸå‡¦ç†ä¸­
                }
                if (!result.success) {
                    alert(`åºƒå‘ŠæˆåŠŸï¼\nï¼ˆ${result.reason}ã®ãŸã‚åŠ¹æœãªã—ï¼‰`);
                    rowUsed = false;
                }
            } else {
                alert('åºƒå‘ŠæˆåŠŸï¼\nï¼ˆèµ¤ãƒãƒƒãƒ—ãŒãªã„ãŸã‚åŠ¹æœãªã—ï¼‰');
                rowUsed = false;
            }
            break;
        case 15: // åŠ´ç½ç™ºç”Ÿ
        case 16:
            company.cannotProduce = true;
            showToast('åŠ´ç½ç™ºç”Ÿï¼\nç”Ÿç”£æ´»å‹•ã¯ã§ãã¾ã›ã‚“\nï¼ˆææ–™è³¼å…¥ã€å•†å“è²©å£²ãƒ»å…¥æœ­ã€DO NOTHINGã¯å¯èƒ½ï¼‰', 'danger', 5000);
            showLaborAccidentActionModal();  // è¡Œå‹•é¸æŠãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
            return;  // ã“ã“ã§ãƒªã‚¿ãƒ¼ãƒ³ï¼ˆãƒ¢ãƒ¼ãƒ€ãƒ«ã§è¡Œå‹•ã‚’é¸æŠå¾Œã«ã‚¿ãƒ¼ãƒ³çµ‚äº†ï¼‰
        case 17: // åºƒå‘Šæ”¿ç­–å¤±æ•—
        case 18:
            if (company.chips.advertising > 0) {
                company.chips.advertising--;
                alert('åºƒå‘Šæ”¿ç­–å¤±æ•—ï¼\nèµ¤ãƒãƒƒãƒ—1æšè¿”å´');
            } else if (company.nextPeriodChips.advertising > 0) {
                company.nextPeriodChips.advertising--;
                alert('åºƒå‘Šæ”¿ç­–å¤±æ•—ï¼\næ¬¡ç¹°ç›¤ã®èµ¤ãƒãƒƒãƒ—1æšè¿”å´');
            } else {
                alert('åºƒå‘Šæ”¿ç­–å¤±æ•—ï¼\nï¼ˆèµ¤ãƒãƒƒãƒ—ãŒãªã„ãŸã‚åŠ¹æœãªã—ï¼‰');
                rowUsed = false;
            }
            break;
        case 19: // ç‰¹åˆ¥ã‚µãƒ¼ãƒ“ã‚¹
        case 20:
            showSpecialServiceModal();  // é¸æŠãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
            return;  // ã“ã“ã§ãƒªã‚¿ãƒ¼ãƒ³ï¼ˆãƒ¢ãƒ¼ãƒ€ãƒ«ã§é¸æŠå¾Œã«ã‚¿ãƒ¼ãƒ³çµ‚äº†ï¼‰
        case 21: // è¿”å“ç™ºç”Ÿ
        case 22:
        case 23:
            if (gameState.currentPeriod !== 2) {
                company.products = Math.min(company.products + 1, 999);
                company.totalSales -= 20;
                alert('è¿”å“ç™ºç”Ÿï¼\nå•†å“1å€‹ãŒæˆ»ã‚Šã€å£²ä¸Šâ–²20å††');
            } else {
                alert('è¿”å“ç™ºç”Ÿï¼\n2æœŸç›®ã¯å…é™¤');
                rowUsed = false;
            }
            break;
        case 24: // ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ãƒ¼ãƒˆãƒ©ãƒ–ãƒ«
        case 25:
            company.cash = Math.max(0, company.cash - 10);
            if (!company.additionalFixedCost) company.additionalFixedCost = 0;
            company.additionalFixedCost += 10;  // Fã«è¨ˆä¸Š
            showToast('ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ãƒ¼ãƒˆãƒ©ãƒ–ãƒ«ï¼\nè£½é€ çµŒè²»â–²10ï¼ˆFè¨ˆä¸Šï¼‰', 'warning', 4000);
            break;
        case 26: // å•†å“ã®ç‹¬å è²©å£²ï¼ˆä»•å…¥ã‚Œå¯ï¼‰
        case 27:
        case 28:
            if (company.salesmen > 0) {
                // ã‚»ãƒ¼ãƒ«ã‚¹ãƒãƒ³1äººã«ã¤ã2å€‹ã¾ã§ã€æœ€é«˜5å€‹ã¾ã§ã€ä»•å…¥ã‚Œå¯
                const result = executeSpecialSaleWithPurchase('exclusive', 'salesmen', 2, false);
                if (result.async) {
                    return; // éåŒæœŸå‡¦ç†ä¸­
                }
                if (!result.success) {
                    alert(`å•†å“ã®ç‹¬å è²©å£²ï¼\nï¼ˆ${result.reason}ã®ãŸã‚åŠ¹æœãªã—ï¼‰`);
                    rowUsed = false;
                }
            } else {
                alert('å•†å“ã®ç‹¬å è²©å£²ï¼\nï¼ˆã‚»ãƒ¼ãƒ«ã‚¹ãƒãƒ³ãŒã„ãªã„ãŸã‚åŠ¹æœãªã—ï¼‰');
                rowUsed = false;
            }
            break;
        case 29: // è£½é€ ãƒŸã‚¹ç™ºç”Ÿ
        case 30:
            if (company.wip > 0) {
                company.wip--;
                company.specialLoss = (company.specialLoss || 0) + 14;  // ä»•æ›å“1å€‹=14å††
                alert('è£½é€ ãƒŸã‚¹ç™ºç”Ÿï¼\nä»•æ›å“1å€‹ã‚’ã‚¹ãƒˆãƒƒã‚«ãƒ¼ã¸ï¼ˆç‰¹åˆ¥æå¤±Â¥14ï¼‰');
            } else {
                alert('è£½é€ ãƒŸã‚¹ç™ºç”Ÿï¼\nï¼ˆä»•æ›å“ãŒãªã„ãŸã‚åŠ¹æœãªã—ï¼‰');
                rowUsed = false;
            }
            break;
        case 31: // å€‰åº«ç«ç½
        case 32:
            if (isMaterialProtectedFromFire(company)) {
                alert('å€‰åº«ç«ç½ï¼\nç„¡ç½å®³å€‰åº«ã«ã‚ˆã‚Šå›é¿ã—ã¾ã—ãŸ');
            } else if (company.chips.insurance > 0) {
                const lostMaterials = company.materials;
                const materialValue = lostMaterials * 13;  // ææ–™1å€‹=13å††
                const compensation = lostMaterials * 8;
                const netLoss = materialValue - compensation;
                company.cash += compensation;
                company.materials = 0;
                company.chips.insurance = 0;  // ä¿é™ºä½¿ç”¨å¾Œæ¶ˆå¤±
                company.specialLoss = (company.specialLoss || 0) + netLoss;
                if (company.type === 'player') {
                    showInsuranceRepurchaseModal('å€‰åº«ç«ç½', lostMaterials, compensation, netLoss);
                } else {
                    // AIä¼šç¤¾ã¯è‡ªå‹•ã§å†åŠ å…¥
                    if (company.cash >= 5) {
                        company.cash -= 5;
                        company.chips.insurance = 1;
                    }
                }
            } else {
                const lostMaterials = company.materials;
                const materialValue = lostMaterials * 13;
                company.materials = 0;
                company.specialLoss = (company.specialLoss || 0) + materialValue;
                alert(`å€‰åº«ç«ç½ï¼\nææ–™${lostMaterials}å€‹ã‚’ã‚¹ãƒˆãƒƒã‚«ãƒ¼ã¸ï¼ˆç‰¹åˆ¥æå¤±Â¥${materialValue}ï¼‰`);
            }
            break;
        case 33: // ç¸æ•…æ¡ç”¨
        case 34:
            company.cash = Math.max(0, company.cash - 5);
            company.extraLaborCost = (company.extraLaborCost || 0) + 5;  // äººä»¶è²»
            showHiringChoiceModal();
            rowUsed = false;
            break;
        case 35: // ç ”ç©¶é–‹ç™ºæˆåŠŸ
        case 36:
        case 37:
        case 38:
        case 39:
        case 40:
            if (company.chips.research > 0 && company.products > 0) {
                const salesCapacity = getSalesCapacity(company);
                const sellQty = Math.min(company.chips.research * 2, company.products, salesCapacity, 5);
                const revenue = sellQty * 32;
                company.cash += revenue;
                company.products -= sellQty;
                company.totalSales += revenue;
                // ã‚¹ãƒˆãƒƒã‚«ãƒ¼ï¼ˆæµ·å¤–å¸‚å ´ï¼‰ã«æˆ»ã™
                const overseasMarket = gameState.markets.find(m => m.name === 'æµ·å¤–');
                if (overseasMarket) overseasMarket.currentStock += sellQty;
                alert(`ç ”ç©¶é–‹ç™ºæˆåŠŸï¼\né’ãƒãƒƒãƒ—${company.chips.research}æšã§${sellQty}å€‹ã‚’Â¥32ã§è²©å£²\nå…¥é‡‘é¡: Â¥${revenue}`);
            } else {
                alert('ç ”ç©¶é–‹ç™ºæˆåŠŸï¼\nï¼ˆé’ãƒãƒƒãƒ—ã¾ãŸã¯è£½å“ãŒãªã„ãŸã‚åŠ¹æœãªã—ï¼‰');
                rowUsed = false;
            }
            break;
        case 41: // å„ç¤¾å…±é€š
        case 42:
            executeAllCompaniesCommonPurchase();
            return; // ãƒ¢ãƒ¼ãƒ€ãƒ«ã§é¸æŠå¾Œã«processCommonPurchaseã§å‡¦ç†
        case 43: // ã‚¹ãƒˆãƒ©ã‚¤ã‚­ç™ºç”Ÿï¼ˆè¡Œã‚’æ¶ˆè²»ã—ãªã„ãŒä¼‘ã¿ã§ã¯ãªã„ï¼‰
        case 44:
            showToast('ã‚¹ãƒˆãƒ©ã‚¤ã‚­ç™ºç”Ÿï¼\nä»Šå›ã®è¡Œå‹•ã¯ç„¡åŠ¹', 'danger', 4000);
            rowUsed = false;
            break;
        case 45: // ç›—é›£ç™ºè¦‹
        case 46:
            if (isProductProtectedFromTheft(company)) {
                alert('ç›—é›£ç™ºè¦‹ï¼\nç„¡ç½å®³å€‰åº«ã«ã‚ˆã‚Šå›é¿ã—ã¾ã—ãŸ');
            } else if (company.chips.insurance > 0) {
                const stolen = Math.min(2, company.products);
                const productValue = stolen * 15;  // è£½å“1å€‹=15å††
                const compensation = stolen * 10;
                const netLoss = productValue - compensation;
                company.cash += compensation;
                company.products -= stolen;
                company.chips.insurance = 0;  // ä¿é™ºä½¿ç”¨å¾Œæ¶ˆå¤±
                const overseasMarket = gameState.markets.find(m => m.name === 'æµ·å¤–');
                if (overseasMarket) overseasMarket.currentStock += stolen;
                company.specialLoss = (company.specialLoss || 0) + netLoss;
                if (company.type === 'player') {
                    showInsuranceRepurchaseModal('ç›—é›£ç™ºè¦‹', stolen, compensation, netLoss);
                } else {
                    // AIä¼šç¤¾ã¯è‡ªå‹•ã§å†åŠ å…¥
                    if (company.cash >= 5) {
                        company.cash -= 5;
                        company.chips.insurance = 1;
                    }
                }
            } else {
                const stolen = Math.min(2, company.products);
                const productValue = stolen * 15;
                company.products -= stolen;
                const overseasMarket = gameState.markets.find(m => m.name === 'æµ·å¤–');
                if (overseasMarket) overseasMarket.currentStock += stolen;
                company.specialLoss = (company.specialLoss || 0) + productValue;
                alert(`ç›—é›£ç™ºè¦‹ï¼\nå•†å“${stolen}å€‹ã‚’ã‚¹ãƒˆãƒƒã‚«ãƒ¼ã¸ï¼ˆä¿é™ºæœªåŠ å…¥ï¼‰`);
            }
            break;
        case 47: // é•·æœŸåŠ´å‹™ç´›äº‰
        case 48:
            company.skipTurns = 1;
            showToast('é•·æœŸåŠ´å‹™ç´›äº‰ï¼\næ¬¡ã‚‚1å›ä¼‘ã¿', 'danger', 4000);
            rowUsed = false;
            break;
        case 49: // è¨­è¨ˆãƒˆãƒ©ãƒ–ãƒ«ç™ºç”Ÿ
        case 50:
            company.cash = Math.max(0, company.cash - 10);
            if (!company.additionalFixedCost) company.additionalFixedCost = 0;
            company.additionalFixedCost += 10;  // Fã«è¨ˆä¸Š
            showToast('è¨­è¨ˆãƒˆãƒ©ãƒ–ãƒ«ç™ºç”Ÿï¼\nè£½é€ çµŒè²»â–²10ï¼ˆFè¨ˆä¸Šï¼‰', 'warning', 4000);
            break;
        case 51: // ãƒ¯ãƒ¼ã‚«ãƒ¼é€€è·
        case 52:
            company.cash = Math.max(0, company.cash - 5);
            company.extraLaborCost = (company.extraLaborCost || 0) + 5;  // äººä»¶è²»
            if (company.workers > 0) {
                company.workers--;
                company.retiredWorkers = (company.retiredWorkers || 0) + 1;  // é€€è·è€…è¿½è·¡ï¼ˆ0.5ååˆ†çµ¦æ–™ï¼‰
                alert('ãƒ¯ãƒ¼ã‚«ãƒ¼é€€è·ï¼\näººä»¶è²»â–²5\nãƒ¯ãƒ¼ã‚«ãƒ¼1äººé€€è·ï¼ˆçµ¦æ–™ã¯0.5ååˆ†ï¼‰');
            } else {
                alert('ãƒ¯ãƒ¼ã‚«ãƒ¼é€€è·ï¼\näººä»¶è²»â–²5');
            }
            break;
        case 53: // æ™¯æ°—å¤‰å‹•
        case 54:
            gameState.turnReversed = !gameState.turnReversed;
            alert(`æ™¯æ°—å¤‰å‹•ï¼\nã‚¿ãƒ¼ãƒ³é †ãŒ${gameState.turnReversed ? 'é€†å›ã‚Š' : 'æ­£é †'}ã«ãªã‚Šã¾ã—ãŸ`);
            break;
        case 55: // æ•™è‚²å¤±æ•—
        case 56:
            if (company.chips.education > 0) {
                company.chips.education--;
                alert('æ•™è‚²å¤±æ•—ï¼\né»„ãƒãƒƒãƒ—1æšè¿”å´');
            } else if (company.nextPeriodChips.education > 0) {
                company.nextPeriodChips.education--;
                alert('æ•™è‚²å¤±æ•—ï¼\næ¬¡ç¹°ç›¤ã®é»„ãƒãƒƒãƒ—1æšè¿”å´');
            } else {
                alert('æ•™è‚²å¤±æ•—ï¼\nï¼ˆé»„ãƒãƒƒãƒ—ãŒãªã„ãŸã‚åŠ¹æœãªã—ï¼‰');
                rowUsed = false;
            }
            break;
        case 57: // ã‚»ãƒ¼ãƒ«ã‚¹ãƒãƒ³é€€è·
        case 58:
            company.cash = Math.max(0, company.cash - 5);
            company.extraLaborCost = (company.extraLaborCost || 0) + 5;  // äººä»¶è²»
            if (company.salesmen > 0) {
                company.salesmen--;
                company.retiredSalesmen = (company.retiredSalesmen || 0) + 1;  // é€€è·è€…è¿½è·¡ï¼ˆ0.5ååˆ†çµ¦æ–™ï¼‰
                alert('ã‚»ãƒ¼ãƒ«ã‚¹ãƒãƒ³é€€è·ï¼\näººä»¶è²»â–²5\nã‚»ãƒ¼ãƒ«ã‚¹ãƒãƒ³1äººé€€è·ï¼ˆçµ¦æ–™ã¯0.5ååˆ†ï¼‰');
            } else {
                alert('ã‚»ãƒ¼ãƒ«ã‚¹ãƒãƒ³é€€è·ï¼\näººä»¶è²»â–²5');
            }
            break;
        case 59: // ç¤¾é•·ã€ç—…æ°—ã§å€’ã‚Œã‚‹ï¼ˆè¡Œã‚’æ¶ˆè²»ã—ãªã„ãŒä¼‘ã¿ã§ã¯ãªã„ï¼‰
        case 60:
            showToast('ç¤¾é•·ã€ç—…æ°—ã§å€’ã‚Œã‚‹ï¼\nä»Šå›ã®è¡Œå‹•ã¯ç„¡åŠ¹', 'danger', 4000);
            rowUsed = false;
            break;
        case 61: // ä¸è‰¯åœ¨åº«ç™ºç”Ÿ
        case 62:
            let totalInventory = company.materials + company.wip + company.products;
            if (totalInventory > 20) {
                let excess = totalInventory - 20;
                let lostItems = 0;
                let lostValue = 0;
                // è£½å“ã‹ã‚‰é †ã«å‡¦ç†
                if (company.products > 0 && excess > 0) {
                    const remove = Math.min(company.products, excess);
                    company.products -= remove;
                    lostValue += remove * 15;  // è£½å“1å€‹=15å††
                    lostItems += remove;
                    excess -= remove;
                }
                if (company.wip > 0 && excess > 0) {
                    const remove = Math.min(company.wip, excess);
                    company.wip -= remove;
                    lostValue += remove * 14;  // ä»•æ›å“1å€‹=14å††
                    lostItems += remove;
                    excess -= remove;
                }
                if (company.materials > 0 && excess > 0) {
                    const remove = Math.min(company.materials, excess);
                    company.materials -= remove;
                    lostValue += remove * 13;  // ææ–™1å€‹=13å††
                    lostItems += remove;
                }

                // å¤±ã‚ã‚ŒãŸåœ¨åº«ã‚’æµ·å¤–å¸‚å ´ï¼ˆã‚¹ãƒˆãƒƒã‚«ãƒ¼ï¼‰ã«æˆ»ã™
                const overseasMarket = gameState.markets.find(m => m.name === 'æµ·å¤–');
                if (overseasMarket && lostItems > 0) {
                    overseasMarket.currentStock += lostItems;
                }

                // ä¿é™ºåŠ å…¥ãƒã‚§ãƒƒã‚¯
                if (company.chips.insurance > 0) {
                    const compensation = lostItems * 10;  // 1å€‹10å††ã®ä¿é™ºé‡‘
                    const netLoss = lostValue - compensation;
                    company.cash += compensation;
                    company.chips.insurance = 0;  // ä¿é™ºä½¿ç”¨å¾Œæ¶ˆå¤±
                    company.specialLoss = (company.specialLoss || 0) + netLoss;
                    if (company.type === 'player') {
                        showInsuranceRepurchaseModal('ä¸è‰¯åœ¨åº«ç™ºç”Ÿ', lostItems, compensation, netLoss);
                        return;  // ãƒ¢ãƒ¼ãƒ€ãƒ«ã§å†åŠ å…¥é¸æŠå¾Œã«å‡¦ç†
                    } else {
                        // AIä¼šç¤¾ã¯è‡ªå‹•ã§å†åŠ å…¥
                        if (company.cash >= 5) {
                            company.cash -= 5;
                            company.chips.insurance = 1;
                        }
                        alert(`ä¸è‰¯åœ¨åº«ç™ºç”Ÿï¼\n${lostItems}å€‹ã‚’ã‚¹ãƒˆãƒƒã‚«ãƒ¼ã¸\nä¿é™ºé‡‘: Â¥${compensation}\nç‰¹åˆ¥æå¤±: Â¥${netLoss}`);
                    }
                } else {
                    // ä¿é™ºæœªåŠ å…¥
                    company.specialLoss = (company.specialLoss || 0) + lostValue;
                    alert(`ä¸è‰¯åœ¨åº«ç™ºç”Ÿï¼\n${lostItems}å€‹ã‚’ã‚¹ãƒˆãƒƒã‚«ãƒ¼ã¸\nç‰¹åˆ¥æå¤±: Â¥${lostValue}ï¼ˆä¿é™ºæœªåŠ å…¥ï¼‰`);
                }
            } else {
                alert('ä¸è‰¯åœ¨åº«ç™ºç”Ÿï¼\nï¼ˆç·åœ¨åº«ãŒ20å€‹ä»¥ä¸‹ã®ãŸã‚åŠ¹æœãªã—ï¼‰');
                rowUsed = false;
            }
            break;
        case 63: // æ©Ÿæ¢°æ•…éšœ
        case 64:
            company.cash = Math.max(0, company.cash - 5);
            if (!company.additionalFixedCost) company.additionalFixedCost = 0;
            company.additionalFixedCost += 5;
            alert('æ©Ÿæ¢°æ•…éšœï¼\nè£½é€ çµŒè²»â–²5');
            break;
    }

    closeModal();

    if (rowUsed) {
        endTurn();
    } else {
        // è¡Œã‚’æ¶ˆè²»ã—ãªã„ãƒªã‚¹ã‚¯ã‚«ãƒ¼ãƒ‰ã®å ´åˆã€ãã®ã¾ã¾æ¬¡ã®äººã¸ï¼ˆä½•ã‚‚ã§ããªã„ï¼‰
        updateDisplay();
        nextTurn();
    }
}

// ============================================
// ãƒªã‚¹ã‚¯ã‚«ãƒ¼ãƒ‰ç‰¹æ®ŠåŠ¹æœã¯ js/risk-effects.js ã«ç§»å‹•ã—ã¾ã—ãŸ
// ============================================

// Render markets
function renderMarkets() {
    const container = document.getElementById('marketsContainer');
    let html = '';
    
    gameState.markets.forEach(market => {
        html += `
            <div class="market-card">
                <div class="market-header">
                    <span class="market-name">${market.name}</span>
                    <div class="market-prices">
                        <span class="price-tag buy">è²·Â¥${market.buyPrice}</span>
                        <span class="price-tag sell">å£²Â¥${market.sellPrice}</span>
                    </div>
                </div>
                <div class="market-stock-info">
                    <div class="market-stock">
                        ${Array(Math.min(market.currentStock, 20)).fill('<div class="stock-block"></div>').join('')}
                        ${market.currentStock > 20 ? '...' : ''}
                    </div>
                    <span class="stock-count">${market.currentStock}/${market.maxStock}</span>
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

// Render companies
function renderCompanies() {
    const container = document.getElementById('companiesContainer');
    let html = '';
    
    gameState.companies.forEach((company, index) => {
        const isCurrentTurn = index === gameState.currentPlayerIndex;
        const isPlayer = company.type === 'player';
        const mfgCapacity = getManufacturingCapacity(company);
        const salesCapacity = getSalesCapacity(company);
        
        // Machine display
        let machineDisplay = '';
        company.machines.forEach((machine) => {
            const machineName = machine.type === 'small' ? 
                (machine.attachments > 0 ? 'å°å‹+A' : 'å°å‹') : 'å¤§å‹';
            machineDisplay += `<span class="machine-item">${machineName}</span>`;
        });
        
        // Warehouse display
        let warehouseDisplay = '';
        if (company.warehouses > 0) {
            let locationText = '';
            if (company.warehouses === 2 || company.warehouseLocation === 'both') {
                locationText = 'æ+è£½';
            } else if (company.warehouseLocation === 'materials') {
                locationText = 'æ';
            } else {
                locationText = 'è£½';
            }
            warehouseDisplay = `<span class="warehouse-item">å€‰åº«(${locationText})</span>`;
        }
        
        html += `
            <div class="company-card ${isPlayer ? 'player' : ''} ${isCurrentTurn ? 'current-turn' : ''}">
                <div class="company-header">
                    <span class="company-name">${company.name}</span>
                    <span class="company-cash">Â¥${company.cash}</span>
                    <span style="font-size: 12px; background: ${(company.currentRow || 1) >= gameState.maxRows - 5 ? '#ef4444' : '#3b82f6'}; color: white; padding: 2px 6px; border-radius: 4px; font-weight: bold;">
                        è¡Œ:${company.currentRow || 1}/${gameState.maxRows}
                    </span>
                </div>
                <div class="company-stats">
                    <div class="stat-item">è‡ªå·±è³‡æœ¬: Â¥${company.equity}</div>
                    <div class="stat-item">å€Ÿå…¥: Â¥${company.loans + company.shortLoans}</div>
                    <div class="stat-item capacity" onclick="showManufacturingCapacityDetail(${index})" style="cursor: pointer;">è£½é€ èƒ½åŠ›: ${mfgCapacity}</div>
                    <div class="stat-item capacity" onclick="showSalesCapacityDetail(${index})" style="cursor: pointer;">è²©å£²èƒ½åŠ›: ${salesCapacity}</div>
                </div>
                <div class="machine-section">
                    ${machineDisplay || '<span class="machine-item">æ©Ÿæ¢°ãªã—</span>'}
                </div>
                ${warehouseDisplay ? `<div class="warehouse-section">${warehouseDisplay}</div>` : ''}
                <div class="personnel-section">
                    <div class="personnel-group">
                        <span class="personnel-label">ãƒ¯ãƒ¼ã‚«ãƒ¼:</span>
                        <div class="personnel-dots">
                            ${Array(company.workers).fill('<div class="personnel-dot"></div>').join('')}
                        </div>
                        <span>(${company.workers})</span>
                    </div>
                    <div class="personnel-group">
                        <span class="personnel-label">ã‚»ãƒ¼ãƒ«ã‚¹:</span>
                        <div class="personnel-dots">
                            ${Array(company.salesmen).fill('<div class="personnel-dot"></div>').join('')}
                        </div>
                        <span>(${company.salesmen})</span>
                    </div>
                </div>
                <div class="inventory-section">
                    <div class="inventory-box">
                        <div class="inventory-label">ææ–™</div>
                        <div class="inventory-blocks">
                            ${Array(Math.min(company.materials, 10)).fill('<div class="inventory-block material"></div>').join('')}
                            ${company.materials > 10 ? `<small>+${company.materials - 10}</small>` : ''}
                        </div>
                    </div>
                    <div class="inventory-box">
                        <div class="inventory-label">ä»•æ›å“</div>
                        <div class="inventory-blocks">
                            ${Array(Math.min(company.wip, 10)).fill('<div class="inventory-block wip"></div>').join('')}
                            ${company.wip > 10 ? `<small>+${company.wip - 10}</small>` : ''}
                        </div>
                    </div>
                    <div class="inventory-box">
                        <div class="inventory-label">è£½å“</div>
                        <div class="inventory-blocks">
                            ${Array(Math.min(company.products, 10)).fill('<div class="inventory-block product"></div>').join('')}
                            ${company.products > 10 ? `<small>+${company.products - 10}</small>` : ''}
                        </div>
                    </div>
                </div>
                <div class="chips-section">
                    <div class="chip-row">
                        <span class="chip-label">PC:</span>
                        <div class="chip-dots">
                            ${Array(3).fill(0).map((_, i) =>
                                `<div class="chip-dot ${i < company.chips.computer ? 'filled computer' : ''}"></div>`
                            ).join('')}
                        </div>
                        <span class="chip-count">${company.chips.computer}</span>
                    </div>
                    <div class="chip-row">
                        <span class="chip-label">ä¿é™º:</span>
                        <div class="chip-dots">
                            ${Array(3).fill(0).map((_, i) =>
                                `<div class="chip-dot ${i < company.chips.insurance ? 'filled insurance' : ''}"></div>`
                            ).join('')}
                        </div>
                        <span class="chip-count">${company.chips.insurance}</span>
                    </div>
                    <div class="chip-row">
                        <span class="chip-label">ç ”ç©¶:</span>
                        <div class="chip-dots">
                            ${Array(5).fill(0).map((_, i) =>
                                `<div class="chip-dot ${i < (company.chips.research + (company.nextPeriodChips?.research || 0)) ? 'filled research' : ''}"></div>`
                            ).join('')}
                        </div>
                        <span class="chip-count">${company.chips.research + (company.nextPeriodChips?.research || 0)}</span>
                    </div>
                    <div class="chip-row">
                        <span class="chip-label">æ•™è‚²:</span>
                        <div class="chip-dots">
                            ${Array(gameState.currentPeriod === 2 ? 2 : 1).fill(0).map((_, i) =>
                                `<div class="chip-dot ${i < (company.chips.education + (company.nextPeriodChips?.education || 0)) ? 'filled education' : ''}"></div>`
                            ).join('')}
                        </div>
                        <span class="chip-count">${company.chips.education + (company.nextPeriodChips?.education || 0)}</span>
                    </div>
                    <div class="chip-row">
                        <span class="chip-label">åºƒå‘Š:</span>
                        <div class="chip-dots">
                            ${Array(5).fill(0).map((_, i) =>
                                `<div class="chip-dot ${i < (company.chips.advertising + (company.nextPeriodChips?.advertising || 0)) ? 'filled advertising' : ''}"></div>`
                            ).join('')}
                        </div>
                        <span class="chip-count">${company.chips.advertising + (company.nextPeriodChips?.advertising || 0)}</span>
                    </div>
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

// Render action buttons
function renderActionButtons() {
    const container = document.getElementById('actionButtons');
    const isPlayerTurn = gameState.currentPlayerIndex === 0;
    
    let html = '';
    
    if (!gameState.periodStarted) {
        html = `<button class="action-btn warning" onclick="startPeriod()">ç¬¬${gameState.currentPeriod}æœŸã‚’é–‹å§‹</button>`;
    } else if (isPlayerTurn) {
        html = `
            <button class="action-btn main mobile-card-btn" onclick="showTurnStartOptions()">ã‚«ãƒ¼ãƒ‰ã‚’å¼•ã</button>
        `;
    } else {
        html = `
            <button class="action-btn secondary" disabled>AIã®ã‚¿ãƒ¼ãƒ³ä¸­...</button>
        `;
    }
    
    container.innerHTML = html;
}

// UIé–¢æ•°ã¯js/ui.jsã«ç§»è¡Œæ¸ˆã¿
// renderCompanyBoard, renderMarketsBoard, renderFixedCostBreakdown,
// renderOtherCompanies, showAICompanyModal, showToast, showModal, closeModal

// ä¿é™ºå†åŠ å…¥ãƒ¢ãƒ¼ãƒ€ãƒ«
function showInsuranceRepurchaseModal(disasterType, lostItems, compensation, netLoss) {
    const company = gameState.companies[0];
    const canAfford = company.cash >= 5;

    const itemLabel = disasterType === 'å€‰åº«ç«ç½' ? 'ææ–™' : 'å•†å“';
    const content = `
        <div style="padding: 15px; text-align: center;">
            <div style="background: linear-gradient(135deg, #dc2626 0%, #ef4444 100%); border-radius: 12px; padding: 20px; margin-bottom: 15px; color: white;">
                <div style="font-size: 24px; margin-bottom: 10px;">âš ï¸ ${disasterType}ç™ºç”Ÿï¼</div>
                <div style="font-size: 14px;">
                    <div>${itemLabel} ${lostItems}å€‹ã‚’ã‚¹ãƒˆãƒƒã‚«ãƒ¼ã¸</div>
                    <div>ä¿é™ºé‡‘ Â¥${compensation} ã‚’å—ã‘å–ã‚Šã¾ã—ãŸ</div>
                    <div>ç‰¹åˆ¥æå¤± Â¥${netLoss}</div>
                </div>
            </div>

            <div style="background: #fef3c7; border-radius: 8px; padding: 15px; margin-bottom: 15px;">
                <div style="font-weight: bold; color: #92400e; margin-bottom: 10px;">
                    ä¿é™ºãƒãƒƒãƒ—ã‚’æ¶ˆè²»ã—ã¾ã—ãŸ
                </div>
                <div style="font-size: 14px; color: #78350f;">
                    å†åŠ å…¥: Â¥5ï¼ˆç¾åœ¨ã®ç¾é‡‘: Â¥${company.cash}ï¼‰
                </div>
            </div>

            <div style="display: flex; gap: 10px; justify-content: center;">
                ${canAfford ? `
                    <button class="action-btn primary" onclick="repurchaseInsurance()" style="flex: 1;">
                        å†åŠ å…¥ã™ã‚‹ï¼ˆÂ¥5ï¼‰
                    </button>
                ` : ''}
                <button class="action-btn secondary" onclick="closeModal(); updateDisplay();" style="flex: 1;">
                    ${canAfford ? 'å†åŠ å…¥ã—ãªã„' : 'é–‰ã˜ã‚‹'}
                </button>
            </div>
        </div>
    `;

    showModal('ä¿é™ºä½¿ç”¨', content);
}

// ä¿é™ºå†åŠ å…¥å‡¦ç†
function repurchaseInsurance() {
    const company = gameState.companies[0];
    if (company.cash >= 5) {
        company.cash -= 5;
        company.chips.insurance = 1;
        alert('ä¿é™ºã«å†åŠ å…¥ã—ã¾ã—ãŸï¼ˆÂ¥5ï¼‰');
    } else {
        alert('è³‡é‡‘ãŒä¸è¶³ã—ã¦ã„ã¾ã™');
    }
    closeModal();
    updateDisplay();
}

// å›ºå®šè²»å†…è¨³ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
function showFixedCostModal() {
    const company = gameState.companies[0];
    const period = gameState.currentPeriod;
    const baseCost = {2: 22, 3: 24, 4: 26, 5: 28};
    let unitCost = baseCost[period] || 22;

    if (period >= 3 && gameState.wageMultiplier > 1) {
        unitCost = Math.round(baseCost[period] * gameState.wageMultiplier);
    }

    const halfCost = Math.round(unitCost / 2);
    const machineCount = company.machines.length;
    const effectiveWorkers = company.workers + (company.retiredWorkers || 0) * 0.5;
    const effectiveSalesmen = company.salesmen + (company.retiredSalesmen || 0) * 0.5;
    const maxPersonnel = company.maxPersonnel || (company.workers + company.salesmen);

    const machineCost = machineCount * unitCost;
    const workerCost = Math.round(effectiveWorkers * unitCost);
    const salesmenCost = Math.round(effectiveSalesmen * unitCost);
    const maxPersonnelCost = maxPersonnel * halfCost;
    const salaryCost = machineCost + workerCost + salesmenCost + maxPersonnelCost;

    // æ¸›ä¾¡å„Ÿå´ï¼ˆå®šæ•°ã‚’ä½¿ç”¨ï¼‰
    let depreciationCost = 0;
    company.machines.forEach(m => {
        if (period === 2) {
            if (m.type === 'large') {
                depreciationCost += DEPRECIATION.large.period2;
            } else {
                depreciationCost += m.attachments > 0 ? DEPRECIATION.smallWithAttachment.period2 : DEPRECIATION.small.period2;
            }
        } else {
            if (m.type === 'large') depreciationCost += DEPRECIATION.large.period3plus;
            else depreciationCost += m.attachments > 0 ? DEPRECIATION.smallWithAttachment.period3plus : DEPRECIATION.small.period3plus;
        }
    });

    // æˆ¦ç•¥ãƒãƒƒãƒ—è²»ç”¨
    const carriedOver = company.carriedOverChips || {research: 0, education: 0, advertising: 0};
    let chipCost = 0;
    let chipDetails = [];

    if (period === 2) {
        const researchCost = (company.chips.research || 0) * CHIP_COSTS.normal;
        const educationCost = (company.chips.education || 0) * CHIP_COSTS.normal;
        const advertisingCost = (company.chips.advertising || 0) * CHIP_COSTS.normal;
        chipCost = researchCost + educationCost + advertisingCost;
        if (researchCost > 0) chipDetails.push(`ç ”ç©¶ ${company.chips.research}æšÃ—Â¥${CHIP_COSTS.normal} = Â¥${researchCost}`);
        if (educationCost > 0) chipDetails.push(`æ•™è‚² ${company.chips.education}æšÃ—Â¥${CHIP_COSTS.normal} = Â¥${educationCost}`);
        if (advertisingCost > 0) chipDetails.push(`åºƒå‘Š ${company.chips.advertising}æšÃ—Â¥${CHIP_COSTS.normal} = Â¥${advertisingCost}`);
    } else {
        // ç¹°ã‚Šè¶Šã—åˆ†ï¼ˆé€šå¸¸ä¾¡æ ¼ï¼‰
        const carryResearch = (carriedOver.research || 0) * CHIP_COSTS.normal;
        const carryEducation = (carriedOver.education || 0) * CHIP_COSTS.normal;
        const carryAdvertising = (carriedOver.advertising || 0) * CHIP_COSTS.normal;
        // ç‰¹æ€¥åˆ†ï¼ˆç‰¹æ€¥ä¾¡æ ¼ï¼‰
        const urgentResearch = Math.max(0, (company.chips.research || 0) - (carriedOver.research || 0)) * CHIP_COSTS.express;
        const urgentEducation = Math.max(0, (company.chips.education || 0) - (carriedOver.education || 0)) * CHIP_COSTS.express;
        const urgentAdvertising = Math.max(0, (company.chips.advertising || 0) - (carriedOver.advertising || 0)) * CHIP_COSTS.express;
        // æ¬¡æœŸç¹°ã‚Šè¶Šã—åˆ†ï¼ˆé€šå¸¸ä¾¡æ ¼ï¼‰
        const nextResearch = (company.nextPeriodChips?.research || 0) * CHIP_COSTS.normal;
        const nextEducation = (company.nextPeriodChips?.education || 0) * CHIP_COSTS.normal;
        const nextAdvertising = (company.nextPeriodChips?.advertising || 0) * CHIP_COSTS.normal;

        chipCost = carryResearch + carryEducation + carryAdvertising +
                   urgentResearch + urgentEducation + urgentAdvertising +
                   nextResearch + nextEducation + nextAdvertising;

        if (carriedOver.research > 0) chipDetails.push(`ç ”ç©¶(ç¹°è¶Š) ${carriedOver.research}æšÃ—Â¥${CHIP_COSTS.normal} = Â¥${carryResearch}`);
        if (urgentResearch > 0) chipDetails.push(`ç ”ç©¶(ç‰¹æ€¥) ${(company.chips.research - carriedOver.research)}æšÃ—Â¥${CHIP_COSTS.express} = Â¥${urgentResearch}`);
        if (carriedOver.education > 0) chipDetails.push(`æ•™è‚²(ç¹°è¶Š) ${carriedOver.education}æšÃ—Â¥${CHIP_COSTS.normal} = Â¥${carryEducation}`);
        if (urgentEducation > 0) chipDetails.push(`æ•™è‚²(ç‰¹æ€¥) ${(company.chips.education - carriedOver.education)}æšÃ—Â¥${CHIP_COSTS.express} = Â¥${urgentEducation}`);
        if (carriedOver.advertising > 0) chipDetails.push(`åºƒå‘Š(ç¹°è¶Š) ${carriedOver.advertising}æšÃ—Â¥${CHIP_COSTS.normal} = Â¥${carryAdvertising}`);
        if (urgentAdvertising > 0) chipDetails.push(`åºƒå‘Š(ç‰¹æ€¥) ${(company.chips.advertising - carriedOver.advertising)}æšÃ—Â¥${CHIP_COSTS.express} = Â¥${urgentAdvertising}`);
        if (nextResearch > 0) chipDetails.push(`ç ”ç©¶(æ¬¡æœŸ) ${company.nextPeriodChips.research}æšÃ—Â¥${CHIP_COSTS.normal} = Â¥${nextResearch}`);
        if (nextEducation > 0) chipDetails.push(`æ•™è‚²(æ¬¡æœŸ) ${company.nextPeriodChips.education}æšÃ—Â¥${CHIP_COSTS.normal} = Â¥${nextEducation}`);
        if (nextAdvertising > 0) chipDetails.push(`åºƒå‘Š(æ¬¡æœŸ) ${company.nextPeriodChips.advertising}æšÃ—Â¥${CHIP_COSTS.normal} = Â¥${nextAdvertising}`);
    }

    // ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ãƒ»ä¿é™º
    const computerCost = (company.chips.computer || 0) * CHIP_COSTS.computer;
    const insuranceCost = (company.chips.insurance || 0) * CHIP_COSTS.insurance;

    // é‡‘åˆ©
    const longInterest = Math.round((company.loans || 0) * INTEREST_RATES.longTerm);
    const shortInterest = Math.round((company.shortLoans || 0) * INTEREST_RATES.shortTerm);

    // ãã®ä»–äººä»¶è²»ï¼ˆæ¡ç”¨è²»ã€é€€è·è²»ã€ãƒªã‚¹ã‚¯ã‚«ãƒ¼ãƒ‰ãªã©ï¼‰
    const extraLabor = company.extraLaborCost || 0;

    // åˆè¨ˆ
    const totalFixed = salaryCost + depreciationCost + chipCost + computerCost + insuranceCost +
                       longInterest + shortInterest + extraLabor;

    const content = `
        <div class="breakdown-list" style="max-height: 400px; overflow-y: auto;">
            <div style="font-weight: bold; color: #1e40af; margin-bottom: 12px; font-size: 14px;">çµ¦æ–™ï¼ˆå˜ä¾¡: Â¥${unitCost}ï¼‰</div>
            <div class="breakdown-item">
                <span class="breakdown-item-label">æ©Ÿæ¢° ${machineCount}å° Ã— Â¥${unitCost}</span>
                <span class="breakdown-item-value">Â¥${machineCost}</span>
            </div>
            <div class="breakdown-item">
                <span class="breakdown-item-label">ãƒ¯ãƒ¼ã‚«ãƒ¼ ${effectiveWorkers}äºº Ã— Â¥${unitCost}</span>
                <span class="breakdown-item-value">Â¥${workerCost}</span>
            </div>
            <div class="breakdown-item">
                <span class="breakdown-item-label">ã‚»ãƒ¼ãƒ«ã‚¹ ${effectiveSalesmen}äºº Ã— Â¥${unitCost}</span>
                <span class="breakdown-item-value">Â¥${salesmenCost}</span>
            </div>
            <div class="breakdown-item">
                <span class="breakdown-item-label">æœŸä¸­æœ€å¤§ ${maxPersonnel}äºº Ã— Â¥${halfCost}</span>
                <span class="breakdown-item-value">Â¥${maxPersonnelCost}</span>
            </div>
            <div style="font-weight: bold; color: #1e40af; margin: 12px 0; font-size: 14px;">æ¸›ä¾¡å„Ÿå´ãƒ»ãã®ä»–</div>
            <div class="breakdown-item">
                <span class="breakdown-item-label">æ¸›ä¾¡å„Ÿå´</span>
                <span class="breakdown-item-value">Â¥${depreciationCost}</span>
            </div>
            ${chipCost > 0 ? `
            <div style="font-weight: bold; color: #059669; margin: 12px 0; font-size: 12px;">æˆ¦ç•¥ãƒãƒƒãƒ—</div>
            ${chipDetails.map(d => `<div class="breakdown-item" style="font-size: 11px;"><span>${d}</span></div>`).join('')}
            <div class="breakdown-item">
                <span class="breakdown-item-label">ãƒãƒƒãƒ—åˆè¨ˆ</span>
                <span class="breakdown-item-value">Â¥${chipCost}</span>
            </div>
            ` : ''}
            ${computerCost > 0 ? `
            <div class="breakdown-item">
                <span class="breakdown-item-label">ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ ${company.chips.computer}æšÃ—Â¥20</span>
                <span class="breakdown-item-value">Â¥${computerCost}</span>
            </div>
            ` : ''}
            ${insuranceCost > 0 ? `
            <div class="breakdown-item">
                <span class="breakdown-item-label">ä¿é™º ${company.chips.insurance}æšÃ—Â¥5</span>
                <span class="breakdown-item-value">Â¥${insuranceCost}</span>
            </div>
            ` : ''}
            ${longInterest > 0 ? `
            <div class="breakdown-item">
                <span class="breakdown-item-label">é•·æœŸå€Ÿå…¥é‡‘åˆ© Â¥${company.loans}Ã—10%</span>
                <span class="breakdown-item-value">Â¥${longInterest}</span>
            </div>
            ` : ''}
            ${shortInterest > 0 ? `
            <div class="breakdown-item">
                <span class="breakdown-item-label">çŸ­æœŸå€Ÿå…¥é‡‘åˆ© Â¥${company.shortLoans}Ã—20%</span>
                <span class="breakdown-item-value">Â¥${shortInterest}</span>
            </div>
            ` : ''}
            ${extraLabor > 0 ? `
            <div class="breakdown-item">
                <span class="breakdown-item-label">ãã®ä»–ï¼ˆæ¡ç”¨è²»ãƒ»ãƒªã‚¹ã‚¯ç­‰ï¼‰</span>
                <span class="breakdown-item-value">Â¥${extraLabor}</span>
            </div>
            ` : ''}
            <div class="breakdown-total">
                <span>Fåˆè¨ˆ</span>
                <span>Â¥${totalFixed}</span>
            </div>
        </div>
    `;

    showModal('Fï¼ˆå›ºå®šè²»ï¼‰å†…è¨³', content);
}

// closeModalã¯js/ui.jsã«ç§»è¡Œæ¸ˆã¿

// Buy materials modal - è³¼å…¥ãƒ¢ãƒ¼ãƒ‰ã«å…¥ã‚‹
function showBuyMaterialsModal() {
    enterBuyMode();
}

// Update material purchase cost (for multiple markets - not used now)
function updateMaterialCost() {
    let totalCost = 0;
    let rowsUsed = 0;

    gameState.markets.forEach((market, marketIndex) => {
        const selectElement = document.getElementById(`market_${marketIndex}`);
        if (!selectElement) return;
        const qty = parseInt(selectElement.value || 0);
        if (qty > 0) {
            totalCost += market.buyPrice * qty;
            rowsUsed++;
        }
    });

    const totalCostEl = document.getElementById('totalCost');
    const rowsUsedEl = document.getElementById('rowsUsed');
    if (totalCostEl) totalCostEl.textContent = `Â¥${totalCost}`;
    if (rowsUsedEl) rowsUsedEl.textContent = rowsUsed;
}

// Buy materials from multiple markets
function buyMaterialsFromMultiple() {
    const company = gameState.companies[0];
    let totalCost = 0;
    let totalQty = 0;
    let rowsUsed = 0;
    let purchases = [];

    // å„å¸‚å ´ã‹ã‚‰ã®è³¼å…¥ã‚’åé›†ï¼ˆå®Ÿéš›ã®å¸‚å ´ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’ä½¿ç”¨ï¼‰
    gameState.markets.forEach((market, marketIndex) => {
        const selectElement = document.getElementById(`market_${marketIndex}`);
        if (!selectElement) return; // é–‰é–å¸‚å ´ãªã©ã§è¦ç´ ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—
        const qty = parseInt(selectElement.value || 0);
        if (qty > 0) {
            totalCost += market.buyPrice * qty;
            totalQty += qty;
            rowsUsed++;
            purchases.push({market: market, marketIndex: marketIndex, qty: qty, cost: market.buyPrice * qty});
        }
    });
    
    if (rowsUsed === 0) {
        showToast('è³¼å…¥ã™ã‚‹å¸‚å ´ã‚’é¸æŠã—ã¦ãã ã•ã„', 'warning', 3000);
        return;
    }
    
    // å€‰åº«å®¹é‡ãƒã‚§ãƒƒã‚¯
    const newMaterialCount = company.materials + totalQty;
    const maxMaterialCapacity = getMaterialCapacity(company);
    if (newMaterialCount > maxMaterialCapacity) {
        if (company.warehouses === 0) {
            alert(`ææ–™ç½®å ´ã«10å€‹ä»¥ä¸Šç½®ãã«ã¯ç„¡ç½å®³å€‰åº«ãŒå¿…è¦ã§ã™ã€‚\nç¾åœ¨: ${company.materials}å€‹ã€è³¼å…¥å¾Œ: ${newMaterialCount}å€‹`);
        } else {
            alert(`ææ–™ç½®å ´ã®å®¹é‡ï¼ˆ${maxMaterialCapacity}å€‹ï¼‰ã‚’è¶…ãˆã¾ã™ã€‚\nç¾åœ¨: ${company.materials}å€‹ã€è³¼å…¥å¾Œ: ${newMaterialCount}å€‹`);
        }
        return;
    }
    
    // è¡Œæ•°ãƒã‚§ãƒƒã‚¯ï¼ˆãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ä¼šç¤¾ã®è¡Œæ•°ã‚’ä½¿ç”¨ï¼‰
    const playerRow = company.currentRow || 1;
    if (playerRow + rowsUsed - 1 > gameState.maxRows) {
        alert(`è¡Œæ•°ãŒä¸è¶³ã—ã¦ã„ã¾ã™ï¼ˆå¿…è¦: ${rowsUsed}è¡Œã€æ®‹ã‚Š: ${gameState.maxRows - playerRow + 1}è¡Œï¼‰`);
        return;
    }

    // ç¾é‡‘ãƒã‚§ãƒƒã‚¯ï¼ˆçŸ­æœŸå€Ÿå…¥ã§è³¼å…¥ã¯ä¸å¯ï¼‰
    if (company.cash < totalCost) {
        showToast(`ç¾é‡‘ä¸è¶³ã®ãŸã‚è³¼å…¥ã§ãã¾ã›ã‚“ï¼ˆå¿…è¦: Â¥${totalCost}ã€æ‰€æŒ: Â¥${company.cash}ï¼‰`, 'error', 4000);
        return;
    }

    // è³¼å…¥å®Ÿè¡Œ
    company.cash -= totalCost;
    company.materials += totalQty;
    company.totalMaterialCost += totalCost;

    // å„å¸‚å ´ã®åœ¨åº«ã‚’æ¸›ã‚‰ã™
    purchases.forEach(p => {
        gameState.markets[p.marketIndex].currentStock -= p.qty;
        console.log(`${p.market.name}ã‹ã‚‰${p.qty}å€‹è³¼å…¥: æ®‹ã‚Šåœ¨åº«${gameState.markets[p.marketIndex].currentStock}`);
    });

    // è¡Œå‹•ãƒ­ã‚°è¨˜éŒ²ï¼ˆè¤‡æ•°å¸‚å ´ã‹ã‚‰ã®è³¼å…¥ï¼‰
    const purchaseDetails = purchases.map(p => `${p.market.name}Â¥${p.market.buyPrice}Ã—${p.qty}`).join(', ');
    logAction(0, 'ææ–™è³¼å…¥', purchaseDetails, -totalCost, true);

    // ä½¿ç”¨è¡Œæ•°åˆ†é€²ã‚ã‚‹ï¼ˆãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®å®Ÿéš›ã®è¡Œæ•°ã‚’æ›´æ–°ï¼‰
    // rowsUsed - 1 ã‚’å…ˆã«è¿½åŠ ï¼ˆendTurnã§+1ã•ã‚Œã‚‹ãŸã‚ï¼‰
    company.currentRow = (company.currentRow || 1) + (rowsUsed - 1);
    gameState.currentRow += rowsUsed - 1; // è¡¨ç¤ºç”¨ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚«ã‚¦ãƒ³ã‚¿ã‚‚æ›´æ–°

    closeModal();
    updateDisplay();

    // è³¼å…¥çµæœã‚’è¡¨ç¤º
    let message = `ææ–™${totalQty}å€‹ã‚’Â¥${totalCost}ã§è³¼å…¥ã—ã¾ã—ãŸ\n`;
    purchases.forEach(p => {
        message += `${p.market.name}: ${p.qty}å€‹ (Â¥${p.cost})\n`;
    });
    message += `${rowsUsed}è¡Œä½¿ç”¨ã—ã¾ã—ãŸ`;
    alert(message);

    endTurn();
}

// Buy materials (single market - legacy support)
function buyMaterials() {
    const company = gameState.companies[0];
    const marketIndex = parseInt(document.getElementById('marketSelect')?.value || 0);
    const quantity = parseInt(document.getElementById('quantity')?.value || 0);
    const market = gameState.markets[marketIndex];
    if (!market || quantity <= 0) {
        showToast('å¸‚å ´ã¾ãŸã¯æ•°é‡ãŒç„¡åŠ¹ã§ã™', 'warning', 3000);
        return;
    }
    
    // Check warehouse capacity
    const newMaterialCount = company.materials + quantity;
    const maxMaterialCapacity = getMaterialCapacity(company);
    if (newMaterialCount > maxMaterialCapacity) {
        if (company.warehouses === 0) {
            alert(`ææ–™ç½®å ´ã«10å€‹ä»¥ä¸Šç½®ãã«ã¯ç„¡ç½å®³å€‰åº«ãŒå¿…è¦ã§ã™ã€‚\nç¾åœ¨: ${company.materials}å€‹ã€è³¼å…¥å¾Œ: ${newMaterialCount}å€‹`);
        } else {
            alert(`ææ–™ç½®å ´ã®å®¹é‡ï¼ˆ${maxMaterialCapacity}å€‹ï¼‰ã‚’è¶…ãˆã¾ã™ã€‚\nç¾åœ¨: ${company.materials}å€‹ã€è³¼å…¥å¾Œ: ${newMaterialCount}å€‹`);
        }
        return;
    }
    
    const cost = market.buyPrice * quantity;

    // ç¾é‡‘ãƒã‚§ãƒƒã‚¯ï¼ˆçŸ­æœŸå€Ÿå…¥ã§è³¼å…¥ã¯ä¸å¯ï¼‰
    if (company.cash < cost) {
        showToast(`ç¾é‡‘ä¸è¶³ã®ãŸã‚è³¼å…¥ã§ãã¾ã›ã‚“ï¼ˆå¿…è¦: Â¥${cost}ã€æ‰€æŒ: Â¥${company.cash}ï¼‰`, 'error', 4000);
        return;
    }

    if (quantity > market.currentStock) {
        showToast('åœ¨åº«ãŒä¸è¶³ã—ã¦ã„ã¾ã™ï¼', 'danger', 3000);
        return;
    }
    
    company.cash -= cost;
    company.materials += quantity;
    company.totalMaterialCost += cost;
    market.currentStock -= quantity;

    // è¡Œå‹•ãƒ­ã‚°è¨˜éŒ²
    logAction(0, 'ææ–™è³¼å…¥', `${market.name}ã‹ã‚‰Â¥${market.buyPrice}Ã—${quantity}å€‹`, -cost, true);

    closeModal();
    updateDisplay();
    showToast(`${market.name}ã‹ã‚‰ææ–™${quantity}å€‹ã‚’Â¥${cost}ã§è³¼å…¥ã—ã¾ã—ãŸ`, 'success', 3000);
    endTurn();
}

// è²©å£²ãƒ»å¸‚å ´é–¢æ•°ã¯ js/sales.js ã«ç§»å‹•ã—ã¾ã—ãŸ

// Chip purchase modal for decision cards (ã‚«ãƒ¼ãƒ‰ã‚¿ãƒƒãƒ—å½¢å¼)
function showChipPurchaseModal() {
    const company = gameState.companies[0];
    const maxEducation = gameState.currentPeriod === 2 ? 2 : 1;
    const mfgCap = getManufacturingCapacity(company);
    const salesCap = getSalesCapacity(company);

    const content = `
        <!-- ä¼šç¤¾ç›¤ï¼ˆãƒŸãƒ‹è¡¨ç¤ºï¼‰ -->
        <div style="background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%); border: 2px solid #22c55e; border-radius: 12px; padding: 12px; margin-bottom: 15px;">
            <div style="font-size: 12px; color: #166534; font-weight: bold; margin-bottom: 8px; text-align: center;">ğŸ“Š ä¼šç¤¾ç›¤</div>
            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; text-align: center; font-size: 11px;">
                <div style="background: rgba(255,255,255,0.7); padding: 6px; border-radius: 6px;">
                    <div style="color: #6b7280;">ææ–™</div>
                    <div style="font-weight: bold; font-size: 14px;">${company.materials}</div>
                </div>
                <div style="background: rgba(255,255,255,0.7); padding: 6px; border-radius: 6px;">
                    <div style="color: #6b7280;">ä»•æ›</div>
                    <div style="font-weight: bold; font-size: 14px;">${company.wip}</div>
                </div>
                <div style="background: rgba(255,255,255,0.7); padding: 6px; border-radius: 6px;">
                    <div style="color: #6b7280;">è£½å“</div>
                    <div style="font-weight: bold; font-size: 14px;">${company.products}</div>
                </div>
                <div style="background: rgba(255,255,255,0.7); padding: 6px; border-radius: 6px;">
                    <div style="color: #6b7280;">ç¾é‡‘</div>
                    <div style="font-weight: bold; font-size: 14px; color: #166534;">Â¥${company.cash}</div>
                </div>
            </div>
            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; text-align: center; font-size: 11px; margin-top: 8px;">
                <div style="background: rgba(255,255,255,0.7); padding: 6px; border-radius: 6px;">
                    <div style="color: #6b7280;">è£½é€ èƒ½åŠ›</div>
                    <div style="font-weight: bold;">${mfgCap}å€‹/å›</div>
                </div>
                <div style="background: rgba(255,255,255,0.7); padding: 6px; border-radius: 6px;">
                    <div style="color: #6b7280;">è²©å£²èƒ½åŠ›</div>
                    <div style="font-weight: bold;">${salesCap}å€‹/å›</div>
                </div>
                <div style="background: rgba(255,255,255,0.7); padding: 6px; border-radius: 6px;">
                    <div style="color: #6b7280;">è¡Œæ•°</div>
                    <div style="font-weight: bold;">${company.currentRow || 1}/${gameState.maxRows}</div>
                </div>
            </div>
            <div style="display: flex; justify-content: center; gap: 10px; margin-top: 8px; font-size: 11px;">
                <span style="color: #3b82f6;">ğŸ”¬ç ”ç©¶:${company.chips.research || 0}</span>
                <span style="color: #eab308;">ğŸ“šæ•™è‚²:${company.chips.education || 0}</span>
                <span style="color: #ef4444;">ğŸ“¢åºƒå‘Š:${company.chips.advertising || 0}</span>
                <span style="color: #22c55e;">ğŸ’»PC:${company.chips.computer || 0}</span>
                <span style="color: #f97316;">ğŸ›¡ä¿é™º:${company.chips.insurance || 0}</span>
            </div>
            <div style="display: flex; justify-content: center; gap: 15px; margin-top: 6px; font-size: 11px; color: #666;">
                <span>W${company.workers}</span>
                <span>æ©Ÿ${company.machines.length}</span>
                <span>S${company.salesmen}</span>
            </div>
        </div>
        <p style="text-align: center; margin-bottom: 15px; color: #666;">è³¼å…¥ã™ã‚‹ãƒãƒƒãƒ—ã‚’ã‚¿ãƒƒãƒ—ã—ã¦ãã ã•ã„ï¼ˆ1æšÂ¥20ï¼‰</p>
        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px;">
            <!-- ç ”ç©¶ãƒãƒƒãƒ—ï¼ˆé’ï¼‰ -->
            <div onclick="buyChipDirect('research')" style="
                background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
                border: 3px solid #1e40af;
                border-radius: 12px;
                padding: 15px 10px;
                text-align: center;
                cursor: pointer;
                color: white;
                transition: transform 0.2s, box-shadow 0.2s;
                box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
            " onmouseover="this.style.transform='scale(1.05)'; this.style.boxShadow='0 6px 20px rgba(59, 130, 246, 0.6)'"
               onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='0 4px 12px rgba(59, 130, 246, 0.4)'">
                <div style="font-size: 28px; margin-bottom: 8px;">ğŸ”¬</div>
                <div style="font-weight: bold; font-size: 14px;">ç ”ç©¶é–‹ç™º</div>
                <div style="font-size: 11px; margin-top: 5px;">ä¾¡æ ¼ç«¶äº‰åŠ›+2</div>
                <div style="font-size: 10px; margin-top: 3px; opacity: 0.8;">æ‰€æŒ: ${company.chips.research || 0}æš</div>
            </div>

            <!-- æ•™è‚²ãƒãƒƒãƒ—ï¼ˆé»„ï¼‰ -->
            <div onclick="buyChipDirect('education')" style="
                background: linear-gradient(135deg, #eab308 0%, #ca8a04 100%);
                border: 3px solid #a16207;
                border-radius: 12px;
                padding: 15px 10px;
                text-align: center;
                cursor: pointer;
                color: #1e293b;
                transition: transform 0.2s, box-shadow 0.2s;
                box-shadow: 0 4px 12px rgba(234, 179, 8, 0.4);
            " onmouseover="this.style.transform='scale(1.05)'; this.style.boxShadow='0 6px 20px rgba(234, 179, 8, 0.6)'"
               onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='0 4px 12px rgba(234, 179, 8, 0.4)'">
                <div style="font-size: 28px; margin-bottom: 8px;">ğŸ“š</div>
                <div style="font-weight: bold; font-size: 14px;">æ•™è‚²</div>
                <div style="font-size: 11px; margin-top: 5px;">è£½é€ ãƒ»è²©å£²+1</div>
                <div style="font-size: 10px; margin-top: 3px; opacity: 0.8;">æ‰€æŒ: ${company.chips.education || 0}/${maxEducation}æš</div>
            </div>

            <!-- åºƒå‘Šãƒãƒƒãƒ—ï¼ˆèµ¤ï¼‰ -->
            <div onclick="buyChipDirect('advertising')" style="
                background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
                border: 3px solid #b91c1c;
                border-radius: 12px;
                padding: 15px 10px;
                text-align: center;
                cursor: pointer;
                color: white;
                transition: transform 0.2s, box-shadow 0.2s;
                box-shadow: 0 4px 12px rgba(239, 68, 68, 0.4);
            " onmouseover="this.style.transform='scale(1.05)'; this.style.boxShadow='0 6px 20px rgba(239, 68, 68, 0.6)'"
               onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='0 4px 12px rgba(239, 68, 68, 0.4)'">
                <div style="font-size: 28px; margin-bottom: 8px;">ğŸ“¢</div>
                <div style="font-weight: bold; font-size: 14px;">åºƒå‘Š</div>
                <div style="font-size: 11px; margin-top: 5px;">è²©å£²èƒ½åŠ›å‘ä¸Š</div>
                <div style="font-size: 10px; margin-top: 3px; opacity: 0.8;">æ‰€æŒ: ${company.chips.advertising || 0}æš</div>
            </div>
        </div>
        <div style="text-align: center; margin-top: 15px;">
            <button class="action-btn secondary" onclick="closeModal(true)" style="padding: 10px 30px;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        </div>
    `;

    showModal('æˆ¦ç•¥ãƒãƒƒãƒ—è³¼å…¥', content);
}

// ç›´æ¥ãƒãƒƒãƒ—è³¼å…¥ï¼ˆã‚«ãƒ¼ãƒ‰ã‚¿ãƒƒãƒ—ç”¨ï¼‰
function buyChipDirect(chipType) {
    const company = gameState.companies[0];
    const cost = 20;

    if (company.cash < cost) {
        alert('ç¾é‡‘ãŒä¸è¶³ã—ã¦ã„ã¾ã™ï¼ˆå¿…è¦: Â¥20ï¼‰');
        return;
    }

    // ä¸Šé™ãƒã‚§ãƒƒã‚¯
    const maxLimits = {
        research: 5,
        education: gameState.currentPeriod === 2 ? 2 : 1,
        advertising: 5
    };
    const currentCount = company.chips[chipType] || 0;

    if (currentCount >= maxLimits[chipType]) {
        const names = { research: 'ç ”ç©¶é–‹ç™º', education: 'æ•™è‚²', advertising: 'åºƒå‘Š' };
        alert(`${names[chipType]}ãƒãƒƒãƒ—ã¯æœ€å¤§${maxLimits[chipType]}æšã¾ã§ã§ã™`);
        return;
    }

    company.cash -= cost;
    company.chips[chipType] = currentCount + 1;
    // Fè¨ˆç®—ç”¨ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°ï¼ˆ2æœŸç”¨ï¼‰
    company.chipsPurchasedThisPeriod[chipType] = (company.chipsPurchasedThisPeriod[chipType] || 0) + 1;

    const names = { research: 'ç ”ç©¶é–‹ç™º', education: 'æ•™è‚²', advertising: 'åºƒå‘Š' };
    closeModal();
    showToast(`${names[chipType]}ãƒãƒƒãƒ—ã‚’è³¼å…¥ã—ã¾ã—ãŸï¼ˆÂ¥20ï¼‰`, 'success', 3000);

    endTurn();
}

// Buy chips from decision card
function buyChipsFromDecision() {
    const company = gameState.companies[0];
    const chipType = document.getElementById('chipType').value;
    const quantity = parseInt(document.getElementById('quantity').value);
    
    const cost = quantity * 20;
    
    if (company.cash < cost) {
        showToast('ç¾é‡‘ãŒä¸è¶³ã—ã¦ã„ã¾ã™', 'danger', 3000);
        return;
    }
    
    // Check limits (2æœŸã¯æ•™è‚²ãƒãƒƒãƒ—2æšã¾ã§)
    const maxLimits = {
        research: 5, 
        education: gameState.currentPeriod === 2 ? 2 : 1,  // 2æœŸã¯2æšã¾ã§
        advertising: 5
    };
    const currentCount = company.chips[chipType] || 0;
    const newTotal = currentCount + quantity;
    
    if (newTotal > maxLimits[chipType]) {
        alert(`${chipType}ãƒãƒƒãƒ—ã¯æœ€å¤§${maxLimits[chipType]}æšã¾ã§ã§ã™`);
        return;
    }
    
    company.cash -= cost;
    company.chips[chipType] = newTotal;
    // Fè¨ˆç®—ç”¨ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°ï¼ˆ2æœŸç”¨ï¼‰
    company.chipsPurchasedThisPeriod[chipType] = (company.chipsPurchasedThisPeriod[chipType] || 0) + quantity;

    closeModal();
    showToast(`${chipType}ãƒãƒƒãƒ—ã‚’${quantity}å€‹è³¼å…¥ã—ã¾ã—ãŸï¼ˆÂ¥${cost}ï¼‰`, 'success', 3000);

    endTurn();
}

// Show manufacturing capacity detail
function showManufacturingCapacityDetail(companyIndex) {
    const company = gameState.companies[companyIndex];
    let baseMachineCapacity = 0;
    let machineDetail = [];
    
    company.machines.forEach(machine => {
        if (machine.type === 'small') {
            const capacity = machine.attachments > 0 ? 2 : 1;
            baseMachineCapacity += capacity;
            machineDetail.push(`å°å‹æ©Ÿæ¢°${machine.attachments > 0 ? '+ã‚¢ã‚¿ãƒƒãƒãƒ¡ãƒ³ãƒˆ' : ''}: ${capacity}`);
        } else if (machine.type === 'large') {
            baseMachineCapacity += 4;
            machineDetail.push(`å¤§å‹æ©Ÿæ¢°: 4`);
        }
    });
    
    const computerBonus = company.chips.computer || 0;
    const machineCapacity = baseMachineCapacity + computerBonus;
    const workerCapacity = company.workers + (company.chips.education || 0);
    const finalCapacity = Math.min(machineCapacity, workerCapacity);
    
    const content = `
        <div class="breakdown-list">
            <h3>è£½é€ èƒ½åŠ›ã®è©³ç´°</h3>
            ${machineDetail.map(d => `<div class="breakdown-item"><span>${d}</span></div>`).join('')}
            ${computerBonus > 0 ? `<div class="breakdown-item"><span>ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ãƒãƒƒãƒ—: +${computerBonus}</span></div>` : ''}
            <div class="breakdown-item"><span>æ©Ÿæ¢°èƒ½åŠ›è¨ˆ: ${machineCapacity}</span></div>
            <hr>
            <div class="breakdown-item"><span>ãƒ¯ãƒ¼ã‚«ãƒ¼: ${company.workers}</span></div>
            ${company.chips.education > 0 ? `<div class="breakdown-item"><span>æ•™è‚²ãƒãƒƒãƒ—: +${company.chips.education}</span></div>` : ''}
            <div class="breakdown-item"><span>ãƒ¯ãƒ¼ã‚«ãƒ¼èƒ½åŠ›è¨ˆ: ${workerCapacity}</span></div>
            <hr>
            <div class="breakdown-item breakdown-total"><span>è£½é€ èƒ½åŠ›</span><span>MIN(${machineCapacity}, ${workerCapacity}) = ${finalCapacity}</span></div>
        </div>
    `;
    
    showModal(`${company.name}ã®è£½é€ èƒ½åŠ›`, content);
}

// ============================================
// å…¥æœ­é–¢é€£é–¢æ•°ã¯ js/bidding.js ã«ç§»å‹•ã—ã¾ã—ãŸ
// ============================================

// ãƒãƒƒãƒ—è³¼å…¥é–¢æ•°ã¯ js/chips.js ã«ç§»å‹•ã—ã¾ã—ãŸ

// Do nothing
function doNothing() {
    const company = gameState.companies[0];
    
    if (!gameState.doNothingCount[0]) {
        gameState.doNothingCount[0] = 0;
    }
    
    if (gameState.doNothingCount[0] >= 3) {
        showToast('DO NOTHINGã¯é€£ç¶š3å›ã¾ã§ã§ã™ï¼', 'danger', 3000);
        return;
    }
    
    gameState.doNothingCount[0]++;
    showToast(`DO NOTHINGã‚’é¸æŠã—ã¾ã—ãŸï¼ˆ${gameState.doNothingCount[0]}/3å›ï¼‰\nè¡Œã¯æ¶ˆè²»ã•ã‚Œã¾ã›ã‚“ã€‚`, 'info', 3000);
    
    // DO NOTHING doesn't use a row
    nextTurn();
}

// ãƒ©ã‚¹ãƒˆ5è¡Œè­¦å‘Šãƒ¢ãƒ¼ãƒ€ãƒ«
function showLast5RowWarning(company) {
    const remaining = gameState.maxRows - company.currentRow + 1;
    const content = `
        <div style="padding: 20px; text-align: center;">
            <div style="font-size: 48px; margin-bottom: 15px;">âš ï¸</div>
            <div style="font-size: 18px; font-weight: bold; color: #dc2626; margin-bottom: 10px;">
                ${company.name}ãŒãƒ©ã‚¹ãƒˆ5è¡Œã«åˆ°é”ï¼
            </div>
            <div style="font-size: 14px; color: #6b7280; margin-bottom: 15px;">
                æ®‹ã‚Š${remaining}è¡Œã§æœŸæœ«å‡¦ç†ãŒå§‹ã¾ã‚Šã¾ã™ã€‚<br>
                çµ¦æ–™æ”¯æ‰•ã„ã«å‚™ãˆã¦è³‡é‡‘ã‚’ç¢ºä¿ã—ã¦ãã ã•ã„ã€‚
            </div>
            <div style="background: #fef2f2; border-radius: 8px; padding: 15px; margin-bottom: 15px;">
                <div style="font-size: 12px; color: #991b1b;">
                    ç¾åœ¨è¡Œ: ${company.currentRow} / ä¸Šé™: ${gameState.maxRows}è¡Œ
                </div>
            </div>
            <button class="submit-btn" onclick="closeModal()">OK</button>
        </div>
    `;
    showModal('ãƒ©ã‚¹ãƒˆ5è¡Œè­¦å‘Š', content);
}

// è¡Œæ•°ã‚’å¢—ã‚„ã™é–¢æ•°ï¼ˆè³‡æºå¤‰æ›´æ™‚ã«å‘¼ã¶ï¼‰
function incrementRow(companyIndex) {
    const company = gameState.companies[companyIndex];
    company.currentRow = (company.currentRow || 1) + 1;

    // ãƒ©ã‚¹ãƒˆ5è¡Œã®è­¦å‘Šï¼ˆå„ç¤¾ãŒå€‹åˆ¥ã«æ®‹ã‚Š5è¡Œã«åˆ°é”ã™ã‚‹ãŸã³ã«è­¦å‘Šï¼‰
    if (!company.last5RowWarningShown && company.currentRow === gameState.maxRows - 4) {
        company.last5RowWarningShown = true;
        showLast5RowWarning(company);
    }
    
    // èª°ã‹ãŒä¸Šé™ã«é”ã—ãŸã‚‰æœŸæœ«å‡¦ç†ï¼ˆå…¨å“¡å¼·åˆ¶çµ‚äº†ï¼‰
    if (company.currentRow >= gameState.maxRows) {
        console.log(`${company.name}ãŒè¡Œæ•°ä¸Šé™ï¼ˆ${gameState.maxRows}è¡Œï¼‰ã«é”ã—ã¾ã—ãŸï¼æœŸæœ«å‡¦ç†ã‚’é–‹å§‹ã—ã¾ã™ã€‚`);

        // å…¨å“¡ã«å‘ŠçŸ¥ï¼šèª°ã‹ãŒè¦å®šè¡Œæ•°ã«é”ã—ãŸã®ã§å…¨å“¡ã“ã®æœŸã¯çµ‚äº†
        showPeriodEndAnnouncement(company);
        return true;  // æœŸæœ«å‡¦ç†ã‚’é–‹å§‹ã—ãŸ
    }
    return false;  // ã¾ã ç¶šè¡Œ
}

// æœŸæœ«å‘ŠçŸ¥ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆèª°ã‹ãŒè¦å®šè¡Œæ•°ã«é”ã—ãŸæ™‚ï¼‰
function showPeriodEndAnnouncement(triggerCompany) {
    // ãƒ•ãƒªãƒ¼ã‚ºé˜²æ­¢ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‚’ã‚¯ãƒªã‚¢ï¼ˆAIè¡Œå‹•ä¸­ã«æœŸæœ«ã«ãªã£ãŸå ´åˆï¼‰
    if (window.currentAITurnTimeout) {
        clearTimeout(window.currentAITurnTimeout);
        window.currentAITurnTimeout = null;
    }
    const companies = gameState.companies;

    // å„ç¤¾ã®è¡Œæ•°ä¸€è¦§ã‚’ç”Ÿæˆ
    let rowsHtml = companies.map((c, i) => {
        const emoji = i === 0 ? 'ğŸ‘¤' : ['ğŸ…°ï¸', 'ğŸ…±ï¸', 'Â©ï¸', 'ğŸ‡©', 'ğŸ‡ª'][i - 1] || 'ğŸ¢';
        const isTrigger = (c === triggerCompany);
        return `
            <div style="display: flex; justify-content: space-between; padding: 8px; background: ${isTrigger ? '#fef3c7' : '#f9fafb'}; border-radius: 6px; margin: 5px 0; ${isTrigger ? 'border: 2px solid #f59e0b;' : ''}">
                <span>${emoji} ${c.name}</span>
                <span style="font-weight: bold; ${isTrigger ? 'color: #d97706;' : ''}">${c.currentRow}è¡Œ ${isTrigger ? '(è¦å®šåˆ°é”ï¼)' : ''}</span>
            </div>
        `;
    }).join('');

    const content = `
        <div style="text-align: center; padding: 15px;">
            <div style="font-size: 48px; margin-bottom: 10px;">ğŸ</div>
            <h3 style="color: #dc2626; margin-bottom: 15px;">ç¬¬${gameState.currentPeriod}æœŸ çµ‚äº†ï¼</h3>
            <p style="font-size: 14px; color: #4b5563; margin-bottom: 15px;">
                <strong>${triggerCompany.name}</strong> ãŒè¦å®šè¡Œæ•°ï¼ˆ${gameState.maxRows}è¡Œï¼‰ã«åˆ°é”ã—ã¾ã—ãŸã€‚<br>
                <span style="color: #dc2626; font-weight: bold;">å…¨ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ã“ã®æœŸã¯å¼·åˆ¶çµ‚äº†ã¨ãªã‚Šã¾ã™ã€‚</span>
            </p>
            <div style="background: #f3f4f6; border-radius: 10px; padding: 15px; margin-bottom: 15px;">
                <div style="font-size: 12px; color: #6b7280; margin-bottom: 10px;">å„ç¤¾ã®ä½¿ç”¨è¡Œæ•°</div>
                ${rowsHtml}
            </div>
            <button class="submit-btn" onclick="closePeriodEndAnnouncementAndStartSettlement()">æ±ºç®—å‡¦ç†ã¸é€²ã‚€</button>
        </div>
    `;

    showModal('æœŸçµ‚äº†', content);
}

function closePeriodEndAnnouncementAndStartSettlement() {
    // ãƒ•ãƒªãƒ¼ã‚ºé˜²æ­¢ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‚’ã‚¯ãƒªã‚¢ï¼ˆAIè¡Œå‹•ä¸­ã«æœŸæœ«ã«ãªã£ãŸå ´åˆï¼‰
    if (window.currentAITurnTimeout) {
        clearTimeout(window.currentAITurnTimeout);
        window.currentAITurnTimeout = null;
    }
    closeModal();
    endPeriod();
}

// End turn
function endTurn() {
    const company = gameState.companies[gameState.currentPlayerIndex];

    // åŠ´ç½ãƒ•ãƒ©ã‚°ã‚’ãƒªã‚»ãƒƒãƒˆï¼ˆã‚¿ãƒ¼ãƒ³çµ‚äº†æ™‚ï¼‰
    company.cannotProduce = false;

    // è¡Œæ•°ã‚’å¢—ã‚„ã™ï¼ˆè³‡æºå¤‰æ›´ãŒã‚ã£ãŸãŸã‚ï¼‰
    if (incrementRow(gameState.currentPlayerIndex)) {
        return;  // æœŸæœ«å‡¦ç†ãŒå§‹ã¾ã£ãŸã®ã§çµ‚äº†
    }

    gameState.doNothingCount[gameState.currentPlayerIndex] = 0;

    // è‡ªå‹•ã‚»ãƒ¼ãƒ–
    saveGame();

    nextTurn();
}

// Next turn
function nextTurn() {
    // ãƒ•ãƒªãƒ¼ã‚ºé˜²æ­¢ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‚’ã‚¯ãƒªã‚¢
    if (window.currentAITurnTimeout) {
        clearTimeout(window.currentAITurnTimeout);
        window.currentAITurnTimeout = null;
    }
    // ã‚¿ãƒ¼ãƒ³é †ã®å‡¦ç†ï¼ˆé€†å›ã‚Šã®å ´åˆï¼‰
    if (gameState.turnReversed) {
        gameState.currentPlayerIndex--;
        if (gameState.currentPlayerIndex < 0) {
            gameState.currentPlayerIndex = gameState.companies.length - 1;
            gameState.currentRow++;
            
            if (gameState.currentRow > gameState.maxRows) {
                endPeriod();
                return;
            }
        }
    } else {
        gameState.currentPlayerIndex++;
        if (gameState.currentPlayerIndex >= gameState.companies.length) {
            gameState.currentPlayerIndex = 0;
            gameState.currentRow++;
            
            if (gameState.currentRow > gameState.maxRows) {
                endPeriod();
                return;
            }
        }
    }
    
    updateDisplay();
    
    // Auto-execute AI turn
    if (gameState.currentPlayerIndex !== 0) {
        setTimeout(executeAITurn, 1000);
    } else {
        // Player's turn
        if (gameState.companies[0].skipTurns > 0) {
            gameState.companies[0].skipTurns--;
            alert(`ä¼‘ã¿ä¸­ï¼ˆæ®‹ã‚Š${gameState.companies[0].skipTurns}å›ï¼‰`);
            nextTurn();
        } else {
            showTurnStartOptions();
        }
    }
}

// ============================================
// AIè¡Œå‹•é–¢æ•°ã¯ js/ai-actions.js ã«ç§»å‹•ã—ã¾ã—ãŸ
// ============================================

// planAIPeriodStrategy ã¯ js/ai-strategies.js ã«ç§»å‹•æ¸ˆã¿
// AIBrain ã¯ js/ai-brain.js ã«ç§»å‹•æ¸ˆã¿
// AIæˆ¦ç•¥é–¢æ•°ç¾¤ ã¯ js/ai-strategies.js ã«ç§»å‹•æ¸ˆã¿

// End period
function endPeriod() {
    showToast('æœŸæœ«æ±ºç®—ã‚’é–‹å§‹ã—ã¾ã™', 'info', 3000);
    
    // æœŸæœ«æ™‚ç‚¹ã®äººæ•°ãƒ»æ©Ÿæ¢°å°æ•°ã‚’è¨˜éŒ²
    gameState.companies.forEach(company => {
        company.endOfPeriodStats = {
            workers: company.workers,
            salesmen: company.salesmen,
            machines: company.machines.length
        };
    });
    
    // Calculate financial metrics for all companies
    const financialData = [];
    
    gameState.companies.forEach((company, companyIndex) => {
        // Calculate PQ, VQ, MQ, G
        const pq = company.totalSales;
        const vq = calculateVQ(company);
        const mq = pq - vq;
        const fixedCosts = calculateFixedCost(company);
        const g = mq - fixedCosts - (company.specialLoss || 0);
        
        // Q = è²©å£²å€‹æ•°ï¼ˆæœŸä¸­ã®ç·è²©å£²æ•°é‡ï¼‰
        const q = company.totalSoldQuantity || 0;
        
        // Calculate unit prices (P=PQ/Q, V=VQ/Q, M=MQ/Q) with rounding to 1 decimal place
        // ã™ã¹ã¦Qã§å‰²ã‚‹ï¼ˆè²©å£²æ•°é‡ãƒ™ãƒ¼ã‚¹ã®å˜ä¾¡ï¼‰
        const unitP = q > 0 ? Math.round(pq / q * 10) / 10 : 0;  // P = PQ Ã· Q
        const unitV = q > 0 ? Math.round(vq / q * 10) / 10 : 0;  // V = VQ Ã· Q
        const unitM = q > 0 ? Math.round(mq / q * 10) / 10 : 0;  // M = MQ Ã· Q
        
        // ãƒãƒƒãƒ—è¿”å´å‰ã®ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ï¼ˆè¡¨ç¤ºç”¨ï¼‰
        const chipsBefore = {
            computer: company.chips.computer || 0,
            insurance: company.chips.insurance || 0,
            research: company.chips.research || 0,
            education: company.chips.education || 0,
            advertising: company.chips.advertising || 0
        };
        const nextPeriodChipsBefore = {
            research: company.nextPeriodChips?.research || 0,
            education: company.nextPeriodChips?.education || 0,
            advertising: company.nextPeriodChips?.advertising || 0
        };

        // Fè©³ç´°è¨ˆç®—ç”¨ï¼ˆãƒªã‚»ãƒƒãƒˆå‰ã«ä¿å­˜ï¼‰
        const calcPeriod = gameState.currentPeriod;
        let unitCostF = BASE_SALARY_BY_PERIOD[calcPeriod] || 22;
        if (calcPeriod >= 3 && gameState.wageMultiplier > 1) {
            unitCostF = Math.round(unitCostF * gameState.wageMultiplier);
        }
        const halfCostF = Math.round(unitCostF / 2);
        const fStats = company.endOfPeriodStats;
        const fMachineSalary = fStats.machines * unitCostF;
        const fWorkerSalary = fStats.workers * unitCostF;
        const fSalesmenSalary = fStats.salesmen * unitCostF;
        const fMaxPersonnel = company.maxPersonnel || (fStats.workers + fStats.salesmen);
        const fMaxPersonnelCost = fMaxPersonnel * halfCostF;
        const fTotalSalary = fMachineSalary + fWorkerSalary + fSalesmenSalary + fMaxPersonnelCost;
        const fDepreciation = calculateDepreciation(company, calcPeriod);
        const fLongInterest = Math.floor((company.loans || 0) * 0.1);
        const fShortInterest = Math.floor((company.shortLoans || 0) * 0.2);
        const fPcCost = (company.chips.computer || 0) * 20;
        const fInsuranceCost = (company.chips.insurance || 0) * 5;

        // ãƒãƒƒãƒ—è²»ç”¨è¨ˆç®—
        let fChipCost = 0;
        if (calcPeriod === 2) {
            const purchased = company.chipsPurchasedThisPeriod || {research: 0, education: 0, advertising: 0};
            const chipsAtEnd = {
                research: company.chips.research || 0,
                education: company.chips.education || 0,
                advertising: company.chips.advertising || 0
            };
            const willCarryOver = {
                research: Math.max(0, Math.min(chipsAtEnd.research, 3) - 1),
                education: Math.max(0, Math.min(chipsAtEnd.education, 3) - 1),
                advertising: Math.max(0, Math.min(chipsAtEnd.advertising, 3) - 1)
            };
            fChipCost = (Math.max(0, (purchased.research || 0) - willCarryOver.research) +
                        Math.max(0, (purchased.education || 0) - willCarryOver.education) +
                        Math.max(0, (purchased.advertising || 0) - willCarryOver.advertising)) * 20;
        } else {
            const carriedOver = company.carriedOverChips || {research: 0, education: 0, advertising: 0};
            const express = company.expressChipsPurchased || {research: 0, education: 0, advertising: 0};
            fChipCost = ((carriedOver.research || 0) + (carriedOver.education || 0) + (carriedOver.advertising || 0)) * 20;
            fChipCost += ((express.research || 0) + (express.education || 0) + (express.advertising || 0)) * 40;
        }
        const fExtraLabor = company.extraLaborCost || 0;
        const fAdditionalF = company.additionalFixedCost || 0;

        financialData.push({
            name: company.name,
            p: unitP,  // P=PQ/Q (å˜ä¾¡)
            v: unitV,  // V=VQ/Q (å˜ä¾¡)
            m: unitM,  // M=MQ/Q (å˜ä¾¡)
            q: q,
            pq: pq,
            vq: vq,
            mq: mq,
            f: fixedCosts,
            g: g,
            // VQè©³ç´°è¨ˆç®—ç”¨ï¼ˆshowFinancialDetailsã§ä½¿ç”¨ï¼‰
            materialCost: company.totalMaterialCost || 0,
            productionCost: company.totalProductionCost || 0,
            startInventory: {
                materials: company.periodStartInventory?.materials || 0,
                wip: company.periodStartInventory?.wip || 0,
                products: company.periodStartInventory?.products || 0
            },
            endInventory: {
                materials: company.materials || 0,
                wip: company.wip || 0,
                products: company.products || 0
            },
            // Fè©³ç´°è¨ˆç®—ç”¨ï¼ˆãƒªã‚»ãƒƒãƒˆå‰ã«ä¿å­˜ï¼‰
            fBreakdown: {
                period: calcPeriod,
                unitCost: unitCostF,
                halfCost: halfCostF,
                stats: {
                    machines: fStats.machines,
                    workers: fStats.workers,
                    salesmen: fStats.salesmen
                },
                machineSalary: fMachineSalary,
                workerSalary: fWorkerSalary,
                salesmenSalary: fSalesmenSalary,
                maxPersonnel: fMaxPersonnel,
                maxPersonnelCost: fMaxPersonnelCost,
                totalSalary: fTotalSalary,
                depreciation: fDepreciation,
                longInterest: fLongInterest,
                shortInterest: fShortInterest,
                pcCost: fPcCost,
                insuranceCost: fInsuranceCost,
                chipCost: fChipCost,
                extraLabor: fExtraLabor,
                additionalF: fAdditionalF
            },
            // ãƒãƒƒãƒ—è¿”å´æƒ…å ±
            chipsBefore: chipsBefore,
            nextPeriodChipsBefore: nextPeriodChipsBefore
        });
        
        // Calculate tax and dividend if equity exceeds Â¥300
        let tax = 0;
        let dividend = 0;
        const previousEquity = company.equity;
        const newEquity = previousEquity + g;

        if (newEquity > 300) {
            if (!company.hasExceeded300) {
                // åˆã‚ã¦Â¥300ã‚’è¶…ãˆãŸå ´åˆ
                const excess = newEquity - 300;
                tax = Math.round(excess * 0.5);  // è¶…éåˆ†ã®50%
                dividend = Math.round(excess * 0.2);  // è¶…éåˆ†ã®20%
                company.hasExceeded300 = true;
            } else {
                // æ—¢ã«Â¥300ã‚’è¶…ãˆã¦ã„ãŸå ´åˆï¼ˆåˆ©ç›ŠãŒã‚ã‚‹å ´åˆã®ã¿ï¼‰
                if (g > 0) {
                    tax = Math.round(g * 0.5);  // åˆ©ç›Šã®50%
                    dividend = Math.round(g * 0.1);  // åˆ©ç›Šã®10%
                }
            }
        }

        company.pendingTax = tax;
        company.pendingDividend = dividend;

        // Update equity (ç¨é‡‘ã¯è‡ªå·±è³‡æœ¬ã‹ã‚‰å¼•ã)
        company.equity = newEquity - tax;
        
        // Pay period-end costs (using end-of-period stats)
        const periodPayment = calculatePeriodPayment(company, true);
        company.cash -= periodPayment;
        
        // Apply short-term loan if cash is negative
        if (company.cash < 0) {
            const needed = Math.ceil(Math.abs(company.cash) / 0.8 / 50) * 50;
            company.shortLoans += needed;
            company.cash += needed * 0.8;  // çŸ­æœŸå€Ÿå…¥: å€Ÿå…¥æ™‚20%é‡‘åˆ©æ§é™¤
        }
        
        // Handle chip returns
        if (gameState.currentPeriod === 2) {
            // 2æœŸæœ«ï¼šã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ãƒ»ä¿é™ºã¯è¿”å´ã€ç ”ç©¶ãƒ»åºƒå‘Šã¯æœ€å¤§3æšã¾ã§æŒã¡è¶Šã—
            const maxCarryOver = 3;
            const totalResearch = company.chips.research + company.nextPeriodChips.research;
            const totalAdvertising = company.chips.advertising + company.nextPeriodChips.advertising;
            const totalEducation = company.chips.education + company.nextPeriodChips.education;

            // 3æšã‚’è¶…ãˆã‚‹å ´åˆã¯è­¦å‘Š
            if (totalResearch > maxCarryOver && company.type === 'player') {
                alert(`ç ”ç©¶ãƒãƒƒãƒ—ãŒ${totalResearch}æšã‚ã‚Šã¾ã™ãŒã€3æšã¾ã§ã—ã‹æŒã¡è¶Šã›ã¾ã›ã‚“ã€‚`);
            }
            if (totalAdvertising > maxCarryOver && company.type === 'player') {
                alert(`åºƒå‘Šãƒãƒƒãƒ—ãŒ${totalAdvertising}æšã‚ã‚Šã¾ã™ãŒã€3æšã¾ã§ã—ã‹æŒã¡è¶Šã›ã¾ã›ã‚“ã€‚`);
            }

            // æ¬¡æœŸãƒãƒƒãƒ—è¨­å®šï¼ˆ2æœŸâ†’3æœŸã¯å…¨ãƒãƒƒãƒ—1æšæ¸›ã£ã¦ç¹°ã‚Šè¶Šã—ã€æœ€å¤§3æšã¾ã§ï¼‰
            const newResearch = Math.max(0, Math.min(totalResearch, maxCarryOver) - 1);
            const newEducation = Math.max(0, Math.min(totalEducation, maxCarryOver) - 1);
            const newAdvertising = Math.max(0, Math.min(totalAdvertising, maxCarryOver) - 1);

            company.chips.computer = 0;  // è¿”å´
            company.chips.insurance = 0; // è¿”å´
            company.chips.research = newResearch;
            company.chips.education = newEducation;
            company.chips.advertising = newAdvertising;
            company.nextPeriodChips = {research: 0, education: 0, advertising: 0};

            // ç¹°ã‚Šè¶Šã—ãƒãƒƒãƒ—ã‚’è¨˜éŒ²ï¼ˆ3æœŸã®Fè¨ˆç®—ã§20å††/æšã¨ã—ã¦ä½¿ç”¨ï¼‰
            company.carriedOverChips = {
                research: newResearch,
                education: newEducation,
                advertising: newAdvertising
            };
        } else {
            // 3-5æœŸæœ«ï¼šå…¨ãƒãƒƒãƒ—æ²¡åï¼ˆç¹°è¶Šåˆ†ã¯æ®‹ã‚‹ï¼‰
            const carryResearch = company.nextPeriodChips.research || 0;
            const carryEducation = company.nextPeriodChips.education || 0;
            const carryAdvertising = company.nextPeriodChips.advertising || 0;

            company.chips = {
                computer: 0,
                insurance: 0,
                research: carryResearch,
                education: carryEducation,
                advertising: carryAdvertising
            };
            company.nextPeriodChips = {research: 0, education: 0, advertising: 0};

            // ç¹°ã‚Šè¶Šã—ãƒãƒƒãƒ—ã‚’è¨˜éŒ²ï¼ˆæ¬¡æœŸã®Fè¨ˆç®—ã§20å††/æšã¨ã—ã¦ä½¿ç”¨ï¼‰
            company.carriedOverChips = {
                research: carryResearch,
                education: carryEducation,
                advertising: carryAdvertising
            };
        }

        // ãƒãƒƒãƒ—è¿”å´å¾Œã®ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
        financialData[companyIndex].chipsAfter = {
            computer: company.chips.computer,
            insurance: company.chips.insurance,
            research: company.chips.research,
            education: company.chips.education,
            advertising: company.chips.advertising
        };

        // Update period start inventory
        company.periodStartInventory = {
            materials: company.materials,
            wip: company.wip,
            products: company.products
        };
        
        // Reset period tracking
        company.rowsUsed = 0;
        company.totalSales = 0;
        company.totalSoldQuantity = 0;
        company.totalMaterialCost = 0;
        company.totalProductionCost = 0;
        company.specialLoss = 0;
        company.extraLaborCost = 0;
        // ãƒãƒƒãƒ—è³¼å…¥ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ãƒªã‚»ãƒƒãƒˆï¼ˆFè¨ˆç®—ç”¨ï¼‰
        company.chipsPurchasedThisPeriod = {research: 0, education: 0, advertising: 0};
        company.expressChipsPurchased = {research: 0, education: 0, advertising: 0};

        // å€‰åº«ãƒªã‚»ãƒƒãƒˆï¼ˆæœŸæœ«ã§æ¶ˆæ»…ï¼‰
        company.warehouses = 0;
        company.warehouseLocation = 'materials';

        // Reset retirement and max personnel tracking for next period
        company.retiredWorkers = 0;
        company.retiredSalesmen = 0;
        company.maxPersonnel = company.workers + company.salesmen;  // æ¬¡æœŸã®åˆæœŸå€¤
    });
    
    // Store and show financial summary
    window.lastFinancialData = financialData;

    // æ¬¡æœŸã®ã‚µã‚¤ã‚³ãƒ­æ‹…å½“ï¼ˆä»ŠæœŸPQãƒˆãƒƒãƒ—ï¼‰ã‚’è¨˜éŒ²
    let maxPQ = 0;
    let pqTopIndex = 0;
    financialData.forEach((data, idx) => {
        if (data.pq > maxPQ) {
            maxPQ = data.pq;
            pqTopIndex = idx;
        }
    });
    gameState.previousPQTopIndex = pqTopIndex;
    gameState.previousPQTopName = gameState.companies[pqTopIndex].name;
    gameState.previousPQTopAmount = maxPQ;
    console.log(`[PQãƒˆãƒƒãƒ—] ä»ŠæœŸ: ${gameState.previousPQTopName} (Â¥${maxPQ})`);

    // æœŸæœ«è¿”æ¸ˆå‡¦ç†ï¼ˆAIä¼šç¤¾ã¯è‡ªå‹•è¿”æ¸ˆã€ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¯é¸æŠï¼‰
    processEndPeriodLoanRepayments(financialData);
}

// æœŸæœ«è¿”æ¸ˆé–¢æ•°ã¯js/loans.jsã«ç§»å‹•

// End game
function endGame() {
    // å‹åˆ©æ¡ä»¶ãƒã‚§ãƒƒã‚¯: æ¬¡æœŸç¹°ã‚Šè¶Šã—ãƒãƒƒãƒ—3æšä»¥ä¸Š ã‹ã¤ åœ¨åº«åˆè¨ˆ10å€‹ä»¥ä¸Š
    const companiesWithConditions = gameState.companies.map(company => {
        const nextChips = (company.nextPeriodChips?.research || 0) +
                         (company.nextPeriodChips?.education || 0) +
                         (company.nextPeriodChips?.advertising || 0);
        const inventory = company.materials + company.wip + company.products;
        const meetsCondition = nextChips >= 3 && inventory >= 10;

        return {
            ...company,
            nextChips,
            inventory,
            meetsCondition
        };
    });

    // === AIå­¦ç¿’: ã‚²ãƒ¼ãƒ çµæœã‹ã‚‰å­¦ç¿’ ===
    try {
        const gameResults = gameState.companies.map(c => ({
            name: c.name,
            equity: c.equity,
            strategy: c.strategy,
            type: c.type
        }));
        AIBrain.learnFromGameResult(gameResults);
        console.log('[AIå­¦ç¿’] ã‚²ãƒ¼ãƒ çµ‚äº†æ™‚ã®å­¦ç¿’å®Œäº†');
    } catch (e) {
        console.error('[AIå­¦ç¿’] å­¦ç¿’ã‚¨ãƒ©ãƒ¼:', e);
    }

    // æ¡ä»¶ã‚’æº€ãŸã™ä¼šç¤¾ã®ã¿ã§ãƒ©ãƒ³ã‚­ãƒ³ã‚°
    const qualifiedCompanies = companiesWithConditions.filter(c => c.meetsCondition);
    const disqualifiedCompanies = companiesWithConditions.filter(c => !c.meetsCondition);

    let resultHtml = '<div style="max-height: 500px; overflow-y: auto;">';

    // å‹åˆ©æ¡ä»¶ã®èª¬æ˜
    resultHtml += `
        <div style="background: #fef3c7; border-radius: 8px; padding: 12px; margin-bottom: 15px; font-size: 12px;">
            <div style="font-weight: bold; color: #92400e; margin-bottom: 5px;">å‹åˆ©æ¡ä»¶</div>
            <div style="color: #78350f;">æ¬¡æœŸç¹°ã‚Šè¶Šã—ãƒãƒƒãƒ—3æšä»¥ä¸Š ã‹ã¤ åœ¨åº«åˆè¨ˆ10å€‹ä»¥ä¸Š</div>
        </div>
    `;

    if (qualifiedCompanies.length > 0) {
        const rankings = qualifiedCompanies.sort((a, b) => b.equity - a.equity);
        const winner = rankings[0];

        resultHtml += `
            <div style="background: linear-gradient(180deg, #fbbf24 0%, #f59e0b 100%); border-radius: 12px; padding: 20px; margin-bottom: 15px; text-align: center; border: 3px solid #d97706;">
                <div style="font-size: 32px; margin-bottom: 5px;">ğŸ†</div>
                <div style="font-size: 20px; font-weight: bold; color: #78350f;">${winner.name}</div>
                <div style="font-size: 24px; font-weight: bold; color: #1e40af; margin-top: 5px;">è‡ªå·±è³‡æœ¬ Â¥${winner.equity}</div>
                <div style="font-size: 11px; color: #78350f; margin-top: 8px;">
                    ç¹°è¶Šãƒãƒƒãƒ—: ${winner.nextChips}æš / åœ¨åº«: ${winner.inventory}å€‹
                </div>
            </div>
        `;

        resultHtml += '<div class="breakdown-list">';
        rankings.forEach((company, index) => {
            const medal = index === 0 ? 'ğŸ¥‡' : index === 1 ? 'ğŸ¥ˆ' : index === 2 ? 'ğŸ¥‰' : '';
            resultHtml += `
                <div class="breakdown-item" style="padding: 10px; ${index === 0 ? 'background: #fef9c3;' : ''}">
                    <div>
                        <span style="font-weight: bold;">${medal} ${index + 1}ä½: ${company.name}</span>
                        <div style="font-size: 11px; color: #666;">ãƒãƒƒãƒ—: ${company.nextChips}æš / åœ¨åº«: ${company.inventory}å€‹</div>
                    </div>
                    <span style="font-weight: bold; color: #1e40af;">Â¥${company.equity}</span>
                </div>
            `;
        });
        resultHtml += '</div>';
    } else {
        resultHtml += `
            <div style="background: #fee2e2; border-radius: 12px; padding: 20px; margin-bottom: 15px; text-align: center;">
                <div style="font-size: 24px; margin-bottom: 5px;">ğŸ˜¢</div>
                <div style="font-size: 16px; font-weight: bold; color: #991b1b;">å‹åˆ©æ¡ä»¶ã‚’æº€ãŸã™ä¼šç¤¾ãŒã‚ã‚Šã¾ã›ã‚“</div>
            </div>
        `;
    }

    // å¤±æ ¼ä¼šç¤¾ï¼ˆæ¡ä»¶æœªé”æˆï¼‰
    if (disqualifiedCompanies.length > 0) {
        resultHtml += `
            <div style="margin-top: 15px; padding-top: 15px; border-top: 2px dashed #e5e7eb;">
                <div style="font-weight: bold; color: #6b7280; margin-bottom: 10px;">æ¡ä»¶æœªé”æˆ</div>
        `;
        disqualifiedCompanies.forEach(company => {
            const chipStatus = company.nextChips >= 3 ? 'âœ“' : 'âœ—';
            const invStatus = company.inventory >= 10 ? 'âœ“' : 'âœ—';
            resultHtml += `
                <div class="breakdown-item" style="padding: 8px; opacity: 0.7;">
                    <div>
                        <span>${company.name}</span>
                        <div style="font-size: 10px; color: #ef4444;">
                            ãƒãƒƒãƒ—${chipStatus}${company.nextChips}æš / åœ¨åº«${invStatus}${company.inventory}å€‹
                        </div>
                    </div>
                    <span style="color: #6b7280;">Â¥${company.equity}</span>
                </div>
            `;
        });
        resultHtml += '</div>';
    }

    resultHtml += '</div>';

    showModal('ã‚²ãƒ¼ãƒ çµ‚äº† - æœ€çµ‚çµæœ', resultHtml);
}

// ============================================
// ã‚»ãƒ¼ãƒ–ãƒ»ãƒ­ãƒ¼ãƒ‰æ©Ÿèƒ½ã¯ js/save.js ã«ç§»å‹•ã—ã¾ã—ãŸ

function showStartMenu() {
    const hasSave = hasSavedGame();
    const saveData = hasSave ? loadGame() : null;
    const saveInfo = saveData ? `ï¼ˆ${saveData.currentPeriod}æœŸã€${new Date(saveData.timestamp).toLocaleString('ja-JP')}ï¼‰` : '';

    const menuHtml = `
        <div class="modal active" style="z-index: 2000;">
            <div class="modal-content" style="max-width: 400px; text-align: center;">
                <h2 style="margin-bottom: 20px; color: #1e40af;">ğŸ® MGï¼ˆãƒãƒã‚¸ãƒ¡ãƒ³ãƒˆã‚²ãƒ¼ãƒ ï¼‰</h2>
                <p style="margin-bottom: 20px; color: #666;">è‡ªä¸»ç·´ãƒ¢ãƒ¼ãƒ‰ - 6äººå¯¾æˆ¦</p>

                <div style="display: flex; flex-direction: column; gap: 12px;">
                    ${hasSave ? `
                        <button onclick="resumeGame()" class="action-btn primary" style="padding: 15px; font-size: 16px;">
                            â–¶ ç¶šãã‹ã‚‰å§‹ã‚ã‚‹${saveInfo}
                        </button>
                    ` : ''}
                    <button onclick="startNewGame()" class="action-btn success" style="padding: 15px; font-size: 16px;">
                        ğŸ†• 2æœŸã‹ã‚‰æ–°ã—ãå§‹ã‚ã‚‹
                    </button>
                    ${hasSave ? `
                        <button onclick="confirmDeleteSave()" class="action-btn secondary" style="padding: 10px; font-size: 14px;">
                            ğŸ—‘ ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤
                        </button>
                    ` : ''}
                </div>
            </div>
        </div>
    `;
    document.getElementById('modalContainer').innerHTML = menuHtml;
}

function resumeGame() {
    const saveData = loadGame();
    if (saveData) {
        restoreGame(saveData);
        document.getElementById('modalContainer').innerHTML = '';
        updateDisplay();
        showToast('ã‚²ãƒ¼ãƒ ã‚’å†é–‹ã—ã¾ã—ãŸï¼ˆ' + gameState.currentPeriod + 'æœŸï¼‰', 'success', 3000);
    }
}

function startNewGame() {
    deleteSavedGame();
    initializeCompanies();
    initializeCardDeck();
    // 2æœŸã®ã‚¹ã‚¿ãƒ¼ãƒˆé †ã‚’ãƒ©ãƒ³ãƒ€ãƒ åŒ–ï¼ˆã‚¸ãƒ£ãƒ³ã‚±ãƒ³ä»£ã‚ã‚Šï¼‰
    const randomStartIndex = Math.floor(Math.random() * gameState.companies.length);
    gameState.currentPlayerIndex = randomStartIndex;
    gameState.periodStartPlayerIndex = randomStartIndex;
    document.getElementById('modalContainer').innerHTML = '';
    updateDisplay();
    saveGame(); // åˆæœŸçŠ¶æ…‹ã‚’ä¿å­˜
    // ã‚¹ã‚¿ãƒ¼ãƒˆé †ã‚’é€šçŸ¥
    const startPlayer = gameState.companies[randomStartIndex];
    showToast(`ğŸ² ${startPlayer.name}ã‹ã‚‰ã‚¹ã‚¿ãƒ¼ãƒˆï¼`, 'info', 3000);
}

function confirmDeleteSave() {
    if (confirm('ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚')) {
        deleteSavedGame();
        showStartMenu();
    }
}

// Initialize game
function initGame() {
    console.log("initGame started");
    try {
        // ã¾ãšä¼šç¤¾ã¨ãƒ‡ãƒƒã‚­ã‚’åˆæœŸåŒ–ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆçŠ¶æ…‹ï¼‰
        initializeCompanies();
        console.log("Companies initialized");
        initializeCardDeck();
        console.log("Card deck initialized (75 cards)");

        // ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Œã°ã‚¹ã‚¿ãƒ¼ãƒˆãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’è¡¨ç¤º
        if (hasSavedGame()) {
            showStartMenu();
        } else {
            updateDisplay();
            saveGame(); // åˆæœŸçŠ¶æ…‹ã‚’ä¿å­˜
        }
        console.log("Display updated");
    } catch(e) {
        console.error("Error in initGame:", e);
        alert("ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: " + e.message);
    }
}

// Start the game
console.log("Starting game...");
initGame();
    </script>
</body>
</html>