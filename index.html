<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MG (Management Game) - Ultimate Edition</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif; background: #f5f5f5; min-height: 100vh; color: #333; }
        .container { max-width: 100%; margin: 0 auto; padding: 8px; }

        /* ============================================ */
        /* トースト通知システム */
        /* ============================================ */
        .toast-container {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 10000;
            display: flex;
            flex-direction: column;
            gap: 10px;
            pointer-events: none;
        }
        .toast {
            background: linear-gradient(135deg, #1e40af 0%, #1e3a8a 100%);
            color: white;
            padding: 16px 24px;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            min-width: 280px;
            max-width: 400px;
            animation: toastSlideIn 0.3s ease-out;
            pointer-events: auto;
            border: 2px solid #3b82f6;
        }
        .toast.success {
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
            border-color: #34d399;
        }
        .toast.warning {
            background: linear-gradient(135deg, #d97706 0%, #b45309 100%);
            border-color: #fbbf24;
        }
        .toast.danger {
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
            border-color: #f87171;
        }
        .toast-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
        }
        .toast-icon {
            font-size: 24px;
        }
        .toast-title {
            font-weight: bold;
            font-size: 14px;
        }
        .toast-body {
            font-size: 13px;
            line-height: 1.5;
            white-space: pre-line;
        }
        .toast-close {
            position: absolute;
            top: 8px;
            right: 12px;
            background: none;
            border: none;
            color: white;
            font-size: 18px;
            cursor: pointer;
            opacity: 0.7;
        }
        .toast-close:hover {
            opacity: 1;
        }
        @keyframes toastSlideIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes toastSlideOut {
            from { opacity: 1; transform: translateY(0); }
            to { opacity: 0; transform: translateY(-20px); }
        }
        .toast.hiding {
            animation: toastSlideOut 0.3s ease-in forwards;
        }

        /* ============================================ */
        /* ヘッダー - ゲーム情報 */
        /* ============================================ */
        .header { background: #fff; border: 2px solid #1e40af; border-radius: 8px; padding: 10px 15px; margin-bottom: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .period-info { display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; align-items: center; }
        .info-item { background: #e0f2fe; padding: 6px 12px; border-radius: 20px; display: flex; gap: 8px; align-items: center; border: 1px solid #0284c7; }
        .info-label { font-size: 11px; color: #0369a1; }
        .info-value { font-size: 14px; font-weight: bold; color: #0f766e; }
        .info-value.negative { color: #dc2626; }

        /* ============================================ */
        /* ゲームエリアレイアウト（市場中央、他社周囲） */
        /* ============================================ */
        .game-area {
            margin-bottom: 10px;
        }
        .other-companies-top {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-bottom: 8px;
            flex-wrap: wrap;
        }
        .center-area {
            display: flex;
            justify-content: center;
            align-items: stretch;
            gap: 8px;
        }
        .other-companies-left,
        .other-companies-right {
            display: flex;
            flex-direction: column;
            gap: 8px;
            justify-content: center;
        }
        .market-center {
            flex: 1;
            max-width: 400px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        /* 他社会社盤（フル表示 - 実物再現） */
        .other-company-board {
            background: linear-gradient(180deg, #4a7bb7 0%, #3a6aa5 100%);
            border: 3px solid #1e4a7a;
            border-radius: 8px;
            padding: 8px;
            font-size: 11px;
            min-width: 170px;
            max-width: 210px;
            color: #fff;
            box-shadow: 0 3px 10px rgba(0,0,0,0.3);
        }
        .other-company-board.current-turn {
            border-color: #fbbf24;
            border-width: 4px;
            box-shadow: 0 0 20px rgba(251, 191, 36, 0.8);
        }
        .other-company-board .oc-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
            padding-bottom: 4px;
            border-bottom: 2px solid rgba(255,255,255,0.3);
        }
        .other-company-board .oc-name { font-weight: bold; font-size: 12px; color: #fbbf24; text-shadow: 0 1px 2px rgba(0,0,0,0.3); }
        .other-company-board .oc-cash { font-weight: bold; color: #4ade80; text-shadow: 0 1px 2px rgba(0,0,0,0.3); }
        .other-company-board .oc-stats {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 4px;
            margin-bottom: 6px;
        }
        .other-company-board .oc-stat {
            background: rgba(255,255,255,0.2);
            padding: 3px;
            border-radius: 4px;
            text-align: center;
            font-size: 10px;
        }
        .other-company-board .oc-stat-label { color: #bfdbfe; }
        .other-company-board .oc-stat-value { font-weight: bold; color: #fff; }
        .other-company-board .oc-inv {
            display: flex;
            gap: 3px;
            justify-content: center;
            flex-wrap: wrap;
        }
        .other-company-board .oc-block {
            width: 14px; height: 14px;
            border-radius: 2px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.4);
        }
        .other-company-board .oc-block.m { background: linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%); }
        .other-company-board .oc-block.w { background: linear-gradient(135deg, #a569bd 0%, #9b59b6 100%); border: 1px dashed #c39bd3; }
        .other-company-board .oc-block.p { background: linear-gradient(135deg, #7d6ee7 0%, #6366f1 100%); }

        /* 他社会社盤（フル表示 - コンパクト版） */
        .board-title-mini {
            text-align: center;
            font-size: 11px;
            font-weight: bold;
            padding: 4px 8px;
            background: linear-gradient(180deg, #f8f8f8 0%, #e8e8e8 100%);
            color: #1e3a5f;
            border-radius: 3px;
            margin-bottom: 6px;
            border: 1px solid #1e4a7a;
            letter-spacing: 1px;
        }
        .production-flow-mini {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 3px;
            margin-bottom: 6px;
        }
        .flow-box-mini {
            background: linear-gradient(180deg, #faf5eb 0%, #f5efe5 100%);
            border: 2px solid #8b7355;
            border-radius: 4px;
            padding: 4px 3px;
            text-align: center;
        }
        .flow-box-mini.factory { background: linear-gradient(180deg, #e8f4fd 0%, #d4e8f8 100%); border-color: #4a90c2; }
        .flow-box-title-mini { font-size: 8px; color: #3d3d3d; font-weight: bold; }
        .flow-box-content-mini { display: flex; flex-wrap: wrap; gap: 2px; justify-content: center; min-height: 18px; align-items: center; }
        .flow-box-content-mini .inv-block { width: 13px; height: 13px; }

        .personnel-row-mini {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 3px;
            margin-bottom: 6px;
        }
        .personnel-box-mini {
            background: linear-gradient(180deg, #faf5eb 0%, #f5efe5 100%);
            border: 1px solid #8b7355;
            border-radius: 4px;
            padding: 3px;
            text-align: center;
        }
        .personnel-box-title-mini { font-size: 8px; color: #3d3d3d; font-weight: bold; }
        .personnel-dots-mini { display: flex; flex-wrap: wrap; gap: 2px; justify-content: center; min-height: 16px; align-items: center; }
        .personnel-dots-mini .person-dot { width: 16px; height: 16px; font-size: 7px; }
        .personnel-dots-mini .person-dot.worker { background: linear-gradient(180deg, #f5deb3 0%, #deb887 100%); color: #5d4037; border: 1px solid #a08060; }
        .personnel-dots-mini .person-dot.salesman { background: linear-gradient(180deg, #ff6b6b 0%, #ee5a5a 100%); border: 1px solid #c44; }
        .personnel-dots-mini .machine-dot { width: 18px; height: 16px; font-size: 7px; background: linear-gradient(180deg, #888 0%, #666 100%); border: 1px solid #444; }

        .chips-row-mini {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 2px;
        }
        .chip-box-mini {
            background: linear-gradient(180deg, #faf5eb 0%, #f5efe5 100%);
            border: 1px solid #8b7355;
            border-radius: 3px;
            padding: 3px 2px;
            text-align: center;
            min-height: 18px;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-wrap: wrap;
            gap: 2px;
            font-size: 7px;
            color: #3d3d3d;
        }
        .chip-box-mini .chip { width: 12px; height: 12px; box-shadow: 0 1px 2px rgba(0,0,0,0.3); }

        /* 手元エリア（プレイヤーの会社盤） */
        .player-area {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 10px;
            align-items: start;
            position: relative;
        }
        /* 会社盤固定時のスペース確保 */
        .player-area-wrapper {
            margin-top: 10px;
        }

        /* 次繰盤 */
        .next-period-board {
            background: #faf5ff;
            border: 2px solid #9333ea;
            border-radius: 8px;
            padding: 8px;
            margin-top: 10px;
        }
        .next-period-content {
            padding: 6px;
        }
        .next-chips {
            display: flex;
            gap: 12px;
            justify-content: center;
            font-size: 12px;
            color: #581c87;
        }
        .next-chip-item {
            background: #e9d5ff;
            padding: 4px 10px;
            border-radius: 12px;
            border: 1px solid #a855f7;
        }

        /* ============================================ */
        /* カードデッキ（実際のカードデザイン） */
        /* ============================================ */
        .card-draw-section {
            background: #fff;
            border: 3px solid #059669;
            border-radius: 12px;
            padding: 15px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
        }
        .draw-card-btn {
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
            color: white;
            border: none;
            padding: 20px 40px;
            font-size: 20px;
            font-weight: bold;
            border-radius: 12px;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(5, 150, 105, 0.4);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .draw-card-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(5, 150, 105, 0.5); }
        .draw-card-btn:active { transform: translateY(0); }
        .turn-info { margin-top: 10px; font-size: 14px; color: #059669; font-weight: bold; }

        /* ============================================ */
        /* 会社盤（物理盤風デザイン - 実物再現） */
        /* ============================================ */
        .company-board {
            background: linear-gradient(180deg, #4a7bb7 0%, #3a6aa5 50%, #2d5a8a 100%);
            border-radius: 10px;
            padding: 15px;
            color: #fff;
            box-shadow: 0 6px 20px rgba(0,0,0,0.4), inset 0 1px 0 rgba(255,255,255,0.2);
            border: 4px solid #1e4a7a;
            position: sticky;
            bottom: 10px;
            z-index: 100;
        }
        /* 情報バー（期数・行数・現金・F・自己資本） */
        .board-info-bar {
            display: flex;
            justify-content: space-between;
            gap: 6px;
            margin-bottom: 10px;
            padding: 8px;
            background: linear-gradient(180deg, #1e3a5f 0%, #172554 100%);
            border-radius: 8px;
            border: 2px solid #3b82f6;
        }
        .info-badge {
            flex: 1;
            text-align: center;
            padding: 6px 8px;
            border-radius: 6px;
            background: linear-gradient(180deg, #fff 0%, #e5e7eb 100%);
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .info-badge.period { background: linear-gradient(180deg, #dbeafe 0%, #bfdbfe 100%); border: 2px solid #3b82f6; }
        .info-badge.row { background: linear-gradient(180deg, #dcfce7 0%, #bbf7d0 100%); border: 2px solid #22c55e; }
        .info-badge.cash { background: linear-gradient(180deg, #fef9c3 0%, #fef08a 100%); border: 2px solid #eab308; }
        .info-badge.fixed-cost { background: linear-gradient(180deg, #fee2e2 0%, #fecaca 100%); border: 2px solid #ef4444; cursor: pointer; transition: transform 0.1s; }
        .info-badge.fixed-cost:hover { transform: scale(1.05); box-shadow: 0 4px 8px rgba(239,68,68,0.3); }
        .info-badge.equity { background: linear-gradient(180deg, #e9d5ff 0%, #d8b4fe 100%); border: 2px solid #a855f7; }
        .info-badge-label { display: block; font-size: 9px; color: #374151; font-weight: bold; }
        .info-badge-value { display: block; font-size: 16px; font-weight: bold; color: #1f2937; }
        .info-badge.cash .info-badge-value { color: #854d0e; }
        .info-badge.fixed-cost .info-badge-value { color: #b91c1c; }
        .info-badge.equity .info-badge-value { color: #6b21a8; }

        /* 能力サマリー（製造・販売・価格競争力） */
        .capacity-summary {
            display: flex;
            justify-content: center;
            gap: 12px;
            margin-bottom: 12px;
        }
        .capacity-item {
            background: linear-gradient(180deg, #fff 0%, #f5f5f5 100%);
            border-radius: 6px;
            padding: 6px 14px;
            text-align: center;
            min-width: 65px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
        }
        .capacity-item.mfg { border: 3px solid #f97316; background: linear-gradient(180deg, #fff7ed 0%, #ffedd5 100%); }
        .capacity-item.sales { border: 3px solid #ec4899; background: linear-gradient(180deg, #fdf2f8 0%, #fce7f3 100%); }
        .capacity-item.price { border: 3px solid #3b82f6; background: linear-gradient(180deg, #eff6ff 0%, #dbeafe 100%); }
        .capacity-label { display: block; font-size: 10px; color: #64748b; font-weight: bold; }
        .capacity-value { display: block; font-size: 20px; font-weight: bold; color: #1e293b; }

        /* 生産フロー（材料倉庫→工場→営業所） */
        .production-flow {
            display: flex;
            align-items: stretch;
            gap: 4px;
            margin-bottom: 12px;
        }
        .flow-box {
            flex: 1;
            background: linear-gradient(180deg, #faf5eb 0%, #f5efe5 100%);
            border: 3px solid #8b7355;
            border-radius: 6px;
            padding: 8px 6px;
            text-align: center;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
            position: relative;
        }
        .flow-box.factory {
            background: linear-gradient(180deg, #e8f4fd 0%, #d4e8f8 100%);
            border-color: #4a90c2;
        }
        .flow-box-title {
            font-size: 11px;
            color: #3d3d3d;
            margin-bottom: 6px;
            font-weight: bold;
            background: rgba(255,255,255,0.7);
            padding: 2px 6px;
            border-radius: 3px;
            display: inline-block;
        }
        .flow-box-content { display: flex; flex-wrap: wrap; gap: 3px; justify-content: center; min-height: 35px; align-items: center; }
        /* フロー矢印 */
        .flow-arrow {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 0 2px;
            color: #fff;
        }
        .flow-arrow-icon {
            font-size: 24px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        .flow-arrow-label {
            font-size: 9px;
            background: rgba(255,255,255,0.9);
            color: #1e3a5f;
            padding: 1px 4px;
            border-radius: 3px;
            margin-top: 2px;
            font-weight: bold;
        }

        /* 在庫ブロック */
        .inv-block {
            width: 22px; height: 22px;
            border-radius: 3px;
            display: inline-block;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        .inv-block.material { background: linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%); border: 1px solid #7b3b9b; }
        .inv-block.wip { background: linear-gradient(135deg, #a569bd 0%, #9b59b6 100%); border: 2px dashed #c39bd3; }
        .inv-block.product { background: linear-gradient(135deg, #7d6ee7 0%, #6366f1 100%); border: 1px solid #5651d8; }

        /* 人員・機械セクション */
        .personnel-row {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-bottom: 12px;
        }
        .personnel-box {
            background: linear-gradient(180deg, #faf5eb 0%, #f5efe5 100%);
            border: 2px solid #8b7355;
            border-radius: 6px;
            padding: 8px;
            text-align: center;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
        }
        .personnel-box-title { font-size: 10px; color: #3d3d3d; margin-bottom: 5px; font-weight: bold; }
        .personnel-dots { display: flex; flex-wrap: wrap; gap: 4px; justify-content: center; min-height: 28px; align-items: center; }
        .person-dot {
            width: 26px; height: 26px;
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 10px; color: white; font-weight: bold;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        .person-dot.worker { background: linear-gradient(180deg, #f5deb3 0%, #deb887 100%); color: #5d4037; border: 2px solid #a08060; }
        .person-dot.salesman { background: linear-gradient(180deg, #ff6b6b 0%, #ee5a5a 100%); border: 2px solid #c44; }
        .machine-dot {
            width: 30px; height: 30px;
            background: linear-gradient(180deg, #888 0%, #666 100%);
            border-radius: 4px;
            display: flex; align-items: center; justify-content: center;
            font-size: 9px; color: white;
            border: 2px solid #444;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        .machine-dot.large { background: linear-gradient(180deg, #555 0%, #333 100%); width: 38px; }

        /* チップセクション */
        .chips-row {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 6px;
        }
        .chip-box {
            background: linear-gradient(180deg, #faf5eb 0%, #f5efe5 100%);
            border-radius: 6px;
            padding: 6px 4px;
            text-align: center;
            border: 2px solid #8b7355;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
        }
        .chip-box-title { font-size: 8px; color: #3d3d3d; margin-bottom: 4px; font-weight: bold; }
        .chip-dots { display: flex; gap: 3px; justify-content: center; flex-wrap: wrap; min-height: 20px; align-items: center; }
        .chip { width: 20px; height: 20px; border-radius: 50%; box-shadow: 0 2px 4px rgba(0,0,0,0.3); }
        .chip.research { background: linear-gradient(180deg, #4a90d9 0%, #2e6db4 100%); border: 2px solid #1e4a7a; }
        .chip.education { background: linear-gradient(180deg, #fbbf24 0%, #d69e00 100%); border: 2px solid #9a7000; }
        .chip.advertising { background: linear-gradient(180deg, #ef4444 0%, #c42b2b 100%); border: 2px solid #8b1c1c; }
        .chip.computer { background: linear-gradient(180deg, #22c55e 0%, #16a34a 100%); border: 2px solid #0d7331; }
        .chip.insurance { background: linear-gradient(135deg, #f97316 0%, #ea580c 100%); }

        /* ============================================ */
        /* 市場盤（リアルな七角形デザイン） */
        /* ============================================ */
        .markets-board {
            background: #1a1a1a;
            clip-path: polygon(50% 0%, 93% 25%, 93% 75%, 50% 100%, 7% 75%, 7% 25%);
            padding: 15px;
            min-height: 420px;
            width: 100%;
            max-width: 450px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            box-shadow: 0 8px 30px rgba(0,0,0,0.6), inset 0 2px 20px rgba(255,255,255,0.1);
            position: relative;
        }
        .markets-inner {
            position: relative;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        /* 中央のカードデッキエリア */
        .card-deck-area {
            position: absolute;
            width: 80px;
            height: 80px;
            background: radial-gradient(circle, #8b2424 0%, #5c1a1a 100%);
            border-radius: 50%;
            border: 3px solid #3a0a0a;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 5;
            box-shadow: inset 0 3px 10px rgba(0,0,0,0.5);
        }
        .deck-cards {
            width: 50px;
            height: 60px;
            background: linear-gradient(135deg, #86efac 0%, #4ade80 100%);
            border-radius: 4px;
            border: 2px solid #166534;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 8px;
            font-weight: bold;
            color: #166534;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.4);
            transform: rotate(-5deg);
        }
        /* 市場タイルを円形に配置 */
        .markets-ring {
            position: relative;
            width: 380px;
            height: 380px;
            margin: auto;
        }
        .market-tile {
            position: absolute;
            width: 85px;
            padding: 6px 4px;
            text-align: center;
            border-radius: 6px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.3);
            transition: transform 0.2s, box-shadow 0.2s;
            cursor: pointer;
        }
        .market-tile:hover { transform: scale(1.08); box-shadow: 0 5px 15px rgba(0,0,0,0.4); }
        /* 各市場の位置と色（六角形内に完全収まるよう調整） */
        /* 六角形の頂点付近は狭いため、タイルをより中央寄りに配置 */
        .market-tile.tokyo { top: 12%; left: 50%; transform: translateX(-50%); background: linear-gradient(180deg, #1e40af 0%, #1e3a8a 100%); border: 3px solid #3b82f6; }
        .market-tile.nagoya { top: 28%; right: 12%; background: linear-gradient(180deg, #047857 0%, #065f46 100%); border: 3px solid #10b981; }
        .market-tile.osaka { top: 52%; right: 10%; background: linear-gradient(180deg, #047857 0%, #065f46 100%); border: 3px solid #10b981; }
        .market-tile.fukuoka { bottom: 18%; right: 22%; background: linear-gradient(180deg, #047857 0%, #065f46 100%); border: 3px solid #10b981; }
        .market-tile.overseas { bottom: 18%; left: 22%; background: linear-gradient(180deg, #1e40af 0%, #1e3a8a 100%); border: 3px solid #3b82f6; }
        .market-tile.sapporo { top: 52%; left: 10%; background: linear-gradient(180deg, #047857 0%, #065f46 100%); border: 3px solid #10b981; }
        .market-tile.sendai { top: 28%; left: 12%; background: linear-gradient(180deg, #047857 0%, #065f46 100%); border: 3px solid #10b981; }
        .market-tile.closed { background: linear-gradient(180deg, #4b5563 0%, #374151 100%) !important; border-color: #6b7280 !important; opacity: 0.7; }
        .market-tile.closed .market-name { color: #9ca3af; text-decoration: line-through; }

        /* 販売モード時の市場タイル */
        .markets-board.sales-mode { animation: boardGlow 1.5s ease-in-out infinite; }
        @keyframes boardGlow {
            0%, 100% { box-shadow: 0 8px 30px rgba(0,0,0,0.6), inset 0 2px 20px rgba(255,255,255,0.1), 0 0 30px rgba(251,191,36,0.3); }
            50% { box-shadow: 0 8px 30px rgba(0,0,0,0.6), inset 0 2px 20px rgba(255,255,255,0.1), 0 0 50px rgba(251,191,36,0.6); }
        }
        .markets-board.sales-mode .market-tile:not(.closed):not(.unavailable) {
            animation: tileGlow 1s ease-in-out infinite;
            cursor: pointer;
        }
        @keyframes tileGlow {
            0%, 100% { box-shadow: 0 3px 10px rgba(0,0,0,0.3), 0 0 15px rgba(251,191,36,0.5); }
            50% { box-shadow: 0 3px 10px rgba(0,0,0,0.3), 0 0 25px rgba(251,191,36,0.8); }
        }
        .markets-board.sales-mode .market-tile.unavailable {
            opacity: 0.4;
            cursor: not-allowed;
        }
        .markets-board.sales-mode .market-tile.selected {
            border-color: #8b5cf6 !important;
            box-shadow: 0 0 20px rgba(139,92,246,0.8), 0 0 40px rgba(139,92,246,0.4) !important;
            animation: selectedGlow 1s ease-in-out infinite !important;
        }
        @keyframes selectedGlow {
            0%, 100% { box-shadow: 0 0 20px rgba(139,92,246,0.8), 0 0 40px rgba(139,92,246,0.4); }
            50% { box-shadow: 0 0 30px rgba(139,92,246,1), 0 0 60px rgba(139,92,246,0.6); }
        }
        /* 購入モード時の市場タイル */
        .markets-board.buy-mode { animation: boardGlowBlue 1.5s ease-in-out infinite; }
        @keyframes boardGlowBlue {
            0%, 100% { box-shadow: 0 8px 30px rgba(0,0,0,0.6), inset 0 2px 20px rgba(255,255,255,0.1), 0 0 30px rgba(34,197,94,0.3); }
            50% { box-shadow: 0 8px 30px rgba(0,0,0,0.6), inset 0 2px 20px rgba(255,255,255,0.1), 0 0 50px rgba(34,197,94,0.6); }
        }
        .markets-board.buy-mode .market-tile:not(.closed):not(.unavailable) {
            animation: tileGlowBlue 1s ease-in-out infinite;
            cursor: pointer;
        }
        @keyframes tileGlowBlue {
            0%, 100% { box-shadow: 0 3px 10px rgba(0,0,0,0.3), 0 0 15px rgba(34,197,94,0.5); }
            50% { box-shadow: 0 3px 10px rgba(0,0,0,0.3), 0 0 25px rgba(34,197,94,0.8); }
        }
        .markets-board.buy-mode .market-tile.unavailable {
            opacity: 0.4;
            cursor: not-allowed;
        }
        /* インストラクションオーバーレイ */
        .market-instruction {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(180deg, #fef3c7 0%, #fde68a 100%);
            border: 3px solid #f59e0b;
            border-radius: 12px;
            padding: 12px 25px;
            font-size: 16px;
            font-weight: bold;
            color: #78350f;
            z-index: 1000;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            display: flex;
            align-items: center;
            gap: 15px;
            animation: slideDown 0.3s ease-out;
        }
        .market-instruction.buy-mode {
            background: linear-gradient(180deg, #dcfce7 0%, #bbf7d0 100%);
            border-color: #22c55e;
            color: #166534;
        }
        @keyframes slideDown {
            from { transform: translateX(-50%) translateY(-100%); opacity: 0; }
            to { transform: translateX(-50%) translateY(0); opacity: 1; }
        }
        .cancel-mode-btn {
            background: #dc2626;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: background 0.2s;
        }
        .cancel-mode-btn:hover { background: #b91c1c; }
        .market-name { font-size: 14px; font-weight: bold; color: #ffffff; margin-bottom: 4px; text-shadow: 0 2px 4px rgba(0,0,0,0.9), 0 0 10px rgba(0,0,0,0.7), 1px 1px 2px #000; }
        .market-volume { font-size: 10px; color: #fef08a; text-shadow: 0 1px 2px rgba(0,0,0,0.8); margin-top: 2px; }
        .market-prices { display: flex; justify-content: center; gap: 4px; margin: 4px 0; }
        .price-badge {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            font-size: 11px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        .price-badge.buy { background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%); color: white; }
        .price-badge.sell { background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white; }
        .market-stock {
            display: flex;
            flex-wrap: wrap;
            gap: 2px;
            justify-content: center;
            min-height: 18px;
            background: rgba(255,255,255,0.15);
            border-radius: 4px;
            padding: 3px;
        }
        .stock-cube { width: 12px; height: 12px; background: linear-gradient(135deg, #a78bfa 0%, #8b5cf6 100%); border-radius: 2px; box-shadow: 0 1px 2px rgba(0,0,0,0.3); }

        /* ============================================ */
        /* F（固定費）内訳パネル */
        /* ============================================ */
        .fixed-cost-panel {
            background: linear-gradient(135deg, #7c2d12 0%, #9a3412 100%);
            border-radius: 12px;
            padding: 12px;
            color: #fff;
        }
        .panel-title { font-size: 14px; font-weight: bold; margin-bottom: 8px; color: #fed7aa; }
        .cost-breakdown { font-size: 12px; color: #fef3c7; }
        .cost-item { display: flex; justify-content: space-between; padding: 3px 0; border-bottom: 1px solid rgba(255,255,255,0.1); color: #fef3c7; }
        .cost-item:last-child { border-bottom: none; }
        .cost-total { font-weight: bold; color: #fbbf24; margin-top: 5px; padding-top: 5px; border-top: 2px solid rgba(255,255,255,0.3); }

        /* ============================================ */
        /* 他社一覧 */
        /* ============================================ */
        .other-companies-section {
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            border-radius: 12px;
            padding: 12px;
        }
        .other-companies-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; }
        .other-company-card {
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
            padding: 8px;
            font-size: 11px;
        }
        .other-company-card.current-turn { background: rgba(251, 191, 36, 0.2); border: 1px solid #fbbf24; }
        .other-company-card .company-name { font-weight: bold; font-size: 12px; }
        .other-company-card .company-cash { color: #4ade80; }
        .other-company-card .mini-inv { display: flex; gap: 4px; margin-top: 4px; }
        .other-company-card .mini-block { width: 12px; height: 12px; border-radius: 2px; }
        .other-company-card .mini-block.m { background: #7c3aed; }
        .other-company-card .mini-block.w { background: #8b5cf6; }
        .other-company-card .mini-block.p { background: #6366f1; }
        
        /* 市場セクション */
        .markets-section { background: white; border-radius: 8px; padding: 15px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .section-title { font-size: 16px; font-weight: bold; margin-bottom: 12px; padding-bottom: 8px; border-bottom: 2px solid #e9ecef; color: #2c3e50; }
        .market-card { background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 6px; padding: 10px; margin-bottom: 8px; }
        .market-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .market-name { font-weight: bold; font-size: 14px; color: #ffffff; text-shadow: 0 2px 4px rgba(0,0,0,0.9), 0 0 10px rgba(0,0,0,0.7); }
        .market-prices { display: flex; gap: 8px; }
        .price-tag { padding: 2px 6px; border-radius: 3px; font-size: 12px; font-weight: bold; }
        .price-tag.buy { background: #28a745; color: white; }
        .price-tag.sell { background: #dc3545; color: white; }
        .market-stock-info { display: flex; justify-content: space-between; align-items: center; }
        .market-stock { display: flex; gap: 2px; flex-wrap: wrap; min-height: 24px; padding: 4px; background: white; border-radius: 4px; flex: 1; }
        .stock-block { width: 18px; height: 18px; background: #7c3aed; border-radius: 2px; }
        .stock-count { font-size: 12px; color: #666; margin-left: 10px; font-weight: bold; }
        
        /* 会社セクション */
        .companies-section { background: white; border-radius: 8px; padding: 15px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .company-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 12px; }
        .company-card { border: 2px solid #dee2e6; border-radius: 6px; padding: 12px; background: #f8f9fa; }
        .company-card.player { border-color: #007bff; background: #e7f3ff; }
        .company-card.current-turn { border-color: #ffc107; box-shadow: 0 0 0 3px rgba(255, 193, 7, 0.25); }
        .company-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .company-name { font-weight: bold; font-size: 14px; color: #2c3e50; }
        .company-cash { background: #28a745; color: white; padding: 3px 8px; border-radius: 4px; font-size: 12px; font-weight: bold; }
        .company-stats { display: grid; grid-template-columns: repeat(2, 1fr); gap: 6px; margin-bottom: 8px; font-size: 12px; }
        .stat-item { background: white; padding: 4px 6px; border-radius: 3px; }
        .stat-item.capacity { background: #e7f3ff; font-weight: bold; }
        .personnel-section { display: flex; gap: 10px; margin-bottom: 8px; font-size: 12px; }
        .personnel-group { display: flex; align-items: center; gap: 4px; }
        .personnel-label { color: #666; font-size: 11px; }
        .personnel-dots { display: flex; gap: 2px; }
        .personnel-dot { width: 8px; height: 8px; background: #6c757d; border-radius: 50%; }
        
        /* 在庫セクション */
        .inventory-section { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 8px; }
        .inventory-box { background: white; border: 1px solid #dee2e6; border-radius: 4px; padding: 6px; }
        .inventory-label { font-size: 10px; color: #666; margin-bottom: 4px; text-align: center; }
        .inventory-blocks { display: flex; gap: 2px; flex-wrap: wrap; min-height: 20px; justify-content: center; }
        .inventory-block { width: 12px; height: 12px; border-radius: 2px; }
        .inventory-block.material { background: #7c3aed; }
        .inventory-block.wip { background: #8b5cf6; }
        .inventory-block.product { background: #7c3aed; }
        
        /* 機械表示 */
        .machine-section { margin-bottom: 8px; font-size: 11px; }
        .machine-item { background: white; padding: 3px 6px; border-radius: 3px; margin-bottom: 3px; display: inline-block; margin-right: 4px; }
        
        /* 倉庫表示 */
        .warehouse-section { margin-bottom: 8px; font-size: 11px; }
        .warehouse-item { background: #ffd700; padding: 3px 6px; border-radius: 3px; margin-bottom: 3px; display: inline-block; margin-right: 4px; color: #333; }
        
        .chips-section { margin-top: 8px; padding-top: 8px; border-top: 1px solid #dee2e6; font-size: 11px; }
        .chip-row { display: flex; align-items: center; gap: 4px; margin-bottom: 3px; }
        .chip-label { width: 80px; color: #6c757d; }
        .chip-dots { display: flex; gap: 3px; }
        .chip-dot { width: 14px; height: 14px; border-radius: 50%; border: 1px solid #dee2e6; }
        .chip-dot.filled.computer { background: #10b981; }
        .chip-dot.filled.insurance { background: #f97316; }
        .chip-dot.filled.research { background: #3b82f6; }
        .chip-dot.filled.education { background: #eab308; }
        .chip-dot.filled.advertising { background: #ef4444; }
        
        /* アクションボタン */
        .action-section { background: white; border-radius: 8px; padding: 15px; margin-top: 15px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .action-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 8px; }
        .action-btn { padding: 10px; border: none; border-radius: 6px; font-size: 13px; font-weight: bold; cursor: pointer; transition: all 0.2s; }
        .action-btn.primary { background: #007bff; color: white; }
        .action-btn.primary:hover { background: #0056b3; transform: translateY(-1px); }
        .action-btn.secondary { background: #6c757d; color: white; }
        .action-btn.secondary:hover { background: #545b62; }
        .action-btn.danger { background: #dc3545; color: white; }
        .action-btn.success { background: #28a745; color: white; }
        .action-btn.warning { background: #ffc107; color: black; }
        .action-btn.main { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; font-size: 16px; padding: 15px; }
        .action-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        
        /* カード選択画面 */
        .card-choice-container { text-align: center; padding: 20px; }
        .card-choice-btn { margin: 10px; padding: 20px 40px; font-size: 18px; border-radius: 10px; }
        
        /* モーダル（リッチなデザイン） */
        .modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 1000; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        .modal.active { display: flex; animation: fadeIn 0.2s ease-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .modal-content {
            background: linear-gradient(180deg, #ffffff 0%, #f1f5f9 100%);
            border-radius: 20px;
            padding: 0;
            max-width: 500px;
            width: 94%;
            max-height: 85vh;
            overflow: hidden;
            box-shadow: 0 25px 80px rgba(0,0,0,0.4), 0 0 0 1px rgba(255,255,255,0.1);
            animation: slideUp 0.3s ease-out;
        }
        @keyframes slideUp { from { transform: translateY(30px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 18px 24px;
            background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%);
            color: white;
        }
        .modal-title { font-size: 20px; font-weight: bold; color: #fff; text-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        .modal-body { padding: 24px; overflow-y: auto; max-height: calc(85vh - 140px); }
        .close-btn { background: rgba(255,255,255,0.2); color: white; border: 2px solid rgba(255,255,255,0.3); padding: 8px 16px; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: bold; transition: all 0.2s; }
        .close-btn:hover { background: rgba(255,255,255,0.3); transform: scale(1.05); }
        .form-group { margin-bottom: 20px; }
        .form-label { display: block; margin-bottom: 10px; font-size: 15px; font-weight: bold; color: #1e293b; }
        .form-control { width: 100%; padding: 14px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 16px; background: #fff; transition: all 0.2s; }
        .form-control:focus { outline: none; border-color: #3b82f6; box-shadow: 0 0 0 4px rgba(59,130,246,0.15); }
        .submit-btn { width: 100%; padding: 16px; background: linear-gradient(135deg, #059669 0%, #047857 100%); color: white; border: none; border-radius: 12px; font-size: 18px; font-weight: bold; cursor: pointer; box-shadow: 0 4px 15px rgba(5, 150, 105, 0.4); transition: all 0.2s; }
        .submit-btn:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(5, 150, 105, 0.5); }
        .submit-btn:active { transform: translateY(0); }
        .cancel-btn { width: 100%; padding: 16px; background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%); color: white; border: none; border-radius: 12px; font-size: 18px; font-weight: bold; cursor: pointer; box-shadow: 0 4px 15px rgba(107, 114, 128, 0.4); transition: all 0.2s; }
        .cancel-btn:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(107, 114, 128, 0.5); }
        .cancel-btn:active { transform: translateY(0); }

        /* アクションボタン（カード風） */
        .action-cards { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-top: 15px; }
        .action-card {
            background: linear-gradient(180deg, #fff 0%, #f8fafc 100%);
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 16px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        .action-card:hover { border-color: #3b82f6; transform: translateY(-3px); box-shadow: 0 8px 20px rgba(59,130,246,0.2); }
        .action-card-icon { font-size: 28px; margin-bottom: 8px; }
        .action-card-title { font-weight: bold; color: #1e293b; font-size: 14px; }
        .action-card-desc { font-size: 11px; color: #64748b; margin-top: 4px; }

        /* 内訳表示（改善） */
        .breakdown-list { background: linear-gradient(180deg, #f8fafc 0%, #f1f5f9 100%); border-radius: 12px; padding: 16px; margin-top: 15px; border: 2px solid #e2e8f0; }
        .breakdown-item { display: flex; justify-content: space-between; padding: 10px 12px; border-radius: 8px; margin-bottom: 6px; background: #fff; }
        .breakdown-item:last-child { margin-bottom: 0; }
        .breakdown-item-label { color: #475569; font-weight: 500; }
        .breakdown-item-value { color: #1e293b; font-weight: bold; }
        .breakdown-total { font-weight: bold; color: #dc2626; padding: 12px; margin-top: 10px; background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%); border-radius: 10px; display: flex; justify-content: space-between; border: 2px solid #fca5a5; }

        /* AI行動表示 */
        .ai-action-display {
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
            border-radius: 12px;
            padding: 16px;
            color: #fff;
            margin-bottom: 15px;
        }
        .ai-action-header { font-size: 14px; color: #94a3b8; margin-bottom: 8px; }
        .ai-action-content { font-size: 16px; font-weight: bold; }
        
        /* 意思決定カードオーバーレイ */
        .decision-overlay {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1000;
            background: linear-gradient(180deg, #064e3b 0%, #065f46 100%);
            border: 4px solid #fbbf24;
            border-radius: 20px;
            padding: 20px;
            max-width: 420px;
            width: 94%;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5), 0 0 0 8px rgba(251,191,36,0.2);
            animation: cardAppear 0.3s ease-out;
        }
        @keyframes cardAppear { from { transform: translate(-50%, -50%) scale(0.8); opacity: 0; } to { transform: translate(-50%, -50%) scale(1); opacity: 1; } }
        .decision-header {
            text-align: center;
            padding-bottom: 15px;
            border-bottom: 2px solid rgba(251,191,36,0.3);
            margin-bottom: 15px;
        }
        .decision-title { font-size: 22px; font-weight: bold; color: #fbbf24; margin: 0; text-shadow: 0 2px 4px rgba(0,0,0,0.3); }
        .decision-subtitle { font-size: 13px; color: #a7f3d0; margin-top: 5px; }
        .decision-stats { display: flex; justify-content: center; gap: 20px; margin-top: 10px; }
        .decision-stat {
            background: rgba(255,255,255,0.1);
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            color: #fff;
        }
        .decision-stat-value { font-weight: bold; color: #fbbf24; }
        .decision-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
        .decision-grid .decision-btn:last-child:nth-child(odd) { grid-column: 1 / -1; }  /* 最後のアイテムが奇数個目なら全幅 */
        .decision-btn {
            background: linear-gradient(180deg, #fff 0%, #f0fdf4 100%);
            border: 3px solid transparent;
            border-radius: 12px;
            padding: 14px 10px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }
        .decision-btn:hover { transform: translateY(-3px); box-shadow: 0 8px 20px rgba(0,0,0,0.3); border-color: #fbbf24; }
        .decision-btn:active { transform: translateY(0); }
        .decision-btn-icon { font-size: 28px; margin-bottom: 6px; }
        .decision-btn-text { font-size: 13px; font-weight: bold; color: #1e293b; }
        .decision-btn.sell { background: linear-gradient(180deg, #fef3c7 0%, #fde68a 100%); }
        .decision-btn.buy { background: linear-gradient(180deg, #dbeafe 0%, #bfdbfe 100%); }
        .decision-btn.produce { background: linear-gradient(180deg, #d1fae5 0%, #a7f3d0 100%); }
        .decision-btn.hire { background: linear-gradient(180deg, #fce7f3 0%, #fbcfe8 100%); }
        .decision-btn.machine { background: linear-gradient(180deg, #e5e7eb 0%, #d1d5db 100%); }
        .decision-btn.strategy { background: linear-gradient(180deg, #e9d5ff 0%, #d8b4fe 100%); }
        .decision-btn.skip { background: linear-gradient(180deg, #6b7280 0%, #4b5563 100%); }
        .decision-btn.skip .decision-btn-text { color: #fff; }

        /* AI行動表示モーダル */
        .ai-action-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1000;
            background: linear-gradient(180deg, #1e3a5f 0%, #0f172a 100%);
            border: 3px solid #3b82f6;
            border-radius: 16px;
            padding: 20px;
            min-width: 320px;
            max-width: 90%;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
            animation: aiActionAppear 0.4s ease-out;
        }
        @keyframes aiActionAppear {
            from { transform: translate(-50%, -50%) scale(0.8) translateY(20px); opacity: 0; }
            to { transform: translate(-50%, -50%) scale(1) translateY(0); opacity: 1; }
        }
        .ai-action-header {
            display: flex;
            align-items: center;
            gap: 12px;
            padding-bottom: 12px;
            border-bottom: 2px solid rgba(59,130,246,0.3);
            margin-bottom: 15px;
        }
        .ai-action-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(180deg, #3b82f6 0%, #1d4ed8 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            border: 3px solid #60a5fa;
        }
        .ai-action-company-info { flex: 1; }
        .ai-action-company-name { font-size: 18px; font-weight: bold; color: #fbbf24; }
        .ai-action-company-cash { font-size: 13px; color: #4ade80; }
        .ai-action-body { text-align: center; padding: 15px 0; }
        .ai-action-icon { font-size: 48px; margin-bottom: 10px; }
        .ai-action-type { font-size: 20px; font-weight: bold; color: #fff; margin-bottom: 8px; }
        .ai-action-detail { font-size: 14px; color: #94a3b8; line-height: 1.5; }
        .ai-action-result {
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            padding: 12px;
            margin-top: 15px;
        }
        .ai-action-result-row {
            display: flex;
            justify-content: space-between;
            padding: 4px 0;
            color: #e2e8f0;
            font-size: 13px;
        }
        .ai-action-result-row.highlight { color: #4ade80; font-weight: bold; }
        .ai-action-continue-btn {
            width: 100%;
            margin-top: 15px;
            padding: 12px;
            background: linear-gradient(180deg, #3b82f6 0%, #1d4ed8 100%);
            color: #fff;
            border: none;
            border-radius: 10px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
        }
        .ai-action-continue-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(59,130,246,0.4); }

        /* リスクカード表示 */
        .risk-display {
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
            color: white;
            padding: 24px;
            border-radius: 16px;
            text-align: center;
            margin: 10px 0;
            box-shadow: 0 8px 30px rgba(220,38,38,0.4);
            border: 3px solid #fca5a5;
        }
        .risk-badge { display: inline-block; background: rgba(255,255,255,0.2); padding: 4px 12px; border-radius: 20px; font-size: 12px; margin-bottom: 10px; }
        .risk-title { font-weight: bold; font-size: 24px; margin-bottom: 12px; text-shadow: 0 2px 4px rgba(0,0,0,0.3); }
        .risk-description { font-size: 16px; line-height: 1.5; background: rgba(255,255,255,0.1); padding: 12px; border-radius: 8px; }

        /* 入札表示（改善） */
        .bid-display {
            background: linear-gradient(180deg, #eff6ff 0%, #dbeafe 100%);
            border: 3px solid #3b82f6;
            border-radius: 16px;
            padding: 20px;
            margin: 10px 0;
        }
        .bid-title { font-weight: bold; color: #1e40af; margin-bottom: 15px; font-size: 18px; }
        .bid-entries { display: grid; gap: 8px; }
        .bid-entry { display: flex; justify-content: space-between; padding: 10px 12px; background: white; border-radius: 8px; border: 2px solid #e2e8f0; }
        .bid-winner { background: linear-gradient(180deg, #d1fae5 0%, #a7f3d0 100%); font-weight: bold; border-color: #22c55e; }
        
        /* ============================================ */
        /* レスポンシブデザイン（スマホ優先） */
        /* ============================================ */

        /* スマホ向け（480px以下） - 最優先 */
        @media (max-width: 480px) {
            .container { padding: 5px; }
            .header { padding: 6px; margin-bottom: 6px; }
            .period-info { gap: 4px; flex-wrap: wrap; }
            .info-item { padding: 4px 8px; }
            .info-label { font-size: 10px; }
            .info-value { font-size: 12px; }

            /* スマホ：縦積みレイアウト */
            .center-area { flex-direction: column; }
            .other-companies-left,
            .other-companies-right { flex-direction: row; justify-content: center; flex-wrap: wrap; }
            .market-center { max-width: 100%; }

            .card-draw-section { padding: 10px; }
            .draw-card-btn { padding: 15px 30px; font-size: 16px; }

            .company-board { padding: 8px; }
            .board-title { font-size: 14px; padding: 4px; }
            .production-flow { gap: 4px; }
            .flow-box { padding: 6px; }
            .flow-box-title { font-size: 10px; }
            .inv-block { width: 16px; height: 16px; }

            .personnel-row { gap: 4px; }
            .personnel-box { padding: 6px; }
            .personnel-box-title { font-size: 10px; }
            .person-dot { width: 20px; height: 20px; font-size: 10px; }
            .machine-dot { width: 24px; height: 24px; font-size: 9px; }

            .chips-row { gap: 3px; }
            .chip-box { padding: 4px; }
            .chip-box-title { font-size: 9px; }
            .chip { width: 14px; height: 14px; }

            /* スマホ用市場盤調整 */
            .markets-board {
                padding: 10px;
                min-height: 320px;
                max-width: 340px;
            }
            .markets-ring {
                width: 300px;
                height: 300px;
            }
            .market-tile {
                padding: 4px 3px;
                width: 68px;
            }
            .market-name { font-size: 10px; }
            .market-volume { font-size: 9px; }
            .price-badge { font-size: 8px; padding: 1px 3px; }
            .stock-cube { width: 8px; height: 8px; }
            .card-deck-area { width: 50px; height: 50px; }
            .deck-cards { font-size: 7px; }

            .fixed-cost-panel { padding: 8px; }
            .panel-title { font-size: 12px; }
            .cost-breakdown { font-size: 11px; }

            /* 手元エリア：スマホでは縦積み */
            .player-area { grid-template-columns: 1fr; }

            /* 他社会社盤：スマホ用調整 */
            .other-company-board {
                min-width: 145px;
                max-width: 160px;
                padding: 5px;
                font-size: 10px;
            }
            .other-company-board .board-title { font-size: 11px; }

            /* ミニ表示用 */
            .other-company-mini { min-width: 60px; padding: 4px 6px; }
            .other-company-mini .oc-name { font-size: 10px; }
            .other-company-mini .oc-cash { font-size: 10px; }

            /* モーダル - スマホ最適化 */
            .modal-content { width: 95%; max-height: 90vh; padding: 12px; }
            .modal-title { font-size: 16px; }
            .form-control { font-size: 16px; padding: 12px; }
            .submit-btn { padding: 15px; font-size: 16px; }
            .decision-options { grid-template-columns: 1fr; gap: 8px; }

            /* トースト調整 */
            .toast {
                min-width: 260px;
                max-width: 90vw;
                font-size: 12px;
                padding: 12px 16px;
            }
        }

        /* タブレット向け（481px〜768px） */
        @media (min-width: 481px) and (max-width: 768px) {
            .markets-grid { grid-template-columns: repeat(4, 1fr); }
            .market-center { max-width: 380px; }
            .player-area { grid-template-columns: 1fr 200px; }

            /* タブレット用市場盤調整 */
            .markets-board {
                min-height: 360px;
                max-width: 400px;
            }
            .markets-ring {
                width: 340px;
                height: 340px;
            }
            .market-tile {
                width: 78px;
            }

            /* 他社会社盤 */
            .other-company-board {
                min-width: 160px;
                max-width: 180px;
            }
        }

        /* PC向け（769px以上） */
        @media (min-width: 769px) {
            .market-center { max-width: 450px; }
            .markets-grid { grid-template-columns: repeat(4, 1fr); }
            .player-area { grid-template-columns: 1fr 250px; }
            .other-company-mini { min-width: 100px; }
        }

        /* タッチデバイス用のタップ領域拡大 */
        @media (hover: none) and (pointer: coarse) {
            .draw-card-btn { min-height: 50px; }
            .close-btn { min-width: 44px; min-height: 44px; }
            input[type="number"], input[type="text"], select {
                min-height: 44px;
                font-size: 16px;
            }
        }
    </style>
</head>
<body>
    <!-- トースト通知コンテナ -->
    <div id="toastContainer" class="toast-container"></div>

    <div class="container">
        <!-- ゲームエリア：市場盤中央、他社周囲 -->
        <div class="game-area">
            <!-- 上部：他社（1-3） -->
            <div class="other-companies-top" id="otherCompaniesTop"></div>

            <!-- 中央エリア：左の他社 | 市場盤+カードデッキ | 右の他社 -->
            <div class="center-area">
                <!-- 左の他社 -->
                <div class="other-companies-left" id="otherCompaniesLeft"></div>

                <!-- 市場盤（中央）とカードデッキ -->
                <div class="market-center">
                    <div class="card-draw-section" id="cardDrawSection">
                        <button class="draw-card-btn" onclick="drawCard()">カードを引く</button>
                        <div class="turn-info" id="turnInfo">あなたのターンです</div>
                    </div>
                    <div class="markets-board">
                        <div class="markets-inner">
                            <div class="card-deck-area">
                                <div class="deck-cards">DECISION</div>
                            </div>
                            <div class="markets-ring" id="marketsDisplay"></div>
                        </div>
                    </div>
                </div>

                <!-- 右の他社 -->
                <div class="other-companies-right" id="otherCompaniesRight"></div>
            </div>
        </div>

        <!-- 手元エリア：プレイヤーの会社盤 + 固定費 + 次繰盤 -->
        <div class="player-area-wrapper">
        <div class="player-area">
            <!-- 会社盤（大きく表示） -->
            <div class="company-board" id="companyBoard">
                <!-- 情報バー -->
                <div class="board-info-bar">
                    <div class="info-badge period">
                        <span class="info-badge-label">期</span>
                        <span class="info-badge-value" id="currentPeriod">2</span>
                    </div>
                    <div class="info-badge row">
                        <span class="info-badge-label">行</span>
                        <span class="info-badge-value" id="currentRow">2/20</span>
                    </div>
                    <div class="info-badge cash">
                        <span class="info-badge-label">現金</span>
                        <span class="info-badge-value" id="playerCash">¥112</span>
                    </div>
                    <div class="info-badge fixed-cost" onclick="showFixedCostModal()">
                        <span class="info-badge-label">F</span>
                        <span class="info-badge-value" id="fixedCostDisplay">¥0</span>
                    </div>
                    <div class="info-badge equity">
                        <span class="info-badge-label">自己資本</span>
                        <span class="info-badge-value" id="equity">¥283</span>
                    </div>
                </div>

                <!-- 能力サマリー -->
                <div class="capacity-summary" id="capacitySummary">
                    <div class="capacity-item mfg">
                        <span class="capacity-label">製造</span>
                        <span class="capacity-value" id="mfgCapacityDisplay">1</span>
                    </div>
                    <div class="capacity-item sales">
                        <span class="capacity-label">販売</span>
                        <span class="capacity-value" id="salesCapacityDisplay">2</span>
                    </div>
                    <div class="capacity-item price">
                        <span class="capacity-label">価格</span>
                        <span class="capacity-value" id="priceCompDisplay">+0</span>
                    </div>
                </div>

                <!-- 生産フロー -->
                <div class="production-flow">
                    <div class="flow-box">
                        <div class="flow-box-title">材料倉庫</div>
                        <div class="flow-box-content" id="materialsDisplay"></div>
                    </div>
                    <div class="flow-arrow">
                        <span class="flow-arrow-icon">→</span>
                        <span class="flow-arrow-label">投入</span>
                    </div>
                    <div class="flow-box factory">
                        <div class="flow-box-title">工場（仕掛品）</div>
                        <div class="flow-box-content" id="wipDisplay"></div>
                    </div>
                    <div class="flow-arrow">
                        <span class="flow-arrow-icon">→</span>
                        <span class="flow-arrow-label">完成</span>
                    </div>
                    <div class="flow-box">
                        <div class="flow-box-title">営業所（製品）</div>
                        <div class="flow-box-content" id="productsDisplay"></div>
                    </div>
                </div>

                <!-- 人員・機械 -->
                <div class="personnel-row">
                    <div class="personnel-box">
                        <div class="personnel-box-title">ワーカー</div>
                        <div class="personnel-dots" id="workersDisplay"></div>
                    </div>
                    <div class="personnel-box">
                        <div class="personnel-box-title">機械</div>
                        <div class="personnel-dots" id="machinesDisplay"></div>
                    </div>
                    <div class="personnel-box">
                        <div class="personnel-box-title">セールスマン</div>
                        <div class="personnel-dots" id="salesmenDisplay"></div>
                    </div>
                </div>

                <!-- チップ -->
                <div class="chips-row">
                    <div class="chip-box">
                        <div class="chip-box-title">研究</div>
                        <div class="chip-dots" id="researchChipsDisplay"></div>
                    </div>
                    <div class="chip-box">
                        <div class="chip-box-title">教育</div>
                        <div class="chip-dots" id="educationChipsDisplay"></div>
                    </div>
                    <div class="chip-box">
                        <div class="chip-box-title">広告</div>
                        <div class="chip-dots" id="advertisingChipsDisplay"></div>
                    </div>
                    <div class="chip-box">
                        <div class="chip-box-title">PC</div>
                        <div class="chip-dots" id="computerChipsDisplay"></div>
                    </div>
                    <div class="chip-box">
                        <div class="chip-box-title">保険</div>
                        <div class="chip-dots" id="insuranceChipsDisplay"></div>
                    </div>
                </div>
            </div>

            <!-- F内訳パネル -->
            <div class="fixed-cost-panel">
                <div class="panel-title">F内訳</div>
                <div class="cost-breakdown" id="fixedCostBreakdown"></div>
            </div>

            <!-- 次繰盤（3期以降のみ表示） -->
            <div class="next-period-board" id="nextPeriodBoard" style="display: none;">
                <div class="board-title" style="background: #6b21a8;">次繰盤</div>
                <div class="next-period-content">
                    <div class="next-chips">
                        <span class="next-chip-item">研究: <span id="nextResearch">0</span></span>
                        <span class="next-chip-item">教育: <span id="nextEducation">0</span></span>
                        <span class="next-chip-item">広告: <span id="nextAdvertising">0</span></span>
                    </div>
                </div>
            </div>
        </div>
        </div> <!-- player-area-wrapper -->
    </div>

    <div id="modalContainer"></div>
    
    <script>
// MG Game Ultimate Edition - Complete Implementation
const gameState = {
    currentPeriod: 2,
    currentRow: 2,  // 2期は期首処理後2行目から開始（廃止予定）
    maxRows: 20,  // 現在の期の行数上限
    maxRowsByPeriod: {2: 20, 3: 30, 4: 34, 5: 35},  // 各期の行数上限
    currentPlayerIndex: 0,
    turnOrder: [],
    skipTurns: {},
    doNothingCount: {},
    usedRiskCards: [],
    usedDecisionCards: [],
    reverseOrder: false,
    turnReversed: false,  // 景気変動による逆回り
    periodStarted: false,
    waitingForBids: false,
    currentBids: [],
    bidMarkets: [],

    // 行動ログ（期末に表示）
    actionLog: [],  // {companyIndex, companyName, action, details, cashBefore, cashAfter, rowUsed}
    playerSoldInBid: null,  // 入札での販売成功フラグ

    // 市場選択モード
    salesMode: false,  // 販売モード（市場タップで販売）
    buyMode: false,    // 購入モード（市場タップで材料購入）
    twoMarketMode: false,  // 2市場販売モード ('simultaneous' or 'separate' or false)
    selectedMarkets: [],   // 2市場販売で選択された市場インデックス
    pendingSeparateBids: null, // 別々販売の入札キュー

    // 3期以降のサイコロ結果
    diceRoll: null,  // 1-6の値
    wageMultiplier: 1.0,  // 人件費倍率（1.1または1.2）
    osakaMaxPrice: 24,  // 大阪上限価格（21-26）

    // カードデッキ（75枚：60枚意思決定 + 15枚リスク）
    cardDeck: [],
    deckInitialized: false,
    
    markets: [
        {name: '仙台', buyPrice: 10, sellPrice: 40, maxStock: 3, currentStock: 3, needsBid: true},
        {name: '札幌', buyPrice: 11, sellPrice: 36, maxStock: 4, currentStock: 4, needsBid: true},
        {name: '福岡', buyPrice: 12, sellPrice: 32, maxStock: 6, currentStock: 6, needsBid: true},
        {name: '名古屋', buyPrice: 13, sellPrice: 28, maxStock: 9, currentStock: 9, needsBid: true},
        {name: '大阪', buyPrice: 14, sellPrice: 24, maxStock: 13, currentStock: 13, needsBid: true},
        {name: '東京', buyPrice: 15, sellPrice: 20, maxStock: 20, currentStock: 20, needsBid: false},
        {name: '海外', buyPrice: 16, sellPrice: 16, maxStock: 100, currentStock: 45, needsBid: false}
    ],
    
    decisionCards: [
        {id: 1, name: '商品販売', description: '製品を市場に販売'},
        {id: 2, name: '材料購入', description: '材料を市場から購入'},
        {id: 3, name: '完成・投入', description: '材料→仕掛品→製品'},
        {id: 4, name: '採用', description: '人材を採用（最大3名）'},
        {id: 5, name: '設備投資', description: '機械を購入'},
        {id: 6, name: 'チップ購入', description: '研究・教育・広告チップ'},
        {id: 7, name: 'DO NOTHING', description: '何もしない（行消費なし）'}
    ],
    
    // リスクカード（64枚のPDFに基づく正確な実装が必要）
    // 注：材料暴落は存在しないカード
    riskCards: [
        {id: 1, name: 'クレーム発生', description: '本社経費▲5', type: 'cost'},
        {id: 2, name: 'クレーム発生', description: '本社経費▲5', type: 'cost'},
        {id: 3, name: '教育成功', description: '教育チップを持っていれば1個32円で販売（販売能力の範囲内、最高5個まで、仕入れ可）', type: 'benefit'},
        {id: 4, name: '教育成功', description: '教育チップを持っていれば1個32円で販売（販売能力の範囲内、最高5個まで、仕入れ可）', type: 'benefit'},
        {id: 5, name: '消費者運動発生', description: '商品の販売はできません（材料購入、完成・投入、DO NOTHINGは可能）', type: 'cost'},
        {id: 6, name: '消費者運動発生', description: '商品の販売はできません（材料購入、完成・投入、DO NOTHINGは可能）', type: 'cost'},
        {id: 7, name: '得意先倒産', description: '現金▲30（特別損失）', type: 'cost', period2Exempt: true},
        {id: 8, name: '得意先倒産', description: '現金▲30（特別損失）', type: 'cost', period2Exempt: true},
        {id: 9, name: '研究開発失敗', description: '青チップ1枚返却（まず会社盤から、なければ次繰盤から）', type: 'cost'},
        {id: 10, name: '研究開発失敗', description: '青チップ1枚返却（まず会社盤から、なければ次繰盤から）', type: 'cost'},
        {id: 11, name: '研究開発失敗', description: '青チップ1枚返却（まず会社盤から、なければ次繰盤から）', type: 'cost'},
        {id: 12, name: '広告成功', description: '赤チップ1枚につき2個まで空いた市場へ独占販売可能（最高5個まで、仕入れ可）', type: 'benefit'},
        {id: 13, name: '広告成功', description: '赤チップ1枚につき2個まで空いた市場へ独占販売可能（最高5個まで、仕入れ可）', type: 'benefit'},
        {id: 14, name: '広告成功', description: '赤チップ1枚につき2個まで空いた市場へ独占販売可能（最高5個まで、仕入れ可）', type: 'benefit'},
        {id: 15, name: '労災発生', description: '生産活動はできません（材料購入、商品販売・入札、DO NOTHINGは可能）', type: 'cost'},
        {id: 16, name: '労災発生', description: '生産活動はできません（材料購入、商品販売・入札、DO NOTHINGは可能）', type: 'cost'},
        {id: 17, name: '広告政策失敗', description: '赤チップ1枚返却（まず会社盤から、なければ次繰盤から）', type: 'cost'},
        {id: 18, name: '広告政策失敗', description: '赤チップ1枚返却（まず会社盤から、なければ次繰盤から）', type: 'cost'},
        {id: 19, name: '特別サービス', description: '材料購入→1個10で5個まで or 広告の特別サービス1個20で2個まで可', type: 'benefit'},
        {id: 20, name: '特別サービス', description: '材料購入→1個10で5個まで or 広告の特別サービス1個20で2個まで可', type: 'benefit'},
        {id: 21, name: '返品発生', description: 'ストッカーから商品1個を営業所に戻し、売上欄に（▲1個、▲20）と記入', type: 'cost', period2Exempt: true},
        {id: 22, name: '返品発生', description: 'ストッカーから商品1個を営業所に戻し、売上欄に（▲1個、▲20）と記入', type: 'cost', period2Exempt: true},
        {id: 23, name: '返品発生', description: 'ストッカーから商品1個を営業所に戻し、売上欄に（▲1個、▲20）と記入', type: 'cost', period2Exempt: true},
        {id: 24, name: 'コンピュータートラブル', description: '製造経費▲10', type: 'cost'},
        {id: 25, name: 'コンピュータートラブル', description: '製造経費▲10', type: 'cost'},
        {id: 26, name: '商品の独占販売', description: 'セールスマン1人につき2個まで売れる 1個32でストッカーへ（最高5個まで 仕入れ可）', type: 'benefit'},
        {id: 27, name: '商品の独占販売', description: 'セールスマン1人につき2個まで売れる 1個32でストッカーへ（最高5個まで 仕入れ可）', type: 'benefit'},
        {id: 28, name: '商品の独占販売', description: 'セールスマン1人につき2個まで売れる 1個32でストッカーへ（最高5個まで 仕入れ可）', type: 'benefit'},
        {id: 29, name: '製造ミス発生', description: '仕掛品1個をストッカーへ', type: 'cost'},
        {id: 30, name: '製造ミス発生', description: '仕掛品1個をストッカーへ', type: 'cost'},
        {id: 31, name: '倉庫火災', description: '材料を全てストッカーへ 保険に加入していれば1個8の保険金が受け取れる（再加入5）', type: 'cost'},
        {id: 32, name: '倉庫火災', description: '材料を全てストッカーへ 保険に加入していれば1個8の保険金が受け取れる（再加入5）', type: 'cost'},
        {id: 33, name: '縁故採用', description: '本社経費▲5', type: 'cost'},
        {id: 34, name: '縁故採用', description: '本社経費▲5', type: 'cost'},
        {id: 35, name: '研究開発成功', description: '青チップ1枚につき2個まで売れる 1個32でストッカーへ（販売能力の範囲内、最高5個まで 仕入れ不可）', type: 'benefit'},
        {id: 36, name: '研究開発成功', description: '青チップ1枚につき2個まで売れる 1個32でストッカーへ（販売能力の範囲内、最高5個まで 仕入れ不可）', type: 'benefit'},
        {id: 37, name: '研究開発成功', description: '青チップ1枚につき2個まで売れる 1個32でストッカーへ（販売能力の範囲内、最高5個まで 仕入れ不可）', type: 'benefit'},
        {id: 38, name: '研究開発成功', description: '青チップ1枚につき2個まで売れる 1個32でストッカーへ（販売能力の範囲内、最高5個まで 仕入れ不可）', type: 'benefit'},
        {id: 39, name: '研究開発成功', description: '青チップ1枚につき2個まで売れる 1個32でストッカーへ（販売能力の範囲内、最高5個まで 仕入れ不可）', type: 'benefit'},
        {id: 40, name: '研究開発成功', description: '青チップ1枚につき2個まで売れる 1個32でストッカーへ（販売能力の範囲内、最高5個まで 仕入れ不可）', type: 'benefit'},
        {id: 41, name: '各社共通', description: '3個までを1個12で購入可（まず市場から、不足分はストッカーから）', type: 'special'},
        {id: 42, name: '各社共通', description: '3個までを1個12で購入可（まず市場から、不足分はストッカーから）', type: 'special'},
        {id: 43, name: 'ストライキ発生', description: '1回休み', type: 'cost'},
        {id: 44, name: 'ストライキ発生', description: '1回休み', type: 'cost'},
        {id: 45, name: '盗難発見', description: '商品を2個ストッカーへ 保険に加入していれば1個10の保険金が受け取れる（再加入5）', type: 'cost'},
        {id: 46, name: '盗難発見', description: '商品を2個ストッカーへ 保険に加入していれば1個10の保険金が受け取れる（再加入5）', type: 'cost'},
        {id: 47, name: '長期労務紛争', description: '2回休み', type: 'cost'},
        {id: 48, name: '長期労務紛争', description: '2回休み', type: 'cost'},
        {id: 49, name: '設計トラブル発生', description: '製造経費▲10', type: 'cost'},
        {id: 50, name: '設計トラブル発生', description: '製造経費▲10', type: 'cost'},
        {id: 51, name: 'ワーカー退職', description: '労務費▲5', type: 'cost'},
        {id: 52, name: 'ワーカー退職', description: '労務費▲5', type: 'cost'},
        {id: 53, name: '景気変動', description: '逆回り', type: 'special'},
        {id: 54, name: '景気変動', description: '逆回り', type: 'special'},
        {id: 55, name: '教育失敗', description: '黄チップ1枚返却（まず会社盤から、なければ次繰盤から）', type: 'cost'},
        {id: 56, name: '教育失敗', description: '黄チップ1枚返却（まず会社盤から、なければ次繰盤から）', type: 'cost'},
        {id: 57, name: 'セールスマン退職', description: '本社人件費▲5', type: 'cost'},
        {id: 58, name: 'セールスマン退職', description: '本社人件費▲5', type: 'cost'},
        {id: 59, name: '社長、病気で倒れる', description: '1回休み', type: 'cost'},
        {id: 60, name: '社長、病気で倒れる', description: '1回休み', type: 'cost'},
        {id: 61, name: '不良在庫発生', description: '総在庫が20個を超えるものは全てストッカーへ 1個10の保険金（製品から順に）', type: 'cost'},
        {id: 62, name: '不良在庫発生', description: '総在庫が20個を超えるものは全てストッカーへ 1個10の保険金（製品から順に）', type: 'cost'},
        {id: 63, name: '機械故障', description: '製造経費▲5', type: 'cost'},
        {id: 64, name: '機械故障', description: '製造経費▲5', type: 'cost'}
    ],
    
    companies: []
};

// Handle cash shortage - first sell materials, then short-term loan
// Returns object with details of actions taken
function handleCashShortage(company, neededAmount) {
    let shortage = neededAmount - company.cash;
    if (shortage <= 0) return { materialsSold: 0, loanAmount: 0 };

    let materialsSold = 0;
    let materialRevenue = 0;

    // First, sell materials at ¥10 each to overseas market
    if (company.materials > 0 && shortage > 0) {
        const materialsToSell = Math.min(company.materials, Math.ceil(shortage / 10));
        materialsSold = materialsToSell;
        materialRevenue = materialsToSell * 10;
        company.materials -= materialsToSell;
        company.cash += materialRevenue;

        // Add to overseas market stock
        const overseasMarket = gameState.markets.find(m => m.name === '海外');
        if (overseasMarket) {
            overseasMarket.currentStock += materialsToSell;
        }

        shortage = neededAmount - company.cash;
    }

    let loanAmount = 0;

    // If still not enough, take short-term loan
    if (shortage > 0) {
        // Short-term loan: receive 80% of loan amount
        loanAmount = Math.ceil(shortage / 0.8 / 50) * 50;
        company.shortLoans += loanAmount;
        company.cash += loanAmount * 0.8;
    }

    return { materialsSold, materialRevenue, loanAmount };
}

// Initialize companies (6人: プレイヤー1人 + AI 5人、ランダム戦略)
function initializeCompanies() {
    // AI戦略をランダムに選択
    const strategies = ['aggressive', 'balanced', 'conservative', 'price_focused', 'tech_focused', 'unpredictable'];
    const shuffledStrategies = strategies.sort(() => Math.random() - 0.5);

    const companyNames = ['青山商事', '鈴木産業', '田中製作所', '山本工業', '佐藤物産'];

    const companyTypes = [
        {name: 'あなた', type: 'player', strategy: 'player'},
        ...companyNames.map((name, i) => ({
            name: name,
            type: 'ai',
            strategy: shuffledStrategies[i % shuffledStrategies.length]
        }))
    ];
    
    // 2期開始: 137円 → 期首処理（コンピュータ20円+保険5円=25円）→ 112円で2行目スタート
    gameState.companies = companyTypes.map(ct => ({
        name: ct.name,
        type: ct.type,
        strategy: ct.strategy || ct.type,  // strategyまたはtypeを使用
        cash: 112,  // 2期開始時の現金（期首処理後: 137-25=112）
        equity: 283,
        loans: 0,
        shortLoans: 0,
        currentRow: 2,  // 期首処理で1行使用済み、2行目からスタート
        materials: 1,  // 2期開始時の初期在庫
        wip: 2,         // 2期開始時の初期在庫
        products: 1,    // 2期開始時の初期在庫
        workers: 1,
        salesmen: 1,
        machines: [{type: 'small', attachments: 0}],
        warehouses: 0,  // 無災害倉庫の数（0, 1, or 2）
        warehouseLocation: 'materials',  // 1個の場合の設置場所 ('materials' or 'products')
        chips: {
            computer: 1,  // 期首処理で購入済み
            insurance: 1, // 期首処理で購入済み
            research: 0,
            education: 0,
            advertising: 0
        },
        nextPeriodChips: {
            research: 0,
            education: 0,
            advertising: 0
        },
        carriedOverChips: {  // 前期から繰り越したチップ（F計算で20円/枚）
            research: 0,
            education: 0,
            advertising: 0
        },
        periodStartInventory: {
            materials: 1,
            wip: 2,
            products: 1
        },
        skipTurns: 0,
        rowsUsed: 0,
        decisionCard: null,
        totalSales: 0,  // PQ計算用
        totalMaterialCost: 0,  // VQ計算用
        totalProductionCost: 0,  // VQ計算用
        extraLaborCost: 0,  // 追加人件費（退職、縁故採用、倉庫等）
        retiredWorkers: 0,  // 期中に退職したワーカー数（0.5名として給料計算）
        retiredSalesmen: 0,  // 期中に退職したセールスマン数（0.5名として給料計算）
        maxPersonnel: 2,  // 期中最大人員（期首=ワーカー1+セールスマン1）
        hasExceeded300: false,  // 自己資本が¥300を超えたことがあるか
        pendingTax: 0,  // 次期期首に支払う税金
        pendingDividend: 0,  // 次期期首に支払う配当
        aiStrategy: ct.type
    }));
}

// Calculate manufacturing capacity
function getManufacturingCapacity(company) {
    let baseMachineCapacity = 0;
    company.machines.forEach(machine => {
        if (machine.type === 'small') {
            baseMachineCapacity += machine.attachments > 0 ? 2 : 1;
        } else if (machine.type === 'large') {
            baseMachineCapacity += 4;
        }
    });
    
    // ワーカーが0人なら製造能力0
    if (company.workers === 0) {
        return 0;
    }
    
    // 機械台数とワーカー人数をチェック
    const machineCount = company.machines.length;
    if (company.workers < machineCount) {
        // ワーカーが機械台数より少ない場合、ワーカー人数が上限
        return company.workers;
    }
    
    // 機械能力の計算
    // 基本機械能力 + コンピュータチップ(+1) + 教育チップ(+1)
    let manufacturingCapacity = baseMachineCapacity + (company.chips.computer || 0);
    
    // 教育チップで製造能力+1（効果は常に1枚分が上限）
    const educationBonus = Math.min(company.chips.education || 0, 1);
    manufacturingCapacity += educationBonus;
    
    return manufacturingCapacity;
}

// Calculate sales capacity
function getSalesCapacity(company) {
    // セールスマン0人なら販売能力0（教育チップがあっても無効）
    if (company.salesmen === 0) {
        return 0;
    }

    // セールスマン×2
    const baseCapacity = company.salesmen * 2;

    // 広告チップ効果（1枚につき+2、セールスマン1人につき2枚まで有効）
    const effectiveAdChips = Math.min(company.chips.advertising || 0, company.salesmen * 2);
    const adBonus = effectiveAdChips * 2;

    // 基本販売能力
    let salesCapacity = baseCapacity + adBonus;

    // 教育チップで販売能力+1（効果は常に1枚分が上限）
    const educationBonus = Math.min(company.chips.education || 0, 1);
    salesCapacity += educationBonus;

    return salesCapacity;
}

// 材料置場の容量を取得（倉庫位置に基づく）
function getMaterialCapacity(company) {
    const baseCapacity = 10;
    const warehouseBonus = 12;

    if (company.warehouses === 0) {
        return baseCapacity;
    } else if (company.warehouses === 1) {
        // 1個の場合、warehouseLocationに基づく
        return company.warehouseLocation === 'materials' ? baseCapacity + warehouseBonus : baseCapacity;
    } else {
        // 2個の場合、両方に設置
        return baseCapacity + warehouseBonus;
    }
}

// 製品置場の容量を取得（倉庫位置に基づく）
function getProductCapacity(company) {
    const baseCapacity = 10;
    const warehouseBonus = 12;

    if (company.warehouses === 0) {
        return baseCapacity;
    } else if (company.warehouses === 1) {
        // 1個の場合、warehouseLocationに基づく
        return company.warehouseLocation === 'products' ? baseCapacity + warehouseBonus : baseCapacity;
    } else {
        // 2個の場合、両方に設置
        return baseCapacity + warehouseBonus;
    }
}

// 材料が火災から保護されているか（無災害倉庫が材料置場にある）
function isMaterialProtectedFromFire(company) {
    if (company.warehouses === 0) return false;
    if (company.warehouses === 1) {
        return company.warehouseLocation === 'materials';
    }
    return true;  // 2個の場合は両方に設置
}

// 製品が盗難から保護されているか（無災害倉庫が製品置場にある）
function isProductProtectedFromTheft(company) {
    if (company.warehouses === 0) return false;
    if (company.warehouses === 1) {
        return company.warehouseLocation === 'products';
    }
    return true;  // 2個の場合は両方に設置
}

// 行動ログを記録する関数
function logAction(companyIndex, action, details, cashChange = 0, rowUsed = false) {
    const company = gameState.companies[companyIndex];
    gameState.actionLog.push({
        companyIndex: companyIndex,
        companyName: company.name,
        action: action,
        details: details,
        cashChange: cashChange,  // 正=収入、負=支出
        rowUsed: rowUsed,
        row: company.currentRow,
        timestamp: Date.now()
    });
}

// 行動ログをリセット（期の開始時）
function resetActionLog() {
    gameState.actionLog = [];
}

// 行動ログを表示するモーダル
function showActionLogModal() {
    const companies = gameState.companies;

    let content = `
        <div style="max-height: 70vh; overflow-y: auto; padding: 10px;">
            <div style="text-align: center; margin-bottom: 15px;">
                <div style="font-size: 20px; font-weight: bold;">第${gameState.currentPeriod}期 行動ログ</div>
            </div>
    `;

    // 各会社ごとにログをまとめる
    for (let i = 0; i < companies.length; i++) {
        const company = companies[i];
        const companyLogs = gameState.actionLog.filter(log => log.companyIndex === i);
        const emoji = i === 0 ? '👤' : ['🅰️', '🅱️', '©️', '🇩', '🇪'][i - 1] || '🏢';
        const bgColor = i === 0 ? '#eff6ff' : '#f9fafb';

        content += `
            <div style="background: ${bgColor}; border-radius: 10px; padding: 12px; margin-bottom: 12px; border: 1px solid #e5e7eb;">
                <div style="display: flex; align-items: center; margin-bottom: 10px; border-bottom: 1px solid #e5e7eb; padding-bottom: 8px;">
                    <span style="font-size: 24px; margin-right: 10px;">${emoji}</span>
                    <span style="font-weight: bold; font-size: 16px; color: ${i === 0 ? '#2563eb' : '#374151'};">${company.name}</span>
                    <span style="margin-left: auto; font-size: 12px; color: #666;">使用行数: ${company.currentRow - 1}</span>
                </div>
        `;

        if (companyLogs.length === 0) {
            content += `<div style="color: #999; font-size: 12px; padding: 5px;">行動記録なし</div>`;
        } else {
            content += '<div style="font-size: 12px;">';
            companyLogs.forEach((log, idx) => {
                const cashStr = log.cashChange !== 0
                    ? `<span style="color: ${log.cashChange > 0 ? '#16a34a' : '#dc2626'}; font-weight: bold;">${log.cashChange > 0 ? '+' : ''}¥${log.cashChange}</span>`
                    : '';
                const rowStr = log.rowUsed ? `<span style="color: #9333ea; margin-left: 5px;">【1行】</span>` : '';

                content += `
                    <div style="display: flex; align-items: flex-start; padding: 4px 0; ${idx < companyLogs.length - 1 ? 'border-bottom: 1px dashed #e5e7eb;' : ''}">
                        <span style="color: #9ca3af; width: 25px; flex-shrink: 0;">${log.row}行</span>
                        <span style="color: #374151; flex: 1;">${log.action}: ${log.details}</span>
                        <span style="min-width: 70px; text-align: right;">${cashStr}${rowStr}</span>
                    </div>
                `;
            });
            content += '</div>';
        }

        // 総計
        const totalIncome = companyLogs.filter(l => l.cashChange > 0).reduce((sum, l) => sum + l.cashChange, 0);
        const totalExpense = companyLogs.filter(l => l.cashChange < 0).reduce((sum, l) => sum + l.cashChange, 0);
        content += `
            <div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid #d1d5db; display: flex; justify-content: space-between; font-size: 11px;">
                <span style="color: #16a34a;">収入計: +¥${totalIncome}</span>
                <span style="color: #dc2626;">支出計: ¥${totalExpense}</span>
                <span style="font-weight: bold;">差引: ¥${totalIncome + totalExpense}</span>
            </div>
        `;

        content += '</div>';
    }

    content += `
        </div>
        <button class="submit-btn" onclick="closeModal()">閉じる</button>
    `;

    showModal('行動ログ', content);
}

// Get price competitiveness
function getPriceCompetitiveness(company, companyIndex = null) {
    // companyIndexが渡されない場合は、companiesから検索
    if (companyIndex === null) {
        companyIndex = gameState.companies.indexOf(company);
    }
    
    // 親（現在のターンプレイヤー）は追加で2円の価格競争力
    const isParent = (companyIndex === gameState.currentPlayerIndex);
    const parentBonus = isParent ? 2 : 0;
    return (company.chips.research * 2) + parentBonus;  // 研究チップ1枚につき2円 + 親ボーナス
}

// Calculate salary costs (給料)
function calculateSalaryCost(company, period) {
    let cost = 0;

    // 基本単価（サイコロによる変動は3期以降）
    const baseCost = {2: 22, 3: 24, 4: 26, 5: 28};
    let unitCost = baseCost[period];
    let halfCost = Math.round(unitCost / 2);

    // 3期以降はサイコロで単価変動
    if (period >= 3 && gameState.wageMultiplier > 1) {
        unitCost = Math.round(baseCost[period] * gameState.wageMultiplier);
        halfCost = Math.round(unitCost / 2);
    }

    // 機械台数 × 単価
    const machineCount = company.machines.length;
    cost += machineCount * unitCost;

    // ワーカー（現在 + 退職者0.5）× 単価
    const effectiveWorkers = company.workers + (company.retiredWorkers || 0) * 0.5;
    cost += effectiveWorkers * unitCost;

    // セールスマン（現在 + 退職者0.5）× 単価
    const effectiveSalesmen = company.salesmen + (company.retiredSalesmen || 0) * 0.5;
    cost += effectiveSalesmen * unitCost;

    // 期中最大人員 × 半額単価
    const maxPersonnel = company.maxPersonnel || (company.workers + company.salesmen);
    cost += maxPersonnel * halfCost;

    return Math.round(cost);
}

// Calculate depreciation
function calculateDepreciation(company, period) {
    let cost = 0;
    
    company.machines.forEach(machine => {
        if (machine.type === 'small') {
            if (machine.attachments > 0) {
                // 小型+アタッチメント
                cost += period === 2 ? 13 : 26;
            } else {
                // 小型のみ
                cost += period === 2 ? 10 : 20;
            }
        } else if (machine.type === 'large') {
            // 大型
            cost += period === 2 ? 20 : 40;
        }
    });
    
    return cost;
}

// Calculate period end payment (期末支払)
function calculatePeriodPayment(company, useEndOfPeriod = false) {
    const period = gameState.currentPeriod;
    let payment = 0;

    // 給料（期末計算時は期末時点の人数を使用）
    if (useEndOfPeriod && company.endOfPeriodStats) {
        // 期末時点の人数・機械台数で計算
        const baseCost = {2: 22, 3: 24, 4: 26, 5: 28};
        let unitCost = baseCost[period] || 22;
        if (period >= 3 && gameState.wageMultiplier > 1) {
            unitCost = Math.round(baseCost[period] * gameState.wageMultiplier);
        }
        const halfCost = Math.round(unitCost / 2);

        payment += company.endOfPeriodStats.machines * unitCost;
        payment += company.endOfPeriodStats.workers * unitCost;
        payment += company.endOfPeriodStats.salesmen * unitCost;
        payment += (company.endOfPeriodStats.workers + company.endOfPeriodStats.salesmen) * halfCost;
    } else {
        payment += calculateSalaryCost(company, period);
    }
    
    // 長期借入返済（元本の10%以上）
    if (company.loans > 0) {
        payment += Math.floor(company.loans * 0.1);
    }
    
    // 短期借入返済（元本の20%以上）
    if (company.shortLoans > 0) {
        payment += Math.floor(company.shortLoans * 0.2);
    }
    
    return payment;
}

// Calculate chip costs
function calculateChipCost(company, period) {
    let cost = 0;
    
    // コンピュータ・保険
    cost += (company.chips.computer || 0) * 20;
    cost += (company.chips.insurance || 0) * 5;
    
    // 戦略チップ
    if (period === 2) {
        // 2期は各1枚分のみ固定費
        if (company.chips.research > 0) cost += 20;
        if (company.chips.education > 0) cost += 20;
        if (company.chips.advertising > 0) cost += 20;
    } else {
        // 3期以降
        cost += (company.chips.research || 0) * 40;  // 特急
        cost += (company.chips.education || 0) * 40; // 特急
        cost += (company.chips.advertising || 0) * 40; // 特急
        cost += (company.nextPeriodChips?.research || 0) * 20; // 繰越
        cost += (company.nextPeriodChips?.education || 0) * 20; // 繰越
        cost += (company.nextPeriodChips?.advertising || 0) * 20; // 繰越
    }
    
    return cost;
}

// Calculate fixed costs total (固定費合計 - 簡易表示用)
function calculateFixedCostTotal(company, period) {
    return calculateFixedCost(company);
}

// Calculate fixed costs (固定費) - 税金除外
function calculateFixedCost(company) {
    const period = gameState.currentPeriod;
    let cost = 0;

    // 給料（人件費）
    cost += calculateSalaryCost(company, period);

    // 借入金利（Fに含める）
    // 長期借入：10%
    cost += Math.round((company.loans || 0) * 0.10);
    // 短期借入：20%
    cost += Math.round((company.shortLoans || 0) * 0.20);

    // コンピュータ・保険費用
    cost += (company.chips.computer || 0) * 20;
    cost += (company.chips.insurance || 0) * 5;

    // 戦略チップ費用
    const carriedOver = company.carriedOverChips || {research: 0, education: 0, advertising: 0};

    if (period === 2) {
        // 2期：各種1枚だけ返却 → 各種最大20円のみ
        if (company.chips.research > 0) cost += 20;  // 1枚分のみ
        if (company.chips.education > 0) cost += 20;  // 1枚分のみ
        if (company.chips.advertising > 0) cost += 20; // 1枚分のみ
    } else {
        // 3-5期：繰り越し分は20円、今期購入（特急）は40円
        // 繰り越しチップ（前期から持ち越し）= 20円/枚
        cost += (carriedOver.research || 0) * 20;
        cost += (carriedOver.education || 0) * 20;
        cost += (carriedOver.advertising || 0) * 20;

        // 今期特急購入分（chips - carriedOver）= 40円/枚
        const urgentResearch = Math.max(0, (company.chips.research || 0) - (carriedOver.research || 0));
        const urgentEducation = Math.max(0, (company.chips.education || 0) - (carriedOver.education || 0));
        const urgentAdvertising = Math.max(0, (company.chips.advertising || 0) - (carriedOver.advertising || 0));
        cost += urgentResearch * 40;
        cost += urgentEducation * 40;
        cost += urgentAdvertising * 40;

        // 次期繰り越し分（来期用に購入）= 20円/枚
        cost += (company.nextPeriodChips?.research || 0) * 20;
        cost += (company.nextPeriodChips?.education || 0) * 20;
        cost += (company.nextPeriodChips?.advertising || 0) * 20;
    }

    // 減価償却費
    cost += calculateDepreciation(company, period);

    // 機械故障による追加固定費
    if (company.additionalFixedCost) {
        cost += company.additionalFixedCost;
    }

    // リスクカード費用（追加固定費として計上済み）

    // 倉庫費用（無災害倉庫は購入時のみ20円、期末費用なし）

    // 追加人件費（採用費、退職、縁故採用、倉庫購入など）
    cost += company.extraLaborCost || 0;

    return cost;
}

// Calculate VQ (変動費総額)
function calculateVQ(company) {
    // VQ = 材料購入金額 + 完成投入費用 + (期首在庫評価額 - 期末在庫評価額)
    // ※ 在庫が増えた分はコストではない、在庫が減った分がコストになる

    // ①材料購入費（期中の合計）
    const materialCost = company.totalMaterialCost || 0;

    // ②完成・投入費（期中の合計）
    const productionCost = company.totalProductionCost || 0;

    // ③期首在庫評価額（元の材料価値）
    // 材料:13円、仕掛品:14円、製品:15円
    const startInventoryValue = (company.periodStartInventory.materials * 13) +
                               (company.periodStartInventory.wip * 14) +
                               (company.periodStartInventory.products * 15);

    // ④期末在庫評価額（今の材料価値）
    const endInventoryValue = (company.materials * 13) +
                             (company.wip * 14) +
                             (company.products * 15);

    // VQ = ①+②+(③-④)
    return materialCost + productionCost + startInventoryValue - endInventoryValue;
}

// Show period payment breakdown
function showPeriodPaymentBreakdown() {
    const company = gameState.companies[0];
    const period = gameState.currentPeriod;
    
    let html = '<div class="breakdown-list">';
    
    // 給料の詳細内訳
    if (company.endOfPeriodStats) {
        // 期末時点の人数・機械台数を使用
        const stats = company.endOfPeriodStats;

        // 基本単価（サイコロによる変動は3期以降）
        const baseCost = {2: 22, 3: 24, 4: 26, 5: 28};
        let unitCost = baseCost[period] || 22;
        if (period >= 3 && gameState.wageMultiplier > 1) {
            unitCost = Math.round(baseCost[period] * gameState.wageMultiplier);
        }
        const halfCost = Math.round(unitCost / 2);

        const machineCost = stats.machines * unitCost;
        const workerCost = stats.workers * unitCost;
        const salesmanCost = stats.salesmen * unitCost;
        const personnelCost = (stats.workers + stats.salesmen) * halfCost;

        html += `<div class="breakdown-item"><span>【給料内訳】</span><span></span></div>`;
        html += `<div class="breakdown-item"><span>　機械費 (${stats.machines}台×¥${unitCost})</span><span>¥${machineCost}</span></div>`;
        html += `<div class="breakdown-item"><span>　ワーカー給料 (${stats.workers}人×¥${unitCost})</span><span>¥${workerCost}</span></div>`;
        html += `<div class="breakdown-item"><span>　セールスマン給料 (${stats.salesmen}人×¥${unitCost})</span><span>¥${salesmanCost}</span></div>`;
        html += `<div class="breakdown-item"><span>　人員合計費 (${stats.workers + stats.salesmen}人×¥${halfCost})</span><span>¥${personnelCost}</span></div>`;
        html += `<div class="breakdown-item"><span>給料合計</span><span>¥${machineCost + workerCost + salesmanCost + personnelCost}</span></div>`;
    } else {
        // 通常の給料計算
        const salaryCost = calculateSalaryCost(company, period);
        html += `<div class="breakdown-item"><span>給料</span><span>¥${salaryCost}</span></div>`;
    }
    
    // 長期借入返済
    if (company.loans > 0) {
        const loanPayment = Math.floor(company.loans * 0.1);
        html += `<div class="breakdown-item"><span>長期借入返済 (¥${company.loans}×10%)</span><span>¥${loanPayment}</span></div>`;
    }
    
    // 短期借入返済
    if (company.shortLoans > 0) {
        const shortLoanPayment = Math.floor(company.shortLoans * 0.2);
        html += `<div class="breakdown-item"><span>短期借入返済 (¥${company.shortLoans}×20%)</span><span>¥${shortLoanPayment}</span></div>`;
    }
    
    const total = calculatePeriodPayment(company, company.endOfPeriodStats ? true : false);
    html += `<div class="breakdown-item breakdown-total"><span>合計</span><span>¥${total}</span></div>`;
    html += '</div>';
    
    showModal('期末支払内訳', html);
}

// Show fixed cost breakdown
function showFixedCostBreakdown() {
    const company = gameState.companies[0];
    const period = gameState.currentPeriod;
    
    let html = '<div class="breakdown-list">';
    
    // 給料
    const salaryCost = calculateSalaryCost(company, period);
    html += `<div class="breakdown-item"><span>給料</span><span>¥${salaryCost}</span></div>`;
    
    // コンピュータ・保険
    if (company.chips.computer > 0) {
        html += `<div class="breakdown-item"><span>コンピュータ(${company.chips.computer}枚)</span><span>¥${company.chips.computer * 20}</span></div>`;
    }
    
    if (company.chips.insurance > 0) {
        html += `<div class="breakdown-item"><span>保険(${company.chips.insurance}枚)</span><span>¥${company.chips.insurance * 5}</span></div>`;
    }
    
    // 戦略チップ
    if (period === 2) {
        if (company.chips.research > 0) html += `<div class="breakdown-item"><span>研究(1枚分)</span><span>¥20</span></div>`;
        if (company.chips.education > 0) html += `<div class="breakdown-item"><span>教育(1枚分)</span><span>¥20</span></div>`;
        if (company.chips.advertising > 0) html += `<div class="breakdown-item"><span>広告(1枚分)</span><span>¥20</span></div>`;
    } else {
        if (company.chips.research > 0) html += `<div class="breakdown-item"><span>研究・特急(${company.chips.research}枚)</span><span>¥${company.chips.research * 40}</span></div>`;
        if (company.chips.education > 0) html += `<div class="breakdown-item"><span>教育・特急(${company.chips.education}枚)</span><span>¥${company.chips.education * 40}</span></div>`;
        if (company.chips.advertising > 0) html += `<div class="breakdown-item"><span>広告・特急(${company.chips.advertising}枚)</span><span>¥${company.chips.advertising * 40}</span></div>`;
        if (company.nextPeriodChips?.research > 0) html += `<div class="breakdown-item"><span>研究・繰越(${company.nextPeriodChips.research}枚)</span><span>¥${company.nextPeriodChips.research * 20}</span></div>`;
        if (company.nextPeriodChips?.education > 0) html += `<div class="breakdown-item"><span>教育・繰越(${company.nextPeriodChips.education}枚)</span><span>¥${company.nextPeriodChips.education * 20}</span></div>`;
        if (company.nextPeriodChips?.advertising > 0) html += `<div class="breakdown-item"><span>広告・繰越(${company.nextPeriodChips.advertising}枚)</span><span>¥${company.nextPeriodChips.advertising * 20}</span></div>`;
    }
    
    // 減価償却費
    const depreciationCost = calculateDepreciation(company, period);
    if (depreciationCost > 0) {
        html += `<div class="breakdown-item"><span>減価償却費</span><span>¥${depreciationCost}</span></div>`;
    }
    
    const total = calculateFixedCost(company);
    html += `<div class="breakdown-item breakdown-total"><span>合計</span><span>¥${total}</span></div>`;
    html += '</div>';
    
    showModal('固定費内訳', html);
}

// Start period
function startPeriod() {
    if (gameState.periodStarted) return;
    
    let content = `
        <div class="decision-card">
            <h3>第${gameState.currentPeriod}期開始</h3>
            <p>期首処理を行います</p>
        </div>
    `;
    
    // 3期以降は借入と無災害倉庫の選択
    if (gameState.currentPeriod >= 3) {
        const company = gameState.companies[0];
        // 借入上限：3期は0.5倍、4期以降で自己資本300超なら1倍
        const loanMultiplier = (gameState.currentPeriod >= 4 && company.equity > 300) ? 1.0 : 0.5;
        const maxLoanTotal = Math.round(company.equity * loanMultiplier);
        const availableLoan = Math.max(0, maxLoanTotal - company.loans);
        const loanRuleText = (gameState.currentPeriod >= 4 && company.equity > 300)
            ? `自己資本の1倍まで（300超のため）`
            : `自己資本の0.5倍まで`;

        content += `
            <div class="form-group">
                <label class="form-label">長期借入（${loanRuleText}）</label>
                <div style="font-size: 11px; color: #666; margin-bottom: 5px;">
                    上限: ¥${maxLoanTotal} - 既存借入¥${company.loans} = 追加可能¥${availableLoan}
                </div>
                <select id="loanAmount" class="form-control">
                    <option value="0">借りない</option>
                    ${availableLoan >= 50 ? '<option value="50">¥50</option>' : ''}
                    ${availableLoan >= 100 ? '<option value="100">¥100</option>' : ''}
                    ${availableLoan >= 150 ? '<option value="150">¥150</option>' : ''}
                    ${availableLoan >= 200 ? '<option value="200">¥200</option>' : ''}
                    ${availableLoan >= 250 ? '<option value="250">¥250</option>' : ''}
                    ${availableLoan >= 300 ? '<option value="300">¥300</option>' : ''}
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">無災害倉庫（¥20/個、容量12）</label>
                <select id="warehouseCount" class="form-control">
                    <option value="0">買わない</option>
                    <option value="1">1個買う</option>
                    <option value="2">2個買う</option>
                </select>
            </div>
        `;
    }
    
    content += `
        <div class="form-group">
            <label class="form-label">コンピュータチップ（生産+1）</label>
            <div>価格: ¥20/個（期首は1個限定）</div>
            <select id="computerChips" class="form-control">
                <option value="0">0個</option>
                <option value="1" selected>1個</option>
            </select>
        </div>
        <div class="form-group">
            <label class="form-label">保険チップ（災害対策）</label>
            <div>価格: ¥5/個（期首は1個限定）</div>
            <select id="insuranceChips" class="form-control">
                <option value="0">0個</option>
                <option value="1" selected>1個</option>
            </select>
        </div>
        <button class="submit-btn" onclick="processPeriodStart()">期首処理を完了</button>
    `;
    
    showModal('期首処理', content);
}

// Process period start
function processPeriodStart() {
    const company = gameState.companies[0];
    let totalCost = 0;

    // 納税・配当の支払い（前期決算分）
    const playerTax = company.pendingTax || 0;
    const playerDividend = company.pendingDividend || 0;
    const taxDividendTotal = playerTax + playerDividend;

    if (taxDividendTotal > 0) {
        // プレイヤーに通知
        alert(`【納税・配当の支払い】\n税金: ¥${playerTax}\n配当: ¥${playerDividend}\n合計: ¥${taxDividendTotal}`);
    }

    // 全社の納税・配当を処理
    gameState.companies.forEach(c => {
        const payment = (c.pendingTax || 0) + (c.pendingDividend || 0);
        if (payment > 0) {
            c.cash -= payment;
            console.log(`${c.name}: 納税¥${c.pendingTax || 0} + 配当¥${c.pendingDividend || 0} = ¥${payment}`);

            // 現金不足の場合は短期借入
            if (c.cash < 0) {
                const needed = Math.ceil(Math.abs(c.cash) / 0.8 / 50) * 50;
                c.shortLoans += needed;
                c.cash += needed * 0.8;
            }

            c.pendingTax = 0;
            c.pendingDividend = 0;
        }
    });

    // 借入処理（3期以降）
    if (gameState.currentPeriod >= 3) {
        const loanAmount = parseInt(document.getElementById('loanAmount')?.value || 0);
        if (loanAmount > 0) {
            const interest = Math.floor(loanAmount * 0.1);
            company.cash += loanAmount - interest;  // 利息を引いた額が入金
            company.loans += loanAmount;
            console.log(`長期借入: ¥${loanAmount} (利息¥${interest}支払い済み)`);
        }
        
        // 無災害倉庫購入
        const warehouseCount = parseInt(document.getElementById('warehouseCount')?.value || 0);
        if (warehouseCount > 0) {
            totalCost += warehouseCount * 20;
            company.warehouses += warehouseCount;
            company.extraLaborCost = (company.extraLaborCost || 0) + (warehouseCount * 20);  // 人件費（機械経費）
        }
    }
    
    // コンピュータ・保険購入
    const computerQty = parseInt(document.getElementById('computerChips').value || 0);
    const insuranceQty = parseInt(document.getElementById('insuranceChips').value || 0);
    
    totalCost += (computerQty * 20) + (insuranceQty * 5);

    // 期首で現金不足の場合、¥100の長期借入が可能
    if (company.cash < totalCost) {
        const shortage = totalCost - company.cash;
        const loansNeeded = Math.ceil(shortage / 100) * 100;

        if (confirm(`現金が¥${shortage}不足しています。\n長期借入¥${loansNeeded}を行いますか？\n（利息10%を差し引いた¥${loansNeeded * 0.9}が入金されます）`)) {
            const netAmount = loansNeeded * 0.9;
            company.loans += loansNeeded;
            company.cash += netAmount;
        } else {
            alert('期首処理をキャンセルしました');
            return;
        }
    }

    company.cash -= totalCost;
    company.chips.computer = Math.min(3, company.chips.computer + computerQty);
    company.chips.insurance = Math.min(3, company.chips.insurance + insuranceQty);
    
    // AI companies also process period start
    for (let i = 1; i < gameState.companies.length; i++) {
        const aiCompany = gameState.companies[i];
        // Simple AI logic
        if (aiCompany.cash >= 25) {
            aiCompany.cash -= 25;
            aiCompany.chips.computer = 1;
            aiCompany.chips.insurance = 1;
        }
    }
    
    gameState.periodStarted = true;
    closeModal();
    updateDisplay();
    
    // Show turn start options
    showTurnStartOptions();
}

// Show turn start options
function showTurnStartOptions() {
    if (gameState.currentPlayerIndex !== 0) return;

    const company = gameState.companies[0];
    const content = `
        <div class="card-choice-container">
            <h2>あなたのターン</h2>
            <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                <button class="action-btn main card-choice-btn" onclick="drawCard()" style="flex: 2;">カードを引く</button>
                <button class="action-btn secondary" onclick="viewGameState()" style="flex: 1; font-size: 12px;">全体を見る</button>
            </div>
            <div style="margin-top: 20px;">
                <p>その他のアクション（Bルール）</p>
                <button class="action-btn secondary" onclick="showInsurancePurchaseModal()">保険チップ購入</button>
                <button class="action-btn secondary" onclick="showWarehouseModal()">無災害倉庫を購入</button>
                ${company.warehouses === 1 ? '<button class="action-btn secondary" onclick="showWarehouseMoveModal()">倉庫の移動</button>' : ''}
                <button class="action-btn secondary" onclick="showReassignModal()">配置転換</button>
                <button class="action-btn secondary" onclick="showSellMachineModal()">機械売却</button>
            </div>
        </div>
    `;
    
    showModal('行動選択', content);
}

// View game state - 全体を見る機能
function viewGameState() {
    closeModal();

    // 表示順（販売上限価格の高い順）
    const displayOrder = ['仙台', '札幌', '福岡', '名古屋', '大阪', '東京', '海外'];

    // 市場情報を生成
    let marketsHtml = '<div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-bottom: 15px;">';
    displayOrder.forEach(marketName => {
        const market = gameState.markets.find(m => m.name === marketName);
        if (!market) return;
        const closedStyle = market.closed ? 'opacity: 0.5; text-decoration: line-through;' : '';
        const volumeText = market.name === '海外' ? '∞' : market.maxStock;
        marketsHtml += `
            <div style="background: linear-gradient(135deg, #1e3a5f 0%, #0f172a 100%); padding: 8px; border-radius: 8px; text-align: center; ${closedStyle}">
                <div style="font-weight: bold; color: #fbbf24; font-size: 12px;">${market.name}</div>
                <div style="color: #93c5fd; font-size: 10px;">売¥${market.sellPrice} / 買¥${market.buyPrice}</div>
                <div style="color: #4ade80; font-size: 11px; margin-top: 3px;">在庫: ${market.currentStock}/${volumeText}</div>
                ${market.closed ? '<div style="color: #ef4444; font-size: 10px;">閉鎖中</div>' : ''}
            </div>
        `;
    });
    marketsHtml += '</div>';

    // 全会社の情報を生成
    let companiesHtml = '';
    gameState.companies.forEach((company, idx) => {
        const isPlayer = idx === 0;
        const periodPayment = calculatePeriodPayment(company);
        const fixedCost = calculateFixedCost(company);
        const mfgCapacity = getManufacturingCapacity(company);
        const salesCapacity = getSalesCapacity(company);
        const priceComp = getPriceCompetitiveness(company, idx);

        // チップ情報
        const chips = company.chips || {};
        const chipInfo = [];
        if (chips.research) chipInfo.push(`研${chips.research}`);
        if (chips.education) chipInfo.push(`教${chips.education}`);
        if (chips.advertising) chipInfo.push(`広${chips.advertising}`);
        if (chips.computer) chipInfo.push(`PC${chips.computer}`);
        if (chips.insurance) chipInfo.push(`保${chips.insurance}`);

        // 機械情報
        const smallMachines = company.machines.filter(m => m.type === 'small').length;
        const largeMachines = company.machines.filter(m => m.type === 'large').length;

        const bgColor = isPlayer ? 'linear-gradient(135deg, #166534 0%, #14532d 100%)' : 'linear-gradient(135deg, #1e40af 0%, #1e3a8a 100%)';
        const borderColor = isPlayer ? '#22c55e' : '#3b82f6';

        companiesHtml += `
            <div style="background: ${bgColor}; border: 2px solid ${borderColor}; border-radius: 12px; padding: 12px; margin-bottom: 10px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                    <div style="font-weight: bold; color: #fbbf24; font-size: 14px;">${isPlayer ? '★ ' : ''}${company.name}</div>
                    <div style="display: flex; gap: 8px;">
                        <span style="color: #4ade80; font-weight: bold;">¥${company.cash}</span>
                        <span style="background: ${(company.currentRow || 1) >= gameState.maxRows - 5 ? '#ef4444' : '#3b82f6'}; color: white; padding: 2px 6px; border-radius: 4px; font-size: 11px;">
                            ${company.currentRow || 1}/${gameState.maxRows}行
                        </span>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px; margin-bottom: 8px;">
                    <div style="background: rgba(139, 92, 246, 0.3); padding: 6px; border-radius: 6px; text-align: center;">
                        <div style="color: #c4b5fd; font-size: 10px;">材料</div>
                        <div style="color: white; font-weight: bold;">${company.materials}個</div>
                    </div>
                    <div style="background: rgba(168, 85, 247, 0.3); padding: 6px; border-radius: 6px; text-align: center;">
                        <div style="color: #d8b4fe; font-size: 10px;">仕掛品</div>
                        <div style="color: white; font-weight: bold;">${company.wip}個</div>
                    </div>
                    <div style="background: rgba(99, 102, 241, 0.3); padding: 6px; border-radius: 6px; text-align: center;">
                        <div style="color: #a5b4fc; font-size: 10px;">製品</div>
                        <div style="color: white; font-weight: bold;">${company.products}個</div>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px; margin-bottom: 8px;">
                    <div style="background: rgba(251, 191, 36, 0.2); padding: 4px; border-radius: 4px; text-align: center;">
                        <span style="color: #fbbf24; font-size: 10px;">W:${company.workers}</span>
                    </div>
                    <div style="background: rgba(148, 163, 184, 0.2); padding: 4px; border-radius: 4px; text-align: center;">
                        <span style="color: #94a3b8; font-size: 10px;">機:${smallMachines}小${largeMachines}大</span>
                    </div>
                    <div style="background: rgba(59, 130, 246, 0.2); padding: 4px; border-radius: 4px; text-align: center;">
                        <span style="color: #60a5fa; font-size: 10px;">S:${company.salesmen}</span>
                    </div>
                </div>

                <div style="display: flex; justify-content: space-between; font-size: 10px; color: #93c5fd;">
                    <span>製造:${mfgCapacity} 販売:${salesCapacity} 価格:+${priceComp}</span>
                    <span>F:¥${fixedCost}</span>
                </div>

                ${chipInfo.length > 0 ? `<div style="font-size: 10px; color: #a78bfa; margin-top: 4px;">チップ: ${chipInfo.join(' ')}</div>` : ''}
            </div>
        `;
    });

    const content = `
        <div style="max-height: 70vh; overflow-y: auto; padding: 10px;">
            <div style="background: #1e293b; padding: 10px; border-radius: 8px; margin-bottom: 15px;">
                <div style="text-align: center; color: #fbbf24; font-weight: bold; margin-bottom: 10px;">
                    📊 ${gameState.currentPeriod}期 ${gameState.currentRow}/${gameState.maxRows}行目
                </div>
                <h4 style="color: #60a5fa; margin-bottom: 8px; font-size: 13px;">🏪 市場盤</h4>
                ${marketsHtml}
            </div>

            <h4 style="color: #60a5fa; margin-bottom: 10px; font-size: 13px;">🏢 全会社盤</h4>
            ${companiesHtml}
        </div>

        <button onclick="closeModal(); showTurnStartOptions();"
                style="width: 100%; padding: 12px; background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
                       color: white; border: none; border-radius: 8px; font-weight: bold; font-size: 14px; cursor: pointer;">
            行動選択に戻る
        </button>
    `;

    showModal('全体を見る', content);
}

// Draw card (80% decision, 20% risk)
// カードデッキを初期化（75枚：60枚意思決定 + 15枚リスク）
function initializeCardDeck() {
    gameState.cardDeck = [];

    // 60枚の意思決定カード（'decision'）
    for (let i = 0; i < 60; i++) {
        gameState.cardDeck.push('decision');
    }

    // 15枚のリスクカード（'risk'）
    for (let i = 0; i < 15; i++) {
        gameState.cardDeck.push('risk');
    }

    // シャッフル（Fisher-Yates）
    for (let i = gameState.cardDeck.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [gameState.cardDeck[i], gameState.cardDeck[j]] = [gameState.cardDeck[j], gameState.cardDeck[i]];
    }

    gameState.deckInitialized = true;
    console.log('カードデッキを初期化しました（75枚）');
}

// Draw card from deck
function drawCard() {
    closeModal();

    // デッキがない、または空の場合は初期化
    if (!gameState.deckInitialized || gameState.cardDeck.length === 0) {
        initializeCardDeck();
    }

    // デッキからカードを引く
    const cardType = gameState.cardDeck.pop();
    console.log(`カードを引きました: ${cardType}（残り${gameState.cardDeck.length}枚）`);

    if (cardType === 'decision') {
        showDecisionCard();
    } else {
        drawRiskCard();
    }
}

// Show decision card (会社盤が見える状態で表示)
function showDecisionCard() {
    const company = gameState.companies[0];
    const mfgCapacity = getManufacturingCapacity(company);
    const salesCapacity = getSalesCapacity(company);
    const priceComp = getPriceCompetitiveness(company, 0);

    // 各アクションの設定
    const actionConfig = {
        1: { icon: '💰', label: '商品販売', color: '#22c55e', border: '#16a34a', desc: '製品を販売' },
        2: { icon: '📦', label: '材料仕入', color: '#8b5cf6', border: '#7c3aed', desc: '材料を購入' },
        3: { icon: '🏭', label: '完成・投入', color: '#3b82f6', border: '#2563eb', desc: '製造を実行' },
        4: { icon: '👥', label: '採用', color: '#f59e0b', border: '#d97706', desc: '人員を採用' },
        5: { icon: '⚙️', label: '設備投資', color: '#6366f1', border: '#4f46e5', desc: '機械を購入' },
        6: { icon: '🎯', label: '戦略チップ', color: '#ef4444', border: '#dc2626', desc: 'チップ購入' },
        7: { icon: '⏭️', label: 'DO NOTHING', color: '#64748b', border: '#475569', desc: 'パス' }
    };

    const cardHtml = gameState.decisionCards.map(card => {
        const cfg = actionConfig[card.id];
        return `
            <div onclick="selectDecisionCard(${card.id})" style="
                background: linear-gradient(135deg, ${cfg.color} 0%, ${cfg.border} 100%);
                border: 3px solid ${cfg.border};
                border-radius: 10px;
                padding: 12px 8px;
                text-align: center;
                cursor: pointer;
                color: white;
                transition: transform 0.2s, box-shadow 0.2s;
                box-shadow: 0 3px 10px rgba(0,0,0,0.2);
            " onmouseover="this.style.transform='scale(1.05)'"
               onmouseout="this.style.transform='scale(1)'">
                <div style="font-size: 24px; margin-bottom: 4px;">${cfg.icon}</div>
                <div style="font-weight: bold; font-size: 12px;">${cfg.label}</div>
                <div style="font-size: 9px; opacity: 0.9;">${cfg.desc}</div>
            </div>
        `;
    }).join('');

    const content = `
        <div style="background: #fef3c7; border-radius: 8px; padding: 8px; margin-bottom: 12px; text-align: center;">
            <div style="font-weight: bold; color: #92400e; font-size: 14px;">💰 持ち金: ¥${company.cash}</div>
        </div>
        <div style="display: flex; justify-content: space-around; margin-bottom: 12px; padding: 8px; background: #f1f5f9; border-radius: 8px;">
            <div style="text-align: center;">
                <div style="font-size: 10px; color: #64748b;">製造</div>
                <div style="font-size: 16px; font-weight: bold; color: #0284c7;">${mfgCapacity}</div>
            </div>
            <div style="text-align: center;">
                <div style="font-size: 10px; color: #64748b;">販売</div>
                <div style="font-size: 16px; font-weight: bold; color: #dc2626;">${salesCapacity}</div>
            </div>
            <div style="text-align: center;">
                <div style="font-size: 10px; color: #64748b;">価格競争力</div>
                <div style="font-size: 16px; font-weight: bold; color: #16a34a;">+${priceComp}</div>
            </div>
        </div>
        <div style="display: flex; justify-content: center; gap: 6px; margin-bottom: 12px; font-size: 11px;">
            <div style="background: #e0e7ff; padding: 4px 10px; border-radius: 6px;">
                <span style="color: #4338ca;">材料</span> <b>${company.materials}</b>
            </div>
            <div style="background: #fae8ff; padding: 4px 10px; border-radius: 6px;">
                <span style="color: #a21caf;">仕掛品</span> <b>${company.wip}</b>
            </div>
            <div style="background: #dbeafe; padding: 4px 10px; border-radius: 6px;">
                <span style="color: #1d4ed8;">製品</span> <b>${company.products}</b>
            </div>
        </div>
        <p style="text-align: center; font-size: 12px; color: #666; margin-bottom: 10px;">アクションを選択してください</p>
        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px;">
            ${cardHtml}
        </div>
    `;

    showModal('意思決定カード', content);
}

// Select decision card
function selectDecisionCard(cardId) {
    const card = gameState.decisionCards.find(c => c.id === cardId);
    gameState.companies[0].decisionCard = card;
    
    closeModal();
    
    // Execute decision card action
    switch(cardId) {
        case 1: showSalesModal(); break;
        case 2: showBuyMaterialsModal(); break;
        case 3: showProductionModal(); break;
        case 4: showHireModal(); break;
        case 5: showMachineModal(); break;
        case 6: showChipPurchaseModal(); break;  // チップ購入
        case 7: doNothing(); break;
    }
}

// Draw risk card
function drawRiskCard() {
    const availableCards = gameState.riskCards.filter(card => {
        if (gameState.currentPeriod === 2 && card.period2Exempt) return false;
        return !gameState.usedRiskCards.includes(card.id);
    });
    
    if (availableCards.length === 0) {
        showDecisionCard();
        return;
    }
    
    const card = availableCards[Math.floor(Math.random() * availableCards.length)];
    gameState.usedRiskCards.push(card.id);

    // カードタイプに応じた色とアイコン
    const isPositive = card.type === 'benefit';
    const cardIcon = isPositive ? '🎉' : '⚠️';

    const content = `
        <div class="risk-display" style="${isPositive ? 'background: linear-gradient(135deg, #059669 0%, #047857 100%); border-color: #34d399;' : ''}">
            <div class="risk-badge">${cardIcon} リスクカード</div>
            <div class="risk-title">${card.name}</div>
            <div class="risk-description">${card.description}</div>
        </div>
        <button class="submit-btn" onclick="applyRiskCard(${card.id})" style="margin-top: 15px;">
            ${isPositive ? '✓ 効果を適用' : '⚡ 適用する'}
        </button>
    `;

    showModal('リスクカード', content);
}

// Apply risk card
function applyRiskCard(cardId) {
    const company = gameState.companies[0];
    const card = gameState.riskCards.find(c => c.id === cardId);
    let rowUsed = true;

    switch(cardId) {
        case 1: // クレーム発生
        case 2:
            company.cash = Math.max(0, company.cash - 5);
            showToast('クレーム発生！\n本社経費▲5', 'warning', 4000);
            break;
        case 3: // 教育成功（仕入れ可）
        case 4:
            if (company.chips.education > 0) {
                // 販売能力の範囲内、最高5個まで、仕入れ可
                const result = executeSpecialSaleWithPurchase('education', 'education', 2, true);
                if (result.async) {
                    return; // 非同期処理中
                }
                if (!result.success) {
                    alert(`教育成功！\n（${result.reason}のため効果なし）`);
                    rowUsed = false;
                }
            } else {
                alert('教育チップを持っていないため効果なし');
                rowUsed = false;
            }
            break;
        case 5: // 消費者運動発生
        case 6:
            company.cannotSell = true;
            showToast('消費者運動発生！\n商品の販売はできません\n（材料購入、完成・投入、DO NOTHINGは可能）', 'danger', 5000);
            showForcedActionModal();  // アクション選択モーダルを表示
            return;  // ここでリターン（モーダルで行動を選択後にターン終了）
        case 7: // 得意先倒産
        case 8:
            if (gameState.currentPeriod !== 2) {
                company.cash = Math.max(0, company.cash - 30);
                company.specialLoss = (company.specialLoss || 0) + 30;
                alert('得意先倒産！\n現金▲30（特別損失）');
            } else {
                alert('得意先倒産！\n2期目は免除');
                rowUsed = false;
            }
            break;
        case 9: // 研究開発失敗
        case 10:
        case 11:
            if (company.chips.research > 0) {
                company.chips.research--;
                alert('研究開発失敗！\n青チップ1枚返却');
            } else if (company.nextPeriodChips.research > 0) {
                company.nextPeriodChips.research--;
                alert('研究開発失敗！\n次繰盤の青チップ1枚返却');
            } else {
                alert('研究開発失敗！\n（青チップがないため効果なし）');
                rowUsed = false;
            }
            break;
        case 12: // 広告成功（仕入れ可）
        case 13:
        case 14:
            if (company.chips.advertising > 0) {
                // 赤チップ1枚につき2個まで、最高5個まで、仕入れ可
                const result = executeSpecialSaleWithPurchase('advertising', 'advertising', 2, false);
                if (result.async) {
                    return; // 非同期処理中
                }
                if (!result.success) {
                    alert(`広告成功！\n（${result.reason}のため効果なし）`);
                    rowUsed = false;
                }
            } else {
                alert('広告成功！\n（赤チップがないため効果なし）');
                rowUsed = false;
            }
            break;
        case 15: // 労災発生
        case 16:
            company.cannotProduce = true;
            showToast('労災発生！\n生産活動はできません\n（材料購入、商品販売・入札、DO NOTHINGは可能）', 'danger', 5000);
            showLaborAccidentActionModal();  // 行動選択モーダルを表示
            return;  // ここでリターン（モーダルで行動を選択後にターン終了）
        case 17: // 広告政策失敗
        case 18:
            if (company.chips.advertising > 0) {
                company.chips.advertising--;
                alert('広告政策失敗！\n赤チップ1枚返却');
            } else if (company.nextPeriodChips.advertising > 0) {
                company.nextPeriodChips.advertising--;
                alert('広告政策失敗！\n次繰盤の赤チップ1枚返却');
            } else {
                alert('広告政策失敗！\n（赤チップがないため効果なし）');
                rowUsed = false;
            }
            break;
        case 19: // 特別サービス
        case 20:
            showSpecialServiceModal();  // 選択モーダルを表示
            return;  // ここでリターン（モーダルで選択後にターン終了）
        case 21: // 返品発生
        case 22:
        case 23:
            if (gameState.currentPeriod !== 2) {
                company.products = Math.min(company.products + 1, 999);
                company.totalSales -= 20;
                alert('返品発生！\n商品1個が戻り、売上▲20円');
            } else {
                alert('返品発生！\n2期目は免除');
                rowUsed = false;
            }
            break;
        case 24: // コンピュータートラブル
        case 25:
            company.cash = Math.max(0, company.cash - 10);
            showToast('コンピュータートラブル！\n製造経費▲10', 'warning', 4000);
            break;
        case 26: // 商品の独占販売（仕入れ可）
        case 27:
        case 28:
            if (company.salesmen > 0) {
                // セールスマン1人につき2個まで、最高5個まで、仕入れ可
                const result = executeSpecialSaleWithPurchase('exclusive', 'salesmen', 2, false);
                if (result.async) {
                    return; // 非同期処理中
                }
                if (!result.success) {
                    alert(`商品の独占販売！\n（${result.reason}のため効果なし）`);
                    rowUsed = false;
                }
            } else {
                alert('商品の独占販売！\n（セールスマンがいないため効果なし）');
                rowUsed = false;
            }
            break;
        case 29: // 製造ミス発生
        case 30:
            if (company.wip > 0) {
                company.wip--;
                company.specialLoss = (company.specialLoss || 0) + 14;  // 仕掛品1個=14円
                alert('製造ミス発生！\n仕掛品1個をストッカーへ（特別損失¥14）');
            } else {
                alert('製造ミス発生！\n（仕掛品がないため効果なし）');
                rowUsed = false;
            }
            break;
        case 31: // 倉庫火災
        case 32:
            if (isMaterialProtectedFromFire(company)) {
                alert('倉庫火災！\n無災害倉庫により回避しました');
            } else if (company.chips.insurance > 0) {
                const lostMaterials = company.materials;
                const materialValue = lostMaterials * 13;  // 材料1個=13円
                const compensation = lostMaterials * 8;
                const netLoss = materialValue - compensation;
                company.cash += compensation;
                company.materials = 0;
                company.chips.insurance = 0;  // 保険使用後消失
                company.specialLoss = (company.specialLoss || 0) + netLoss;
                if (company.type === 'player') {
                    showInsuranceRepurchaseModal('倉庫火災', lostMaterials, compensation, netLoss);
                } else {
                    // AI会社は自動で再加入
                    if (company.cash >= 5) {
                        company.cash -= 5;
                        company.chips.insurance = 1;
                    }
                }
            } else {
                const lostMaterials = company.materials;
                const materialValue = lostMaterials * 13;
                company.materials = 0;
                company.specialLoss = (company.specialLoss || 0) + materialValue;
                alert(`倉庫火災！\n材料${lostMaterials}個をストッカーへ（特別損失¥${materialValue}）`);
            }
            break;
        case 33: // 縁故採用
        case 34:
            company.cash = Math.max(0, company.cash - 5);
            company.extraLaborCost = (company.extraLaborCost || 0) + 5;  // 人件費
            showHiringChoiceModal();
            rowUsed = false;
            break;
        case 35: // 研究開発成功
        case 36:
        case 37:
        case 38:
        case 39:
        case 40:
            if (company.chips.research > 0 && company.products > 0) {
                const salesCapacity = getSalesCapacity(company);
                const sellQty = Math.min(company.chips.research * 2, company.products, salesCapacity, 5);
                const revenue = sellQty * 32;
                company.cash += revenue;
                company.products -= sellQty;
                company.totalSales += revenue;
                alert(`研究開発成功！\n青チップ${company.chips.research}枚で${sellQty}個を¥32で販売\n入金額: ¥${revenue}（仕入れ不可）`);
            } else {
                alert('研究開発成功！\n（青チップまたは製品がないため効果なし）');
                rowUsed = false;
            }
            break;
        case 41: // 各社共通
        case 42:
            executeAllCompaniesCommonPurchase();
            rowUsed = false;
            break;
        case 43: // ストライキ発生
        case 44:
            company.skipTurns = 1;
            showToast('ストライキ発生！\n1回休み', 'danger', 4000);
            rowUsed = false;
            break;
        case 45: // 盗難発見
        case 46:
            if (isProductProtectedFromTheft(company)) {
                alert('盗難発見！\n無災害倉庫により回避しました');
            } else if (company.chips.insurance > 0) {
                const stolen = Math.min(2, company.products);
                const productValue = stolen * 15;  // 製品1個=15円
                const compensation = stolen * 10;
                const netLoss = productValue - compensation;
                company.cash += compensation;
                company.products -= stolen;
                company.chips.insurance = 0;  // 保険使用後消失
                const overseasMarket = gameState.markets.find(m => m.name === '海外');
                if (overseasMarket) overseasMarket.currentStock += stolen;
                company.specialLoss = (company.specialLoss || 0) + netLoss;
                if (company.type === 'player') {
                    showInsuranceRepurchaseModal('盗難発見', stolen, compensation, netLoss);
                } else {
                    // AI会社は自動で再加入
                    if (company.cash >= 5) {
                        company.cash -= 5;
                        company.chips.insurance = 1;
                    }
                }
            } else {
                const stolen = Math.min(2, company.products);
                const productValue = stolen * 15;
                company.products -= stolen;
                const overseasMarket = gameState.markets.find(m => m.name === '海外');
                if (overseasMarket) overseasMarket.currentStock += stolen;
                company.specialLoss = (company.specialLoss || 0) + productValue;
                alert(`盗難発見！\n商品${stolen}個をストッカーへ（保険未加入）`);
            }
            break;
        case 47: // 長期労務紛争
        case 48:
            company.skipTurns = 2;
            showToast('長期労務紛争！\n2回休み', 'danger', 4000);
            rowUsed = false;
            break;
        case 49: // 設計トラブル発生
        case 50:
            company.cash = Math.max(0, company.cash - 10);
            alert('設計トラブル発生！\n製造経費▲10');
            break;
        case 51: // ワーカー退職
        case 52:
            company.cash = Math.max(0, company.cash - 5);
            company.extraLaborCost = (company.extraLaborCost || 0) + 5;  // 人件費
            if (company.workers > 0) {
                company.workers--;
                company.retiredWorkers = (company.retiredWorkers || 0) + 1;  // 退職者追跡（0.5名分給料）
                alert('ワーカー退職！\n人件費▲5\nワーカー1人退職（給料は0.5名分）');
            } else {
                alert('ワーカー退職！\n人件費▲5');
            }
            break;
        case 53: // 景気変動
        case 54:
            gameState.turnReversed = !gameState.turnReversed;
            alert(`景気変動！\nターン順が${gameState.turnReversed ? '逆回り' : '正順'}になりました`);
            break;
        case 55: // 教育失敗
        case 56:
            if (company.chips.education > 0) {
                company.chips.education--;
                alert('教育失敗！\n黄チップ1枚返却');
            } else if (company.nextPeriodChips.education > 0) {
                company.nextPeriodChips.education--;
                alert('教育失敗！\n次繰盤の黄チップ1枚返却');
            } else {
                alert('教育失敗！\n（黄チップがないため効果なし）');
                rowUsed = false;
            }
            break;
        case 57: // セールスマン退職
        case 58:
            company.cash = Math.max(0, company.cash - 5);
            company.extraLaborCost = (company.extraLaborCost || 0) + 5;  // 人件費
            if (company.salesmen > 0) {
                company.salesmen--;
                company.retiredSalesmen = (company.retiredSalesmen || 0) + 1;  // 退職者追跡（0.5名分給料）
                alert('セールスマン退職！\n人件費▲5\nセールスマン1人退職（給料は0.5名分）');
            } else {
                alert('セールスマン退職！\n人件費▲5');
            }
            break;
        case 59: // 社長、病気で倒れる
        case 60:
            company.skipTurns = 1;
            showToast('社長、病気で倒れる！\n1回休み', 'danger', 4000);
            rowUsed = false;
            break;
        case 61: // 不良在庫発生
        case 62:
            let totalInventory = company.materials + company.wip + company.products;
            if (totalInventory > 20) {
                let excess = totalInventory - 20;
                let lostItems = 0;
                let lostValue = 0;
                // 製品から順に処理
                if (company.products > 0 && excess > 0) {
                    const remove = Math.min(company.products, excess);
                    company.products -= remove;
                    lostValue += remove * 15;  // 製品1個=15円
                    lostItems += remove;
                    excess -= remove;
                }
                if (company.wip > 0 && excess > 0) {
                    const remove = Math.min(company.wip, excess);
                    company.wip -= remove;
                    lostValue += remove * 14;  // 仕掛品1個=14円
                    lostItems += remove;
                    excess -= remove;
                }
                if (company.materials > 0 && excess > 0) {
                    const remove = Math.min(company.materials, excess);
                    company.materials -= remove;
                    lostValue += remove * 13;  // 材料1個=13円
                    lostItems += remove;
                }

                // 保険加入チェック
                if (company.chips.insurance > 0) {
                    const compensation = lostItems * 10;  // 1個10円の保険金
                    const netLoss = lostValue - compensation;
                    company.cash += compensation;
                    company.chips.insurance = 0;  // 保険使用後消失
                    company.specialLoss = (company.specialLoss || 0) + netLoss;
                    if (company.type === 'player') {
                        showInsuranceRepurchaseModal('不良在庫発生', lostItems, compensation, netLoss);
                        return;  // モーダルで再加入選択後に処理
                    } else {
                        // AI会社は自動で再加入
                        if (company.cash >= 5) {
                            company.cash -= 5;
                            company.chips.insurance = 1;
                        }
                        alert(`不良在庫発生！\n${lostItems}個をストッカーへ\n保険金: ¥${compensation}\n特別損失: ¥${netLoss}`);
                    }
                } else {
                    // 保険未加入
                    company.specialLoss = (company.specialLoss || 0) + lostValue;
                    alert(`不良在庫発生！\n${lostItems}個をストッカーへ\n特別損失: ¥${lostValue}（保険未加入）`);
                }
            } else {
                alert('不良在庫発生！\n（総在庫が20個以下のため効果なし）');
                rowUsed = false;
            }
            break;
        case 63: // 機械故障
        case 64:
            company.cash = Math.max(0, company.cash - 5);
            if (!company.additionalFixedCost) company.additionalFixedCost = 0;
            company.additionalFixedCost += 5;
            alert('機械故障！\n製造経費▲5');
            break;
    }

    closeModal();

    if (rowUsed) {
        endTurn();
    } else {
        // 行を消費しないリスクカードの場合、意思決定カードを表示
        showDecisionCard();
    }
}

// Special service modal
function showSpecialServiceModal() {
    const content = `
        <div class="form-group">
            <label class="form-label">特別サービスを選択してください:</label>
            <div style="margin: 10px 0;">
                <button class="action-btn primary" onclick="executeMaterialPurchase()" style="width: 100%; margin: 5px 0;">
                    材料購入（1個¥10で5個まで）
                </button>
                <button class="action-btn secondary" onclick="executeAdPurchase()" style="width: 100%; margin: 5px 0;">
                    広告チップ購入（1枚¥20で2枚まで）
                </button>
            </div>
        </div>
    `;
    
    showModal('特別サービス', content);
}

// Execute material purchase from special service
function executeMaterialPurchase() {
    const company = gameState.companies[0];
    
    // 購入数量を選択させる
    const content = `
        <div class="form-group">
            <label class="form-label">材料購入：数量を選択してください</label>
            <p style="font-size: 12px; color: #666;">特別価格：1個10円（最大5個まで）</p>
            <p style="font-size: 12px; color: #666;">現在の現金: ¥${company.cash}</p>
            <p style="font-size: 12px; color: #666;">現在の材料: ${company.materials}個</p>
            <select id="materialQty" class="form-control">
                <option value="0">購入しない</option>
                ${company.cash >= 10 ? '<option value="1">1個（¥10）</option>' : ''}
                ${company.cash >= 20 ? '<option value="2">2個（¥20）</option>' : ''}
                ${company.cash >= 30 ? '<option value="3">3個（¥30）</option>' : ''}
                ${company.cash >= 40 ? '<option value="4">4個（¥40）</option>' : ''}
                ${company.cash >= 50 ? '<option value="5">5個（¥50）</option>' : ''}
            </select>
            <button class="submit-btn" onclick="confirmMaterialPurchase()" style="margin-top: 10px;">購入</button>
        </div>
    `;
    
    showModal('特別サービス - 材料購入', content);
}

// Confirm material purchase from special service
function confirmMaterialPurchase() {
    const company = gameState.companies[0];
    const buyQty = parseInt(document.getElementById('materialQty').value || 0);

    if (buyQty > 0) {
        const cost = buyQty * 10;
        company.cash -= cost;
        company.materials += buyQty;
        company.totalMaterialCost += cost;
        incrementRow(gameState.companies.indexOf(company));
        closeModal();
        alert(`特別サービス：材料${buyQty}個を¥${cost}で購入しました`);
        updateDisplay();
        nextTurn();
    } else {
        // 購入しない場合は意思決定カードを表示（行を消費しない）
        closeModal();
        showDecisionCard();
    }
}

// Execute ad chip purchase from special service
function executeAdPurchase() {
    const company = gameState.companies[0];
    
    // 購入数量を選択させる
    const content = `
        <div class="form-group">
            <label class="form-label">広告チップ購入：数量を選択してください</label>
            <p style="font-size: 12px; color: #666;">特別価格：1枚20円（最大2枚まで）</p>
            <p style="font-size: 12px; color: #666;">現在の現金: ¥${company.cash}</p>
            <p style="font-size: 12px; color: #666;">現在の広告チップ: ${company.chips.advertising || 0}枚</p>
            <select id="adChipQty" class="form-control">
                <option value="0">購入しない</option>
                ${company.cash >= 20 ? '<option value="1">1枚（¥20）</option>' : ''}
                ${company.cash >= 40 ? '<option value="2">2枚（¥40）</option>' : ''}
            </select>
            <button class="submit-btn" onclick="confirmAdPurchase()" style="margin-top: 10px;">購入</button>
        </div>
    `;
    
    showModal('特別サービス - 広告チップ購入', content);
}

// Confirm ad chip purchase from special service
function confirmAdPurchase() {
    const company = gameState.companies[0];
    const buyQty = parseInt(document.getElementById('adChipQty').value || 0);

    if (buyQty > 0) {
        const cost = buyQty * 20;
        company.cash -= cost;
        company.chips.advertising = (company.chips.advertising || 0) + buyQty;
        incrementRow(gameState.companies.indexOf(company));
        closeModal();
        alert(`特別サービス：広告チップ${buyQty}枚を¥${cost}で購入しました`);
        updateDisplay();
        nextTurn();
    } else {
        // 購入しない場合は意思決定カードを表示（行を消費しない）
        closeModal();
        showDecisionCard();
    }
}

// ============================================
// 仕入れ交渉システム（他企業から製品を購入）
// ============================================

// 仕入れ交渉の状態を保持
let purchaseNegotiationState = {
    cardType: null,        // 'education', 'advertising', 'exclusive'
    maxSellQty: 0,         // 最大販売可能数
    ownProducts: 0,        // 自社製品数
    needToBuy: 0,          // 仕入れ必要数
    purchases: [],         // [{companyIndex, qty, price}]
    onComplete: null       // 完了時のコールバック
};

// AI企業の仕入れ交渉応答ロジック
function getAINegotiationResponse(aiCompany, requestedQty, offeredPrice) {
    // AI企業の戦略に基づいて交渉応答を決定
    const strategy = aiCompany.strategy;
    const hasProducts = aiCompany.products >= requestedQty;

    if (!hasProducts) {
        return { accept: false, counter: null, reason: '在庫不足' };
    }

    // 各戦略の最低希望価格
    let minPrice;
    switch (strategy) {
        case 'aggressive':
            minPrice = 26;  // 積極的：利益重視で高め
            break;
        case 'balanced':
            minPrice = 24;  // バランス型：中間
            break;
        case 'conservative':
            minPrice = 28;  // 保守的：リスク回避で高め
            break;
        case 'price_focused':
            minPrice = 22;  // 価格破壊：安くても売る
            break;
        case 'tech_focused':
            minPrice = 25;  // 技術重視：普通
            break;
        case 'unpredictable':
            minPrice = 18 + Math.floor(Math.random() * 14);  // 18-31のランダム
            break;
        default:
            minPrice = 25;
    }

    if (offeredPrice >= minPrice) {
        return { accept: true, counter: null, reason: null };
    } else {
        // カウンターオファー
        const counterPrice = Math.min(31, minPrice + Math.floor(Math.random() * 3));
        return { accept: false, counter: counterPrice, reason: `¥${counterPrice}なら売ります` };
    }
}

// 仕入れ交渉モーダルを表示
function showPurchaseNegotiationModal(cardType, maxSellQty, ownProducts, onComplete) {
    const company = gameState.companies[0];
    const needToBuy = maxSellQty - ownProducts;

    if (needToBuy <= 0) {
        // 仕入れ不要：自社製品だけで足りる
        onComplete(0, 0, []);
        return;
    }

    // 他企業の在庫を確認
    const otherCompanies = gameState.companies.slice(1).filter(c => c.products > 0);

    if (otherCompanies.length === 0) {
        alert('他企業に在庫がないため仕入れできません');
        onComplete(0, 0, []);
        return;
    }

    purchaseNegotiationState = {
        cardType,
        maxSellQty,
        ownProducts,
        needToBuy,
        purchases: [],
        onComplete
    };

    let content = `
        <div class="form-group">
            <p><strong>販売可能数:</strong> ${maxSellQty}個（自社${ownProducts}個 + 仕入れ${needToBuy}個まで）</p>
            <p><strong>仕入れ可能数:</strong> 最大${needToBuy}個</p>
            <hr style="margin: 10px 0;">
            <p><strong>他企業から仕入れ交渉:</strong></p>
            <div id="negotiationList">
    `;

    otherCompanies.forEach((c, idx) => {
        const actualIdx = gameState.companies.indexOf(c);
        content += `
            <div style="border: 1px solid #ddd; padding: 10px; margin: 5px 0; border-radius: 5px;">
                <strong>${c.name}</strong>（在庫: ${c.products}個）
                <div style="display: flex; gap: 10px; margin-top: 5px; align-items: center;">
                    <label>数量: <input type="number" id="negQty_${actualIdx}" min="0" max="${Math.min(c.products, needToBuy)}" value="0" style="width: 60px;"></label>
                    <label>希望価格: ¥<input type="number" id="negPrice_${actualIdx}" min="15" max="31" value="25" style="width: 60px;"></label>
                    <button class="action-btn secondary" onclick="negotiateWithCompany(${actualIdx})" style="padding: 5px 10px;">交渉</button>
                    <span id="negResult_${actualIdx}" style="font-size: 12px;"></span>
                </div>
            </div>
        `;
    });

    content += `
            </div>
            <div id="purchaseSummary" style="margin-top: 15px; padding: 10px; background: #f5f5f5; border-radius: 5px;">
                <p>仕入れ合計: <span id="totalPurchased">0</span>個 / 費用: ¥<span id="totalCost">0</span></p>
            </div>
            <div style="margin-top: 15px; display: flex; gap: 10px;">
                <button class="action-btn primary" onclick="completePurchaseNegotiation()">仕入れ完了</button>
                <button class="action-btn secondary" onclick="skipPurchaseNegotiation()">仕入れしない</button>
            </div>
        </div>
    `;

    showModal('仕入れ交渉', content);
}

// 個別企業との交渉
function negotiateWithCompany(companyIndex) {
    const aiCompany = gameState.companies[companyIndex];
    const qtyInput = document.getElementById(`negQty_${companyIndex}`);
    const priceInput = document.getElementById(`negPrice_${companyIndex}`);
    const resultSpan = document.getElementById(`negResult_${companyIndex}`);

    const requestedQty = parseInt(qtyInput.value) || 0;
    const offeredPrice = parseInt(priceInput.value) || 25;

    if (requestedQty <= 0) {
        resultSpan.textContent = '数量を指定してください';
        resultSpan.style.color = 'orange';
        return;
    }

    if (requestedQty > aiCompany.products) {
        resultSpan.textContent = '在庫不足';
        resultSpan.style.color = 'red';
        return;
    }

    // 既存の交渉結果を削除
    purchaseNegotiationState.purchases = purchaseNegotiationState.purchases.filter(
        p => p.companyIndex !== companyIndex
    );

    // 現在の仕入れ合計を確認
    const currentTotal = purchaseNegotiationState.purchases.reduce((sum, p) => sum + p.qty, 0);
    const remainingNeed = purchaseNegotiationState.needToBuy - currentTotal;

    if (requestedQty > remainingNeed) {
        resultSpan.textContent = `あと${remainingNeed}個まで`;
        resultSpan.style.color = 'orange';
        return;
    }

    const response = getAINegotiationResponse(aiCompany, requestedQty, offeredPrice);

    if (response.accept) {
        purchaseNegotiationState.purchases.push({
            companyIndex,
            qty: requestedQty,
            price: offeredPrice
        });
        resultSpan.textContent = `✓ ${requestedQty}個×¥${offeredPrice}で合意`;
        resultSpan.style.color = 'green';
    } else if (response.counter) {
        resultSpan.textContent = response.reason;
        resultSpan.style.color = 'blue';
        priceInput.value = response.counter;
    } else {
        resultSpan.textContent = response.reason;
        resultSpan.style.color = 'red';
    }

    updatePurchaseSummary();
}

// 仕入れサマリーを更新
function updatePurchaseSummary() {
    const totalPurchased = purchaseNegotiationState.purchases.reduce((sum, p) => sum + p.qty, 0);
    const totalCost = purchaseNegotiationState.purchases.reduce((sum, p) => sum + (p.qty * p.price), 0);

    const purchasedSpan = document.getElementById('totalPurchased');
    const costSpan = document.getElementById('totalCost');

    if (purchasedSpan) purchasedSpan.textContent = totalPurchased;
    if (costSpan) costSpan.textContent = totalCost;
}

// 仕入れ交渉完了
function completePurchaseNegotiation() {
    const company = gameState.companies[0];
    const state = purchaseNegotiationState;

    const totalPurchased = state.purchases.reduce((sum, p) => sum + p.qty, 0);
    const totalCost = state.purchases.reduce((sum, p) => sum + (p.qty * p.price), 0);

    // 資金チェック
    if (totalCost > company.cash) {
        alert(`資金不足です（必要: ¥${totalCost}、現金: ¥${company.cash}）`);
        return;
    }

    // 仕入れ実行
    company.cash -= totalCost;
    state.purchases.forEach(p => {
        gameState.companies[p.companyIndex].products -= p.qty;
        gameState.companies[p.companyIndex].cash += p.qty * p.price;
    });

    closeModal();

    if (state.onComplete) {
        state.onComplete(totalPurchased, totalCost, state.purchases);
    }
}

// 仕入れスキップ
function skipPurchaseNegotiation() {
    closeModal();
    if (purchaseNegotiationState.onComplete) {
        purchaseNegotiationState.onComplete(0, 0, []);
    }
}

// 仕入れ可能カード用の販売処理
function executeSpecialSaleWithPurchase(cardType, chipType, maxPerChip, salesCapacityRequired) {
    const company = gameState.companies[0];

    // チップ確認
    let chipCount = 0;
    if (chipType === 'education') chipCount = company.chips.education || 0;
    else if (chipType === 'advertising') chipCount = company.chips.advertising || 0;
    else if (chipType === 'research') chipCount = company.chips.research || 0;
    else if (chipType === 'salesmen') chipCount = company.salesmen || 0;

    if (chipCount <= 0 && chipType !== 'salesmen') {
        return { success: false, reason: 'チップなし' };
    }
    if (chipType === 'salesmen' && chipCount <= 0) {
        return { success: false, reason: 'セールスマンなし' };
    }

    // 最大販売数を計算
    let maxSell = chipCount * maxPerChip;
    maxSell = Math.min(maxSell, 5);  // 最高5個まで

    if (salesCapacityRequired) {
        const salesCapacity = getSalesCapacity(company);
        maxSell = Math.min(maxSell, salesCapacity);
    }

    const ownProducts = company.products;

    // 自社製品がない場合でも仕入れ可能なら続行
    if (ownProducts <= 0 && cardType !== 'research') {
        // 仕入れ交渉を開始
        showPurchaseNegotiationModal(cardType, maxSell, ownProducts, (purchasedQty, purchaseCost, purchases) => {
            const totalSell = purchasedQty;
            if (totalSell > 0) {
                const revenue = totalSell * 32;
                company.cash += revenue;
                company.totalSales += revenue;
                alert(`${cardType === 'education' ? '教育成功' : cardType === 'advertising' ? '広告成功' : '商品の独占販売'}！\n仕入れ${purchasedQty}個（¥${purchaseCost}）→ ${totalSell}個を¥${revenue}で販売\n純利益: ¥${revenue - purchaseCost}`);
                endTurn();
            } else {
                alert('仕入れなし：効果なし');
                nextTurn();
            }
        });
        return { success: true, async: true };
    }

    // 仕入れ交渉を開始
    showPurchaseNegotiationModal(cardType, maxSell, ownProducts, (purchasedQty, purchaseCost, purchases) => {
        const totalSell = ownProducts + purchasedQty;
        const sellFromOwn = Math.min(ownProducts, totalSell);

        if (totalSell > 0) {
            company.products -= sellFromOwn;
            const revenue = totalSell * 32;
            company.cash += revenue;
            company.totalSales += revenue;

            let message = `${cardType === 'education' ? '教育成功' : cardType === 'advertising' ? '広告成功' : '商品の独占販売'}！\n`;
            message += `自社${sellFromOwn}個`;
            if (purchasedQty > 0) {
                message += ` + 仕入れ${purchasedQty}個（¥${purchaseCost}）`;
            }
            message += `\n合計${totalSell}個を¥${revenue}で販売`;
            if (purchasedQty > 0) {
                message += `\n純利益: ¥${revenue - purchaseCost}`;
            }
            alert(message);
            endTurn();
        } else {
            alert('販売なし：効果なし');
            nextTurn();
        }
    });

    return { success: true, async: true };
}

// Show forced action modal for 消費者運動発生
function showForcedActionModal() {
    const content = `
        <div class="form-group">
            <label class="form-label">消費者運動発生：販売禁止のため、以下から選択してください</label>
            <div style="margin: 10px 0;">
                <button class="action-btn primary" onclick="closeModal(); showMaterialPurchaseModal();" style="width: 100%; margin: 5px 0;">
                    材料購入
                </button>
                <button class="action-btn primary" onclick="closeModal(); showProductionModal();" style="width: 100%; margin: 5px 0;">
                    完成・投入
                </button>
                <button class="action-btn secondary" onclick="closeModal(); doNothing();" style="width: 100%; margin: 5px 0;">
                    Do Nothing（1行消費）
                </button>
            </div>
        </div>
    `;

    showModal('消費者運動発生 - 行動選択', content);
}

// Show forced action modal for 労災発生
function showLaborAccidentActionModal() {
    const content = `
        <div class="form-group">
            <div style="background: #fee2e2; border: 2px solid #dc2626; border-radius: 8px; padding: 12px; margin-bottom: 15px; text-align: center;">
                <div style="font-weight: bold; color: #b91c1c;">⚠️ 労災発生中</div>
                <div style="font-size: 12px; color: #7f1d1d; margin-top: 5px;">生産活動はできません</div>
            </div>
            <label class="form-label">以下から行動を選択してください：</label>
            <div style="margin: 10px 0;">
                <button class="action-btn success" onclick="closeModal(); showSaleModal();" style="width: 100%; margin: 5px 0;">
                    💰 商品販売
                </button>
                <button class="action-btn primary" onclick="closeModal(); showMaterialPurchaseModal();" style="width: 100%; margin: 5px 0;">
                    📦 材料購入
                </button>
                <button class="action-btn secondary" onclick="closeModal(); doNothing();" style="width: 100%; margin: 5px 0;">
                    ⏸️ Do Nothing（1行消費）
                </button>
            </div>
        </div>
    `;

    showModal('労災発生 - 行動選択', content);
}

// Show hiring choice modal for 縁故採用
function showHiringChoiceModal() {
    const company = gameState.companies[0];
    const content = `
        <div style="background: #fef3c7; border-radius: 8px; padding: 10px; margin-bottom: 15px; text-align: center;">
            <div style="font-weight: bold; color: #92400e;">💰 持ち金: ¥${company.cash}</div>
        </div>
        <p style="text-align: center; margin-bottom: 15px; color: #666; font-size: 14px;">縁故採用：追加する人員を選択（本社経費¥5）</p>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
            <!-- セールスマン -->
            <div onclick="executeHiring('salesman')" style="
                background: linear-gradient(135deg, #ff6b6b 0%, #ee5a5a 100%);
                border: 3px solid #c44;
                border-radius: 12px;
                padding: 20px 15px;
                text-align: center;
                cursor: pointer;
                color: white;
                transition: transform 0.2s, box-shadow 0.2s;
                box-shadow: 0 4px 12px rgba(238, 90, 90, 0.4);
            " onmouseover="this.style.transform='scale(1.05)'; this.style.boxShadow='0 6px 20px rgba(238, 90, 90, 0.6)'"
               onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='0 4px 12px rgba(238, 90, 90, 0.4)'">
                <div style="font-size: 36px; margin-bottom: 8px;">💼</div>
                <div style="font-weight: bold; font-size: 16px;">セールスマン</div>
                <div style="font-size: 12px; margin-top: 5px;">+1名</div>
            </div>

            <!-- ワーカー -->
            <div onclick="executeHiring('worker')" style="
                background: linear-gradient(135deg, #f5deb3 0%, #deb887 100%);
                border: 3px solid #a08060;
                border-radius: 12px;
                padding: 20px 15px;
                text-align: center;
                cursor: pointer;
                color: #5d4037;
                transition: transform 0.2s, box-shadow 0.2s;
                box-shadow: 0 4px 12px rgba(160, 128, 96, 0.4);
            " onmouseover="this.style.transform='scale(1.05)'; this.style.boxShadow='0 6px 20px rgba(160, 128, 96, 0.6)'"
               onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='0 4px 12px rgba(160, 128, 96, 0.4)'">
                <div style="font-size: 36px; margin-bottom: 8px;">👷</div>
                <div style="font-weight: bold; font-size: 16px;">ワーカー</div>
                <div style="font-size: 12px; margin-top: 5px;">+1名</div>
            </div>
        </div>
        <div style="text-align: center; margin-top: 15px;">
            <button class="cancel-btn" onclick="closeModal(true)" style="padding: 10px 30px;">キャンセル</button>
        </div>
    `;

    showModal('縁故採用', content);
}

// Execute hiring from 縁故採用
function executeHiring(type) {
    const company = gameState.companies[0];
    const cost = 5;  // 縁故採用費用

    // 現金不足時は短期借入
    if (company.cash < cost) {
        const needed = Math.ceil((cost - company.cash) / 0.8 / 50) * 50;
        company.shortLoans += needed;
        company.cash += needed * 0.8;
        showToast(`現金不足のため短期借入¥${needed}を実行しました`, 'warning', 4000);
    }

    // 5円支払い
    company.cash -= cost;
    company.extraLaborCost = (company.extraLaborCost || 0) + cost;  // Fに計上

    if (type === 'worker') {
        company.workers++;
        // 行動ログ記録
        logAction(0, '縁故採用', 'ワーカー+1', -cost, true);
        closeModal();
        alert('縁故採用：ワーカーを1名追加しました（¥5）');
    } else if (type === 'salesman') {
        company.salesmen++;
        // 行動ログ記録
        logAction(0, '縁故採用', 'セールス+1', -cost, true);
        closeModal();
        alert('縁故採用：セールスマンを1名追加しました（¥5）');
    }

    updateDisplay();
    endTurn();  // 5円支払いがあるので1行使用
}

// Execute common purchase for all companies (各社共通)
function executeAllCompaniesCommonPurchase() {
    const triggerCompany = gameState.companies[gameState.currentPlayerIndex];
    const content = `
        <div class="risk-display">
            <div class="risk-title">${triggerCompany.name}が「各社共通」を引きました</div>
            <div class="risk-description">全社が12円で3個まで材料を購入できます<br>（まず市場から、不足分は海外から）</div>
        </div>
        <div class="form-group" style="margin-top: 20px;">
            <label class="form-label">あなたの購入数量:</label>
            <p>現在の現金: ¥${gameState.companies[0].cash}</p>
            <select id="playerQuantity" class="form-control">
                <option value="0">購入しない</option>
                <option value="1">1個（¥12）</option>
                <option value="2">2個（¥24）</option>
                <option value="3">3個（¥36）</option>
            </select>
        </div>
        <button class="submit-btn" onclick="processCommonPurchase()">決定</button>
    `;
    
    showModal('各社共通購入', content);
}

// Process common purchase
function processCommonPurchase() {
    const playerQty = parseInt(document.getElementById('playerQuantity').value || 0);
    let purchaseLog = [];
    let playerPurchased = false;  // プレイヤーが購入したか追跡

    // プレイヤーの購入処理
    if (playerQty > 0) {
        const playerCompany = gameState.companies[0];
        const cost = playerQty * 12;

        if (playerCompany.cash >= cost) {
            let purchased = 0;

            // まず市場から購入
            for (const market of gameState.markets) {
                if (purchased >= playerQty) break;
                if (market.currentStock > 0) {
                    const qty = Math.min(playerQty - purchased, market.currentStock);
                    market.currentStock -= qty;
                    purchased += qty;
                }
            }

            // 不足分は海外市場（ストッカー）から
            const overseasMarket = gameState.markets.find(m => m.name === '海外');
            if (purchased < playerQty && overseasMarket) {
                const qty = playerQty - purchased;
                overseasMarket.currentStock = Math.max(0, overseasMarket.currentStock - qty);
                purchased += qty;
            }

            playerCompany.cash -= cost;
            playerCompany.materials += playerQty;
            playerCompany.totalMaterialCost += cost;
            playerPurchased = true;  // 購入した

            // 行動ログ記録
            logAction(0, '各社共通', `¥12×${playerQty}個購入`, -cost, true);

            purchaseLog.push(`あなた: ${playerQty}個購入（¥${cost}）`);
        } else {
            purchaseLog.push('あなた: 現金不足で購入できず');
        }
    } else {
        purchaseLog.push('あなた: 購入しない');
    }

    // AI会社の購入処理（プロは12円で3個必ず買う）
    for (let i = 1; i < gameState.companies.length; i++) {
        const company = gameState.companies[i];
        const maxAffordable = Math.min(3, Math.floor(company.cash / 12));

        if (maxAffordable >= 2) {  // 2個以上買えるなら買う
            const aiQty = maxAffordable;  // 可能な限り最大量購入
            let purchased = 0;

            // まず市場から購入
            for (const market of gameState.markets) {
                if (purchased >= aiQty) break;
                if (market.currentStock > 0) {
                    const qty = Math.min(aiQty - purchased, market.currentStock);
                    market.currentStock -= qty;
                    purchased += qty;
                }
            }

            // 不足分は海外から
            const overseasMarket = gameState.markets.find(m => m.name === '海外');
            if (purchased < aiQty && overseasMarket) {
                const qty = aiQty - purchased;
                overseasMarket.currentStock = Math.max(0, overseasMarket.currentStock - qty);
                purchased += qty;
            }

            if (purchased > 0) {
                const aiCost = purchased * 12;
                company.cash -= aiCost;
                company.materials += purchased;
                company.totalMaterialCost += aiCost;

                // 行動ログ記録（AI）
                logAction(i, '各社共通', `¥12×${purchased}個購入`, -aiCost, false);

                purchaseLog.push(`${company.name}: ${purchased}個購入（¥${aiCost}）`);
            }
        }
    }

    closeModal();
    updateDisplay();

    // 購入結果を表示
    if (purchaseLog.length > 0) {
        alert('【各社共通購入結果】\n' + purchaseLog.join('\n'));
    } else {
        alert('どの会社も購入しませんでした');
    }

    // プレイヤーが購入した場合のみ1行使用
    if (playerPurchased) {
        endTurn();
    } else {
        nextTurn();
    }
}

// Render markets
function renderMarkets() {
    const container = document.getElementById('marketsContainer');
    let html = '';
    
    gameState.markets.forEach(market => {
        html += `
            <div class="market-card">
                <div class="market-header">
                    <span class="market-name">${market.name}</span>
                    <div class="market-prices">
                        <span class="price-tag buy">買¥${market.buyPrice}</span>
                        <span class="price-tag sell">売¥${market.sellPrice}</span>
                    </div>
                </div>
                <div class="market-stock-info">
                    <div class="market-stock">
                        ${Array(Math.min(market.currentStock, 20)).fill('<div class="stock-block"></div>').join('')}
                        ${market.currentStock > 20 ? '...' : ''}
                    </div>
                    <span class="stock-count">${market.currentStock}/${market.maxStock}</span>
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

// Render companies
function renderCompanies() {
    const container = document.getElementById('companiesContainer');
    let html = '';
    
    gameState.companies.forEach((company, index) => {
        const isCurrentTurn = index === gameState.currentPlayerIndex;
        const isPlayer = company.type === 'player';
        const mfgCapacity = getManufacturingCapacity(company);
        const salesCapacity = getSalesCapacity(company);
        
        // Machine display
        let machineDisplay = '';
        company.machines.forEach((machine) => {
            const machineName = machine.type === 'small' ? 
                (machine.attachments > 0 ? '小型+A' : '小型') : '大型';
            machineDisplay += `<span class="machine-item">${machineName}</span>`;
        });
        
        // Warehouse display
        let warehouseDisplay = '';
        if (company.warehouses > 0) {
            let locationText = '';
            if (company.warehouses === 2 || company.warehouseLocation === 'both') {
                locationText = '材+製';
            } else if (company.warehouseLocation === 'materials') {
                locationText = '材';
            } else {
                locationText = '製';
            }
            warehouseDisplay = `<span class="warehouse-item">倉庫(${locationText})</span>`;
        }
        
        html += `
            <div class="company-card ${isPlayer ? 'player' : ''} ${isCurrentTurn ? 'current-turn' : ''}">
                <div class="company-header">
                    <span class="company-name">${company.name}</span>
                    <span class="company-cash">¥${company.cash}</span>
                    <span style="font-size: 12px; background: ${(company.currentRow || 1) >= gameState.maxRows - 5 ? '#ef4444' : '#3b82f6'}; color: white; padding: 2px 6px; border-radius: 4px; font-weight: bold;">
                        行:${company.currentRow || 1}/${gameState.maxRows}
                    </span>
                </div>
                <div class="company-stats">
                    <div class="stat-item">自己資本: ¥${company.equity}</div>
                    <div class="stat-item">借入: ¥${company.loans + company.shortLoans}</div>
                    <div class="stat-item capacity" onclick="showManufacturingCapacityDetail(${index})" style="cursor: pointer;">製造能力: ${mfgCapacity}</div>
                    <div class="stat-item capacity" onclick="showSalesCapacityDetail(${index})" style="cursor: pointer;">販売能力: ${salesCapacity}</div>
                </div>
                <div class="machine-section">
                    ${machineDisplay || '<span class="machine-item">機械なし</span>'}
                </div>
                ${warehouseDisplay ? `<div class="warehouse-section">${warehouseDisplay}</div>` : ''}
                <div class="personnel-section">
                    <div class="personnel-group">
                        <span class="personnel-label">ワーカー:</span>
                        <div class="personnel-dots">
                            ${Array(company.workers).fill('<div class="personnel-dot"></div>').join('')}
                        </div>
                        <span>(${company.workers})</span>
                    </div>
                    <div class="personnel-group">
                        <span class="personnel-label">セールス:</span>
                        <div class="personnel-dots">
                            ${Array(company.salesmen).fill('<div class="personnel-dot"></div>').join('')}
                        </div>
                        <span>(${company.salesmen})</span>
                    </div>
                </div>
                <div class="inventory-section">
                    <div class="inventory-box">
                        <div class="inventory-label">材料</div>
                        <div class="inventory-blocks">
                            ${Array(Math.min(company.materials, 10)).fill('<div class="inventory-block material"></div>').join('')}
                            ${company.materials > 10 ? `<small>+${company.materials - 10}</small>` : ''}
                        </div>
                    </div>
                    <div class="inventory-box">
                        <div class="inventory-label">仕掛品</div>
                        <div class="inventory-blocks">
                            ${Array(Math.min(company.wip, 10)).fill('<div class="inventory-block wip"></div>').join('')}
                            ${company.wip > 10 ? `<small>+${company.wip - 10}</small>` : ''}
                        </div>
                    </div>
                    <div class="inventory-box">
                        <div class="inventory-label">製品</div>
                        <div class="inventory-blocks">
                            ${Array(Math.min(company.products, 10)).fill('<div class="inventory-block product"></div>').join('')}
                            ${company.products > 10 ? `<small>+${company.products - 10}</small>` : ''}
                        </div>
                    </div>
                </div>
                <div class="chips-section">
                    <div class="chip-row">
                        <span class="chip-label">コンピュータ:</span>
                        <div class="chip-dots">
                            ${Array(3).fill(0).map((_, i) => 
                                `<div class="chip-dot ${i < company.chips.computer ? 'filled computer' : ''}"></div>`
                            ).join('')}
                        </div>
                    </div>
                    <div class="chip-row">
                        <span class="chip-label">保険:</span>
                        <div class="chip-dots">
                            ${Array(3).fill(0).map((_, i) => 
                                `<div class="chip-dot ${i < company.chips.insurance ? 'filled insurance' : ''}"></div>`
                            ).join('')}
                        </div>
                    </div>
                    <div class="chip-row">
                        <span class="chip-label">研究:</span>
                        <div class="chip-dots">
                            ${Array(5).fill(0).map((_, i) =>
                                `<div class="chip-dot ${i < (company.chips.research + (company.nextPeriodChips?.research || 0)) ? 'filled research' : ''}"></div>`
                            ).join('')}
                        </div>
                    </div>
                    <div class="chip-row">
                        <span class="chip-label">教育:</span>
                        <div class="chip-dots">
                            ${Array(gameState.currentPeriod === 2 ? 2 : 1).fill(0).map((_, i) =>
                                `<div class="chip-dot ${i < (company.chips.education + (company.nextPeriodChips?.education || 0)) ? 'filled education' : ''}"></div>`
                            ).join('')}
                        </div>
                    </div>
                    <div class="chip-row">
                        <span class="chip-label">広告:</span>
                        <div class="chip-dots">
                            ${Array(5).fill(0).map((_, i) =>
                                `<div class="chip-dot ${i < (company.chips.advertising + (company.nextPeriodChips?.advertising || 0)) ? 'filled advertising' : ''}"></div>`
                            ).join('')}
                        </div>
                    </div>
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

// Render action buttons
function renderActionButtons() {
    const container = document.getElementById('actionButtons');
    const isPlayerTurn = gameState.currentPlayerIndex === 0;
    
    let html = '';
    
    if (!gameState.periodStarted) {
        html = `<button class="action-btn warning" onclick="startPeriod()">第${gameState.currentPeriod}期を開始</button>`;
    } else if (isPlayerTurn) {
        html = `
            <button class="action-btn main mobile-card-btn" onclick="showTurnStartOptions()">カードを引く</button>
        `;
    } else {
        html = `
            <button class="action-btn secondary" disabled>AIのターン中...</button>
        `;
    }
    
    container.innerHTML = html;
}

// Update display
function updateDisplay() {
    const player = gameState.companies[0];
    const currentCompany = gameState.companies[gameState.currentPlayerIndex];

    // ヘッダー情報
    document.getElementById('currentPeriod').textContent = gameState.currentPeriod;
    document.getElementById('currentRow').textContent = `${player.currentRow || 1}/${gameState.maxRows}`;
    document.getElementById('playerCash').textContent = `¥${player.cash}`;
    document.getElementById('equity').textContent = `¥${player.equity}`;

    // カードを引くセクション
    const cardSection = document.getElementById('cardDrawSection');
    const turnInfo = document.getElementById('turnInfo');
    if (gameState.currentPlayerIndex === 0) {
        cardSection.style.display = 'block';
        turnInfo.textContent = 'あなたのターンです';
    } else {
        cardSection.style.display = 'none';
    }

    // 会社盤を更新
    renderCompanyBoard(player);

    // 市場盤を更新
    renderMarketsBoard();

    // 固定費内訳を更新
    renderFixedCostBreakdown(player);

    // 他社一覧を更新
    renderOtherCompanies();

    // 次繰盤の表示（3期以降のみ）
    const nextPeriodBoard = document.getElementById('nextPeriodBoard');
    if (gameState.currentPeriod >= 3) {
        nextPeriodBoard.style.display = 'block';
        document.getElementById('nextResearch').textContent = player.nextPeriodChips?.research || 0;
        document.getElementById('nextEducation').textContent = player.nextPeriodChips?.education || 0;
        document.getElementById('nextAdvertising').textContent = player.nextPeriodChips?.advertising || 0;
    } else {
        nextPeriodBoard.style.display = 'none';
    }
}

// 会社盤を描画
function renderCompanyBoard(company) {
    // 情報バーを更新
    document.getElementById('currentPeriod').textContent = gameState.currentPeriod;
    document.getElementById('currentRow').textContent = `${company.currentRow}/${gameState.maxRows}`;
    document.getElementById('playerCash').textContent = `¥${company.cash}`;
    document.getElementById('equity').textContent = `¥${company.equity}`;

    // 固定費を計算して表示
    const fixedCost = calculateFixedCostTotal(company, gameState.currentPeriod);
    document.getElementById('fixedCostDisplay').textContent = `¥${fixedCost}`;

    // 能力サマリーを更新
    const mfgCapacity = getManufacturingCapacity(company);
    const salesCapacity = getSalesCapacity(company);
    const priceComp = getPriceCompetitiveness(company, 0);
    document.getElementById('mfgCapacityDisplay').textContent = mfgCapacity;
    document.getElementById('salesCapacityDisplay').textContent = salesCapacity;
    document.getElementById('priceCompDisplay').textContent = '+' + priceComp;

    // 材料
    const materialsHtml = Array(company.materials).fill('<div class="inv-block material"></div>').join('');
    document.getElementById('materialsDisplay').innerHTML = materialsHtml || '<span style="color:#999;font-size:10px;">0</span>';

    // 仕掛品
    const wipHtml = Array(company.wip).fill('<div class="inv-block wip"></div>').join('');
    document.getElementById('wipDisplay').innerHTML = wipHtml || '<span style="color:#999;font-size:10px;">0</span>';

    // 製品
    const productsHtml = Array(company.products).fill('<div class="inv-block product"></div>').join('');
    document.getElementById('productsDisplay').innerHTML = productsHtml || '<span style="color:#999;font-size:10px;">0</span>';

    // ワーカー
    const workersHtml = Array(company.workers).fill('<div class="person-dot worker">W</div>').join('');
    document.getElementById('workersDisplay').innerHTML = workersHtml || '<span style="color:#999;font-size:10px;">0</span>';

    // 機械
    let machinesHtml = '';
    company.machines.forEach(m => {
        if (m.type === 'large') {
            machinesHtml += '<div class="machine-dot large">大</div>';
        } else {
            machinesHtml += `<div class="machine-dot">小${m.attachments > 0 ? '+' : ''}</div>`;
        }
    });
    document.getElementById('machinesDisplay').innerHTML = machinesHtml || '<span style="color:#999;font-size:10px;">0</span>';

    // セールスマン
    const salesmenHtml = Array(company.salesmen).fill('<div class="person-dot salesman">S</div>').join('');
    document.getElementById('salesmenDisplay').innerHTML = salesmenHtml || '<span style="color:#999;font-size:10px;">0</span>';

    // チップ
    document.getElementById('researchChipsDisplay').innerHTML =
        Array(company.chips.research || 0).fill('<div class="chip research"></div>').join('') || '-';
    document.getElementById('educationChipsDisplay').innerHTML =
        Array(company.chips.education || 0).fill('<div class="chip education"></div>').join('') || '-';
    document.getElementById('advertisingChipsDisplay').innerHTML =
        Array(company.chips.advertising || 0).fill('<div class="chip advertising"></div>').join('') || '-';
    document.getElementById('computerChipsDisplay').innerHTML =
        Array(company.chips.computer || 0).fill('<div class="chip computer"></div>').join('') || '-';
    document.getElementById('insuranceChipsDisplay').innerHTML =
        Array(company.chips.insurance || 0).fill('<div class="chip insurance"></div>').join('') || '-';
}

// 市場盤を描画
function renderMarketsBoard() {
    // 市場名→CSSクラス名のマッピング
    const marketClasses = {
        '東京': 'tokyo',
        '名古屋': 'nagoya',
        '大阪': 'osaka',
        '福岡': 'fukuoka',
        '海外': 'overseas',
        '仙台': 'sendai',
        '札幌': 'sapporo'
    };

    // 表示順（販売上限価格の高い順）
    const displayOrder = ['仙台', '札幌', '福岡', '名古屋', '大阪', '東京', '海外'];

    const company = gameState.companies[0];
    const period = gameState.currentPeriod;

    let html = '';
    displayOrder.forEach(marketName => {
        const market = gameState.markets.find(m => m.name === marketName);
        if (!market) return;
        const marketIndex = gameState.markets.indexOf(market);

        const marketClass = marketClasses[market.name] || '';
        const stockHtml = Array(Math.min(market.currentStock, 12)).fill('<div class="stock-cube"></div>').join('');
        const stockExtra = market.currentStock > 12 ? `+${market.currentStock - 12}` : '';

        // 閉鎖中かどうか
        const closedClass = market.closed ? 'closed' : '';

        // モード別の利用可能チェック
        let unavailableClass = '';
        let onClickHandler = '';

        // 2市場モードで選択済みかチェック（同時・別々両方）
        const isSelected = (gameState.twoMarketMode === 'simultaneous' || gameState.twoMarketMode === 'separate') &&
            gameState.selectedMarkets && gameState.selectedMarkets.includes(marketIndex);

        if (gameState.salesMode) {
            // 販売モード: 2期は海外禁止、閉鎖市場禁止、在庫満杯禁止
            const isFull = market.currentStock >= market.maxStock;
            const isOverseasIn2nd = period === 2 && market.name === '海外';
            // 2市場同時モードでは入札市場のみ
            const needsBidOnly = gameState.twoMarketMode === 'simultaneous' && !market.needsBid;
            if (market.closed || isFull || isOverseasIn2nd || needsBidOnly) {
                unavailableClass = 'unavailable';
            } else {
                onClickHandler = `onclick="onMarketTileClick(${marketIndex}, 'sell')"`;
            }
        } else if (gameState.buyMode) {
            // 購入モード: 閉鎖市場禁止、在庫がない市場禁止
            const isEmpty = market.currentStock <= 0;
            if (market.closed || isEmpty) {
                unavailableClass = 'unavailable';
            } else {
                onClickHandler = `onclick="onMarketTileClick(${marketIndex}, 'buy')"`;
            }
        }

        // マーケットボリューム（海外は無制限）
        const volumeText = market.name === '海外' ? '∞' : market.maxStock;

        const selectedClass = isSelected ? 'selected' : '';
        const selectedBadge = isSelected ? '<div style="position:absolute;top:2px;right:2px;background:#8b5cf6;color:white;border-radius:50%;width:20px;height:20px;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:bold;">✓</div>' : '';

        html += `
            <div class="market-tile ${marketClass} ${closedClass} ${unavailableClass} ${selectedClass}" ${onClickHandler} style="position:relative;">
                ${selectedBadge}
                <div class="market-name">${market.name}</div>
                <div class="market-volume">MV:${volumeText}</div>
                <div class="market-prices">
                    <span class="price-badge buy">${market.buyPrice}</span>
                    <span class="price-badge sell">${market.sellPrice}</span>
                </div>
                <div class="market-stock">${stockHtml}${stockExtra ? `<span style="color:#fff;font-size:10px;margin-left:2px;">${stockExtra}</span>` : ''}</div>
            </div>
        `;
    });
    document.getElementById('marketsDisplay').innerHTML = html;

    // モードに応じて市場盤にクラスを追加
    const marketsBoard = document.querySelector('.markets-board');
    if (marketsBoard) {
        marketsBoard.classList.toggle('sales-mode', gameState.salesMode);
        marketsBoard.classList.toggle('buy-mode', gameState.buyMode);
    }
}

// 固定費内訳を描画
function renderFixedCostBreakdown(company) {
    const period = gameState.currentPeriod;
    const baseCost = {2: 22, 3: 24, 4: 26, 5: 28};
    let unitCost = baseCost[period] || 22;

    if (period >= 3 && gameState.wageMultiplier > 1) {
        unitCost = Math.round(baseCost[period] * gameState.wageMultiplier);
    }

    const halfCost = Math.round(unitCost / 2);
    const machineCount = company.machines.length;
    const effectiveWorkers = company.workers + (company.retiredWorkers || 0) * 0.5;
    const effectiveSalesmen = company.salesmen + (company.retiredSalesmen || 0) * 0.5;
    const maxPersonnel = company.maxPersonnel || (company.workers + company.salesmen);

    const machineCost = machineCount * unitCost;
    const workerCost = Math.round(effectiveWorkers * unitCost);
    const salesmenCost = Math.round(effectiveSalesmen * unitCost);
    const maxPersonnelCost = maxPersonnel * halfCost;
    const salaryCost = machineCost + workerCost + salesmenCost + maxPersonnelCost;

    // 減価償却
    let depreciationCost = 0;
    company.machines.forEach(m => {
        if (period === 2) {
            depreciationCost += m.type === 'large' ? 20 : 10;
        } else {
            if (m.type === 'large') depreciationCost += 40;
            else depreciationCost += m.attachments > 0 ? 26 : 20;
        }
    });

    const extraLabor = company.extraLaborCost || 0;
    const totalFixed = salaryCost + depreciationCost + extraLabor;

    const html = `
        <div class="cost-item"><span>給料(機械×${unitCost})</span><span>¥${machineCost}</span></div>
        <div class="cost-item"><span>給料(W${effectiveWorkers}×${unitCost})</span><span>¥${workerCost}</span></div>
        <div class="cost-item"><span>給料(S${effectiveSalesmen}×${unitCost})</span><span>¥${salesmenCost}</span></div>
        <div class="cost-item"><span>期中最大(${maxPersonnel}×${halfCost})</span><span>¥${maxPersonnelCost}</span></div>
        <div class="cost-item"><span>減価償却</span><span>¥${depreciationCost}</span></div>
        ${extraLabor > 0 ? `<div class="cost-item"><span>その他人件費</span><span>¥${extraLabor}</span></div>` : ''}
        <div class="cost-item cost-total"><span>F合計</span><span>¥${totalFixed}</span></div>
    `;
    document.getElementById('fixedCostBreakdown').innerHTML = html;
}

// 他社一覧を描画（市場盤の周囲に配置）- プレイヤーと同じフル会社盤表示
function renderOtherCompanies() {
    const others = gameState.companies.slice(1);

    // 他社会社盤のHTML生成関数（プレイヤーと同じ形式）
    function createCompanyBoard(company, idx) {
        const isCurrent = gameState.currentPlayerIndex === idx + 1;

        // 材料ブロック
        const materialsHtml = Array(company.materials).fill('<div class="inv-block material"></div>').join('');
        // 仕掛品ブロック
        const wipHtml = Array(company.wip).fill('<div class="inv-block wip"></div>').join('');
        // 製品ブロック
        const productsHtml = Array(company.products).fill('<div class="inv-block product"></div>').join('');

        // ワーカー
        const workersHtml = Array(company.workers).fill('<div class="person-dot worker">W</div>').join('');
        // 機械
        const machinesHtml = company.machines.map(m =>
            `<div class="machine-dot ${m.type === 'large' ? 'large' : ''}">${m.type === 'large' ? '大' : '小'}${m.attachments > 0 ? '+' : ''}</div>`
        ).join('');
        // セールスマン
        const salesmenHtml = Array(company.salesmen).fill('<div class="person-dot salesman">S</div>').join('');

        // チップ
        const researchHtml = Array(company.chips.research || 0).fill('<div class="chip research"></div>').join('');
        const educationHtml = Array(company.chips.education || 0).fill('<div class="chip education"></div>').join('');
        const advertisingHtml = Array(company.chips.advertising || 0).fill('<div class="chip advertising"></div>').join('');
        const computerHtml = Array(company.chips.computer || 0).fill('<div class="chip computer"></div>').join('');
        const insuranceHtml = Array(company.chips.insurance || 0).fill('<div class="chip insurance"></div>').join('');

        return `
            <div class="other-company-board ${isCurrent ? 'current-turn' : ''}">
                <div class="board-title-mini">
                    ${company.name}
                    <span style="color: #4ade80;">¥${company.cash}</span>
                    <span style="background: ${(company.currentRow || 1) >= gameState.maxRows - 5 ? '#ef4444' : '#3b82f6'}; color: white; padding: 1px 4px; border-radius: 3px; font-size: 9px; margin-left: 4px;">
                        ${company.currentRow || 1}/${gameState.maxRows}
                    </span>
                </div>

                <!-- 生産フロー -->
                <div class="production-flow-mini">
                    <div class="flow-box-mini">
                        <div class="flow-box-title-mini">材料</div>
                        <div class="flow-box-content-mini">${materialsHtml || '-'}</div>
                    </div>
                    <div class="flow-box-mini factory">
                        <div class="flow-box-title-mini">仕掛</div>
                        <div class="flow-box-content-mini">${wipHtml || '-'}</div>
                    </div>
                    <div class="flow-box-mini">
                        <div class="flow-box-title-mini">製品</div>
                        <div class="flow-box-content-mini">${productsHtml || '-'}</div>
                    </div>
                </div>

                <!-- 人員・機械 -->
                <div class="personnel-row-mini">
                    <div class="personnel-box-mini">
                        <div class="personnel-box-title-mini">W</div>
                        <div class="personnel-dots-mini">${workersHtml || '-'}</div>
                    </div>
                    <div class="personnel-box-mini">
                        <div class="personnel-box-title-mini">機</div>
                        <div class="personnel-dots-mini">${machinesHtml || '-'}</div>
                    </div>
                    <div class="personnel-box-mini">
                        <div class="personnel-box-title-mini">S</div>
                        <div class="personnel-dots-mini">${salesmenHtml || '-'}</div>
                    </div>
                </div>

                <!-- チップ -->
                <div class="chips-row-mini">
                    <div class="chip-box-mini" title="研究">${researchHtml || '-'}</div>
                    <div class="chip-box-mini" title="教育">${educationHtml || '-'}</div>
                    <div class="chip-box-mini" title="広告">${advertisingHtml || '-'}</div>
                    <div class="chip-box-mini" title="PC">${computerHtml || '-'}</div>
                    <div class="chip-box-mini" title="保険">${insuranceHtml || '-'}</div>
                </div>
            </div>
        `;
    }

    // 5社を上2・左1・右2に配置
    let topHtml = '';
    let leftHtml = '';
    let rightHtml = '';

    others.forEach((company, idx) => {
        const board = createCompanyBoard(company, idx);
        if (idx < 2) {
            topHtml += board;  // A社、B社
        } else if (idx === 2) {
            leftHtml += board;  // C社
        } else {
            rightHtml += board;  // D社、E社
        }
    });

    document.getElementById('otherCompaniesTop').innerHTML = topHtml;
    document.getElementById('otherCompaniesLeft').innerHTML = leftHtml;
    document.getElementById('otherCompaniesRight').innerHTML = rightHtml;
}

// ============================================
// トースト通知システム
// ============================================
function showToast(message, type = 'info', duration = 3000) {
    const container = document.getElementById('toastContainer');
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;

    const icons = {
        info: 'ℹ️',
        success: '✅',
        warning: '⚠️',
        danger: '❌'
    };

    const titles = {
        info: 'お知らせ',
        success: '成功',
        warning: '注意',
        danger: '警告'
    };

    toast.innerHTML = `
        <button class="toast-close" onclick="this.parentElement.remove()">×</button>
        <div class="toast-header">
            <span class="toast-icon">${icons[type] || icons.info}</span>
            <span class="toast-title">${titles[type] || titles.info}</span>
        </div>
        <div class="toast-body">${message}</div>
    `;

    container.appendChild(toast);

    // 自動削除
    setTimeout(() => {
        toast.classList.add('hiding');
        setTimeout(() => toast.remove(), 300);
    }, duration);

    return toast;
}

// Modal functions
function showModal(title, content) {
    const modalHtml = `
        <div class="modal active">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title">${title}</h3>
                    <button class="close-btn" onclick="closeModal(true)">✕ 閉じる</button>
                </div>
                <div class="modal-body">
                    ${content}
                </div>
            </div>
        </div>
    `;
    document.getElementById('modalContainer').innerHTML = modalHtml;
}

// 保険再加入モーダル
function showInsuranceRepurchaseModal(disasterType, lostItems, compensation, netLoss) {
    const company = gameState.companies[0];
    const canAfford = company.cash >= 5;

    const itemLabel = disasterType === '倉庫火災' ? '材料' : '商品';
    const content = `
        <div style="padding: 15px; text-align: center;">
            <div style="background: linear-gradient(135deg, #dc2626 0%, #ef4444 100%); border-radius: 12px; padding: 20px; margin-bottom: 15px; color: white;">
                <div style="font-size: 24px; margin-bottom: 10px;">⚠️ ${disasterType}発生！</div>
                <div style="font-size: 14px;">
                    <div>${itemLabel} ${lostItems}個をストッカーへ</div>
                    <div>保険金 ¥${compensation} を受け取りました</div>
                    <div>特別損失 ¥${netLoss}</div>
                </div>
            </div>

            <div style="background: #fef3c7; border-radius: 8px; padding: 15px; margin-bottom: 15px;">
                <div style="font-weight: bold; color: #92400e; margin-bottom: 10px;">
                    保険チップを消費しました
                </div>
                <div style="font-size: 14px; color: #78350f;">
                    再加入: ¥5（現在の現金: ¥${company.cash}）
                </div>
            </div>

            <div style="display: flex; gap: 10px; justify-content: center;">
                ${canAfford ? `
                    <button class="action-btn primary" onclick="repurchaseInsurance()" style="flex: 1;">
                        再加入する（¥5）
                    </button>
                ` : ''}
                <button class="action-btn secondary" onclick="closeModal(); updateDisplay();" style="flex: 1;">
                    ${canAfford ? '再加入しない' : '閉じる'}
                </button>
            </div>
        </div>
    `;

    showModal('保険使用', content);
}

// 保険再加入処理
function repurchaseInsurance() {
    const company = gameState.companies[0];
    if (company.cash >= 5) {
        company.cash -= 5;
        company.chips.insurance = 1;
        alert('保険に再加入しました（¥5）');
    } else {
        alert('資金が不足しています');
    }
    closeModal();
    updateDisplay();
}

// 固定費内訳モーダル表示
function showFixedCostModal() {
    const company = gameState.companies[0];
    const period = gameState.currentPeriod;
    const baseCost = {2: 22, 3: 24, 4: 26, 5: 28};
    let unitCost = baseCost[period] || 22;

    if (period >= 3 && gameState.wageMultiplier > 1) {
        unitCost = Math.round(baseCost[period] * gameState.wageMultiplier);
    }

    const halfCost = Math.round(unitCost / 2);
    const machineCount = company.machines.length;
    const effectiveWorkers = company.workers + (company.retiredWorkers || 0) * 0.5;
    const effectiveSalesmen = company.salesmen + (company.retiredSalesmen || 0) * 0.5;
    const maxPersonnel = company.maxPersonnel || (company.workers + company.salesmen);

    const machineCost = machineCount * unitCost;
    const workerCost = Math.round(effectiveWorkers * unitCost);
    const salesmenCost = Math.round(effectiveSalesmen * unitCost);
    const maxPersonnelCost = maxPersonnel * halfCost;
    const salaryCost = machineCost + workerCost + salesmenCost + maxPersonnelCost;

    // 減価償却
    let depreciationCost = 0;
    company.machines.forEach(m => {
        if (period === 2) {
            depreciationCost += m.type === 'large' ? 20 : 10;
        } else {
            if (m.type === 'large') depreciationCost += 40;
            else depreciationCost += m.attachments > 0 ? 26 : 20;
        }
    });

    // 戦略チップ費用
    const carriedOver = company.carriedOverChips || {research: 0, education: 0, advertising: 0};
    let chipCost = 0;
    let chipDetails = [];

    if (period === 2) {
        const researchCost = (company.chips.research || 0) * 20;
        const educationCost = (company.chips.education || 0) * 20;
        const advertisingCost = (company.chips.advertising || 0) * 20;
        chipCost = researchCost + educationCost + advertisingCost;
        if (researchCost > 0) chipDetails.push(`研究 ${company.chips.research}枚×¥20 = ¥${researchCost}`);
        if (educationCost > 0) chipDetails.push(`教育 ${company.chips.education}枚×¥20 = ¥${educationCost}`);
        if (advertisingCost > 0) chipDetails.push(`広告 ${company.chips.advertising}枚×¥20 = ¥${advertisingCost}`);
    } else {
        // 繰り越し分（20円）
        const carryResearch = (carriedOver.research || 0) * 20;
        const carryEducation = (carriedOver.education || 0) * 20;
        const carryAdvertising = (carriedOver.advertising || 0) * 20;
        // 特急分（40円）
        const urgentResearch = Math.max(0, (company.chips.research || 0) - (carriedOver.research || 0)) * 40;
        const urgentEducation = Math.max(0, (company.chips.education || 0) - (carriedOver.education || 0)) * 40;
        const urgentAdvertising = Math.max(0, (company.chips.advertising || 0) - (carriedOver.advertising || 0)) * 40;
        // 次期繰り越し分（20円）
        const nextResearch = (company.nextPeriodChips?.research || 0) * 20;
        const nextEducation = (company.nextPeriodChips?.education || 0) * 20;
        const nextAdvertising = (company.nextPeriodChips?.advertising || 0) * 20;

        chipCost = carryResearch + carryEducation + carryAdvertising +
                   urgentResearch + urgentEducation + urgentAdvertising +
                   nextResearch + nextEducation + nextAdvertising;

        if (carriedOver.research > 0) chipDetails.push(`研究(繰越) ${carriedOver.research}枚×¥20 = ¥${carryResearch}`);
        if (urgentResearch > 0) chipDetails.push(`研究(特急) ${(company.chips.research - carriedOver.research)}枚×¥40 = ¥${urgentResearch}`);
        if (carriedOver.education > 0) chipDetails.push(`教育(繰越) ${carriedOver.education}枚×¥20 = ¥${carryEducation}`);
        if (urgentEducation > 0) chipDetails.push(`教育(特急) ${(company.chips.education - carriedOver.education)}枚×¥40 = ¥${urgentEducation}`);
        if (carriedOver.advertising > 0) chipDetails.push(`広告(繰越) ${carriedOver.advertising}枚×¥20 = ¥${carryAdvertising}`);
        if (urgentAdvertising > 0) chipDetails.push(`広告(特急) ${(company.chips.advertising - carriedOver.advertising)}枚×¥40 = ¥${urgentAdvertising}`);
        if (nextResearch > 0) chipDetails.push(`研究(次期) ${company.nextPeriodChips.research}枚×¥20 = ¥${nextResearch}`);
        if (nextEducation > 0) chipDetails.push(`教育(次期) ${company.nextPeriodChips.education}枚×¥20 = ¥${nextEducation}`);
        if (nextAdvertising > 0) chipDetails.push(`広告(次期) ${company.nextPeriodChips.advertising}枚×¥20 = ¥${nextAdvertising}`);
    }

    // コンピュータ・保険
    const computerCost = (company.chips.computer || 0) * 20;
    const insuranceCost = (company.chips.insurance || 0) * 5;

    // 金利
    const longInterest = Math.round((company.loans || 0) * 0.10);
    const shortInterest = Math.round((company.shortLoans || 0) * 0.20);

    // その他人件費（採用費、退職費、リスクカードなど）
    const extraLabor = company.extraLaborCost || 0;

    // 合計
    const totalFixed = salaryCost + depreciationCost + chipCost + computerCost + insuranceCost +
                       longInterest + shortInterest + extraLabor;

    const content = `
        <div class="breakdown-list" style="max-height: 400px; overflow-y: auto;">
            <div style="font-weight: bold; color: #1e40af; margin-bottom: 12px; font-size: 14px;">給料（単価: ¥${unitCost}）</div>
            <div class="breakdown-item">
                <span class="breakdown-item-label">機械 ${machineCount}台 × ¥${unitCost}</span>
                <span class="breakdown-item-value">¥${machineCost}</span>
            </div>
            <div class="breakdown-item">
                <span class="breakdown-item-label">ワーカー ${effectiveWorkers}人 × ¥${unitCost}</span>
                <span class="breakdown-item-value">¥${workerCost}</span>
            </div>
            <div class="breakdown-item">
                <span class="breakdown-item-label">セールス ${effectiveSalesmen}人 × ¥${unitCost}</span>
                <span class="breakdown-item-value">¥${salesmenCost}</span>
            </div>
            <div class="breakdown-item">
                <span class="breakdown-item-label">期中最大 ${maxPersonnel}人 × ¥${halfCost}</span>
                <span class="breakdown-item-value">¥${maxPersonnelCost}</span>
            </div>
            <div style="font-weight: bold; color: #1e40af; margin: 12px 0; font-size: 14px;">減価償却・その他</div>
            <div class="breakdown-item">
                <span class="breakdown-item-label">減価償却</span>
                <span class="breakdown-item-value">¥${depreciationCost}</span>
            </div>
            ${chipCost > 0 ? `
            <div style="font-weight: bold; color: #059669; margin: 12px 0; font-size: 12px;">戦略チップ</div>
            ${chipDetails.map(d => `<div class="breakdown-item" style="font-size: 11px;"><span>${d}</span></div>`).join('')}
            <div class="breakdown-item">
                <span class="breakdown-item-label">チップ合計</span>
                <span class="breakdown-item-value">¥${chipCost}</span>
            </div>
            ` : ''}
            ${computerCost > 0 ? `
            <div class="breakdown-item">
                <span class="breakdown-item-label">コンピュータ ${company.chips.computer}枚×¥20</span>
                <span class="breakdown-item-value">¥${computerCost}</span>
            </div>
            ` : ''}
            ${insuranceCost > 0 ? `
            <div class="breakdown-item">
                <span class="breakdown-item-label">保険 ${company.chips.insurance}枚×¥5</span>
                <span class="breakdown-item-value">¥${insuranceCost}</span>
            </div>
            ` : ''}
            ${longInterest > 0 ? `
            <div class="breakdown-item">
                <span class="breakdown-item-label">長期借入金利 ¥${company.loans}×10%</span>
                <span class="breakdown-item-value">¥${longInterest}</span>
            </div>
            ` : ''}
            ${shortInterest > 0 ? `
            <div class="breakdown-item">
                <span class="breakdown-item-label">短期借入金利 ¥${company.shortLoans}×20%</span>
                <span class="breakdown-item-value">¥${shortInterest}</span>
            </div>
            ` : ''}
            ${extraLabor > 0 ? `
            <div class="breakdown-item">
                <span class="breakdown-item-label">その他（採用費・リスク等）</span>
                <span class="breakdown-item-value">¥${extraLabor}</span>
            </div>
            ` : ''}
            <div class="breakdown-total">
                <span>F合計</span>
                <span>¥${totalFixed}</span>
            </div>
        </div>
    `;

    showModal('F（固定費）内訳', content);
}

function closeModal(returnToDecision = false) {
    document.getElementById('modalContainer').innerHTML = '';
    // 意思決定カードから来た場合は意思決定カードに戻る
    if (returnToDecision && gameState.currentPlayerIndex === 0) {
        showDecisionCard();
    }
}

// Buy materials modal - 購入モードに入る
function showBuyMaterialsModal() {
    enterBuyMode();
}

// Update material purchase cost (for multiple markets - not used now)
function updateMaterialCost() {
    let totalCost = 0;
    let rowsUsed = 0;
    
    gameState.markets.forEach((market, i) => {
        const qty = parseInt(document.getElementById(`market_${i}`).value || 0);
        if (qty > 0) {
            totalCost += market.buyPrice * qty;
            rowsUsed++;
        }
    });
    
    document.getElementById('totalCost').textContent = `¥${totalCost}`;
    document.getElementById('rowsUsed').textContent = rowsUsed;
}

// Buy materials from multiple markets
function buyMaterialsFromMultiple() {
    const company = gameState.companies[0];
    let totalCost = 0;
    let totalQty = 0;
    let rowsUsed = 0;
    let purchases = [];
    
    // 各市場からの購入を収集
    gameState.markets.forEach((market, i) => {
        const qty = parseInt(document.getElementById(`market_${i}`).value || 0);
        if (qty > 0) {
            totalCost += market.buyPrice * qty;
            totalQty += qty;
            rowsUsed++;
            purchases.push({market: market, qty: qty, cost: market.buyPrice * qty});
        }
    });
    
    if (rowsUsed === 0) {
        showToast('購入する市場を選択してください', 'warning', 3000);
        return;
    }
    
    // 倉庫容量チェック
    const newMaterialCount = company.materials + totalQty;
    const maxMaterialCapacity = getMaterialCapacity(company);
    if (newMaterialCount > maxMaterialCapacity) {
        if (company.warehouses === 0) {
            alert(`材料置場に10個以上置くには無災害倉庫が必要です。\n現在: ${company.materials}個、購入後: ${newMaterialCount}個`);
        } else {
            alert(`材料置場の容量（${maxMaterialCapacity}個）を超えます。\n現在: ${company.materials}個、購入後: ${newMaterialCount}個`);
        }
        return;
    }
    
    // 行数チェック
    if (gameState.currentRow + rowsUsed - 1 > gameState.maxRows) {
        alert(`行数が不足しています（必要: ${rowsUsed}行、残り: ${gameState.maxRows - gameState.currentRow + 1}行）`);
        return;
    }
    
    // 現金チェックと短期借入
    if (company.cash < totalCost) {
        const needed = Math.ceil((totalCost - company.cash) / 0.8 / 50) * 50;
        company.shortLoans += needed;
        company.cash += needed * 0.8;  // 短期借入: 借入時20%金利控除
        showToast(`現金不足のため短期借入¥${needed}を実行しました`, 'warning', 4000);
    }
    
    // 購入実行
    company.cash -= totalCost;
    company.materials += totalQty;
    company.totalMaterialCost += totalCost;

    // 各市場の在庫を減らす
    purchases.forEach(p => {
        const marketIndex = gameState.markets.indexOf(p.market);
        gameState.markets[marketIndex].currentStock -= p.qty;
    });

    // 行動ログ記録（複数市場からの購入）
    const purchaseDetails = purchases.map(p => `${p.market.name}¥${p.market.buyPrice}×${p.qty}`).join(', ');
    logAction(0, '材料購入', purchaseDetails, -totalCost, true);

    // 使用行数分進める
    gameState.currentRow += rowsUsed - 1; // -1は通常のendTurnで1行進むため

    closeModal();
    updateDisplay();

    // 購入結果を表示
    let message = `材料${totalQty}個を¥${totalCost}で購入しました\n`;
    purchases.forEach(p => {
        message += `${p.market.name}: ${p.qty}個 (¥${p.cost})\n`;
    });
    message += `${rowsUsed}行使用しました`;
    alert(message);

    endTurn();
}

// Buy materials (single market - legacy support)
function buyMaterials() {
    const company = gameState.companies[0];
    const marketIndex = parseInt(document.getElementById('marketSelect').value);
    const quantity = parseInt(document.getElementById('quantity').value);
    const market = gameState.markets[marketIndex];
    
    // Check warehouse capacity
    const newMaterialCount = company.materials + quantity;
    const maxMaterialCapacity = getMaterialCapacity(company);
    if (newMaterialCount > maxMaterialCapacity) {
        if (company.warehouses === 0) {
            alert(`材料置場に10個以上置くには無災害倉庫が必要です。\n現在: ${company.materials}個、購入後: ${newMaterialCount}個`);
        } else {
            alert(`材料置場の容量（${maxMaterialCapacity}個）を超えます。\n現在: ${company.materials}個、購入後: ${newMaterialCount}個`);
        }
        return;
    }
    
    const cost = market.buyPrice * quantity;
    
    if (company.cash < cost) {
        // 短期借入
        const needed = Math.ceil((cost - company.cash) / 0.8 / 50) * 50;
        company.shortLoans += needed;
        company.cash += needed * 0.8;  // 短期借入: 借入時20%金利控除
        showToast(`現金不足のため短期借入¥${needed}を実行しました`, 'warning', 4000);
    }
    
    if (quantity > market.currentStock) {
        showToast('在庫が不足しています！', 'danger', 3000);
        return;
    }
    
    company.cash -= cost;
    company.materials += quantity;
    company.totalMaterialCost += cost;
    market.currentStock -= quantity;

    // 行動ログ記録
    logAction(0, '材料購入', `${market.name}から¥${market.buyPrice}×${quantity}個`, -cost, true);

    closeModal();
    updateDisplay();
    showToast(`${market.name}から材料${quantity}個を¥${cost}で購入しました`, 'success', 3000);
    endTurn();
}

// Production modal
function showProductionModal() {
    const company = gameState.companies[0];

    // 労災発生チェック（フラグはターン終了時にリセット）
    if (company.cannotProduce) {
        showToast('労災発生中のため生産できません！\n（材料購入、商品販売・入札、DO NOTHINGは可能）', 'danger', 4000);
        showDecisionCard();
        return;
    }

    const mfgCapacity = getManufacturingCapacity(company);

    const content = `
        <div style="background: #fef3c7; border-radius: 8px; padding: 10px; margin-bottom: 15px; text-align: center;">
            <div style="font-weight: bold; color: #92400e;">💰 持ち金: ¥${company.cash}</div>
        </div>
        <div style="background: linear-gradient(180deg, #e0f2fe 0%, #bae6fd 100%); border-radius: 12px; padding: 15px; margin-bottom: 15px; border: 2px solid #0284c7;">
            <div style="text-align: center; margin-bottom: 10px;">
                <span style="font-size: 12px; color: #0369a1;">製造能力</span>
                <span style="font-size: 28px; font-weight: bold; color: #0c4a6e; display: block;">${mfgCapacity}個</span>
            </div>
            <div style="display: flex; justify-content: space-around; text-align: center;">
                <div style="background: #fff; border-radius: 8px; padding: 8px 15px; border: 2px solid #9b59b6;">
                    <div style="font-size: 10px; color: #7c3aed;">材料</div>
                    <div style="font-size: 20px; font-weight: bold; color: #6d28d9;">${company.materials}</div>
                </div>
                <div style="font-size: 24px; color: #0284c7; display: flex; align-items: center;">→</div>
                <div style="background: #fff; border-radius: 8px; padding: 8px 15px; border: 2px dashed #a855f7;">
                    <div style="font-size: 10px; color: #a855f7;">仕掛品</div>
                    <div style="font-size: 20px; font-weight: bold; color: #9333ea;">${company.wip}</div>
                </div>
                <div style="font-size: 24px; color: #0284c7; display: flex; align-items: center;">→</div>
                <div style="background: #fff; border-radius: 8px; padding: 8px 15px; border: 2px solid #6366f1;">
                    <div style="font-size: 10px; color: #4f46e5;">製品</div>
                    <div style="font-size: 20px; font-weight: bold; color: #4338ca;">${company.products}</div>
                </div>
            </div>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 15px;">
            <div style="background: linear-gradient(180deg, #faf5ff 0%, #f3e8ff 100%); border-radius: 10px; padding: 12px; border: 2px solid #9b59b6;">
                <div style="font-size: 12px; font-weight: bold; color: #7c3aed; margin-bottom: 8px; text-align: center;">🔧 材料→仕掛品</div>
                <div style="font-size: 10px; color: #6b7280; text-align: center; margin-bottom: 5px;">（¥1/個）</div>
                <select id="matToWip" class="form-control" style="font-size: 18px; text-align: center; font-weight: bold;">
                    ${Array(Math.min(mfgCapacity, company.materials) + 1).fill(0).map((_, i) =>
                        `<option value="${i}" ${i === Math.min(mfgCapacity, company.materials) ? 'selected' : ''}>${i}個</option>`
                    ).join('')}
                </select>
            </div>
            <div style="background: linear-gradient(180deg, #eef2ff 0%, #e0e7ff 100%); border-radius: 10px; padding: 12px; border: 2px solid #6366f1;">
                <div style="font-size: 12px; font-weight: bold; color: #4f46e5; margin-bottom: 8px; text-align: center;">📦 仕掛品→製品</div>
                <div style="font-size: 10px; color: #6b7280; text-align: center; margin-bottom: 5px;">（¥1/個）</div>
                <select id="wipToProd" class="form-control" style="font-size: 18px; text-align: center; font-weight: bold;">
                    ${Array(Math.min(mfgCapacity, company.wip) + 1).fill(0).map((_, i) =>
                        `<option value="${i}" ${i === Math.min(mfgCapacity, company.wip) ? 'selected' : ''}>${i}個</option>`
                    ).join('')}
                </select>
            </div>
        </div>

        <div style="background: #f1f5f9; border-radius: 10px; padding: 12px; text-align: center; margin-bottom: 15px;">
            <span style="font-size: 14px; color: #475569;">生産コスト: </span>
            <span id="totalCost" style="font-size: 24px; font-weight: bold; color: #dc2626;">¥0</span>
        </div>

        <button class="submit-btn" onclick="produce()" style="width: 100%;">
            🏭 生産実行
        </button>
    `;

    showModal('🏭 完成・投入', content);

    // Update cost display
    const updateCost = () => {
        const matToWip = parseInt(document.getElementById('matToWip').value) || 0;
        const wipToProd = parseInt(document.getElementById('wipToProd').value) || 0;
        const cost = matToWip + wipToProd;
        document.getElementById('totalCost').textContent = `¥${cost}`;
    };

    // Set initial cost display
    updateCost();

    document.getElementById('matToWip').addEventListener('change', updateCost);
    document.getElementById('wipToProd').addEventListener('change', updateCost);
    updateCost();
}

// Production
function produce() {
    const company = gameState.companies[0];
    const matToWip = parseInt(document.getElementById('matToWip').value);
    const wipToProd = parseInt(document.getElementById('wipToProd').value);
    
    // Check capacity limits
    const newWip = company.wip + matToWip - wipToProd;
    const newProducts = company.products + wipToProd;
    
    if (newWip > 10) {
        alert('仕掛品置場の容量不足です。仕掛品は10個までです。');
        return;
    }
    
    const maxProductCapacity = getProductCapacity(company);
    if (newProducts > maxProductCapacity) {
        if (company.warehouses === 0 || company.warehouseLocation === 'materials') {
            alert(`製品置場に10個以上置くには無災害倉庫が必要です。\n現在: ${company.products}個、生産後: ${newProducts}個`);
        } else {
            alert(`製品置場の容量（${maxProductCapacity}個）を超えます。`);
        }
        return;
    }
    
    const cost = matToWip + wipToProd;
    
    if (company.cash < cost) {
        // 短期借入
        const needed = Math.ceil((cost - company.cash) / 0.8 / 50) * 50;
        company.shortLoans += needed;
        company.cash += needed * 0.8;  // 短期借入: 借入時20%金利控除
        showToast(`現金不足のため短期借入¥${needed}を実行しました`, 'warning', 4000);
    }
    
    company.cash -= cost;
    company.materials -= matToWip;
    company.wip = newWip;
    company.products = newProducts;
    company.totalProductionCost += cost;

    // 行動ログ記録
    const productionDetails = `材${matToWip}→仕掛, 仕掛${wipToProd}→製品`;
    logAction(0, '完成・投入', productionDetails, -cost, true);

    closeModal();
    updateDisplay();
    showToast(`材料${matToWip}個→仕掛品、仕掛品${wipToProd}個→製品を生産しました（¥${cost}）`, 'success', 3500);
    endTurn();
}

// 販売モードを開始
function enterSalesMode() {
    const company = gameState.companies[0];

    if (company.products <= 0) {
        showToast('製品在庫がありません', 'danger', 3000);
        return;
    }

    // 販売方式選択モーダルを表示
    showSalesTypeModal();
}

// 販売方式選択モーダル
function showSalesTypeModal() {
    const company = gameState.companies[0];
    const salesCapacity = getSalesCapacity(company);
    const availableMarkets = gameState.markets.filter(m => !m.closed && m.needsBid);
    const canTwoMarkets = availableMarkets.length >= 2 && company.products >= 2;

    const content = `
        <div style="padding: 10px;">
            <div style="background: #fef3c7; border-radius: 8px; padding: 12px; margin-bottom: 15px;">
                <div style="font-weight: bold; color: #92400e;">製品在庫: ${company.products}個 / 販売能力: ${salesCapacity}</div>
            </div>

            <div style="display: grid; gap: 12px;">
                <button onclick="startSingleMarketSale()" class="submit-btn" style="padding: 15px; font-size: 16px;">
                    <div style="font-weight: bold;">📍 1市場で販売</div>
                    <div style="font-size: 12px; opacity: 0.8;">1行使用</div>
                </button>

                ${canTwoMarkets ? `
                <button onclick="startTwoMarketSale()" class="submit-btn" style="padding: 15px; font-size: 16px; background: linear-gradient(180deg, #8b5cf6 0%, #7c3aed 100%);">
                    <div style="font-weight: bold;">📍📍 2市場同時販売</div>
                    <div style="font-size: 12px; opacity: 0.8;">同価格・1行使用（低い上限価格適用）</div>
                </button>

                <button onclick="startSeparateTwoMarketSale()" class="submit-btn" style="padding: 15px; font-size: 16px; background: linear-gradient(180deg, #f59e0b 0%, #d97706 100%);">
                    <div style="font-weight: bold;">📍+📍 2市場別々販売</div>
                    <div style="font-size: 12px; opacity: 0.8;">別価格・2行使用</div>
                </button>
                ` : `
                <div style="background: #f3f4f6; border-radius: 8px; padding: 12px; text-align: center; color: #6b7280;">
                    2市場販売には入札市場が2つ以上必要です
                </div>
                `}
            </div>

            <button onclick="closeModal(); showTurnStartOptions();" class="submit-btn" style="margin-top: 15px; background: linear-gradient(180deg, #6b7280 0%, #4b5563 100%);">
                ← 戻る
            </button>
        </div>
    `;

    showModal('💰 販売方式を選択', content);
}

// 1市場販売モード開始
function startSingleMarketSale() {
    const company = gameState.companies[0];
    gameState.salesMode = true;
    gameState.buyMode = false;
    gameState.twoMarketMode = false;
    closeModal();
    renderMarketsBoard();

    const instruction = document.createElement('div');
    instruction.className = 'market-instruction';
    instruction.id = 'marketInstruction';
    instruction.innerHTML = `
        <span>💰 販売したい市場をタップしてください（在庫: ${company.products}個）</span>
        <button class="cancel-mode-btn" onclick="cancelMarketMode()">キャンセル</button>
    `;
    document.body.appendChild(instruction);
}

// 2市場同時販売モード開始
function startTwoMarketSale() {
    const company = gameState.companies[0];
    gameState.salesMode = true;
    gameState.buyMode = false;
    gameState.twoMarketMode = 'simultaneous';
    gameState.selectedMarkets = [];
    closeModal();
    renderMarketsBoard();

    const instruction = document.createElement('div');
    instruction.className = 'market-instruction';
    instruction.id = 'marketInstruction';
    instruction.style.background = 'linear-gradient(180deg, #8b5cf6 0%, #7c3aed 100%)';
    instruction.innerHTML = `
        <span>📍📍 2つの市場を選択してください（同価格・1行）</span>
        <button class="cancel-mode-btn" onclick="cancelMarketMode()">キャンセル</button>
    `;
    document.body.appendChild(instruction);
}

// 2市場別々販売モード開始
function startSeparateTwoMarketSale() {
    const company = gameState.companies[0];
    gameState.salesMode = true;
    gameState.buyMode = false;
    gameState.twoMarketMode = 'separate';
    gameState.selectedMarkets = [];
    closeModal();
    renderMarketsBoard();

    const instruction = document.createElement('div');
    instruction.className = 'market-instruction';
    instruction.id = 'marketInstruction';
    instruction.style.background = 'linear-gradient(180deg, #f59e0b 0%, #d97706 100%)';
    instruction.innerHTML = `
        <span>📍+📍 2つの市場を選択してください（別価格・2行）</span>
        <button class="cancel-mode-btn" onclick="cancelMarketMode()">キャンセル</button>
    `;
    document.body.appendChild(instruction);
}

// 材料購入モーダル（複数市場対応）
function showMaterialPurchaseModal() {
    const company = gameState.companies[0];
    const remainingRows = gameState.maxRows - company.currentRow + 1;

    // 最も行数を使っている会社を取得
    const maxRowCompany = gameState.companies.reduce((max, c) =>
        (c.currentRow || 1) > (max.currentRow || 1) ? c : max
    );
    const isHighestRow = company === maxRowCompany;

    // 購入可能な市場を取得（閉鎖されていない市場のみ）
    const availableMarkets = gameState.markets.filter(m => !m.closed && m.currentStock > 0);

    // 3期以降は1市場からの購入上限 = 製造能力
    const mfgCapacity = getManufacturingCapacity(company);
    const isPeriod2 = gameState.currentPeriod === 2;

    let marketOptions = '';
    availableMarkets.forEach((market, i) => {
        const marketIndex = gameState.markets.indexOf(market);
        // 2期: 制限なし、3期以降: 製造能力が上限
        const maxPerMarket = isPeriod2 ? 99 : mfgCapacity;
        const maxBuy = Math.min(market.currentStock, 10 - company.materials, maxPerMarket);
        marketOptions += `
            <div style="background: #f3f4f6; border-radius: 8px; padding: 10px; margin-bottom: 10px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                    <span style="font-weight: bold;">${market.name}</span>
                    <span style="color: #059669; font-weight: bold;">¥${market.buyPrice}/個</span>
                </div>
                <div style="display: flex; align-items: center; gap: 10px;">
                    <span style="font-size: 12px; color: #6b7280;">在庫: ${market.currentStock}個</span>
                    <select id="market_${marketIndex}" class="form-control" style="flex: 1;">
                        <option value="0">購入しない</option>
                        ${Array.from({length: maxBuy}, (_, j) => `<option value="${j + 1}">${j + 1}個 (¥${market.buyPrice * (j + 1)})</option>`).join('')}
                    </select>
                </div>
            </div>
        `;
    });

    const content = `
        <div style="padding: 10px;">
            <div style="background: #fef3c7; border-radius: 8px; padding: 10px; margin-bottom: 15px;">
                <div style="font-weight: bold; color: #92400e;">現金: ¥${company.cash} / 材料: ${company.materials}個</div>
                <div style="font-size: 12px; color: #78350f;">残り行数: ${remainingRows}行</div>
                ${!isPeriod2 ? `<div style="font-size: 12px; color: #0369a1;">製造能力: ${mfgCapacity} (1市場あたり${mfgCapacity}個まで)</div>` : ''}
                ${isHighestRow ? `<div style="font-size: 12px; color: #dc2626; margin-top: 5px;">⚠️ あなたは行数トップです。2市場購入は慎重に。</div>` : ''}
            </div>
            <div style="font-size: 13px; color: #6b7280; margin-bottom: 10px;">
                複数市場から購入可能です（市場数×1行使用）
            </div>
            ${marketOptions}
            <button class="submit-btn" onclick="buyMaterialsFromMultiple()">購入実行</button>
        </div>
    `;

    showModal('📦 材料購入', content);
}

// 購入モードを開始
function enterBuyMode() {
    gameState.buyMode = true;
    gameState.salesMode = false;
    closeModal();
    renderMarketsBoard();

    const company = gameState.companies[0];

    // インストラクションを表示
    const instruction = document.createElement('div');
    instruction.className = 'market-instruction buy-mode';
    instruction.id = 'marketInstruction';
    instruction.innerHTML = `
        <span>📦 材料を購入する市場をタップしてください（現金: ¥${company.cash}）</span>
        <button class="cancel-mode-btn" onclick="cancelMarketMode()">キャンセル</button>
    `;
    document.body.appendChild(instruction);
}

// 市場選択モードをキャンセル
function cancelMarketMode() {
    gameState.salesMode = false;
    gameState.buyMode = false;
    gameState.twoMarketMode = false;
    gameState.selectedMarkets = [];
    gameState.pendingSeparateBids = null;
    const instruction = document.getElementById('marketInstruction');
    if (instruction) instruction.remove();
    renderMarketsBoard();
    showTurnStartOptions();
}

// 市場タイルがクリックされた時
function onMarketTileClick(marketIndex, action) {
    const market = gameState.markets[marketIndex];
    const company = gameState.companies[0];

    if (action === 'sell') {
        // 2市場同時販売モードの場合
        if (gameState.twoMarketMode === 'simultaneous') {
            if (!gameState.selectedMarkets) gameState.selectedMarkets = [];

            // 既に選択済みなら除外
            const existingIndex = gameState.selectedMarkets.indexOf(marketIndex);
            if (existingIndex >= 0) {
                gameState.selectedMarkets.splice(existingIndex, 1);
                updateMarketSelectionInstruction();
                renderMarketsBoard();
                return;
            }

            // 選択追加
            gameState.selectedMarkets.push(marketIndex);

            if (gameState.selectedMarkets.length === 2) {
                // 2市場選択完了
                const instruction = document.getElementById('marketInstruction');
                if (instruction) instruction.remove();
                gameState.salesMode = false;
                renderMarketsBoard();
                showTwoMarketSaleModal();
            } else {
                updateMarketSelectionInstruction();
                renderMarketsBoard();
            }
            return;
        }

        // 2市場別々販売モードの場合
        if (gameState.twoMarketMode === 'separate') {
            if (!gameState.selectedMarkets) gameState.selectedMarkets = [];

            // 既に選択済みなら除外
            const existingIndex = gameState.selectedMarkets.indexOf(marketIndex);
            if (existingIndex >= 0) {
                gameState.selectedMarkets.splice(existingIndex, 1);
                updateSeparateMarketSelectionInstruction();
                renderMarketsBoard();
                return;
            }

            // 選択追加
            gameState.selectedMarkets.push(marketIndex);

            if (gameState.selectedMarkets.length === 2) {
                // 2市場選択完了
                const instruction = document.getElementById('marketInstruction');
                if (instruction) instruction.remove();
                gameState.salesMode = false;
                renderMarketsBoard();
                showSeparateTwoMarketSaleModal();
            } else {
                updateSeparateMarketSelectionInstruction();
                renderMarketsBoard();
            }
            return;
        }

        // 通常の1市場販売
        const instruction = document.getElementById('marketInstruction');
        if (instruction) instruction.remove();
        gameState.salesMode = false;
        renderMarketsBoard();
        showSaleConfirmModal(marketIndex);
    } else if (action === 'buy') {
        const instruction = document.getElementById('marketInstruction');
        if (instruction) instruction.remove();
        gameState.buyMode = false;
        renderMarketsBoard();
        showBuyConfirmModal(marketIndex);
    }
}

// 2市場選択時のインストラクション更新（同時販売）
function updateMarketSelectionInstruction() {
    const instruction = document.getElementById('marketInstruction');
    if (instruction) {
        const selected = gameState.selectedMarkets || [];
        const marketNames = selected.map(i => gameState.markets[i].name).join('、');
        instruction.innerHTML = `
            <span>📍📍 2つの市場を選択 (${selected.length}/2) ${marketNames ? '- ' + marketNames : ''}</span>
            <button class="cancel-mode-btn" onclick="cancelMarketMode()">キャンセル</button>
        `;
    }
}

// 2市場選択時のインストラクション更新（別々販売）
function updateSeparateMarketSelectionInstruction() {
    const instruction = document.getElementById('marketInstruction');
    if (instruction) {
        const selected = gameState.selectedMarkets || [];
        const marketNames = selected.map(i => gameState.markets[i].name).join('、');
        instruction.innerHTML = `
            <span>📍+📍 2つの市場を選択 (${selected.length}/2) ${marketNames ? '- ' + marketNames : ''}</span>
            <button class="cancel-mode-btn" onclick="cancelMarketMode()">キャンセル</button>
        `;
    }
}

// 2市場別々販売モーダル
function showSeparateTwoMarketSaleModal() {
    const company = gameState.companies[0];
    const salesCapacity = getSalesCapacity(company);
    const market1 = gameState.markets[gameState.selectedMarkets[0]];
    const market2 = gameState.markets[gameState.selectedMarkets[1]];

    // 各市場のマーケットボリューム（空き容量）
    const volume1 = market1.maxStock - market1.currentStock;
    const volume2 = market2.maxStock - market2.currentStock;

    // 各市場への最大販売数
    const maxQty1 = Math.min(salesCapacity, volume1, company.products);
    const maxQty2 = Math.min(salesCapacity, volume2, company.products);

    const defaultPrice1 = market1.sellPrice - 4;
    const defaultPrice2 = market2.sellPrice - 4;

    const content = `
        <div style="padding: 10px;">
            <div style="background: linear-gradient(180deg, #f59e0b 0%, #d97706 100%); border-radius: 12px; padding: 15px; margin-bottom: 15px; color: white;">
                <div style="font-weight: bold; font-size: 16px; margin-bottom: 5px;">2市場別々販売</div>
                <div style="font-size: 12px;">各市場に異なる価格で入札（2行使用）</div>
            </div>

            <div style="background: #f1f5f9; border-radius: 8px; padding: 10px; margin-bottom: 10px;">
                <div style="font-weight: bold; color: #1e293b;">製品在庫: ${company.products}個 / 販売能力: ${salesCapacity}</div>
            </div>

            <!-- 1つ目の市場 -->
            <div style="background: #fef3c7; border-radius: 8px; padding: 12px; margin-bottom: 10px; border-left: 4px solid #f59e0b;">
                <div style="font-weight: bold; margin-bottom: 8px;">${market1.name}（上限¥${market1.sellPrice}、空き${volume1}個）</div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <div>
                        <label style="font-size: 12px; color: #666;">数量</label>
                        <select id="separateQty1" class="form-control" style="font-size: 14px;" onchange="updateSeparateTotal()">
                            <option value="0">販売しない</option>
                            ${Array(maxQty1).fill(0).map((_, i) => `<option value="${i+1}">${i+1}個</option>`).join('')}
                        </select>
                    </div>
                    <div>
                        <label style="font-size: 12px; color: #666;">入札価格</label>
                        <input type="number" id="separatePrice1" class="form-control" min="1" max="${market1.sellPrice}" value="${defaultPrice1}" style="font-size: 14px;">
                    </div>
                </div>
            </div>

            <!-- 2つ目の市場 -->
            <div style="background: #dbeafe; border-radius: 8px; padding: 12px; margin-bottom: 15px; border-left: 4px solid #3b82f6;">
                <div style="font-weight: bold; margin-bottom: 8px;">${market2.name}（上限¥${market2.sellPrice}、空き${volume2}個）</div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <div>
                        <label style="font-size: 12px; color: #666;">数量</label>
                        <select id="separateQty2" class="form-control" style="font-size: 14px;" onchange="updateSeparateTotal()">
                            <option value="0">販売しない</option>
                            ${Array(maxQty2).fill(0).map((_, i) => `<option value="${i+1}">${i+1}個</option>`).join('')}
                        </select>
                    </div>
                    <div>
                        <label style="font-size: 12px; color: #666;">入札価格</label>
                        <input type="number" id="separatePrice2" class="form-control" min="1" max="${market2.sellPrice}" value="${defaultPrice2}" style="font-size: 14px;">
                    </div>
                </div>
            </div>

            <div id="separateTotalInfo" style="background: #f3f4f6; border-radius: 8px; padding: 10px; margin-bottom: 15px; text-align: center;">
                <span style="color: #6b7280;">合計販売数量: <strong id="separateTotalQty">0</strong>個（販売能力: ${salesCapacity}）</span>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <button onclick="cancelSeparateTwoMarketSale()" class="submit-btn" style="background: linear-gradient(180deg, #6b7280 0%, #4b5563 100%);">
                    ← 戻る
                </button>
                <button onclick="processSeparateTwoMarketSale()" class="submit-btn" style="background: linear-gradient(180deg, #f59e0b 0%, #d97706 100%);">
                    💰 入札実行（2行）
                </button>
            </div>
        </div>
    `;

    showModal('📍+📍 2市場別々販売', content);
}

// 別々販売の合計数量を更新
function updateSeparateTotal() {
    const qty1 = parseInt(document.getElementById('separateQty1').value) || 0;
    const qty2 = parseInt(document.getElementById('separateQty2').value) || 0;
    document.getElementById('separateTotalQty').textContent = qty1 + qty2;
}

// 2市場別々販売をキャンセル
function cancelSeparateTwoMarketSale() {
    gameState.selectedMarkets = [];
    gameState.twoMarketMode = false;
    closeModal();
    showSalesTypeModal();
}

// 2市場別々販売を実行
function processSeparateTwoMarketSale() {
    const company = gameState.companies[0];
    const salesCapacity = getSalesCapacity(company);

    const qty1 = parseInt(document.getElementById('separateQty1').value) || 0;
    const qty2 = parseInt(document.getElementById('separateQty2').value) || 0;
    const price1 = parseInt(document.getElementById('separatePrice1').value);
    const price2 = parseInt(document.getElementById('separatePrice2').value);

    const totalQty = qty1 + qty2;

    if (totalQty === 0) {
        showToast('少なくとも1つの市場に販売数量を設定してください', 'warning', 3000);
        return;
    }

    if (totalQty > salesCapacity) {
        alert(`合計販売数量（${totalQty}個）が販売能力（${salesCapacity}個）を超えています`);
        return;
    }

    if (totalQty > company.products) {
        alert(`合計販売数量（${totalQty}個）が製品在庫（${company.products}個）を超えています`);
        return;
    }

    const market1 = gameState.markets[gameState.selectedMarkets[0]];
    const market2 = gameState.markets[gameState.selectedMarkets[1]];

    if (qty1 > 0 && price1 > market1.sellPrice) {
        alert(`${market1.name}の入札価格は上限¥${market1.sellPrice}以下にしてください`);
        return;
    }

    if (qty2 > 0 && price2 > market2.sellPrice) {
        alert(`${market2.name}の入札価格は上限¥${market2.sellPrice}以下にしてください`);
        return;
    }

    // 価格競争力を計算
    const competitiveness = getPriceCompetitiveness(company, 0);

    // 2市場別々入札として保存
    gameState.pendingSeparateBids = {
        bids: [],
        currentIndex: 0
    };

    if (qty1 > 0) {
        gameState.pendingSeparateBids.bids.push({
            marketIndex: gameState.selectedMarkets[0],
            quantity: qty1,
            price: price1 - competitiveness,
            displayPrice: price1,
            company: 0
        });
    }

    if (qty2 > 0) {
        gameState.pendingSeparateBids.bids.push({
            marketIndex: gameState.selectedMarkets[1],
            quantity: qty2,
            price: price2 - competitiveness,
            displayPrice: price2,
            company: 0
        });
    }

    closeModal();
    gameState.twoMarketMode = false;
    gameState.selectedMarkets = [];

    // 最初の市場の入札を処理
    processSeparateBidNext();
}

// 別々販売の次の入札を処理
function processSeparateBidNext() {
    const pending = gameState.pendingSeparateBids;

    if (pending.currentIndex >= pending.bids.length) {
        // 全ての入札完了
        gameState.pendingSeparateBids = null;
        updateDisplay();
        return;
    }

    const bid = pending.bids[pending.currentIndex];
    const market = gameState.markets[bid.marketIndex];

    // この入札をpendingBidに設定して通常の入札処理を実行
    gameState.pendingBid = bid;
    gameState.pendingSeparateBids.currentIndex++;

    // 他社の入札を処理
    showOtherPlayersBidModal(market, bid.marketIndex);
}

// 2市場同時販売モーダル
function showTwoMarketSaleModal() {
    const company = gameState.companies[0];
    const salesCapacity = getSalesCapacity(company);
    const market1 = gameState.markets[gameState.selectedMarkets[0]];
    const market2 = gameState.markets[gameState.selectedMarkets[1]];

    // 低い方の上限価格を適用
    const maxPrice = Math.min(market1.sellPrice, market2.sellPrice);
    const defaultPrice = maxPrice - 4;

    // 各市場のマーケットボリューム（空き容量）
    const volume1 = market1.maxStock - market1.currentStock;
    const volume2 = market2.maxStock - market2.currentStock;
    const totalVolume = volume1 + volume2;

    // 販売上限 = MIN(販売能力, 合計マーケットボリューム, 製品在庫)
    const maxQuantity = Math.min(salesCapacity, totalVolume, company.products);

    const content = `
        <div style="padding: 10px;">
            <div style="background: linear-gradient(180deg, #8b5cf6 0%, #7c3aed 100%); border-radius: 12px; padding: 15px; margin-bottom: 15px; color: white;">
                <div style="font-weight: bold; font-size: 16px; margin-bottom: 10px;">2市場同時販売</div>
                <div style="display: flex; justify-content: space-around;">
                    <div style="text-align: center;">
                        <div style="font-size: 12px; opacity: 0.8;">${market1.name}</div>
                        <div style="font-size: 14px;">上限¥${market1.sellPrice}</div>
                        <div style="font-size: 11px;">空き${volume1}個</div>
                    </div>
                    <div style="font-size: 24px;">+</div>
                    <div style="text-align: center;">
                        <div style="font-size: 12px; opacity: 0.8;">${market2.name}</div>
                        <div style="font-size: 14px;">上限¥${market2.sellPrice}</div>
                        <div style="font-size: 11px;">空き${volume2}個</div>
                    </div>
                </div>
                <div style="text-align: center; margin-top: 10px; padding-top: 10px; border-top: 1px solid rgba(255,255,255,0.3);">
                    <div style="font-size: 12px;">適用上限価格</div>
                    <div style="font-size: 24px; font-weight: bold;">¥${maxPrice}</div>
                </div>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                <div style="background: #f1f5f9; border-radius: 8px; padding: 10px; text-align: center;">
                    <div style="font-size: 11px; color: #64748b;">販売能力</div>
                    <div style="font-size: 20px; font-weight: bold;">${salesCapacity}</div>
                </div>
                <div style="background: #f1f5f9; border-radius: 8px; padding: 10px; text-align: center;">
                    <div style="font-size: 11px; color: #64748b;">製品在庫</div>
                    <div style="font-size: 20px; font-weight: bold;">${company.products}</div>
                </div>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                <div class="form-group" style="margin-bottom: 0;">
                    <label class="form-label">📦 販売数量</label>
                    <select id="twoMarketQuantity" class="form-control" style="font-size: 16px; text-align: center;">
                        ${Array(maxQuantity).fill(0).map((_, i) =>
                            `<option value="${i+1}" ${i+1 === maxQuantity ? 'selected' : ''}>${i+1}個</option>`
                        ).join('')}
                    </select>
                </div>
                <div class="form-group" style="margin-bottom: 0;">
                    <label class="form-label">💵 入札価格</label>
                    <input type="number" id="twoMarketPrice" class="form-control" min="1" max="${maxPrice}" value="${defaultPrice}" style="font-size: 16px; text-align: center;">
                </div>
            </div>

            <div style="font-size: 12px; color: #6b7280; margin-bottom: 15px; text-align: center;">
                ※ 両市場に同価格で入札（1行使用）
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <button onclick="cancelTwoMarketSale()" class="submit-btn" style="background: linear-gradient(180deg, #6b7280 0%, #4b5563 100%);">
                    ← 戻る
                </button>
                <button onclick="processTwoMarketSale()" class="submit-btn">
                    💰 入札実行
                </button>
            </div>
        </div>
    `;

    showModal('📍📍 2市場同時販売', content);
}

// 2市場同時販売をキャンセル
function cancelTwoMarketSale() {
    gameState.selectedMarkets = [];
    gameState.twoMarketMode = false;
    closeModal();
    showSalesTypeModal();
}

// 2市場同時販売を実行
function processTwoMarketSale() {
    const company = gameState.companies[0];
    const quantity = parseInt(document.getElementById('twoMarketQuantity').value);
    const bidPrice = parseInt(document.getElementById('twoMarketPrice').value);
    const salesCapacity = getSalesCapacity(company);

    if (quantity > salesCapacity) {
        alert(`販売能力（${salesCapacity}個）を超えて入札できません`);
        return;
    }

    const market1 = gameState.markets[gameState.selectedMarkets[0]];
    const market2 = gameState.markets[gameState.selectedMarkets[1]];
    const maxPrice = Math.min(market1.sellPrice, market2.sellPrice);

    if (bidPrice > maxPrice) {
        alert(`入札価格は上限価格¥${maxPrice}以下にしてください`);
        return;
    }

    // 価格競争力を計算
    const competitiveness = getPriceCompetitiveness(company, 0);
    const effectiveBidPrice = bidPrice - competitiveness;

    // 2市場同時入札として保存
    gameState.pendingBid = {
        markets: gameState.selectedMarkets,
        quantity: quantity,
        price: effectiveBidPrice,
        displayPrice: bidPrice,
        company: 0,
        isTwoMarket: true
    };

    closeModal();

    // 他社の入札を処理
    showOtherPlayersBidModalTwoMarket();
}

// 販売確認モーダル
function showSaleConfirmModal(marketIndex) {
    const market = gameState.markets[marketIndex];
    const company = gameState.companies[0];
    const salesCapacity = getSalesCapacity(company);
    const maxQuantity = Math.min(salesCapacity, company.products, market.maxStock - market.currentStock);
    const defaultPrice = market.sellPrice - 4;

    const content = `
        <div style="background: linear-gradient(180deg, #fef3c7 0%, #fde68a 100%); border-radius: 12px; padding: 15px; margin-bottom: 15px; border: 2px solid #f59e0b;">
            <div style="display: flex; justify-content: space-around; text-align: center;">
                <div>
                    <div style="font-size: 12px; color: #92400e;">選択市場</div>
                    <div style="font-size: 20px; font-weight: bold; color: #78350f;">${market.name}</div>
                </div>
                <div>
                    <div style="font-size: 12px; color: #92400e;">上限価格</div>
                    <div style="font-size: 20px; font-weight: bold; color: #059669;">¥${market.sellPrice}</div>
                </div>
                <div>
                    <div style="font-size: 12px; color: #92400e;">${market.needsBid ? '入札' : '即売'}</div>
                    <div style="font-size: 20px; font-weight: bold; color: ${market.needsBid ? '#dc2626' : '#2563eb'};">${market.needsBid ? '⚔️' : '✓'}</div>
                </div>
            </div>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 15px;">
            <div style="background: #f1f5f9; border-radius: 8px; padding: 10px; text-align: center;">
                <div style="font-size: 11px; color: #64748b;">販売能力</div>
                <div style="font-size: 22px; font-weight: bold; color: #1e293b;">${salesCapacity}</div>
            </div>
            <div style="background: #f1f5f9; border-radius: 8px; padding: 10px; text-align: center;">
                <div style="font-size: 11px; color: #64748b;">製品在庫</div>
                <div style="font-size: 22px; font-weight: bold; color: #1e293b;">${company.products}</div>
            </div>
        </div>

        <div style="display: grid; grid-template-columns: 1fr ${market.needsBid ? '1fr' : ''}; gap: 12px;">
            <div class="form-group" style="margin-bottom: 0;">
                <label class="form-label">📦 販売数量</label>
                <select id="quantity" class="form-control" style="font-size: 18px; text-align: center; font-weight: bold;">
                    ${maxQuantity > 0 ? Array(maxQuantity).fill(0).map((_, i) =>
                        `<option value="${i+1}" ${i+1 === maxQuantity ? 'selected' : ''}>${i+1}個</option>`
                    ).join('') : '<option value="0">販売不可</option>'}
                </select>
            </div>
            ${market.needsBid ? `
            <div class="form-group" style="margin-bottom: 0;" id="bidPriceGroup">
                <label class="form-label">💵 入札価格</label>
                <input type="number" id="bidPrice" class="form-control" min="1" max="${market.sellPrice}" value="${defaultPrice}" style="font-size: 18px; text-align: center; font-weight: bold;">
            </div>
            ` : ''}
        </div>

        <input type="hidden" id="marketSelect" value="${marketIndex}">

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px;">
            <button class="submit-btn" onclick="enterSalesMode()" style="background: linear-gradient(180deg, #6b7280 0%, #4b5563 100%);">
                ← 市場を変更
            </button>
            <button class="submit-btn" onclick="processSale()" ${maxQuantity <= 0 ? 'disabled' : ''}>
                💰 販売実行
            </button>
        </div>
    `;

    showModal(`💰 ${market.name}に販売`, content);
}

// 購入確認モーダル
function showBuyConfirmModal(marketIndex) {
    const market = gameState.markets[marketIndex];
    const company = gameState.companies[0];
    const maxQuantity = Math.min(market.currentStock, Math.floor(company.cash / market.buyPrice));

    // 材料倉庫の空き容量をチェック
    const maxMaterialCapacity = getMaterialCapacity(company);
    const spaceAvailable = maxMaterialCapacity - company.materials;
    const actualMax = Math.min(maxQuantity, spaceAvailable);

    const content = `
        <div style="background: linear-gradient(180deg, #dcfce7 0%, #bbf7d0 100%); border-radius: 12px; padding: 15px; margin-bottom: 15px; border: 2px solid #22c55e;">
            <div style="display: flex; justify-content: space-around; text-align: center;">
                <div>
                    <div style="font-size: 12px; color: #166534;">選択市場</div>
                    <div style="font-size: 20px; font-weight: bold; color: #14532d;">${market.name}</div>
                </div>
                <div>
                    <div style="font-size: 12px; color: #166534;">仕入価格</div>
                    <div style="font-size: 20px; font-weight: bold; color: #059669;">¥${market.buyPrice}</div>
                </div>
                <div>
                    <div style="font-size: 12px; color: #166534;">市場在庫</div>
                    <div style="font-size: 20px; font-weight: bold; color: #14532d;">${market.currentStock}個</div>
                </div>
            </div>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 15px;">
            <div style="background: #f1f5f9; border-radius: 8px; padding: 10px; text-align: center;">
                <div style="font-size: 11px; color: #64748b;">現金</div>
                <div style="font-size: 22px; font-weight: bold; color: #1e293b;">¥${company.cash}</div>
            </div>
            <div style="background: #f1f5f9; border-radius: 8px; padding: 10px; text-align: center;">
                <div style="font-size: 11px; color: #64748b;">材料在庫</div>
                <div style="font-size: 22px; font-weight: bold; color: #1e293b;">${company.materials}個</div>
            </div>
        </div>

        <div class="form-group">
            <label class="form-label">📦 購入数量</label>
            <select id="buyQuantity" class="form-control" style="font-size: 18px; text-align: center; font-weight: bold;">
                ${actualMax > 0 ? Array(actualMax).fill(0).map((_, i) =>
                    `<option value="${i+1}" ${i+1 === Math.min(actualMax, 3) ? 'selected' : ''}>${i+1}個（¥${(i+1) * market.buyPrice}）</option>`
                ).join('') : '<option value="0">購入不可</option>'}
            </select>
        </div>

        <input type="hidden" id="buyMarketSelect" value="${marketIndex}">

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px;">
            <button class="submit-btn" onclick="enterBuyMode()" style="background: linear-gradient(180deg, #6b7280 0%, #4b5563 100%);">
                ← 市場を変更
            </button>
            <button class="submit-btn" onclick="processBuyFromModal()" ${actualMax <= 0 ? 'disabled' : ''} style="background: linear-gradient(180deg, #22c55e 0%, #16a34a 100%);">
                📦 購入実行
            </button>
        </div>
    `;

    showModal(`📦 ${market.name}から材料購入`, content);
}

// モーダルから購入処理
function processBuyFromModal() {
    const marketIndex = parseInt(document.getElementById('buyMarketSelect').value);
    const quantity = parseInt(document.getElementById('buyQuantity').value);
    const market = gameState.markets[marketIndex];
    const company = gameState.companies[0];

    const cost = market.buyPrice * quantity;

    if (company.cash < cost) {
        showToast('現金が不足しています', 'danger', 3000);
        return;
    }

    if (market.currentStock < quantity) {
        showToast('市場在庫が不足しています', 'danger', 3000);
        return;
    }

    company.cash -= cost;
    company.materials += quantity;
    market.currentStock -= quantity;
    company.totalPurchaseCost += cost;

    closeModal();
    updateDisplay();
    showToast(`${market.name}から材料${quantity}個を¥${cost}で購入しました`, 'success', 3000);
    endTurn();
}

// 販売モードに入るように変更
function showSalesModal() {
    enterSalesMode();
}

// Process sale
function processSale() {
    const company = gameState.companies[0];
    const marketIndex = parseInt(document.getElementById('marketSelect').value);
    const quantity = parseInt(document.getElementById('quantity').value);
    const market = gameState.markets[marketIndex];
    
    if (company.products < quantity) {
        showToast('製品が不足しています！', 'danger', 3000);
        return;
    }
    
    if (market.needsBid) {
        // 入札処理
        const bidPrice = parseInt(document.getElementById('bidPrice').value);
        
        // プレイヤーの入札（販売能力を超えて入札できない）
        const salesCapacity = getSalesCapacity(company);
        if (quantity > salesCapacity) {
            alert(`販売能力（${salesCapacity}個）を超えて入札できません`);
            return;
        }
        
        // Store bid for later processing
        // 価格競争力を計算（親ボーナス+研究チップ）
        const competitiveness = getPriceCompetitiveness(company, 0);  // 0はプレイヤーのindex
        const effectiveBidPrice = bidPrice - competitiveness;
        
        // デバッグ情報
        console.log(`プレイヤー入札: 表示価格=${bidPrice}, 競争力=${competitiveness}, 有効価格=${effectiveBidPrice}`);
        
        gameState.pendingBid = {
            market: marketIndex,
            company: 0,
            price: effectiveBidPrice,  // 有効入札価格
            quantity: quantity,
            displayPrice: bidPrice  // 表示用価格
        };
        
        // Show modal for other players to bid
        showOtherPlayersBidModal(market, marketIndex);
        return;  // Exit here, will continue after all bids collected
    } else {
        // 入札不要（東京・海外）
        const actualQty = Math.min(quantity, market.maxStock - market.currentStock);
        if (actualQty > 0) {
            company.cash += market.sellPrice * actualQty;
            company.products -= actualQty;
            company.totalSales += market.sellPrice * actualQty;
            company.totalSoldQuantity = (company.totalSoldQuantity || 0) + actualQty;
            market.currentStock += actualQty;
            
            closeModal();
            updateDisplay();
            alert(`${market.name}に製品${actualQty}個を¥${market.sellPrice * actualQty}で販売しました`);
            endTurn();
        }
    }
}

// Complete sale
function completeSale() {
    closeModal();
    updateDisplay();
    if (gameState.lastSaleInfo) {
        alert(gameState.lastSaleInfo);
        gameState.lastSaleInfo = null;
    }

    // 別々販売の次の入札があれば処理
    if (gameState.pendingSeparateBids && gameState.pendingSeparateBids.currentIndex < gameState.pendingSeparateBids.bids.length) {
        processSeparateBidNext();
        return;
    }

    // 別々販売完了
    if (gameState.pendingSeparateBids) {
        gameState.pendingSeparateBids = null;
    }

    // プレイヤーが実際に販売した場合のみ1行使用（お金の流れがあった場合）
    const playerSold = gameState.playerSoldInBid;
    gameState.playerSoldInBid = null;  // フラグをリセット

    if (playerSold) {
        endTurn();
    } else {
        nextTurn();
    }
}

// Hire modal
function showHireModal() {
    const company = gameState.companies[0];

    const content = `
        <div style="background: linear-gradient(180deg, #fef3c7 0%, #fde68a 100%); border-radius: 12px; padding: 15px; margin-bottom: 15px; border: 2px solid #f59e0b;">
            <div style="text-align: center; margin-bottom: 10px;">
                <span style="font-size: 12px; color: #92400e;">採用上限（1ターン）</span>
                <span style="font-size: 24px; font-weight: bold; color: #78350f; display: block;">3名まで</span>
                <span style="font-size: 11px; color: #a16207;">採用費: ¥5/人</span>
            </div>
            <div style="display: flex; justify-content: space-around; text-align: center; margin-top: 10px;">
                <div style="background: #fff; border-radius: 8px; padding: 8px 15px; border: 2px solid #a08060;">
                    <div style="font-size: 10px; color: #5d4037;">現ワーカー</div>
                    <div style="font-size: 20px; font-weight: bold; color: #5d4037;">${company.workers}人</div>
                </div>
                <div style="background: #fff; border-radius: 8px; padding: 8px 15px; border: 2px solid #c44;">
                    <div style="font-size: 10px; color: #c44;">現セールス</div>
                    <div style="font-size: 20px; font-weight: bold; color: #c44;">${company.salesmen}人</div>
                </div>
            </div>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 15px;">
            <div style="background: linear-gradient(180deg, #f5deb3 0%, #deb887 100%); border-radius: 10px; padding: 15px; border: 2px solid #a08060; text-align: center;">
                <div style="font-size: 28px; margin-bottom: 5px;">👷</div>
                <div style="font-size: 14px; font-weight: bold; color: #5d4037; margin-bottom: 8px;">ワーカー</div>
                <select id="workerCount" class="form-control" style="font-size: 18px; text-align: center; font-weight: bold;">
                    <option value="0">0人</option>
                    <option value="1">1人</option>
                    <option value="2">2人</option>
                    <option value="3">3人</option>
                </select>
            </div>
            <div style="background: linear-gradient(180deg, #ff6b6b 0%, #ee5a5a 100%); border-radius: 10px; padding: 15px; border: 2px solid #c44; text-align: center;">
                <div style="font-size: 28px; margin-bottom: 5px;">💼</div>
                <div style="font-size: 14px; font-weight: bold; color: #fff; margin-bottom: 8px;">セールスマン</div>
                <select id="salesmanCount" class="form-control" style="font-size: 18px; text-align: center; font-weight: bold;">
                    <option value="0">0人</option>
                    <option value="1">1人</option>
                    <option value="2">2人</option>
                    <option value="3">3人</option>
                </select>
            </div>
        </div>

        <div style="background: #f1f5f9; border-radius: 10px; padding: 12px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <div>
                <span style="font-size: 12px; color: #64748b;">採用人数: </span>
                <span id="totalHires" style="font-size: 18px; font-weight: bold; color: #1e293b;">0人</span>
            </div>
            <div>
                <span style="font-size: 12px; color: #64748b;">採用費: </span>
                <span id="totalCost" style="font-size: 22px; font-weight: bold; color: #dc2626;">¥0</span>
            </div>
        </div>

        <button class="submit-btn" onclick="hire()" style="width: 100%;">
            👥 採用実行
        </button>
    `;

    showModal('👥 採用', content);

    // Update cost display
    const updateCost = () => {
        const workers = parseInt(document.getElementById('workerCount').value) || 0;
        const salesmen = parseInt(document.getElementById('salesmanCount').value) || 0;
        const total = workers + salesmen;

        if (total > 3) {
            alert('合計3名までです');
            document.getElementById('workerCount').value = 0;
            document.getElementById('salesmanCount').value = 0;
            return;
        }

        const cost = total * 5;
        document.getElementById('totalHires').textContent = `${total}人`;
        document.getElementById('totalCost').textContent = `¥${cost}`;
    };

    document.getElementById('workerCount').addEventListener('change', updateCost);
    document.getElementById('salesmanCount').addEventListener('change', updateCost);
    updateCost();
}

// Hire
function hire() {
    const company = gameState.companies[0];
    const workers = parseInt(document.getElementById('workerCount').value) || 0;
    const salesmen = parseInt(document.getElementById('salesmanCount').value) || 0;
    const total = workers + salesmen;
    
    if (total > 3) {
        alert('合計3名までです！');
        return;
    }
    
    const cost = total * 5;
    
    if (company.cash < cost) {
        // 短期借入
        const needed = Math.ceil((cost - company.cash) / 0.8 / 50) * 50;
        company.shortLoans += needed;
        company.cash += needed * 0.8;  // 短期借入: 借入時20%金利控除
        showToast(`現金不足のため短期借入¥${needed}を実行しました`, 'warning', 4000);
    }
    
    company.cash -= cost;
    company.extraLaborCost = (company.extraLaborCost || 0) + cost;  // 採用費は人件費
    company.workers += workers;
    company.salesmen += salesmen;

    // 退職者の補充（再雇用で退職者カウントを減らす）
    if (workers > 0 && company.retiredWorkers > 0) {
        const filled = Math.min(workers, company.retiredWorkers);
        company.retiredWorkers -= filled;
    }
    if (salesmen > 0 && company.retiredSalesmen > 0) {
        const filled = Math.min(salesmen, company.retiredSalesmen);
        company.retiredSalesmen -= filled;
    }

    // 期中最大人員の更新
    const currentTotal = company.workers + company.salesmen;
    if (currentTotal > (company.maxPersonnel || 0)) {
        company.maxPersonnel = currentTotal;
    }

    // 教育チップの効果
    if (company.chips.education > 0) {
        company.workers++;
        company.salesmen++;
        alert('教育チップの効果でワーカー+1、セールス+1！');
    }

    // 行動ログ記録
    logAction(0, '採用', `ワーカー${workers}人, セールス${salesmen}人`, -cost, true);

    closeModal();
    updateDisplay();
    alert(`ワーカー${workers}人、セールスマン${salesmen}人を採用しました（人件費¥${cost}）`);
    endTurn();
}

// Machine modal
function showMachineModal() {
    const company = gameState.companies[0];
    const smallMachines = company.machines.filter(m => m.type === 'small');
    const largeMachines = company.machines.filter(m => m.type === 'large');
    const attachableMachines = smallMachines.filter(m => m.attachments === 0);

    const content = `
        <div style="background: linear-gradient(180deg, #e5e7eb 0%, #d1d5db 100%); border-radius: 12px; padding: 15px; margin-bottom: 15px; border: 2px solid #6b7280;">
            <div style="text-align: center; margin-bottom: 10px;">
                <span style="font-size: 12px; color: #4b5563;">現在の設備</span>
            </div>
            <div style="display: flex; justify-content: space-around; text-align: center;">
                <div style="background: #fff; border-radius: 8px; padding: 8px 15px; border: 2px solid #888;">
                    <div style="font-size: 10px; color: #666;">小型機械</div>
                    <div style="font-size: 20px; font-weight: bold; color: #444;">${smallMachines.length}台</div>
                </div>
                <div style="background: #fff; border-radius: 8px; padding: 8px 15px; border: 2px solid #444;">
                    <div style="font-size: 10px; color: #444;">大型機械</div>
                    <div style="font-size: 20px; font-weight: bold; color: #222;">${largeMachines.length}台</div>
                </div>
                <div style="background: #fff; border-radius: 8px; padding: 8px 15px; border: 2px solid #f97316;">
                    <div style="font-size: 10px; color: #ea580c;">製造能力</div>
                    <div style="font-size: 20px; font-weight: bold; color: #c2410c;">${getManufacturingCapacity(company)}</div>
                </div>
            </div>
        </div>

        <div style="display: grid; grid-template-columns: 1fr; gap: 10px; margin-bottom: 15px;">
            <div onclick="selectMachineType('small')" id="machine-small" style="background: linear-gradient(180deg, #888 0%, #666 100%); border-radius: 10px; padding: 15px; border: 3px solid #444; cursor: pointer; display: flex; align-items: center; gap: 15px; transition: all 0.2s;">
                <div style="font-size: 32px;">⚙️</div>
                <div style="flex: 1;">
                    <div style="font-size: 14px; font-weight: bold; color: #fff;">小型機械</div>
                    <div style="font-size: 11px; color: #ddd;">製造能力 +1</div>
                </div>
                <div style="text-align: right;">
                    <div style="font-size: 18px; font-weight: bold; color: #fef08a;">¥100</div>
                </div>
            </div>
            <div onclick="selectMachineType('attachment')" id="machine-attachment" style="background: linear-gradient(180deg, #f97316 0%, #ea580c 100%); border-radius: 10px; padding: 15px; border: 3px solid #c2410c; cursor: ${attachableMachines.length > 0 ? 'pointer' : 'not-allowed'}; display: flex; align-items: center; gap: 15px; transition: all 0.2s; opacity: ${attachableMachines.length > 0 ? '1' : '0.5'};">
                <div style="font-size: 32px;">🔧</div>
                <div style="flex: 1;">
                    <div style="font-size: 14px; font-weight: bold; color: #fff;">アタッチメント</div>
                    <div style="font-size: 11px; color: #fed7aa;">小型機械を能力2に ${attachableMachines.length === 0 ? '（対象なし）' : `（対象: ${attachableMachines.length}台）`}</div>
                </div>
                <div style="text-align: right;">
                    <div style="font-size: 18px; font-weight: bold; color: #fff;">¥30</div>
                </div>
            </div>
            <div onclick="selectMachineType('large')" id="machine-large" style="background: linear-gradient(180deg, #555 0%, #333 100%); border-radius: 10px; padding: 15px; border: 3px solid #111; cursor: pointer; display: flex; align-items: center; gap: 15px; transition: all 0.2s;">
                <div style="font-size: 32px;">🏭</div>
                <div style="flex: 1;">
                    <div style="font-size: 14px; font-weight: bold; color: #fff;">大型機械</div>
                    <div style="font-size: 11px; color: #ddd;">製造能力 +4</div>
                </div>
                <div style="text-align: right;">
                    <div style="font-size: 18px; font-weight: bold; color: #fef08a;">¥200</div>
                </div>
            </div>
        </div>

        <input type="hidden" id="machineType" value="small">

        <button class="submit-btn" onclick="buyMachine()" style="width: 100%;">
            ⚙️ 購入実行
        </button>
    `;

    showModal('⚙️ 設備投資', content);

    // 初期選択を視覚的に反映
    setTimeout(() => selectMachineType('small'), 0);
}

// 機械タイプを選択
function selectMachineType(type) {
    const company = gameState.companies[0];
    const attachableMachines = company.machines.filter(m => m.type === 'small' && m.attachments === 0);

    if (type === 'attachment' && attachableMachines.length === 0) {
        return; // アタッチメント対象がない場合は選択不可
    }

    document.getElementById('machineType').value = type;

    // 視覚的な選択状態を更新
    ['small', 'attachment', 'large'].forEach(t => {
        const el = document.getElementById(`machine-${t}`);
        if (el) {
            el.style.transform = t === type ? 'scale(1.02)' : 'scale(1)';
            el.style.boxShadow = t === type ? '0 0 20px rgba(251,191,36,0.5)' : 'none';
        }
    });
}

// Buy machine
function buyMachine() {
    const company = gameState.companies[0];
    const type = document.getElementById('machineType').value;
    
    let cost = 0;
    if (type === 'small') cost = 100;
    else if (type === 'large') cost = 200;
    else if (type === 'attachment') cost = 30;
    
    if (company.cash < cost) {
        // 短期借入
        const needed = Math.ceil((cost - company.cash) / 0.8 / 50) * 50;
        company.shortLoans += needed;
        company.cash += needed * 0.8;  // 短期借入: 借入時20%金利控除
        showToast(`現金不足のため短期借入¥${needed}を実行しました`, 'warning', 4000);
    }
    
    if (type === 'attachment') {
        // Find small machine without attachment
        const smallMachine = company.machines.find(m => m.type === 'small' && m.attachments === 0);
        if (!smallMachine) {
            alert('アタッチメントを付けられる小型機械がありません！');
            return;
        }
        smallMachine.attachments = 1;
        company.cash -= cost;
        alert('小型機械にアタッチメントを追加しました');
    } else {
        company.cash -= cost;
        company.machines.push({type: type, attachments: 0});
        showToast(`${type === 'small' ? '小型' : '大型'}機械を購入しました（¥${cost}）`, 'success', 3000);
    }
    
    closeModal();
    updateDisplay();
    endTurn();
}

// Warehouse modal (無災害倉庫)
function showWarehouseModal() {
    const company = gameState.companies[0];
    const currentWarehouses = company.warehouses || 0;

    if (currentWarehouses >= 2) {
        alert('倉庫は最大2個までです。既に2個所有しています。');
        return;
    }

    // 購入可能なオプションを生成
    let locationOptions = '';
    let purchaseOptions = '';

    if (currentWarehouses === 0) {
        // 0個→1個: 材料か製品を選択
        locationOptions = `
            <option value="materials">材料置場に設置（+12個）</option>
            <option value="products">製品置場に設置（+12個）</option>
        `;
        purchaseOptions = `
            <option value="1">1個購入（¥20）</option>
            <option value="2">2個購入（¥40）- 材料+製品両方</option>
        `;
    } else {
        // 1個→2個: 反対側に追加
        const otherLocation = company.warehouseLocation === 'materials' ? 'products' : 'materials';
        const otherName = otherLocation === 'materials' ? '材料置場' : '製品置場';
        locationOptions = `<option value="${otherLocation}">${otherName}に設置（+12個）</option>`;
        purchaseOptions = `<option value="1">1個購入（¥20）</option>`;
    }

    const content = `
        <div style="padding: 10px;">
            <div style="background: #fef3c7; border-radius: 8px; padding: 10px; margin-bottom: 15px;">
                <div style="font-weight: bold; color: #92400e;">現金: ¥${company.cash}</div>
                <div style="font-size: 12px; color: #78350f;">
                    現在の倉庫: ${currentWarehouses}個
                    ${currentWarehouses === 1 ? `（${company.warehouseLocation === 'materials' ? '材料置場' : '製品置場'}）` : ''}
                </div>
            </div>
            <div class="form-group">
                <label class="form-label">無災害倉庫（¥20/個、容量+12個）</label>
                <p style="font-size: 12px; color: #666;">効果：火災・盗難完全回避</p>
                <p style="font-size: 12px; color: #0369a1;">※ 1個の場合は後から移動可能</p>
            </div>
            <div class="form-group">
                <label class="form-label">購入数:</label>
                <select id="warehouseCount" class="form-control" onchange="updateWarehouseLocationOptions()">
                    ${purchaseOptions}
                </select>
            </div>
            <div class="form-group" id="warehouseLocationGroup">
                <label class="form-label">設置場所:</label>
                <select id="warehouseLocation" class="form-control">
                    ${locationOptions}
                </select>
            </div>
            <button class="submit-btn" onclick="buyWarehouse()">購入（1行使用）</button>
        </div>
    `;

    showModal('無災害倉庫購入', content);
}

// 倉庫購入数に応じて設置場所オプションを更新
function updateWarehouseLocationOptions() {
    const count = document.getElementById('warehouseCount').value;
    const locationGroup = document.getElementById('warehouseLocationGroup');

    if (count === '2') {
        locationGroup.style.display = 'none';  // 2個の場合は両方に設置なので選択不要
    } else {
        locationGroup.style.display = 'block';
    }
}

// Buy warehouse
function buyWarehouse() {
    const company = gameState.companies[0];
    const count = parseInt(document.getElementById('warehouseCount')?.value || '1');
    const location = document.getElementById('warehouseLocation')?.value || 'materials';

    const cost = count * 20;

    if (company.warehouses + count > 2) {
        alert('倉庫は最大2個までです！');
        return;
    }

    if (company.cash < cost) {
        showToast('現金が不足しています！', 'danger', 3000);
        return;
    }

    company.cash -= cost;

    if (count === 2) {
        // 2個購入: 両方に設置
        company.warehouses = 2;
        company.warehouseLocation = 'both';  // 両方に設置を示す
    } else {
        // 1個購入
        company.warehouses += 1;
        if (company.warehouses === 1) {
            company.warehouseLocation = location;
        } else {
            // 2個目は反対側に設置（自動）
            company.warehouseLocation = 'both';
        }
    }

    company.extraLaborCost = (company.extraLaborCost || 0) + cost;

    closeModal();
    let locationText;
    if (count === 2 || company.warehouses === 2) {
        locationText = '材料置場と製品置場';
    } else {
        locationText = location === 'materials' ? '材料置場' : '製品置場';
    }
    alert(`無災害倉庫を${locationText}に設置しました（¥${cost}）`);

    // カードを引く
    drawCard();
}

// 倉庫移動モーダル（1個のみ保有時に使用可能）
function showWarehouseMoveModal() {
    const company = gameState.companies[0];

    if (company.warehouses !== 1) {
        alert('倉庫の移動は1個保有時のみ可能です。');
        return;
    }

    const currentLocation = company.warehouseLocation === 'materials' ? '材料置場' : '製品置場';
    const newLocation = company.warehouseLocation === 'materials' ? 'products' : 'materials';
    const newLocationName = newLocation === 'materials' ? '材料置場' : '製品置場';

    // 移動先の容量チェック
    let canMove = true;
    let warningMessage = '';

    if (newLocation === 'materials') {
        // 製品置場→材料置場に移動する場合、製品が10個を超えているか確認
        if (company.products > 10) {
            canMove = false;
            warningMessage = `製品が${company.products}個あります。\n倉庫を移動すると製品置場の容量（10個）を超えてしまいます。`;
        }
    } else {
        // 材料置場→製品置場に移動する場合、材料が10個を超えているか確認
        if (company.materials > 10) {
            canMove = false;
            warningMessage = `材料が${company.materials}個あります。\n倉庫を移動すると材料置場の容量（10個）を超えてしまいます。`;
        }
    }

    const content = `
        <div style="padding: 10px;">
            <div style="background: #fef3c7; border-radius: 8px; padding: 10px; margin-bottom: 15px;">
                <div style="font-weight: bold; color: #92400e;">現在の倉庫位置</div>
                <div style="font-size: 18px; color: #78350f; margin-top: 5px;">${currentLocation}</div>
            </div>
            <div style="margin-bottom: 15px;">
                <p style="font-size: 14px; color: #444;">倉庫を${newLocationName}に移動しますか？</p>
                <p style="font-size: 12px; color: #0369a1;">※ 移動は何回でも可能で、行を消費しません</p>
                ${!canMove ? `<p style="font-size: 12px; color: #dc2626; margin-top: 10px;">${warningMessage}</p>` : ''}
            </div>
            ${canMove ? `
                <button class="submit-btn" onclick="moveWarehouse('${newLocation}')" style="width: 100%;">
                    ${newLocationName}に移動
                </button>
            ` : `
                <button class="submit-btn" disabled style="width: 100%; background: #ccc; cursor: not-allowed;">
                    移動不可
                </button>
            `}
            <button class="action-btn secondary" onclick="closeModal()" style="width: 100%; margin-top: 10px;">キャンセル</button>
        </div>
    `;

    showModal('倉庫の移動', content);
}

// 倉庫を移動する
function moveWarehouse(newLocation) {
    const company = gameState.companies[0];

    if (company.warehouses !== 1) {
        alert('倉庫の移動は1個保有時のみ可能です。');
        return;
    }

    const newLocationName = newLocation === 'materials' ? '材料置場' : '製品置場';
    company.warehouseLocation = newLocation;

    closeModal();
    alert(`倉庫を${newLocationName}に移動しました。`);
    updateDisplay();
    // 行を消費しないので、ターン選択に戻る
    showTurnStartOptions();
}

// Reassign modal (配置転換)
function showReassignModal() {
    const content = `
        <div class="form-group">
            <label class="form-label">配置転換（¥5/人）:</label>
            <select id="reassignType" class="form-control">
                <option value="workerToSales">ワーカー→セールスマン</option>
                <option value="salesToWorker">セールスマン→ワーカー</option>
            </select>
        </div>
        <div class="form-group">
            <label class="form-label">人数:</label>
            <select id="reassignCount" class="form-control">
                <option value="1">1人</option>
                <option value="2">2人</option>
                <option value="3">3人</option>
            </select>
        </div>
        <button class="submit-btn" onclick="reassign()">配置転換</button>
    `;
    
    showModal('配置転換', content);
}

// Reassign
function reassign() {
    const company = gameState.companies[0];
    const type = document.getElementById('reassignType').value;
    const count = parseInt(document.getElementById('reassignCount').value);
    const cost = count * 5;

    if (company.cash < cost) {
        showToast('現金が不足しています！', 'danger', 3000);
        return;
    }

    if (type === 'workerToSales') {
        if (company.workers < count) {
            alert('ワーカーが不足しています！');
            return;
        }
        company.workers -= count;
        company.salesmen += count;
    } else {
        if (company.salesmen < count) {
            alert('セールスマンが不足しています！');
            return;
        }
        company.salesmen -= count;
        company.workers += count;
    }

    company.cash -= cost;

    // 配置転換費用をFに計上
    company.extraLaborCost = (company.extraLaborCost || 0) + cost;

    closeModal();

    // 1行使用してターン終了
    endTurn();
}

// Sell machine modal
function showSellMachineModal() {
    const company = gameState.companies[0];
    
    if (company.machines.length === 0) {
        alert('売却する機械がありません！');
        return;
    }
    
    const content = `
        <div class="form-group">
            <label class="form-label">売却する機械（簿価の70%）:</label>
            <select id="machineIndex" class="form-control">
                ${company.machines.map((m, i) => {
                    const name = m.type === 'small' ? 
                        (m.attachments > 0 ? '小型+アタッチメント' : '小型機械') : '大型機械';
                    const bookValue = m.type === 'small' ? 
                        (m.attachments > 0 ? 130 : 100) : 200;
                    const salePrice = Math.floor(bookValue * 0.7);
                    return `<option value="${i}">${name} (売却額: ¥${salePrice})</option>`;
                }).join('')}
            </select>
        </div>
        <button class="submit-btn" onclick="sellMachine()">売却</button>
    `;
    
    showModal('機械売却', content);
}

// Sell machine
function sellMachine() {
    const company = gameState.companies[0];
    const machineIndex = parseInt(document.getElementById('machineIndex').value);
    const machine = company.machines[machineIndex];
    
    const bookValue = machine.type === 'small' ? 
        (machine.attachments > 0 ? 130 : 100) : 200;
    const salePrice = Math.floor(bookValue * 0.7);
    const loss = bookValue - salePrice;
    
    company.cash += salePrice;
    company.machines.splice(machineIndex, 1);
    
    // 特別損失として期末に反映
    company.specialLoss = (company.specialLoss || 0) + loss;
    
    closeModal();
    alert(`機械を¥${salePrice}で売却しました（特別損失¥${loss}）`);
    
    // カードを引く
    drawCard();
}

// Chip purchase modal for decision cards (カードタップ形式)
function showChipPurchaseModal() {
    const company = gameState.companies[0];
    const maxEducation = gameState.currentPeriod === 2 ? 2 : 1;

    const content = `
        <div style="background: #fef3c7; border-radius: 8px; padding: 10px; margin-bottom: 15px; text-align: center;">
            <div style="font-weight: bold; color: #92400e;">💰 持ち金: ¥${company.cash}</div>
        </div>
        <p style="text-align: center; margin-bottom: 15px; color: #666;">購入するチップをタップしてください（1枚¥20）</p>
        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px;">
            <!-- 研究チップ（青） -->
            <div onclick="buyChipDirect('research')" style="
                background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
                border: 3px solid #1e40af;
                border-radius: 12px;
                padding: 15px 10px;
                text-align: center;
                cursor: pointer;
                color: white;
                transition: transform 0.2s, box-shadow 0.2s;
                box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
            " onmouseover="this.style.transform='scale(1.05)'; this.style.boxShadow='0 6px 20px rgba(59, 130, 246, 0.6)'"
               onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='0 4px 12px rgba(59, 130, 246, 0.4)'">
                <div style="font-size: 28px; margin-bottom: 8px;">🔬</div>
                <div style="font-weight: bold; font-size: 14px;">研究開発</div>
                <div style="font-size: 11px; margin-top: 5px;">価格競争力+2</div>
                <div style="font-size: 10px; margin-top: 3px; opacity: 0.8;">所持: ${company.chips.research || 0}枚</div>
            </div>

            <!-- 教育チップ（黄） -->
            <div onclick="buyChipDirect('education')" style="
                background: linear-gradient(135deg, #eab308 0%, #ca8a04 100%);
                border: 3px solid #a16207;
                border-radius: 12px;
                padding: 15px 10px;
                text-align: center;
                cursor: pointer;
                color: #1e293b;
                transition: transform 0.2s, box-shadow 0.2s;
                box-shadow: 0 4px 12px rgba(234, 179, 8, 0.4);
            " onmouseover="this.style.transform='scale(1.05)'; this.style.boxShadow='0 6px 20px rgba(234, 179, 8, 0.6)'"
               onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='0 4px 12px rgba(234, 179, 8, 0.4)'">
                <div style="font-size: 28px; margin-bottom: 8px;">📚</div>
                <div style="font-weight: bold; font-size: 14px;">教育</div>
                <div style="font-size: 11px; margin-top: 5px;">製造・販売+1</div>
                <div style="font-size: 10px; margin-top: 3px; opacity: 0.8;">所持: ${company.chips.education || 0}/${maxEducation}枚</div>
            </div>

            <!-- 広告チップ（赤） -->
            <div onclick="buyChipDirect('advertising')" style="
                background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
                border: 3px solid #b91c1c;
                border-radius: 12px;
                padding: 15px 10px;
                text-align: center;
                cursor: pointer;
                color: white;
                transition: transform 0.2s, box-shadow 0.2s;
                box-shadow: 0 4px 12px rgba(239, 68, 68, 0.4);
            " onmouseover="this.style.transform='scale(1.05)'; this.style.boxShadow='0 6px 20px rgba(239, 68, 68, 0.6)'"
               onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='0 4px 12px rgba(239, 68, 68, 0.4)'">
                <div style="font-size: 28px; margin-bottom: 8px;">📢</div>
                <div style="font-weight: bold; font-size: 14px;">広告</div>
                <div style="font-size: 11px; margin-top: 5px;">販売能力向上</div>
                <div style="font-size: 10px; margin-top: 3px; opacity: 0.8;">所持: ${company.chips.advertising || 0}枚</div>
            </div>
        </div>
        <div style="text-align: center; margin-top: 15px;">
            <button class="action-btn secondary" onclick="closeModal(true)" style="padding: 10px 30px;">キャンセル</button>
        </div>
    `;

    showModal('戦略チップ購入', content);
}

// 直接チップ購入（カードタップ用）
function buyChipDirect(chipType) {
    const company = gameState.companies[0];
    const cost = 20;

    if (company.cash < cost) {
        alert('現金が不足しています（必要: ¥20）');
        return;
    }

    // 上限チェック
    const maxLimits = {
        research: 5,
        education: gameState.currentPeriod === 2 ? 2 : 1,
        advertising: 5
    };
    const currentCount = company.chips[chipType] || 0;

    if (currentCount >= maxLimits[chipType]) {
        const names = { research: '研究開発', education: '教育', advertising: '広告' };
        alert(`${names[chipType]}チップは最大${maxLimits[chipType]}枚までです`);
        return;
    }

    company.cash -= cost;
    company.chips[chipType] = currentCount + 1;

    const names = { research: '研究開発', education: '教育', advertising: '広告' };
    closeModal();
    showToast(`${names[chipType]}チップを購入しました（¥20）`, 'success', 3000);

    endTurn();
}

// Buy chips from decision card
function buyChipsFromDecision() {
    const company = gameState.companies[0];
    const chipType = document.getElementById('chipType').value;
    const quantity = parseInt(document.getElementById('quantity').value);
    
    const cost = quantity * 20;
    
    if (company.cash < cost) {
        showToast('現金が不足しています', 'danger', 3000);
        return;
    }
    
    // Check limits (2期は教育チップ2枚まで)
    const maxLimits = {
        research: 5, 
        education: gameState.currentPeriod === 2 ? 2 : 1,  // 2期は2枚まで
        advertising: 5
    };
    const currentCount = company.chips[chipType] || 0;
    const newTotal = currentCount + quantity;
    
    if (newTotal > maxLimits[chipType]) {
        alert(`${chipType}チップは最大${maxLimits[chipType]}枚までです`);
        return;
    }
    
    company.cash -= cost;
    company.chips[chipType] = newTotal;
    
    closeModal();
    showToast(`${chipType}チップを${quantity}個購入しました（¥${cost}）`, 'success', 3000);
    
    endTurn();
}

// Show manufacturing capacity detail
function showManufacturingCapacityDetail(companyIndex) {
    const company = gameState.companies[companyIndex];
    let baseMachineCapacity = 0;
    let machineDetail = [];
    
    company.machines.forEach(machine => {
        if (machine.type === 'small') {
            const capacity = machine.attachments > 0 ? 2 : 1;
            baseMachineCapacity += capacity;
            machineDetail.push(`小型機械${machine.attachments > 0 ? '+アタッチメント' : ''}: ${capacity}`);
        } else if (machine.type === 'large') {
            baseMachineCapacity += 4;
            machineDetail.push(`大型機械: 4`);
        }
    });
    
    const computerBonus = company.chips.computer || 0;
    const machineCapacity = baseMachineCapacity + computerBonus;
    const workerCapacity = company.workers + (company.chips.education || 0);
    const finalCapacity = Math.min(machineCapacity, workerCapacity);
    
    const content = `
        <div class="breakdown-list">
            <h3>製造能力の詳細</h3>
            ${machineDetail.map(d => `<div class="breakdown-item"><span>${d}</span></div>`).join('')}
            ${computerBonus > 0 ? `<div class="breakdown-item"><span>コンピュータチップ: +${computerBonus}</span></div>` : ''}
            <div class="breakdown-item"><span>機械能力計: ${machineCapacity}</span></div>
            <hr>
            <div class="breakdown-item"><span>ワーカー: ${company.workers}</span></div>
            ${company.chips.education > 0 ? `<div class="breakdown-item"><span>教育チップ: +${company.chips.education}</span></div>` : ''}
            <div class="breakdown-item"><span>ワーカー能力計: ${workerCapacity}</span></div>
            <hr>
            <div class="breakdown-item breakdown-total"><span>製造能力</span><span>MIN(${machineCapacity}, ${workerCapacity}) = ${finalCapacity}</span></div>
        </div>
    `;
    
    showModal(`${company.name}の製造能力`, content);
}

// Show other players bid modal
function showOtherPlayersBidModal(market, marketIndex) {
    const content = `
        <div class="bid-display">
            <div class="bid-title">他社の入札参加</div>
            <p>市場: ${market.name} (最大価格: ¥${market.sellPrice})</p>
            <p>あなたの入札: ¥${gameState.pendingBid.displayPrice || gameState.pendingBid.price} × ${gameState.pendingBid.quantity}個</p>
            <p style="color: #666; font-size: 12px;">他社も入札に参加します（金額は非公開）</p>
            <button class="submit-btn" onclick="processBidsWithAllCompanies(${marketIndex})">入札結果を確認</button>
            <button class="cancel-btn" onclick="cancelPlayerBid()" style="margin-top: 10px;">入札に参加しない</button>
        </div>
    `;
    
    showModal('入札参加確認', content);
}

// Cancel player bid
function cancelPlayerBid() {
    // プレイヤーの入札をキャンセル（お金の流れがないので行を消費しない）
    gameState.pendingBid = null;
    closeModal();
    showToast('入札への参加を取りやめました', 'info', 3000);
    nextTurn();
}

// Process bids with all companies
function processBidsWithAllCompanies(marketIndex) {
    const market = gameState.markets[marketIndex];
    const allBids = [gameState.pendingBid];
    
    // AI companies also bid
    for (let i = 1; i < gameState.companies.length; i++) {
        const aiCompany = gameState.companies[i];
        if (aiCompany.products > 0) {
            const aiSalesCapacity = getSalesCapacity(aiCompany);
            const aiQuantity = Math.min(aiSalesCapacity, aiCompany.products);
            if (aiQuantity > 0) {
                // AIが親の場合、2円の価格競争力を追加
                const isAIParent = (gameState.currentPlayerIndex === i);
                const aiDisplayPrice = Math.floor(market.sellPrice * (0.7 + Math.random() * 0.25));
                const aiPrice = aiDisplayPrice - getPriceCompetitiveness(aiCompany, isAIParent);
                allBids.push({
                    company: i, 
                    price: aiPrice, 
                    quantity: aiQuantity,
                    displayPrice: aiDisplayPrice
                });
            }
        }
    }
    
    // Sort by: 1) price (lowest), 2) research chips (most), 3) parent (priority)
    allBids.sort((a, b) => {
        // First compare actual bid price
        if (a.price !== b.price) return a.price - b.price;
        
        // Same price: compare research chips (more chips wins)
        const aResearch = gameState.companies[a.company].chips.research || 0;
        const bResearch = gameState.companies[b.company].chips.research || 0;
        if (aResearch !== bResearch) return bResearch - aResearch;
        
        // Same research chips: parent wins
        const aIsParent = (gameState.currentPlayerIndex === a.company);
        const bIsParent = (gameState.currentPlayerIndex === b.company);
        if (aIsParent && !bIsParent) return -1;
        if (!aIsParent && bIsParent) return 1;
        
        return 0;
    });
    
    // 入札結果を処理（販売上限は親の出した個数）
    // 親の入札数量を販売上限とする（市場枠とも比較）
    const parentBid = allBids.find(b => b.company === gameState.currentPlayerIndex);
    const parentQuantity = parentBid ? parentBid.quantity : (gameState.pendingBid ? gameState.pendingBid.quantity : 3);
    let remainingCapacity = Math.min(parentQuantity, market.maxStock - market.currentStock);
    let salesResults = [];

    // 入札順（価格が低い順）に市場枠を割り当て
    for (const bid of allBids) {
        if (remainingCapacity <= 0) break;

        const bidCompany = gameState.companies[bid.company];
        const actualQty = Math.min(bid.quantity, remainingCapacity, bidCompany.products);

        if (actualQty > 0) {
            const salePrice = bid.displayPrice || bid.price;
            const revenue = salePrice * actualQty;
            bidCompany.cash += revenue;
            bidCompany.products -= actualQty;
            bidCompany.totalSales += revenue;
            bidCompany.totalSoldQuantity = (bidCompany.totalSoldQuantity || 0) + actualQty;
            market.currentStock += actualQty;
            remainingCapacity -= actualQty;

            // 行動ログ記録
            logAction(bid.company, '商品販売', `${market.name}に¥${salePrice}×${actualQty}個`, revenue, true);

            salesResults.push({
                company: bidCompany,
                quantity: actualQty,
                price: salePrice,
                bid: bid
            });
        }
    }

    // 入札結果の表示
    let bidResultHtml = '<div class="bid-display">';
    bidResultHtml += '<div class="bid-title">入札結果</div>';

    // 販売成功者を表示
    salesResults.forEach((result, index) => {
        const researchChips = result.company.chips.research || 0;
        const isParent = (gameState.currentPlayerIndex === result.bid.company);
        const bgColor = index === 0 ? '#d4edda' : '#fef3c7';
        const callPrice = result.bid.price;  // コール価格（勝敗判定用）
        const recordPrice = result.bid.displayPrice || result.bid.price;  // 記帳価格（売上計上用）

        bidResultHtml += `<div style="background: ${bgColor}; padding: 10px; margin: 10px 0; border-radius: 5px;">`;
        bidResultHtml += `<strong>${index === 0 ? '🏆 1位落札' : '✓ 残枠販売'}: ${result.company.name}</strong><br>`;
        bidResultHtml += `<div style="display: flex; gap: 15px; margin: 5px 0;">`;
        bidResultHtml += `<span style="font-size: 12px; color: #666;">コール価格: ¥${callPrice}</span>`;
        bidResultHtml += `<span style="font-size: 12px; color: #2563eb;">記帳価格: ¥${recordPrice}</span>`;
        bidResultHtml += `</div>`;
        bidResultHtml += `数量: ${result.quantity}個<br>`;
        if (researchChips > 0 || isParent) {
            bidResultHtml += '<div style="font-size: 12px; margin-top: 5px; color: #666;">【価格競争力】';
            if (researchChips > 0) {
                bidResultHtml += ` 研究${researchChips}枚(-${researchChips * 2}円)`;
            }
            if (isParent) {
                bidResultHtml += ` 親(-2円)`;
            }
            bidResultHtml += '</div>';
        }
        bidResultHtml += `<strong>売上金額: ¥${recordPrice * result.quantity}</strong>`;
        bidResultHtml += '</div>';
    });

    // 入札したが売れなかった者
    const unsoldBids = allBids.filter(bid =>
        !salesResults.some(result => result.bid === bid)
    );

    if (unsoldBids.length > 0) {
        bidResultHtml += '<div class="bid-entries">';
        bidResultHtml += '<div style="font-size: 12px; color: #666; margin-bottom: 5px;">入札したが売れなかった:</div>';
        unsoldBids.forEach((bid) => {
            const bidCompany = gameState.companies[bid.company];
            const callPrice = bid.price;  // コール価格
            const recordPrice = bid.displayPrice || bid.price;  // 記帳価格

            bidResultHtml += `
                <div class="bid-entry" style="color: #9ca3af; padding: 5px;">
                    <span>${bidCompany.name}</span>
                    <span style="font-size: 11px;">コール¥${callPrice} / 記帳¥${recordPrice} × ${bid.quantity}個（市場枠なし）</span>
                </div>
            `;
        });
        bidResultHtml += '</div>';
    }

    bidResultHtml += '</div>';

    closeModal();
    showModal('入札結果', bidResultHtml + '<button class="submit-btn" onclick="completeSale()">OK</button>');

    // プレイヤーへのメッセージとフラグ設定
    const playerResult = salesResults.find(r => r.bid.company === 0);
    if (playerResult) {
        gameState.lastSaleInfo = `【入札結果】\nあなたは${market.name}に${playerResult.quantity}個を¥${playerResult.price * playerResult.quantity}で販売しました`;
        gameState.playerSoldInBid = true;  // お金の流れがあった
    } else {
        gameState.lastSaleInfo = `【入札結果】\n${market.name}への入札は他社に負けました`;
        gameState.playerSoldInBid = false;  // お金の流れがなかった
    }

    // Clear pending bid
    gameState.pendingBid = null;
}

// 2市場同時販売の他社入札モーダル
function showOtherPlayersBidModalTwoMarket() {
    const market1 = gameState.markets[gameState.selectedMarkets[0]];
    const market2 = gameState.markets[gameState.selectedMarkets[1]];
    const maxPrice = Math.min(market1.sellPrice, market2.sellPrice);

    const content = `
        <div class="bid-display">
            <div class="bid-title">2市場同時入札 - 他社参加</div>
            <p>市場: ${market1.name} + ${market2.name}</p>
            <p>適用上限価格: ¥${maxPrice}</p>
            <p>あなたの入札: ¥${gameState.pendingBid.displayPrice} × ${gameState.pendingBid.quantity}個</p>
            <p style="color: #666; font-size: 12px;">他社も入札に参加します（金額は非公開）</p>
            <button class="submit-btn" onclick="processBidsWithAllCompaniesTwoMarket()">入札結果を確認</button>
            <button class="cancel-btn" onclick="cancelPlayerBidTwoMarket()" style="margin-top: 10px;">入札に参加しない</button>
        </div>
    `;

    showModal('2市場同時入札', content);
}

// 2市場同時入札のキャンセル
function cancelPlayerBidTwoMarket() {
    // お金の流れがないので行を消費しない
    gameState.pendingBid = null;
    gameState.selectedMarkets = [];
    gameState.twoMarketMode = false;
    closeModal();
    showToast('入札への参加を取りやめました', 'info', 3000);
    nextTurn();
}

// 2市場同時入札の処理
function processBidsWithAllCompaniesTwoMarket() {
    const market1 = gameState.markets[gameState.selectedMarkets[0]];
    const market2 = gameState.markets[gameState.selectedMarkets[1]];
    const maxPrice = Math.min(market1.sellPrice, market2.sellPrice);

    const allBids = [gameState.pendingBid];

    // AI companies also bid (2市場同時)
    for (let i = 1; i < gameState.companies.length; i++) {
        const aiCompany = gameState.companies[i];
        if (aiCompany.products >= 2) {  // 2市場同時は2個以上必要
            const aiSalesCapacity = getSalesCapacity(aiCompany);
            const aiQuantity = Math.min(aiSalesCapacity, aiCompany.products);
            if (aiQuantity >= 2) {
                const isAIParent = (gameState.currentPlayerIndex === i);
                const aiDisplayPrice = Math.floor(maxPrice * (0.7 + Math.random() * 0.25));
                const aiPrice = aiDisplayPrice - getPriceCompetitiveness(aiCompany, isAIParent);
                allBids.push({
                    company: i,
                    price: aiPrice,
                    quantity: aiQuantity,
                    displayPrice: aiDisplayPrice,
                    isTwoMarket: true
                });
            }
        }
    }

    // Sort by: 1) price (lowest), 2) research chips (most), 3) parent (priority)
    allBids.sort((a, b) => {
        if (a.price !== b.price) return a.price - b.price;
        const aResearch = gameState.companies[a.company].chips.research || 0;
        const bResearch = gameState.companies[b.company].chips.research || 0;
        if (aResearch !== bResearch) return bResearch - aResearch;
        const aIsParent = (gameState.currentPlayerIndex === a.company);
        const bIsParent = (gameState.currentPlayerIndex === b.company);
        if (aIsParent && !bIsParent) return -1;
        if (!aIsParent && bIsParent) return 1;
        return 0;
    });

    // 2市場の合計容量
    const volume1 = market1.maxStock - market1.currentStock;
    const volume2 = market2.maxStock - market2.currentStock;
    const parentBid = allBids.find(b => b.company === gameState.currentPlayerIndex);
    const parentQuantity = parentBid ? parentBid.quantity : gameState.pendingBid.quantity;
    let remainingCapacity = Math.min(parentQuantity, volume1 + volume2);
    let salesResults = [];

    // 入札順に割り当て
    for (const bid of allBids) {
        if (remainingCapacity <= 0) break;

        const bidCompany = gameState.companies[bid.company];
        const actualQty = Math.min(bid.quantity, remainingCapacity, bidCompany.products);

        if (actualQty > 0) {
            const salePrice = bid.displayPrice || bid.price;
            const revenue = salePrice * actualQty;
            bidCompany.cash += revenue;
            bidCompany.products -= actualQty;
            bidCompany.totalSales += revenue;
            bidCompany.totalSoldQuantity = (bidCompany.totalSoldQuantity || 0) + actualQty;

            // 2市場に分配
            let remainingQty = actualQty;
            if (market1.currentStock < market1.maxStock && remainingQty > 0) {
                const toMarket1 = Math.min(remainingQty, market1.maxStock - market1.currentStock);
                market1.currentStock += toMarket1;
                remainingQty -= toMarket1;
            }
            if (market2.currentStock < market2.maxStock && remainingQty > 0) {
                const toMarket2 = Math.min(remainingQty, market2.maxStock - market2.currentStock);
                market2.currentStock += toMarket2;
            }

            remainingCapacity -= actualQty;

            // 行動ログ記録
            logAction(bid.company, '商品販売', `${market1.name}+${market2.name}に¥${salePrice}×${actualQty}個`, revenue, true);

            salesResults.push({
                company: bidCompany,
                quantity: actualQty,
                price: salePrice,
                bid: bid
            });
        }
    }

    // 入札結果の表示
    let bidResultHtml = '<div class="bid-display">';
    bidResultHtml += '<div class="bid-title">2市場同時入札 結果</div>';
    bidResultHtml += `<p style="margin-bottom: 10px;">${market1.name} + ${market2.name}</p>`;

    salesResults.forEach((result, index) => {
        const researchChips = result.company.chips.research || 0;
        const isParent = (gameState.currentPlayerIndex === result.bid.company);
        const bgColor = index === 0 ? '#d4edda' : '#fef3c7';
        const callPrice = result.bid.price;  // コール価格（勝敗判定用）
        const recordPrice = result.bid.displayPrice || result.bid.price;  // 記帳価格（売上計上用）

        bidResultHtml += `<div style="background: ${bgColor}; padding: 10px; margin: 10px 0; border-radius: 5px;">`;
        bidResultHtml += `<strong>${index === 0 ? '🏆 1位落札' : '✓ 残枠販売'}: ${result.company.name}</strong><br>`;
        bidResultHtml += `<div style="display: flex; gap: 15px; margin: 5px 0;">`;
        bidResultHtml += `<span style="font-size: 12px; color: #666;">コール価格: ¥${callPrice}</span>`;
        bidResultHtml += `<span style="font-size: 12px; color: #2563eb;">記帳価格: ¥${recordPrice}</span>`;
        bidResultHtml += `</div>`;
        bidResultHtml += `数量: ${result.quantity}個<br>`;
        if (researchChips > 0 || isParent) {
            bidResultHtml += '<div style="font-size: 12px; margin-top: 5px; color: #666;">【価格競争力】';
            if (researchChips > 0) {
                bidResultHtml += ` 研究${researchChips}枚(-${researchChips * 2}円)`;
            }
            if (isParent) {
                bidResultHtml += ` 親(-2円)`;
            }
            bidResultHtml += '</div>';
        }
        bidResultHtml += `<strong>売上金額: ¥${recordPrice * result.quantity}</strong>`;
        bidResultHtml += '</div>';
    });

    const unsoldBids = allBids.filter(bid =>
        !salesResults.some(result => result.bid === bid)
    );

    if (unsoldBids.length > 0) {
        bidResultHtml += '<div class="bid-entries">';
        bidResultHtml += '<div style="font-size: 12px; color: #666; margin-bottom: 5px;">入札したが売れなかった:</div>';
        unsoldBids.forEach((bid) => {
            const bidCompany = gameState.companies[bid.company];
            const callPrice = bid.price;  // コール価格
            const recordPrice = bid.displayPrice || bid.price;  // 記帳価格
            bidResultHtml += `
                <div class="bid-entry" style="color: #9ca3af; padding: 5px;">
                    <span>${bidCompany.name}</span>
                    <span style="font-size: 11px;">コール¥${callPrice} / 記帳¥${recordPrice} × ${bid.quantity}個（市場枠なし）</span>
                </div>
            `;
        });
        bidResultHtml += '</div>';
    }

    bidResultHtml += '</div>';

    closeModal();
    showModal('2市場同時入札 結果', bidResultHtml + '<button class="submit-btn" onclick="completeSaleTwoMarket()">OK</button>');

    // プレイヤーへのメッセージとフラグ設定
    const playerResult = salesResults.find(r => r.bid.company === 0);
    if (playerResult) {
        gameState.lastSaleInfo = `【2市場同時入札結果】\n${market1.name}+${market2.name}に${playerResult.quantity}個を¥${playerResult.price * playerResult.quantity}で販売しました`;
        gameState.playerSoldInBid = true;  // お金の流れがあった
    } else {
        gameState.lastSaleInfo = `【2市場同時入札結果】\n入札は他社に負けました`;
        gameState.playerSoldInBid = false;  // お金の流れがなかった
    }

    gameState.pendingBid = null;
    gameState.selectedMarkets = [];
    gameState.twoMarketMode = false;
}

// 2市場同時販売完了
function completeSaleTwoMarket() {
    closeModal();
    updateDisplay();

    // プレイヤーが実際に販売した場合のみ1行使用（お金の流れがあった場合）
    const playerSold = gameState.playerSoldInBid;
    gameState.playerSoldInBid = null;  // フラグをリセット

    if (playerSold) {
        endTurn();
    } else {
        nextTurn();
    }
}

// 各社の決算を個別に表示
function showCompanySettlement(index, financialData) {
    if (index >= financialData.length) {
        // 全社表示完了、サマリーを表示
        showFinancialSummary(financialData);
        return;
    }

    const data = financialData[index];
    const company = gameState.companies[index];
    const isPlayer = index === 0;

    // PQ/VQ/MQ/G計算
    const pq = data.pq;
    const vq = data.vq;
    const mq = data.mq;
    const f = data.f;
    const g = data.g;
    const q = data.q;

    const companyEmojis = { 'あなた': '👤', 'A社': '🅰️', 'B社': '🅱️', 'C社': '©️', 'D社': '🇩', 'E社': '🇪' };
    const emoji = companyEmojis[company.name] || '🏢';

    const content = `
        <div style="padding: 20px;">
            <div style="text-align: center; margin-bottom: 20px;">
                <div style="font-size: 48px; margin-bottom: 10px;">${emoji}</div>
                <div style="font-size: 24px; font-weight: bold; color: ${isPlayer ? '#2563eb' : '#374151'};">${company.name}</div>
                <div style="font-size: 14px; color: #666;">第${gameState.currentPeriod}期 決算</div>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                <div style="background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%); color: white; padding: 15px; border-radius: 12px; text-align: center;">
                    <div style="font-size: 12px; opacity: 0.8;">売上高 (PQ)</div>
                    <div style="font-size: 24px; font-weight: bold;">¥${pq}</div>
                </div>
                <div style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; padding: 15px; border-radius: 12px; text-align: center;">
                    <div style="font-size: 12px; opacity: 0.8;">変動費 (VQ)</div>
                    <div style="font-size: 24px; font-weight: bold;">¥${vq}</div>
                </div>
                <div style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; padding: 15px; border-radius: 12px; text-align: center;">
                    <div style="font-size: 12px; opacity: 0.8;">付加価値 (MQ)</div>
                    <div style="font-size: 24px; font-weight: bold;">¥${mq}</div>
                </div>
                <div style="background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%); color: white; padding: 15px; border-radius: 12px; text-align: center;">
                    <div style="font-size: 12px; opacity: 0.8;">固定費 (F)</div>
                    <div style="font-size: 24px; font-weight: bold;">¥${f}</div>
                </div>
            </div>

            <div style="background: ${g >= 0 ? 'linear-gradient(135deg, #22c55e 0%, #16a34a 100%)' : 'linear-gradient(135deg, #ef4444 0%, #dc2626 100%)'}; color: white; padding: 20px; border-radius: 12px; text-align: center; margin-bottom: 20px;">
                <div style="font-size: 14px; opacity: 0.9;">利益 (G = MQ - F)</div>
                <div style="font-size: 36px; font-weight: bold;">${g >= 0 ? '+' : ''}¥${g}</div>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 20px;">
                <div style="background: #f1f5f9; padding: 10px; border-radius: 8px; text-align: center;">
                    <div style="font-size: 10px; color: #64748b;">販売個数 (Q)</div>
                    <div style="font-size: 18px; font-weight: bold;">${q}個</div>
                </div>
                <div style="background: #f1f5f9; padding: 10px; border-radius: 8px; text-align: center;">
                    <div style="font-size: 10px; color: #64748b;">平均P</div>
                    <div style="font-size: 18px; font-weight: bold;">${data.p.toFixed(1)}</div>
                </div>
                <div style="background: #f1f5f9; padding: 10px; border-radius: 8px; text-align: center;">
                    <div style="font-size: 10px; color: #64748b;">平均M</div>
                    <div style="font-size: 18px; font-weight: bold;">${data.m.toFixed(1)}</div>
                </div>
            </div>

            <div style="background: #e0f2fe; padding: 15px; border-radius: 12px; margin-bottom: 20px;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span style="font-size: 14px; color: #0369a1;">自己資本</span>
                    <span style="font-size: 24px; font-weight: bold; color: #0369a1;">¥${company.equity}</span>
                </div>
            </div>

            <div style="text-align: center;">
                <button class="action-btn primary" onclick="showNextCompanySettlement()" style="padding: 15px 40px; font-size: 16px;">
                    ${index < financialData.length - 1 ? `次へ（${financialData[index + 1].name}）` : '全社サマリーを表示'}
                </button>
            </div>
        </div>
    `;

    showModal(`${company.name} 決算結果`, content);
}

// 次の会社の決算を表示
function showNextCompanySettlement() {
    closeModal();
    window.currentSettlementIndex++;
    showCompanySettlement(window.currentSettlementIndex, window.lastFinancialData);
}

// Show financial summary with detailed calculations
// 横軸：メンバー、縦軸：項目の表形式
function showFinancialSummary(financialData) {
    // 各社の自己資本を取得
    const equities = gameState.companies.map(c => c.equity);

    // 項目定義（縦軸）
    const items = [
        { key: 'equity', label: '自己資本', format: v => `¥${v}` },
        { key: 'p', label: '平均P', format: v => v.toFixed(1) },
        { key: 'v', label: '平均V', format: v => v.toFixed(1) },
        { key: 'm', label: '平均M', format: v => v.toFixed(1) },
        { key: 'q', label: 'Q', format: v => v },
        { key: 'pq', label: 'PQ', format: v => `¥${v}` },
        { key: 'vq', label: 'VQ', format: v => `¥${v}` },
        { key: 'mq', label: 'MQ', format: v => `¥${v}` },
        { key: 'f', label: 'F', format: v => `¥${v}` },
        { key: 'g', label: 'G', format: v => `¥${v}`, highlight: true }
    ];

    // ヘッダー行（会社名）
    let html = `
        <div style="overflow-x: auto;">
            <table style="width: 100%; border-collapse: collapse; font-size: 11px;">
                <thead>
                    <tr style="background: #1e40af; color: white;">
                        <th style="border: 1px solid #3b82f6; padding: 6px; text-align: left;">項目</th>
    `;

    financialData.forEach((data, index) => {
        const isPlayer = index === 0;
        html += `<th style="border: 1px solid #3b82f6; padding: 6px; text-align: center; background: ${isPlayer ? '#2563eb' : '#1e40af'}; min-width: 60px;">${data.name.replace('社', '')}</th>`;
    });
    html += '</tr></thead><tbody>';

    // 各項目の行を生成
    items.forEach(item => {
        html += `<tr>
            <td style="border: 1px solid #dee2e6; padding: 6px; background: #f1f5f9; font-weight: bold;">${item.label}</td>`;

        financialData.forEach((data, index) => {
            const isPlayer = index === 0;
            let value;
            if (item.key === 'equity') {
                value = equities[index];
            } else {
                value = data[item.key];
            }

            const formatted = item.format(value);
            let style = `border: 1px solid #dee2e6; padding: 6px; text-align: right;`;
            if (isPlayer) style += ' background: #e0f2fe;';
            if (item.highlight) {
                style += value >= 0 ? ' color: #16a34a; font-weight: bold;' : ' color: #dc2626; font-weight: bold;';
            }

            html += `<td style="${style}">${formatted}</td>`;
        });
        html += '</tr>';
    });

    html += `
                </tbody>
            </table>
        </div>
        <div style="margin-top: 10px; font-size: 10px; color: #666;">
            <p>平均P = PQ÷Q、平均V = VQ÷Q、平均M = MQ÷Q</p>
            <p>MQ = PQ - VQ、G = MQ - F</p>
        </div>
        <div style="display: flex; gap: 10px; margin-top: 15px;">
            <button class="cancel-btn" onclick="showActionLogModal()" style="flex: 1;">行動ログを見る</button>
            <button class="submit-btn" onclick="closeModal(); proceedToNextPeriod();" style="flex: 1;">次期へ進む</button>
        </div>
    `;

    showModal(`第${gameState.currentPeriod}期 決算結果`, html);
}

// Show detailed financial calculations for a company
function showFinancialDetails(companyIndex) {
    const company = gameState.companies[companyIndex];
    const pq = company.totalSales;
    const vq = calculateVQ(company);
    const mq = pq - vq;
    const fixedCosts = calculateFixedCost(company);
    const g = mq - fixedCosts - (company.specialLoss || 0);
    
    // Q = 販売個数
    const q = company.totalSoldQuantity || 0;
    
    // 在庫数量
    const inventoryP = company.products || 0;
    const inventoryV = company.wip || 0;
    const inventoryM = company.materials || 0;
    
    // VQの詳細計算
    const materialCost = company.totalMaterialCost || 0;
    const productionCost = company.totalProductionCost || 0;
    const endInventoryValue = (inventoryM * 13) + (inventoryV * 14) + (inventoryP * 15);
    const startInventoryValue = (company.periodStartInventory.materials * 13) + 
                               (company.periodStartInventory.wip * 14) + 
                               (company.periodStartInventory.products * 15);
    
    let html = `
        <div class="breakdown-list" style="max-height: 500px; overflow-y: auto;">
            <h3>${company.name}の財務詳細</h3>
            
            <div class="breakdown-item breakdown-total"><span>【PQ：売上高】</span><span>¥${pq}</span></div>
            <div class="breakdown-item" style="font-size: 11px;"><span>　期中売上累計</span><span>¥${pq}</span></div>
            
            <div class="breakdown-item breakdown-total"><span>【VQ：変動費総額】</span><span>¥${vq}</span></div>
            <div class="breakdown-item" style="font-size: 11px;"><span>　①材料購入費</span><span>¥${materialCost}</span></div>
            <div class="breakdown-item" style="font-size: 11px;"><span>　②完成投入費</span><span>¥${productionCost}</span></div>
            <div class="breakdown-item" style="font-size: 11px;"><span>　③期末在庫評価額</span><span>¥${endInventoryValue}</span></div>
            <div class="breakdown-item" style="font-size: 11px; color: #666;"><span>　　(材${inventoryM}×13 + 仕${inventoryV}×14 + 製${inventoryP}×15)</span><span></span></div>
            <div class="breakdown-item" style="font-size: 11px;"><span>　④期首在庫評価額</span><span>-¥${startInventoryValue}</span></div>
            <div class="breakdown-item" style="font-size: 11px; color: #666;"><span>　　(材${company.periodStartInventory.materials}×13 + 仕${company.periodStartInventory.wip}×14 + 製${company.periodStartInventory.products}×15)</span><span></span></div>
            <div class="breakdown-item" style="font-size: 11px; color: #28a745;"><span>　VQ = ①+②+③-④</span><span>¥${vq}</span></div>
            
            <div class="breakdown-item breakdown-total"><span>【MQ：付加価値総額】</span><span>¥${mq}</span></div>
            <div class="breakdown-item" style="font-size: 11px; color: #28a745;"><span>　MQ = PQ - VQ</span><span>¥${pq} - ¥${vq}</span></div>
            
            <div class="breakdown-item breakdown-total"><span>【F】</span><span>¥${fixedCosts}</span></div>
            <div class="breakdown-item" style="font-size: 11px;"><span>　給料</span><span>¥${calculateSalaryCost(company, gameState.currentPeriod)}</span></div>
            <div class="breakdown-item" style="font-size: 11px;"><span>　チップ費用</span><span>¥${calculateChipCost(company, gameState.currentPeriod)}</span></div>
            <div class="breakdown-item" style="font-size: 11px;"><span>　減価償却費</span><span>¥${calculateDepreciation(company, gameState.currentPeriod)}</span></div>
            ${company.specialLoss ? `<div class="breakdown-item" style="font-size: 11px;"><span>　特別損失</span><span>¥${company.specialLoss}</span></div>` : ''}
            
            <div class="breakdown-item breakdown-total"><span>【G：利益】</span><span style="color: ${g >= 0 ? '#28a745' : '#dc3545'}">¥${g}</span></div>
            <div class="breakdown-item" style="font-size: 11px; color: #28a745;"><span>　G = MQ - F</span><span>¥${mq} - ¥${fixedCosts}</span></div>
            
            <div class="breakdown-item breakdown-total"><span>【Q：販売個数】</span><span>${company.totalSoldQuantity || 0}個</span></div>
            
            <div class="breakdown-item breakdown-total"><span>【期末在庫】</span><span></span></div>
            <div class="breakdown-item" style="font-size: 11px;"><span>　材料</span><span>${inventoryM}個</span></div>
            <div class="breakdown-item" style="font-size: 11px;"><span>　仕掛品</span><span>${inventoryV}個</span></div>
            <div class="breakdown-item" style="font-size: 11px;"><span>　製品</span><span>${inventoryP}個</span></div>
            
            <div class="breakdown-item breakdown-total"><span>【単価計算】</span><span></span></div>
            <div class="breakdown-item" style="font-size: 11px;"><span>　P = PQ÷Q</span><span>¥${pq}÷${q} = ${q > 0 ? (pq/q).toFixed(1) : '―'}</span></div>
            <div class="breakdown-item" style="font-size: 11px;"><span>　V = VQ÷Q</span><span>¥${vq}÷${q} = ${q > 0 ? (vq/q).toFixed(1) : '―'}</span></div>
            <div class="breakdown-item" style="font-size: 11px;"><span>　M = MQ÷Q</span><span>¥${mq}÷${q} = ${q > 0 ? (mq/q).toFixed(1) : '―'}</span></div>
        </div>
        <button class="submit-btn" onclick="closeModal();" style="margin-top: 10px;">閉じる</button>
    `;
    
    showModal(`${company.name}の財務詳細`, html);
}

// Store financial data for reference
window.lastFinancialData = [];

// Proceed to next period
function proceedToNextPeriod() {
    // Move to next period
    gameState.currentPeriod++;
    gameState.currentPlayerIndex = 0;
    // 2期は期首処理で1行目を使うので、1からスタート
    // 3-5期も期首処理があるので1からスタート
    gameState.currentRow = 1;
    gameState.periodStarted = false;
    gameState.doNothingCount = {};

    // 各社のラスト5行警告フラグをリセット
    gameState.companies.forEach(company => {
        company.last5RowWarningShown = false;
    });

    // カードデッキをリセット（毎期シャッフル）
    initializeCardDeck();
    console.log(`第${gameState.currentPeriod}期開始：カードデッキをリセットしました`);

    // 使用済みリスクカードもリセット
    gameState.usedRiskCards = [];
    
    // Set max rows based on period
    if (gameState.currentPeriod === 3) {
        gameState.maxRows = 30;
    } else if (gameState.currentPeriod === 4) {
        gameState.maxRows = 34;
    } else if (gameState.currentPeriod === 5) {
        gameState.maxRows = 35;
    }
    
    if (gameState.currentPeriod > 5) {
        endGame();
    } else {
        // Period 2: Auto-purchase chips and start from row 2
        if (gameState.currentPeriod === 2) {
            // 期首処理として1行目を消費し、2行目から開始
            gameState.maxRows = gameState.maxRowsByPeriod[2];  // 2期は20行
            gameState.currentRow = 2;  // 期首処理済みなので2行目から開始（廃止予定）
            
            // 期首に自動でコンピュータと保険を購入
            gameState.companies.forEach(company => {
                const computerCost = 20;
                const insuranceCost = 5;
                const totalCost = computerCost + insuranceCost;
                
                // 各社の行数を2に設定（期首処理で1行使用）
                company.currentRow = 2;
                
                if (company.cash >= totalCost) {
                    company.cash -= totalCost;
                    company.chips.computer = 1;  // 毎期1枚購入
                    company.chips.insurance = 1;
                } else {
                    // Apply short loan if needed
                    const needed = Math.ceil((totalCost - company.cash) / 0.8 / 50) * 50;
                    company.shortLoans += needed;
                    company.cash += needed * 0.8;  // 短期借入: 借入時20%金利控除
                    company.cash -= totalCost;
                    company.chips.computer = 1;
                    company.chips.insurance = 1;
                }
            });
            
            gameState.periodStarted = true;
            updateDisplay();
            showToast(`第${gameState.currentPeriod}期を開始します\n全社：コンピュータチップ(¥20)と保険チップ(¥5)を自動購入しました。\n期首処理により2行目からゲーム開始です。`, 'success', 5000);

            // 強制的にもう一度updateDisplay()を呼んで確実に2行目表示
            setTimeout(() => {
                updateDisplay();
                saveGame();  // 期首を自動セーブ
                showTurnStartOptions();
            }, 100);
        } else {
            // Periods 3-5: Ask about borrowing
            showBorrowingChoice();
        }
    }
}

// 期首金利支払い処理（3期以降）
function processInterestPayments() {
    const interestDetails = [];

    gameState.companies.forEach(company => {
        let totalInterest = 0;
        let shortInterest = 0;
        let longInterest = 0;

        // 短期借入金利（20%）
        if (company.shortLoans > 0) {
            shortInterest = Math.floor(company.shortLoans * 0.2);
            totalInterest += shortInterest;
        }

        // 長期借入金利（10%）
        if (company.loans > 0) {
            longInterest = Math.floor(company.loans * 0.1);
            totalInterest += longInterest;
        }

        if (totalInterest > 0) {
            // 資金が足りない場合は短期借入
            if (company.cash < totalInterest) {
                const needed = Math.ceil((totalInterest - company.cash) / 0.8 / 50) * 50;
                company.shortLoans += needed;
                company.cash += needed * 0.8;  // 短期借入: 借入時20%金利控除
            }

            company.cash -= totalInterest;

            interestDetails.push({
                name: company.name,
                shortLoans: company.shortLoans,
                longLoans: company.loans,
                shortInterest: shortInterest,
                longInterest: longInterest,
                total: totalInterest
            });
        }
    });

    return interestDetails;
}

// Show borrowing choice for periods 3-5
function showBorrowingChoice() {
    // 期首金利支払い処理
    const interestDetails = processInterestPayments();

    // サイコロを振る（前期のPQトップが振る設定だが、簡略化して自動で振る）
    gameState.diceRoll = Math.floor(Math.random() * 6) + 1;

    // サイコロ結果に基づく設定
    if (gameState.diceRoll <= 3) {
        gameState.wageMultiplier = 1.1;
        // 仙台のみ閉鎖
        gameState.markets[0].closed = true;  // 仙台
        gameState.markets[1].closed = false; // 札幌
    } else {
        gameState.wageMultiplier = 1.2;
        // 仙台・札幌閉鎖
        gameState.markets[0].closed = true;  // 仙台
        gameState.markets[1].closed = true;  // 札幌
    }

    // 大阪上限価格（サイコロの目+20）
    gameState.osakaMaxPrice = 20 + gameState.diceRoll;
    gameState.markets[4].sellPrice = gameState.osakaMaxPrice;

    const closedMarkets = gameState.diceRoll <= 3 ? '仙台' : '仙台・札幌';

    // 金利支払い情報のHTML生成
    let interestHtml = '';
    if (interestDetails.length > 0) {
        interestHtml = `
            <div style="background: linear-gradient(135deg, #dc2626 0%, #ef4444 100%); border-radius: 12px; padding: 15px; margin-bottom: 15px; color: white; text-align: left;">
                <div style="font-size: 14px; font-weight: bold; margin-bottom: 10px; text-align: center;">💰 期首金利支払い</div>
                ${interestDetails.map(d => `
                    <div style="background: rgba(255,255,255,0.15); border-radius: 8px; padding: 10px; margin-bottom: 8px;">
                        <div style="font-weight: bold; margin-bottom: 5px;">${d.name}</div>
                        <div style="font-size: 12px; display: grid; grid-template-columns: 1fr 1fr; gap: 5px;">
                            ${d.shortInterest > 0 ? `<div>短期金利(20%): ¥${d.shortInterest}</div>` : ''}
                            ${d.longInterest > 0 ? `<div>長期金利(10%): ¥${d.longInterest}</div>` : ''}
                        </div>
                        <div style="font-size: 13px; font-weight: bold; margin-top: 5px; text-align: right;">支払合計: ¥${d.total}</div>
                    </div>
                `).join('')}
            </div>
        `;
    }

    const content = `
        <div style="text-align: center; padding: 20px;">
            <h3 style="margin-bottom: 15px;">第${gameState.currentPeriod}期開始</h3>

            ${interestHtml}

            <div style="background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%); border-radius: 16px; padding: 20px; margin-bottom: 20px; color: white;">
                <div style="font-size: 14px; margin-bottom: 10px;">🎲 サイコロ結果</div>
                <div style="font-size: 48px; font-weight: bold; margin-bottom: 10px;">${gameState.diceRoll}</div>
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; font-size: 12px;">
                    <div style="background: rgba(255,255,255,0.2); padding: 8px; border-radius: 8px;">
                        <div style="opacity: 0.8;">市場閉鎖</div>
                        <div style="font-weight: bold;">${closedMarkets}</div>
                    </div>
                    <div style="background: rgba(255,255,255,0.2); padding: 8px; border-radius: 8px;">
                        <div style="opacity: 0.8;">人件費倍率</div>
                        <div style="font-weight: bold;">×${gameState.wageMultiplier}</div>
                    </div>
                    <div style="background: rgba(255,255,255,0.2); padding: 8px; border-radius: 8px;">
                        <div style="opacity: 0.8;">大阪上限</div>
                        <div style="font-weight: bold;">¥${gameState.osakaMaxPrice}</div>
                    </div>
                </div>
            </div>

            <p style="margin-bottom: 15px;">借入を行いますか？</p>
            <button class="action-btn primary" onclick="startPeriodWithBorrowing()" style="margin: 10px;">借入を行う（3行目からスタート）</button>
            <button class="action-btn secondary" onclick="startPeriodWithoutBorrowing()" style="margin: 10px;">借入を行わない（2行目からスタート）</button>
        </div>
    `;

    showModal('期首処理 - サイコロ結果', content);
}

// Start period with borrowing (periods 3-5)
function startPeriodWithBorrowing() {
    // 行動ログをリセット
    resetActionLog();

    // Auto-purchase chips for all companies first
    gameState.companies.forEach(company => {
        const computerCost = 20;
        const insuranceCost = 5;
        const totalCost = computerCost + insuranceCost;
        
        // 期首処理で2行使用（借入あり）→3行目から開始
        company.currentRow = 3;
        
        if (company.cash >= totalCost) {
            company.cash -= totalCost;
            company.chips.computer = 1;
            company.chips.insurance = 1;
        } else {
            // Apply short loan if needed
            const needed = Math.ceil((totalCost - company.cash) / 0.8 / 50) * 50;
            company.shortLoans += needed;
            company.cash += needed * 0.8;  // 短期借入: 借入時20%金利控除
            company.cash -= totalCost;
            company.chips.computer = 1;
            company.chips.insurance = 1;
        }
    });
    
    gameState.currentRow = 3;  // Start from row 3 when borrowing
    // Set maxRows based on period
    if (gameState.currentPeriod === 3) {
        gameState.maxRows = gameState.maxRowsByPeriod[3];
    } else if (gameState.currentPeriod === 4) {
        gameState.maxRows = gameState.maxRowsByPeriod[4];
    } else if (gameState.currentPeriod === 5) {
        gameState.maxRows = gameState.maxRowsByPeriod[5];
    }
    gameState.periodStarted = true;
    closeModal();
    updateDisplay();
    showToast(`第${gameState.currentPeriod}期を開始します\n全社：コンピュータチップ(¥20)と保険チップ(¥5)を自動購入しました。\n借入を実施するため、3行目からゲームスタートです。`, 'success', 5000);
    showBorrowModal();
}

// Start period without borrowing (periods 3-5)
function startPeriodWithoutBorrowing() {
    // 行動ログをリセット
    resetActionLog();

    // Auto-purchase chips for all companies first
    gameState.companies.forEach(company => {
        const computerCost = 20;
        const insuranceCost = 5;
        const totalCost = computerCost + insuranceCost;
        
        // 期首処理で1行使用（借入なし）→2行目から開始
        company.currentRow = 2;
        
        if (company.cash >= totalCost) {
            company.cash -= totalCost;
            company.chips.computer = 1;
            company.chips.insurance = 1;
        } else {
            // Apply short loan if needed
            const needed = Math.ceil((totalCost - company.cash) / 0.8 / 50) * 50;
            company.shortLoans += needed;
            company.cash += needed * 0.8;  // 短期借入: 借入時20%金利控除
            company.cash -= totalCost;
            company.chips.computer = 1;
            company.chips.insurance = 1;
        }
    });
    
    // Period 3-5: 借入なしの場合は2行目から開始
    gameState.currentRow = 2;  // Start from row 2 (period start processing uses 1 row)
    // Set maxRows based on period
    if (gameState.currentPeriod === 3) {
        gameState.maxRows = gameState.maxRowsByPeriod[3];
    } else if (gameState.currentPeriod === 4) {
        gameState.maxRows = gameState.maxRowsByPeriod[4];
    } else if (gameState.currentPeriod === 5) {
        gameState.maxRows = gameState.maxRowsByPeriod[5];
    }
    gameState.periodStarted = true;
    closeModal();
    updateDisplay();
    saveGame();  // 期首を自動セーブ
    showToast(`第${gameState.currentPeriod}期を開始します\n全社：コンピュータチップ(¥20)と保険チップ(¥5)を自動購入しました。\n期首処理完了で2行目からゲームスタートです。`, 'success', 5000);
    showTurnStartOptions();
}

// Show borrowing modal
function showBorrowModal() {
    const company = gameState.companies[0];
    // 借入上限：3期は0.5倍、4期以降で自己資本300超なら1倍
    const loanMultiplier = (gameState.currentPeriod >= 4 && company.equity > 300) ? 1.0 : 0.5;
    const maxLoanTotal = Math.round(company.equity * loanMultiplier);
    const availableLoan = Math.max(0, maxLoanTotal - company.loans);
    const loanRuleText = (gameState.currentPeriod >= 4 && company.equity > 300)
        ? `自己資本の1倍まで（300超のため）`
        : `自己資本の0.5倍まで`;

    const content = `
        <div class="form-group">
            <label class="form-label">長期借入（${loanRuleText}）</label>
            <div style="font-size: 11px; color: #666; margin-bottom: 5px;">
                上限: ¥${maxLoanTotal} - 既存借入¥${company.loans} = 追加可能¥${availableLoan}
            </div>
            <select id="loanAmount" class="form-control">
                <option value="0">借りない</option>
                ${availableLoan >= 50 ? '<option value="50">¥50</option>' : ''}
                ${availableLoan >= 100 ? '<option value="100">¥100</option>' : ''}
                ${availableLoan >= 150 ? '<option value="150">¥150</option>' : ''}
                ${availableLoan >= 200 ? '<option value="200">¥200</option>' : ''}
                ${availableLoan >= 250 ? '<option value="250">¥250</option>' : ''}
                ${availableLoan >= 300 ? '<option value="300">¥300</option>' : ''}
            </select>
        </div>
        <button class="submit-btn" onclick="processBorrowing()">借入を実施</button>
    `;

    showModal('借入処理', content);
}

// Process borrowing
function processBorrowing() {
    const company = gameState.companies[0];
    const loanAmount = parseInt(document.getElementById('loanAmount').value || 0);

    if (loanAmount > 0) {
        company.loans += loanAmount;
        const netAmount = Math.floor(loanAmount * 0.9);  // 長期借入: 借入時10%金利控除
        company.cash += netAmount;
        alert(`長期借入¥${loanAmount}（利息控除後¥${netAmount}入金）`);
    }

    closeModal();
    updateDisplay();
    saveGame();  // 借入後を自動セーブ
    showTurnStartOptions();
}

// Show sales capacity detail
function showSalesCapacityDetail(companyIndex) {
    const company = gameState.companies[companyIndex];
    const baseCapacity = company.salesmen * 2;
    const maxAdChips = company.salesmen * 2;  // セールスマン1人につき2枚まで
    const effectiveAdChips = Math.min(company.chips.advertising || 0, maxAdChips);
    const adBonus = effectiveAdChips * 2;
    const educationBonus = Math.min(company.chips.education || 0, 1);  // 効果は1枚分が上限
    const totalCapacity = getSalesCapacity(company);

    const adInfo = company.chips.advertising > 0
        ? `広告チップ: ${effectiveAdChips}枚 × 2 = +${adBonus}${company.chips.advertising > maxAdChips ? ` (${company.chips.advertising}枚中${effectiveAdChips}枚有効)` : ''}`
        : '';

    const content = `
        <div class="breakdown-list">
            <h3>販売能力の詳細</h3>
            <div class="breakdown-item"><span>セールスマン: ${company.salesmen}人 × 2 = ${baseCapacity}</span></div>
            ${adInfo ? `<div class="breakdown-item"><span>${adInfo}</span></div>` : ''}
            ${educationBonus > 0 ? `<div class="breakdown-item"><span>教育チップ: +${educationBonus}${company.chips.education > 1 ? ' (上限1)' : ''}</span></div>` : ''}
            <hr>
            <div class="breakdown-item breakdown-total"><span>販売能力</span><span>${totalCapacity}</span></div>
        </div>
    `;

    showModal(`${company.name}の販売能力`, content);
}

// Show AI bid notification
function showAIBidNotification() {
    const bid = gameState.aiPendingBid;
    const playerCompany = gameState.companies[0];
    const playerSalesCapacity = getSalesCapacity(playerCompany);
    const playerMaxQty = Math.min(playerSalesCapacity, playerCompany.products);
    
    const content = `
        <div class="bid-display">
            <div class="bid-title">${gameState.companies[bid.company].name}が入札を開始</div>
            <p>市場: ${bid.market.name} (最大価格: ¥${bid.market.sellPrice})</p>
            <p>${gameState.companies[bid.company].name}の入札: 非公開 × ${bid.quantity}個</p>
            <hr>
            <p>あなたも入札に参加しますか？</p>
            <p>現在の在庫: ${playerCompany.products}個 (販売能力: ${playerSalesCapacity})</p>
            <div class="form-group">
                <label class="form-label">入札価格（¥）:</label>
                <input type="number" id="playerBidPrice" class="form-control" value="${Math.floor(bid.market.sellPrice * 0.9)}" min="1" max="${bid.market.sellPrice}">
            </div>
            <div class="form-group">
                <label class="form-label">入札数量:</label>
                <select id="playerBidQty" class="form-control">
                    ${Array(playerMaxQty + 1).fill(0).map((_, i) => 
                        `<option value="${i}" ${i === playerMaxQty ? 'selected' : ''}>${i}個</option>`
                    ).join('')}
                </select>
            </div>
            <button class="submit-btn" onclick="processAIBidWithPlayer()">入札に参加</button>
            <button class="cancel-btn" onclick="skipPlayerBid()">参加しない</button>
        </div>
    `;
    
    showModal('他社入札への参加', content);
}

// Process AI bid with player participation
function processAIBidWithPlayer() {
    const bid = gameState.aiPendingBid;
    const playerPrice = parseInt(document.getElementById('playerBidPrice').value);
    const playerQty = parseInt(document.getElementById('playerBidQty').value);
    
    const allBids = [];
    
    // AI company's bid
    const aiCompany = gameState.companies[bid.company];
    const aiCompetitiveness = getPriceCompetitiveness(aiCompany);
    allBids.push({
        company: bid.company,
        price: bid.price,  // 有効入札額（既に競争力を引いた値）
        displayPrice: bid.price + aiCompetitiveness,  // 実際の入金額
        quantity: bid.quantity,
        competitiveness: aiCompetitiveness
    });
    
    // Player's bid
    if (playerQty > 0) {
        const playerCompetitiveness = getPriceCompetitiveness(gameState.companies[0]);
        allBids.push({
            company: 0,
            price: playerPrice - playerCompetitiveness,  // 有効入札額
            displayPrice: playerPrice,  // 実際の入金額
            quantity: playerQty,
            competitiveness: playerCompetitiveness
        });
    }
    
    // Other AI companies' bids
    for (let i = 1; i < gameState.companies.length; i++) {
        if (i !== bid.company) {
            const otherCompany = gameState.companies[i];
            if (otherCompany.products > 0) {
                const otherCapacity = getSalesCapacity(otherCompany);
                const otherQty = Math.min(otherCapacity, otherCompany.products);
                if (otherQty > 0) {
                    const otherDisplayPrice = Math.floor(bid.market.sellPrice * (0.7 + Math.random() * 0.25));
                    const otherPrice = otherDisplayPrice - getPriceCompetitiveness(otherCompany);
                    allBids.push({company: i, price: otherPrice, quantity: otherQty, displayPrice: otherDisplayPrice});
                }
            }
        }
    }
    
    // Sort by: 1) price (lowest), 2) research chips (most), 3) parent (priority)
    allBids.sort((a, b) => {
        // First compare actual bid price
        if (a.price !== b.price) return a.price - b.price;
        
        // Same price: compare research chips (more chips wins)
        const aResearch = gameState.companies[a.company].chips.research || 0;
        const bResearch = gameState.companies[b.company].chips.research || 0;
        if (aResearch !== bResearch) return bResearch - aResearch;
        
        // Same research chips: parent wins
        const aIsParent = (gameState.currentPlayerIndex === a.company);
        const bIsParent = (gameState.currentPlayerIndex === b.company);
        if (aIsParent && !bIsParent) return -1;
        if (!aIsParent && bIsParent) return 1;
        
        return 0;
    });
    
    // Process winner
    const winner = allBids[0];
    const winCompany = gameState.companies[winner.company];
    const actualQty = Math.min(winner.quantity, bid.market.maxStock - bid.market.currentStock);
    
    if (actualQty > 0) {
        const salePrice = winner.displayPrice || winner.price;
        winCompany.cash += salePrice * actualQty;
        winCompany.products -= actualQty;
        winCompany.totalSales += salePrice * actualQty;
        winCompany.totalSoldQuantity = (winCompany.totalSoldQuantity || 0) + actualQty;
        bid.market.currentStock += actualQty;
    }
    
    // Show results
    let resultHtml = '<div class="bid-display"><div class="bid-title">入札結果</div><div class="bid-entries">';
    allBids.forEach((b, index) => {
        const isWinner = index === 0;
        const company = gameState.companies[b.company];
        const isParent = (gameState.currentPlayerIndex === b.company);
        const researchChips = company.chips.research || 0;
        
        // 競争力の内訳を表示
        let competitiveBonus = '';
        if (isParent) competitiveBonus += '親+2 ';
        if (researchChips > 0) competitiveBonus += `研究+${researchChips * 2} `;
        
        // 有効入札額と実際の入金額を表示
        const effectivePrice = b.price;
        const actualPrice = b.displayPrice || (b.price + getPriceCompetitiveness(company));
        
        resultHtml += `
            <div class="bid-entry ${isWinner ? 'bid-winner' : ''}">
                <span>${company.name}</span>
                <span>¥${effectivePrice}（¥${actualPrice}）× ${b.quantity}個 ${competitiveBonus}</span>
            </div>
        `;
    });
    resultHtml += '</div><p style="font-size: 12px; margin-top: 10px;">※有効入札額（実際の入金額）</p></div><button class="submit-btn" onclick="continueAITurn()">OK</button>';
    
    closeModal();
    showModal('入札結果', resultHtml);
}

// Skip player bid
function skipPlayerBid() {
    // プレイヤーの入札をスキップ（数量0で処理）
    document.getElementById('playerBidQty').value = '0';
    processAIBidWithPlayer(); // Process without player bid
}

// Continue AI turn after bid
function continueAITurn() {
    closeModal();
    const company = gameState.companies[gameState.aiPendingBid.company];
    incrementRow(gameState.companies.indexOf(company));
    gameState.aiPendingBid = null;
    nextTurn();
}

// Insurance purchase modal (B-rule)
function showInsurancePurchaseModal() {
    const company = gameState.companies[0];
    
    if (company.chips.insurance > 0) {
        showToast('すでに保険に加入しています', 'warning', 3000);
        return;
    }
    
    const content = `
        <div class="form-group">
            <label class="form-label">保険チップ購入</label>
            <p style="font-size: 12px; color: #666;">価格：¥5<br>効果：火災・盗難時に保険金受取（使用後消費）</p>
        </div>
        <button class="submit-btn" onclick="buyInsurance()">購入(¥5)</button>
    `;
    
    showModal('保険チップ購入', content);
}

// Buy insurance
function buyInsurance() {
    const company = gameState.companies[0];
    
    if (company.cash < 5) {
        showToast('現金が不足しています', 'danger', 3000);
        return;
    }
    
    company.cash -= 5;
    company.chips.insurance = 1;
    
    closeModal();
    showToast('保険チップを購入しました（¥5）', 'success', 3000);
    
    // カードを引く
    drawCard();
}

// Chip modal (for period-specific purchases)
function showChipModal(specificType = null) {
    const period = gameState.currentPeriod;
    const company = gameState.companies[0];

    const chipInfo = {
        research: { name: '研究', icon: '🔬', color: '#4a90d9', border: '#1e4a7a', desc: '価格競争力+2円' },
        education: { name: '教育', icon: '📚', color: '#fbbf24', border: '#9a7000', desc: '製造能力+1' },
        advertising: { name: '広告', icon: '📣', color: '#ef4444', border: '#8b1c1c', desc: '販売能力+2' }
    };

    let content = `
        <div style="background: linear-gradient(180deg, #f0f9ff 0%, #e0f2fe 100%); border-radius: 12px; padding: 15px; margin-bottom: 15px; border: 2px solid #0284c7;">
            <div style="text-align: center; margin-bottom: 10px;">
                <span style="font-size: 12px; color: #0369a1;">現在のチップ</span>
            </div>
            <div style="display: flex; justify-content: space-around; text-align: center;">
                <div style="background: #fff; border-radius: 8px; padding: 6px 12px; border: 2px solid ${chipInfo.research.border};">
                    <div style="font-size: 18px;">${chipInfo.research.icon}</div>
                    <div style="font-size: 14px; font-weight: bold; color: ${chipInfo.research.color};">${company.chips.research || 0}</div>
                </div>
                <div style="background: #fff; border-radius: 8px; padding: 6px 12px; border: 2px solid ${chipInfo.education.border};">
                    <div style="font-size: 18px;">${chipInfo.education.icon}</div>
                    <div style="font-size: 14px; font-weight: bold; color: ${chipInfo.education.color};">${company.chips.education || 0}</div>
                </div>
                <div style="background: #fff; border-radius: 8px; padding: 6px 12px; border: 2px solid ${chipInfo.advertising.border};">
                    <div style="font-size: 18px;">${chipInfo.advertising.icon}</div>
                    <div style="font-size: 14px; font-weight: bold; color: ${chipInfo.advertising.color};">${company.chips.advertising || 0}</div>
                </div>
            </div>
        </div>

        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 15px;">
            <div onclick="selectChipType('research')" id="chip-research" style="background: linear-gradient(180deg, ${chipInfo.research.color} 0%, #2e6db4 100%); border-radius: 10px; padding: 12px 8px; border: 3px solid ${chipInfo.research.border}; cursor: pointer; text-align: center; transition: all 0.2s;">
                <div style="font-size: 28px; margin-bottom: 5px;">${chipInfo.research.icon}</div>
                <div style="font-size: 12px; font-weight: bold; color: #fff;">研究</div>
                <div style="font-size: 9px; color: #bfdbfe;">${chipInfo.research.desc}</div>
            </div>
            <div onclick="selectChipType('education')" id="chip-education" style="background: linear-gradient(180deg, ${chipInfo.education.color} 0%, #d69e00 100%); border-radius: 10px; padding: 12px 8px; border: 3px solid ${chipInfo.education.border}; cursor: pointer; text-align: center; transition: all 0.2s;">
                <div style="font-size: 28px; margin-bottom: 5px;">${chipInfo.education.icon}</div>
                <div style="font-size: 12px; font-weight: bold; color: #78350f;">教育</div>
                <div style="font-size: 9px; color: #92400e;">${chipInfo.education.desc}</div>
            </div>
            <div onclick="selectChipType('advertising')" id="chip-advertising" style="background: linear-gradient(180deg, ${chipInfo.advertising.color} 0%, #c42b2b 100%); border-radius: 10px; padding: 12px 8px; border: 3px solid ${chipInfo.advertising.border}; cursor: pointer; text-align: center; transition: all 0.2s;">
                <div style="font-size: 28px; margin-bottom: 5px;">${chipInfo.advertising.icon}</div>
                <div style="font-size: 12px; font-weight: bold; color: #fff;">広告</div>
                <div style="font-size: 9px; color: #fecaca;">${chipInfo.advertising.desc}</div>
            </div>
        </div>

        <input type="hidden" id="chipType" value="${specificType || 'research'}">
    `;

    if (period >= 3) {
        // 3-5期：特急または繰り越し
        content += `
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
            <div onclick="selectPurchaseType('express')" id="purchase-express" style="background: linear-gradient(180deg, #dc2626 0%, #b91c1c 100%); border-radius: 10px; padding: 12px; border: 3px solid #991b1b; cursor: pointer; text-align: center; transition: all 0.2s;">
                <div style="font-size: 20px; margin-bottom: 3px;">⚡</div>
                <div style="font-size: 13px; font-weight: bold; color: #fff;">特急</div>
                <div style="font-size: 11px; color: #fecaca;">¥40 / 即時使用</div>
            </div>
            <div onclick="selectPurchaseType('carryover')" id="purchase-carryover" style="background: linear-gradient(180deg, #9333ea 0%, #7c3aed 100%); border-radius: 10px; padding: 12px; border: 3px solid #6b21a8; cursor: pointer; text-align: center; transition: all 0.2s;">
                <div style="font-size: 20px; margin-bottom: 3px;">📅</div>
                <div style="font-size: 13px; font-weight: bold; color: #fff;">次期繰り越し</div>
                <div style="font-size: 11px; color: #e9d5ff;">¥20 / 次期から</div>
            </div>
        </div>
        <input type="hidden" id="purchaseType" value="express">
        `;
    }

    content += `
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 15px;">
            <div style="background: #f1f5f9; border-radius: 10px; padding: 12px;">
                <div style="font-size: 12px; color: #64748b; margin-bottom: 5px;">購入数</div>
                <select id="quantity" class="form-control" style="font-size: 18px; text-align: center; font-weight: bold;" onchange="updateChipCost()">
                    <option value="1">1個</option>
                    <option value="2">2個</option>
                    <option value="3">3個</option>
                </select>
            </div>
            <div style="background: #f1f5f9; border-radius: 10px; padding: 12px; text-align: center;">
                <div style="font-size: 12px; color: #64748b;">合計金額</div>
                <div id="chipTotalCost" style="font-size: 24px; font-weight: bold; color: #dc2626;">¥${period === 2 ? 20 : 40}</div>
            </div>
        </div>

        <button class="submit-btn" onclick="buyChips()" style="width: 100%;">
            🎯 購入実行
        </button>
    `;

    showModal('🎯 戦略チップ購入', content);

    // 初期選択を視覚的に反映
    setTimeout(() => {
        selectChipType(specificType || 'research');
        if (period >= 3) selectPurchaseType('express');
    }, 0);
}

// チップタイプを選択
function selectChipType(type) {
    document.getElementById('chipType').value = type;

    ['research', 'education', 'advertising'].forEach(t => {
        const el = document.getElementById(`chip-${t}`);
        if (el) {
            el.style.transform = t === type ? 'scale(1.05)' : 'scale(1)';
            el.style.boxShadow = t === type ? '0 0 20px rgba(251,191,36,0.6)' : 'none';
        }
    });
    updateChipCost();
}

// 購入タイプを選択（3期以降）
function selectPurchaseType(type) {
    document.getElementById('purchaseType').value = type;

    ['express', 'carryover'].forEach(t => {
        const el = document.getElementById(`purchase-${t}`);
        if (el) {
            el.style.transform = t === type ? 'scale(1.03)' : 'scale(1)';
            el.style.boxShadow = t === type ? '0 0 15px rgba(251,191,36,0.5)' : 'none';
        }
    });
    updateChipCost();
}

// チップ購入金額を更新
function updateChipCost() {
    const period = gameState.currentPeriod;
    const quantity = parseInt(document.getElementById('quantity').value) || 1;
    let unitCost = 20;

    if (period >= 3) {
        const purchaseType = document.getElementById('purchaseType');
        if (purchaseType && purchaseType.value === 'express') {
            unitCost = 40;
        }
    }

    const total = quantity * unitCost;
    document.getElementById('chipTotalCost').textContent = `¥${total}`;
}

// Buy chips
function buyChips() {
    const company = gameState.companies[0];
    const chipType = document.getElementById('chipType').value;
    const quantity = parseInt(document.getElementById('quantity').value);
    const period = gameState.currentPeriod;
    
    let cost = 0;
    let isExpress = false;
    
    if (period === 2) {
        // 2期：その期に使用（20円）
        cost = quantity * 20;
        isExpress = true;
    } else {
        // 3-5期：特急または繰り越し
        const purchaseType = document.getElementById('purchaseType').value;
        isExpress = purchaseType === 'express';
        cost = quantity * (isExpress ? 40 : 20);
    }
    
    if (company.cash < cost) {
        // 短期借入
        const needed = Math.ceil((cost - company.cash) / 0.8 / 50) * 50;
        company.shortLoans += needed;
        company.cash += needed * 0.8;  // 短期借入: 借入時20%金利控除
        showToast(`現金不足のため短期借入¥${needed}を実行しました`, 'warning', 4000);
    }
    
    // Check max limits
    const maxLimits = {research: 5, education: 1, advertising: 5};
    const nextPeriodCount = company.nextPeriodChips?.[chipType] || 0;
    const currentTotal = company.chips[chipType] + nextPeriodCount + quantity;
    if (currentTotal > maxLimits[chipType]) {
        alert(`${chipType}チップは最大${maxLimits[chipType]}個までです！`);
        return;
    }
    
    company.cash -= cost;

    if (isExpress) {
        // 即時使用
        company.chips[chipType] += quantity;
    } else {
        // 次期繰り越し
        company.nextPeriodChips[chipType] += quantity;
    }

    // 行動ログ記録
    const chipNames = {research: '研究', education: '教育', advertising: '広告'};
    const typeStr = isExpress ? '特急' : '繰越';
    logAction(0, 'チップ購入', `${chipNames[chipType]}${quantity}枚(${typeStr})`, -cost, true);

    closeModal();
    updateDisplay();
    showToast(`${chipType}チップを${quantity}個購入しました（¥${cost}）`, 'success', 3000);
    endTurn();
}

// Do nothing
function doNothing() {
    const company = gameState.companies[0];
    
    if (!gameState.doNothingCount[0]) {
        gameState.doNothingCount[0] = 0;
    }
    
    if (gameState.doNothingCount[0] >= 3) {
        showToast('DO NOTHINGは連続3回までです！', 'danger', 3000);
        return;
    }
    
    gameState.doNothingCount[0]++;
    showToast(`DO NOTHINGを選択しました（${gameState.doNothingCount[0]}/3回）\n行は消費されません。`, 'info', 3000);
    
    // DO NOTHING doesn't use a row
    nextTurn();
}

// ラスト5行警告モーダル
function showLast5RowWarning(company) {
    const remaining = gameState.maxRows - company.currentRow + 1;
    const content = `
        <div style="padding: 20px; text-align: center;">
            <div style="font-size: 48px; margin-bottom: 15px;">⚠️</div>
            <div style="font-size: 18px; font-weight: bold; color: #dc2626; margin-bottom: 10px;">
                ${company.name}がラスト5行に到達！
            </div>
            <div style="font-size: 14px; color: #6b7280; margin-bottom: 15px;">
                残り${remaining}行で期末処理が始まります。<br>
                給料支払いに備えて資金を確保してください。
            </div>
            <div style="background: #fef2f2; border-radius: 8px; padding: 15px; margin-bottom: 15px;">
                <div style="font-size: 12px; color: #991b1b;">
                    現在行: ${company.currentRow} / 上限: ${gameState.maxRows}行
                </div>
            </div>
            <button class="submit-btn" onclick="closeModal()">OK</button>
        </div>
    `;
    showModal('ラスト5行警告', content);
}

// 行数を増やす関数（資源変更時に呼ぶ）
function incrementRow(companyIndex) {
    const company = gameState.companies[companyIndex];
    company.currentRow = (company.currentRow || 1) + 1;

    // ラスト5行の警告（各社が個別に残り5行に到達するたびに警告）
    if (!company.last5RowWarningShown && company.currentRow === gameState.maxRows - 4) {
        company.last5RowWarningShown = true;
        showLast5RowWarning(company);
    }
    
    // 誰かが上限に達したら期末処理
    if (company.currentRow >= gameState.maxRows) {
        console.log(`${company.name}が行数上限（${gameState.maxRows}行）に達しました！期末処理を開始します。`);
        endPeriod();
        return true;  // 期末処理を開始した
    }
    return false;  // まだ続行
}

// End turn
function endTurn() {
    const company = gameState.companies[gameState.currentPlayerIndex];

    // 労災フラグをリセット（ターン終了時）
    company.cannotProduce = false;

    // 行数を増やす（資源変更があったため）
    if (incrementRow(gameState.currentPlayerIndex)) {
        return;  // 期末処理が始まったので終了
    }

    gameState.doNothingCount[gameState.currentPlayerIndex] = 0;

    // 自動セーブ
    saveGame();

    nextTurn();
}

// Next turn
function nextTurn() {
    // Check skip turns
    const currentCompany = gameState.companies[gameState.currentPlayerIndex];
    if (currentCompany.skipTurns > 0) {
        currentCompany.skipTurns--;
        console.log(`${currentCompany.name}は休み（残り${currentCompany.skipTurns}回）`);
    }
    
    // ターン順の処理（逆回りの場合）
    if (gameState.turnReversed) {
        gameState.currentPlayerIndex--;
        if (gameState.currentPlayerIndex < 0) {
            gameState.currentPlayerIndex = gameState.companies.length - 1;
            gameState.currentRow++;
            
            if (gameState.currentRow > gameState.maxRows) {
                endPeriod();
                return;
            }
        }
    } else {
        gameState.currentPlayerIndex++;
        if (gameState.currentPlayerIndex >= gameState.companies.length) {
            gameState.currentPlayerIndex = 0;
            gameState.currentRow++;
            
            if (gameState.currentRow > gameState.maxRows) {
                endPeriod();
                return;
            }
        }
    }
    
    updateDisplay();
    
    // Auto-execute AI turn
    if (gameState.currentPlayerIndex !== 0) {
        setTimeout(executeAITurn, 1000);
    } else {
        // Player's turn
        if (gameState.companies[0].skipTurns > 0) {
            gameState.companies[0].skipTurns--;
            alert(`休み中（残り${gameState.companies[0].skipTurns}回）`);
            nextTurn();
        } else {
            showTurnStartOptions();
        }
    }
}

// Apply risk card to AI company
function applyRiskCardToAI(company, card) {
    let rowUsed = true;

    switch(card.id) {
        case 1: // クレーム発生
        case 2:
            company.cash = Math.max(0, company.cash - 5);
            break;
        case 3: // 教育成功
        case 4:
            if (company.chips.education > 0 && company.products > 0) {
                const sellQty = Math.min(getSalesCapacity(company), company.products, 5);
                company.cash += sellQty * 32;
                company.products -= sellQty;
                company.totalSales += sellQty * 32;
                company.totalSoldQuantity = (company.totalSoldQuantity || 0) + sellQty;
            }
            break;
        case 5: // 消費者運動発生
        case 6:
            company.cannotSell = true;
            break;
        case 7: // 得意先倒産
        case 8:
            if (gameState.currentPeriod !== 2) {
                company.cash = Math.max(0, company.cash - 30);
                company.specialLoss = (company.specialLoss || 0) + 30;
            }
            break;
        case 9: // 研究開発失敗
        case 10:
        case 11:
            if (company.chips.research > 0) {
                company.chips.research--;
            } else if (company.nextPeriodChips.research > 0) {
                company.nextPeriodChips.research--;
            }
            break;
        case 12: // 広告成功
        case 13:
        case 14:
            if (company.chips.advertising > 0 && company.products > 0) {
                const maxSell = Math.min(company.chips.advertising * 2, 5);
                const sellQty = Math.min(maxSell, company.products);
                company.cash += sellQty * 32;
                company.products -= sellQty;
                company.totalSales += sellQty * 32;
                company.totalSoldQuantity = (company.totalSoldQuantity || 0) + sellQty;
            }
            break;
        case 15: // 労災発生
        case 16:
            company.cannotProduce = true;
            break;
        case 17: // 広告政策失敗
        case 18:
            if (company.chips.advertising > 0) {
                company.chips.advertising--;
            } else if (company.nextPeriodChips.advertising > 0) {
                company.nextPeriodChips.advertising--;
            }
            break;
        case 19: // 特別サービス
        case 20:
            // AIは材料購入を選択（5個まで1個10円）
            const buyQty = Math.min(5, Math.floor(company.cash / 10));
            if (buyQty > 0) {
                company.cash -= buyQty * 10;
                company.materials += buyQty;
            }
            break;
        case 21: // 返品発生
        case 22:
        case 23:
            if (gameState.currentPeriod !== 2) {
                company.totalSales -= 20;
                company.products++;
            }
            break;
        case 24: // コンピュータートラブル
        case 25:
            company.cash = Math.max(0, company.cash - 10);
            break;
        case 26: // 商品の独占販売
        case 27:
        case 28:
            const sellQtyMonopoly = Math.min(company.salesmen * 2, company.products, 5);
            if (sellQtyMonopoly > 0) {
                company.cash += sellQtyMonopoly * 32;
                company.products -= sellQtyMonopoly;
                company.totalSales += sellQtyMonopoly * 32;
                company.totalSoldQuantity = (company.totalSoldQuantity || 0) + sellQtyMonopoly;
            }
            break;
        case 29: // 製造ミス発生
        case 30:
            if (company.wip > 0) {
                company.wip--;
                company.specialLoss = (company.specialLoss || 0) + 14;
            }
            break;
        case 31: // 倉庫火災
        case 32:
            {
                const lostMaterials = company.materials;
                const materialValue = lostMaterials * 13;
                if (company.chips.insurance > 0) {
                    const compensation = lostMaterials * 8;
                    company.cash += compensation;
                    company.chips.insurance = 0;
                    company.specialLoss = (company.specialLoss || 0) + (materialValue - compensation);
                } else {
                    company.specialLoss = (company.specialLoss || 0) + materialValue;
                }
                company.materials = 0;
            }
            break;
        case 33: // 縁故採用
        case 34:
            company.cash = Math.max(0, company.cash - 5);
            company.extraLaborCost = (company.extraLaborCost || 0) + 5;  // 人件費
            // AIはランダムでワーカーかセールスマンを追加
            if (Math.random() > 0.5) {
                company.workers++;
            } else {
                company.salesmen++;
            }
            break;
        case 35: // 研究開発成功
        case 36:
        case 37:
        case 38:
        case 39:
        case 40:
            if (company.chips.research > 0 && company.products > 0) {
                const salesCapacity = getSalesCapacity(company);
                const sellQty = Math.min(company.chips.research * 2, company.products, salesCapacity, 5);
                company.cash += sellQty * 32;
                company.products -= sellQty;
                company.totalSales += sellQty * 32;
                company.totalSoldQuantity = (company.totalSoldQuantity || 0) + sellQty;
            }
            break;
        case 41: // 各社共通
        case 42:
            executeAllCompaniesCommonPurchaseFromAI(company);
            return;
        case 43: // ストライキ発生
        case 44:
            company.skipTurns = 1;
            rowUsed = false;
            break;
        case 45: // 盗難発見
        case 46:
            {
                const stolen = Math.min(2, company.products);
                const productValue = stolen * 15;
                if (company.chips.insurance > 0) {
                    const compensation = stolen * 10;
                    company.cash += compensation;
                    company.chips.insurance = 0;
                    company.specialLoss = (company.specialLoss || 0) + (productValue - compensation);
                } else {
                    company.specialLoss = (company.specialLoss || 0) + productValue;
                }
                company.products -= stolen;
                const overseasMarket = gameState.markets.find(m => m.name === '海外');
                if (overseasMarket) overseasMarket.currentStock += stolen;
            }
            break;
        case 47: // 長期労務紛争
        case 48:
            company.skipTurns = 2;
            rowUsed = false;
            break;
        case 49: // 設計トラブル発生
        case 50:
            company.cash = Math.max(0, company.cash - 10);
            break;
        case 51: // ワーカー退職
        case 52:
            company.cash = Math.max(0, company.cash - 5);
            company.extraLaborCost = (company.extraLaborCost || 0) + 5;  // 人件費
            if (company.workers > 0) {
                company.workers--;
                company.retiredWorkers = (company.retiredWorkers || 0) + 1;  // 退職者追跡
            }
            break;
        case 53: // 景気変動
        case 54:
            gameState.turnReversed = !gameState.turnReversed;
            break;
        case 55: // 教育失敗
        case 56:
            if (company.chips.education > 0) {
                company.chips.education--;
            } else if (company.nextPeriodChips.education > 0) {
                company.nextPeriodChips.education--;
            }
            break;
        case 57: // セールスマン退職
        case 58:
            company.cash = Math.max(0, company.cash - 5);
            company.extraLaborCost = (company.extraLaborCost || 0) + 5;  // 人件費
            if (company.salesmen > 0) {
                company.salesmen--;
                company.retiredSalesmen = (company.retiredSalesmen || 0) + 1;  // 退職者追跡
            }
            break;
        case 59: // 社長、病気で倒れる
        case 60:
            company.skipTurns = 1;
            rowUsed = false;
            break;
        case 61: // 不良在庫発生（保険対象外）
        case 62:
            let totalInv = company.materials + company.wip + company.products;
            if (totalInv > 20) {
                let excess = totalInv - 20;
                let lostVal = 0;
                if (company.products > 0 && excess > 0) {
                    const remove = Math.min(company.products, excess);
                    company.products -= remove;
                    lostVal += remove * 15;
                    excess -= remove;
                }
                if (company.wip > 0 && excess > 0) {
                    const remove = Math.min(company.wip, excess);
                    company.wip -= remove;
                    lostVal += remove * 14;
                    excess -= remove;
                }
                if (company.materials > 0 && excess > 0) {
                    const remove = Math.min(company.materials, excess);
                    company.materials -= remove;
                    lostVal += remove * 13;
                }
                company.specialLoss = (company.specialLoss || 0) + lostVal;
            }
            break;
        case 63: // 機械故障
        case 64:
            company.cash = Math.max(0, company.cash - 5);
            if (!company.additionalFixedCost) company.additionalFixedCost = 0;
            company.additionalFixedCost += 5;
            break;
        default:
            break;
    }

    if (rowUsed) {
        endTurn();
    } else {
        nextTurn();
    }
}

// Execute common purchase when AI draws the card
function executeAllCompaniesCommonPurchaseFromAI(aiCompany) {
    const playerCompany = gameState.companies[0];
    const content = `
        <div class="risk-display">
            <div class="risk-title">${aiCompany.name}が「各社共通」を引きました</div>
            <div class="risk-description">全社が12円で3個まで材料を購入できます<br>（まず市場から、不足分は海外から）</div>
        </div>
        <div style="margin-top: 20px;">
            <p>現在の現金: ¥${playerCompany.cash}</p>
            <div class="form-group">
                <label class="form-label">あなたの購入数量:</label>
                <select id="playerQuantity" class="form-control">
                    <option value="0">購入しない</option>
                    <option value="1">1個購入（¥12）</option>
                    <option value="2">2個購入（¥24）</option>
                    <option value="3">3個購入（¥36）</option>
                </select>
            </div>
            <button class="submit-btn" onclick="processAICommonPurchase()">決定</button>
        </div>
    `;
    
    showModal('各社共通購入', content);
    
    // AI会社を一時保存
    gameState.aiCommonPurchase = aiCompany;
}

// Process AI common purchase
function processAICommonPurchase() {
    const playerQty = parseInt(document.getElementById('playerQuantity').value || 0);
    const playerCompany = gameState.companies[0];
    const aiCompany = gameState.aiCommonPurchase;

    let purchaseLog = [];
    let playerPurchased = false;  // プレイヤーが実際に購入したかどうか

    // プレイヤーの購入処理
    if (playerQty > 0) {
        const cost = playerQty * 12;
        if (playerCompany.cash >= cost) {
            let purchased = 0;

            // まず市場から購入
            for (const market of gameState.markets) {
                if (purchased >= playerQty) break;
                if (market.currentStock > 0) {
                    const qty = Math.min(playerQty - purchased, market.currentStock);
                    market.currentStock -= qty;
                    purchased += qty;
                }
            }

            // 不足分は海外市場（ストッカー）から
            const overseasMarket = gameState.markets.find(m => m.name === '海外');
            if (purchased < playerQty && overseasMarket) {
                const qty = playerQty - purchased;
                overseasMarket.currentStock = Math.max(0, overseasMarket.currentStock - qty);
                purchased += qty;
            }

            playerCompany.cash -= cost;
            playerCompany.materials += playerQty;
            playerCompany.totalMaterialCost += cost;
            playerPurchased = true;  // お金の流れがあった

            // 行動ログ記録
            logAction(0, '各社共通', `¥12×${playerQty}個購入`, -cost, true);

            purchaseLog.push(`あなた: ${playerQty}個購入（¥${cost}）`);
        } else {
            purchaseLog.push('あなた: 現金不足で購入できず');
        }
    } else {
        purchaseLog.push('あなた: 購入しない');
    }

    // 全AI会社の購入処理（プロは12円で3個必ず買う）
    for (let i = 1; i < gameState.companies.length; i++) {
        const company = gameState.companies[i];
        const maxAffordable = Math.min(3, Math.floor(company.cash / 12));

        if (maxAffordable >= 2) {  // 2個以上買えるなら買う
            const aiQty = maxAffordable;
            let purchased = 0;

            // まず市場から購入
            for (const market of gameState.markets) {
                if (purchased >= aiQty) break;
                if (market.currentStock > 0) {
                    const buyQty = Math.min(aiQty - purchased, market.currentStock);
                    market.currentStock -= buyQty;
                    purchased += buyQty;
                }
            }

            // 不足分は海外市場から
            const overseasMarket = gameState.markets.find(m => m.name === '海外');
            if (purchased < aiQty && overseasMarket) {
                const buyQty = aiQty - purchased;
                overseasMarket.currentStock = Math.max(0, overseasMarket.currentStock - buyQty);
                purchased += buyQty;
            }

            if (purchased > 0) {
                const aiCost = purchased * 12;
                company.cash -= aiCost;
                company.materials += purchased;
                company.totalMaterialCost += aiCost;

                // 行動ログ記録（AI）
                logAction(i, '各社共通', `¥12×${purchased}個購入`, -aiCost, false);

                purchaseLog.push(`${company.name}: ${purchased}個購入（¥${aiCost}）`);
            }
        }
    }

    closeModal();
    updateDisplay();

    // 購入結果を表示
    alert('【各社共通購入結果】\n' + purchaseLog.join('\n'));

    // AIのターンを終了
    gameState.aiCommonPurchase = null;

    // プレイヤーが購入した場合のみ1行使用（お金の流れがあった場合）
    if (playerPurchased) {
        endTurn();
    } else {
        nextTurn();
    }
}

// AI行動表示モーダル
function showAIActionModal(company, actionType, actionIcon, actionDetail, resultData = null) {
    const companyEmojis = {
        'A社': '🅰️', 'B社': '🅱️', 'C社': '©️', 'D社': '🇩', 'E社': '🇪'
    };

    let resultHtml = '';
    if (resultData) {
        resultHtml = '<div class="ai-action-result">';
        resultData.forEach(row => {
            resultHtml += `<div class="ai-action-result-row ${row.highlight ? 'highlight' : ''}">
                <span>${row.label}</span>
                <span>${row.value}</span>
            </div>`;
        });
        resultHtml += '</div>';
    }

    const modalHtml = `
        <div class="ai-action-modal" id="aiActionModal">
            <div class="ai-action-header">
                <div class="ai-action-avatar">${companyEmojis[company.name] || '🏢'}</div>
                <div class="ai-action-company-info">
                    <div class="ai-action-company-name">${company.name}</div>
                    <div class="ai-action-company-cash">現金: ¥${company.cash}</div>
                </div>
            </div>
            <div class="ai-action-body">
                <div class="ai-action-icon">${actionIcon}</div>
                <div class="ai-action-type">${actionType}</div>
                <div class="ai-action-detail">${actionDetail}</div>
                ${resultHtml}
            </div>
            <button class="ai-action-continue-btn" onclick="closeAIActionModal()">OK</button>
        </div>
    `;

    document.getElementById('modalContainer').innerHTML = modalHtml;
}

// AI行動モーダルを閉じて次のターンへ
function closeAIActionModal() {
    document.getElementById('modalContainer').innerHTML = '';
    nextTurn();
}

// Execute AI turn
function executeAITurn() {
    const company = gameState.companies[gameState.currentPlayerIndex];

    if (company.skipTurns > 0) {
        company.skipTurns--;
        nextTurn();
        return;
    }

    // カードデッキから引く（プレイヤーと同様）
    if (!gameState.deckInitialized || gameState.cardDeck.length === 0) {
        initializeCardDeck();
    }

    const cardType = gameState.cardDeck.pop();
    console.log(`${company.name}がカードを引きました: ${cardType}（残り${gameState.cardDeck.length}枚）`);

    if (cardType === 'risk') {
        const availableCards = gameState.riskCards.filter(card => {
            if (gameState.currentPeriod === 2 && card.period2Exempt) return false;
            return !gameState.usedRiskCards.includes(card.id);
        });

        if (availableCards.length > 0) {
            const card = availableCards[Math.floor(Math.random() * availableCards.length)];
            gameState.usedRiskCards.push(card.id);
            console.log(`${company.name}がリスクカード「${card.name}」を引きました`);

            // Apply risk card effect to AI
            applyRiskCardToAI(company, card);

            // リスクカードを引いたことを通知
            showAIActionModal(company, `リスクカード: ${card.name}`, '⚠️', card.description);
            return; // リスクカードを引いたらターン終了
        }
        // 利用可能なリスクカードがない場合は意思決定へ
    }
    
    // 緊急採用チェック（ワーカーまたはセールスマンが0人）
    if (company.workers === 0 || company.salesmen === 0) {
        // 緊急採用を実行
        let hireWorkers = 0;
        let hireSalesmen = 0;
        
        if (company.workers === 0) {
            hireWorkers = 1; // 最低1人採用
        }
        if (company.salesmen === 0) {
            hireSalesmen = 1; // 最低1人採用
        }
        
        const cost = (hireWorkers + hireSalesmen) * 5;
        if (company.cash >= cost) {
            company.cash -= cost;
            company.workers += hireWorkers;
            company.salesmen += hireSalesmen;
            incrementRow(gameState.companies.indexOf(company));
            
            let detail = '';
            if (hireWorkers > 0) detail += `ワーカー ${hireWorkers}人`;
            if (hireSalesmen > 0) detail += `${hireWorkers > 0 ? '、' : ''}セールスマン ${hireSalesmen}人`;

            showAIActionModal(company, '緊急採用', '👥', detail, [
                { label: '採用費', value: `¥${cost}` }
            ]);
            return;
        } else {
            // 現金不足の場合は短期借入
            const needed = Math.ceil((cost - company.cash) / 0.8 / 50) * 50;
            company.shortLoans += needed;
            company.cash += needed * 0.8;  // 短期借入: 借入時20%金利控除
            company.cash -= cost;
            company.workers += hireWorkers;
            company.salesmen += hireSalesmen;
            incrementRow(gameState.companies.indexOf(company));

            let detail = '';
            if (hireWorkers > 0) detail += `ワーカー ${hireWorkers}人`;
            if (hireSalesmen > 0) detail += `${hireWorkers > 0 ? '、' : ''}セールスマン ${hireSalesmen}人`;

            showAIActionModal(company, '緊急採用', '👥', detail, [
                { label: '短期借入', value: `¥${needed}` },
                { label: '採用費', value: `¥${cost}` }
            ]);
            return;
        }
    }
    
    // AI性格別戦略実行
    const mfgCapacity = getManufacturingCapacity(company);
    const salesCapacity = getSalesCapacity(company);
    
    // AI分析データを取得
    const analysis = getAIFinancialAnalysis(company);
    executeAIStrategyByType(company, mfgCapacity, salesCapacity, analysis);
}

// AI財務分析（賢い判断のためのデータ収集 - 5期終了時自己資本最大化志向）
function getAIFinancialAnalysis(company) {
    const period = gameState.currentPeriod;
    const rowsRemaining = gameState.maxRows - (company.currentRow || 1);
    const periodsRemaining = 5 - period;  // 残り期数

    // 期末必要資金（給料 + 借入返済）
    const periodEndCost = calculatePeriodPayment(company);
    const fixedCost = calculateFixedCost(company);

    // 他社との比較
    const rivals = gameState.companies.filter(c => c !== company);
    const avgRivalEquity = rivals.reduce((sum, c) => sum + c.equity, 0) / rivals.length;
    const maxRivalEquity = Math.max(...rivals.map(c => c.equity));
    const equityRank = gameState.companies.filter(c => c.equity > company.equity).length + 1;

    // MQ推定（現在の販売能力と製品から）
    const salesCapacity = getSalesCapacity(company);
    const potentialSales = Math.min(company.products, salesCapacity);
    const estimatedPQ = potentialSales * 28; // 平均販売価格推定
    const estimatedMQ = estimatedPQ - (potentialSales * 15); // 材料費差し引き

    // 在庫状況
    const totalInventory = company.materials + company.wip + company.products;
    const needsMaterials = company.materials < 3;
    const needsProduction = company.wip > 0 || company.materials > company.wip;
    const canSell = company.products > 0 && salesCapacity > 0;

    // 資金余裕度
    const cashSafety = company.cash - periodEndCost;
    const isCashTight = cashSafety < 50;

    // 長期借入可能額（3期は0.5倍、4期以降で300超なら1倍）
    const loanMultiplier = (period >= 4 && company.equity > 300) ? 1.0 : 0.5;
    const maxLongLoan = Math.round(company.equity * loanMultiplier);
    const availableLoan = Math.max(0, maxLongLoan - company.loans);
    const canBorrow = period >= 3 && availableLoan > 0;

    // === 長期戦略分析（5期終了時自己資本最大化） ===
    const mfgCapacity = getManufacturingCapacity(company);

    // 次期への投資価値（研究チップは価格競争力+2 → 入札勝率向上 → MQ増加）
    const researchChipValue = periodsRemaining * 2 * 5;  // 残り期数 × 価格競争力 × 推定販売回数
    const shouldInvestForFuture = periodsRemaining >= 2 && !isCashTight && company.chips.research < 4;

    // 能力バランス（長期的に製造=販売が理想）
    const capacityBalance = mfgCapacity - salesCapacity;
    const needsCapacityBalance = Math.abs(capacityBalance) >= 2;

    // 5期は投資せず売り切り優先（回収期）
    const isFinalPeriod = period === 5;
    const isRecoveryPhase = period >= 4 && rowsRemaining < 10;

    return {
        period,
        periodsRemaining,
        rowsRemaining,
        periodEndCost,
        fixedCost,
        avgRivalEquity,
        maxRivalEquity,
        equityRank,
        estimatedMQ,
        totalInventory,
        needsMaterials,
        needsProduction,
        canSell,
        cashSafety,
        isCashTight,
        maxLongLoan,
        canBorrow,
        // 長期戦略
        shouldInvestForFuture,
        researchChipValue,
        capacityBalance,
        needsCapacityBalance,
        isFinalPeriod,
        isRecoveryPhase,
        // 推奨アクション優先度
        shouldSellFirst: canSell && (isCashTight || rowsRemaining < 5 || isFinalPeriod),
        shouldInvest: !isCashTight && rowsRemaining > 10 && !isRecoveryPhase,
        shouldBeAggressive: equityRank > 3 && rowsRemaining > 5 && !isFinalPeriod
    };
}

// AI性格別の戦略実行
function executeAIStrategyByType(company, mfgCapacity, salesCapacity, analysis) {
    // 給料支払いを考慮：残り5行以下かつ資金不足なら販売優先
    if (analysis.rowsRemaining <= 5 && analysis.isCashTight && company.products > 0 && salesCapacity > 0) {
        executeDefaultSale(company, salesCapacity, 0.85);
        return;
    }

    // 次期チップ投資（3期以降、余裕があれば）
    if (gameState.currentPeriod >= 3 && !analysis.isCashTight && analysis.rowsRemaining > 3) {
        const chipCost = 40;
        if (company.cash > analysis.periodEndCost + chipCost + 50) {
            // 研究チップ優先（次期に持ち越し）
            if (company.nextPeriodChips.research < 3 && Math.random() > 0.5) {
                company.cash -= chipCost;
                company.nextPeriodChips.research++;
                incrementRow(gameState.companies.indexOf(company));
                showAIActionModal(company, 'チップ購入(次期)', '🔬', '研究開発チップを次期用に購入');
                return;
            }
        }
    }

    switch(company.strategy) {
        case 'aggressive':    // A社：積極的
            executeAggressiveStrategy(company, mfgCapacity, salesCapacity, analysis);
            break;
        case 'conservative':  // C社：保守的
            executeConservativeStrategy(company, mfgCapacity, salesCapacity, analysis);
            break;
        case 'price_focused': // D社：価格競争
            executePriceFocusedStrategy(company, mfgCapacity, salesCapacity, analysis);
            break;
        case 'tech_focused':  // E社：技術重視
            executeTechFocusedStrategy(company, mfgCapacity, salesCapacity, analysis);
            break;
        case 'unpredictable': // F社：予測不能
            executeUnpredictableStrategy(company, mfgCapacity, salesCapacity, analysis);
            break;
        default:             // B社：バランス
            executeBalancedStrategy(company, mfgCapacity, salesCapacity, analysis);
    }
}

// A社：積極的戦略（MQ最大化重視・長期志向）
function executeAggressiveStrategy(company, mfgCapacity, salesCapacity, analysis) {
    // MQを最大化するための戦略的判断（5期終了時自己資本最大化）
    const periodEndCost = calculatePeriodPayment(company);
    const safetyMargin = periodEndCost + 30;
    const chipCost = gameState.currentPeriod === 2 ? 20 : 40;

    // === 5期（最終期）は売り切り優先 ===
    if (analysis.isFinalPeriod) {
        if (company.products > 0 && salesCapacity > 0) {
            executeDefaultSale(company, salesCapacity, 0.70);
            return;
        }
        if ((company.materials > 0 || company.wip > 0) && mfgCapacity > 0) {
            executeDefaultProduction(company, mfgCapacity);
            return;
        }
        nextTurn();
        return;
    }

    // === 4期後半は回収フェーズ ===
    if (analysis.isRecoveryPhase && company.products > 0 && salesCapacity > 0) {
        executeDefaultSale(company, salesCapacity, 0.72);
        return;
    }

    // 1. 販売優先（PQを増やす - 7割以上で）
    if (company.products > 0 && salesCapacity > 0) {
        const minSellQty = Math.ceil(salesCapacity * 0.7);
        if (company.products >= minSellQty) {
            executeDefaultSale(company, salesCapacity, 0.70);  // A社は積極的な低価格
            return;
        }
    }

    // 2. 生産最大化（在庫を製品に変換）
    if ((company.materials > 0 || company.wip > 0) && mfgCapacity > 0) {
        executeDefaultProduction(company, mfgCapacity);
        return;
    }

    // 3. 材料購入（7割以上の製造能力で）
    if (company.cash > safetyMargin + 40 && company.materials < mfgCapacity) {
        executeDefaultMaterialPurchase(company, mfgCapacity);
        return;
    }

    // 4. 長期投資（残り期数を考慮）
    if (company.cash > safetyMargin + chipCost && analysis.rowsRemaining > 5 && !analysis.isRecoveryPhase) {
        // 研究チップ優先（長期的にMQ増加に直結）
        if (analysis.shouldInvestForFuture && company.chips.research < 5 && company.cash >= chipCost + safetyMargin) {
            company.cash -= chipCost;
            company.chips.research++;
            incrementRow(gameState.companies.indexOf(company));
            showAIActionModal(company, 'チップ購入', '🔬', '研究開発チップ購入（長期投資）');
            return;
        }

        // 次期用チップ購入（積極的に）
        if (gameState.currentPeriod >= 3 && analysis.periodsRemaining >= 2) {
            if (company.nextPeriodChips.research < 3 && company.cash >= chipCost + safetyMargin + 30) {
                company.cash -= chipCost;
                company.nextPeriodChips.research++;
                incrementRow(gameState.companies.indexOf(company));
                showAIActionModal(company, 'チップ購入(次期)', '🔬', '次期用研究チップ購入');
                return;
            }
        }

        // ボトルネック解消投資
        if (analysis.needsCapacityBalance && analysis.capacityBalance > 0) {
            if (company.chips.advertising < 3 && company.cash >= chipCost + safetyMargin) {
                company.cash -= chipCost;
                company.chips.advertising++;
                incrementRow(gameState.companies.indexOf(company));
                showAIActionModal(company, 'チップ購入', '📢', '広告チップ購入');
                return;
            }
        }
    }
    
    // 販売最優先
    if (company.products >= salesCapacity && salesCapacity > 0) {
        // Find best market (high price, has space)
        const availableMarkets = gameState.markets.filter(m => 
            m.currentStock < m.maxStock && 
            (gameState.currentPeriod > 2 || m.name !== '海外')
        ).sort((a, b) => b.sellPrice - a.sellPrice);
        
        if (availableMarkets.length > 0) {
            const market = availableMarkets[0];
            const sellQty = Math.min(salesCapacity, company.products, market.maxStock - market.currentStock);
            
            if (market.needsBid) {
                // Check if player wants to participate
                const playerCompany = gameState.companies[0];
                
                if (playerCompany.products > 0) {
                    // Store AI company's bid info and ask player
                    gameState.aiPendingBid = {
                        company: gameState.currentPlayerIndex,
                        market: market,
                        marketIndex: gameState.markets.indexOf(market),
                        price: Math.floor(market.sellPrice * (0.7 + Math.random() * 0.25)) - getPriceCompetitiveness(company),
                        quantity: sellQty
                    };
                    
                    // Show modal to ask player if they want to bid
                    showAIBidNotification();
                    return; // Exit here, will continue after player decides
                }
                
                // Process bidding with all companies (player has no products)
                const allBids = [];
                
                // 価格設定（性格により変動）
                let priceMultiplier = 0.7 + Math.random() * 0.25;
                if (company.strategy === 'price_focused') {
                    priceMultiplier = 0.6 + Math.random() * 0.2;  // D社：より低価格
                } else if (company.strategy === 'conservative') {
                    priceMultiplier = 0.75 + Math.random() * 0.2; // C社：安定価格
                } else if (company.strategy === 'aggressive') {
                    priceMultiplier = 0.65 + Math.random() * 0.25; // A社：積極的価格
                }
                
                // Current AI company's bid
                const bidPrice = Math.floor(market.sellPrice * priceMultiplier) - getPriceCompetitiveness(company);
                const displayPrice = Math.floor(market.sellPrice * priceMultiplier);
                allBids.push({company: gameState.currentPlayerIndex, price: bidPrice, quantity: sellQty, displayPrice: displayPrice});
                
                // All other companies (including player) also bid if they have products
                for (let i = 0; i < gameState.companies.length; i++) {
                    if (i !== gameState.currentPlayerIndex) {
                        const otherCompany = gameState.companies[i];
                        if (otherCompany.products > 0) {
                            const otherCapacity = getSalesCapacity(otherCompany);
                            const otherQty = Math.min(otherCapacity, otherCompany.products, market.maxStock - market.currentStock);
                            if (otherQty > 0) {
                                let otherPrice;
                                if (i === 0) {
                                    // Player company - use strategic pricing
                                    otherPrice = Math.floor(market.sellPrice * 0.85) - getPriceCompetitiveness(otherCompany);
                                } else {
                                    // AI company
                                    otherPrice = Math.floor(market.sellPrice * (0.7 + Math.random() * 0.25)) - getPriceCompetitiveness(otherCompany);
                                }
                                const otherDisplayPrice = i === 0 ? Math.floor(market.sellPrice * 0.85) : Math.floor(market.sellPrice * (0.7 + Math.random() * 0.25));
                                allBids.push({company: i, price: otherPrice, quantity: otherQty, displayPrice: otherDisplayPrice});
                            }
                        }
                    }
                }
                
                // Sort by price (lowest wins)
                allBids.sort((a, b) => a.price - b.price);
                
                // Process winner's sale
                const winner = allBids[0];
                const winCompany = gameState.companies[winner.company];
                const actualQty = Math.min(winner.quantity, market.maxStock - market.currentStock);
                
                if (actualQty > 0) {
                    const salePrice = winner.displayPrice || winner.price;
                    winCompany.cash += salePrice * actualQty;
                    winCompany.products -= actualQty;
                    winCompany.totalSales += salePrice * actualQty;
                    winCompany.totalSoldQuantity = (winCompany.totalSoldQuantity || 0) + actualQty;
                    market.currentStock += actualQty;
                    
                    // Notify player if they participated
                    if (winner.company === 0) {
                        console.log(`プレイヤーが${market.name}に¥${winner.price}×${actualQty}個で落札しました！`);
                    } else if (gameState.companies[0].products > 0) {
                        console.log(`${winCompany.name}が${market.name}に¥${winner.price}×${actualQty}個で落札（プレイヤーも参加）`);
                    } else {
                        console.log(`入札結果: ${winCompany.name}が${market.name}に¥${winner.price}×${actualQty}個で落札`);
                    }
                }
            } else {
                // Direct sale (no bidding)
                company.cash += market.sellPrice * sellQty;
                company.products -= sellQty;
                company.totalSales += market.sellPrice * sellQty;
                company.totalSoldQuantity = (company.totalSoldQuantity || 0) + sellQty;
                market.currentStock += sellQty;
            }
            
            incrementRow(gameState.companies.indexOf(company));
            nextTurn();
            return;
        }
    }
    
    // Buy materials if low
    if (company.materials < 3 && company.cash > 50) {
        // Find cheapest market with stock
        const availableMarkets = gameState.markets.filter(m => m.currentStock > 0)
            .sort((a, b) => a.buyPrice - b.buyPrice);
        
        if (availableMarkets.length > 0) {
            const market = availableMarkets[0];
            const buyQty = Math.min(3, market.currentStock, Math.floor(company.cash / market.buyPrice));
            
            if (buyQty > 0) {
                company.cash -= market.buyPrice * buyQty;
                company.materials += buyQty;
                company.totalMaterialCost += market.buyPrice * buyQty;
                market.currentStock -= buyQty;
                
                incrementRow(gameState.companies.indexOf(company));
                nextTurn();
                return;
            }
        }
    }
    
    // Produce if has materials
    if (company.materials > 0 && company.cash > mfgCapacity) {
        const produceQty = Math.min(mfgCapacity, company.materials);
        const wipToProduct = Math.min(mfgCapacity, company.wip);
        const cost = produceQty + wipToProduct;
        
        if (company.cash >= cost) {
            company.cash -= cost;
            company.materials -= produceQty;
            company.wip += produceQty - wipToProduct;
            company.products += wipToProduct;
            company.totalProductionCost += cost;
            
            incrementRow(gameState.companies.indexOf(company));
            nextTurn();
            return;
        }
    }
    
    // 投資戦略（性格により異なる）
    executeDefaultInvestment(company);
}

// C社：保守的戦略（安定的MQ確保・長期志向）
function executeConservativeStrategy(company, mfgCapacity, salesCapacity, analysis) {
    // 安定的にMQを確保する戦略（5期終了時自己資本最大化）
    const periodEndCost = calculatePeriodPayment(company);
    const safetyMargin = periodEndCost + 50;  // 保守的なので余裕を持つ
    const chipCost = gameState.currentPeriod === 2 ? 20 : 40;

    // === 5期（最終期）は売り切り優先 ===
    if (analysis.isFinalPeriod) {
        if (company.products > 0 && salesCapacity > 0) {
            executeDefaultSale(company, salesCapacity, 0.85);
            return;
        }
        if ((company.materials > 0 || company.wip > 0) && mfgCapacity > 0) {
            executeDefaultProduction(company, mfgCapacity);
            return;
        }
        nextTurn();
        return;
    }

    // === 4期後半は回収フェーズ ===
    if (analysis.isRecoveryPhase && company.products > 0 && salesCapacity > 0) {
        executeDefaultSale(company, salesCapacity, 0.83);
        return;
    }

    // 1. 確実な販売（在庫リスク回避、7割以上で）
    const minSellQty = Math.ceil(salesCapacity * 0.7);
    if (company.products >= minSellQty && salesCapacity > 0) {
        executeDefaultSale(company, salesCapacity, 0.85);  // 安全な価格
        return;
    }

    // 2. 安定生産
    if ((company.materials > 0 || company.wip > 0) && mfgCapacity > 0 && company.products < 4) {
        executeDefaultProduction(company, mfgCapacity);
        return;
    }

    // 3. 計画的材料購入（7割以上で）
    if (company.cash > safetyMargin + 40 && company.materials < mfgCapacity) {
        executeDefaultMaterialPurchase(company, mfgCapacity);
        return;
    }

    // 4. 長期的投資（保守的だが着実に）
    if (company.cash > safetyMargin + chipCost && analysis.rowsRemaining > 8 && !analysis.isRecoveryPhase) {
        // 保険チップ（リスク軽減）
        if (!company.chips.insurance && company.cash >= chipCost + safetyMargin) {
            company.cash -= chipCost;
            company.chips.insurance = 1;
            incrementRow(gameState.companies.indexOf(company));
            showAIActionModal(company, 'チップ購入', '🛡️', '保険チップ購入（リスク軽減）');
            return;
        }
        // 研究チップ（長期的に価格競争力向上）
        if (analysis.shouldInvestForFuture && company.chips.research < 3 && company.cash >= chipCost + safetyMargin) {
            company.cash -= chipCost;
            company.chips.research++;
            incrementRow(gameState.companies.indexOf(company));
            showAIActionModal(company, 'チップ購入', '🔬', '研究開発チップ購入（長期投資）');
            return;
        }
        // 次期用チップ購入（保守的に1枚まで）
        if (gameState.currentPeriod >= 3 && analysis.periodsRemaining >= 2) {
            if (company.nextPeriodChips.research < 1 && company.cash >= chipCost + safetyMargin + 80) {
                company.cash -= chipCost;
                company.nextPeriodChips.research++;
                incrementRow(gameState.companies.indexOf(company));
                showAIActionModal(company, 'チップ購入(次期)', '🔬', '次期用研究チップ購入');
                return;
            }
        }
    }

    // Do Nothing（行数を増やさない - 保守的判断）
    nextTurn();
}

// D社：価格競争戦略（量でMQ確保・長期志向）
function executePriceFocusedStrategy(company, mfgCapacity, salesCapacity, analysis) {
    // 大量生産・大量販売でMQを確保（5期終了時自己資本最大化）
    const periodEndCost = calculatePeriodPayment(company);
    const safetyMargin = periodEndCost + 30;
    const chipCost = gameState.currentPeriod === 2 ? 20 : 40;

    // === 5期（最終期）は売り切り優先 ===
    if (analysis.isFinalPeriod) {
        if (company.products > 0 && salesCapacity > 0) {
            executeDefaultSale(company, salesCapacity, 0.65);
            return;
        }
        if ((company.materials > 0 || company.wip > 0) && mfgCapacity > 0) {
            executeDefaultProduction(company, mfgCapacity);
            return;
        }
        nextTurn();
        return;
    }

    // === 4期後半は回収フェーズ ===
    if (analysis.isRecoveryPhase && company.products > 0 && salesCapacity > 0) {
        executeDefaultSale(company, salesCapacity, 0.67);
        return;
    }

    // 1. 大量販売（低価格でも量で勝負、7割以上）
    const minSellQty = Math.ceil(salesCapacity * 0.7);
    if (company.products >= minSellQty && salesCapacity > 0) {
        executeDefaultSale(company, salesCapacity, 0.65);  // 積極的な低価格
        return;
    }

    // 2. 大量生産
    if ((company.materials > 0 || company.wip > 0) && mfgCapacity > 0) {
        executeDefaultProduction(company, mfgCapacity);
        return;
    }

    // 3. 大量材料購入（7割以上で）
    if (company.cash > safetyMargin + 40 && company.materials < mfgCapacity) {
        executeDefaultMaterialPurchase(company, mfgCapacity);
        return;
    }

    // 4. 長期投資（量を増やすための投資）
    if (company.cash > safetyMargin + 50 && analysis.rowsRemaining > 5 && !analysis.isRecoveryPhase) {
        // 研究チップ（価格競争力で量を確保）
        if (analysis.shouldInvestForFuture && company.chips.research < 3 && company.cash >= chipCost + safetyMargin) {
            company.cash -= chipCost;
            company.chips.research++;
            incrementRow(gameState.companies.indexOf(company));
            showAIActionModal(company, 'チップ購入', '🔬', '研究開発チップ購入（長期投資）');
            return;
        }

        // 能力バランス調整
        if (analysis.needsCapacityBalance && analysis.capacityBalance > 0) {
            if (company.chips.advertising < 3 && company.cash >= chipCost + safetyMargin) {
                company.cash -= chipCost;
                company.chips.advertising++;
                incrementRow(gameState.companies.indexOf(company));
                showAIActionModal(company, 'チップ購入', '📢', '広告チップ購入');
                return;
            }
        }

        // 次期用チップ購入
        if (gameState.currentPeriod >= 3 && analysis.periodsRemaining >= 2) {
            if (company.nextPeriodChips.research < 2 && company.cash >= chipCost + safetyMargin + 40) {
                company.cash -= chipCost;
                company.nextPeriodChips.research++;
                incrementRow(gameState.companies.indexOf(company));
                showAIActionModal(company, 'チップ購入(次期)', '🔬', '次期用研究チップ購入');
                return;
            }
        }
    }

    // 何もしなかった場合はDo Nothing
    nextTurn();
}

// E社：技術重視戦略（能力向上でMQ最大化・長期志向）
function executeTechFocusedStrategy(company, mfgCapacity, salesCapacity, analysis) {
    // 技術投資で効率を上げてMQを最大化（5期終了時自己資本最大化）
    const periodEndCost = calculatePeriodPayment(company);
    const safetyMargin = periodEndCost + 40;
    const chipCost = gameState.currentPeriod === 2 ? 20 : 40;

    // === 5期（最終期）は売り切り優先 ===
    if (analysis.isFinalPeriod) {
        if (company.products > 0 && salesCapacity > 0) {
            executeDefaultSale(company, salesCapacity, 0.80);
            return;
        }
        if ((company.materials > 0 || company.wip > 0) && mfgCapacity > 0) {
            executeDefaultProduction(company, mfgCapacity);
            return;
        }
        nextTurn();
        return;
    }

    // === 4期後半は回収フェーズ ===
    if (analysis.isRecoveryPhase && company.products > 0 && salesCapacity > 0) {
        executeDefaultSale(company, salesCapacity, 0.78);
        return;
    }

    // 1. 高効率販売（7割以上で）
    const minSellQty = Math.ceil(salesCapacity * 0.7);
    if (company.products >= minSellQty && salesCapacity > 0) {
        executeDefaultSale(company, salesCapacity, 0.80);  // 研究チップで勝負
        return;
    }

    // 2. 効率的生産
    if ((company.materials > 0 || company.wip > 0) && mfgCapacity > 0) {
        executeDefaultProduction(company, mfgCapacity);
        return;
    }

    // 3. 長期技術投資（残り期数を考慮）
    if (company.cash > safetyMargin + chipCost && analysis.rowsRemaining > 5 && !analysis.isRecoveryPhase) {
        // 研究チップ優先（長期的に価格競争力向上）
        if (analysis.shouldInvestForFuture && company.chips.research < 5 && company.cash >= chipCost + safetyMargin) {
            company.cash -= chipCost;
            company.chips.research++;
            incrementRow(gameState.companies.indexOf(company));
            showAIActionModal(company, 'チップ購入', '🔬', '研究開発チップ購入（長期投資）');
            return;
        }

        // 教育チップ（製造・販売能力+1、上限確認）
        const maxEducation = gameState.currentPeriod === 2 ? 2 : 1;
        if (company.chips.education < maxEducation && company.cash >= chipCost + safetyMargin) {
            company.cash -= chipCost;
            company.chips.education++;
            incrementRow(gameState.companies.indexOf(company));
            showAIActionModal(company, 'チップ購入', '📚', '教育チップ購入（能力+1）');
            return;
        }

        // コンピュータチップ（製造能力+1）
        if (!company.chips.computer && company.cash >= chipCost + safetyMargin) {
            company.cash -= chipCost;
            company.chips.computer = 1;
            incrementRow(gameState.companies.indexOf(company));
            showAIActionModal(company, 'チップ購入', '💻', 'コンピュータチップ購入（製造能力+1）');
            return;
        }

        // 次期用チップ購入（積極的に）
        if (gameState.currentPeriod >= 3 && analysis.periodsRemaining >= 2) {
            if (company.nextPeriodChips.research < 3 && company.cash >= chipCost + safetyMargin + 30) {
                company.cash -= chipCost;
                company.nextPeriodChips.research++;
                incrementRow(gameState.companies.indexOf(company));
                showAIActionModal(company, 'チップ購入(次期)', '🔬', '次期用研究チップ購入');
                return;
            }
        }
    }

    // 4. 材料購入（7割以上で）
    if (company.cash > safetyMargin + 40 && company.materials < mfgCapacity) {
        executeDefaultMaterialPurchase(company, mfgCapacity);
        return;
    }

    // 通常の投資戦略へ
    executeDefaultInvestment(company);
}

// B社・デフォルト：バランス戦略（長期的自己資本最大化志向）
function executeBalancedStrategy(company, mfgCapacity, salesCapacity, analysis) {
    // バランス良くMQを増やしつつ、5期終了時の自己資本最大化を目指す
    const periodEndCost = calculatePeriodPayment(company);
    const safetyMargin = periodEndCost + 35;
    const chipCost = gameState.currentPeriod === 2 ? 20 : 40;

    // === 5期（最終期）は売り切り優先 ===
    if (analysis.isFinalPeriod) {
        if (company.products > 0 && salesCapacity > 0) {
            executeDefaultSale(company, salesCapacity, 0.80);
            return;
        }
        if ((company.materials > 0 || company.wip > 0) && mfgCapacity > 0) {
            executeDefaultProduction(company, mfgCapacity);
            return;
        }
        nextTurn();
        return;
    }

    // === 4期後半は回収フェーズ ===
    if (analysis.isRecoveryPhase) {
        if (company.products > 0 && salesCapacity > 0) {
            executeDefaultSale(company, salesCapacity, 0.78);
            return;
        }
    }

    // 1. 販売機会を逃さない（7割以上で）
    const minSellQty = Math.ceil(salesCapacity * 0.7);
    if (company.products >= minSellQty && salesCapacity > 0) {
        executeDefaultSale(company, salesCapacity, 0.75);
        return;
    }

    // 2. 効率的生産
    if ((company.materials > 0 || company.wip > 0) && mfgCapacity > 0) {
        executeDefaultProduction(company, mfgCapacity);
        return;
    }

    // 3. 材料確保（7割以上で）
    if (company.cash > safetyMargin + 40 && company.materials < mfgCapacity) {
        executeDefaultMaterialPurchase(company, mfgCapacity);
        return;
    }

    // 4. 長期戦略的投資（残り期数を考慮）
    if (company.cash > safetyMargin + chipCost && analysis.rowsRemaining > 6 && !analysis.isRecoveryPhase) {
        // 研究チップ優先（価格競争力は長期的にMQ増加に直結）
        if (analysis.shouldInvestForFuture && company.chips.research < 4 && company.cash >= chipCost + safetyMargin) {
            company.cash -= chipCost;
            company.chips.research++;
            incrementRow(gameState.companies.indexOf(company));
            showAIActionModal(company, 'チップ購入', '🔬', '研究開発チップ購入（長期投資）');
            return;
        }

        // 能力バランス調整（製造=販売が理想）
        if (analysis.needsCapacityBalance) {
            if (analysis.capacityBalance > 0 && company.chips.advertising < 2 && company.cash >= chipCost + safetyMargin) {
                // 製造 > 販売 → 広告チップで販売力強化
                company.cash -= chipCost;
                company.chips.advertising++;
                incrementRow(gameState.companies.indexOf(company));
                showAIActionModal(company, 'チップ購入', '📢', '広告チップ購入（能力バランス）');
                return;
            }
        }

        // 次期用チップ購入（3期以降、余裕があれば）
        if (gameState.currentPeriod >= 3 && analysis.periodsRemaining >= 2) {
            if (company.nextPeriodChips.research < 2 && company.cash >= chipCost + safetyMargin + 50) {
                company.cash -= chipCost;
                company.nextPeriodChips.research++;
                incrementRow(gameState.companies.indexOf(company));
                showAIActionModal(company, 'チップ購入(次期)', '🔬', '次期用研究チップ購入');
                return;
            }
        }
    }

    // 何もしなかった場合はDo Nothing
    nextTurn();
}

// F社：予測不能戦略（ランダムだが長期志向）
function executeUnpredictableStrategy(company, mfgCapacity, salesCapacity, analysis) {
    // ランダムだが5期終了時の自己資本最大化を意識
    const periodEndCost = calculatePeriodPayment(company);
    const safetyMargin = periodEndCost + 20;
    const chipCost = gameState.currentPeriod === 2 ? 20 : 40;

    // === 5期（最終期）は売り切り優先 ===
    if (analysis.isFinalPeriod) {
        if (company.products > 0 && salesCapacity > 0) {
            const priceBase = 0.70 + Math.random() * 0.15;
            executeDefaultSale(company, salesCapacity, priceBase);
            return;
        }
        if ((company.materials > 0 || company.wip > 0) && mfgCapacity > 0) {
            executeDefaultProduction(company, mfgCapacity);
            return;
        }
        nextTurn();
        return;
    }

    // === 4期後半は回収フェーズ ===
    if (analysis.isRecoveryPhase && company.products > 0 && salesCapacity > 0) {
        const priceBase = 0.68 + Math.random() * 0.12;
        executeDefaultSale(company, salesCapacity, priceBase);
        return;
    }

    const actions = [];

    // 可能なアクションをリストアップ（合理的な条件で）
    const minSellQty = Math.ceil(salesCapacity * 0.7);
    if (company.products >= minSellQty && salesCapacity > 0) {
        actions.push('sell');  // 販売
    }
    if ((company.materials > 0 || company.wip > 0) && mfgCapacity > 0) {
        actions.push('produce');  // 生産
    }
    if (company.cash > safetyMargin + 40 && company.materials < mfgCapacity) {
        actions.push('buy_materials');  // 材料購入
    }
    if (company.cash > safetyMargin + chipCost && analysis.rowsRemaining > 5 && !analysis.isRecoveryPhase) {
        actions.push('buy_chip');  // チップ購入（長期投資）
    }
    // 常にDo Nothingは選択可能
    actions.push('do_nothing');

    // ランダムに行動を選択
    const action = actions[Math.floor(Math.random() * actions.length)];

    switch(action) {
        case 'sell':
            // ランダムな価格で販売（0.65〜0.85の範囲）
            const priceBase = 0.65 + Math.random() * 0.2;
            executeDefaultSale(company, salesCapacity, priceBase);
            return;

        case 'produce':
            // 生産実行
            executeDefaultProduction(company, mfgCapacity);
            return;

        case 'buy_materials':
            // 材料購入
            executeDefaultMaterialPurchase(company, mfgCapacity);
            return;

        case 'buy_chip':
            // ランダムなチップを購入（研究チップ優先）
            const chipTypes = ['research', 'research', 'advertising'];  // 研究チップ確率高め
            const chipType = chipTypes[Math.floor(Math.random() * chipTypes.length)];
            if (chipType === 'research' && company.chips.research < 4) {
                company.cash -= chipCost;
                company.chips.research++;
                incrementRow(gameState.companies.indexOf(company));
                showAIActionModal(company, 'チップ購入', '🔬', '研究開発チップ購入');
            } else if (company.chips.advertising < 3) {
                company.cash -= chipCost;
                company.chips.advertising++;
                incrementRow(gameState.companies.indexOf(company));
                showAIActionModal(company, 'チップ購入', '📢', '広告チップ購入');
            } else {
                nextTurn();
            }
            return;

        case 'do_nothing':
        default:
            // 意図的に何もしない
            incrementRow(gameState.companies.indexOf(company));
            showAIActionModal(company, 'DO NOTHING', '⏭️', '様子見');
            return;
    }
}

// 共通関数：販売実行
function executeDefaultSale(company, salesCapacity, priceBase) {
    // 販売能力の7割以上を売る（例：能力10なら7〜10個）
    const minSellQty = Math.ceil(salesCapacity * 0.7);  // 最低7割
    const targetSellQty = salesCapacity;  // なるべく限界まで
    const sellQty = Math.min(targetSellQty, company.products);

    // 7割に満たない場合は販売しない（行の無駄遣い防止）
    if (sellQty < minSellQty || sellQty < 2) {
        if (company.materials > 0 || company.wip > 0) {
            // 代わりに生産を試みる
            const mfgCapacity = getManufacturingCapacity(company);
            executeDefaultProduction(company, mfgCapacity);
            return;
        }
        incrementRow(gameState.companies.indexOf(company));
        showAIActionModal(company, 'DO NOTHING', '⏭️', '販売能力の7割に満たないため見送り');
        return;
    }

    // 高価格市場を優先（入札市場も含む）
    const availableMarkets = gameState.markets
        .filter(m => m.currentStock < m.maxStock && !m.closed && (gameState.currentPeriod > 2 || m.name !== '海外'))
        .sort((a, b) => b.sellPrice - a.sellPrice);

    if (availableMarkets.length > 0) {
        const market = availableMarkets[0];
        const actualQty = Math.min(sellQty, market.maxStock - market.currentStock);

        if (actualQty > 0) {
            if (!market.needsBid) {
                // 即売市場
                const revenue = market.sellPrice * actualQty;
                company.cash += revenue;
                company.products -= actualQty;
                company.totalSales += revenue;
                company.totalSoldQuantity = (company.totalSoldQuantity || 0) + actualQty;
                market.currentStock += actualQty;

                incrementRow(gameState.companies.indexOf(company));
                showAIActionModal(company, '商品販売', '💰', `${market.name}に${actualQty}個販売`, [
                    { label: '販売価格', value: `¥${market.sellPrice}/個` },
                    { label: '売上', value: `¥${revenue}`, highlight: true }
                ]);
                return;
            } else {
                // 入札市場：AIが親として入札を開始、プレイヤーと他AIも参加
                startAIBidding(company, market, actualQty, priceBase);
                return;
            }
        }
    }

    incrementRow(gameState.companies.indexOf(company));
    showAIActionModal(company, 'DO NOTHING', '⏭️', '販売できる市場がありません');
}

// AIが親として入札を開始
function startAIBidding(parentCompany, market, parentQty, priceBase) {
    const marketIndex = gameState.markets.indexOf(market);
    const parentIndex = gameState.companies.indexOf(parentCompany);

    // 親AIの入札価格を決定
    const parentPrice = Math.floor(market.sellPrice * priceBase);
    const parentCompetitiveness = getPriceCompetitiveness(parentCompany, true);
    const parentEffectivePrice = parentPrice - parentCompetitiveness;

    // 親の入札情報を保存
    gameState.aiBidding = {
        market: market,
        marketIndex: marketIndex,
        parentCompany: parentIndex,
        parentQty: parentQty,
        parentPrice: parentPrice,
        parentEffectivePrice: parentEffectivePrice
    };

    // プレイヤーに入札参加を確認
    const player = gameState.companies[0];
    const playerSalesCapacity = getSalesCapacity(player);
    const playerMaxQty = Math.min(playerSalesCapacity, player.products);

    if (playerMaxQty > 0) {
        // プレイヤーも入札可能
        showPlayerBidInAIAuction(parentCompany, market, parentQty, parentPrice, playerMaxQty);
    } else {
        // プレイヤーは参加不可、AI同士で入札
        processAIOnlyBidding();
    }
}

// プレイヤーにAI開始の入札への参加を確認
function showPlayerBidInAIAuction(parentCompany, market, parentQty, parentPrice, playerMaxQty) {
    const player = gameState.companies[0];
    const competitiveness = getPriceCompetitiveness(player, false);

    const defaultBidPrice = Math.floor(market.sellPrice * 0.85);  // プレイヤーのデフォルト入札価格

    const content = `
        <div style="text-align: center; padding: 15px;">
            <div style="background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%); color: white; padding: 15px; border-radius: 12px; margin-bottom: 15px;">
                <div style="font-size: 16px; font-weight: bold;">⚔️ ${parentCompany.name}が入札を開始！</div>
                <div style="font-size: 14px; margin-top: 8px;">市場: ${market.name}（上限価格: ¥${market.sellPrice}）</div>
                <div style="font-size: 14px;">販売希望: ${parentQty}個（入札価格は非公開）</div>
            </div>

            <div style="background: #fef3c7; border-radius: 8px; padding: 10px; margin-bottom: 15px;">
                <div style="font-weight: bold; color: #92400e;">💰 あなたの現金: ¥${player.cash} / 製品: ${player.products}個</div>
            </div>

            <p style="margin-bottom: 15px;">入札に参加しますか？</p>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 15px;">
                <div>
                    <label style="font-size: 12px;">📦 販売数量</label>
                    <select id="playerBidQty" class="form-control" style="font-size: 16px; text-align: center;">
                        ${Array(playerMaxQty).fill(0).map((_, i) =>
                            `<option value="${i+1}">${i+1}個</option>`
                        ).join('')}
                    </select>
                </div>
                <div>
                    <label style="font-size: 12px;">💵 入札価格 (競争力: -¥${competitiveness})</label>
                    <input type="number" id="playerBidPrice" class="form-control" min="1" max="${market.sellPrice}" value="${defaultBidPrice}" style="font-size: 16px; text-align: center;">
                </div>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <button class="action-btn primary" onclick="submitPlayerBidInAIAuction()">入札に参加</button>
                <button class="action-btn secondary" onclick="skipPlayerBidInAIAuction()">参加しない</button>
            </div>
        </div>
    `;

    showModal('入札参加確認', content);
}

// プレイヤーがAI入札に参加
function submitPlayerBidInAIAuction() {
    const player = gameState.companies[0];
    const bidQty = parseInt(document.getElementById('playerBidQty').value);
    const bidPrice = parseInt(document.getElementById('playerBidPrice').value);
    const competitiveness = getPriceCompetitiveness(player, false);

    gameState.aiBidding.playerBid = {
        company: 0,
        quantity: bidQty,
        price: bidPrice - competitiveness,
        displayPrice: bidPrice
    };

    closeModal();
    processAIBiddingWithPlayer();
}

// プレイヤーがAI入札をスキップ
function skipPlayerBidInAIAuction() {
    gameState.aiBidding.playerBid = null;
    closeModal();
    processAIBiddingWithPlayer();
}

// AI入札を処理（プレイヤー参加/不参加どちらも）
function processAIBiddingWithPlayer() {
    const bidInfo = gameState.aiBidding;
    const market = bidInfo.market;
    const allBids = [];

    // 親AIの入札
    allBids.push({
        company: bidInfo.parentCompany,
        quantity: bidInfo.parentQty,
        price: bidInfo.parentEffectivePrice,
        displayPrice: bidInfo.parentPrice
    });

    // プレイヤーの入札（参加した場合）
    if (bidInfo.playerBid) {
        allBids.push(bidInfo.playerBid);
    }

    // 他のAIも積極的に入札（製品があれば必ず参加）
    for (let i = 1; i < gameState.companies.length; i++) {
        if (i === bidInfo.parentCompany) continue; // 親AIはスキップ

        const aiCompany = gameState.companies[i];
        if (aiCompany.products >= 2) {  // 2個以上あれば入札
            const aiSalesCapacity = getSalesCapacity(aiCompany);
            const aiQuantity = Math.min(aiSalesCapacity, aiCompany.products);
            if (aiQuantity >= 2) {
                // AIの性格に応じて入札価格を決定
                let priceMultiplier = 0.8;  // デフォルト80%
                if (aiCompany.strategy === 'aggressive') priceMultiplier = 0.7;
                else if (aiCompany.strategy === 'price_focused') priceMultiplier = 0.75;
                else if (aiCompany.strategy === 'conservative') priceMultiplier = 0.85;

                const aiDisplayPrice = Math.floor(market.sellPrice * (priceMultiplier + Math.random() * 0.1));
                const aiCompetitiveness = getPriceCompetitiveness(aiCompany, false);
                const aiPrice = aiDisplayPrice - aiCompetitiveness;
                allBids.push({
                    company: i,
                    quantity: aiQuantity,
                    price: aiPrice,
                    displayPrice: aiDisplayPrice
                });
            }
        }
    }

    // 入札結果を処理（販売上限は親の数量）
    processAIBidsResult(bidInfo.parentQty, market, allBids);
}

// AI入札のみ（プレイヤー参加不可の場合）
function processAIOnlyBidding() {
    const bidInfo = gameState.aiBidding;
    const market = bidInfo.market;
    const allBids = [];

    // 親AIの入札
    allBids.push({
        company: bidInfo.parentCompany,
        quantity: bidInfo.parentQty,
        price: bidInfo.parentEffectivePrice,
        displayPrice: bidInfo.parentPrice
    });

    // 他のAIも積極的に入札（製品があれば必ず参加）
    for (let i = 1; i < gameState.companies.length; i++) {
        if (i === bidInfo.parentCompany) continue;

        const aiCompany = gameState.companies[i];
        if (aiCompany.products >= 2) {
            const aiSalesCapacity = getSalesCapacity(aiCompany);
            const aiQuantity = Math.min(aiSalesCapacity, aiCompany.products);
            if (aiQuantity >= 2) {
                // AIの性格に応じて入札価格を決定
                let priceMultiplier = 0.8;
                if (aiCompany.strategy === 'aggressive') priceMultiplier = 0.7;
                else if (aiCompany.strategy === 'price_focused') priceMultiplier = 0.75;
                else if (aiCompany.strategy === 'conservative') priceMultiplier = 0.85;

                const aiDisplayPrice = Math.floor(market.sellPrice * (priceMultiplier + Math.random() * 0.1));
                const aiCompetitiveness = getPriceCompetitiveness(aiCompany, false);
                const aiPrice = aiDisplayPrice - aiCompetitiveness;
                allBids.push({
                    company: i,
                    quantity: aiQuantity,
                    price: aiPrice,
                    displayPrice: aiDisplayPrice
                });
            }
        }
    }

    processAIBidsResult(bidInfo.parentQty, market, allBids);
}

// AI入札結果を処理
function processAIBidsResult(maxSales, market, allBids) {
    // 価格でソート（低い順=有利）
    allBids.sort((a, b) => {
        if (a.price !== b.price) return a.price - b.price;
        const aResearch = gameState.companies[a.company].chips.research || 0;
        const bResearch = gameState.companies[b.company].chips.research || 0;
        if (aResearch !== bResearch) return bResearch - aResearch;
        const aIsParent = (a.company === gameState.aiBidding.parentCompany);
        const bIsParent = (b.company === gameState.aiBidding.parentCompany);
        if (aIsParent && !bIsParent) return -1;
        if (!aIsParent && bIsParent) return 1;
        return 0;
    });

    // 販売上限は親の数量
    let remainingCapacity = maxSales;
    let salesResults = [];

    for (const bid of allBids) {
        if (remainingCapacity <= 0) break;

        const bidCompany = gameState.companies[bid.company];
        const actualQty = Math.min(bid.quantity, remainingCapacity, bidCompany.products);

        if (actualQty > 0) {
            const salePrice = bid.displayPrice || bid.price;
            bidCompany.cash += salePrice * actualQty;
            bidCompany.products -= actualQty;
            bidCompany.totalSales += salePrice * actualQty;
            bidCompany.totalSoldQuantity = (bidCompany.totalSoldQuantity || 0) + actualQty;
            market.currentStock += actualQty;
            remainingCapacity -= actualQty;

            salesResults.push({
                company: bidCompany,
                companyIndex: bid.company,
                quantity: actualQty,
                price: salePrice
            });
        }
    }

    // 親AIの行数を消費
    incrementRow(gameState.aiBidding.parentCompany);

    // 結果表示
    showAIBiddingResultModal(market, salesResults);
}

// AI入札結果モーダル
function showAIBiddingResultModal(market, salesResults) {
    let resultHtml = salesResults.map(r => `
        <div style="display: flex; justify-content: space-between; padding: 8px; background: ${r.companyIndex === 0 ? '#dcfce7' : '#f1f5f9'}; border-radius: 6px; margin-bottom: 5px;">
            <span style="font-weight: bold;">${r.company.name}</span>
            <span>${r.quantity}個 × ¥${r.price} = ¥${r.quantity * r.price}</span>
        </div>
    `).join('');

    if (salesResults.length === 0) {
        resultHtml = '<p style="text-align: center; color: #666;">売れた会社はありません</p>';
    }

    const content = `
        <div style="padding: 15px;">
            <div style="background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%); color: white; padding: 15px; border-radius: 12px; margin-bottom: 15px; text-align: center;">
                <div style="font-size: 16px; font-weight: bold;">⚔️ 入札結果</div>
                <div style="font-size: 14px; margin-top: 5px;">市場: ${market.name}</div>
            </div>

            <div style="margin-bottom: 15px;">
                ${resultHtml}
            </div>

            <button class="action-btn primary" onclick="closeAIBiddingResult()" style="width: 100%;">確認</button>
        </div>
    `;

    showModal('入札結果', content);
}

// AI入札結果を閉じる
function closeAIBiddingResult() {
    gameState.aiBidding = null;
    closeModal();
    nextTurn();
}

// 共通関数：材料購入
function executeDefaultMaterialPurchase(company, targetQty) {
    // 3期以降は製造能力の7割以上を購入（例：能力10なら7〜10個）
    const mfgCapacity = getManufacturingCapacity(company);
    const minBuyQty = gameState.currentPeriod >= 3 ? Math.ceil(mfgCapacity * 0.7) : 2;
    const actualTargetQty = gameState.currentPeriod >= 3 ? mfgCapacity : targetQty;

    const availableMarkets = gameState.markets.filter(m => m.currentStock > 0 && !m.closed)
        .sort((a, b) => a.buyPrice - b.buyPrice);

    if (availableMarkets.length > 0) {
        const market = availableMarkets[0];
        const buyQty = Math.min(actualTargetQty, market.currentStock, Math.floor(company.cash / market.buyPrice));

        // 7割に満たない場合は購入しない（行の無駄遣い防止）
        if (buyQty >= minBuyQty && buyQty >= 2) {
            const cost = market.buyPrice * buyQty;
            company.cash -= cost;
            company.materials += buyQty;
            company.totalMaterialCost += cost;
            market.currentStock -= buyQty;

            incrementRow(gameState.companies.indexOf(company));
            showAIActionModal(company, '材料仕入', '📦', `${market.name}から${buyQty}個購入`, [
                { label: '仕入価格', value: `¥${market.buyPrice}/個` },
                { label: '支払', value: `¥${cost}` }
            ]);
            return;
        }
    }

    // 7割以上買えない場合は生産を試みる
    if (company.materials > 0 || company.wip > 0) {
        executeDefaultProduction(company, mfgCapacity);
        return;
    }

    incrementRow(gameState.companies.indexOf(company));
    showAIActionModal(company, 'DO NOTHING', '⏭️', '製造能力の7割に満たないため見送り');
}

// 共通関数：生産実行
function executeDefaultProduction(company, maxQty) {
    const produceQty = Math.min(maxQty, company.materials);
    const wipToProduct = Math.min(maxQty, company.wip);
    const cost = produceQty + wipToProduct;

    if (company.cash >= cost && (produceQty > 0 || wipToProduct > 0)) {
        company.cash -= cost;
        company.materials -= produceQty;
        company.wip += produceQty - wipToProduct;
        company.products += wipToProduct;
        company.totalProductionCost += cost;

        let detail = '';
        if (produceQty > 0) detail += `材料→仕掛品: ${produceQty}個`;
        if (wipToProduct > 0) detail += `${produceQty > 0 ? '、' : ''}仕掛品→製品: ${wipToProduct}個`;

        incrementRow(gameState.companies.indexOf(company));
        showAIActionModal(company, '完成・投入', '🏭', detail, [
            { label: '加工費', value: `¥${cost}` }
        ]);
        return;
    }

    incrementRow(gameState.companies.indexOf(company));
    showAIActionModal(company, 'DO NOTHING', '⏭️', '生産できません');
}

// 共通関数：投資実行（G最大化・自己資本最大化志向）
function executeDefaultInvestment(company) {
    const mfgCapacity = getManufacturingCapacity(company);
    const salesCapacity = getSalesCapacity(company);
    const chipCost = gameState.currentPeriod === 2 ? 20 : 40;
    const rowsRemaining = gameState.maxRows - (company.currentRow || 1);

    // 期末近くは投資しない（資金を確保）
    if (rowsRemaining < 5) {
        nextTurn();
        return;
    }

    // 必要な余裕資金（期末支払い+αを確保）
    const periodEndCost = calculatePeriodPayment(company);
    const safetyMargin = periodEndCost + 30;
    if (company.cash <= safetyMargin) {
        nextTurn();
        return;
    }

    // === 戦略的投資判断 ===

    // 1. 研究チップ（価格競争力向上→MQ増加に直結）
    if (company.chips.research < 4 && company.cash >= chipCost + safetyMargin) {
        // 入札市場での勝率向上はGに直接貢献
        company.cash -= chipCost;
        company.chips.research++;
        incrementRow(gameState.companies.indexOf(company));
        showAIActionModal(company, 'チップ購入', '🔬', '研究開発チップ購入（価格競争力+2）');
        return;
    }

    // 2. 能力バランス調整（ボトルネック解消のみ）
    // 製造能力 < 販売能力 → ワーカー or 機械が必要
    const needMoreMfg = mfgCapacity < salesCapacity && mfgCapacity < 6;
    // 販売能力 < 製造能力 → セールスマンが必要
    const needMoreSales = salesCapacity < mfgCapacity && salesCapacity < 6;

    // ワーカー採用（製造能力がボトルネックの場合のみ）
    if (needMoreMfg && company.workers < 3 && company.cash >= 5 + safetyMargin) {
        // 機械能力も確認（ワーカーが増えても機械能力がなければ無意味）
        const machineCapacity = company.machines.reduce((sum, m) => {
            if (m.type === 'small') return sum + (m.attachments > 0 ? 2 : 1);
            return sum + 4;
        }, 0) + (company.chips.computer || 0);

        if (company.workers < machineCapacity) {
            company.cash -= 5;
            company.workers++;
            company.extraLaborCost = (company.extraLaborCost || 0) + 5;
            incrementRow(gameState.companies.indexOf(company));
            showAIActionModal(company, '採用', '👷', 'ワーカー採用（製造能力向上）');
            return;
        }
    }

    // セールスマン採用（販売能力がボトルネックの場合のみ）
    if (needMoreSales && company.salesmen < 3 && company.cash >= 5 + safetyMargin) {
        company.cash -= 5;
        company.salesmen++;
        company.extraLaborCost = (company.extraLaborCost || 0) + 5;
        incrementRow(gameState.companies.indexOf(company));
        showAIActionModal(company, '採用', '💼', 'セールスマン採用（販売能力向上）');
        return;
    }

    // 3. 広告チップ（販売能力がボトルネックの場合）
    if (needMoreSales && company.chips.advertising < 3 && company.cash >= chipCost + safetyMargin) {
        company.cash -= chipCost;
        company.chips.advertising++;
        incrementRow(gameState.companies.indexOf(company));
        showAIActionModal(company, 'チップ購入', '📢', '広告チップ購入（販売能力向上）');
        return;
    }

    // 4. 機械投資（製造能力がボトルネック、かつワーカー能力に余裕がある場合のみ）
    const workerCapacity = company.workers + (company.chips.education || 0);
    if (needMoreMfg && company.machines.length < 2 && workerCapacity > mfgCapacity && company.cash >= 50 + safetyMargin) {
        company.cash -= 50;
        company.machines.push({type: 'small', attachments: 0});
        incrementRow(gameState.companies.indexOf(company));
        showAIActionModal(company, '設備投資', '⚙️', '小型機械購入（製造能力向上）');
        return;
    }

    // 何もしなかった場合はDo Nothing
    nextTurn();
}

// End period
function endPeriod() {
    showToast('期末決算を開始します', 'info', 3000);
    
    // 期末時点の人数・機械台数を記録
    gameState.companies.forEach(company => {
        company.endOfPeriodStats = {
            workers: company.workers,
            salesmen: company.salesmen,
            machines: company.machines.length
        };
    });
    
    // Calculate financial metrics for all companies
    const financialData = [];
    
    gameState.companies.forEach(company => {
        // Calculate PQ, VQ, MQ, G
        const pq = company.totalSales;
        const vq = calculateVQ(company);
        const mq = pq - vq;
        const fixedCosts = calculateFixedCost(company);
        const g = mq - fixedCosts - (company.specialLoss || 0);
        
        // Q = 販売個数（期中の総販売数量）
        const q = company.totalSoldQuantity || 0;
        
        // Calculate unit prices (P=PQ/Q, V=VQ/Q, M=MQ/Q) with rounding to 1 decimal place
        // すべてQで割る（販売数量ベースの単価）
        const unitP = q > 0 ? Math.round(pq / q * 10) / 10 : 0;  // P = PQ ÷ Q
        const unitV = q > 0 ? Math.round(vq / q * 10) / 10 : 0;  // V = VQ ÷ Q
        const unitM = q > 0 ? Math.round(mq / q * 10) / 10 : 0;  // M = MQ ÷ Q
        
        financialData.push({
            name: company.name,
            p: unitP,  // P=PQ/Q (単価)
            v: unitV,  // V=VQ/Q (単価)
            m: unitM,  // M=MQ/Q (単価)
            q: q,
            pq: pq,
            vq: vq,
            mq: mq,
            f: fixedCosts,
            g: g
        });
        
        // Calculate tax and dividend if equity exceeds ¥300
        let tax = 0;
        let dividend = 0;
        const previousEquity = company.equity;
        const newEquity = previousEquity + g;

        if (newEquity > 300) {
            if (!company.hasExceeded300) {
                // 初めて¥300を超えた場合
                const excess = newEquity - 300;
                tax = Math.round(excess * 0.5);  // 超過分の50%
                dividend = Math.round(excess * 0.2);  // 超過分の20%
                company.hasExceeded300 = true;
            } else {
                // 既に¥300を超えていた場合（利益がある場合のみ）
                if (g > 0) {
                    tax = Math.round(g * 0.5);  // 利益の50%
                    dividend = Math.round(g * 0.1);  // 利益の10%
                }
            }
        }

        company.pendingTax = tax;
        company.pendingDividend = dividend;

        // Update equity (税金は自己資本から引く)
        company.equity = newEquity - tax;
        
        // Pay period-end costs (using end-of-period stats)
        const periodPayment = calculatePeriodPayment(company, true);
        company.cash -= periodPayment;
        
        // Apply short-term loan if cash is negative
        if (company.cash < 0) {
            const needed = Math.ceil(Math.abs(company.cash) / 0.8 / 50) * 50;
            company.shortLoans += needed;
            company.cash += needed * 0.8;  // 短期借入: 借入時20%金利控除
        }
        
        // Handle chip returns
        if (gameState.currentPeriod === 2) {
            // 2期末：コンピュータ・保険は返却、研究・広告は最大3枚まで持ち越し
            const maxCarryOver = 3;
            const totalResearch = company.chips.research + company.nextPeriodChips.research;
            const totalAdvertising = company.chips.advertising + company.nextPeriodChips.advertising;
            const totalEducation = company.chips.education + company.nextPeriodChips.education;

            // 3枚を超える場合は警告
            if (totalResearch > maxCarryOver && company.type === 'player') {
                alert(`研究チップが${totalResearch}枚ありますが、3枚までしか持ち越せません。`);
            }
            if (totalAdvertising > maxCarryOver && company.type === 'player') {
                alert(`広告チップが${totalAdvertising}枚ありますが、3枚までしか持ち越せません。`);
            }

            // 次期チップ設定（2期→3期は全チップ1枚減って繰り越し、最大3枚まで）
            const newResearch = Math.max(0, Math.min(totalResearch, maxCarryOver) - 1);
            const newEducation = Math.max(0, Math.min(totalEducation, maxCarryOver) - 1);
            const newAdvertising = Math.max(0, Math.min(totalAdvertising, maxCarryOver) - 1);

            company.chips.computer = 0;  // 返却
            company.chips.insurance = 0; // 返却
            company.chips.research = newResearch;
            company.chips.education = newEducation;
            company.chips.advertising = newAdvertising;
            company.nextPeriodChips = {research: 0, education: 0, advertising: 0};

            // 繰り越しチップを記録（3期のF計算で20円/枚として使用）
            company.carriedOverChips = {
                research: newResearch,
                education: newEducation,
                advertising: newAdvertising
            };
        } else {
            // 3-5期末：全チップ没収（繰越分は残る）
            const carryResearch = company.nextPeriodChips.research || 0;
            const carryEducation = company.nextPeriodChips.education || 0;
            const carryAdvertising = company.nextPeriodChips.advertising || 0;

            company.chips = {
                computer: 0,
                insurance: 0,
                research: carryResearch,
                education: carryEducation,
                advertising: carryAdvertising
            };
            company.nextPeriodChips = {research: 0, education: 0, advertising: 0};

            // 繰り越しチップを記録（次期のF計算で20円/枚として使用）
            company.carriedOverChips = {
                research: carryResearch,
                education: carryEducation,
                advertising: carryAdvertising
            };
        }
        
        // Update period start inventory
        company.periodStartInventory = {
            materials: company.materials,
            wip: company.wip,
            products: company.products
        };
        
        // Reset period tracking
        company.rowsUsed = 0;
        company.totalSales = 0;
        company.totalSoldQuantity = 0;
        company.totalMaterialCost = 0;
        company.totalProductionCost = 0;
        company.specialLoss = 0;
        company.extraLaborCost = 0;

        // 倉庫リセット（期末で消滅）
        company.warehouses = 0;
        company.warehouseLocation = 'materials';

        // Reset retirement and max personnel tracking for next period
        company.retiredWorkers = 0;
        company.retiredSalesmen = 0;
        company.maxPersonnel = company.workers + company.salesmen;  // 次期の初期値
    });
    
    // Store and show financial summary
    window.lastFinancialData = financialData;

    // 期末返済処理（AI会社は自動返済、プレイヤーは選択）
    processEndPeriodLoanRepayments(financialData);
}

// 期末返済処理
function processEndPeriodLoanRepayments(financialData) {
    // AI会社の自動返済処理
    gameState.companies.forEach(company => {
        if (company.type === 'ai') {
            processAutoLoanRepayment(company);
        }
    });

    // プレイヤー会社の返済UI表示
    const player = gameState.companies[0];
    if (player.shortLoans > 0 || player.loans > 0) {
        showLoanRepaymentModal(financialData);
    } else {
        // 借入がない場合は直接決算表示へ
        window.currentSettlementIndex = 0;
        showCompanySettlement(0, financialData);
    }
}

// AI会社の自動返済処理
function processAutoLoanRepayment(company) {
    // 短期借入: 最低20%返済
    if (company.shortLoans > 0) {
        const minShortPayment = Math.ceil(company.shortLoans * 0.2);
        const actualPayment = Math.min(minShortPayment, company.cash);

        if (actualPayment > 0) {
            company.cash -= actualPayment;
            company.shortLoans -= actualPayment;
        }

        // 資金不足で最低返済できない場合は短期借入で補填
        if (actualPayment < minShortPayment) {
            const shortfall = minShortPayment - actualPayment;
            const needed = Math.ceil(shortfall / 0.8 / 50) * 50;
            company.shortLoans += needed;
            company.cash += needed * 0.8;
            company.cash -= (minShortPayment - actualPayment);
            company.shortLoans -= (minShortPayment - actualPayment);
        }
    }

    // 長期借入: 最低10%返済
    if (company.loans > 0) {
        const minLongPayment = Math.ceil(company.loans * 0.1);
        const actualPayment = Math.min(minLongPayment, company.cash);

        if (actualPayment > 0) {
            company.cash -= actualPayment;
            company.loans -= actualPayment;
        }

        // 資金不足で最低返済できない場合は短期借入で補填
        if (actualPayment < minLongPayment) {
            const shortfall = minLongPayment - actualPayment;
            const needed = Math.ceil(shortfall / 0.8 / 50) * 50;
            company.shortLoans += needed;
            company.cash += needed * 0.8;
            company.cash -= (minLongPayment - actualPayment);
            company.loans -= (minLongPayment - actualPayment);
        }
    }
}

// プレイヤー返済UIモーダル
function showLoanRepaymentModal(financialData) {
    const player = gameState.companies[0];
    const minShortPayment = player.shortLoans > 0 ? Math.ceil(player.shortLoans * 0.2) : 0;
    const minLongPayment = player.loans > 0 ? Math.ceil(player.loans * 0.1) : 0;

    let shortOptions = '';
    if (player.shortLoans > 0) {
        shortOptions = `
            <div class="form-group">
                <label class="form-label">短期借入返済（残高: ¥${player.shortLoans}、最低20%: ¥${minShortPayment}）</label>
                <select id="shortRepayment" class="form-control">
                    <option value="${minShortPayment}">最低返済: ¥${minShortPayment}</option>
                    ${player.shortLoans <= player.cash ? `<option value="${player.shortLoans}">全額返済: ¥${player.shortLoans}</option>` : ''}
                </select>
            </div>
        `;
    }

    let longOptions = '';
    if (player.loans > 0) {
        longOptions = `
            <div class="form-group">
                <label class="form-label">長期借入返済（残高: ¥${player.loans}、最低10%: ¥${minLongPayment}）</label>
                <select id="longRepayment" class="form-control">
                    <option value="${minLongPayment}">最低返済: ¥${minLongPayment}</option>
                    ${player.loans <= player.cash ? `<option value="${player.loans}">全額返済: ¥${player.loans}</option>` : ''}
                </select>
            </div>
        `;
    }

    const content = `
        <div style="padding: 15px;">
            <div style="background: #fef3c7; border-radius: 8px; padding: 10px; margin-bottom: 15px;">
                <div style="font-weight: bold; color: #92400e;">💰 現在の現金: ¥${player.cash}</div>
            </div>
            ${shortOptions}
            ${longOptions}
            <button class="submit-btn" onclick="processPlayerLoanRepayment()">返済実行</button>
        </div>
    `;

    showModal('期末返済処理', content);
}

// プレイヤー返済処理
function processPlayerLoanRepayment() {
    const player = gameState.companies[0];

    const shortRepaymentEl = document.getElementById('shortRepayment');
    const longRepaymentEl = document.getElementById('longRepayment');

    const shortRepayment = shortRepaymentEl ? parseInt(shortRepaymentEl.value) : 0;
    const longRepayment = longRepaymentEl ? parseInt(longRepaymentEl.value) : 0;
    const totalRepayment = shortRepayment + longRepayment;

    // 資金不足の場合は短期借入
    if (player.cash < totalRepayment) {
        const needed = Math.ceil((totalRepayment - player.cash) / 0.8 / 50) * 50;
        player.shortLoans += needed;
        player.cash += needed * 0.8;
        alert(`資金不足のため¥${needed}を短期借入しました`);
    }

    // 返済処理
    player.cash -= totalRepayment;
    player.shortLoans -= shortRepayment;
    player.loans -= longRepayment;

    closeModal();

    // 決算表示へ
    window.currentSettlementIndex = 0;
    showCompanySettlement(0, window.lastFinancialData);
}

// End game
function endGame() {
    // 勝利条件チェック: 次期繰り越しチップ3枚以上 かつ 在庫合計10個以上
    const companiesWithConditions = gameState.companies.map(company => {
        const nextChips = (company.nextPeriodChips?.research || 0) +
                         (company.nextPeriodChips?.education || 0) +
                         (company.nextPeriodChips?.advertising || 0);
        const inventory = company.materials + company.wip + company.products;
        const meetsCondition = nextChips >= 3 && inventory >= 10;

        return {
            ...company,
            nextChips,
            inventory,
            meetsCondition
        };
    });

    // 条件を満たす会社のみでランキング
    const qualifiedCompanies = companiesWithConditions.filter(c => c.meetsCondition);
    const disqualifiedCompanies = companiesWithConditions.filter(c => !c.meetsCondition);

    let resultHtml = '<div style="max-height: 500px; overflow-y: auto;">';

    // 勝利条件の説明
    resultHtml += `
        <div style="background: #fef3c7; border-radius: 8px; padding: 12px; margin-bottom: 15px; font-size: 12px;">
            <div style="font-weight: bold; color: #92400e; margin-bottom: 5px;">勝利条件</div>
            <div style="color: #78350f;">次期繰り越しチップ3枚以上 かつ 在庫合計10個以上</div>
        </div>
    `;

    if (qualifiedCompanies.length > 0) {
        const rankings = qualifiedCompanies.sort((a, b) => b.equity - a.equity);
        const winner = rankings[0];

        resultHtml += `
            <div style="background: linear-gradient(180deg, #fbbf24 0%, #f59e0b 100%); border-radius: 12px; padding: 20px; margin-bottom: 15px; text-align: center; border: 3px solid #d97706;">
                <div style="font-size: 32px; margin-bottom: 5px;">🏆</div>
                <div style="font-size: 20px; font-weight: bold; color: #78350f;">${winner.name}</div>
                <div style="font-size: 24px; font-weight: bold; color: #1e40af; margin-top: 5px;">自己資本 ¥${winner.equity}</div>
                <div style="font-size: 11px; color: #78350f; margin-top: 8px;">
                    繰越チップ: ${winner.nextChips}枚 / 在庫: ${winner.inventory}個
                </div>
            </div>
        `;

        resultHtml += '<div class="breakdown-list">';
        rankings.forEach((company, index) => {
            const medal = index === 0 ? '🥇' : index === 1 ? '🥈' : index === 2 ? '🥉' : '';
            resultHtml += `
                <div class="breakdown-item" style="padding: 10px; ${index === 0 ? 'background: #fef9c3;' : ''}">
                    <div>
                        <span style="font-weight: bold;">${medal} ${index + 1}位: ${company.name}</span>
                        <div style="font-size: 11px; color: #666;">チップ: ${company.nextChips}枚 / 在庫: ${company.inventory}個</div>
                    </div>
                    <span style="font-weight: bold; color: #1e40af;">¥${company.equity}</span>
                </div>
            `;
        });
        resultHtml += '</div>';
    } else {
        resultHtml += `
            <div style="background: #fee2e2; border-radius: 12px; padding: 20px; margin-bottom: 15px; text-align: center;">
                <div style="font-size: 24px; margin-bottom: 5px;">😢</div>
                <div style="font-size: 16px; font-weight: bold; color: #991b1b;">勝利条件を満たす会社がありません</div>
            </div>
        `;
    }

    // 失格会社（条件未達成）
    if (disqualifiedCompanies.length > 0) {
        resultHtml += `
            <div style="margin-top: 15px; padding-top: 15px; border-top: 2px dashed #e5e7eb;">
                <div style="font-weight: bold; color: #6b7280; margin-bottom: 10px;">条件未達成</div>
        `;
        disqualifiedCompanies.forEach(company => {
            const chipStatus = company.nextChips >= 3 ? '✓' : '✗';
            const invStatus = company.inventory >= 10 ? '✓' : '✗';
            resultHtml += `
                <div class="breakdown-item" style="padding: 8px; opacity: 0.7;">
                    <div>
                        <span>${company.name}</span>
                        <div style="font-size: 10px; color: #ef4444;">
                            チップ${chipStatus}${company.nextChips}枚 / 在庫${invStatus}${company.inventory}個
                        </div>
                    </div>
                    <span style="color: #6b7280;">¥${company.equity}</span>
                </div>
            `;
        });
        resultHtml += '</div>';
    }

    resultHtml += '</div>';

    showModal('ゲーム終了 - 最終結果', resultHtml);
}

// ============================================
// セーブ・ロード機能
// ============================================
const SAVE_KEY = 'mg_game_save';

function saveGame() {
    const saveData = {
        version: 1,
        timestamp: Date.now(),
        currentPeriod: gameState.currentPeriod,
        currentRow: gameState.currentRow,
        maxRows: gameState.maxRows,
        currentPlayerIndex: gameState.currentPlayerIndex,
        turnOrder: gameState.turnOrder,
        skipTurns: gameState.skipTurns,
        doNothingCount: gameState.doNothingCount,
        usedRiskCards: gameState.usedRiskCards,
        usedDecisionCards: gameState.usedDecisionCards,
        reverseOrder: gameState.reverseOrder,
        turnReversed: gameState.turnReversed,
        periodStarted: gameState.periodStarted,
        cardDeck: gameState.cardDeck,
        deckInitialized: gameState.deckInitialized,
        markets: gameState.markets,
        companies: gameState.companies
    };
    localStorage.setItem(SAVE_KEY, JSON.stringify(saveData));
    console.log('ゲームを自動保存しました（期' + gameState.currentPeriod + '）');
}

function loadGame() {
    const savedData = localStorage.getItem(SAVE_KEY);
    if (!savedData) return null;
    try {
        return JSON.parse(savedData);
    } catch (e) {
        console.error('セーブデータの読み込みに失敗:', e);
        return null;
    }
}

function hasSavedGame() {
    return localStorage.getItem(SAVE_KEY) !== null;
}

function deleteSavedGame() {
    localStorage.removeItem(SAVE_KEY);
}

function restoreGame(saveData) {
    gameState.currentPeriod = saveData.currentPeriod;
    gameState.currentRow = saveData.currentRow;
    gameState.maxRows = saveData.maxRows;
    gameState.currentPlayerIndex = saveData.currentPlayerIndex;
    gameState.turnOrder = saveData.turnOrder;
    gameState.skipTurns = saveData.skipTurns;
    gameState.doNothingCount = saveData.doNothingCount;
    gameState.usedRiskCards = saveData.usedRiskCards;
    gameState.usedDecisionCards = saveData.usedDecisionCards;
    gameState.reverseOrder = saveData.reverseOrder;
    gameState.turnReversed = saveData.turnReversed;
    gameState.periodStarted = saveData.periodStarted;
    gameState.cardDeck = saveData.cardDeck;
    gameState.deckInitialized = saveData.deckInitialized;
    gameState.markets = saveData.markets;
    gameState.companies = saveData.companies;
}

function showStartMenu() {
    const hasSave = hasSavedGame();
    const saveData = hasSave ? loadGame() : null;
    const saveInfo = saveData ? `（${saveData.currentPeriod}期、${new Date(saveData.timestamp).toLocaleString('ja-JP')}）` : '';

    const menuHtml = `
        <div class="modal active" style="z-index: 2000;">
            <div class="modal-content" style="max-width: 400px; text-align: center;">
                <h2 style="margin-bottom: 20px; color: #1e40af;">🎮 MG（マネジメントゲーム）</h2>
                <p style="margin-bottom: 20px; color: #666;">自主練モード - 6人対戦</p>

                <div style="display: flex; flex-direction: column; gap: 12px;">
                    ${hasSave ? `
                        <button onclick="resumeGame()" class="action-btn primary" style="padding: 15px; font-size: 16px;">
                            ▶ 続きから始める${saveInfo}
                        </button>
                    ` : ''}
                    <button onclick="startNewGame()" class="action-btn success" style="padding: 15px; font-size: 16px;">
                        🆕 2期から新しく始める
                    </button>
                    ${hasSave ? `
                        <button onclick="confirmDeleteSave()" class="action-btn secondary" style="padding: 10px; font-size: 14px;">
                            🗑 セーブデータを削除
                        </button>
                    ` : ''}
                </div>
            </div>
        </div>
    `;
    document.getElementById('modalContainer').innerHTML = menuHtml;
}

function resumeGame() {
    const saveData = loadGame();
    if (saveData) {
        restoreGame(saveData);
        document.getElementById('modalContainer').innerHTML = '';
        updateDisplay();
        showToast('ゲームを再開しました（' + gameState.currentPeriod + '期）', 'success', 3000);
    }
}

function startNewGame() {
    deleteSavedGame();
    initializeCompanies();
    initializeCardDeck();
    document.getElementById('modalContainer').innerHTML = '';
    updateDisplay();
    saveGame(); // 初期状態を保存
}

function confirmDeleteSave() {
    if (confirm('セーブデータを削除しますか？この操作は取り消せません。')) {
        deleteSavedGame();
        showStartMenu();
    }
}

// Initialize game
function initGame() {
    console.log("initGame started");
    try {
        // まず会社とデッキを初期化（デフォルト状態）
        initializeCompanies();
        console.log("Companies initialized");
        initializeCardDeck();
        console.log("Card deck initialized (75 cards)");

        // セーブデータがあればスタートメニューを表示
        if (hasSavedGame()) {
            showStartMenu();
        } else {
            updateDisplay();
            saveGame(); // 初期状態を保存
        }
        console.log("Display updated");
    } catch(e) {
        console.error("Error in initGame:", e);
        alert("エラーが発生しました: " + e.message);
    }
}

// Start the game
console.log("Starting game...");
initGame();
    </script>
</body>
</html>