# MG開発 会話記録 (2025-12-28)

## 初期セットアップ

### ファイル読み込み
- `c:\Users\nishino\Downloads\!DOCTYPE html.txt` → `index.html`として保存（212KB、MGアプリ本体）
- `c:\Users\nishino\Downloads\【Github】.txt` → `credentials.txt`として保存

### 認証情報
- GitHub: https://github.com/Ghouse-development/Management-Game.git
- Supabase Project: https://hvabaksasexoqqdqfofd.supabase.co
- Supabase Password: Ghouse0648@@@
- Supabase Publishable API Key: sb_publishable_ZxImm2qU__v6SmeP_vCC1Q_Cja4xo9M
- Supabase Secret keys: sb_secret_uf9dYBaaUdKrQx3nwk8gzg_XY0vpTNu

---

## 質問と回答

### Q1: リスクカードのIDについて
**質問**: コード内で`riskCards`配列のIDと`applyRiskCard`のcase文が不一致。倉庫火災と盗難発生のIDが異なる。

**回答**: 倉庫火災と盗難発生のリスクカードはそれぞれ2枚ずつ。IDと処理はまとめてもよい。

**対応**: IDを維持してcase文を修正する方針で合意。

---

### Q2: 不整合の一括修正
**質問**: applyRiskCard関数の多数の不整合を一括で修正するか？

**回答**: はい、お願いします。

**対応**: `applyRiskCard`と`applyRiskCardToAI`の両関数を修正完了。

主な修正内容:
- case 1-2: クレーム発生（追加）
- case 5-6: 消費者運動発生（追加）
- case 7-8: 得意先倒産（臨時収入/支出から修正）
- case 9-11: 研究開発失敗（追加）
- case 12-14: 広告成功（追加）
- case 17-18: 広告政策失敗（長期労務紛争から修正）
- case 24-25: コンピュータートラブル（盗難発生から修正）
- case 31-32: 倉庫火災（case 11から修正）
- case 43-44: ストライキ発生（追加）
- case 45-46: 盗難発見（case 24-25から修正）
- case 47-48: 長期労務紛争（正しいIDに修正）
- case 49-50: 設計トラブル発生（情報漏洩から修正）

---

### Q3: 教育チップの上限について
**質問**: コード内で不整合（2枚まで vs 1枚まで）。正しい上限は？

**回答**: 2期は2枚まで。3期目よりシニアルールになる。

---

### Q4: シニアルール（3期以降）について
**質問**: シニアルールで何が変わるか？

**回答**: 後で説明する。

---

### Q5: 盗難発見の保険金について
**質問**: 保険金額が異なる（¥14 vs ¥10）。正しい金額は？

**回答**:
- 倉庫火災: 材料1個あたり¥8
- 盗難: 製品1個あたり¥10
- 保険使用後はチップを失う
- 再加入可能（¥5）

---

### Q6: 行数管理について
**質問**: `gameState.currentRow`と`company.currentRow`の2箇所で管理。全社共通か個別か？

**回答**:
- 2期=20行、3期=30行、4期=34行、5期=35行
- 期首処理で1行消費
- 借入する場合はもう1行消費（2期は借入不可）
- 各社が個別に行数を消費
- 誰か1社でも上限に達したら全社の期が終了

---

### Q7: 「残り5行」の警告について
**質問**: 全社に1回だけ警告か、各社個別に警告か？

**回答**: B（各社が個別に残り5行に到達するたびに警告）

---

### Q8: シニアルール（3期以降）について（再度）
**質問**: 具体的に何が変わるか？

**回答**: 後で説明する。

---

### Q9: 短期借入について
**質問**: `company.cash += needed * 0.6`（手取り60%）は正しいか？

**回答**:
- ¥100借りると、借入時に¥20の金利を払う
- 期末に返済分として¥20払う
- 正しい手取りは¥80（0.8）

---

### Q10: 短期借入の返済について
**質問**: 期末に¥20払った後、残り¥80はどうなるか？

**回答**:
- 期末に¥20払うと、元本が¥80になる
- 次の期の期首にその20%の金利（¥16）を払う
- その期の期末に¥16（20%以上）を払う
- 資金があれば全額返済も可能

---

### Q11: 長期借入について
**質問**: 金利は何%？返済のタイミングとルールは？

**回答**:
- 金利は10%
- 返済も10%以上
- 短期借入とルールは同じ

---

## 修正が必要な項目（TODO）

1. [ ] 短期借入の手取りを0.6→0.8に修正
2. [ ] 長期借入の手取りを0.9に修正
3. [ ] 期首の金利支払い処理を実装
4. [ ] 期末の返済処理を実装（短期20%以上、長期10%以上、全額返済可）
5. [ ] 保険使用後の再加入UIを実装
6. [ ] 各社個別の「残り5行」警告を実装
7. [ ] シニアルール（3期以降）の詳細を確認・実装

---

## 次のステップ

- ルールブックの提供を待機中

---

## 追加確認事項（PDF読了後）

### Q12: 行数の確定
**回答**: 会話記録の値を採用
- 2期: 20行
- 3期: 30行
- 4期: 34行
- 5期: 35行

### Q13: サイコロルール（3期以降）
**回答**:
- 前の期のPQトップがサイコロを振る
- サイコロの目で以下が決まる：

| サイコロ | 市場閉鎖 | 人件費倍率 | 大阪上限価格 |
|---------|---------|-----------|-------------|
| 1 | 仙台 | 1.1倍 | ¥21 |
| 2 | 仙台 | 1.1倍 | ¥22 |
| 3 | 仙台 | 1.1倍 | ¥23 |
| 4 | 仙台・札幌 | 1.2倍 | ¥24 |
| 5 | 仙台・札幌 | 1.2倍 | ¥25 |
| 6 | 仙台・札幌 | 1.2倍 | ¥26 |

### Q14: 人件費の詳細
**回答**:
- 基本単価: 2期=¥22、3期=¥24、4期=¥26、5期=¥28
- 人件費倍率適用後、四捨五入
- 期中最大人員は半額

**人件費の内訳（期末支払い）：**
- ワーカー × 単価
- 機械 × 単価
- セールスマン × 単価
- 期中最大人員 × 半額単価

**計算例（3期、サイコロ6、ワーカー1名・機械1台・セールスマン3名）：**
- ワーカー: 1 × ¥29 = ¥29
- 機械: 1 × ¥29 = ¥29
- セールスマン: 3 × ¥29 = ¥87
- 期中最大人員: 4 × ¥14 = ¥56
- 合計: ¥201

### Q15: 期末処理
**回答**:
1. 給料（人件費）の支払い
2. 返済（短期20%以上、長期10%以上）

---

## 市場情報（確認済み）

| 市場名 | 材料購入価格 | 販売上限価格 | マーケットボリューム | 入札 |
|--------|-------------|-------------|---------------------|------|
| 仙台 | ¥10 | ¥40 | 3個 | 要 |
| 札幌 | ¥11 | ¥36 | 4個 | 要 |
| 福岡 | ¥12 | ¥32 | 6個 | 要 |
| 名古屋 | ¥13 | ¥28 | 9個 | 要 |
| 大阪 | ¥14 | ¥24 | 13個 | 不要 |
| 東京 | ¥15 | ¥20 | 20個 | 不要 |
| 海外 | ¥16 | ¥16 | - | 不要 |

---

## UI/UXデザイン改善（セッション2）

### 実装完了項目

1. **市場盤を六角形デザインに変更**
   - `clip-path: polygon(50% 0%, 100% 25%, 100% 75%, 50% 100%, 0% 75%, 0% 25%)`
   - 緑のグラデーション背景
   - 参照画像: `sankoushiryou/MG盤001.jpg`

2. **会社盤を物理盤風の青いデザインに変更**
   - 青いグラデーション背景 (`#1e3a5f` → `#1e40af` → `#2563eb`)
   - 黄色のタイトルバー
   - 白い在庫・人員・チップボックス
   - 参照画像: `sankoushiryou/DSCN2090.jpg`

3. **他社会社盤のデザインを統一**
   - 青いグラデーション背景（メイン会社盤と統一）
   - 黄色の会社名、緑の現金表示
   - 現在ターンは黄色ボーダーでハイライト

4. **固定費→F表記に変更**
   - 「固定費内訳」→「F内訳」
   - 「固定費合計」→「F合計」
   - 「【F：固定費】」→「【F】」

5. **視認性の改善**
   - F内訳パネル内のテキスト色を明るく（`#fef3c7`）
   - 各ボックス内のタイトルを太字に
   - コントラスト改善

### 参照画像
- `MG盤001.jpg`: 六角形の市場盤
- `DSCN2090.jpg`: 青い会社盤のレイアウト
- `FireShot Capture 313...png`: チップの色（青=研究、黄=教育、赤=広告、緑=PC）

### 6人対戦・自動セーブ機能

6. **6人対戦に変更（プレイヤー1人+AI5人）**
   - 会社名: あなた、A社、B社、C社、D社、E社
   - AI戦略をゲーム開始時にランダムに割り当て
   - 戦略: aggressive, balanced, conservative, price_focused, tech_focused, unpredictable

7. **自動セーブ・再開機能**
   - localStorageを使用
   - ターン終了時・期首開始時に自動セーブ
   - ゲーム開始時にスタートメニュー表示
     - 続きから始める（セーブデータあり時）
     - 2期から新しく始める
     - セーブデータを削除

### Vercelデプロイ完了
- URL: https://mg-game-l04uq4pst-ghouse-developments-projects.vercel.app

### 残タスク
- [ ] カードデザインを実物のMGカードに近づける（緑=意思決定、赤=リスク）

---

---

## セッション3: ゲームロジック改善

### 実装完了項目

1. **3期以降の期首処理（サイコロ機能）**
   - `showBorrowingChoice()`関数でサイコロを自動振り
   - サイコロ結果に基づく設定:
     - 1-3: 仙台のみ閉鎖、人件費×1.1、大阪上限¥21-23
     - 4-6: 仙台・札幌閉鎖、人件費×1.2、大阪上限¥24-26
   - `gameState.diceRoll`, `gameState.wageMultiplier`, `gameState.osakaMaxPrice` を追加
   - 視覚的なサイコロ結果表示モーダル

2. **AIが入札市場で販売時、他社も入札に参加**
   - `startAIBidding()` - AIが親として入札開始
   - `showPlayerBidInAIAuction()` - プレイヤーに入札参加確認
   - `processAIBiddingWithPlayer()` - 入札結果処理
   - `showAIBiddingResultModal()` - 入札結果表示

3. **入札ルール修正：販売上限を親の出した個数に**
   - `processBidsWithAllCompanies()`で親の入札数量を販売上限に設定
   - AI入札でも同様のルールを適用

4. **各社の行数表示を改善**
   - 会社カードに色付きバッジで行数表示（青/赤）
   - 残り5行以下で赤色に変化
   - ミニボードにも行数追加

5. **決算表示を個別表示に変更**
   - `showCompanySettlement()` - 各社の決算を1社ずつ表示
   - PQ/VQ/MQ/F/G を見やすいカード形式で表示
   - 「次へ」ボタンで次の会社へ
   - 全社表示後にサマリーテーブル

6. **AI行動で給料支払いを考慮**
   - `executeAIStrategyByType()`に給料考慮ロジック追加
   - 残り5行以下かつ資金不足なら販売優先
   - 3期以降、余裕があれば次期チップ投資
   - 全戦略関数に`analysis`パラメータ追加

### 追加されたgameStateプロパティ
```javascript
diceRoll: null,        // 1-6の値
wageMultiplier: 1.0,   // 人件費倍率（1.1または1.2）
osakaMaxPrice: 24,     // 大阪上限価格（21-26）
aiBidding: null,       // AI入札状態管理
```

### 残タスク
- [x] 材料仕入を2市場から購入可能に（行数上位の会社は避ける）
- [ ] カードデザインを実物のMGカードに近づける

---

## セッション4: 借入・返済・その他修正 (2025-12-29)

### 実装完了項目

1. **短期借入の手取り率修正**
   - 0.6 → 0.8 に修正（20%金利控除）
   - 全箇所を一括修正

2. **長期借入の手取り率追加**
   - `processBorrowing()`で0.9（10%金利控除）を実装
   - `loanAmount * 0.9`で実入金額を計算

3. **期首金利支払い処理**
   - `processInterestPayments()` - 3期以降の期首で金利支払い
   - 短期借入: 20%金利
   - 長期借入: 10%金利
   - 資金不足時は自動で短期借入
   - 金利支払い詳細をモーダルで表示

4. **期末返済処理**
   - `processEndPeriodLoanRepayments()` - AI自動返済、プレイヤーUI表示
   - `processAutoLoanRepayment()` - AI会社の最低返済自動処理
   - `showLoanRepaymentModal()` - プレイヤー向け返済選択UI
   - 短期: 最低20%返済、全額返済オプション
   - 長期: 最低10%返済、全額返済オプション

5. **保険使用後の再加入UI**
   - `showInsuranceRepurchaseModal()` - 災害発生後の再加入モーダル
   - `repurchaseInsurance()` - 再加入処理（¥5）
   - AI会社は自動で再加入

6. **各社個別の「残り5行」警告**
   - グローバルフラグから各社個別フラグ`company.last5RowWarningShown`に変更
   - `showLast5RowWarning()` - 視覚的な警告モーダル
   - 期首で各社フラグをリセット

7. **材料仕入2市場対応**
   - `showMaterialPurchaseModal()` - 複数市場選択UI
   - 行数トップの会社には警告表示
   - 市場数×1行使用のルール実装

8. **PQ/VQ/MQ計算修正**
   - 単価計算（V, M）のバグ修正
   - 誤: `VQ / 期末在庫数`
   - 正: `VQ / Q`（販売数量で割る）

### Vercelデプロイ
- URL: https://mg-game-1gphj74dk-ghouse-developments-projects.vercel.app

### 残タスク
- [ ] カードデザインを実物のMGカードに近づける

---

*記録日時: 2025-12-29（セッション4最終更新）*
